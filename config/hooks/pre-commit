#!/bin/bash +x

modified_files="git diff --cached --name-only --diff-filter=ACMRTUXB"
patron="^D[D|M]L_[0-9]{3,5}_(ENTITY0[0-9]|BANK01|HAYA0[0-9]|REM01|CM01|HAYAMASTER|REMMASTER|MASTER|BANKMASTER|CMMASTER|MINIREC|DWH|DS)_.*\.sql"

function paint_error() {
	declare -n error_data=$1
	echo ""
	echo "**********************************************************"
	echo "Control código PFS: ${error_data[name]}"
	echo "Commit no permitido!!!"
	echo "Fichero afectado: ${error_data[file]}"
	echo ""
	echo "Problema: ${error_data[problem]}"
	echo "Solución: ${error_data[solution]}"
	echo "**********************************************************"
	echo ""
}


function check_RIA_RULE_R1() {
	file_content=$1
	declare -A rule=(	[name]="RIA_RULE_R1"
						[file]=$f 
						[problem]="Estás intentando incorporar un debugger en la interface, es muy peligroso."
						[solution]="Elimina la instrucción 'debugger'" )

	r=$(echo $file_content | grep "debugger")
	if [[ "x" != "x$r" ]]; then
		paint_error rule
		exit 1
	fi
}

function check_RIA_RULE_R2() {
	file_content=$1
	declare -A rule=(	[name]="RIA_RULE_R2"
						[file]=$f 
						[problem]="Estás intentando poner comentarios HTML en una JSP."
						[solution]="Convierte tus comentarios <!-- --> en comentarios JSP <%-- --%> o preferiblemente elimina las líneas comentadas." )

	r=$(echo $file_content | grep "<\!--.*-->")
	if [[ "x" != "x$r" ]]; then
		paint_error rule
		exit 1
	fi
}

function check_RIA_RULE_R3() {
	file_content=$1
	regexp=",\s*(,|\]|\}|\)|(\<sec)(.*?)(\>),|(\<\/sec)(.*?)(\>)\s*(.*?)\s*(\<sec)(.*?)(\>),)"

	declare -A rule=(	[name]="RIA_RULE_R3"
						[file]=$f 
						[problem]="Estás intentando poner COMAS FURTIVAS en una JSP."
						[solution]="Revisa el siguiente enlace: https://link-doc.pfsgroup.es/confluence/x/CQDU.
Expresion regular para detectar comas furtivas: $regexp" )

	r=$(echo $file_content | sed 's/'"'"'.*'"'"'/_string_/g' \
                  | sed 's/".*"/_string_/g' \
                  | sed 's/replace(.*\,.*)/_regexp_/g' \
                  | grep -Pzo "$regexp")

	if [[ "x" != "x$r" ]]; then
		paint_error rule
		exit 1
	fi
}

function check_RIA_RULE_R4() {
	file_content=$1
	declare -A rule=(	[name]="RIA_RULE_R4"
						[file]=$f 
						[problem]="Esta expresión es problemática para IExplorer 'border:false'."
						[solution]="Reemplaza esta expresión por 'border:0px'." )

	r=$(echo $file_content | grep -E "border(\s*):(\s*)false")
	if [[ "x" != "x$r" ]]; then
		paint_error rule
		exit 1
	fi
}

function check_RIA_RULE_R5() {
	file_content=$1
	declare -A rule=(	[name]="RIA_RULE_R5"
						[file]=$f 
						[problem]="Esta expresión es problemática para IExplorer 'renderer:app.format.dateRenderer,'."
						[solution]="Reemplaza esta expresión por su equivalente en el JSON o Dto original." )

	r=$(echo $file_content | grep -E "renderer(\s*):(\s*)app.format.dateRenderer,")
	if [[ "x" != "x$r" ]]; then
		paint_error rule
		exit 1
	fi
}

function check_UTF8() {
	file=$1
	declare -A rule=(	[name]="Encodig (UTF-8/ASCII)"
						[file]=$file 
						[problem]="El fichero no está en formato correcto UTF-8 o ASCII."
						[solution]="Convierte el encoding del fichero a u UTF8." )

	encoding=`file -i $file | cut -f 2 -d";" | cut -f 2 -d=`
	if [ $encoding != "utf-8" ] &&  [ $encoding != "us-ascii" ]; then
		paint_error rule
	    exit 1
	fi

}

function check_pitertul_format() {
	f=$1
	expregular=$2
	declare -A rule=(	[name]="Pitertul format"
						[file]=$f
						[problem]="El fichero no está en formato correcto para PITERTUL."
						[solution]="$3"
					)
	r=$(cat $f | tr '\n' ' ' | tr '\t' ' ' | tr -s [:space:] | tr -cd "[:print:]" | 
		grep -a -E -i "$expregular")
	if [[ "x" == "x$r" ]]; then
		paint_error rule
		exit 1
	fi
}

function check_pitertul_name() {
	file=$1
	declare -A rule=(	[name]="Pitertul nombre"
						[file]=$file
						[problem]="El fichero no tiene un nombre correcto para PITERTUL."
						[solution]="Patrón válido: $patron"
					)
	fsinpath=${file##*/}
	if [[ ! $fsinpath =~ $patron ]] ; then 
		paint_error rule
		exit 1
	fi
}

# ***************************
# Control en RIA
# ***************************
function JSP_rules() {
	for f in `eval $modified_files | grep .jsp$`; do
		
		file_content=$(cat $f);

		# R1-RIA. Control de debugger en JSPs
		check_RIA_RULE_R1 "$file_content"
		# R2-RIA.  Control de comentarios en JSPs
		check_RIA_RULE_R2 "$file_content"
		# R3-RIA.  Control de comas furtivas
		check_RIA_RULE_R3 "$file_content"
		# R4-RIA.  Control de reglas border:false (desactivada)
		#check_RIA_RULE_R4 "$file_content"
		# R5-RIA.  Control de reglas dateRenderer()
		check_RIA_RULE_R5 "$file_content"
	done
}

# ***************************
# Control en JS y SQL
# ***************************
function JS_rules() {
	for f in `eval $modified_files | grep .js$`; do
		
		file_content=$(cat $f);

		# R1-RIA. Control de debugger en JSPs
		check_RIA_RULE_R1 "$file_content"
		# R3-RIA.  Control de comas furtivas
		check_RIA_RULE_R3 "$file_content"
	done
}

function SQL_rules() {
	for f in `eval $modified_files | grep  -E \/D.*\.sql$ | grep -v ^reports/ | grep -v migracion | grep -v scripts | grep -v templates | grep -v rutinas`; do
		check_pitertul_name $f
		
		check_UTF8 $f

		exp="\s*WHENEVER\s*SQLERROR\s*EXIT\s*SQL\.SQLCODE(;|)\s*"
		check_pitertul_format $1 $exp "Debe incluir 'WHENEVER SQLERROR EXIT SQL.SQLCODE;'"
		exp="SET\s*SERVEROUTPUT\s*ON(;|)"
		check_pitertul_format $1 $exp "Debe incluir 'SET SERVEROUTPUT ON;'"
		exp="(DECLARE|CREATE)"
		check_pitertul_format $1 $exp "Debe incluir un bloque DECLARE o CREATE"
		exp="BEGIN"
		check_pitertul_format $1 $exp "Debe incluir un bloque BEGIN"
		exp="EXCEPTION"
		check_pitertul_format $1 $exp "Debe incluir un bloque EXCEPTION"
		exp="ROLLBACK;"
		check_pitertul_format $1 $exp "Debe incluir una línea ROLLBACK; dentro del bloque EXCEPTION"
		exp="RAISE;"
		check_pitertul_format $1 $exp "Debe incluir  una línea RAISE; dentro del bloque EXCEPTION"
		exp="END(.*);\s*/"
		check_pitertul_format $1 $exp "Debe incluir un bloque finalizado con END; o END <nombre_sp>;"
		exp="/\s*EXIT(;|)\s*$"
		check_pitertul_format $1 $exp "Debe finalizar con '/ y EXIT'"
	done
}

function PROPERTIES_rules() {
	for f in `eval $modified_files | grep  -E '.properties$'`; do
		check_UTF8 $f
	done
}

########################################################
##### MAIN
########################################################

JSP_rules
JS_rules
SQL_rules

exit 0;
