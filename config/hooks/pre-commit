#!/bin/bash +x

modified_files="git diff --cached --name-only --diff-filter=ACMRTUXB"
patron="^D[D|M]L_[0-9]{3,5}_(ENTITY0[0-9]|BANK01|HAYA0[0-9]|REM01|CM01|HAYAMASTER|REMMASTER|MASTER|BANKMASTER|CMMASTER|MINIREC|DWH|DS)_.*\.sql"

function paint_error() {
	declare -n error_data=$1
	echo ""
	echo "**********************************************************"
	echo "Control código PFS: ${error_data[name]}"
	echo "Commit no permitido!!!"
	echo "Fichero afectado: ${error_data[file]}"
	echo ""
	echo "Problema: ${error_data[problem]}"
	echo "Solución: ${error_data[solution]}"
	echo "**********************************************************"
	echo ""
}


function check_RIA_RULE_R1() {
	file_content=$1
	declare -A rule=(	[name]="RIA_RULE_R1"
						[file]=$f 
						[problem]="Estás intentando incorporar un debugger en la interface, es muy peligroso."
						[solution]="Elimina la instrucción 'debugger'" )

	r=$(echo $file_content | grep "debugger")
	if [[ "x" != "x$r" ]]; then
		paint_error rule
		exit 1
	fi
}

function check_RIA_RULE_R2() {
	file_content=$1
	declare -A rule=(	[name]="RIA_RULE_R2"
						[file]=$f 
						[problem]="Estás intentando poner comentarios HTML en una JSP."
						[solution]="Convierte tus comentarios <!-- --> en comentarios JSP <%-- --%> o preferiblemente elimina las líneas comentadas." )

	r=$(echo $file_content | grep "<\!--.*-->")
	if [[ "x" != "x$r" ]]; then
		paint_error rule
		exit 1
	fi
}

function check_RIA_RULE_R3() {
	file_content=$1
	regexp=",\s*(,|\]|\}|\)|(\<sec)(.*?)(\>),|(\<\/sec)(.*?)(\>)\s*(.*?)\s*(\<sec)(.*?)(\>),)"

	declare -A rule=(	[name]="RIA_RULE_R3"
						[file]=$f 
						[problem]="Estás intentando poner COMAS FURTIVAS en una JSP."
						[solution]="Revisa el siguiente enlace: https://link-doc.pfsgroup.es/confluence/x/CQDU.
Expresion regular para detectar comas furtivas: $regexp" )

	r=$(echo $file_content | sed 's/'"'"'.*'"'"'/_string_/g' \
                  | sed 's/".*"/_string_/g' \
                  | sed 's/replace(.*\,.*)/_regexp_/g' \
                  | grep -Pzo "$regexp")

	if [[ "x" != "x$r" ]]; then
		paint_error rule
		exit 1
	fi
}

function check_RIA_RULE_R4() {
	file_content=$1
	declare -A rule=(	[name]="RIA_RULE_R4"
						[file]=$f 
						[problem]="Estás expresión problemática para IExplorer 'border:false'."
						[solution]="Reemplaza esta expresión por 'border:0px'." )

	r=$(echo $file_content | grep -E "border(\s*):(\s*)false")
	if [[ "x" != "x$r" ]]; then
		paint_error rule
		exit 1
	fi
}

function check_UTF8() {
	file=$1
	declare -A rule=(	[name]="Encodig (UTF-8/ASCII)"
						[file]=$file 
						[problem]="El fichero no está en formato correcto UTF-8 o ASCII."
						[solution]="Convierte el encoding del fichero a u UTF8." )

	encoding=`file -i $file | cut -f 2 -d";" | cut -f 2 -d=`
	if [ $encoding != "utf-8" ] &&  [ $encoding != "us-ascii" ]; then
		paint_error rule
	    exit 1
	fi

}

function check_pitertul_format() {
	file_content=$1
	declare -A rule=(	[name]="Pitertul format"
						[file]=$f
						[problem]="El fichero no está en formato correcto para PITERTUL."
						[solution]="Puedes encontrar ayuda en https://link-doc.pfsgroup.es/confluence/display/TEC/PITERTUL%3A+making+of"
					)
	# Completa: r=$(cat $f | tr '\n' ' ' | grep -E -i "\sWHENEVER\sSQLERROR\sEXIT\sSQL\.SQLCODE(;|)\sSET\sSERVEROUTPUT\sON(;|)(\s*SET\sDEFINE\sOFF(;|)|)\s*(DECLARE(.*)\s*BEGIN|)\s*(.*)EXCEPTION(.*)ROLLBACK;\s*RAISE;\s*END(.*);\s*\/\s*EXIT(;|)\s*$")
	r=$(cat $f | tr '\n' ' ' | grep -E -i "WHENEVER\sSQLERROR\sEXIT\sSQL\.SQLCODE(;|)\sSET\sSERVEROUTPUT\sON(;|)(\s*SET\sDEFINE\sOFF(;|)|)\s*(DECLARE(.*)\s*BEGIN|)\s*(.*)(END(.*);\s*|)\/\s*EXIT(;|)\s*$")
	if [[ "x" == "x$r" ]]; then
		paint_error rule
		exit 1
	fi

}

function check_pitertul_name() {
	file=$1
	declare -A rule=(	[name]="Pitertul nombre"
						[file]=$file
						[problem]="El fichero no tiene un nombre correcto para PITERTUL."
<<<<<<< HEAD
						[solution]="Patrón válido: $patron"
=======
						[solution]="Puedes encontrar ayuda en https://link-doc.pfsgroup.es/confluence/display/TEC/PITERTUL%3A+making+of"
>>>>>>> 616d71fccb... RECOVERY-13610 Nuevo hook
					)
	fsinpath=${file##*/}
	if [[ ! $fsinpath =~ $patron ]] ; then 
		paint_error rule
		exit 1
	fi
}

# ***************************
# Control en RIA
# ***************************
function JSP_rules() {
	for f in `eval $modified_files | grep .jsp$`; do
		
		file_content=$(cat $f);

		# R1-RIA. Control de debugger en JSPs
		check_RIA_RULE_R1 "$file_content"
		# R2-RIA.  Control de comentarios en JSPs
		check_RIA_RULE_R2 "$file_content"
		# R3-RIA.  Control de comas furtivas
		check_RIA_RULE_R3 "$file_content"
		# R4-RIA.  Control de reglas border:false (desactivada)
		#check_RIA_RULE_R4 "$file_content"
	done
}

# ***************************
# Control en RIA
# ***************************
function JS_rules() {
	for f in `eval $modified_files | grep .js$`; do
		
		file_content=$(cat $f);

		# R1-RIA. Control de debugger en JSPs
		check_RIA_RULE_R1 "$file_content"
		# R3-RIA.  Control de comas furtivas
		check_RIA_RULE_R3 "$file_content"
	done
}

function SQL_rules() {
<<<<<<< HEAD
	for f in `eval $modified_files | grep  -E .sql$ | grep -v ^reports/`; do
=======
	for f in `eval $modified_files | grep  -E .sql$ | grep -v ^reports/ | grep -v migracion`; do
		check_pitertul_name $f
		
<<<<<<< HEAD
>>>>>>> 616d71fccb... RECOVERY-13610 Nuevo hook
=======
>>>>>>> 616d71fccb... RECOVERY-13610 Nuevo hook
		file_content=$(cat $f);
		check_UTF8 $f

		# Comprueba formato de Pitertul
		check_pitertul_format "$file_content"
	done
}

function PROPERTIES_rules() {
	for f in `eval $modified_files | grep  -E '.properties$'`; do
		check_UTF8 $f
	done
}

########################################################
##### MAIN
########################################################

JSP_rules
JS_rules
SQL_rules

exit 0;