<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:jms="http://www.springframework.org/schema/integration/jms"
	xmlns:integration="http://www.springframework.org/schema/integration"
	xmlns:file="http://www.springframework.org/schema/integration/file"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
			http://www.springframework.org/schema/beans/spring-beans.xsd
			http://www.springframework.org/schema/integration
			http://www.springframework.org/schema/integration/spring-integration.xsd
			http://www.springframework.org/schema/integration/jms
			http://www.springframework.org/schema/integration/jms/spring-integration-jms.xsd
			http://www.springframework.org/schema/integration/file
			http://www.springframework.org/schema/integration/file/spring-integration-file.xsd">

	<!-- CONFIGURACION DE LA ENTRADA -->
	<integration:channel id="integacionErrorChannel"/> 

	<!-- ************* 
	 Canales de entrada (JSM y escucha de directorio)
	 ************* 	 --> 
	<jms:inbound-channel-adapter id="entradaJMS"
                        destination="paraCajamarQueue"
                        channel="canalEntradaComunJSON"
                        extract-payload="true">
	     <integration:poller>
	         <integration:interval-trigger 
	         	interval="5" 
	         	time-unit="SECONDS"/>
	     </integration:poller>
	 </jms:inbound-channel-adapter>
 	
	<file:inbound-channel-adapter id="canalEntradaPorFichero"
		directory="${integracion.input}"
		filename-pattern=".+.msg">
		<integration:poller id="poller">
			<integration:interval-trigger 
				interval="30"
				time-unit="SECONDS" />
		</integration:poller>
	</file:inbound-channel-adapter>

	<!-- Transforma la entrada por fichero al canal de entrada común (formato texto) --> 
	<file:file-to-string-transformer delete-files="false" charset="UTF-8" 
		input-channel="canalEntradaPorFichero" output-channel="canalEntradaComunJSON"/>
	

	<!-- ************* 
	 Transforma la entrada Json en un DataContainer (contenedor de datos para aplicar filtros)
	 Nota: El orden es importante!
	 ************* 	 --> 
	<integration:chain 
		 input-channel="canalEntradaComunJSON"
		 output-channel="canalEntradaDataContainer">
		<!-- file:file-to-string-transformer delete-files="false" charset="UTF-8" / -->
		<integration:transformer
			ref="jsonAsuntoPayloadTransformer"
			method="deserialize"/>
	</integration:chain>



	<!-- integration:header-value-router input-channel="routingChannel" header-name="rec-msg-type" default-output-channel="inputChannel">
		<integration:mapping value="CAB-UPD-RECURSO" channel="recursosInputChannel" />
		<integration:mapping value="CAB-UPD-PROCEDIMIENTO" channel="recursosInputChannel" />
	</integration:header-value-router -->
	<!-- Canal recursos -->
	<!-- integration:service-activator input-channel="recursosInputChannel" output-channel="nullChannel">
		<bean class="es.pfsgroup.recovery.integration.bpm.PayloadConsumerActionService">
			<constructor-arg index="0" ref="actualizarCabecerasMgr"/>
			<constructor-arg index="1" value="2038"/>
			<constructor-arg index="2" value="file:/Documentos/borrar/mensajes/input/log" />
			<constructor-arg index="3" value="file:/Documentos/borrar/mensajes/input/error" />
		</bean>
	</integration:service-activator -->
		
	<!-- Canal eventos BPM -->
	<integration:service-activator 
		input-channel="canalEntradaDataContainer" 
		output-channel="nullChannel" method="dispatchMessage">
		<bean class="es.pfsgroup.recovery.integration.ConsumerActionService">
			<constructor-arg index="0" ref="bpmConsumerActionMgr" />
			<constructor-arg index="1" value="2038"/>
			<constructor-arg index="2" value="${integracion.input}" />
			<constructor-arg index="3" value="${integracion.error}" />
		</bean>
	</integration:service-activator>

	<!-- ***************** -->
	<!-- REGLAS DE ENTRADA -->
	<!-- ***************** -->
	<bean id="bpmConsumerActionMgr" class="es.pfsgroup.recovery.integration.ConsumerActionManager">
		<constructor-arg>
			<list>

				<!-- ACTUALIZACION DE CABECERA PROCEDIMIENTO -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.ProcedimientoConsumer">
					<constructor-arg>
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="BPM-TAREA-INICIO"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Actualización de un procedimiento, lo crea si no existe"/>
				</bean>

				<!-- NOTIFICACIONES: INICIO / CANCEL / FIN TAREA / BPM-FIN / BPM-TAREA-ACTIVAR ... -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.TareaProcedimientoConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="BPM-TAREA-.+"/>
						</bean>
					</constructor-arg>
					<constructor-arg index="1" ref="diccionarioCodigosConsumer"/>
					<property name="description" value="Gestión de una tarea"/>
				</bean>

				<!-- NOTIFICACIONES: ACUERDOS ... -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.AcuerdoConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DATOS-ACUERDO.*"/>
						</bean>
					</constructor-arg>
					<constructor-arg index="1" ref="diccionarioCodigosConsumer"/>
					<property name="description" value="Gestión de un acuerdo"/>
				</bean>

				<!-- INICIAR UN PROCEIDIENTO TRAS LA LLEGADA DE UNA TAREA -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.ProcedimientoConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.bpm.TareaExternaPayloadRegexRule">
							<property name="tipo" value="BPM-TAREA-FIN"/>
							<property name="codigoTarea" value="H005_declararIVAeIGIC"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Inicio de BPM Declarar IVA/IGIC"/>
					<property name="iniciarBPM" value="true"/>
					<property name="crearNuevo" value="true"/>
					<property name="forzarTipoProcedimiento" value="HCJ001"/>
				</bean>
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.ProcedimientoConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.bpm.TareaExternaPayloadRegexRule">
							<property name="tipo" value="BPM-TAREA-FIN"/>
							<property name="codigoTarea" value="H002_ObtenerValidacionComite|H004_ObtenerValidacionComite|EJ_NOTARIAL"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Inicio de Elevacion Cajamar"/>
					<property name="iniciarBPM" value="true"/>
					<property name="crearNuevo" value="true"/>
					<property name="forzarTipoProcedimiento" value="HCJ002"/>
				</bean>

				<!-- ACTUALIZACION DE CABECERA RECURSO -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.RecursoConsumer">
					<constructor-arg>
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DATOS-RECURSO"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Actualización de un recurso"/>
				</bean>

				<!-- ACTUALIZACION DE CABECERA SUBASTA -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.SubastaConsumer">
					<constructor-arg>
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DATOS-SUBASTA"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Actualización de una subasta"/>
				</bean>
				
				<!-- CONVENIOS -->
				<!-- NO SE USA 
				<bean class="es.pfsgroup.recovery.haya.integration.bpm.consumer.ConvenioConsumer">
					<constructor-arg>
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DATOS-CONVENIO"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Actualización de un convenio"/>
				</bean-->

				<!-- NOTIFICACIONES DE TAREA ... -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.TareaNotificacionConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="TAREA-NOTIF"/>
						</bean>
					</constructor-arg>
					<constructor-arg index="1" ref="diccionarioCodigosConsumer"/>
					<property name="description" value="Gestión de tarea notificaciones"/>
				</bean>
				

			</list>
		</constructor-arg>
	</bean>

	<!-- TRADUCTOR DE CODIGOS PROCEDIMIENTOS, TAREAS, DD -->
	<bean id ="diccionarioCodigosConsumer" class="es.pfsgroup.recovery.integration.bpm.DiccionarioDeCodigos">
		<constructor-arg>
			<map>
				<entry key="procedimientos">
					<map>
					</map>
				</entry>
				<entry key="tareas">
					<map>
					</map>
				</entry>
				<entry key="DD">
					<map>
					</map>
				</entry>
			</map>
		</constructor-arg>
	</bean>

</beans>