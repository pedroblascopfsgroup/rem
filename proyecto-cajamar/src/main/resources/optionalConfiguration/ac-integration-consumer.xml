<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:jms="http://www.springframework.org/schema/integration/jms"
	xmlns:integration="http://www.springframework.org/schema/integration"
	xmlns:file="http://www.springframework.org/schema/integration/file"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
			http://www.springframework.org/schema/beans/spring-beans.xsd
			http://www.springframework.org/schema/integration
			http://www.springframework.org/schema/integration/spring-integration.xsd
			http://www.springframework.org/schema/integration/jms
			http://www.springframework.org/schema/integration/jms/spring-integration-jms.xsd
			http://www.springframework.org/schema/integration/file
			http://www.springframework.org/schema/integration/file/spring-integration-file.xsd">

	<!-- CONFIGURACION DE LA ENTRADA -->
	<bean id="entradaIntegracionAdapter" class="es.pfsgroup.recovery.integration.file.FileIntegrationAdapter">
		<constructor-arg value="${integracion.input}/${integracion.consumer.cola}"/>
	</bean>

	<!-- ************* 
	 Canales de entrada (JSM y escucha de directorio)
	 ************* 	 -->
	<jms:inbound-channel-adapter id="entradaDeCajamarJMS"
						auto-startup="${integracion.activa}"
						destination="integracionConsumerQueue"
						channel="integra.entrada.jms"
						extract-payload="true">
	     <integration:poller>
	         <integration:interval-trigger 
	         	interval="1" 
	         	time-unit="SECONDS"/>
	     </integration:poller>
	 </jms:inbound-channel-adapter>
	<!--  TRANSFORMA MENSAJE JMS EN FORMATO TXT PARA GUARDAR EN FICHERO-->
	<integration:transformer
		input-channel="integra.entrada.jms"
		output-channel="entradaDeHayaJMSFichero" 
		ref="entradaIntegracionAdapter"
		method="transformMsg2file"/>
	<file:outbound-channel-adapter
			id="entradaDeHayaJMSFichero"
			directory="${integracion.input}/${integracion.consumer.cola}"/>

	<file:inbound-channel-adapter
		id="entradaDeHayaFichero"	
		auto-startup="${integracion.activa}"
		directory="${integracion.input}/${integracion.consumer.cola}"
		filename-pattern=".+.msg">
		<integration:poller id="poller">
			<integration:interval-trigger 
				interval="${integracion.consumer.poller}"
				time-unit="MILLISECONDS" />
		</integration:poller>
	</file:inbound-channel-adapter>
	<integration:chain input-channel="entradaDeHayaFichero" output-channel="integra.entrada.ok">
		<integration:header-enricher error-channel="integra.entrada.error" />
		<file:file-to-string-transformer delete-files="false" charset="UTF-8"/>
		<integration:transformer ref="entradaIntegracionAdapter" method="transformFile2msg" />				<!-- CONVIERTE EN FORMATO TXT DE FICHERO EN FORMATO MENSAJE DE TXT -->
 		<integration:service-activator ref="entradaIntegracionAdapter" method="checkExistErrorFolder" />	<!-- ROUTER PARA MENSAJES CON ERROR -->
		<integration:transformer ref="jsonAsuntoPayloadTransformer" method="deserialize"/>				<!-- DESERIALIZA TEXTO DEL MENSAJE EN FORMATO JSON A FORMATO CANONICAL -->
		<integration:service-activator method="dispatchMessage">										<!-- PROCESA EL MENSAJE SEGUN LAS REGLAS -->
			<bean class="es.pfsgroup.recovery.integration.ConsumerActionService">
				<constructor-arg index="0" ref="bpmConsumerActionMgr" />
				<constructor-arg index="1" value="2038"/>
			</bean>
		</integration:service-activator>
	</integration:chain>

	<!-- ESCRITURA A DISCO -->
	<integration:channel id="integra.entrada.ok"/>
	<integration:channel id="integra.entrada.error"/>
	<integration:outbound-channel-adapter 
		channel="integra.entrada.ok" 
		ref="entradaIntegracionAdapter" 
		method="moveFileCompleted" />
	<integration:outbound-channel-adapter 
		channel="integra.entrada.error" 
		ref="entradaIntegracionAdapter" 
		method="moveFileWithErrors" />


	<!-- ***************** -->
	<!-- REGLAS DE ENTRADA -->
	<!-- ***************** -->
	<bean id="bpmConsumerActionMgr" class="es.pfsgroup.recovery.integration.ConsumerActionManager">
		<constructor-arg>
			<list>

				<!-- ACTUALIZACION DE CABECERA PROCEDIMIENTO -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.ProcedimientoConsumer">
					<constructor-arg>
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="BPM-TAREA-INICIO"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Actualización de un procedimiento, lo crea si no existe"/>
				</bean>

				<!-- NOTIFICACIONES: INICIO / CANCEL / FIN TAREA / BPM-FIN / BPM-TAREA-ACTIVAR ... -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.TareaProcedimientoConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="BPM-TAREA-.+"/>
						</bean>
					</constructor-arg>
					<constructor-arg index="1" ref="diccionarioCodigosConsumer"/>
					<property name="description" value="Gestión de una tarea"/>
				</bean>

				<!-- NOTIFICACIONES: ACUERDOS ... -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.AcuerdoConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DATOS-ACUERDO.*"/>
						</bean>
					</constructor-arg>
					<constructor-arg index="1" ref="diccionarioCodigosConsumer"/>
					<property name="description" value="Gestión de un acuerdo"/>
				</bean>

				<!-- INICIAR UN PROCEIDIENTO TRAS LA LLEGADA DE UNA TAREA -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.ProcedimientoConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.bpm.TareaExternaPayloadRegexRule">
							<property name="tipo" value="BPM-TAREA-INICIO"/>
							<property name="codigoTarea" value="H005_declararIVAeIGIC"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Inicio de BPM Declarar IVA/IGIC"/>
					<property name="iniciarBPM" value="true"/>
					<property name="crearNuevo" value="true"/>
					<property name="forzarTipoProcedimiento" value="HCJ001"/>
				</bean>
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.ProcedimientoConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.bpm.TareaExternaPayloadRegexRule">
							<property name="tipo" value="BPM-TAREA-INICIO"/>
							<property name="codigoTarea" value="H002_ObtenerValidacionComite|H004_ObtenerValidacionComite|H036_ElevarPropuestaAComite"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Inicio de Elevacion Cajamar"/>
					<property name="iniciarBPM" value="true"/>
					<property name="crearNuevo" value="true"/>
					<property name="forzarTipoProcedimiento" value="HCJ002"/>
				</bean>

				<!-- ACTUALIZACION DE CABECERA RECURSO -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.RecursoConsumer">
					<constructor-arg>
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DATOS-RECURSO"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Actualización de un recurso"/>
				</bean>

				<!-- ACTUALIZACION DE CABECERA SUBASTA -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.SubastaConsumer">
					<constructor-arg>
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DATOS-SUBASTA"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Actualización de una subasta"/>
				</bean>
				
				<!-- CONVENIOS -->
				<!-- NO SE USA 
				<bean class="es.pfsgroup.recovery.haya.integration.bpm.consumer.ConvenioConsumer">
					<constructor-arg>
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DATOS-CONVENIO"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Actualización de un convenio"/>
				</bean-->

				<!-- NOTIFICACIONES DE TAREA ... -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.TareaNotificacionConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="TAREA-NOTIF"/>
						</bean>
					</constructor-arg>
					<constructor-arg index="1" ref="diccionarioCodigosConsumer"/>
					<property name="description" value="Gestión de tarea notificaciones"/>
				</bean>
				

			</list>
		</constructor-arg>
	</bean>

	<!-- TRADUCTOR DE CODIGOS PROCEDIMIENTOS, TAREAS, DD -->
	<bean id ="diccionarioCodigosConsumer" class="es.pfsgroup.recovery.integration.bpm.DiccionarioDeCodigos">
		<constructor-arg>
			<map>
				<entry key="procedimientos">
					<map>
					</map>
				</entry>
				<entry key="tareas">
					<map>
					</map>
				</entry>
				<entry key="DD">
					<map>
					</map>
				</entry>
			</map>
		</constructor-arg>
	</bean>

</beans>