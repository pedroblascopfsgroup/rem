<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:context="http://www.springframework.org/schema/context" 
    xmlns:p="http://www.springframework.org/schema/p"
    xmlns:tx="http://www.springframework.org/schema/tx"
    xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
               http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd
               http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd"
    default-autowire="byName">

	<!-- Beans,handlers,Managers ... --> 
	<bean id="subastaConcursalCjLeaveActionHandler" class="es.pfsgroup.procedimientos.subasta.SubastaConcursalCjLeaveActionHandler" />
	<bean id="siguientePagoHandler" class="es.pfsgroup.procedimientos.seguimientoCumplimientoAcuerdo.SiguientePagoHandler"></bean>
 	    
	<!-- BPM activos -->
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteDeclaracionIVAIGIC/hcj_declaracionIVAIGIC.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteElevacionCajamar/hcj_elevacionCajamar.xml" p:version="-1"/>
	
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteFaseLiquidacion/cj_faseLiquidacion.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteConclusion/cj_conclusion.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/procedimientoSolicitudConcursal/cj_solicitudConcursal.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteCalificacion/cj_calificacion.xml" p:version="-1"/>		
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteFaseConvenio/cj_faseConvenio.xml" p:version="-1"/>		
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteFaseComun/cj_faseComun.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteDemandaIncidental/cj_demandaIncidental.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteDeclaracionIncumplimiento/cj_declaracionIncumplimiento.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteDemandadoEnIncidente/cj_demandadoEnIncidente.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteReaperturaConcurso/cj_reaperturaConcurso.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteHomologacionAcuerdo/cj_homologacionAcuerdo.xml" p:version="-1"/>	
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteVentaDirecta/cj_ventaDirecta.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramitePropuestaAnticipada/cj_propuestaAnticipada.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteSeguimientoCumplimientoAcuerdo/cj_seguimientoCumplimientoAcuerdo.xml" p:version="-1"/>	
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteAcuerdoExtrajudicialPagos/cj_acuerdoExtrajudicialPagos.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteResolucionInteres/cj_resolucionInteres.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteSubastaConcursal/cj_tramiteSubastaConcursal.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteCreditosContingentes/cj_creditosContingentes.xml" p:version="-1"/>
	<bean parent="bpm.processFactory" p:definitionLocation="classpath:process/pfsgroup/cajamar/tramiteSeguimientoCumplimientoConvenio/cj_seguimientoCumplimientoConvenio.xml" p:version="-1"/>
			
	<!-- Groovy's -->
	<bean id="jbpmUtilCajamarConcursos" class="es.pfsgroup.recovery.haya.utils.JBPMProcessHayaManager" >
  	<property name="contextScripts">
  		<list>
  			<value><![CDATA[ 	
				def comprobarExisteDocumentoPLALIQ = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "PLALIQ");
	            }
	            
	            def comprobarExisteDocumentoAAPLIQ = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "AAPLIQ");
	            }
	            
	            def comprobarExisteDocumentoINFRENCUE = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "INFRENCUE");
	            }
	            
	            def comprobarExisteDocumentoAUTCONCON = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "AUTCONCON");
	            }
	            
	            def comprobarExisteDocumentoINFPRO = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "INFPRO");
	            }
	            
	            def comprobarExisteDocumentoRESJUD = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "RESJUD");
	            }
	            
	            def comprobarExisteDocumentoINFADMCON = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "INFADMCON");
	            }
	            
	            def existeConvenioAprobadoJunta = {
					def convenioManager = ctx.getBean("convenioManager");
               		for (convenio in convenioManager.listaConveniosPorProcedimiento(idProcedimiento)) {
	                  	if (convenio.getEstadoConvenio().getCodigo() == '3') {
	                  		return true;
	                  	}
               		};
               
					return false;
				}
				
				def existeConvenioNoAdmitido = {
					def convenioManager = ctx.getBean("convenioManager");
					for (convenio in convenioManager.listaConveniosPorProcedimiento(idProcedimiento)) {
						if (convenio.getEstadoConvenio().getCodigo() == '4') {
							return true;
						}
					};
					return false;
				}
				
				def comprobarExisteDocumentoACTJUNACR = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "ACTJUNACR");
	            }
	            
	            def comprobarExisteDocumentoRESADE = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "RESADE");
	            }
	            
	            def comprobarExisteDocumentoBOE = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "BOE");
	            }
	            
	            def comprobarExisteDocumentoRESJUZ = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "RESJUZ");
	            }
	            
	            def comprobarExisteDocumentoINTDEM = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "INTDEM");
	            }
	            
	            def comprobarExisteDocumentoINFCANOPE = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "INFCANOPE");
	            }
	            
	            def comprobarExisteDocumentoOFEVEN = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "OFEVEN");
	            }
	            
	            def comprobarExisteDocumentoINFSOBVEN = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "INFSOBVEN");
	            }
	            
	            def comprobarExisteDocumentoAUTO = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "AUTO");
	            }
	            
	            def existeConvenioAnticipadoAsunto = {
               		def cuentaAnticipado = 0;
               		def convenioManager = ctx.getBean("convenioManager");
               		for (convenio in convenioManager.listaConveniosPorAsunto(idProcedimiento)) {
	                  	if (convenio.getTipoConvenio().getCodigo() == '1') {
	                  		cuentaAnticipado = cuentaAnticipado + 1
	                  	  	if (cuentaAnticipado>1) {
	                  	  		return false;
	                  	  	}
	                  	  	
	                  	  	if (convenio.getDescripcionAnticipado() == null) {
	                  	  		return false;
	                  	  	}
	                  	}
               		};
               		
               		if (cuentaAnticipado<1) {
               			return false;
               		} 
               		else {
               			return true;
               		}
            	}
            	
            	def existeConvenioAnticipadoAdmitidoAsunto = {
               		def convenioManager = ctx.getBean("convenioManager");
               		for (convenio in convenioManager.listaConveniosPorAsunto(idProcedimiento)) {
                  		if ((convenio.getTipoConvenio().getCodigo() == '1') && (convenio.getEstadoConvenio().getCodigo() == '2')) {
                  	 		return true;
                  		}
               		};
               		
               		return false;
            	}
            	
            	def existeConvenioAnticipadoNoAdmitidoAsunto = {
               		def convenioManager = ctx.getBean("convenioManager");
               		for (convenio in convenioManager.listaConveniosPorAsunto(idProcedimiento)) {
                  		if ((convenio.getTipoConvenio().getCodigo() == '1') && (convenio.getEstadoConvenio().getCodigo() == '4')) {
                  	 		return true;
                  		}
               		};
               		
               		return false;
            	}
            	
            	def existeConvenioAnticipadoAdmitidoTrasAprobacionAsunto = {
					def convenioManager = ctx.getBean("convenioManager");
					for (convenio in convenioManager.listaConveniosPorAsunto(idProcedimiento)) {
                		if ((convenio.getTipoConvenio().getCodigo() == '1') && (convenio.getEstadoConvenio().getCodigo() == '5')) {
	                  		return true;
    	              	}
        	       	};
        	       	
            	   	return false;
				}	
            	
            	def existeConvenioAnticipadoNoAdmitidoTrasAprobacionAsunto = {
					def convenioManager = ctx.getBean("convenioManager");
					for (convenio in convenioManager.listaConveniosPorAsunto(idProcedimiento)) {
                		if ((convenio.getTipoConvenio().getCodigo() == '1') && (convenio.getEstadoConvenio().getCodigo() == '6')) {
                  			return true;
                  		}
               		};
               		
               		return false;
				}

				def comprobarExisteDocumentoPROPLAPAG = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "PROPLAPAG");
	            }
	            
	            def comprobarExisteDocumentoINFCON = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "INFCON");
	            }

				def comprobarExisteDocumentoCERFIO = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "CERFIO");
	            }
	            
	            def comprobarExisteDocumentoLICPRIO = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "LICPRIO");
	            }
	            
	            def comprobarExisteDocumentoCERDEU = {
	                def adjudicacionProcedimientoManager = ctx.getBean("adjudicacionProcedimientoManagerDelegated");
	                return adjudicacionProcedimientoManager.comprobarAdjunto(idProcedimiento, "CERDEU");
	            }
	            
	            def dameFechaPago = {
	            	def historicoProcedimientoManager = ctx.getBean("EXTHistoricoProcedimientoManager");
	            	def listaTareas = historicoProcedimientoManager.getListByProcedimiento(idProcedimiento);
	            	def idx = -1;
	            	def ultimaTareaFinalizada = listaTareas[idx];
	            	while(ultimaTareaFinalizada.getFechaFin() == null) {
	            		idx--;
	            		ultimaTareaFinalizada = listaTareas[idx];
	            	}
	            	
	            	if(ultimaTareaFinalizada.getCodigoTarea() == 'CJ002_RegistrarAcuerdoAprobado') {
	            		return valores['CJ002_RegistrarAcuerdoAprobado']['fecha'];
	            	}
	            	else if(ultimaTareaFinalizada.getCodigoTarea() == 'CJ002_ConfirmarResultadoNotificacion' || ultimaTareaFinalizada.getCodigoTarea() == 'CJ002_ValidarFinSeguimiento') {
	            		
	            		idx = -2;
	            		def ultimaTareaCumplimiento = listaTareas[idx];
	            		while(ultimaTareaCumplimiento.getCodigoTarea() != 'CJ002_RegistrarCumplimiento') {
	            			idx--;
	            			ultimaTareaCumplimiento = listaTareas[idx];
	            		}
	            		
	            		def tareaNotificacionManager = ctx.getBean("tareaNotificacionManager");
	            		def tareaNotificacion = tareaNotificacionManager.get(ultimaTareaCumplimiento.getIdEntidad());
	            		def listaValores = tareaNotificacion.getTareaExterna().getValores();
	            		
	            		for (valor in listaValores) {
	            			if(valor.getNombre() == 'fechaPago') {
	            				return valor.getValor();
	            			}
	            		}
	            		
	            	}
	            	else {
	            		return new java.text.SimpleDateFormat('yyyy-MM-dd').format(tareaExterna.getTareaPadre().getFechaInicio());
	            	}	
	            }
	            
	            def dameFechaPagoConvenio = {
	            	def historicoProcedimientoManager = ctx.getBean("EXTHistoricoProcedimientoManager");
	            	def listaTareas = historicoProcedimientoManager.getListByProcedimiento(idProcedimiento);
	            	def idx = -1;
	            	def ultimaTareaFinalizada = listaTareas[idx];
	            	while(ultimaTareaFinalizada.getFechaFin() == null) {
	            		idx--;
	            		ultimaTareaFinalizada = listaTareas[idx];
	            	}
	            	
	            	if(ultimaTareaFinalizada.getCodigoTarea() == 'H041_registrarConvenio') {
	            		return valores['H041_registrarConvenio']['fecha'];
	            	}
	            	else if(ultimaTareaFinalizada.getCodigoTarea() == 'H041_ConfirmarResultadoNotificacion' || ultimaTareaFinalizada.getCodigoTarea() == 'H041_validarFinSeguimiento') {
	            		
	            		idx = -2;
	            		def ultimaTareaCumplimiento = listaTareas[idx];
	            		while(ultimaTareaCumplimiento.getCodigoTarea() != 'H041_registrarCumplimiento') {
	            			idx--;
	            			ultimaTareaCumplimiento = listaTareas[idx];
	            		}
	            		
	            		def tareaNotificacionManager = ctx.getBean("tareaNotificacionManager");
	            		def tareaNotificacion = tareaNotificacionManager.get(ultimaTareaCumplimiento.getIdEntidad());
	            		def listaValores = tareaNotificacion.getTareaExterna().getValores();
	            		
	            		for (valor in listaValores) {
	            			if(valor.getNombre() == 'fechaPago') {
	            				return valor.getValor();
	            			}
	            		}
	            		
	            	}
	            	else {
	            		return new java.text.SimpleDateFormat('yyyy-MM-dd').format(tareaExterna.getTareaPadre().getFechaInicio());
	            	}	
	            }
	            
	            def dameCodigoUltimaTarea = {
	            	def historicoProcedimientoManager = ctx.getBean("EXTHistoricoProcedimientoManager");
	            	def listaTareas = historicoProcedimientoManager.getListByProcedimiento(idProcedimiento);
	            	def ultimaTarea = listaTareas[-1];
	            	
	            	return ultimaTarea.getCodigoTarea();
	            }
	            
	            def plazoCumplido = {
				
					def valores = tareaExterna.getValores();
					for (valor in valores) {
						
						if (valor.getNombre() == 'fechaPago') {
							
							def fechaPago = new java.text.SimpleDateFormat('yyyy-MM-dd').parse(valor.getValor());
							def cal = java.util.Calendar.getInstance();
							cal.setTime(new java.util.Date());
							cal.add(Calendar.DATE, -90);
							def dateBefore90Days = cal.getTime();
							
							if (fechaPago.before(dateBefore90Days)) {
								return true;
							}
							else {
								return false;
							}							
						}
					}
				
					return false;
				}
				

  			 ]]>
  			</value>
  		</list>
  	</property>
  </bean> 
  
  <!-- Diccionarios -->
     
</beans>
