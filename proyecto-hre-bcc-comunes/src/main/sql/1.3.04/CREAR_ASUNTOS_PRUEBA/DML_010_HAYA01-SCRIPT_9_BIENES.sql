/* SCRIPT BIENES */ 


/*    BIE_BIEN    */ 


INSERT INTO BIE_BIEN
(
BIE_ID,
DD_TBI_ID,
BIE_PARTICIPACION,
BIE_POBLACION,
BIE_DATOS_REGISTRALES,
VERSION,
USUARIOCREAR,
FECHACREAR,
BORRADO,
BIE_DESCRIPCION,
DD_ORIGEN_ID,
BIE_MARCA_EXTERNOS,
BIE_CODIGO_INTERNO,
DTYPE,
BIE_SOLVENCIA_NO_ENCONTRADA,
BIE_CODIGO_EXTERNO
)

SELECT 
S_BIE_BIEN.NEXTVAL,
4,
100,
LOCALIDAD,
NUMERO_REGISTRO||PLAZA_REGISTRO ||NUMERO_FINCA,
0,
'CONVIVE_F2',
SYSDATE,
0,
DESCRIPCION,
1,
0,
ID_BIEN_NUSE,
'NMBBien' ,
0,
CD_BIEN
FROM (SELECT DISTINCT
LOCALIDAD,
NUMERO_REGISTRO,PLAZA_REGISTRO,NUMERO_FINCA,
DESCRIPCION,
ID_BIEN_NUSE,
CD_BIEN
FROM CNV_AUX_ALTA_PRC_BIE )B1
WHERE NOT EXISTS ( SELECT BIE_CODIGO_INTERNO FROM BIE_BIEN B2 WHERE B1.ID_BIEN_NUSE=B2.BIE_CODIGO_INTERNO ) 
and ID_BIEN_NUSE IS NOT NULL;



/* PRB_PRC_BIE  */ 

INSERT INTO PRB_PRC_BIE
(
PRB_ID,
PRC_ID,
BIE_ID,
VERSION,
USUARIOCREAR,
FECHACREAR,
BORRADO
)


SELECT 

S_PRB_PRC_BIE.nextval,
PRC_ID,
BIE_ID,
0,
'CONVIVE_F2',
SYSDATE,
0

FROM( SELECT DISTINCT
CODIGO_PROCEDIMIENTO_NUSE,
ID_BIEN_NUSE
FROM CNV_AUX_ALTA_PRC_BIE )B1
LEFT JOIN ASU_ASUNTOS ASU ON B1.CODIGO_PROCEDIMIENTO_NUSE=ASU.ASU_ID_EXTERNO
LEFT JOIN PRC_PROCEDIMIENTOS PRC  ON PRC.ASU_ID=ASU.ASU_ID
LEFT JOIN BIE_BIEN B2 ON B1.ID_BIEN_NUSE=B2.BIE_CODIGO_INTERNO
WHERE NOT EXISTS ( SELECT 1 FROM PRB_PRC_BIE PRB WHERE PRB.PRC_ID=PRC.PRC_ID AND PRB.BIE_ID=B2.BIE_ID) 
AND PRC.PRC_ID IS NOT NULL;



/*    BIE_PER    */

INSERT INTO BIE_PER
(
BIE_ID,
PER_ID,
VERSION,
USUARIOCREAR,
FECHACREAR,
BORRADO,
BIE_PER_ID
)


SELECT 

TABLA.BIE_ID,
TABLA.PER_ID,
0,
'CONVIVE_F2',
SYSDATE,
0,
S_BIE_PER.NEXTVAL

FROM (SELECT DISTINCT
PER_ID,
B2.BIE_ID

FROM CNV_AUX_ALTA_PRC_BIE B1
LEFT JOIN ASU_ASUNTOS ASU ON B1.CODIGO_PROCEDIMIENTO_NUSE=ASU.ASU_ID_EXTERNO
LEFT JOIN PEX_PERSONAS_EXPEDIENTE PEX  ON PEX.EXP_ID=ASU.EXP_ID
LEFT JOIN BIE_BIEN B2 ON B1.ID_BIEN_NUSE=B2.BIE_CODIGO_INTERNO
WHERE NOT EXISTS ( SELECT 1 FROM BIE_PER PRB WHERE PEX.PER_ID=PRB.PER_ID AND PRB.BIE_ID=B2.BIE_ID) 
 AND PEX.PER_ID IS NOT NULL) TABLA;
 
 
 
 
 /*    BIE _ CNT   */
 
 
 INSERT INTO BIE_CNT
(
BIE_CNT_ID,
CNT_ID,
BIE_ID,
DD_TBC_ID,
DD_EBC_ID,
BIE_CNT_IMPORTE_GARANTIZADO,
BIE_CNT_FECHA_INICIO,
BIE_CNT_FECHA_CIERRE,
VERSION,
USUARIOCREAR,
FECHACREAR,
BORRADO
)

SELECT 
S_BIE_CNT.NEXTVAL,
CNT_ID,
BIE_ID,
null,
DD_EBC_CODIGO,
null,
null,
null,
0,
'CONVIVE_F2',
SYSDATE,
0

FROM (SELECT DISTINCT
BIE_ID,
CNT_ID,
DD_EBC_CODIGO
FROM
CNV_AUX_ALTA_PRC_BIE B1
LEFT JOIN DD_EBC_ESTADO_BIEN_CNT DD ON DD.DD_EBC_DESCRIPCION = 'ACT'
LEFT JOIN BIE_BIEN B2 ON  B1.ID_BIEN_NUSE=B2.BIE_CODIGO_INTERNO
LEFT JOIN ASU_ASUNTOS ASU ON B1.CODIGO_PROCEDIMIENTO_NUSE=ASU.ASU_ID_EXTERNO
LEFT JOIN CEX_CONTRATOS_EXPEDIENTE CEX ON ASU.EXP_ID=CEX.EXP_ID
WHERE NOT EXISTS ( SELECT 1 FROM BIE_CNT CNT WHERE CNT.BIE_ID=B2.BIE_ID) 
AND B2.BIE_ID IS NOT NULL AND CEX.CNT_ID IS NOT NULL) TABLA;



/*   BIE_DATOS_REGISTRALES    */


INSERT INTO BIE_DATOS_REGISTRALES
(
BIE_DREG_ID,
BIE_ID,
BIE_DREG_REFERENCIA_CATASTRAL,
BIE_DREG_SUPERFICIE,
BIE_DREG_SUPERFICIE_CONSTRUIDA,
BIE_DREG_TOMO,
BIE_DREG_LIBRO,
BIE_DREG_FOLIO,
BIE_DREG_INSCRIPCION,
BIE_DREG_FECHA_INSCRIPCION,
BIE_DREG_NUM_REGISTRO,
BIE_DREG_MUNICIPIO_LIBRO,
BIE_DREG_CODIGO_REGISTRO,
VERSION,
USUARIOCREAR,
FECHACREAR,
BORRADO,
BIE_DREG_NUM_FINCA
)


SELECT 

S_BIE_DATOS_REGISTRALES.NEXTVAL,
BIE_ID,
null,
null,
null,
null,
null,
null,
null,
null,
NUMERO_REGISTRO,
PLAZA_REGISTRO,
COD_POSTAL,
0,
'CONVIVE_F2',
SYSDATE,
0,
NUMERO_FINCA

FROM(
SELECT DISTINCT 
B2.BIE_ID,
NUMERO_REGISTRO,
PLAZA_REGISTRO,
COD_POSTAL,
NUMERO_FINCA
FROM
CNV_AUX_ALTA_PRC_BIE B1
LEFT JOIN BIE_BIEN B2 ON B1.ID_BIEN_NUSE=B2.BIE_CODIGO_INTERNO AND B2.BIE_ID IS NOT NULL
WHERE NOT EXISTS ( SELECT 1 FROM BIE_DATOS_REGISTRALES R WHERE R.BIE_ID=B2.BIE_ID) AND B2.BIE_ID IS NOT NULL)TABLA;



/*    BIE_LOCALIZACION   */

INSERT INTO BIE_LOCALIZACION
(
BIE_LOC_ID,
BIE_ID,
BIE_LOC_POBLACION,
BIE_LOC_DIRECCION,
BIE_LOC_COD_POST,
VERSION,
USUARIOCREAR,
FECHACREAR,
BORRADO,
DD_PRV_ID
)


SELECT 

S_BIE_LOCALIZACION.NEXTVAL,
BIE_ID,
LOCALIDAD,
null,
COD_POSTAL,
0,
'CONVIVE_F2',
SYSDATE,
0,
DD_PRV_ID

FROM (SELECT DISTINCT
BIE_ID,
LOCALIDAD,
COD_POSTAL,
DD_PRV_ID,
B2.USUARIOCREAR
FROM
CNV_AUX_ALTA_PRC_BIE B1
LEFT JOIN BIE_BIEN B2 ON  B1.ID_BIEN_NUSE=B2.BIE_CODIGO_INTERNO
LEFT JOIN HAYAMASTER.DD_PRV_PROVINCIA DD ON TRANSLATE(UPPER(DD_PRV_DESCRIPCION), 'ÁÉÍÓÚÀÈÌÒÙÄËÏÖÜÂÊÎÔÛ', 'AEIOUAEIOUAEIOUAEIOU') = TRANSLATE(UPPER(B2.BIE_POBLACION), 'ÁÉÍÓÚÀÈÌÒÙÄËÏÖÜÂÊÎÔÛ', 'AEIOUAEIOUAEIOUAEIOU')

WHERE NOT EXISTS ( SELECT 1 FROM BIE_LOCALIZACION LOC WHERE LOC.BIE_ID=B2.BIE_ID) AND B2.BIE_ID IS NOT NULL)TABLA;



/* BIE_ADICIONAL   */


INSERT INTO BIE_ADICIONAL
(
BIE_ADI_ID,
BIE_ID,
BIE_ADI_NOM_EMPRESA,
BIE_ADI_CIF_EMPRESA,
BIE_ADI_COD_IAE,
BIE_ADI_DES_IAE,
DD_TPB_ID,
DD_TPN_ID,
BIE_ADI_VALORACION,
BIE_ADI_ENTIDAD,
BIE_ADI_NUM_CUENTA,
BIE_ADI_MATRICULA,
BIE_ADI_BASTIDOR,
BIE_ADI_MODELO,
BIE_ADI_MARCA,
BIE_ADI_FECHAMATRICULA,
VERSION,
USUARIOCREAR,
FECHACREAR,
BORRADO,
BIE_ADI_FFIN_REV_CARGA,
BIE_ADI_SIN_CARGA,
BIE_ADI_OBS_CARGA
)


SELECT 

S_BIE_ADICIONAL.NEXTVAL,
BIE_ID,
null,
null,
null,
null,
null,
null,
null,
null,
null,
null,
null,
null,
null,
null,
0,
'CONVIVE_F2',
SYSDATE,
0,
null,
null,
null

FROM (SELECT DISTINCT
BIE_ID

FROM
CNV_AUX_ALTA_PRC_BIE B1
LEFT JOIN BIE_BIEN B2 ON  B1.ID_BIEN_NUSE=B2.BIE_CODIGO_INTERNO

WHERE NOT EXISTS ( SELECT 1 FROM BIE_ADICIONAL ADI WHERE ADI.BIE_ID=B2.BIE_ID) AND B2.BIE_ID IS NOT NULL)TABLA;



/*    BIE_VALORACIONES   */ 

INSERT INTO BIE_VALORACIONES
(
BIE_VAL_ID,
BIE_ID,
BIE_FECHA_VALOR_SUBJETIVO,
BIE_IMPORTE_VALOR_SUBJETIVO,
BIE_FECHA_VALOR_APRECIACION,
BIE_IMPORTE_VALOR_APRECIACION,
BIE_FECHA_VALOR_TASACION,
BIE_IMPORTE_VALOR_TASACION,
VERSION,
USUARIOCREAR,
FECHACREAR,
BORRADO,
BIE_RESPUESTA_CONSULTA,
BIE_VALOR_TASACION_EXT,
BIE_F_TAS_EXTERNA,
DD_TRA_ID,
BIE_F_SOL_TASACION,
BIE_CD_NUITA
)


SELECT 

S_BIE_VALORACIONES.NEXTVAL,
BIE_ID,
null,
null,
null,
null,
null,
null,
0,
'CONVIVE_F2',
SYSDATE,
0,
null,
null,
null,
null,
null,
null

FROM (SELECT DISTINCT
BIE_ID

FROM
CNV_AUX_ALTA_PRC_BIE B1
LEFT JOIN BIE_BIEN B2 ON  B1.ID_BIEN_NUSE=B2.BIE_CODIGO_INTERNO

WHERE NOT EXISTS ( SELECT 1 FROM BIE_VALORACIONES VAL WHERE VAL.BIE_ID=B2.BIE_ID) AND B2.BIE_ID IS NOT NULL)TABLA;



/*   BIE_BIEN_ENTIDAD   */

INSERT INTO BIE_BIEN_ENTIDAD
(
BIE_ID,
DD_TBI_ID,
BIE_PARTICIPACION,
BIE_VALOR_ACTUAL,
BIE_IMPORTE_CARGAS,
BIE_SUPERFICIE,
BIE_POBLACION,
BIE_DATOS_REGISTRALES,
BIE_REFERENCIA_CATASTRAL,
BIE_DESCRIPCION,
BIE_FECHA_VERIFICACION,
DD_ORIGEN_ID,
BIE_MARCA_EXTERNOS,
DD_TPO_CARGA_ID,
BIE_CODIGO_INTERNO,
BIE_SOLVENCIA_NO_ENCONTRADA,
BIE_OBSERVACIONES,
BIE_LOC_ID,
BIE_LOC_POBLACION,
BIE_LOC_DIRECCION,
BIE_LOC_COD_POST,
DD_PRV_ID,
BIE_DREG_ID,
BIE_DREG_REFERENCIA_CATASTRAL,
BIE_DREG_SUPERFICIE,
BIE_DREG_SUPERFICIE_CONSTRUIDA,
BIE_DREG_TOMO,
BIE_DREG_LIBRO,
BIE_DREG_FOLIO,
BIE_DREG_INSCRIPCION,
BIE_DREG_FECHA_INSCRIPCION,
BIE_DREG_NUM_REGISTRO,
BIE_DREG_MUNICIPIO_LIBRO,
BIE_DREG_CODIGO_REGISTRO,
BIE_DREG_NUM_FINCA,
BIE_ADI_ID,
BIE_ADI_NOM_EMPRESA,
BIE_ADI_CIF_EMPRESA,
BIE_ADI_COD_IAE,
BIE_ADI_DES_IAE,
DD_TPB_ID,
DD_TPN_ID,
BIE_ADI_VALORACION,
BIE_ADI_ENTIDAD,
BIE_ADI_NUM_CUENTA,
BIE_ADI_MATRICULA,
BIE_ADI_BASTIDOR,
BIE_ADI_MODELO,
BIE_ADI_MARCA,
BIE_ADI_FECHAMATRICULA,
BIE_VAL_ID,
BIE_FECHA_VALOR_SUBJETIVO,
BIE_IMPORTE_VALOR_SUBJETIVO,
BIE_FECHA_VALOR_APRECIACION,
BIE_IMPORTE_VALOR_APRECIACION,
BIE_FECHA_VALOR_TASACION,
BIE_IMPORTE_VALOR_TASACION,
VERSION,
USUARIOCREAR,
FECHACREAR,
BORRADO
)


SELECT 

BIE_ID,
DD_TBI_ID,
BIE_PARTICIPACION,
BIE_VALOR_ACTUAL,
BIE_IMPORTE_CARGAS,
BIE_SUPERFICIE,
BIE_POBLACION,
BIE_DATOS_REGISTRALES,
BIE_REFERENCIA_CATASTRAL,
BIE_DESCRIPCION,
BIE_FECHA_VERIFICACION,
DD_ORIGEN_ID,
BIE_MARCA_EXTERNOS,
DD_TPO_CARGA_ID,
BIE_CODIGO_INTERNO,
BIE_SOLVENCIA_NO_ENCONTRADA,
BIE_OBSERVACIONES,
BIE_LOC_ID,
BIE_LOC_POBLACION,
BIE_LOC_DIRECCION,
BIE_LOC_COD_POST,
DD_PRV_ID,
BIE_DREG_ID,
BIE_DREG_REFERENCIA_CATASTRAL,
BIE_DREG_SUPERFICIE,
BIE_DREG_SUPERFICIE_CONSTRUIDA,
BIE_DREG_TOMO,
BIE_DREG_LIBRO,
BIE_DREG_FOLIO,
BIE_DREG_INSCRIPCION,
BIE_DREG_FECHA_INSCRIPCION,
BIE_DREG_NUM_REGISTRO,
BIE_DREG_MUNICIPIO_LIBRO,
BIE_DREG_CODIGO_REGISTRO,
BIE_DREG_NUM_FINCA,
BIE_ADI_ID,
BIE_ADI_NOM_EMPRESA,
BIE_ADI_CIF_EMPRESA,
BIE_ADI_COD_IAE,
BIE_ADI_DES_IAE,
DD_TPB_ID,
DD_TPN_ID,
BIE_ADI_VALORACION,
BIE_ADI_ENTIDAD,
BIE_ADI_NUM_CUENTA,
BIE_ADI_MATRICULA,
BIE_ADI_BASTIDOR,
BIE_ADI_MODELO,
BIE_ADI_MARCA,
BIE_ADI_FECHAMATRICULA,
BIE_VAL_ID,
BIE_FECHA_VALOR_SUBJETIVO,
BIE_IMPORTE_VALOR_SUBJETIVO,
BIE_FECHA_VALOR_APRECIACION,
BIE_IMPORTE_VALOR_APRECIACION,
BIE_FECHA_VALOR_TASACION,
BIE_IMPORTE_VALOR_TASACION,
0,
'CONVIVE_F2',
SYSDATE,
0

FROM (SELECT DISTINCT
B1.ID_BIEN_NUSE,
B2.BIE_ID,
B2.DD_TBI_ID,
B2.BIE_PARTICIPACION,
B2.BIE_VALOR_ACTUAL,
B2.BIE_IMPORTE_CARGAS,
B2.BIE_SUPERFICIE,
B2.BIE_POBLACION,
B2.BIE_DATOS_REGISTRALES,
B2.BIE_REFERENCIA_CATASTRAL,
B2.BIE_DESCRIPCION,
B2.BIE_FECHA_VERIFICACION,
B2.DD_ORIGEN_ID,
B2.BIE_MARCA_EXTERNOS,
B2.DD_TPO_CARGA_ID,
B2.BIE_CODIGO_INTERNO,
B2.BIE_SOLVENCIA_NO_ENCONTRADA,
B2.BIE_OBSERVACIONES,
LOC.BIE_LOC_ID,
LOC.BIE_LOC_POBLACION,
LOC.BIE_LOC_DIRECCION,
LOC.BIE_LOC_COD_POST,
LOC.DD_PRV_ID,
DAT.BIE_DREG_ID,
DAT.BIE_DREG_REFERENCIA_CATASTRAL,
DAT.BIE_DREG_SUPERFICIE,
DAT.BIE_DREG_SUPERFICIE_CONSTRUIDA,
DAT.BIE_DREG_TOMO,
DAT.BIE_DREG_LIBRO,
DAT.BIE_DREG_FOLIO,
DAT.BIE_DREG_INSCRIPCION,
DAT.BIE_DREG_FECHA_INSCRIPCION,
DAT.BIE_DREG_NUM_REGISTRO,
DAT.BIE_DREG_MUNICIPIO_LIBRO,
DAT.BIE_DREG_CODIGO_REGISTRO,
DAT.BIE_DREG_NUM_FINCA,
ADI.BIE_ADI_ID,
ADI.BIE_ADI_NOM_EMPRESA,
ADI.BIE_ADI_CIF_EMPRESA,
ADI.BIE_ADI_COD_IAE,
ADI.BIE_ADI_DES_IAE,
ADI.DD_TPB_ID,
ADI.DD_TPN_ID,
ADI.BIE_ADI_VALORACION,
ADI.BIE_ADI_ENTIDAD,
ADI.BIE_ADI_NUM_CUENTA,
ADI.BIE_ADI_MATRICULA,
ADI.BIE_ADI_BASTIDOR,
ADI.BIE_ADI_MODELO,
ADI.BIE_ADI_MARCA,
ADI.BIE_ADI_FECHAMATRICULA,
VAL.BIE_VAL_ID,
VAL.BIE_FECHA_VALOR_SUBJETIVO,
VAL.BIE_IMPORTE_VALOR_SUBJETIVO,
VAL.BIE_FECHA_VALOR_APRECIACION,
VAL.BIE_IMPORTE_VALOR_APRECIACION,
VAL.BIE_FECHA_VALOR_TASACION,
VAL.BIE_IMPORTE_VALOR_TASACION


FROM
CNV_AUX_ALTA_PRC_BIE B1
LEFT JOIN BIE_BIEN B2 ON  B1.ID_BIEN_NUSE=B2.BIE_CODIGO_INTERNO
LEFT JOIN BIE_LOCALIZACION LOC ON LOC.BIE_ID=B2.BIE_ID
LEFT JOIN  BIE_DATOS_REGISTRALES DAT ON DAT.BIE_ID=B2.BIE_ID
LEFT JOIN BIE_ADICIONAL ADI ON ADI.BIE_ID=B2.BIE_ID
LEFT JOIN BIE_VALORACIONES VAL ON VAL.BIE_ID = B2.BIE_ID

WHERE NOT EXISTS ( SELECT 1 FROM BIE_BIEN_ENTIDAD ENT WHERE ENT.BIE_ID=B2.BIE_ID) AND B2.BIE_ID IS NOT NULL)TABLA;


COMMIT;