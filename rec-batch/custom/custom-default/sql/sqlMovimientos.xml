<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>

  <entry key="movimientos.diasDescubiertoMovimiento">
    <![CDATA[
        SELECT c.cnt_fecha_extraccion - m.mov_fecha_pos_vencida
        FROM cnt_contratos c, mov_movimientos m
        WHERE c.cnt_id = ?  
        AND c.cnt_id = m.cnt_id
        AND m.mov_fecha_extraccion =
                       (SELECT   MAX (mov.mov_fecha_extraccion)
                          FROM   mov_movimientos mov
                         WHERE   mov.cnt_id = c.cnt_id
                                 AND mov.mov_fecha_extraccion < c.cnt_fecha_extraccion)
    ]]>
  </entry>

  <entry key="movimientos.buscarDiasPosVencida.MySQLDialect">
    <![CDATA[
	 SELECT datediff(sysdate(), MOV_FECHA_POS_VENCIDA) FROM mov_movimientos WHERE MOV_ID = ?
    ]]>
  </entry>
  
  <entry key="movimientos.buscarDiasPosVencida">
    <![CDATA[
      SELECT sysdate - MOV_FECHA_POS_VENCIDA FROM mov_movimientos WHERE MOV_ID = ?
    ]]>
  </entry>

  <entry key="movimientos.buscarDiferenciaContrato">
    <![CDATA[
    SELECT
            CASE WHEN e.dd_esc_codigo = ? THEN 1 ELSE 0 end Cancelado,
            CASE WHEN (movAct.mov_deuda_irregular = 0) THEN 1 ELSE 0 END SaldadoSinMovAnterior,
            CASE WHEN (movAct.mov_deuda_irregular = 0 AND movAnt.mov_deuda_irregular <> 0) THEN 1 ELSE 0 END Saldado,                 
            nvl(movAnt.mov_deuda_irregular - movAct.mov_deuda_irregular, 0) Diferencia,
            movAct.mov_deuda_irregular Importe,
            movAnt.mov_deuda_irregular ImporteAnterior,
            t.dd_tpe_activo activo,
            movAnt.MOV_FECHA_POS_VENCIDA fechaVencido,
            movAct.mov_fecha_extraccion fechaExtraccion
          FROM cnt_contratos c, dd_tpe_tipo_prod_entidad t, mov_movimientos movAct, mov_movimientos movAnt, ${master.schema}.dd_esc_estado_cnt e
          WHERE c.dd_tpe_id = t.dd_tpe_id
          AND c.cnt_id = ?
          and c.dd_esc_id = e.dd_esc_id
          AND movAct.cnt_id = c.cnt_id  and movAct.MOV_FECHA_EXTRACCION = c.cnt_fecha_extraccion
          AND movAnt.cnt_id = c.cnt_id
          and movAnt.MOV_FECHA_EXTRACCION = (SELECT CASE WHEN MAX(mov_fecha_extraccion)IS NULL
                            THEN c.cnt_fecha_extraccion
                            ELSE MAX(mov_fecha_extraccion) END
                FROM mov_movimientos
                WHERE mov_fecha_extraccion < c.cnt_fecha_extraccion and CNT_ID = c.cnt_id)
    ]]>
  </entry>
  
  

  
  
  
  <entry key="movimientos.historificarMovimientosQuery">
    <![CDATA[
   INSERT INTO H_MOV_MOVIMIENTOS(CNT_ID, MOV_FECHA_EXTRACCION, MOV_ID, MOV_POS_VIVA_NO_VENCIDA, MOV_POS_VIVA_VENCIDA, MOV_FECHA_POS_VENCIDA, MOV_SALDO_DUDOSO, MOV_FECHA_DUDOSO, MOV_PROVISION, 
		MOV_INT_REMUNERATORIOS, MOV_INT_MORATORIOS, MOV_COMISIONES, MOV_GASTOS, MOV_FICHERO_CARGA, MOV_FECHA_CARGA, DD_EFC_ID, CNT_FECHA_EFC, DD_EFC_ID_ANT, CNT_FECHA_EFC_ANT, DD_TPR_ID, DD_TPE_ID, 
		CNT_COD_ENTIDAD, CNT_COD_OFICINA, CNT_COD_CENTRO, CNT_CONTRATO, DD_ESC_ID, CNT_FECHA_ESC, ZON_ID, VERSION, USUARIOCREAR, FECHACREAR, USUARIOMODIFICAR, FECHAMODIFICAR, USUARIOBORRAR, 
		FECHABORRAR, BORRADO, FECHAHIST, USUARIOHIST, MOV_RIESGO,MOV_DEUDA_IRREGULAR,MOV_DISPUESTO,MOV_SALDO_PASIVO,MOV_RIESGO_GARANT,MOV_SALDO_EXCE,MOV_LIMITE_DESC,MOV_EXTRA_1,MOV_EXTRA_2,
	    MOV_LTV_INI,MOV_LTV_FIN,DD_MX3_ID,DD_MX4_ID,MOV_EXTRA_5,MOV_EXTRA_6,CNT_LIMITE_INI,CNT_LIMITE_FIN,DD_FCN_ID,DD_FNO_ID,DD_GC1_ID,DD_GC2_ID,DD_CT1_ID,DD_CT2_ID,DD_CT3_ID,DD_CT4_ID,DD_CT5_ID,
	    DD_CT6_ID,CNT_FECHA_CREACION,CNT_FECHA_CONSTITUCION,CNT_FECHA_VENC, DD_SCO_ID, MOV_FECHA_DATO, MOV_ENTREGAS_A_CUENTA, MOV_INTERESES_ENTREGAS, MOV_PENDIENTE_DESEMBOLSO,
	    MOV_PROVISION_PORCENTAJE)
	SELECT c.CNT_ID, MOV_FECHA_EXTRACCION, MOV_ID, MOV_POS_VIVA_NO_VENCIDA, MOV_POS_VIVA_VENCIDA, MOV_FECHA_POS_VENCIDA, MOV_SALDO_DUDOSO, MOV_FECHA_DUDOSO, MOV_PROVISION, 
		MOV_INT_REMUNERATORIOS, MOV_INT_MORATORIOS, MOV_COMISIONES, MOV_GASTOS, MOV_FICHERO_CARGA, MOV_FECHA_CARGA, DD_EFC_ID, CNT_FECHA_EFC, DD_EFC_ID_ANT, CNT_FECHA_EFC_ANT, DD_TPR_ID, DD_TPE_ID, 
		CNT_COD_ENTIDAD, CNT_COD_OFICINA, CNT_COD_CENTRO, CNT_CONTRATO, DD_ESC_ID, CNT_FECHA_ESC, ZON_ID, m.VERSION, m.USUARIOCREAR, m.FECHACREAR, m.USUARIOMODIFICAR, m.FECHAMODIFICAR, m.USUARIOBORRAR, 
		m.FECHABORRAR, m.BORRADO, sysdate, 'BATCH_HIST', MOV_RIESGO,MOV_DEUDA_IRREGULAR,MOV_DISPUESTO,MOV_SALDO_PASIVO,MOV_RIESGO_GARANT,MOV_SALDO_EXCE,MOV_LIMITE_DESC,MOV_EXTRA_1,MOV_EXTRA_2,
	    MOV_LTV_INI,MOV_LTV_FIN,DD_MX3_ID,DD_MX4_ID,MOV_EXTRA_5,MOV_EXTRA_6,CNT_LIMITE_INI,CNT_LIMITE_FIN,DD_FCN_ID,DD_FNO_ID,DD_GC1_ID,DD_GC2_ID,DD_CT1_ID,DD_CT2_ID,DD_CT3_ID,DD_CT4_ID,DD_CT5_ID,
	    DD_CT6_ID,CNT_FECHA_CREACION,CNT_FECHA_CONSTITUCION,CNT_FECHA_VENC, DD_SCO_ID,MOV_FECHA_DATO, MOV_ENTREGAS_A_CUENTA, MOV_INTERESES_ENTREGAS, MOV_PENDIENTE_DESEMBOLSO,
	    MOV_PROVISION_PORCENTAJE
	FROM CNT_CONTRATOS C
	INNER JOIN MOV_MOVIMIENTOS M ON C.CNT_ID = M.CNT_ID
	WHERE
		MOV_ID NOT IN
		    (
		        SELECT MOV_ID FROM CNT_CONTRATOS C INNER JOIN MOV_MOVIMIENTOS M 
		        	ON c.cnt_id = m.cnt_id and (c.cnt_fecha_extraccion = m.mov_fecha_extraccion or m.mov_fecha_extraccion = (select max(mov_fecha_extraccion) FROM mov_movimientos where cnt_id = c.cnt_id and mov_fecha_extraccion < c.cnt_fecha_extraccion))            
		    )
		AND NOT EXISTS (SELECT * FROM H_MOV_MOVIMIENTOS WHERE CNT_ID = C.CNT_ID AND MOV_FECHA_EXTRACCION = M.MOV_FECHA_EXTRACCION)
    ]]>
  </entry>
  
  <entry key="movimientos.eliminarMovimientosHistorificadosQuery">
    <![CDATA[
		DELETE FROM MOV_MOVIMIENTOS
		WHERE MOV_ID NOT IN
	    (
	      	SELECT MOV_ID 
	      	FROM CNT_CONTRATOS C 
	      		INNER JOIN MOV_MOVIMIENTOS M 
	      			ON C.CNT_ID = M.CNT_ID 
          				AND (C.CNT_FECHA_EXTRACCION = M.MOV_FECHA_EXTRACCION OR M.MOV_FECHA_EXTRACCION = (SELECT MAX(MOV_FECHA_EXTRACCION) FROM MOV_MOVIMIENTOS WHERE CNT_ID = C.CNT_ID AND MOV_FECHA_EXTRACCION < C.CNT_FECHA_EXTRACCION))
	    )
	    AND EXISTS (SELECT * FROM H_MOV_MOVIMIENTOS H WHERE H.CNT_ID = CNT_ID AND H.MOV_FECHA_EXTRACCION = MOV_FECHA_EXTRACCION)
	]]>
  </entry>

</properties>