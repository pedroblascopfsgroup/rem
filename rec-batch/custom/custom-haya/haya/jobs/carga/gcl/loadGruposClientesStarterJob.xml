<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:p="http://www.springframework.org/schema/p" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd" default-autowire="byName"
   default-merge="true">

   <bean id="batch.task.UnZipi64Support" abstract="true" class="es.pfsgroup.recovery.batch.tasks.Unzip64SupportTasklet"/>
   <bean id="batch.task.PFSDataLoader" abstract="true" class="es.pfsgroup.recovery.batch.tasks.PFSDataLoaderTasklet"/>

   <bean id="loadGruposClientesStarterJob" parent="batch.simpleJob" scope="prototype">
      <property name="steps">
         <list>
				<!-- Descomprimir el fichero .TXT -->
            <bean id="gcl.unzip" parent="batch.taskletStep" scope="prototype">
               <property name="tasklet">
                  <bean parent="batch.task.UnZipi64Support" p:bindings="zipFileName=zipFile,zipFilesToExtract=zipFilesToExtract,pathToExtract=pathToExtract" scope="prototype">
                    <property name="severidad" value="error"/>
                    <property name="message" value="unzip.errorUnziping"/>
                  </bean>                            
               </property>
            </bean>
<!--                                     GCL                                         -->
<!-- 				Convertir el fichero Grupos .TXT en .CSV  -->
<!--						 
            <bean id="cargaGcl.grupos.convert" parent="batch.simpleStep" scope="prototype">
               <property name="itemReader" ref="cargaGcl.grupos.itemReader" />
               <property name="itemWriter" ref="cargaGcl.grupos.itemWriter" />
               <property name="commitInterval" value="5000" />
            </bean>

            <bean id="cargaGcl.relaciones.convert" parent="batch.simpleStep" scope="prototype">
               <property name="itemReader" ref="cargaGcl.relaciones.itemReader" />
               <property name="itemWriter" ref="cargaGcl.relaciones.itemWriter" />
               <property name="commitInterval" value="5000" />
            </bean>
-->
		<!-- Carga de datos -->
            <bean id="cargaCtl.grupos.load" parent="batch.taskletStep" scope="prototype">
               <property name="tasklet">
                  <bean parent="batch.task.PFSDataLoader" scope="prototype"> 
							<!-- Parámetros Fijos del DataLoader -->
                     <property name="dataSource" ref="entityDataSource" />
                     <property name="afterScript">
                        <value>
                                UPDATE TMP_GCL_GRUPOS_CLIENTES SET tmp_gcl_fichero_carga = '${inFile}';
                                ANALYZE TABLE TMP_GCL_GRUPOS_CLIENTES ${sql.analyze};
                        </value>
                     </property>                      
				     <!-- Parámetros Fijos del DataLoader que vienen en los JobParameters -->
                     <property name="bindings" value="fileSystemResource=csvFileGclGrupos${batch.loaderParams}" />
					 <!-- Parámetros Opcionales del DataLoader -->
                     <property name="params">
                        <map> 
		    			   <!-- de Oracle -->
                           <entry key="pathToSqlLoader" value="${batch.pathToSqlLoader}" />
                           <entry key="controlFile" value="haya/load/pcr/gruposClientesDataLoad.ctl" />
                           <entry key="connectionInfo" value="${batch.connectionInfo}" />
                           <entry key="parameters" value="${batch.sqlLoaderParameters}" />
                        </map>
                     </property>
                     <property name="message" value="cargaGclGrupos.dataLoad" />
                     <property name="severidad" value="error" />
                  </bean>
               </property>
            </bean> 
            
            <bean id="cargaCtl.relaciones.load" parent="batch.taskletStep" scope="prototype">
               <property name="tasklet">
                  <bean parent="batch.task.PFSDataLoader" scope="prototype"> 
							<!-- Parámetros Fijos del DataLoader -->
                     <property name="dataSource" ref="entityDataSource" />
                     <property name="afterScript">
                        <value>
                                UPDATE TMP_PER_GCL SET TMP_PER_GCL_FICHERO_CARGA = '${inFile}';
                                ANALYZE TABLE TMP_PER_GCL ${sql.analyze};
                        </value>
                     </property>                      
				     <!-- Parámetros Fijos del DataLoader que vienen en los JobParameters -->
                     <property name="bindings" value="fileSystemResource=csvFileGclRL${batch.loaderParams}" />
					 <!-- Parámetros Opcionales del DataLoader -->
                     <property name="params">
                        <map> 
		    			   <!-- de Oracle -->
                           <entry key="pathToSqlLoader" value="${batch.pathToSqlLoader}" />
                           <entry key="controlFile" value="haya/load/pcr/gruposClientesRelacionesDataLoad.ctl" />
                           <entry key="connectionInfo" value="${batch.connectionInfo}" />
                           <entry key="parameters" value="${batch.sqlLoaderParameters}" />
                        </map>
                     </property>
                     <property name="message" value="cargaGclRLGrupos.dataLoad" />
                     <property name="severidad" value="error" />
                  </bean>
               </property>
            </bean> 
		</list>
	</property>
	</bean>
<!--                                              FIN GCL                                                    -->

   
	<!-- No delimited reader -->
   <bean id="cargaGcl.grupos.itemReader" parent="batch.task.FlatFileItemReader" scope="prototype">
      <property name="bindings" value="fileSystemResource=txtFileGclGrupos" />
      <property name="recordSeparatorPolicy">
         <bean class="org.springframework.batch.item.file.separator.SimpleRecordSeparatorPolicy"/>
      </property>      
      <property name="lineTokenizer">
         <bean parent="batch.transform.FixedLengthTokenizer"
            p:columns="1-8,9-12,13-32,33-52,53-112"/>
      </property>
      <property name="fieldSetMapper">
         <bean parent="batch.mapper.PassThroughFieldSetMapper" />
      </property>
      <property name="message" value="cargaGcl.grupos.tokenizerError" />
      <property name="severidad" value="error" />
   </bean>

	<!-- Custom delimited writer -->
   <bean id="cargaGcl.grupos.itemWriter" parent="batch.task.FlatFileItemWriter" scope="prototype">
      <property name="bindings" value="fileSystemResource=csvFileGclGrupos" />
      <property name="fieldSetCreator">
         <bean parent="batch.mapper.PassThroughFieldSetMapper" />
      </property>
      <property name="lineAggregator">
         <bean parent="batch.transform.DelimitedLineAggregator" p:stringFields="3,4" />
      </property>
      <property name="message" value="cargaGcl.grupos.itemWriter" />
      <property name="severidad" value="error" />
      <property name="trim" value="true" />
   </bean>
   
   <!-- No delimited reader -->
   <bean id="cargaGcl.relaciones.itemReader" parent="batch.task.FlatFileItemReader" scope="prototype">
      <property name="bindings" value="fileSystemResource=txtFileGclRL" />
      <property name="recordSeparatorPolicy">
         <bean class="org.springframework.batch.item.file.separator.SimpleRecordSeparatorPolicy"/>
      </property>      
      <property name="lineTokenizer">
         <bean parent="batch.transform.FixedLengthTokenizer"
            p:columns="1-8,9-12,13-32,33-52,53-72,73-73"/>
      </property>
      <property name="fieldSetMapper">
         <bean parent="batch.mapper.PassThroughFieldSetMapper" />
      </property>
      <property name="message" value="cargaGcl.relaciones.tokenizerError" />
      <property name="severidad" value="error" />
   </bean>

	<!-- Custom delimited writer -->
   <bean id="cargaGcl.relaciones.itemWriter" parent="batch.task.FlatFileItemWriter" scope="prototype">
      <property name="bindings" value="fileSystemResource=csvFileGclRL" />
      <property name="fieldSetCreator">
         <bean parent="batch.mapper.PassThroughFieldSetMapper" />
      </property>
      <property name="lineAggregator">
         <bean parent="batch.transform.DelimitedLineAggregator" p:stringFields="4" />
      </property>
      <property name="message" value="cargaGcl.relaciones.itemWriter" />
      <property name="severidad" value="error" />
      <property name="trim" value="true" />
   </bean>

</beans>
