<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:p="http://www.springframework.org/schema/p" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd"
	default-autowire="byName" default-merge="true">

	<bean id="procesoRearquetipacionExpedientesJob" parent="batch.simpleJob"
		scope="prototype">
		<property name="steps">
			<list>
				<!-- Paso 1 -->
				<bean parent="batch.taskletStep" scope="prototype">
					<property name="tasklet">
						<bean parent="batch.task.MultipleSqlScript" p:dataSource-ref="entityDataSource">
							<property name="scripts">
								<!-- Lista de scrpts SQL ha ejecutar -->
								<list>								
									<!-- Truncado de la tabla TMP_REC_EXP_REARQUETIPADO -->
									<map>
										<entry key="sql">
											<bean parent="sql"
												p:key="recobro.borrado.tmp_rec_exp_rearquetipado" />
										</entry>
										<entry key="message" value="recobro.borrado.tmp_rec_exp_rearquetipado" />
										<entry key="severidad" value="error" />
									</map>
									<!-- Truncado de la tabla TMP_REC_EXP_ROTACION -->
									<map>
										<entry key="sql">
											<bean parent="sql"
												p:key="recobro.borrado.tmp_rec_exp_rotacion" />
										</entry>
										<entry key="message" value="recobro.borrado.tmp_rec_exp_rotacion" />
										<entry key="severidad" value="error" />
									</map>
									<!-- Truncado de la tabla TMP_REC_EXP_DESNORMALIZADO_ARQ -->
									<map>
										<entry key="sql">
											<bean parent="sql"
												p:key="recobro.borrado.tmp_rec_exp_desnormalizado_arq" />
										</entry>
										<entry key="message"
											value="recobro.borrado.tmp_rec_exp_desnormalizado_arq" />
										<entry key="severidad" value="error" />
									</map>
									<!-- Truncado de la tabla TMP_REC_EXP_ASIG_CARTERA -->
									<map>
										<entry key="sql">
											<bean parent="sql"
												p:key="recobro.borrado.tmp_rec_exp_asig_cartera" />
										</entry>
										<entry key="message" value="recobro.borrado.tmp_rec_exp_asig_cartera" />
										<entry key="severidad" value="error" />
									</map>
									<!-- Recompilado de la vista TMP_REC_PER_DATA_RULE_ENGIE -->
									<map>
										<entry key="sql">
											<bean parent="sql"
												p:key="recobro.recompile.tmp_rec_per_data_rule_engine" />
										</entry>
										<entry key="message"
											value="recobro.recompile.tmp_rec_per_data_rule_engine" />
										<entry key="severidad" value="error" />
									</map>
								</list>
							</property>
						</bean>
					</property>
				</bean>
				<!-- PASO 2 -->
				<bean id="batch.recobro.taskletRearquetipacion" parent="batch.taskletStep"
					scope="prototype">
					<property name="tasklet">
						<bean
							class="es.capgemini.pfs.batch.revisar.arquetipos.RevisionGenericaArquetiposTasklet"
							scope="prototype">
							<property name="ruleExecutor">
								<bean
									class="es.capgemini.pfs.batch.revisar.arquetipos.engine.ExtendedRuleExecutor">
									<!-- Este bean extiende por composición el RuleExecutor, por lo 
										tanto le vamos a inyectar el bean original -->
									<property name="engine">
										<bean class="es.capgemini.pfs.ruleengine.RuleExecutor" />
									</property>
									<property name="config">
										<bean id="arquetiposRuleExecutorConf"
											class="es.capgemini.pfs.batch.revisar.arquetipos.ExtendedRuleExecutorConfig">
											<!-- Política de arquetipación: INSERT | UPDATE (deprecated) -->
											<property name="policy" value="INSERT" />

											<!-- Formato de la definición de la regla XML | JSON -->
											<property name="ruleDefinitionType" value="XML" />
											<!-- Tabla desde la que consultamos en busca de variables -->
											<property name="tableFrom" value="TMP_REC_PER_DATA_RULE_ENGINE" />
											<property name="columnFromRef" value="PER_ID" />


											<!-- Tabla en la que escribimos el resultado de la arquetipación -->
											<property name="tableToInsert" value="ARP_ARQ_RECOBRO_PERSONA" />
											<property name="pkColumn" value="ARP_ID" />
											<property name="pkSequence" value="S_ARP_ARQ_RECOBRO_PERSONA" />
											<property name="columnToRef" value="PER_ID" />
											<property name="columnArqId" value="ARQ_ID" />
											<property name="columnArqName" value="ARQ_NAME" />
											<property name="columnArqPriority" value="ARQ_PRIO" />
											<property name="columnArqDate" value="ARQ_DATE" />

											<!-- Indicamos qué vistas materializadas queremos refrescar al 
												empezar el proceso -->
											<!-- <property name="refreshViews"> <value>DATA_RULE_ENGINE</value> 
												</property> -->
										</bean>
									</property>
								</bean>
							</property>
							<property name="arquetiposRepo">
								<bean
									class="es.capgemini.pfs.batch.revisar.arquetipos.repo.RepositorioArquetiposGenerico">
									<property name="dataSource" ref="entityDataSource" />
									<property name="repoConfig">
										<bean
											class="es.capgemini.pfs.batch.revisar.arquetipos.repo.RepositorioConfig">
											<property name="query">
												<value><![CDATA[
													SELECT DISTINCT RCF_CAR_ID, RCF_ESC_PRIORIDAD, RCF_CAR_NOMBRE, RD_DEFINITION
														FROM BATCH_RCF_ENTRADA
														WHERE RCF_DD_EES_CODIGO = 'LBR'										
												]]></value>
											</property>
											<property name="columnForValue" value="RCF_CAR_ID" />
											<property name="columnForPriority" value="RCF_ESC_PRIORIDAD" />
											<property name="columnForName" value="RCF_CAR_NOMBRE" />
											<property name="columnForRuleDefinition" value="RD_DEFINITION" />
										</bean>
									</property>
								</bean>
							</property>
						</bean>
					</property>
				</bean>
				<bean parent="batch.taskletStep" scope="prototype">
					<property name="tasklet">
						<bean parent="batch.task.MultipleSqlScript" p:dataSource-ref="entityDataSource">
							<property name="scripts">
								<!-- Lista de scrpts SQL ha ejecutar -->
								<list>
									<!-- Truncado de la tabla TMP_REC_EXP_REARQUETIPADO -->
									<map>
										<entry key="sql">
											<bean parent="sql"
												p:key="recobro.insert.tmp_rec_exp_desnormalizado_arq" />
										</entry>
										<entry key="message"
											value="recobro.insert.tmp_rec_exp_desnormalizado_arq" />
										<entry key="severidad" value="error" />
									</map>
								</list>
							</property>
						</bean>
					</property>
				</bean>
				<!-- PASO 3 y 4 -->
				<bean parent="batch.taskletStep" scope="prototype">
					<property name="tasklet">
						<bean parent="batch.task.MultipleSqlScript" p:dataSource-ref="entityDataSource">
							<property name="scripts">
								<list>
									<!-- Paso 3 - Rearquetipado de expedientes -->
									<map>
										<entry key="sql">
											<bean parent="sql"
												p:key="recobro.create.tmp_arq_recobro" />
										</entry>
										<entry key="message"
											value="recobro.create.tmp_arq_recobro" />
										<entry key="severidad" value="error" />
									</map>
									<map>
										<entry key="sql">
											<bean parent="sql"
												p:key="recobro.insert.tmp_rec_exp_rearquetipado" />
										</entry>
										<entry key="message" value="recobro.insert.tmp_rec_exp_rearquetipado" />
										<entry key="severidad" value="error" />
									</map>
									<map>
										<entry key="sql">
											<bean parent="sql"
												p:key="recobro.drop.tmp_arq_recobro" />
										</entry>
										<entry key="message"
											value="recobro.drop.tmp_arq_recobro" />
										<entry key="severidad" value="error" />
									</map>
									<!-- Paso 4 - Marcar expedientes para rotación o para asignar a 
										cartera -->
									<map>
										<entry key="sql">
											<bean parent="sql"
												p:key="recobro.insert.tmp_rec_exp_rotacion" />
										</entry>
										<entry key="message" value="recobro.insert.tmp_rec_exp_rotacion" />
										<entry key="severidad" value="error" />
									</map>
									<map>
										<entry key="sql">
											<bean parent="sql"
												p:key="recobro.insert.tmp_rec_exp_asig_cartera" />
										</entry>
										<entry key="message" value="recobro.insert.tmp_rec_exp_asig_cartera" />
										<entry key="severidad" value="error" />
									</map>
								</list>
							</property>
						</bean>
					</property>
				</bean>
			</list>
		</property>
	</bean>
</beans>