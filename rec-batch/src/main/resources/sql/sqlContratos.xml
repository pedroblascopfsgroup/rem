<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>

  <entry key="contratos.buscarFuturosClientes">
    <![CDATA[
       SELECT DISTINCT p.per_id
           FROM per_personas p
             JOIN arq_arquetipos arq_per ON p.arq_id = arq_per.arq_id
             JOIN arq_arquetipos arq_cal ON p.arq_id_calculado = arq_cal.arq_id
           WHERE 1=1
           /* Que tenga un arquetipo ACTUAL con fecha de disparo que cuadre */
           AND (arq_per.arq_plazo_disparo is null OR p.per_ultima_operacion is null OR (sysdate-p.per_ultima_operacion > arq_per.arq_plazo_disparo))
           /* Que tenga un arquetipo NUEVO gestionable */
           AND arq_cal.arq_gestion = 1
           /* Que tenga un NUEVO arquetipo que sea de recuperacion */
           AND EXISTS (SELECT iti.iti_id FROM iti_itinerarios iti JOIN ${master.schema}.dd_tit_tipo_itinerarios tit ON iti.dd_tit_id = tit.dd_tit_id WHERE arq_cal.iti_id = iti.iti_id AND tit.dd_tit_codigo = ?)
           AND
           (
             CASE WHEN arq_per.dd_tsn_id is null THEN 1
             ELSE CASE WHEN arq_cal.arq_nivel <> arq_per.arq_nivel AND arq_per.dd_tsn_id = (SELECT dd_tsn_id FROM ${master.schema}.DD_TSN_TIPO_SALTO_NIVEL WHERE dd_tsn_codigo = ?) THEN 1
                ELSE CASE WHEN arq_cal.arq_nivel > arq_per.arq_nivel AND arq_per.dd_tsn_id = (SELECT dd_tsn_id FROM ${master.schema}.DD_TSN_TIPO_SALTO_NIVEL WHERE dd_tsn_codigo = ?) THEN 1
                    ELSE CASE WHEN arq_cal.arq_nivel < arq_per.arq_nivel AND arq_per.dd_tsn_id = (SELECT dd_tsn_id FROM ${master.schema}.DD_TSN_TIPO_SALTO_NIVEL WHERE dd_tsn_codigo = ?) THEN 1
                        ELSE 0 END END END END
           ) = 1
           /* Que la persona no esté atrapada en ningún expediente de seguimiento */
           AND NOT EXISTS (
             SELECT pex.per_id
                 FROM pex_personas_expediente pex
                     JOIN exp_expedientes exp ON pex.exp_id = exp.exp_id
                     JOIN ${master.schema}.dd_eex_estado_expediente eex ON exp.dd_eex_id = eex.dd_eex_id
                     JOIN ARQ_ARQUETIPOS arq ON exp.arq_id = arq.arq_id
                     JOIN iti_itinerarios iti ON arq.iti_id = iti.iti_id
                     JOIN ${master.schema}.dd_tit_tipo_itinerarios tit ON iti.dd_tit_id = tit.dd_tit_id
                 WHERE pex.borrado = 0
                     AND tit.dd_tit_codigo IN (?, ?)
                     AND pex.per_id = p.per_id
                     AND eex.dd_eex_codigo IN (?, ?, ?)
           )
           /* Que la persona no tenga un cliente creado */
           AND NOT EXISTS (
             SELECT c.per_id
                 FROM CLI_CLIENTES c
                 WHERE c.borrado = 0
                     AND c.per_id = p.per_id
           )
           /* Que la persona tenga algún contrato que esté libre */
           AND EXISTS (
             SELECT c.cnt_id
               FROM cnt_contratos c
                 JOIN  mov_movimientos m ON m.cnt_id = c.cnt_id AND m.mov_fecha_extraccion = c.cnt_fecha_extraccion
                 JOIN cpe_contratos_personas cpe ON cpe.cnt_id = c.cnt_id
                 JOIN dd_tin_tipo_intervencion tin ON cpe.DD_TIN_ID = tin.DD_TIN_ID
                 JOIN ${master.schema}.dd_esc_estado_cnt e ON c.dd_esc_id = e.dd_esc_id
             WHERE cpe.per_id = p.per_id
               /* Que tenga un contrato vencido */
               AND m.mov_deuda_irregular > 0
               AND m.mov_fecha_pos_vencida IS NOT NULL
               /* Que sea titular del contrato */
               AND tin.DD_TIN_TITULAR = 1
               /* Que el contrato no esté ni borrado ni cancelado */
               AND c.borrado = 0 AND e.dd_esc_codigo <> ?
               /* Que el contrato no esté en algún procedimiento 'en curso' */
               AND c.cnt_id NOT IN (
                   SELECT DISTINCT cex.cnt_id FROM CEX_CONTRATOS_EXPEDIENTE cex, PRC_CEX pce, PRC_PROCEDIMIENTOS prc, ${master.schema}.DD_EPR_ESTADO_PROCEDIMIENTO epr
                   WHERE cex.cex_id = pce.cex_id
                   and pce.prc_id = prc.prc_id
                   and cex.borrado = 0 and prc.borrado = 0
                   and prc.dd_epr_id = epr.dd_epr_id
                   and dd_epr_codigo IN (?, ?, ?, ?, ?)
               UNION
                    /* Que el contrato no esté algún expediente 'en curso' */
                   SELECT DISTINCT cex.cnt_id FROM cex_contratos_expediente cex, ${master.schema}.dd_eex_estado_expediente eex, exp_expedientes exp
                   WHERE exp.exp_id = cex.exp_id
                   and cex.borrado = 0
                   and eex.dd_eex_id = exp.dd_eex_id
                   and eex.dd_eex_codigo IN (?, ?, ?)
               UNION
               /* Que el contrato no esté en algún cliente 'en curso' */
                   SELECT DISTINCT cnt_id FROM ccl_contratos_cliente
                   WHERE borrado = 0
               UNION
                    SELECT -1 FROM dual
               )
            )
     ]]>
  </entry>

  <entry key="contratos.buscarFechaPosVencidaParaContratos">
    <![CDATA[
      SELECT MIN(mov_fecha_pos_vencida) FROM mov_movimientos WHERE
     ]]>
  </entry>

  <!--  Scripts para la carga de recuperaciones  -->

  <entry key="contratos.registrarRecuperacion.MySQLDialect">
    <![CDATA[
      INSERT into rec_recuperaciones
        (CNT_ID,
         DD_EST_ID,
         ASU_ID,
         EXP_ID,
         CLI_ID,
         REC_FECHA_ENTREGA,
         REC_IMPORTE_ENTREGADO,
         REC_IMPORTE_RECUPERADO,
         USUARIOCREAR,
         FECHACREAR)
      SELECT
         ?,
         (SELECT dd_est_id FROM cli_clientes WHERE cli_id = ?),
         ?,
         ?,
         ?,
         mAct.mov_fecha_extraccion,
         abs(?),
         abs(?) + (mAnt.mov_int_remuneratorios - mAct.mov_int_remuneratorios)
                + (mAnt.mov_int_moratorios - mAct.mov_int_moratorios)
                + (mAnt.mov_comisiones - mAct.mov_comisiones)
                + (mAnt.mov_gastos - mAct.mov_gastos),
         ?,
         ${sql.function.now}
      FROM
      (SELECT * FROM mov_movimientos m, cnt_contratos c WHERE c.cnt_id = ? AND m.cnt_id = c.cnt_id AND mov_fecha_extraccion = c.cnt_fecha_extraccion) mAct,
      (SELECT * FROM mov_movimientos WHERE cnt_id = ? AND mov_fecha_extraccion =
        (SELECT MAX(mov_fecha_extraccion) FROM mov_movimientos m, cnt_contratos c WHERE m.cnt_id= ? AND m.cnt_id = c.cnt_id  AND mov_fecha_extraccion < c.cnt_fecha_extraccion)) mAnt
    ]]>
  </entry>

  <entry key="contratos.registrarRecuperacion.Oracle10gDialect">
    <![CDATA[
      INSERT into rec_recuperaciones
        (REC_ID,
         CNT_ID,
         DD_EST_ID,
         ASU_ID,
         EXP_ID,
         CLI_ID,
         REC_FECHA_ENTREGA,
         REC_IMPORTE_ENTREGADO,
         REC_IMPORTE_RECUPERADO,
         USUARIOCREAR,
         FECHACREAR)
      SELECT
         S_REC_RECUPERACIONES.nextVal,
         ?,
         (SELECT dd_est_id FROM cli_clientes WHERE cli_id = ?),
         ?,
         ?,
         ?,
         mAct.mov_fecha_extraccion,
         abs(?),
         abs(?) + (mAnt.mov_int_remuneratorios - mAct.mov_int_remuneratorios)
                + (mAnt.mov_int_moratorios - mAct.mov_int_moratorios)
                + (mAnt.mov_comisiones - mAct.mov_comisiones)
                + (mAnt.mov_gastos - mAct.mov_gastos),
         ?,
         ${sql.function.now}
      FROM
      (SELECT * FROM mov_movimientos m, cnt_contratos c WHERE c.cnt_id = ? AND m.cnt_id = c.cnt_id AND mov_fecha_extraccion = c.cnt_fecha_extraccion) mAct,
      (SELECT * FROM mov_movimientos WHERE cnt_id = ? AND mov_fecha_extraccion =
        (SELECT MAX(mov_fecha_extraccion) FROM mov_movimientos m, cnt_contratos c WHERE m.cnt_id= ? AND m.cnt_id = c.cnt_id  AND mov_fecha_extraccion < c.cnt_fecha_extraccion)) mAnt
    ]]>
  </entry>


  <entry key="contratos.buscarSaldoProcedimientoAsunto">
    <![CDATA[
        SELECT PRC_SALDO_RECUPERACION FROM prc_procedimientos p, cex_contratos_expediente cex, prc_cex pce
        WHERE cex.cex_id = pce.cex_id and pce.prc_id = p.prc_id AND p.ASU_ID = ? AND cex.cnt_id = ? AND p.borrado = 0
    ]]>
  </entry>



  <entry key="contratos.buscarIdRecuperaciones.MySQLDialect">
    <![CDATA[
      SELECT rec_id FROM rec_recuperaciones WHERE cnt_id = ? AND rec_fecha_entrega = ?
    ]]>
  </entry>
  <entry key="contratos.buscarIdRecuperaciones.Oracle10gDialect">
    <![CDATA[
      SELECT rec_id FROM rec_recuperaciones WHERE cnt_id = ? AND rec_fecha_entrega = to_date(?, 'yyyy-MM-dd')
    ]]>
  </entry>
  <entry key="contratos.buscarRecuperaciones.MySQLDialect">
    <![CDATA[
      SELECT
        REC_ID id,
        CNT_ID contratoId,
        ASU_ID asuntoId,
        EXP_ID expId,
        CLI_ID clienteId,
        REC_FECHA_ENTREGA fechaEntrega,
        REC_IMPORTE_ENTREGADO importeEntregado,
        REC_IMPORTE_RECUPERADO importeRecuperado
      FROM rec_recuperaciones WHERE cnt_id = ? AND rec_fecha_entrega = ?
    ]]>
  </entry>
  <entry key="contratos.buscarRecuperaciones.Oracle10gDialect">
    <![CDATA[
      SELECT
        REC_ID id,
        CNT_ID contratoId,
        ASU_ID asuntoId,
        EXP_ID expId,
        CLI_ID clienteId,
        REC_FECHA_ENTREGA fechaEntrega,
        REC_IMPORTE_ENTREGADO importeEntregado,
        REC_IMPORTE_RECUPERADO importeRecuperado
      FROM rec_recuperaciones WHERE cnt_id = ? AND rec_fecha_entrega = to_date(?, 'yyyy-MM-dd')
    ]]>
  </entry>

</properties>
