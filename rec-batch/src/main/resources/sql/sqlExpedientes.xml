<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>	
  	<entry key="expedientes.expedientesActivos">
	  	<![CDATA[
      SELECT e.exp_id, cex.cnt_id, cex.cex_pase, e.EXP_PROCESS_BPM, e.exp_manual       
      FROM exp_expedientes e
          JOIN ${master.schema}.dd_eex_estado_expediente eex ON e.dd_eex_id = eex.dd_eex_id AND eex.dd_eex_codigo in (?,?,?)
          JOIN cex_contratos_expediente cex ON cex.exp_id = e.exp_id
          JOIN CNT_CONTRATOS cnt ON cex.cnt_id = cnt.cnt_id
          JOIN ${master.schema}.dd_esc_estado_cnt esc ON cnt.dd_esc_id = esc.dd_esc_id
          JOIN MOV_MOVIMIENTOS mov ON mov.cnt_id = cnt.cnt_id and 
               (mov.mov_fecha_extraccion = cnt.cnt_fecha_extraccion 
               OR ? = (SELECT esc.dd_esc_codigo FROM ${master.schema}.dd_esc_estado_cnt esc WHERE cnt.dd_esc_id = esc.dd_esc_id))
          JOIN dd_tpe_tipo_prod_entidad t ON cnt.dd_tpe_id = t.dd_tpe_id
      WHERE e.borrado = 0      
      ORDER BY e.exp_id
	   ]]>
  	</entry>
  	<entry key="expedientes.liberarContrato">
  		<![CDATA[
  			update cex_contratos_expediente 
            set borrado = 1 
            where cnt_id = ? and exp_id = ? and borrado = 0
  		]]>
  	</entry>	
  	<entry key="expedientes.cancelarExpediente">
  		<![CDATA[
  			update exp_expedientes 
            set DD_EEX_ID = (select DD_EEX_ID from ${master.schema}.DD_EEX_ESTADO_EXPEDIENTE where DD_EEX_CODIGO = ?), 
            exp_process_bpm = null 
            where exp_id = ? and borrado = 0
  		]]>
  	</entry>
  	<entry key="expedientes.recuperacion.clientesParaExpedimentar.Oracle9iDialect">
  		<![CDATA[
		WITH fechasEstados AS (
			  SELECT SYSDATE - ((((SUM(est.est_plazo)/1000)/24)/60)/60) fecha, --Sumamos los días
			    ARQ_ID, arq_prioridad
			  FROM arq_arquetipos arq
			  INNER JOIN iti_itinerarios iti
			    ON arq.iti_id = iti.iti_id
			  INNER JOIN est_estados est
			    ON iti.iti_id = est.iti_id
			  INNER JOIN ${master.schema}.dd_est_estados_itinerarios dd_est
			    ON est.dd_est_id = dd_est.dd_est_id
			    and DD_EST.DD_EST_ORDEN <= --Sumamos todos los plazos que estén por debajo de GestiónVencidos
			    (SELECT DD_EST_ORDEN
			    FROM ${master.schema}.DD_EST_ESTADOS_ITINERARIOS
			    WHERE DD_EST_CODIGO = ${ddEstadoItinerario.gestionVencidos.codigo}
			    )
			  INNER JOIN ${master.schema}.DD_EIN_ENTIDAD_INFORMACION DD_EIN --Solo los de la entidad cliente
			    ON DD_EST.DD_EIN_ID        = DD_EIN.DD_EIN_ID
			    AND DD_EIN_CODIGO          = ${ddEntidadInformacion.Cliente.codigo}        
        where arq.borrado = 0
        GROUP BY ARQ.ARQ_ID, arq.arq_prioridad --Agrupamos por arquetipo para poder calcular el plazo del itinerario de los clientes        
         )
		 SELECT cli.cli_id
		    FROM fechasEstados vFechas
		    INNER JOIN cli_clientes cli
		      ON vFechas.arq_id = cli.arq_id 
		    INNER JOIN ${master.schema}.dd_est_estados_itinerarios dd_est --Solo los que estén en gestionVencidos
		      ON cli.dd_est_id  = dd_est.dd_est_id
		      AND dd_est_codigo = ${ddEstadoItinerario.gestionVencidos.codigo}
		    INNER JOIN ${master.schema}.DD_EIN_ENTIDAD_INFORMACION DD_EIN
		      ON DD_EST.DD_EIN_ID = DD_EIN.DD_EIN_ID
		      AND DD_EIN_CODIGO   = ${ddEntidadInformacion.Cliente.codigo}
		    WHERE 
		      CLI.BORRADO   = 0
		      AND TO_DATE(CLI.CLI_FECHA_CREACION,'DD/MM/YY') <= vFechas.fecha  --Que estén fuera de plazo del itinerario
		      /* Ordenamos por prioridad del arquetipo para crear primero expedientes a los clientes con arq. más prioritarios 
		      	 y desechar a las personas relacionadas menos prioritarias*/
		  ORDER BY arq_prioridad 		
  		]]>
  	</entry>
</properties>
