<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>

    <entry key="gcl-11.lastLoadDateValidator">
         <![CDATA[
         SELECT FRC_FECHA_EXTRACCION AS ERROR_FIELD,
         'GCL' AS ENTITY_CODE
         from FRC_FICHEROS_CARGADOS
         where FRC_FECHA_EXTRACCION > to_date(?,'YYYYMMDD')
         and DD_TFI_ID = (select DD_TFI_ID from ${master.schema}.DD_TFI_TIPO_FICHERO where DD_TFI_CODIGO='GCL')
          ]]>
    </entry>
    <entry key="gcl-01.entityValidatorGrupos">
         <![CDATA[
          SELECT TMP_GCL_CODIGO AS ERROR_FIELD, TMP_GCL_COD_ENTIDAD AS ENTITY_CODE
          FROM TMP_GCL_GRUPOS_CLIENTES WHERE TMP_GCL_COD_ENTIDAD <> ?
          ]]>
    </entry>
    <entry key="gcl-05.entityValidatorRelaciones">
         <![CDATA[
          SELECT  TMP_PER_GCL_COD_CLI AS ERROR_FIELD, TMP_PER_GCL_COD_ENTIDAD AS ENTITY_CODE
          FROM TMP_PER_GCL WHERE TMP_PER_GCL_COD_ENTIDAD <> ?
          ]]>
    </entry>
    <entry key="gcl-02.loadDateValidatorGrupos">
      <![CDATA[
         SELECT TMP_GCL_CODIGO AS ERROR_FIELD,
         TMP_GCL_CODIGO AS ENTITY_CODE
         from TMP_GCL_GRUPOS_CLIENTES where TMP_GCL_FECHA_EXTRACCION <> to_date(?,'YYYYMMDD')
         ]]>
    </entry>

    <entry key="gcl-06.loadDateValidatorRelaciones">
      <![CDATA[
         SELECT TMP_PER_GCL_COD_CLI AS ERROR_FIELD,
         TMP_PER_GCL_COD_CLI AS ENTITY_CODE
         from TMP_PER_GCL where TMP_PER_GCL_FECHA_EXTRACCION <> to_date(?,'YYYYMMDD')
         ]]>
    </entry>

    <entry key="gcl-03.insertTipoGrupoValidator">
        <![CDATA[
        INSERT INTO DD_TGL_TIPO_GRUPO_CLIENTE
        (DD_TGL_ID, DD_TGL_CODIGO, DD_TGL_DESCRIPCION, USUARIOCREAR, FECHACREAR, BORRADO)
        SELECT S_DD_TGL_TIPO_GRUPO_CLIENTE.NEXTVAL,
        TGLX.DD_TGL_CODIGO,
        TGLX.DD_TGL_DESCRIPCION,
        '${PasajeAProducciÃ³nUser}',SYSTIMESTAMP,0
        FROM (
        SELECT DISTINCT ERROR_FIELD as DD_TGL_CODIGO, 'Tipo grupo cliente pendiente de definir ('||ERROR_FIELD||')' as DD_TGL_DESCRIPCION
        from (
            SELECT TMP_GCL_TIPO_GRUPO AS ERROR_FIELD, TMP_GCL_CODIGO AS ENTITY_CODE
            from TMP_GCL_GRUPOS_CLIENTES
            where not exists (select * from DD_TGL_TIPO_GRUPO_CLIENTE dd where dd.DD_TGL_CODIGO = TMP_GCL_TIPO_GRUPO )
        )
        ) TGLX
        ]]>
    </entry>

    <entry key="gcl-03.tipoGrupoValidator">
        SELECT TMP_GCL_TIPO_GRUPO AS ERROR_FIELD, TMP_GCL_CODIGO AS ENTITY_CODE
        from TMP_GCL_GRUPOS_CLIENTES
        where not exists (select * from DD_TGL_TIPO_GRUPO_CLIENTE dd where dd.DD_TGL_CODIGO = TMP_GCL_TIPO_GRUPO )
    </entry>

    <entry key="gcl-04.gruposVaciosValidator">
        SELECT TMP_GCL_CODIGO AS ERROR_FIELD, TMP_GCL_CODIGO AS ENTITY_CODE
        from TMP_GCL_GRUPOS_CLIENTES glc
        where not exists (select *
                          from TMP_PER_GCL rel
                          where glc.TMP_GCL_CODIGO = rel.TMP_PER_GCL_CODIGO_GRUPO
                          and glc.TMP_GCL_TIPO_GRUPO = rel.TMP_PER_GCL_TIPO_GRUPO)
    </entry>

    <entry key="gcl-07.personasValidator">
        SELECT pgl.TMP_PER_GCL_COD_CLI AS ERROR_FIELD, pgl.TMP_PER_GCL_COD_CLI AS ENTITY_CODE
        from TMP_PER_GCL pgl
        where not exists (select * from PER_PERSONAS per where pgl.TMP_PER_GCL_COD_CLI = per.PER_COD_CLIENTE_ENTIDAD)
    </entry>

    <entry key="gcl-08.personasGruposValidator">
        SELECT pgl.TMP_PER_GCL_CODIGO_GRUPO AS ERROR_FIELD, pgl.TMP_PER_GCL_COD_CLI AS ENTITY_CODE
        from TMP_PER_GCL pgl
        where not exists (select *
                          from TMP_GCL_GRUPOS_CLIENTES g
                          where pgl.TMP_PER_GCL_CODIGO_GRUPO = g.TMP_GCL_CODIGO)
    </entry>

    <entry key="gcl-12.deleteDuplicatedPersonsAndGroups">
    <![CDATA[
    DELETE FROM TMP_GCL_GRUPOS_CLIENTES A
    WHERE ROWID > ANY
    (
      SELECT B.rowid
      FROM TMP_GCL_GRUPOS_CLIENTES B
      WHERE
        A.TMP_GCL_CODIGO = B.TMP_GCL_CODIGO
         AND
        A.TMP_GCL_TIPO_GRUPO = B.TMP_GCL_TIPO_GRUPO
    )
    ]]>
    </entry>


    <entry key="gcl-12.gruposRepetidosValidator">
         <![CDATA[
            SELECT  glc1.TMP_GCL_CODIGO AS ERROR_FIELD,  glc1.TMP_GCL_CODIGO AS ENTITY_CODE
            from TMP_GCL_GRUPOS_CLIENTES glc1, TMP_GCL_GRUPOS_CLIENTES glc2
            where glc1.TMP_GCL_CODIGO = glc2.TMP_GCL_CODIGO
            and glc1.TMP_GCL_TIPO_GRUPO = glc2.TMP_GCL_TIPO_GRUPO
            and glc1.TMP_GCL_ID <> glc2.TMP_GCL_ID
         ]]>
    </entry>

    <entry key="gcl-13.deleteDuplicatedRelations">
    <![CDATA[
    DELETE FROM TMP_PER_GCL A
    WHERE ROWID > ANY
    (
      SELECT B.rowid
      FROM TMP_PER_GCL B
      WHERE A.TMP_PER_GCL_COD_CLI = B.TMP_PER_GCL_COD_CLI
    )
    ]]>
    </entry>


    <entry key="gcl-13.personasEnMasDeUnGrupoValidator">
         <![CDATA[
            SELECT pgl.TMP_PER_GCL_CODIGO_GRUPO AS ERROR_FIELD, pgl.TMP_PER_GCL_COD_CLI AS ENTITY_CODE
            from TMP_PER_GCL pgl,TMP_PER_GCL pgl1
            where pgl.TMP_PER_GCL_ID <> pgl1.TMP_PER_GCL_ID
            and pgl.TMP_PER_GCL_COD_CLI = pgl1.TMP_PER_GCL_COD_CLI
         ]]>
    </entry>

 <entry key="gcl-15.tipoRelacionGrupoValidator">
        SELECT TMP_PER_GCL_TIPO_RELACION AS ERROR_FIELD, TMP_PER_GCL_CODIGO_GRUPO AS ENTITY_CODE
        from TMP_PER_GCL
        where not exists (select * from DD_TGE_TIPO_RELACION_GRUPO dd where dd.DD_TGE_CODIGO = TMP_PER_GCL_TIPO_RELACION)
    </entry>


    <entry key="gcl.borrarRelacionesAnteriores">
        DELETE FROM PER_GCL
    </entry>

    <entry key="gcl.borrarGruposAnteriores">
        DELETE FROM GCL_GRUPOS_CLIENTES
    </entry>

    <entry key="gcl.pasajeGruposProduccion">
      BEGIN
        OPERACION_DDL.DDL_TABLE('STATS','TMP_GCL_GRUPOS_CLIENTES');
        INSERT INTO GCL_GRUPOS_CLIENTES (
           GCL_ID,
           DD_TGL_ID,
           GCL_CODIGO,
           GCL_NOMBRE,
           GCL_FECHA_EXTRACCION,
           GCL_FICHERO_CARGA,
           GCL_RIESGO_DIR,
                   GCL_RIESGO_INDIR,
           VERSION,
           USUARIOCREAR,
           FECHACREAR,
           BORRADO,
           GCL_CHAR_EXTRA1,
               GCL_CHAR_EXTRA2,
           GCL_FLAG_EXTRA1,
                   GCL_FLAG_EXTRA2,
                   GCL_DATE_EXTRA1,
                   GCL_DATE_EXTRA2,
                   GCL_NUM_EXTRA1,
                   GCL_NUM_EXTRA2
        )SELECT
            S_GCL_GRUPOS_CLIENTES.nextVal,
            (select dd.DD_TGL_ID from DD_TGL_TIPO_GRUPO_CLIENTE dd where dd.DD_TGL_CODIGO = TMP_GCL_TIPO_GRUPO),
            TMP_GCL_CODIGO,
            TMP_GCL_NOMBRE,
            TMP_GCL_FECHA_EXTRACCION,
            TMP_GCL_FICHERO_CARGA,
            TMP_GCL_RIESGO_DIRECTO,
            TMP_GCL_RIESGO_INDIRECTO,
            0,
            '${gcl.userPasaje}',
            SYSDATE,
            0,
                    TMP_GCL_CHAR_EXTRA1,
                        TMP_GCL_CHAR_EXTRA2,
                        TMP_GCL_FLAG_EXTRA1,
                        TMP_GCL_FLAG_EXTRA2,
                        TMP_GCL_DATE_EXTRA1,
                        TMP_GCL_DATE_EXTRA2,
                        TMP_GCL_NUM_EXTRA1,
                        TMP_GCL_NUM_EXTRA2
        from TMP_GCL_GRUPOS_CLIENTES;
      END;
    </entry>

    <entry key="gcl.pasajeRelacionesProduccion">
      BEGIN
        OPERACION_DDL.DLL_TABLE('STATS','TMP_PER_GCL');
        INSERT INTO PER_GCL (
            PER_GCL_ID,
            GCL_ID,
            PER_ID,
            DD_TGE_ID,
            PER_GCL_FECHA_EXTRACCION,
            PER_GCL_FICHERO_CARGA,
            VERSION,
            USUARIOCREAR,
            FECHACREAR,
            BORRADO,
            PER_GCL_CHAR_EXTRA1,
            PER_GCL_CHAR_EXTRA2,
            PER_GCL_FLAG_EXTRA1,
            PER_GCL_FLAG_EXTRA2,
            PER_GCL_DATE_EXTRA1,
            PER_GCL_DATE_EXTRA2,
            PER_GCL_NUM_EXTRA1,
            PER_GCL_NUM_EXTRA2 )
        SELECT
          S_PER_GCL.NEXTVAL,
          gcl.GCL_ID,
          PER.PER_ID,
          dd.DD_TGE_ID,
          TMP_PER_GCL_FECHA_EXTRACCION,
          TMP_PER_GCL_FICHERO_CARGA,
          0,
          '${gcl.userPasaje}',
          SYSDATE,
          0,
          TMP_PER_GCL_CHAR_EXTRA1,
          TMP_PER_GCL_CHAR_EXTRA2,
          TMP_PER_GCL_FLAG_EXTRA1,
          TMP_PER_GCL_FLAG_EXTRA2,
          TMP_PER_GCL_DATE_EXTRA1,
          TMP_PER_GCL_DATE_EXTRA2,
          TMP_PER_GCL_NUM_EXTRA1,
          TMP_PER_GCL_NUM_EXTRA2
        FROM TMP_PER_GCL
          LEFT JOIN PER_PERSONAS PER ON TMP_PER_GCL_COD_CLI = PER.PER_COD_CLIENTE_ENTIDAD
          LEFT JOIN DD_TGE_TIPO_RELACION_GRUPO DD ON DD.DD_TGE_CODIGO = TMP_PER_GCL_TIPO_RELACION
          INNER JOIN GCL_GRUPOS_CLIENTES GCL ON GCL.GCL_CODIGO = TMP_PER_GCL_CODIGO_GRUPO;
       END;
    </entry>
</properties>
