-- Para añadir un tipo de prorroga a las causas y las razones de prorroga (interna o externa)
CREATE SEQUENCE S_DD_TPR_TIPO_PRORROGA;

CREATE TABLE DD_TPR_TIPO_PRORROGA  (
   DD_TPR_ID            NUMBER(16)                      NOT NULL,
   DD_TPR_CODIGO        VARCHAR2(20)                    NOT NULL,
   DD_TPR_DESCRIPCION   VARCHAR2(50),
   DD_TPR_DESCRIPCION_LARGA VARCHAR2(250),
   VERSION              INTEGER                        DEFAULT 0 NOT NULL,
   USUARIOCREAR         VARCHAR2(10)                    NOT NULL,
   FECHACREAR           TIMESTAMP                       NOT NULL,
   USUARIOMODIFICAR     VARCHAR2(10),
   FECHAMODIFICAR       TIMESTAMP,
   USUARIOBORRAR        VARCHAR2(10),
   FECHABORRAR          TIMESTAMP,
   BORRADO              NUMBER(1,0)                    DEFAULT 0 NOT NULL,
   CONSTRAINT PK_DD_TPR_TIPO_PRORROGA PRIMARY KEY (DD_TPR_ID)
);

ALTER TABLE DD_TPR_TIPO_PRORROGA
 ADD CONSTRAINT UK_DD_TPR_TIPO_PRORROGA
 UNIQUE (DD_TPR_CODIGO);


INSERT INTO DD_TPR_TIPO_PRORROGA (DD_TPR_ID,DD_TPR_CODIGO,DD_TPR_DESCRIPCION,DD_TPR_DESCRIPCION_LARGA,USUARIOCREAR,FECHACREAR) 
VALUES (S_DD_TPR_TIPO_PRORROGA.nextVal,'INT','Primaria / Interna','Primaria / Interna','DD',SYSDATE);


INSERT INTO DD_TPR_TIPO_PRORROGA (DD_TPR_ID,DD_TPR_CODIGO,DD_TPR_DESCRIPCION,DD_TPR_DESCRIPCION_LARGA,USUARIOCREAR,FECHACREAR) 
VALUES (S_DD_TPR_TIPO_PRORROGA.nextVal,'EXT','Externa','Externa','DD',SYSDATE);



ALTER TABLE DD_CPR_CAUSA_PRORROGA
 ADD (DD_TPR_ID NUMBER);
 
ALTER TABLE DD_RPR_RAZON_PRORROGA
 ADD (DD_TPR_ID NUMBER);


update DD_CPR_CAUSA_PRORROGA
set dd_tpr_id = (SELECT dd_tpr_id FROM DD_TPR_TIPO_PRORROGA where dd_tpr_codigo = 'INT');

update DD_RPR_RAZON_PRORROGA
set dd_tpr_id = (SELECT dd_tpr_id FROM DD_TPR_TIPO_PRORROGA where dd_tpr_codigo = 'INT');


ALTER TABLE DD_CPR_CAUSA_PRORROGA
MODIFY(DD_TPR_ID  NOT NULL);

ALTER TABLE DD_RPR_RAZON_PRORROGA
MODIFY(DD_TPR_ID  NOT NULL);

ALTER TABLE DD_CPR_CAUSA_PRORROGA
   ADD CONSTRAINT FK_DD_CPR_C_FK_DD_TPR_T FOREIGN KEY (DD_TPR_ID)
      REFERENCES DD_TPR_TIPO_PRORROGA (DD_TPR_ID);


ALTER TABLE DD_RPR_RAZON_PRORROGA
   ADD CONSTRAINT FK_DD_RPR_R_FK_DD_TPR_T FOREIGN KEY (DD_TPR_ID)
      REFERENCES DD_TPR_TIPO_PRORROGA (DD_TPR_ID);


grant references on DD_TPR_TIPO_PRORROGA to PFS01, PFS02, PFS03, PFS04;
grant select on DD_TPR_TIPO_PRORROGA to PFS01, PFS02, PFS03, PFS04;
grant insert on DD_TPR_TIPO_PRORROGA to PFS01, PFS02, PFS03, PFS04;
grant delete on DD_TPR_TIPO_PRORROGA to PFS01, PFS02, PFS03, PFS04;
grant update on DD_TPR_TIPO_PRORROGA to PFS01, PFS02, PFS03, PFS04;



-- Añadimos los nuevos tipos de subtareas
INSERT INTO DD_STA_SUBTIPO_TAREA_BASE (DD_STA_ID,DD_TAR_ID, DD_STA_CODIGO,DD_STA_DESCRIPCION,DD_STA_DESCRIPCION_LARGA,DD_STA_GESTOR,USUARIOCREAR,FECHACREAR) 
VALUES (53,1,'53','Umbral','Verificación Umbral',1,'DD',sysdate);

INSERT INTO DD_STA_SUBTIPO_TAREA_BASE (DD_STA_ID,DD_TAR_ID, DD_STA_CODIGO,DD_STA_DESCRIPCION,DD_STA_DESCRIPCION_LARGA,DD_STA_GESTOR,USUARIOCREAR,FECHACREAR) 
VALUES (54,1,'54','Solicitar Prorroga DC','Solicitar Prorroga DC',1,'DD',sysdate);

INSERT INTO DD_STA_SUBTIPO_TAREA_BASE (DD_STA_ID,DD_TAR_ID, DD_STA_CODIGO,DD_STA_DESCRIPCION,DD_STA_DESCRIPCION_LARGA,DD_STA_GESTOR,USUARIOCREAR,FECHACREAR) 
VALUES (55,3,'55','Notif Solic Prorroga DC Rechazada','Notificacion Solicitud Prorroga DC Rechazada',1,'DD',sysdate);


-- Añadimos una columna nueva
ALTER TABLE DD_SMG_SUBFASES_MAPA_GLOBAL
 ADD (DD_SMG_ORDEN NUMBER);

-- Actualizamos los datos
update DD_SMG_SUBFASES_MAPA_GLOBAL set dd_smg_orden = 1 where dd_smg_codigo = 'NV'; 
update DD_SMG_SUBFASES_MAPA_GLOBAL set dd_smg_orden = 2 where dd_smg_codigo = 'CAR'; 
update DD_SMG_SUBFASES_MAPA_GLOBAL set dd_smg_orden = 3 where dd_smg_codigo = 'GV15'; 
update DD_SMG_SUBFASES_MAPA_GLOBAL set dd_smg_orden = 4 where dd_smg_codigo = 'GV15-30'; 
update DD_SMG_SUBFASES_MAPA_GLOBAL set dd_smg_orden = 5 where dd_smg_codigo = 'GV30-60'; 
update DD_SMG_SUBFASES_MAPA_GLOBAL set dd_smg_orden = 6 where dd_smg_codigo = 'GV60'; 
update DD_SMG_SUBFASES_MAPA_GLOBAL set dd_smg_orden = 7 where dd_smg_codigo = 'CE'; 
update DD_SMG_SUBFASES_MAPA_GLOBAL set dd_smg_orden = 8 where dd_smg_codigo = 'RE'; 
update DD_SMG_SUBFASES_MAPA_GLOBAL set dd_smg_orden = 9 where dd_smg_codigo = 'DC'; 
update DD_SMG_SUBFASES_MAPA_GLOBAL set dd_smg_orden = 10 where dd_smg_codigo = 'CA'; 
update DD_SMG_SUBFASES_MAPA_GLOBAL set dd_smg_orden = 11 where dd_smg_codigo = 'CJ'; 
update DD_SMG_SUBFASES_MAPA_GLOBAL set dd_smg_orden = 12 where dd_smg_codigo = 'CSC';

-- Forzamos un not null
ALTER TABLE DD_SMG_SUBFASES_MAPA_GLOBAL
MODIFY(DD_SMG_ORDEN NUMBER  NOT NULL);



-- Nuevas tablas de analisis
CREATE SEQUENCE S_DD_CRA_CRITERIO_ANALISIS;

CREATE TABLE DD_CRA_CRITERIO_ANALISIS  (
   DD_CRA_ID            NUMBER(16)                      NOT NULL,
   DD_CRA_CODIGO        VARCHAR2(8)                     NOT NULL,
   DD_CRA_DESCRIPCION   VARCHAR2(50),
   DD_CRA_DESCRIPCION_LARGA VARCHAR2(250),
   VERSION              INTEGER                         DEFAULT 0 NOT NULL,
   USUARIOCREAR         VARCHAR2(10)                    NOT NULL,
   FECHACREAR           TIMESTAMP                       NOT NULL,
   USUARIOMODIFICAR     VARCHAR2(10),
   FECHAMODIFICAR       TIMESTAMP,
   USUARIOBORRAR        VARCHAR2(10),
   FECHABORRAR          TIMESTAMP,
   BORRADO              NUMBER(1,0)                    DEFAULT 0 NOT NULL,
   CONSTRAINT PK_DD_CRA_CRITERIO_ANALISIS PRIMARY KEY (DD_CRA_ID)
);

CREATE TABLE DD_CRA_CRITERIO_ANALISIS_LG  (
   DD_CRA_ID            NUMBER(16)                      NOT NULL,
   DD_CRA_LANG          VARCHAR2(8)                     NOT NULL,
   DD_CRA_CODIGO        VARCHAR2(8)                     NOT NULL,
   DD_CRA_DESCRIPCION   VARCHAR2(50),
   DD_CRA_DESCRIPCION_LARGA VARCHAR2(250),
   VERSION              INTEGER                         DEFAULT 0 NOT NULL,
   USUARIOCREAR         VARCHAR2(10)                    NOT NULL,
   FECHACREAR           TIMESTAMP                       NOT NULL,
   USUARIOMODIFICAR     VARCHAR2(10),
   FECHAMODIFICAR       TIMESTAMP,
   USUARIOBORRAR        VARCHAR2(10),
   FECHABORRAR          TIMESTAMP,
   BORRADO              NUMBER(1,0)                    DEFAULT 0 NOT NULL,
   CONSTRAINT PK_DD_CRA_CRITERIO_ANALISIS_LG PRIMARY KEY (DD_CRA_ID,DD_CRA_LANG)
);


grant references on DD_CRA_CRITERIO_ANALISIS to PFS01, PFS02, PFS03, PFS04;
grant select on DD_CRA_CRITERIO_ANALISIS to PFS01, PFS02, PFS03, PFS04;
grant insert on DD_CRA_CRITERIO_ANALISIS to PFS01, PFS02, PFS03, PFS04;
grant delete on DD_CRA_CRITERIO_ANALISIS to PFS01, PFS02, PFS03, PFS04;
grant update on DD_CRA_CRITERIO_ANALISIS to PFS01, PFS02, PFS03, PFS04;

INSERT INTO DD_CRA_CRITERIO_ANALISIS (DD_CRA_ID, DD_CRA_CODIGO, DD_CRA_DESCRIPCION,DD_CRA_DESCRIPCION_LARGA, USUARIOCREAR, FECHACREAR)
VALUES (1, 'jerarq', 'Por jerarquía', 'Por jerarquía', 'DD', SYSDATE);
INSERT INTO DD_CRA_CRITERIO_ANALISIS (DD_CRA_ID, DD_CRA_CODIGO, DD_CRA_DESCRIPCION,DD_CRA_DESCRIPCION_LARGA, USUARIOCREAR, FECHACREAR)
VALUES (2, 'producto', 'Por tipo de producto', 'Por tipo de producto', 'DD', SYSDATE);
INSERT INTO DD_CRA_CRITERIO_ANALISIS (DD_CRA_ID, DD_CRA_CODIGO, DD_CRA_DESCRIPCION,DD_CRA_DESCRIPCION_LARGA, USUARIOCREAR, FECHACREAR)
VALUES (3, 'segmento', 'Por tipo de segmento', 'Por tipo de segmento', 'DD', SYSDATE);
INSERT INTO DD_CRA_CRITERIO_ANALISIS (DD_CRA_ID, DD_CRA_CODIGO, DD_CRA_DESCRIPCION,DD_CRA_DESCRIPCION_LARGA, USUARIOCREAR, FECHACREAR)
VALUES (4, 'fase', 'Por situación (fase y subfases)', 'Por situación (fase y subfases)', 'DD', SYSDATE);


INSERT INTO FUN_FUNCIONES (FUN_ID, FUN_DESCRIPCION, FUN_DESCRIPCION_LARGA, USUARIOCREAR, FECHACREAR) VALUES (28,'EDITAR_UMBRAL','Edita el umbral de deuda por persona para pasar a Expediente','DD', SYSDATE);
INSERT INTO FUN_FUNCIONES (FUN_ID, FUN_DESCRIPCION, FUN_DESCRIPCION_LARGA, USUARIOCREAR, FECHACREAR) VALUES (29,'MENU-LIST-CNT','Puede buscar Contratos','DD', SYSDATE);
INSERT INTO FUN_FUNCIONES (FUN_ID, FUN_DESCRIPCION, FUN_DESCRIPCION_LARGA, USUARIOCREAR, FECHACREAR) VALUES (30,'EDITAR_GYA_REV','Editar Revisión en Gestión y Análisis','DD', SYSDATE);

commit;
