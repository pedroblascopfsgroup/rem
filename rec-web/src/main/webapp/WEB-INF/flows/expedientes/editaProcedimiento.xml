<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">
    
    <var name="dto" class="es.capgemini.pfs.asunto.dto.ProcedimientoDto"/> 
	
	<input name="idExpediente" type="java.lang.Long"/>
	<input name="idProcedimiento" type="java.lang.Long"/>
	<input name="idAsunto" type="java.lang.Long" />
	<input name="pantalla" type="java.lang.String"/>

	<decision-state id="newOrEdit">
		<if test="idAsunto!=null" then="buscar" else="editaProcedimiento" />
	</decision-state>

	<action-state id="buscar">
	    	<evaluate expression="executor.execute('asuntosManager.get', idAsunto)" result="flowScope.asunto" />
			<transition to="editaProcedimiento" />
	</action-state>

	<!-- renderiza el formulario -->
    <view-state id="editaProcedimiento" view="expedientes/editaProcedimiento" >
	    <on-entry>
	    	<evaluate expression="requestParameters.idExpediente" result="idExpediente" />
            <evaluate expression="executor.execute('asuntosManager.obtenerAsuntosDeUnExpediente',idExpediente)" result="flowScope.asuntos" />
	    	<evaluate expression="executor.execute('procedimientoManager.getProcedimiento', idProcedimiento)" result="flowScope.procedimiento" />
			<!-- <evaluate expression="executor.execute('procedimientoManager.getTiposActuacion')" result="flowScope.tiposActuacion" /> -->
			<evaluate expression="executor.execute('procedimientoManager.getTiposActuacionByTipoAsunto', idAsunto)" result="flowScope.tiposActuacion" />
	    	<evaluate expression="executor.execute('procedimientoManager.getTiposProcedimiento')" result="flowScope.tiposProcedimientos" />
	    	<evaluate expression="executor.execute('procedimientoManager.getTiposReclamacion')" result="flowScope.tiposReclamacion" />
	    	<evaluate expression="executor.execute('expedienteManager.findExpedientesContratoPorId', idExpediente)" result="flowScope.contratos" />
	    	<!--
	    	<evaluate expression="executor.execute('procedimientoManager.getPersonasAsociadasAContratoProcedimiento', idContrato,idProcedimiento)" result="flowScope.personas"/>
	    	-->
	    </on-entry>
	    <transition on="updateProcedimiento" to="updateProcedimiento"/>
    </view-state>
    
    <end-state id="updateProcedimiento" view="asuntos/returnJSON">
	  <on-entry>	
		<evaluate expression="binder.bindAndValidate(flowRequestContext,dto)" />
		<evaluate expression="executor.execute('procedimientoManager.salvarProcedimiento',dto)" result="flowScope.id"/>
	  </on-entry>
	</end-state> 	
    
</flow>