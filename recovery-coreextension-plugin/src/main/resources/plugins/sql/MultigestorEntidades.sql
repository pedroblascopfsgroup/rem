--CREACIÓN TABLA GE_GESTOR_ENTIDAD
CREATE TABLE GE_GESTOR_ENTIDAD
(
  GE_ID             NUMBER(22,16)               NOT NULL,
  UG_ID             NUMBER(22,16)               NOT NULL,
  USU_ID            NUMBER(22,16)               NOT NULL,
  USUARIOCREAR      VARCHAR2(10 CHAR)           NOT NULL,
  FECHACREAR        TIMESTAMP(6)                NOT NULL,
  USUARIOMODIFICAR  VARCHAR2(10 CHAR),
  FECHAMODIFICAR    TIMESTAMP(6),
  USUARIOBORRAR     VARCHAR2(10 CHAR),
  FECHABORRAR       TIMESTAMP(6),
  BORRADO           NUMBER(1),
  VERSION           NUMBER(22,16),
  DD_TGE_ID         NUMBER(22,16)               NOT NULL,
  DD_EIN_ID         NUMBER(22,16)               NOT NULL
)
TABLESPACE UN001
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            MINEXTENTS       1
            MAXEXTENTS       2147483645
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
LOGGING 
NOCOMPRESS 
NOCACHE
NOPARALLEL
MONITORING;


CREATE UNIQUE INDEX GE_GESTOR_ENTIDAD_PK ON GE_GESTOR_ENTIDAD
(GE_ID)
LOGGING
TABLESPACE UN001
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            MINEXTENTS       1
            MAXEXTENTS       2147483645
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
NOPARALLEL;


ALTER TABLE GE_GESTOR_ENTIDAD ADD (
  CONSTRAINT GE_GESTOR_ENTIDAD_PK
 PRIMARY KEY
 (GE_ID)
    USING INDEX 
    TABLESPACE UN001
    PCTFREE    10
    INITRANS   2
    MAXTRANS   255
    STORAGE    (
                INITIAL          64K
                MINEXTENTS       1
                MAXEXTENTS       2147483645
                PCTINCREASE      0
               ));


ALTER TABLE GE_GESTOR_ENTIDAD ADD (
  CONSTRAINT FK_GE_USU 
 FOREIGN KEY (USU_ID) 
 REFERENCES UNMASTER.USU_USUARIOS (USU_ID));

ALTER TABLE GE_GESTOR_ENTIDAD ADD (
  CONSTRAINT FK_GE_DD_TGE 
 FOREIGN KEY (DD_TGE_ID) 
 REFERENCES UNMASTER.DD_TGE_TIPO_GESTOR (DD_TGE_ID));

ALTER TABLE GE_GESTOR_ENTIDAD ADD (
  CONSTRAINT FK_GE_DD_EIN 
 FOREIGN KEY (DD_EIN_ID) 
 REFERENCES UNMASTER.DD_EIN_ENTIDAD_INFORMACION (DD_EIN_ID));
 
 -- SECUENCIA
 
 
DROP SEQUENCE UN001.S_GE_GESTOR_ENTIDAD;

CREATE SEQUENCE UN001.S_GE_GESTOR_ENTIDAD
  START WITH 507
  MAXVALUE 999999999999999999999999999
  MINVALUE 1
  NOCYCLE
  CACHE 100
  NOORDER;

-- AÑADIR LA COLUMNA 

ALTER TABLE ADD (CNT_ID NUMBER(16) );  

ALTER TABLE TAR_TAREAS_NOTIFICACIONES ADD (
  CONSTRAINT FK_TAR_CNT 
 FOREIGN KEY (CNT_ID) 
 REFERENCES CNT_CONTRATOS (CNT_ID));  
 
-- NUEVO TIPO DE SUBTAREA
SET DEFINE OFF;
Insert into UNMASTER.DD_STA_SUBTIPO_TAREA_BASE
   (DD_STA_ID, DD_TAR_ID, DD_STA_CODIGO, DD_STA_DESCRIPCION, DD_STA_DESCRIPCION_LARGA, VERSION, USUARIOCREAR, FECHACREAR, BORRADO, DD_TGE_ID, DTYPE)
 Values
   (601, 1, '700', 'Cambiar datos contrato', 'Cambiar datos contrato', 0, 'xema', TO_TIMESTAMP('09/05/2012 11:44:05.000000','DD/MM/YYYY fmHH24fm:MI:SS.FF'), 0, 23, 'EXTSubtipoTarea');
COMMIT;

--NUEVO TIPO DE GESTOR
SET DEFINE OFF;

Insert into UNMASTER.DD_TGE_TIPO_GESTOR
   (DD_TGE_ID, DD_TGE_CODIGO, DD_TGE_DESCRIPCION, DD_TGE_DESCRIPCION_LARGA, VERSION, USUARIOCREAR, FECHACREAR, BORRADO)
 Values
   (23, 'CDCNT', 'Cambiador de Datos', 'Gestor del contrato para cambiar los datos', 0, 'XEMA', TO_TIMESTAMP('08/05/2012 0:00:00.000000','DD/MM/YYYY fmHH24fm:MI:SS.FF'), 0);
Insert into UNMASTER.DD_TGE_TIPO_GESTOR
   (DD_TGE_ID, DD_TGE_CODIGO, DD_TGE_DESCRIPCION, DD_TGE_DESCRIPCION_LARGA, VERSION, USUARIOCREAR, FECHACREAR, BORRADO)
 Values
   (26, 'OTROS', 'Otros', 'Otros', 0, 'xema', TO_TIMESTAMP('14/05/2012 0:00:00.000000','DD/MM/YYYY fmHH24fm:MI:SS.FF'), 0);
Insert into UNMASTER.DD_TGE_TIPO_GESTOR
   (DD_TGE_ID, DD_TGE_CODIGO, DD_TGE_DESCRIPCION, DD_TGE_DESCRIPCION_LARGA, VERSION, USUARIOCREAR, FECHACREAR, BORRADO)
 Values
   (24, 'GESEXP', 'GESTOR DE EXPEDIENTES', 'GESTOR DE EXPEDIENTES', 0, 'XEMA', TO_TIMESTAMP('10/05/2012 0:00:00.000000','DD/MM/YYYY fmHH24fm:MI:SS.FF'), 0);
Insert into UNMASTER.DD_TGE_TIPO_GESTOR
   (DD_TGE_ID, DD_TGE_CODIGO, DD_TGE_DESCRIPCION, DD_TGE_DESCRIPCION_LARGA, VERSION, USUARIOCREAR, FECHACREAR, BORRADO)
 Values
   (25, 'GESCLI', 'GESTOR DE CLIENTES', 'GESTOR DE CLIENTES', 0, 'XEMA', TO_TIMESTAMP('10/05/2012 0:00:00.000000','DD/MM/YYYY fmHH24fm:MI:SS.FF'), 0);
COMMIT;

-- MODIFICACIÓN DEL DTYPE DE CONTRATOS
update cnt_contratos set dtype = 'EXTContrato'

-- INSERCIÓN PERMISOS TAB GESTORES
insert into fun_funciones
values(s_fun_funciones.nextval,'VER PESTAÑA GESTORES','VER_TAB_GESTORES',0,'XEMA',SYSDATE,NULL,NULL,NULL,NULL,0);

insert into fun_funciones
values(s_fun_funciones.nextval,'EDITAR GESTORES','EDIT_GESTORES',0,'XEMA',SYSDATE,NULL,NULL,NULL,NULL,0);

DECLARE
  CURSOR perfiles_cursor IS
  SELECT pef_id FROM pef_perfiles where borrado = 0;
  pefid NUMBER(16);
BEGIN
 
 OPEN perfiles_cursor;
 
 LOOP
   
    FETCH perfiles_cursor INTO pefid;
   
    EXIT WHEN perfiles_cursor%NOTFOUND;
   
    
    insert into fun_pef (fun_id,pef_id,fp_id,version,usuariocrear,fechacrear,usuariomodificar,fechamodificar,usuarioborrar,fechaborrar,borrado)
    values ((select fun_id from unmaster.fun_funciones where fun_descripcion = 'VER_TAB_GESTORES'),pefid,s_fun_pef.nextval,0,'xema',sysdate,null,null,null,null,0);


  END LOOP;
  
  CLOSE perfiles_cursor;
END;
commit;
