<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:jms="http://www.springframework.org/schema/integration/jms"
	xmlns:integration="http://www.springframework.org/schema/integration"
	xmlns:file="http://www.springframework.org/schema/integration/file"
	xsi:schemaLocation="http://www.springframework.org/schema/beans
			http://www.springframework.org/schema/beans/spring-beans.xsd
			http://www.springframework.org/schema/integration
			http://www.springframework.org/schema/integration/spring-integration.xsd
			http://www.springframework.org/schema/integration/jms
			http://www.springframework.org/schema/integration/jms/spring-integration-jms.xsd
			http://www.springframework.org/schema/integration/file
			http://www.springframework.org/schema/integration/file/spring-integration-file.xsd">

	<!-- CONFIGURACION DE LA ENTRADA -->
	<integration:channel id="integacionErrorChannel"/> 
	
	 <jms:inbound-channel-adapter id="jmsIn"
	                              destination="requestQueue"
	                              channel="inputChannelCommon"
	                              extract-payload="true">
	     <integration:poller>
	         <integration:interval-trigger interval="5" time-unit="SECONDS"/>
	     </integration:poller>
	 </jms:inbound-channel-adapter>
 	
	<!-- FLOW -->
	<file:inbound-channel-adapter id="inputFolderChannel"
		directory="${integracion.input}" filename-pattern=".+.msg">
		<integration:poller id="poller">
			<integration:interval-trigger interval="10000" />
		</integration:poller>
	</file:inbound-channel-adapter>
	<file:file-to-string-transformer delete-files="false" charset="UTF-8" 
		input-channel="inputFolderChannel" output-channel="inputChannelCommon"/>
	
	<integration:chain input-channel="inputChannelCommon" output-channel="inputChannel">
		<!-- file:file-to-string-transformer delete-files="false" charset="UTF-8" / -->
		<integration:transformer ref="jsonAsuntoPayloadTransformer" method="deserialize"/>
	</integration:chain>
	<!-- integration:header-value-router input-channel="routingChannel" header-name="rec-msg-type" default-output-channel="inputChannel">
		<integration:mapping value="CAB-UPD-RECURSO" channel="recursosInputChannel" />
		<integration:mapping value="CAB-UPD-PROCEDIMIENTO" channel="recursosInputChannel" />
	</integration:header-value-router -->

	<!-- Canal recursos -->
	<!-- integration:service-activator input-channel="recursosInputChannel" output-channel="nullChannel">
		<bean class="es.pfsgroup.recovery.integration.bpm.PayloadConsumerActionService">
			<constructor-arg index="0" ref="actualizarCabecerasMgr"/>
			<constructor-arg index="1" value="2038"/>
			<constructor-arg index="2" value="file:/Documentos/borrar/mensajes/input/log" />
			<constructor-arg index="3" value="file:/Documentos/borrar/mensajes/input/error" />
		</bean>
	</integration:service-activator -->
		
	<!-- Canal eventos BPM -->
	<integration:service-activator input-channel="inputChannel" output-channel="nullChannel" method="dispatchMessage">
		<bean class="es.pfsgroup.recovery.integration.ConsumerActionService">
			<constructor-arg index="0" ref="bpmConsumerActionMgr" />
			<constructor-arg index="1" value="2038"/>
			<constructor-arg index="2" value="${integracion.input}" />
			<constructor-arg index="3" value="${integracion.error}" />
		</bean>
	</integration:service-activator>

	<!-- ***************** -->
	<!-- REGLAS DE ENTRADA -->
	<!-- ***************** -->
		
	<bean id="bpmConsumerActionMgr" class="es.pfsgroup.recovery.integration.ConsumerActionManager">
		<constructor-arg>
			<list>

				<!-- ACTUALIZACION DE CABECERA PROCEDIMIENTO -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.ProcedimientoConsumer">
					<constructor-arg>
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="BPM-TAREA-INICIO"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Actualización de un procedimiento, lo crea si no existe"/>
				</bean>

				<!-- NOTIFICACIONES: INICIO / CANCEL / FIN TAREA / BPM-FIN / BPM-TAREA-ACTIVAR ... -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.TareaProcedimientoConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="BPM-TAREA-.+"/>
						</bean>
					</constructor-arg>
					<constructor-arg index="1" ref="diccionarioCodigosConsumer"/>
					<property name="description" value="Gestión de una tarea"/>
				</bean>

				<!-- NOTIFICACIONES: ACUERDOS ... -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.AcuerdoConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DATOS-ACUERDO.*"/>
						</bean>
					</constructor-arg>
					<constructor-arg index="1" ref="diccionarioCodigosConsumer"/>
					<property name="description" value="Gestión de un acuerdo"/>
				</bean>

				<!-- INICIO BPM -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.ProcedimientoConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.bpm.TareaExternaPayloadRegexRule">
							<property name="tipo" value="BPM-TAREA-FIN"/>
							<property name="codigoTarea" value="H040_RegistrarCambioCerradura"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Inicio de BPM Gestión de Llaves"/>
					<property name="iniciarBPM" value="true"/>
					<property name="crearNuevo" value="true"/>
					<property name="forzarTipoProcedimiento" value="H040"/>
				</bean>

				<!-- Transicionar tarea -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.TransicionarTareaBPM">
					<constructor-arg index="0">
						<list>
							<bean class="es.pfsgroup.recovery.integration.bpm.TareaExternaPayloadRegexRule">
								<property name="tipo" value="BPM-FIN"/>
								<property name="codigoProcedimiento" value="H042"/>
							</bean>
							<bean class="es.pfsgroup.recovery.integration.bpm.TareaExternaPayloadRegexRule">
								<property name="tipo" value="BPM-FIN"/>
								<property name="codigoProcedimiento" value="H041"/>
							</bean>
							<bean class="es.pfsgroup.recovery.integration.bpm.TareaExternaPayloadRegexRule">
								<property name="tipo" value="BPM-FIN"/>
								<property name="codigoProcedimiento" value="H040"/>
							</bean>
						</list>
					</constructor-arg>
					<property name="description" value="Recepción de señal de Fin de BPM"/>
					<property name="forzarTransicion" value="avanzaBPM"/>
				</bean>

				<!-- Finalizar un BPM -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.TransicionarBPM">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DO-FINALIZAR-BPM"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Finzaliza un BPM"/>
					<property name="forzarTransicion" value="Fin"/>
				</bean>

				<!-- Paralizar un BPM -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.TransicionarBPM">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DO-PARALIZAR-BPM"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Paraliza un BPM"/>
					<property name="forzarTransicion" value="paralizarTareas"/>
				</bean>

				<!-- Activar un BPM paralizado-->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.TransicionarBPM">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DO-ACTIVAR-BPM"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Activa un BPM paralizado"/>
					<property name="forzarTransicion" value="activarTareas"/>
				</bean>

				<!-- ACTUALIZACION DE CABECERA RECURSO -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.RecursoConsumer">
					<constructor-arg>
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DATOS-RECURSO"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Actualización de un recurso"/>
				</bean>

				<!-- ACTUALIZACION DE CABECERA SUBASTA -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.SubastaConsumer">
					<constructor-arg>
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DATOS-SUBASTA"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Actualización de una subasta"/>
				</bean>
				
				<bean class="es.pfsgroup.recovery.haya.integration.bpm.consumer.ConvenioConsumer">
					<constructor-arg>
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="DATOS-CONVENIO"/>
						</bean>
					</constructor-arg>
					<property name="description" value="Actualización de un convenio"/>
				</bean>

				<!-- NOTIFICACIONES DE TAREA ... -->
				<bean class="es.pfsgroup.recovery.integration.bpm.consumer.TareaNotificacionConsumer">
					<constructor-arg index="0">
						<bean class="es.pfsgroup.recovery.integration.TypePayloadRegexRule">
							<property name="tipo" value="TAREA-NOTIF"/>
						</bean>
					</constructor-arg>
					<constructor-arg index="1" ref="diccionarioCodigosConsumer"/>
					<property name="description" value="Gestión de tarea notificaciones"/>
				</bean>

			</list>
		</constructor-arg>
	</bean>

	<!-- TRADUCTOR DE CODIGOS PROCEDIMIENTOS, TAREAS, DD -->
	<bean id ="diccionarioCodigosConsumer" class="es.pfsgroup.recovery.integration.bpm.DiccionarioDeCodigos">
		<constructor-arg>
			<map>
				<entry key="procedimientos">
					<map>
					</map>
				</entry>
				<entry key="tareas">
					<map>
					</map>
				</entry>
				<entry key="DD">
					<map>
					</map>
				</entry>
			</map>
		</constructor-arg>
	</bean>

</beans>