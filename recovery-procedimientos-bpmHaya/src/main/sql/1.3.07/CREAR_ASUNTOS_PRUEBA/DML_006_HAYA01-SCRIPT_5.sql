  
     /*  CEX_PASE  */


  DECLARE                    
                     
 CURSOR CONTRATOS IS
SELECT DISTINCT EXP_ID FROM CEX_CONTRATOS_EXPEDIENTE WHERE USUARIOCREAR = 'CONVIVE_F2';
                      
TYPE t_contratos_exp IS TABLE OF CONTRATOS%ROWTYPE INDEX BY BINARY_INTEGER;
	l_contratos_exp t_contratos_exp;
  
	  C_DESCRIPCION VARCHAR2(30 CHAR);
    C_USUARIOCREAR VARCHAR2(10 CHAR);
    C_FECHA_HASTA DATE;

  BEGIN
  
  INSERT INTO TMP_CEX_CONV SELECT  CNT_ID, EXP_ID FROM CEX_CONTRATOS_EXPEDIENTE WHERE USUARIOCREAR = 'CONVIVE_F2';

  OPEN CONTRATOS;
  FETCH CONTRATOS BULK COLLECT INTO l_contratos_exp;
  CLOSE CONTRATOS;
  
  IF l_contratos_exp.COUNT>0 THEN

                  
            

      FORALL indx IN 1..l_contratos_exp.COUNT 
               
            MERGE INTO CEX_CONTRATOS_EXPEDIENTE CEX1
            USING(
            SELECT * FROM (
SELECT MOV.MOV_POS_VIVA_VENCIDA+MOV.MOV_POS_VIVA_NO_VENCIDA,TMP.CNT_ID , TMP.EXP_ID,
ROW_NUMBER () OVER (PARTITION BY  TMP.EXP_ID ORDER BY TMP.EXP_ID DESC) RN
FROM CNV_TMP_CNT_ID AUX
INNER JOIN CNT_CONTRATOS CNT ON CNT.CNT_ID = AUX.CNT_ID
INNER JOIN MOV_MOVIMIENTOS MOV ON MOV.MOV_FECHA_EXTRACCION = CNT.CNT_FECHA_EXTRACCION AND MOV.CNT_ID = AUX.CNT_ID
INNER JOIN TMP_CEX_CONV TMP ON TMP.CNT_ID = AUX.CNT_ID
INNER JOIN EXP_EXPEDIENTES ON TMP.EXP_ID = EXP_EXPEDIENTES.EXP_ID
WHERE (MOV.MOV_POS_VIVA_VENCIDA+MOV.MOV_POS_VIVA_NO_VENCIDA)= 
              (SELECT MAX(MOV_POS_VIVA_VENCIDA+MOV_POS_VIVA_NO_VENCIDA)
              FROM MOV_MOVIMIENTOS WHERE CNT_ID 
              IN(SELECT CNT_ID FROM CNV_TMP_CNT_ID 
              WHERE CNT_ID IN
              (SELECT CNT_ID FROM TMP_CEX_CONV
              WHERE EXP_ID=l_contratos_exp(indx).EXP_ID))
              ))TMP
              WHERE TMP.RN = 1
            ) ORIGEN
                  ON (CEX1.CNT_ID=ORIGEN.CNT_ID AND CEX1.EXP_ID=ORIGEN.EXP_ID)
                  WHEN MATCHED THEN UPDATE
                  SET  CEX1.CEX_PASE = 1,
                 CEX1.FECHAMODIFICAR = TRUNC(SYSDATE);

  END IF;
    
  
  END;
/