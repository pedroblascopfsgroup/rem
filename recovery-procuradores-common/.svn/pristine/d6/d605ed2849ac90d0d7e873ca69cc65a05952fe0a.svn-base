package es.pfsgroup.plugin.recovery.procuradores.tareas.impl;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import es.capgemini.devon.bo.annotations.BusinessOperation;
import es.capgemini.devon.pagination.Page;
import es.capgemini.pfs.tareaNotificacion.EXTAbstractTareaNotificacionManager;
import es.capgemini.pfs.tareaNotificacion.dto.DtoBuscarTareaNotificacion;
import es.capgemini.pfs.users.domain.Usuario;
import es.pfsgroup.commons.utils.api.ApiProxyFactory;
import es.pfsgroup.commons.utils.api.BusinessOperationDefinition;
import es.pfsgroup.plugin.recovery.procuradores.configuracion.api.ConfiguracionDespachoExternoApi;
import es.pfsgroup.plugin.recovery.procuradores.tareas.api.PCDProcuradoresApi;
import es.pfsgroup.plugin.recovery.procuradores.tareas.dao.PCDProcuradoresDao;
import es.pfsgroup.plugin.recovery.procuradores.tareas.dto.PCDProcuradoresDto;
import es.pfsgroup.recovery.api.UsuarioApi;


@Component
public class PCDProcuradoresManager  extends EXTAbstractTareaNotificacionManager implements PCDProcuradoresApi {

	@Autowired
	private PCDProcuradoresDao pcdprocuradoresDao;
	
	@Autowired
	private ApiProxyFactory proxyFactory;
	
	@Autowired
	private ConfiguracionDespachoExternoApi configuracionDespachoExternoApi;

	@Override
	@BusinessOperationDefinition(PCD_COUNT_LISTADO_TAREAS_PENDIENTES)
	public Long getCountListadoTareasPendientes(PCDProcuradoresDto dto) {
		return pcdprocuradoresDao.getCountListadoTareasPendientesValidar(dto);
	}
	
	@Override
	@BusinessOperation(PCD_GET_LISTADO_TAREAS_PENDIENTES)
	public Page getListadoTareasPendientesValidar(PCDProcuradoresDto dto){
		Usuario usuarioLogado = proxyFactory.proxy(UsuarioApi.class).getUsuarioLogado();
		dto.setUsuarioLogado(usuarioLogado);
		Long idCategorizacion = configuracionDespachoExternoApi.activoCategorizacion();
		dto.setIdCategorizacion(idCategorizacion);
		Page p = pcdprocuradoresDao.getListadoTareasPendientesValidar(dto);
		return p;
	}
	
	@Override
	@BusinessOperation(PCD_GET_LISTADO_TAREAS_PENDIENTES_PAUSADAS)
	public Page getListadoTareasPendientesValidarPausadas(PCDProcuradoresDto dto){
		Usuario usuarioLogado = proxyFactory.proxy(UsuarioApi.class).getUsuarioLogado();
		dto.setUsuarioLogado(usuarioLogado);
		Long idCategorizacion = configuracionDespachoExternoApi.activoCategorizacion();
		dto.setIdCategorizacion(idCategorizacion);
		Page p = pcdprocuradoresDao.getListadoTareasPendientesValidarPausadas(dto);
		return p;
	}
	
	@Override
	@BusinessOperation(PCD_BUSCAR_TAREAS_PENDIENTES)
	@Transactional
	public Page buscarTareasPendientesDelegator(DtoBuscarTareaNotificacion dto,  String comboEstado, Long comboCtgResol) {
		//return proxyFactory.proxy(EXTTareasApi.class).buscarTareasPendientesDelegator(dto);
		Usuario usuarioLogado = proxyFactory.proxy(UsuarioApi.class).getUsuarioLogado();
		dto.setUsuarioLogado(usuarioLogado);
		Long idCategorizacion = configuracionDespachoExternoApi.activoCategorizacion();
		return pcdprocuradoresDao.buscarTareasPendientes(dto, comboEstado, comboCtgResol, idCategorizacion);

	}

	@Override
	public String managerName() {
		return "tareaNotificacionManager";
	}

}