--/*
--##########################################
--## AUTOR=DANIEL GUTIERREZ
--## FECHA_CREACION=20150617
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.1.0-X
--## PRODUCTO=SI
--##
--## Finalidad: Relaciones de categorías y categorizaciones.
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Version inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;
DECLARE
    V_MSQL VARCHAR2(4000 CHAR);
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA_ENTIDAD#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- Numero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    
BEGIN

	DBMS_OUTPUT.PUT_LINE('******** CTG_CATEGORIZACIONES ********'); 
	DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.CTG_CATEGORIZACIONES... Comprobaciones previas');

	-- Comprobamos si ya existe la FK
	V_MSQL := 'SELECT COUNT(1) FROM ALL_CONSTRAINTS  WHERE CONSTRAINT_NAME= ''FK_CTG_CATEG_FK_DESP_EXT'' and TABLE_NAME=''CTG_CATEGORIZACIONES'' and owner = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO table_count;
	
	IF table_count = 1 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] ' || V_ESQUEMA || '.CTG_CATEGORIZACIONES.FK_CTG_CATEG_FK_DESP_EXT... Ya existe');
	ELSE
		EXECUTE IMMEDIATE 'ALTER TABLE ' || V_ESQUEMA || '.CTG_CATEGORIZACIONES ADD (
  			CONSTRAINT FK_CTG_CATEG_FK_DESP_EXT FOREIGN KEY (CTG_DESP_EXT_ID) REFERENCES DES_DESPACHO_EXTERNO(DES_ID))';
		
		DBMS_OUTPUT.PUT_LINE('ALTER TABLE '|| V_ESQUEMA ||'.CTG_CATEGORIZACIONES ADD FK_CTG_CATEG_FK_DESP_EXT ... OK');
	END IF;
	
	
	
	
	DBMS_OUTPUT.PUT_LINE('******** CAT_CATEGORIAS ********'); 
	DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.CAT_CATEGORIAS... Comprobaciones previas');

	-- Comprobamos si ya existe la FK
	V_MSQL := 'SELECT COUNT(1) FROM ALL_CONSTRAINTS  WHERE CONSTRAINT_NAME= ''FK_CAT_CATEGORIAS_FK_CTG'' and TABLE_NAME=''CAT_CATEGORIAS'' and owner = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO table_count;
	
	IF table_count = 1 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] ' || V_ESQUEMA || '.CAT_CATEGORIAS.FK_CAT_CATEGORIAS_FK_CTG... Ya existe');
	ELSE
		EXECUTE IMMEDIATE 'ALTER TABLE ' || V_ESQUEMA || '.CAT_CATEGORIAS ADD (
  			CONSTRAINT FK_CAT_CATEGORIAS_FK_CTG FOREIGN KEY (CTG_ID) REFERENCES CTG_CATEGORIZACIONES (CTG_ID))';
		
		DBMS_OUTPUT.PUT_LINE('ALTER TABLE '|| V_ESQUEMA ||'.CAT_CATEGORIAS ADD FK_CAT_CATEGORIAS_FK_CTG ... OK');
	END IF;
	
	
	
	
	DBMS_OUTPUT.PUT_LINE('******** REL_CATEGORIAS ********'); 
	DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.REL_CATEGORIAS... Comprobaciones previas');

	-- Comprobamos si ya existe la FK
	V_MSQL := 'SELECT COUNT(1) FROM ALL_CONSTRAINTS  WHERE CONSTRAINT_NAME= ''FK_REL_CAT_FK_CAT'' and TABLE_NAME=''REL_CATEGORIAS'' and owner = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO table_count;
	
	IF table_count = 1 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] ' || V_ESQUEMA || '.REL_CATEGORIAS.FK_REL_CAT_FK_CAT... Ya existe');
	ELSE
		EXECUTE IMMEDIATE 'ALTER TABLE ' || V_ESQUEMA || '.REL_CATEGORIAS ADD (
  			CONSTRAINT FK_REL_CAT_FK_CAT FOREIGN KEY (CAT_ID) REFERENCES CAT_CATEGORIAS (CAT_ID))';
		
		DBMS_OUTPUT.PUT_LINE('ALTER TABLE '|| V_ESQUEMA ||'.REL_CATEGORIAS ADD FK_REL_CAT_FK_CAT ... OK');
	END IF;
	
	
	
	
	DBMS_OUTPUT.PUT_LINE('******** REL_CATEGORIAS_TAREASPROC ********'); 
	DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.REL_CATEGORIAS_TAREASPROC... Comprobaciones previas');

	-- Comprobamos si ya existe la FK
	V_MSQL := 'SELECT COUNT(1) FROM ALL_CONSTRAINTS  WHERE CONSTRAINT_NAME= ''FK_REL_CAT_TAPROC_FK_REL_CAT'' and TABLE_NAME=''REL_CATEGORIAS_TAREASPROC'' and owner = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO table_count;
	
	IF table_count = 1 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] ' || V_ESQUEMA || '.REL_CATEGORIAS_TAREASPROC.FK_REL_CAT_TAPROC_FK_REL_CAT... Ya existe');
	ELSE
		EXECUTE IMMEDIATE 'ALTER TABLE ' || V_ESQUEMA || '.REL_CATEGORIAS_TAREASPROC ADD (
  			CONSTRAINT FK_REL_CAT_TAPROC_FK_REL_CAT FOREIGN KEY (REL_ID) REFERENCES REL_CATEGORIAS (REL_ID))';
		
		DBMS_OUTPUT.PUT_LINE('ALTER TABLE '|| V_ESQUEMA ||'.REL_CATEGORIAS_TAREASPROC ADD FK_REL_CAT_TAPROC_FK_REL_CAT ... OK');
	END IF;
	
	-- Comprobamos si ya existe la FK
	V_MSQL := 'SELECT COUNT(1) FROM ALL_CONSTRAINTS  WHERE CONSTRAINT_NAME= ''FK_REL_CAT_TAPROC_FK_TAPROC'' and TABLE_NAME=''REL_CATEGORIAS_TAREASPROC'' and owner = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO table_count;
	
	IF table_count = 1 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] ' || V_ESQUEMA || '.REL_CATEGORIAS_TAREASPROC.FK_REL_CAT_TAPROC_FK_TAPROC... Ya existe');
	ELSE
		EXECUTE IMMEDIATE 'ALTER TABLE ' || V_ESQUEMA || '.REL_CATEGORIAS_TAREASPROC ADD (
  			CONSTRAINT FK_REL_CAT_TAPROC_FK_TAPROC FOREIGN KEY (TAP_ID) REFERENCES TAP_TAREA_PROCEDIMIENTO (TAP_ID))';
		
		DBMS_OUTPUT.PUT_LINE('ALTER TABLE '|| V_ESQUEMA ||'.REL_CATEGORIAS_TAREASPROC ADD FK_REL_CAT_TAPROC_FK_TAPROC ... OK');
	END IF;
	
	
	
	
	DBMS_OUTPUT.PUT_LINE('******** REL_CATEGORIAS_TIPORESOL ********'); 
	DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.REL_CATEGORIAS_TIPORESOL... Comprobaciones previas');

	-- Comprobamos si ya existe la FK
	V_MSQL := 'SELECT COUNT(1) FROM ALL_CONSTRAINTS  WHERE CONSTRAINT_NAME= ''FK_REL_CAT_TIPRES_FK_REL_CAT'' and TABLE_NAME=''REL_CATEGORIAS_TIPORESOL'' and owner = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO table_count;
	
	IF table_count = 1 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] ' || V_ESQUEMA || '.REL_CATEGORIAS_TIPORESOL.FK_REL_CAT_TIPRES_FK_REL_CAT... Ya existe');
	ELSE
		EXECUTE IMMEDIATE 'ALTER TABLE ' || V_ESQUEMA || '.REL_CATEGORIAS_TIPORESOL ADD (
  			CONSTRAINT FK_REL_CAT_TIPRES_FK_REL_CAT FOREIGN KEY (REL_ID) REFERENCES REL_CATEGORIAS (REL_ID))';
		
		DBMS_OUTPUT.PUT_LINE('ALTER TABLE '|| V_ESQUEMA ||'.REL_CATEGORIAS_TIPORESOL ADD FK_REL_CAT_TIPRES_FK_REL_CAT ... OK');
	END IF;
	
	-- Comprobamos si ya existe la FK
	V_MSQL := 'SELECT COUNT(1) FROM ALL_CONSTRAINTS  WHERE CONSTRAINT_NAME= ''FK_REL_CAT_TIPRES_FK_DD_TIPRES'' and TABLE_NAME=''REL_CATEGORIAS_TIPORESOL'' and owner = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO table_count;
	
	IF table_count = 1 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] ' || V_ESQUEMA || '.REL_CATEGORIAS_TAREASPROC.FK_REL_CAT_TIPRES_FK_DD_TIPRES... Ya existe');
	ELSE
		EXECUTE IMMEDIATE 'ALTER TABLE ' || V_ESQUEMA || '.REL_CATEGORIAS_TIPORESOL ADD (
  			CONSTRAINT FK_REL_CAT_TIPRES_FK_DD_TIPRES FOREIGN KEY (TR_ID) REFERENCES DD_TR_TIPOS_RESOLUCION (DD_TR_ID))';
		
		DBMS_OUTPUT.PUT_LINE('ALTER TABLE '|| V_ESQUEMA ||'.REL_CATEGORIAS_TIPORESOL ADD FK_REL_CAT_TIPRES_FK_DD_TIPRES ... OK');
	END IF;
	
	
	
	
	DBMS_OUTPUT.PUT_LINE('******** DEC_DESPACHO_EXT_CONFIG ********'); 
	DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.DEC_DESPACHO_EXT_CONFIG... Comprobaciones previas');

	-- Comprobamos si ya existe la FK
	V_MSQL := 'SELECT COUNT(1) FROM ALL_CONSTRAINTS  WHERE CONSTRAINT_NAME= ''FK_DES_EXT_CONF_FK_CTG_TAP'' and TABLE_NAME=''DEC_DESPACHO_EXT_CONFIG'' and owner = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO table_count;
	
	IF table_count = 1 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] ' || V_ESQUEMA || '.DEC_DESPACHO_EXT_CONFIG.FK_DES_EXT_CONF_FK_CTG_TAP... Ya existe');
	ELSE
		EXECUTE IMMEDIATE 'ALTER TABLE ' || V_ESQUEMA || '.DEC_DESPACHO_EXT_CONFIG ADD (
  			CONSTRAINT FK_DES_EXT_CONF_FK_CTG_TAP FOREIGN KEY (DEC_CTG_TAREAS) REFERENCES CTG_CATEGORIZACIONES (CTG_ID))';
		
		DBMS_OUTPUT.PUT_LINE('ALTER TABLE '|| V_ESQUEMA ||'.DEC_DESPACHO_EXT_CONFIG ADD FK_DES_EXT_CONF_FK_CTG_TAP ... OK');
	END IF;
	
	-- Comprobamos si ya existe la FK
	V_MSQL := 'SELECT COUNT(1) FROM ALL_CONSTRAINTS  WHERE CONSTRAINT_NAME= ''FK_DES_EXT_CONF_FK_CTG_TR'' and TABLE_NAME=''DEC_DESPACHO_EXT_CONFIG'' and owner = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO table_count;
	
	IF table_count = 1 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] ' || V_ESQUEMA || '.DEC_DESPACHO_EXT_CONFIG.FK_DES_EXT_CONF_FK_CTG_TR... Ya existe');
	ELSE
		EXECUTE IMMEDIATE 'ALTER TABLE ' || V_ESQUEMA || '.DEC_DESPACHO_EXT_CONFIG ADD (
  			CONSTRAINT FK_DES_EXT_CONF_FK_CTG_TR FOREIGN KEY (DEC_CTG_RESOLUCIONES) REFERENCES CTG_CATEGORIZACIONES (CTG_ID))';
		
		DBMS_OUTPUT.PUT_LINE('ALTER TABLE '|| V_ESQUEMA ||'.DEC_DESPACHO_EXT_CONFIG ADD FK_DES_EXT_CONF_FK_CTG_TR ... OK');
	END IF;
	
	-- Comprobamos si ya existe la FK
	V_MSQL := 'SELECT COUNT(1) FROM ALL_CONSTRAINTS  WHERE CONSTRAINT_NAME= ''FK_DES_EXT_CONF_FK_DESP_EXT'' and TABLE_NAME=''DEC_DESPACHO_EXT_CONFIG'' and owner = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO table_count;
	
	IF table_count = 1 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] ' || V_ESQUEMA || '.DEC_DESPACHO_EXT_CONFIG.FK_DES_EXT_CONF_FK_DESP_EXT... Ya existe');
	ELSE
		EXECUTE IMMEDIATE 'ALTER TABLE ' || V_ESQUEMA || '.DEC_DESPACHO_EXT_CONFIG ADD (
			CONSTRAINT FK_DES_EXT_CONF_FK_DESP_EXT FOREIGN KEY (DES_ID) REFERENCES DES_DESPACHO_EXTERNO (DES_ID))';		
 
		DBMS_OUTPUT.PUT_LINE('ALTER TABLE '|| V_ESQUEMA ||'.DEC_DESPACHO_EXT_CONFIG ADD FK_DES_EXT_CONF_FK_DESP_EXT ... OK');
	END IF;

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Código de error obtenido:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
          


END;
/

EXIT