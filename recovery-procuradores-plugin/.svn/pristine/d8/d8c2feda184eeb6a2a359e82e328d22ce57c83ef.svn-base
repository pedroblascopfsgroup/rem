<%@ taglib prefix="sec" uri="http://www.springframework.org/security/tags" %>
<%@ taglib prefix="s" uri="http://www.springframework.org/tags"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core"%>
	{
        text:'<s:message code="plugin.procuradores.arbol.tituloRecordatorios" text="**Recordatorios" />'
        ,id :'arbol_tareas_nodo_recordatorios'
        ,iconCls:'icon_pendientes'
        ,leaf:false
        ,listeners:{click: function() {
        							var node = tree.getNodeById('arbol_tareas_nodo_recordatorios');
        							node.setText(node.getUI().getTextEl().innerHTML.replace(/<.?b>/g,""));
        							app.openTab('<s:message code="plugin.procuradores.listadoRecordatorios.title" text="**Listado de recordatorios"/>',
        							"procuradores/getPanelListadoRecordatorios",{},{id:'tareas_recordatorios_panel'});
        							}
        }
        ,init:function(){
        		tree.getNodeById('arbol_tareas_nodo_recordatorios').getUI().hide();
                this.recargaDatosCategorias();
                //this.cargaCategorias();
                //Comentado para evitar que se hagan llamadas periodicas a recovery
                //setInterval(this.recargaDatosResoluciones, ${appProperties.arbolTareasTiempoRecarga});
                
        }
        ,recargaDatosCategorias:function(){
		              var params = {idUsuario:app.usuarioLogado.id};
		              page.webflow({
		                      flow:"categorias/getListaCategoriasByUsuario"
		                      ,params: params
		                      ,success: function(datos){
		                      //debugger;
		                      		if(datos.despachoIntegral){
		                      			 if (datos.categorias.length > 0){
		                      			 	tree.getNodeById('arbol_tareas_nodo_recordatorios').expand(true);
		                      			 	var vista = datos.vistaCount;
		                      			 	for(i = 0; i < datos.categorias.length; i++){
												var categoria = datos.categorias[i];
												tree.getNodeById('arbol_tareas_nodo_recordatorios').appendChild([{text:categoria.nombre
																				,id :'arbol_tareas_nodo_recordatorios_categoria_' + i
															        			,iconCls:'icon_pendientes'
															        			,leaf:true
															        			,idCategoria: categoria.id
															        			,listeners:{click: function() {
														        							//var node = tree.getNodeById('arbol_tareas_nodo_recordatorios');
														        							//node.setText(node.getUI().getTextEl().innerHTML.replace(/<.?b>/g,""));
														        							app.openTab('<s:message code="plugin.procuradores.listadoRecordatorios.title" text="**Listado de recordatorios"/>',
														        							"procuradores/getPanelListadoTareasPendientes",{idCategoria:this.attributes.idCategoria},{id:'tareas_recordatorios_panel'});
														        							}
														        				}
												}]);
											};
											


		                      			 }
		                      			 	tree.getNodeById('arbol_tareas_nodo_recordatorios').collapse(true);
											tree.getNodeById('arbol_tareas_nodo_recordatorios').getUI().show();
		                      		}
		                      		else{
		                      			tree.getNodeById('arbol_tareas_nodo_recordatorios').remove();
		                      		}
		                            
<!-- 		                        Cargamos el número de resoluciones por categoría -->
<!-- 		                            var datosCategorias = datos.categorias; -->
<!-- 		                            var vista = datos.vistaCount; -->
<!-- 		                            var total = Number(0); -->

<!-- 		                            for(i = 0; i < datosCategorias.length; i++){ -->
<!-- 		                            	var texto = tree.getNodeById('arbol_tareas_nodo_recordatorios_categoria_' + i).text; -->
<!-- 		                            	var contador = Number(0); -->
<!-- 										for(j = 0; j < vista.length; j++){ -->
<!-- 											if(datosCategorias[i].id == vista[j].id) -->
<!-- 											{ -->
<!-- 												contador += Number(vista[j].count); -->
<!-- 												total += contador; -->
<!-- 											} -->
<!-- 										} -->
<!-- 										texto += ' (' + contador + ')'; -->
<!-- 										tree.getNodeById('arbol_tareas_nodo_recordatorios_categoria_' + i).setText(texto); -->
<!-- 									} -->


			                        Ext.Ajax.request({
										url: '/pfs/recrecordatorio/getCountListadoRecordatorios.htm'
										,params: {idUsuario:app.usuarioLogado.id}
										,method: 'POST'
										,success: function (result, request){
											var r = Ext.util.JSON.decode(result.responseText);
											total = r.total;
											var textotal = '<s:message code="plugin.procuradores.arbol.tituloRecordatorios" text="**Recordatorios" /> (' + total + ')';
 		                            		tree.getNodeById('arbol_tareas_nodo_recordatorios').setText(textotal); 
										}
									});

									
		                      }
		              });
		}
        ,cargaCategorias:function(){
    			tree.getNodeById('arbol_tareas_nodo_recordatorios').expand(true);
				tree.getNodeById('arbol_tareas_nodo_recordatorios').appendChild([{text:'Categor&iacute;a 1'
																				,id :'arbol_tareas_nodo_recordatorios_categoria_1'
															        			,iconCls:'icon_pendientes'
															        			,leaf:true
															        			}
															        			,{text:'Categor&iacute;a 2'
																				,id :'arbol_tareas_nodo_recordatorios_categoria_2'
															        			,iconCls:'icon_pendientes'
															        			,leaf:true
															        			}]);
				tree.getNodeById('arbol_tareas_nodo_recordatorios').collapse(true);
				//tree.getNodeById('arbol_tareas_nodo_recordatorios').remove();
				tree.getNodeById('arbol_tareas_nodo_recordatorios').getUI().show();
		}		
		,children:[]

	}


