-- --------------------------------------------------------------------------------
-- Routine DDL
-- Note: comments before and after the routine body will not be stored by the server
-- --------------------------------------------------------------------------------
DELIMITER $$

DROP PROCEDURE IF EXISTS `Actualizar_Situacion_Cartera` $$

-- --------------------------------------------------------------------------------
-- Routine DDL
-- Note: comments before and after the routine body will not be stored by the server
-- --------------------------------------------------------------------------------
DELIMITER $$

SET NAMES UTF8 $$

CREATE DEFINER=`bi_cdd`@`62.15.160.14` PROCEDURE `Actualizar_Situacion_Cartera`(IN date_start Date, IN date_end Date, OUT o_error_status varchar(500))
MY_BLOCK_SIT_CART: BEGIN

-- ===============================================================================================
-- Autor: Enrique Jiménez, PFS Group
-- Fecha creación: Marzo 2014
-- Responsable última modificación: 
-- Fecha última modificación: 
-- Motivos del cambio: 
-- Cliente: Recovery BI Central de Demandas 
-- ****************
-- Descripción: Procedimiento almancenado que Actualiza las tablas de Hechos con la sitaución de la 
--				cartera a nivel de Cuadre (Discrepacias, Despreciables y Correctos).
-- ===============================================================================================

-- ===============================================================================================
--                  									Declaracación de variables
-- ===============================================================================================
declare l_last_row int default 0;
declare fecha date;
declare fecha_rellenar date;

declare c_fecha_rellenar cursor for select distinct(DIA_ID) FROM D_F_DIA where DIA_ID between date_start and date_end;
declare c_fecha cursor for select distinct(DIA_ID) FROM D_F_DIA where DIA_ID between date_start and date_end; 
declare continue HANDLER FOR NOT FOUND SET l_last_row = 1;

-- --------------------------------------------------------------------------------
-- DEFINICIÓN DE LOS HANDLER DE ERROR
-- --------------------------------------------------------------------------------
DECLARE EXIT handler for 1062 set o_error_status := 'Error 1062: La tabla ya existe';
DECLARE EXIT handler for 1048 set o_error_status := 'Error 1048: Has intentado insertar un valor nulo'; 
DECLARE EXIT handler for 1318 set o_error_status := 'Error 1318: Número de parámetros incorrecto'; 

-- --------------------------------------------------------------------------------
-- DEFINICIÓN DEL HANDLER GENÉRICO DE ERROR
-- --------------------------------------------------------------------------------
DECLARE EXIT handler for sqlexception set o_error_status:= 'Se ha producido un error en el proceso';

-- ------------------------------------------------------------------ BUCLE H_EXP -------------------------------------------------------------------
set l_last_row = 0; 

-- --------------------------------------------------------------------------------
-- TABLAS DE CUADRE POR ENTIDAD
--	*>BI_CM_CRUCE_RCV_CNXP_ABANCA => ENTIDAD CEDENTE 1
--	*>BI_CM_CRUCE_RCV_CNXP_BBVA	  => ENTIDAD CEDENTE 2
--	*>BI_CM_CRUCE_RCV_CNXP_BANKIA => ENTIDAD CEDENTE 3
--	*>BI_CM_CRUCE_RCV_CNXP_CAJAMAR=> ENTIDAD CEDENTE 4
-- --------------------------------------------------------------------------------

-- TRUNCATE TABLE TIMER_ANALIZE_SP; -- Reseteamos la tabla de control de tiempos.

open c_fecha;
read_loop: loop
fetch c_fecha into fecha;        
    if (l_last_row=1) then leave read_loop; 
    end if;   

	-- --------------------------------------------------------------------------------
	-- ABANCA
	-- --------------------------------------------------------------------------------

	SELECT 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_ABANCA WHERE CLASIFICACION LIKE '%-COR]%') correctos,
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_ABANCA WHERE CLASIFICACION LIKE '%-DIS]%') incorrectos, 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_ABANCA WHERE CLASIFICACION LIKE '%-DES]%') despreciable,  
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_ABANCA ) total
	INTO @cor, @inc, @des, @tot FROM DUAL;

	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Correctos]- ',fecha,' - ',@cor, ' - ', @inc) , 'UPDATE H_PRC', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_PRC SET SIT_CUADRE_CARTERA_ID = -1; -- Deconocidos.

	UPDATE H_PRC 
		SET SIT_CUADRE_CARTERA_ID = 1 -- Correctos
	WHERE ASUNTO_ID IN (SELECT BCC.ASUNTO_RECOVERY FROM BI_CM_CRUCE_RCV_CNXP_ABANCA BCC WHERE BCC.CLASIFICACION LIKE '%-COR]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 1
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = 'UPDATE H_PRC' AND  `TIME_END_EXECUTE` IS NULL;	
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Incorrectos]- ',fecha,' - ',@cor, ' - ', @inc) , 'UPDATE H_PRC', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_PRC 
		SET SIT_CUADRE_CARTERA_ID = 2 -- Incorrectos
	WHERE ASUNTO_ID IN (SELECT BCC.ASUNTO_RECOVERY FROM BI_CM_CRUCE_RCV_CNXP_ABANCA BCC WHERE BCC.CLASIFICACION LIKE '%-DIS]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 1
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = 'UPDATE H_PRC' AND  `TIME_END_EXECUTE` IS NULL;		
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Despreciables]- ',fecha,' - ',@cor, ' - ', @inc) , 'UPDATE H_PRC', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_PRC 
		SET SIT_CUADRE_CARTERA_ID = 3 -- Despreciables
	WHERE ASUNTO_ID IN (SELECT BCC.ASUNTO_RECOVERY FROM BI_CM_CRUCE_RCV_CNXP_ABANCA BCC WHERE BCC.CLASIFICACION LIKE '%-DES]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 1
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = 'UPDATE H_PRC' AND  `TIME_END_EXECUTE` IS NULL;			
	
	-- --------------------------------------------------------------------------------
	-- BBVA
	-- --------------------------------------------------------------------------------	

	SELECT 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BBVA WHERE CLASIFICACION LIKE '%-COR]%') correctos,
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BBVA WHERE CLASIFICACION LIKE '%-DIS]%') incorrectos, 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BBVA WHERE CLASIFICACION LIKE '%-DES]%') despreciable,  
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BBVA ) total
	INTO @cor, @inc, @des, @tot FROM DUAL;

	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Correctos]- ',fecha,' - ',@cor, ' - ', @inc) , '[BBVA] UPDATE H_PRC', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_PRC 
		SET SIT_CUADRE_CARTERA_ID = 1 -- Correctos
	WHERE ASUNTO_ID IN (SELECT BCC.ASUNTO_RECOVERY FROM BI_CM_CRUCE_RCV_CNXP_BBVA BCC WHERE BCC.CLASIFICACION LIKE '%-COR]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 2 -- BBVA
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[BBVA] UPDATE H_PRC' AND  `TIME_END_EXECUTE` IS NULL;	
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Incorrectos]- ',fecha,' - ',@cor, ' - ', @inc) , '[BBVA] UPDATE H_PRC', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_PRC 
		SET SIT_CUADRE_CARTERA_ID = 2 -- Incorrectos
	WHERE ASUNTO_ID IN (SELECT BCC.ASUNTO_RECOVERY FROM BI_CM_CRUCE_RCV_CNXP_BBVA BCC WHERE BCC.CLASIFICACION LIKE '%-DIS]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 2 -- BBVA
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[BBVA] UPDATE H_PRC' AND  `TIME_END_EXECUTE` IS NULL;		
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Despreciables]- ',fecha,' - ',@cor, ' - ', @inc) , '[BBVA] UPDATE H_PRC', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_PRC 
		SET SIT_CUADRE_CARTERA_ID = 3 -- Despreciables
	WHERE ASUNTO_ID IN (SELECT BCC.ASUNTO_RECOVERY FROM BI_CM_CRUCE_RCV_CNXP_BBVA BCC WHERE BCC.CLASIFICACION LIKE '%-DES]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 2 -- BBVA
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[BBVA] UPDATE H_PRC' AND  `TIME_END_EXECUTE` IS NULL;			
	
	
	-- --------------------------------------------------------------------------------
	-- BANKIA
	-- --------------------------------------------------------------------------------	

	SELECT 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BANKIA WHERE CLASIFICACION LIKE '%-COR]%') correctos,
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BANKIA WHERE CLASIFICACION LIKE '%-DIS]%') incorrectos, 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BANKIA WHERE CLASIFICACION LIKE '%-DES]%') despreciable,  
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BANKIA ) total
	INTO @cor, @inc, @des, @tot FROM DUAL;

	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Correctos]- ',fecha,' - ',@cor, ' - ', @inc) , '[BANKIA] UPDATE H_PRC', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_PRC 
		SET SIT_CUADRE_CARTERA_ID = 1 -- Correctos
	WHERE ASUNTO_ID IN (SELECT BCC.ASUNTO_RECOVERY FROM BI_CM_CRUCE_RCV_CNXP_BANKIA BCC WHERE BCC.CLASIFICACION LIKE '%-COR]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 3 -- BANKIA
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[BANKIA] UPDATE H_PRC' AND  `TIME_END_EXECUTE` IS NULL;	
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Incorrectos]- ',fecha,' - ',@cor, ' - ', @inc) , '[BANKIA] UPDATE H_PRC', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_PRC 
		SET SIT_CUADRE_CARTERA_ID = 2 -- Incorrectos
	WHERE ASUNTO_ID IN (SELECT BCC.ASUNTO_RECOVERY FROM BI_CM_CRUCE_RCV_CNXP_BANKIA BCC WHERE BCC.CLASIFICACION LIKE '%-DIS]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 3 -- BANKIA
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[BBVA] UPDATE H_PRC' AND  `TIME_END_EXECUTE` IS NULL;		
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Despreciables]- ',fecha,' - ',@cor, ' - ', @inc) , '[BANKIA] UPDATE H_PRC', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_PRC 
		SET SIT_CUADRE_CARTERA_ID = 3 -- Despreciables
	WHERE ASUNTO_ID IN (SELECT BCC.ASUNTO_RECOVERY FROM BI_CM_CRUCE_RCV_CNXP_BANKIA BCC WHERE BCC.CLASIFICACION LIKE '%-DES]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 3 -- BANKIA
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[BANKIA] UPDATE H_PRC' AND  `TIME_END_EXECUTE` IS NULL;	
	
	
	-- --------------------------------------------------------------------------------
	-- CAJAMAR
	-- --------------------------------------------------------------------------------	

	SELECT 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR WHERE CLASIFICACION LIKE '%-COR]%') correctos,
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR WHERE CLASIFICACION LIKE '%-DIS]%') incorrectos, 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR WHERE CLASIFICACION LIKE '%-DES]%') despreciable,  
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR ) total
	INTO @cor, @inc, @des, @tot FROM DUAL;

	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Correctos]- ',fecha,' - ',@cor, ' - ', @inc) , '[CAJAMAR] UPDATE H_PRC', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_PRC 
		SET SIT_CUADRE_CARTERA_ID = 1 -- Correctos
	WHERE ASUNTO_ID IN (SELECT BCC.ASUNTO_RECOVERY FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR BCC WHERE BCC.CLASIFICACION LIKE '%-COR]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 4 -- CAJAMAR
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[CAJAMAR] UPDATE H_PRC' AND  `TIME_END_EXECUTE` IS NULL;	
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Incorrectos]- ',fecha,' - ',@cor, ' - ', @inc) , '[CAJAMAR] UPDATE H_PRC', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_PRC 
		SET SIT_CUADRE_CARTERA_ID = 2 -- Incorrectos
	WHERE ASUNTO_ID IN (SELECT BCC.ASUNTO_RECOVERY FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR BCC WHERE BCC.CLASIFICACION LIKE '%-DIS]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 4 -- CAJAMAR
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[CAJAMAR] UPDATE H_PRC' AND  `TIME_END_EXECUTE` IS NULL;		
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Despreciables]- ',fecha,' - ',@cor, ' - ', @inc) , '[CAJAMAR] UPDATE H_PRC', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_PRC 
		SET SIT_CUADRE_CARTERA_ID = 3 -- Despreciables
	WHERE ASUNTO_ID IN (SELECT BCC.ASUNTO_RECOVERY FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR BCC WHERE BCC.CLASIFICACION LIKE '%-DES]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 4 -- CAJAMAR
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[CAJAMAR] UPDATE H_PRC' AND  `TIME_END_EXECUTE` IS NULL;		
	
	
	
	
	--	@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
	-- << H_EXP >>
	--	@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@




	-- --------------------------------------------------------------------------------
	-- ABANCA
	-- --------------------------------------------------------------------------------

	SELECT 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_ABANCA WHERE CLASIFICACION LIKE '%-COR]%') correctos,
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_ABANCA WHERE CLASIFICACION LIKE '%-DIS]%') incorrectos, 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_ABANCA WHERE CLASIFICACION LIKE '%-DES]%') despreciable,  
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_ABANCA ) total
	INTO @cor, @inc, @des, @tot FROM DUAL;

	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Correctos]- ',fecha,' - ',@cor, ' - ', @inc) , 'UPDATE H_EXP', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_EXP SET SIT_CUADRE_CARTERA_ID = -1; -- Deconocidos.

	UPDATE H_EXP 
		SET SIT_CUADRE_CARTERA_ID = 1 -- Correctos
	WHERE EXPEDIENTE_ID IN (SELECT BCC.Cod_CDD FROM BI_CM_CRUCE_RCV_CNXP_ABANCA BCC WHERE BCC.CLASIFICACION LIKE '%-COR]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 1
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = 'UPDATE H_EXP' AND  `TIME_END_EXECUTE` IS NULL;	
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Incorrectos]- ',fecha,' - ',@cor, ' - ', @inc) , 'UPDATE H_EXP', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_EXP 
		SET SIT_CUADRE_CARTERA_ID = 2 -- Incorrectos
	WHERE EXPEDIENTE_ID IN (SELECT BCC.Cod_CDD FROM BI_CM_CRUCE_RCV_CNXP_ABANCA BCC WHERE BCC.CLASIFICACION LIKE '%-DIS]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 1
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = 'UPDATE H_EXP' AND  `TIME_END_EXECUTE` IS NULL;		
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Despreciables]- ',fecha,' - ',@cor, ' - ', @inc) , 'UPDATE H_EXP', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_EXP 
		SET SIT_CUADRE_CARTERA_ID = 3 -- Despreciables
	WHERE EXPEDIENTE_ID IN (SELECT BCC.Cod_CDD FROM BI_CM_CRUCE_RCV_CNXP_ABANCA BCC WHERE BCC.CLASIFICACION LIKE '%-DES]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 1
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = 'UPDATE H_EXP' AND  `TIME_END_EXECUTE` IS NULL;			
	
	-- --------------------------------------------------------------------------------
	-- BBVA
	-- --------------------------------------------------------------------------------	

	SELECT 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BBVA WHERE CLASIFICACION LIKE '%-COR]%') correctos,
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BBVA WHERE CLASIFICACION LIKE '%-DIS]%') incorrectos, 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BBVA WHERE CLASIFICACION LIKE '%-DES]%') despreciable,  
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BBVA ) total
	INTO @cor, @inc, @des, @tot FROM DUAL;

	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Correctos]- ',fecha,' - ',@cor, ' - ', @inc) , '[BBVA] UPDATE H_EXP', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_EXP 
		SET SIT_CUADRE_CARTERA_ID = 1 -- Correctos
	WHERE EXPEDIENTE_ID IN (SELECT BCC.Cod_CDD FROM BI_CM_CRUCE_RCV_CNXP_BBVA BCC WHERE BCC.CLASIFICACION LIKE '%-COR]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 2 -- BBVA
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[BBVA] UPDATE H_EXP' AND  `TIME_END_EXECUTE` IS NULL;	
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Incorrectos]- ',fecha,' - ',@cor, ' - ', @inc) , '[BBVA] UPDATE H_EXP', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_EXP 
		SET SIT_CUADRE_CARTERA_ID = 2 -- Incorrectos
	WHERE EXPEDIENTE_ID IN (SELECT BCC.Cod_CDD FROM BI_CM_CRUCE_RCV_CNXP_BBVA BCC WHERE BCC.CLASIFICACION LIKE '%-DIS]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 2 -- BBVA
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[BBVA] UPDATE H_EXP' AND  `TIME_END_EXECUTE` IS NULL;		
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Despreciables]- ',fecha,' - ',@cor, ' - ', @inc) , '[BBVA] UPDATE H_EXP', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_EXP 
		SET SIT_CUADRE_CARTERA_ID = 3 -- Despreciables
	WHERE EXPEDIENTE_ID IN (SELECT BCC.Cod_CDD FROM BI_CM_CRUCE_RCV_CNXP_BBVA BCC WHERE BCC.CLASIFICACION LIKE '%-DES]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 2 -- BBVA
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[BBVA] UPDATE H_EXP' AND  `TIME_END_EXECUTE` IS NULL;			
	
	
	-- --------------------------------------------------------------------------------
	-- BANKIA
	-- --------------------------------------------------------------------------------	

	SELECT 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BANKIA WHERE CLASIFICACION LIKE '%-COR]%') correctos,
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BANKIA WHERE CLASIFICACION LIKE '%-DIS]%') incorrectos, 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BANKIA WHERE CLASIFICACION LIKE '%-DES]%') despreciable,  
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_BANKIA ) total
	INTO @cor, @inc, @des, @tot FROM DUAL;

	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Correctos]- ',fecha,' - ',@cor, ' - ', @inc) , '[BANKIA] UPDATE H_EXP', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_EXP 
		SET SIT_CUADRE_CARTERA_ID = 1 -- Correctos
	WHERE EXPEDIENTE_ID IN (SELECT BCC.Cod_CDD FROM BI_CM_CRUCE_RCV_CNXP_BANKIA BCC WHERE BCC.CLASIFICACION LIKE '%-COR]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 3 -- BANKIA
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[BANKIA] UPDATE H_EXP' AND  `TIME_END_EXECUTE` IS NULL;	
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Incorrectos]- ',fecha,' - ',@cor, ' - ', @inc) , '[BANKIA] UPDATE H_EXP', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_EXP 
		SET SIT_CUADRE_CARTERA_ID = 2 -- Incorrectos
	WHERE EXPEDIENTE_ID IN (SELECT BCC.Cod_CDD FROM BI_CM_CRUCE_RCV_CNXP_BANKIA BCC WHERE BCC.CLASIFICACION LIKE '%-DIS]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 3 -- BANKIA
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[BBVA] UPDATE H_EXP' AND  `TIME_END_EXECUTE` IS NULL;		
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Despreciables]- ',fecha,' - ',@cor, ' - ', @inc) , '[BANKIA] UPDATE H_EXP', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_EXP 
		SET SIT_CUADRE_CARTERA_ID = 3 -- Despreciables
	WHERE EXPEDIENTE_ID IN (SELECT BCC.Cod_CDD FROM BI_CM_CRUCE_RCV_CNXP_BANKIA BCC WHERE BCC.CLASIFICACION LIKE '%-DES]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 3 -- BANKIA
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[BANKIA] UPDATE H_EXP' AND  `TIME_END_EXECUTE` IS NULL;	
	
	
	-- --------------------------------------------------------------------------------
	-- CAJAMAR
	-- --------------------------------------------------------------------------------	

	SELECT 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR WHERE CLASIFICACION LIKE '%-COR]%') correctos,
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR WHERE CLASIFICACION LIKE '%-DIS]%') incorrectos, 
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR WHERE CLASIFICACION LIKE '%-DES]%') despreciable,  
		(SELECT COUNT(1) FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR ) total
	INTO @cor, @inc, @des, @tot FROM DUAL;

	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Correctos]- ',fecha,' - ',@cor, ' - ', @inc) , '[CAJAMAR] UPDATE H_EXP', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_EXP 
		SET SIT_CUADRE_CARTERA_ID = 1 -- Correctos
	WHERE EXPEDIENTE_ID IN (SELECT BCC.Cod_CDD FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR BCC WHERE BCC.CLASIFICACION LIKE '%-COR]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 4 -- CAJAMAR
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[CAJAMAR] UPDATE H_EXP' AND  `TIME_END_EXECUTE` IS NULL;	
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Incorrectos]- ',fecha,' - ',@cor, ' - ', @inc) , '[CAJAMAR] UPDATE H_EXP', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_EXP 
		SET SIT_CUADRE_CARTERA_ID = 2 -- Incorrectos
	WHERE EXPEDIENTE_ID IN (SELECT BCC.Cod_CDD FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR BCC WHERE BCC.CLASIFICACION LIKE '%-DIS]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 4 -- CAJAMAR
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[CAJAMAR] UPDATE H_EXP' AND  `TIME_END_EXECUTE` IS NULL;		
	
	INSERT INTO TIMER_ANALIZE_SP ( `NAME_SP`, `STEP_SP`, `TIME_EXECUTE`, `TIME_START_EXECUTE`, `TIME_END_EXECUTE`, `TIME_DIFF_EXECUTE`) 
		VALUE ( CONCAT('Actualizar_Situacion_Cartera [Despreciables]- ',fecha,' - ',@cor, ' - ', @inc) , '[CAJAMAR] UPDATE H_EXP', CURDATE(), CURTIME(), NULL, NULL);

	UPDATE H_EXP 
		SET SIT_CUADRE_CARTERA_ID = 3 -- Despreciables
	WHERE EXPEDIENTE_ID IN (SELECT BCC.Cod_CDD FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR BCC WHERE BCC.CLASIFICACION LIKE '%-DES]%')
		AND DIA_ID = fecha
		AND ENTIDAD_CEDENTE_ID = 4 -- CAJAMAR
	;

	UPDATE TIMER_ANALIZE_SP SET `TIME_END_EXECUTE` = CURTIME(), `TIME_DIFF_EXECUTE` = TIMEDIFF(`TIME_END_EXECUTE`, `TIME_START_EXECUTE`) 
	WHERE  `STEP_SP` = '[CAJAMAR] UPDATE H_EXP' AND  `TIME_END_EXECUTE` IS NULL;		
	


-- ------------------------------------------------UPDATE JUZGADOS, PLAZAS Y PROCURADORES --------------------------------------------------------
TRUNCATE TABLE TMP_PRC_JUZGADO_PLAZA_PROCURADOR;

INSERT INTO TMP_PRC_JUZGADO_PLAZA_PROCURADOR (PROCEDIMIENTO_ID, EXPEDIENTE_ID)
(SELECT DISTINCT  HPC.PROCEDIMIENTO_ID ,max(HEP.EXPEDIENTE_ID) as EXPEDIENTE_ID 
FROM BI_CM_CRUCE_RCV_CNXP_ABANCA CRX
	INNER JOIN H_PRC HPC ON HPC.ASUNTO_ID = CRX.ASUNTO_RECOVERY AND HPC.DIA_ID = fecha
			AND HPC.ENTIDAD_CEDENTE_ID = 1
	INNER JOIN H_EXP HEP ON CRX.Cod_CDD = HEP.EXPEDIENTE_ID AND HEP.DIA_ID = fecha
			AND HEP.ENTIDAD_CEDENTE_ID = 1 AND (HEP.EST_VIDA_ID=1 or HEP.EST_VIDA_ID=3)

 AND HEP.EST_GESTION_ID=3 group by HPC.PROCEDIMIENTO_ID);

INSERT INTO TMP_PRC_JUZGADO_PLAZA_PROCURADOR (PROCEDIMIENTO_ID, EXPEDIENTE_ID)
(SELECT DISTINCT  HPC.PROCEDIMIENTO_ID ,max(HEP.EXPEDIENTE_ID) as EXPEDIENTE_ID 
FROM BI_CM_CRUCE_RCV_CNXP_BBVA CRX
	INNER JOIN H_PRC HPC ON HPC.ASUNTO_ID = CRX.ASUNTO_RECOVERY AND HPC.DIA_ID = fecha
			AND HPC.ENTIDAD_CEDENTE_ID = 2
	INNER JOIN H_EXP HEP ON CRX.Cod_CDD = HEP.EXPEDIENTE_ID AND HEP.DIA_ID = fecha
			AND HEP.ENTIDAD_CEDENTE_ID = 2 AND (HEP.EST_VIDA_ID=1 or HEP.EST_VIDA_ID=3)

 AND HEP.EST_GESTION_ID=3 group by HPC.PROCEDIMIENTO_ID);


INSERT INTO TMP_PRC_JUZGADO_PLAZA_PROCURADOR (PROCEDIMIENTO_ID, EXPEDIENTE_ID)
(SELECT DISTINCT  HPC.PROCEDIMIENTO_ID ,max(HEP.EXPEDIENTE_ID) as EXPEDIENTE_ID 
FROM BI_CM_CRUCE_RCV_CNXP_BANKIA CRX
	INNER JOIN H_PRC HPC ON HPC.ASUNTO_ID = CRX.ASUNTO_RECOVERY AND HPC.DIA_ID = fecha
			AND HPC.ENTIDAD_CEDENTE_ID = 3
	INNER JOIN H_EXP HEP ON CRX.Cod_CDD = HEP.EXPEDIENTE_ID AND HEP.DIA_ID = fecha
			AND HEP.ENTIDAD_CEDENTE_ID = 3 AND (HEP.EST_VIDA_ID=1 or HEP.EST_VIDA_ID=3)

 AND HEP.EST_GESTION_ID=3 group by HPC.PROCEDIMIENTO_ID);


INSERT INTO TMP_PRC_JUZGADO_PLAZA_PROCURADOR (PROCEDIMIENTO_ID, EXPEDIENTE_ID)
(SELECT DISTINCT  HPC.PROCEDIMIENTO_ID ,max(HEP.EXPEDIENTE_ID) as EXPEDIENTE_ID 
FROM BI_CM_CRUCE_RCV_CNXP_CAJAMAR CRX
	INNER JOIN H_PRC HPC ON HPC.ASUNTO_ID = CRX.ASUNTO_RECOVERY AND HPC.DIA_ID = fecha
			AND HPC.ENTIDAD_CEDENTE_ID = 4
	INNER JOIN H_EXP HEP ON CRX.Cod_CDD = HEP.EXPEDIENTE_ID AND HEP.DIA_ID = fecha
			AND HEP.ENTIDAD_CEDENTE_ID = 4 AND (HEP.EST_VIDA_ID=1 or HEP.EST_VIDA_ID=3)

 AND HEP.EST_GESTION_ID=3 group by HPC.PROCEDIMIENTO_ID);


UPDATE TMP_PRC_JUZGADO_PLAZA_PROCURADOR PRC ,H_EXP HEP 

SET PRC.DIA_ID=HEP.DIA_ID, 
PRC.JUZGADO_ID=if(HEP.JUZGADO_ID is null, -1, HEP.JUZGADO_ID),
PRC.PLAZA_ID=if(HEP.PLAZA_ID is null, -1, HEP.PLAZA_ID),
PRC.PROCURADOR_ID=if(HEP.PROCURADOR_ID is null, -1, HEP.PROCURADOR_ID),
PRC.ENTIDAD_CEDENTE_ID=HEP.ENTIDAD_CEDENTE_ID

WHERE PRC.EXPEDIENTE_ID=HEP.EXPEDIENTE_ID AND HEP.DIA_ID=fecha;


UPDATE H_PRC_PLAZO_MEDIO PM,TMP_PRC_JUZGADO_PLAZA_PROCURADOR PRC
SET PM.JUZGADO_ID=if(PRC.JUZGADO_ID is null, -1, PRC.JUZGADO_ID),
PM.PLAZA_ID=if(PRC.PLAZA_ID is null, -1, PRC.PLAZA_ID),
PM.PROCURADOR_ID=if(PRC.PROCURADOR_ID is null, -1, PRC.PROCURADOR_ID)

WHERE PM.PROCEDIMIENTO_ID=PRC.PROCEDIMIENTO_ID 
AND PM.DIA_ID=PRC.DIA_ID AND PRC.DIA_ID=fecha AND PM.ENTIDAD_CEDENTE_ID=PRC.ENTIDAD_CEDENTE_ID
;


UPDATE H_PRC PRC,TMP_PRC_JUZGADO_PLAZA_PROCURADOR TPRC
SET PRC.JUZGADO_ID=if(TPRC.JUZGADO_ID is null, -1, TPRC.JUZGADO_ID),
PRC.PLAZA_ID=if(TPRC.PLAZA_ID is null, -1, TPRC.PLAZA_ID),
PRC.PROCURADOR_ID=if(TPRC.PROCURADOR_ID is null, -1, TPRC.PROCURADOR_ID)

WHERE PRC.PROCEDIMIENTO_ID=TPRC.PROCEDIMIENTO_ID 
AND PRC.DIA_ID=TPRC.DIA_ID AND PRC.DIA_ID=fecha AND PRC.ENTIDAD_CEDENTE_ID=TPRC.ENTIDAD_CEDENTE_ID
;




		
	
end loop;
close c_fecha;
-- ---------------------------------------------------------------- FIN BUCLE H_EXP -----------------------------------------------------------------





END MY_BLOCK_SIT_CART

