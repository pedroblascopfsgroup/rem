--/*
--##########################################
--## AUTOR=David González
--## FECHA_CREACION=20151201
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=BKREC-1494
--## PRODUCTO=NO
--## 
--## Finalidad: Creación de tablas de respaldo para el etl dirigido a 
--##			finalizar tareas, procedimientos y asuntos por venta de cartera
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

V_ESQUEMA VARCHAR2(10 CHAR) := '#ESQUEMA#';
V_MASTER VARCHAR2(16 CHAR) := '#ESQUEMA_MASTER#';
V_TABLA VARCHAR2(40 CHAR);
V_SENTENCIA VARCHAR2(1600 CHAR);
V_NUM NUMBER(9,0);

BEGIN


--[ FINALIZACION DE PROCEDIMIENTOS POR VENTA DE CARTERA]
--[ ALMACENAMOS LOS CAMBIOS EN TABLA COMO COPIA DE SEGURIDAD PARA PRUEBAS ]

----## BUSCAR TODAS LAS TAREAS VINCULADAS AL PRC_ID Y FINALIZARLAS ##
-- CREAMOS TABLA CON TAREAS QUE CONTENGAN EL PRC_ID QUE TENEMOS EN PROCEDIMIENTOS_A_CERRAR (FIN_AUX_PRC_CERRAR_FINAL)

	DBMS_OUTPUT.PUT_LINE('[INICIO] Comienza el proceso de creación de tablas de respaldo ...');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Respaldo de tareas ...');
	
	V_TABLA := 'FIN_AUX_TMP_TAR_VENTACAR';
	
	V_SENTENCIA := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA||''' AND OWNER = '''||V_ESQUEMA||'''';
	
	EXECUTE IMMEDIATE V_SENTENCIA INTO V_NUM;
	
	IF V_NUM > 0 THEN
		
		DBMS_OUTPUT.PUT_LINE('[INFO] La tabla de respaldo de tareas ya existe');
		
	ELSE
	
	V_SENTENCIA := 'CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||' AS (
					SELECT DISTINCT TAR.TAR_ID, TAR.USUARIOMODIFICAR, TAR.FECHAMODIFICAR, TAR.TAR_TAREA_FINALIZADA, TAR.TAR_FECHA_FIN
					FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR
						INNER JOIN '||V_ESQUEMA||'.FIN_AUX_PRC_CERRAR_FINAL CER
							ON TAR.PRC_ID = CER.PRC_ID
							AND TAR.TAR_TAREA_FINALIZADA != 1
							AND TAR.BORRADO = 0
					)
					'
					;
					
	EXECUTE IMMEDIATE V_SENTENCIA;
	
	END IF;
	
  
-- CREAMOS TABLA CON TAREAS EXTERNAS (TEX_TAREAS_EXTERNAS) QUE CONTENGAN EL PRC_ID QUE TENEMOS EN PROCEDIMIENTOS_A_CERRAR (FIN_AUX_PRC_CERRAR_FINAL)

	DBMS_OUTPUT.PUT_LINE('[INFO] Respaldo de tareas externas ...');
	
	V_TABLA := 'FIN_AUX_TMP_TEX_VENTACAR';
	
	V_SENTENCIA := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA||''' AND OWNER = '''||V_ESQUEMA||'''';
	
	EXECUTE IMMEDIATE V_SENTENCIA INTO V_NUM;
	
	IF V_NUM > 0 THEN
		
		DBMS_OUTPUT.PUT_LINE('[INFO] La tabla de respaldo de tareas externas ya existe');
		
	ELSE
	
	V_SENTENCIA := 'CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||' AS (
					SELECT DISTINCT TEX.TAR_ID, TEX.USUARIOMODIFICAR, TEX.FECHAMODIFICAR, TEX.USUARIOBORRAR, TEX.FECHABORRAR, TEX.BORRADO
					FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR 
						INNER JOIN '||V_ESQUEMA||'.FIN_AUX_PRC_CERRAR_FINAL CER 
							ON TAR.PRC_ID = CER.PRC_ID
							AND TAR.TAR_TAREA_FINALIZADA != 1
						INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX
							ON TAR.TAR_ID = TEX.TAR_ID
					WHERE TEX.BORRADO = 0
					)
					'
					;

	EXECUTE IMMEDIATE V_SENTENCIA;
	
	END IF;
	

----## BUSCAR EL PRC_ID Y FINALIZARLO: PONER MOTIVO "VENTA DE CARTERA" * A FALTA DE METER TEXTO_VENTA ##
-- CREAMOS TABLA CON PROCEDIMIENTOS QUE CONTENGAN EL PRC_ID QUE TENEMOS EN PROCEDIMIENTOS_A_CERRAR (FIN_AUX_PRC_CERRAR_FINAL)

	DBMS_OUTPUT.PUT_LINE('[INFO] Respaldo de procedimientos ...');
	
	V_TABLA := 'FIN_AUX_TMP_PCR_VENTACAR';
	
	V_SENTENCIA := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA||''' AND OWNER = '''||V_ESQUEMA||'''';
	
	EXECUTE IMMEDIATE V_SENTENCIA INTO V_NUM;
	
	IF V_NUM > 0 THEN
		
		DBMS_OUTPUT.PUT_LINE('[INFO] La tabla de respaldo de procedimientos ya existe');
		
	ELSE
	
	V_SENTENCIA := 'CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||' AS (
					SELECT DISTINCT PRC.PRC_ID, PRC.USUARIOMODIFICAR, PRC.FECHAMODIFICAR, PRC.DD_EPR_ID
					FROM '||V_ESQUEMA||'.PRC_PROCEDIMIENTOS PRC 
					  INNER JOIN '||V_ESQUEMA||'.FIN_AUX_PRC_CERRAR_FINAL CER 
						ON PRC.PRC_ID = CER.PRC_ID
						AND PRC.BORRADO = 0
						AND PRC.DD_EPR_ID != (SELECT EPR.DD_EPR_ID FROM '||V_MASTER||'.DD_EPR_ESTADO_PROCEDIMIENTO EPR WHERE EPR.DD_EPR_DESCRIPCION = ''Cerrado'')
					)
					'
					;

	EXECUTE IMMEDIATE V_SENTENCIA;
	
	END IF;
	
  
-- CREAMOS TABLA CON DECISIONES PROCEDIMIENTOS QUE CONTENGAN EL PRC_ID QUE TENEMOS EN PROCEDIMIENTOS_A_CERRAR (FIN_AUX_PRC_CERRAR_FINAL)
  
	V_TABLA := 'FIN_AUX_TMP_DPR_VENTACAR';
	
	V_SENTENCIA := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA||''' AND OWNER = '''||V_ESQUEMA||'''';
	
	EXECUTE IMMEDIATE V_SENTENCIA INTO V_NUM;
	
	IF V_NUM > 0 THEN
		
		DBMS_OUTPUT.PUT_LINE('[INFO] La tabla de respaldo de decisiones procedimientos ya existe');
		
	ELSE
	
	V_SENTENCIA := 'CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||' AS (
					SELECT PRC.PRC_ID, DPR.USUARIOMODIFICAR, DPR.FECHAMODIFICAR, DPR.DD_DFI_ID
					  FROM '||V_ESQUEMA||'.DPR_DECISIONES_PROCEDIMIENTOS DPR 
						INNER JOIN '||V_ESQUEMA||'.FIN_AUX_PRC_CERRAR_FINAL PRC 
						  ON DPR.PRC_ID = PRC.PRC_ID 
						  AND DPR.DD_DFI_ID != (SELECT DFI.DD_DFI_ID FROM BANK01.DD_DFI_DECISION_FINALIZAR DFI WHERE DFI.DD_DFI_DESCRIPCION = ''Venta de cartera'')
						  AND DPR.BORRADO = 0
					)
					'
					;
					
	EXECUTE IMMEDIATE V_SENTENCIA;
	
	END IF;
	
	
----## BUSCAR EL ASU_ID Y FINALIZARLO ## 
-- CREAMOS TABLA CON ASUNTOS QUE CONTENGAN EL ASU_ID QUE TENEMOS EN PROCEDIMIENTOS_A_CERRAR (FIN_AUX_PRC_CERRAR_FINAL)

	DBMS_OUTPUT.PUT_LINE('[INFO] Respaldo de asuntos ...');
	
	V_TABLA := 'FIN_AUX_TMP_ASU_VENTACAR';
	
	V_SENTENCIA := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA||''' AND OWNER = '''||V_ESQUEMA||'''';
	
	EXECUTE IMMEDIATE V_SENTENCIA INTO V_NUM;
	
	IF V_NUM > 0 THEN
		
		DBMS_OUTPUT.PUT_LINE('[INFO] La tabla de respaldo de asuntos ya existe');
		
	ELSE
	
	V_SENTENCIA := 'CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||' AS (
					SELECT DISTINCT ASU.ASU_ID, ASU.USUARIOMODIFICAR, ASU.FECHAMODIFICAR, ASU.DD_EAS_ID
					FROM '||V_ESQUEMA||'.ASU_ASUNTOS ASU
					  INNER JOIN '||V_ESQUEMA||'.FIN_AUX_PRC_CERRAR_FINAL CER
						ON ASU.ASU_ID = CER.ASU_ID
						AND ASU.DD_EAS_ID != (SELECT DD_EAS_ID FROM BANKMASTER.DD_EAS_ESTADO_ASUNTOS WHERE DD_EAS_DESCRIPCION = ''Cerrado'')
						AND ASU.BORRADO = 0
					)
					'
					;
	
	EXECUTE IMMEDIATE V_SENTENCIA;
	
	END IF;
	
	DBMS_OUTPUT.PUT_LINE('[FIN] Proceso de creación de tablas de respaldo finalizado');

END;
/

EXIT;
