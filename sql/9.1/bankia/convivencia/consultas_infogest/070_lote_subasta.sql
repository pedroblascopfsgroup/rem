DELETE FROM MINIREC.RCV_GEST_LOTE_SUBASTA;
commit;

INSERT INTO MINIREC.RCV_GEST_LOTE_SUBASTA
WITH TAR_VALORES AS
( select tar.asu_id, tev.tev_valor
    from bank01.tar_tareas_notificaciones tar
       , bank01.tex_tarea_externa         tex
       , bank01.tap_tarea_procedimiento   tap
       , bank01.tev_tarea_externa_valor   tev
   where tar.tar_id = tex.tar_id
     and tex.tap_id = tap.tap_id
     and tex.tex_id = tev.tex_id
     and tap.tap_codigo in ('P401_CelebracionSubasta','P409_CelebracionSubasta')
     and trim(tev.tev_nombre) = 'comboPostores'
)
SELECT 
   A.ID_PROCEDI
  ,A.ID_ASUNTO_RCV
  ,A.ID_PROCEDI_RCV
  ,LOS.LOS_NUM_LOTE LOTE
  , A.ID_PROPUESTA_RCV
  ,DECODE(ESU.DD_ESU_CODIGO,'CEL','S',' ') AS CELEBRADA
  ,SUB.SUB_FECHA_SENYALAMIENTO
  ,MAX(MIG.CON_POSTORES)  POSTORES
  ,DECODE(MAX(BAD.BIE_ADJ_CESION_REMATE),1,'CES',DECODE(MIN(UPPER(EAD.DD_EAD_DESCRIPCION)),'ENTIDAD','ADJ','TER')) RESULTADO_SUBASTA
  ,DECODE(MAX(BAD.BIE_ADJ_CESION_REMATE),1,'1',DECODE(MIN(UPPER(EAD.DD_EAD_DESCRIPCION)),'ENTIDAD','1','2'))  ID_RESULTADO_SUBASTA_RCV
  ,DECODE(MAX(BAD.BIE_ADJ_CESION_REMATE),1,'CESION',MIN(UPPER(EAD.DD_EAD_DESCRIPCION)))   RESULTADO_SUBASTA_RCV       
  ,MIN(EAD.DD_EAD_CODIGO)             ENTIDAD_ADJ_RCV			
  ,DECODE(MAX(BAD.BIE_ADJ_CESION_REMATE),1,'S',' ') CESION_REMATE_RCV 
FROM MINIREC.RCV_GEST_PROPUESTA A
,bank01.SUB_SUBASTA SUB
,bank01.DD_EAD_ENTIDAD_ADJUDICA EAD
,bank01.BIE_ADJ_ADJUDICACION      BAD
,bank01.LOB_LOTE_BIEN             LOB
,bank01.LOS_LOTE_SUBASTA          LOS
,bank01.MIG_PROCS_SUBASTAS_LOTES  MIG
,bank01.DD_ESU_ESTADO_SUBASTA ESU
WHERE A.ID_PROPUESTA_RCV = SUB.PRC_ID
AND SUB.SUB_ID = LOS.SUB_ID
AND LOS.LOS_ID = LOB.LOS_ID
AND LOB.BIE_ID = BAD.BIE_ID
AND BAD.DD_EAD_ID  = EAD.DD_EAD_ID
AND SUB.DD_ESU_ID = ESU.DD_ESU_ID
AND SUB.CD_SUBASTA_ORIG = MIG.CD_SUBASTA
GROUP BY A.ID_PROCEDI
  ,A.ID_ASUNTO_RCV
  ,A.ID_PROCEDI_RCV
  ,LOS.LOS_NUM_LOTE
  , A.ID_PROPUESTA_RCV
  ,ESU.DD_ESU_CODIGO
  ,SUB.SUB_FECHA_SENYALAMIENTO;
COMMIT;


