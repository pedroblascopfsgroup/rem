DELETE FROM MINIREC.RCV_GEST_BIEN_PDM;
COMMIT;

INSERT INTO MINIREC.RCV_GEST_BIEN_PDM
WITH ULTIMA_TAREA AS 
(
SELECT /*+ MATERIALIZE */ PRC_id, ASU_ID, DD_TPO_ID, BIE_ID, tap_codigo, tap_descripcion, tar_fecha_fin, cod_hito_nal
   FROM (SELECT DISTINCT PRC.PRC_ID, PRC.DD_TPO_ID , TAR.ASU_ID , PRB2.BIE_ID, TAR.TAR_ID
             , tap.tap_codigo, tap.tap_descripcion, tar.tar_fecha_fin
             , trd.cod_hito_nal
             , ROW_NUMBER() OVER (PARTITION BY TAR.asu_id, PRB2.BIE_ID ORDER BY PRB2.BIE_ID, TAR.TAR_ID DESC) ORDEN
          FROM BANK01.PRB_PRC_BIE                 PRB2
             , BANK01.PRC_PROCEDIMIENTOS          PRC
             , BANK01.TAR_TAREAS_NOTIFICACIONES   TAR
             , BANK01.TEX_TAREA_EXTERNA           TEX
             , BANK01.TAP_TAREA_PROCEDIMIENTO     TAP
             , BANK01.AUX_THR_TRADUC_HITOS_RECNAL TRD
             , BANK01.DD_TPO_TIPO_PROCEDIMIENTO   TPO
         WHERE PRC.ASU_ID = TAR.ASU_ID
           AND PRC.PRC_ID = PRB2.PRC_ID
           AND TRD.DD_TPO_CODIGO in ('P401','P409','P413','P416','P417','P418','P419','P09')
           AND TRD.DD_TPO_CODIGO = TPO.DD_TPO_CODIGO
           AND PRC.DD_TPO_ID = TAP.DD_TPO_ID
           AND TAP.DD_TPO_ID = TPO.DD_TPO_ID
           AND TAP.TAP_CODIGO = TRD.TAP_CODIGO
           AND TAR.TAR_ID = TEX.TAR_ID
           AND TEX.TAP_ID = TAP.TAP_ID
           AND NOT (TAR.BORRADO=0 AND NVL(TAR.TAR_TAREA_FINALIZADA,0)=0)
       ) WHERE ORDEN = 1
),
PRIMERA_VALORACION AS 
( SELECT /*+ MATERIALIZE */ BIE_ID,BIE_IMPORTE_VALOR_TASACION,BIE_FECHA_VALOR_TASACION
  FROM (SELECT /*+ MATERIALIZE */ BIEVAL.BIE_ID, BIEVAL.BIE_IMPORTE_VALOR_TASACION, BIEVAL.BIE_FECHA_VALOR_TASACION
             , ROW_NUMBER() OVER (PARTITION BY BIE_ID ORDER BY BIE_FECHA_VALOR_SUBJETIVO ASC) VALORACION_NUM
          FROM BANK01.BIE_VALORACIONES BIEVAL
       ) WHERE VALORACION_NUM = 1
),
ULTIMA_VALORACION AS 
( SELECT /*+ MATERIALIZE */ BIE_ID,BIE_IMPORTE_VALOR_TASACION,BIE_FECHA_VALOR_TASACION
  FROM (SELECT /*+ MATERIALIZE */ BIEVAL.BIE_ID, BIEVAL.BIE_IMPORTE_VALOR_TASACION, BIEVAL.BIE_FECHA_VALOR_TASACION
             , ROW_NUMBER() OVER (PARTITION BY BIE_ID ORDER BY BIE_FECHA_VALOR_SUBJETIVO DESC) VALORACION_NUM
          FROM BANK01.BIE_VALORACIONES BIEVAL
       ) WHERE VALORACION_NUM = 1
),
FECHAS_ACTA_SUBASTA AS
(
SELECT A.PRC_ID, TO_DATE(D.TEV_VALOR,'YYYY-MM-DD') AS FECHA_REGISTRO_ACTA
FROM BANK01.PRC_PROCEDIMIENTOS A, BANK01.TAR_TAREAS_NOTIFICACIONES B, BANK01.TEX_TAREA_EXTERNA C, BANK01.TEV_TAREA_EXTERNA_VALOR D,
     BANK01.TAP_TAREA_PROCEDIMIENTO E
WHERE A.PRC_ID = B.PRC_ID
AND B.TAR_ID = C.TAR_ID
AND C.TEX_ID = D.TEX_ID
AND C.TAP_ID = E.TAP_ID
AND E.DD_TPO_ID = A.DD_TPO_ID
AND E.TAP_CODIGO IN ('P401_RegistrarActaSubasta','P409_RegistrarActaSubasta') 
AND D.TEV_NOMBRE = ('fecha')
)
SELECT DISTINCT 
     GUI.ID_PROCEDI                                       as ID_PROCEDI
   , GUI.ID_ASUNTO_RCV                                    as ID_ASUNTO_RCV
   , GUI.ID_PROCEDI_RCV                                   as ID_PROCEDI_RCV
   , BIE.BIE_ID                                           as ID_BIEN_RCV
   , BIE.BIE_CODIGO_EXTERNO                               as ID_BIEN
   , MAX(TRUNC(SUB.SUB_FECHA_SENYALAMIENTO))              as FEC_SE_SUBASTA
   , NVL(MAX(BIE.BIE_TIPO_SUBASTA),0)                     as VALOR_JUDICIAL
   , DECODE(MAX(DD_ESU.DD_ESU_CODIGO),'CEL','S','N')      as SUBASTA_CELEBRADA
   , TRUNC(MAX(SUB.SUB_FECHA_SENYALAMIENTO))              as FEC_CELB_SUBASTA
   , MAX(DECODE(ADJ.BIE_ADJ_CESION_REMATE,1,'1',NULL, NULL, DECODE(UPPER(EAD.DD_EAD_DESCRIPCION),'ENTIDAD','1','2')))  ID_RESULTADO_SUBASTA_RCV
   , MAX(DECODE(ADJ.BIE_ADJ_CESION_REMATE,1,'CESION',NULL,NULL,UPPER(EAD.DD_EAD_DESCRIPCION)))   RESULTADO_SUBASTA_RCV  
   , MAX(DECODE(ADJ.BIE_ADJ_CESION_REMATE,1,'CES',NULL,NULL,DECODE(UPPER(EAD.DD_EAD_DESCRIPCION),'ENTIDAD','ADJ','TER'))) RESULTADO_SUBASTA
   , MAX(ADJ.BIE_ADJ_IMPORTE_ADJUDICACION)                as IMPORTE_SUBASTA
   , MAX(DD_MOTCANCEL.DD_MCS_CODIGO)                      as ID_MOTIVO_SUBASTA_RCV
   , CASE 
        WHEN MAX(DD_MOTCANCEL.DD_MCS_CODIGO) IS NULL
          THEN NULL
          ELSE DECODE(MAX(DD_MOTCANCEL.DD_MCS_CODIGO)
                     ,'ACU','REG','EAC','SUS'
                     ,'CAN')
     END                                                  as MOTIVO_SUBASTA_RCV
   , MAX(DD_MOTCANCEL.DD_MCS_DESCRIPCION)                 as MOTIVO_SUBASTA
   , MAX(FACTS.FECHA_REGISTRO_ACTA)                       as FEC_RECEPCION_ACTA
   , MAX(ADJ.BIE_ADJ_F_DECRETO_N_FIRME)                   as FEC_AUTO_ADJ_NO
   , MAX(ADJ.BIE_ADJ_F_DECRETO_FIRME)                     as FEC_AUTO_ADJ
   , MAX(ULT_TAR.TAP_CODIGO)                              as ID_ULT_TAR_REALIZADA_RCV
   , MAX(ULT_TAR.TAP_DESCRIPCION)                         as ULT_TAR_REALIZADA_RCV
   , MAX(ULT_TAR.COD_HITO_NAL)                            as HITO_MAS_AVANZADO
   , MAX(trunc(ULT_TAR.TAR_FECHA_FIN))                    as F_HITO_MAS_AVANZADO
   , MAX(BIE.BIE_NUMERO_ACTIVO)                           as NUMERO_ACTIVO
   , MAX(LOS.LOS_NUM_LOTE)                                as LOTE
   , MAX(PRIBIEVAL.BIE_IMPORTE_VALOR_TASACION)            as TASACION_ACTIVOS_INI
   , MAX(PRIBIEVAL.BIE_FECHA_VALOR_TASACION)              as FECHA_RECEP_INI_TASACION
   , MAX(PRIBIEVAL.BIE_FECHA_VALOR_TASACION)              as FECHA_REALIZ_INI_TASACION
   , MAX(PRIBIEVAL.BIE_FECHA_VALOR_TASACION)              as FECHA_PETIC_INI_TASACION
   , MAX(ULTBIEVAL.BIE_IMPORTE_VALOR_TASACION)            as TASACION_ACTIVOS_ULT
   , MAX(ULTBIEVAL.BIE_FECHA_VALOR_TASACION)              as FECHA_RECEP_ULT_TASACION
   , MAX(ULTBIEVAL.BIE_FECHA_VALOR_TASACION)              as FECHA_REALIZ_ULT_TASACION
   , MAX(ULTBIEVAL.BIE_FECHA_VALOR_TASACION)              as FECHA_PETIC_ULT_TASACION
   , MAX(ADJ.BIE_ADJ_F_INSCRIP_TITULO)                    as FEC_INSCR_TITULO
   , MAX(ADJ.BIE_ADJ_F_REA_POSESION)                      as FEC_REALI_POSES
   , MAX(ADJ.BIE_ADJ_F_REA_LANZAMIENTO)                   as FEC_REALI_LANZA
   , MAX(ADJ.BIE_ADJ_F_ENVIO_LLAVES)                      as FEC_RECEP_LLAVES
   , MAX(ADJ.BIE_ADJ_F_RECEP_DEPOSITARIO_F)               as FECHA_CESION_FONDO
   , CASE MAX(BIE_ADJ_CESION_REMATE) 
       WHEN 1 THEN 'S'
       ELSE 'N' END                                       as TRATADA_CESION
   , NULL                                                 as TRATADO_TESTIMONIO
   , NULL                                                 as TRATADA_INSCRIPCION
   , NULL                                                 as TRATADA_POSESION
FROM MINIREC.RCV_GEST_PDM_LITIGIO GUI
   , BANK01.PRB_PRC_BIE PRB
   , BANK01.PRC_PROCEDIMIENTOS PRC
   , BANK01.BIE_BIEN BIE 
   , BANK01.BIE_ADJ_ADJUDICACION ADJ 
   , BANK01.DD_EAD_ENTIDAD_ADJUDICA EAD 
   , PRIMERA_VALORACION PRIBIEVAL 
   , ULTIMA_VALORACION ULTBIEVAL 
   , BANK01.LOB_LOTE_BIEN LOB 
   , BANK01.LOS_LOTE_SUBASTA LOS
   , BANK01.SUB_SUBASTA SUB 
   , BANK01.DD_ESU_ESTADO_SUBASTA DD_ESU
   , BANK01.DD_MCS_MOT_CANCEL_SUBASTA DD_MOTCANCEL
   , ULTIMA_TAREA ULT_TAR
   , FECHAS_ACTA_SUBASTA FACTS
WHERE GUI.ID_ASUNTO_RCV = PRC.ASU_ID
AND PRC.PRC_ID = PRB.PRC_ID
AND PRB.BIE_ID = BIE.BIE_ID
AND PRC.ASU_ID = ULT_TAR.ASU_ID (+)
AND BIE.BIE_ID = ADJ.BIE_ID(+)
AND ADJ.DD_EAD_ID = EAD.DD_EAD_ID(+)
AND BIE.BIE_ID = PRIBIEVAL.BIE_ID(+)
AND BIE.BIE_ID = ULTBIEVAL.BIE_ID(+)
AND BIE.BIE_ID = LOB.BIE_ID(+)
AND LOB.LOS_ID = LOS.LOS_ID(+)
AND GUI.ID_ASUNTO_RCV = SUB.ASU_ID(+)
AND SUB.DD_ESU_ID = DD_ESU.DD_ESU_ID(+)
AND SUB.DD_MCS_ID = DD_MOTCANCEL.DD_MCS_ID(+)
AND PRC.PRC_ID = FACTS.PRC_ID (+)
GROUP BY
     GUI.ID_PROCEDI
   , GUI.ID_ASUNTO_RCV
   , GUI.ID_PROCEDI_RCV
   , BIE.BIE_ID
   , BIE.BIE_CODIGO_EXTERNO
   , SUB.SUB_ID;
   
COMMIT;






--merge into minirec.RCV_GEST_BIEN_PDM a
--using (
--WITH ULTIMA_TAREA AS 
--(
--SELECT /*+ MATERIALIZE */ PRC_id, ASU_ID, DD_TPO_ID, BIE_ID, tap_codigo, tap_descripcion, tar_fecha_fin, cod_hito_nal
/*   FROM (SELECT DISTINCT PRC.PRC_ID, PRC.DD_TPO_ID , TAR.ASU_ID , PRB2.BIE_ID, TAR.TAR_ID
             , tap.tap_codigo, tap.tap_descripcion, tar.tar_fecha_fin
             , trd.cod_hito_nal
             , ROW_NUMBER() OVER (PARTITION BY TAR.asu_id, PRB2.BIE_ID ORDER BY PRB2.BIE_ID, TAR.TAR_ID DESC) ORDEN
          FROM bank01.PRB_PRC_BIE                 PRB2
             , bank01.PRC_PROCEDIMIENTOS          PRC
             , bank01.TAR_TAREAS_NOTIFICACIONES   TAR
             , bank01.TEX_TAREA_EXTERNA           TEX
             , bank01.TAP_TAREA_PROCEDIMIENTO     TAP
             , bank01.AUX_THR_TRADUC_HITOS_RECNAL TRD
             , bank01.DD_TPO_TIPO_PROCEDIMIENTO   TPO
         WHERE PRC.ASU_ID = TAR.ASU_ID
           AND PRC.PRC_ID = PRB2.PRC_ID
           AND TRD.DD_TPO_CODIGO in ('P401','P409','P413','P416','P417','P418','P419','P09')
           AND TRD.DD_TPO_CODIGO = TPO.DD_TPO_CODIGO
           AND PRC.DD_TPO_ID = TAP.DD_TPO_ID
           AND TAP.DD_TPO_ID = TPO.DD_TPO_ID
           AND TAP.TAP_CODIGO = TRD.TAP_CODIGO
           AND TAR.TAR_ID = TEX.TAR_ID
           AND TEX.TAP_ID = TAP.TAP_ID
           AND NOT (TAR.BORRADO=0 AND NVL(TAR.TAR_TAREA_FINALIZADA,0)=0)
       ) WHERE ORDEN = 1
),

FECHAS_ACTA_SUBASTA AS
(
SELECT A.PRC_ID, TO_DATE(D.TEV_VALOR,'YYYY-MM-DD') AS FECHA_REGISTRO_ACTA
FROM bank01.PRC_PROCEDIMIENTOS A, bank01.TAR_TAREAS_NOTIFICACIONES B, bank01.TEX_TAREA_EXTERNA C, bank01.TEV_TAREA_EXTERNA_VALOR D,
     bank01.TAP_TAREA_PROCEDIMIENTO E
WHERE A.PRC_ID = B.PRC_ID
AND B.TAR_ID = C.TAR_ID
AND C.TEX_ID = D.TEX_ID
AND C.TAP_ID = E.TAP_ID
AND E.DD_TPO_ID = A.DD_TPO_ID
AND E.TAP_CODIGO IN ('P401_RegistrarActaSubasta','P409_RegistrarActaSubasta') 
AND D.TEV_NOMBRE = ('fecha')
)
select distinct DECODE(ESU.DD_ESU_CODIGO,'CEL','S','N')      as SUBASTA_CELEBRADA, sub.PRC_ID, sub.asu_id, lob.bie_id,tap_descripcion, tar_fecha_fin, cod_hito_nal, (fech.FECHA_REGISTRO_ACTA)                       as FEC_RECEPCION_ACTA
from BANK01.SUB_SUBASTA sub 
inner join BANK01.DD_ESU_ESTADO_SUBASTA esu on sub.DD_ESU_ID = esu.DD_ESU_ID
inner join BANK01.LOS_LOTE_SUBASTA los on sub.SUB_ID = los.SUB_ID
inner join BANK01.LOB_LOTE_BIEN lob on los.LOS_ID = lob.LOS_ID
inner join minirec.RCV_GEST_BIEN_PDM rcv on lob.BIE_ID=rcv.ID_BIEN_RCV
inner join ultima_tarea tarea on tarea.prc_id=sub.prc_id
inner join fechas_acta_subasta fech on TARea.PRC_ID = fech.PRC_ID
where  (lob.bie_id,fech.FECHA_REGISTRO_ACTA) in (select lob.bie_id,fech.FECHA_REGISTRO_ACTA from BANK01.SUB_SUBASTA sub 
inner join BANK01.DD_ESU_ESTADO_SUBASTA esu on sub.DD_ESU_ID = esu.DD_ESU_ID
inner join BANK01.LOS_LOTE_SUBASTA los on sub.SUB_ID = los.SUB_ID
inner join BANK01.LOB_LOTE_BIEN lob on los.LOS_ID = lob.LOS_ID
inner join minirec.RCV_GEST_BIEN_PDM rcv on lob.BIE_ID=rcv.ID_BIEN_RCV
inner join ultima_tarea tarea on tarea.prc_id=sub.prc_id
inner join fechas_acta_subasta fech on TARea.PRC_ID = fech.PRC_ID group by lob.bie_id,fech.FECHA_REGISTRO_ACTA having count(*)=1)) b
on ( a.id_asunto_rcv=b.asu_id and a.id_bien_rcv=b.bie_id) 
when matched then update set a.SUBASTA_CELEBRADA=b.SUBASTA_CELEBRADA;
*/

commit;
