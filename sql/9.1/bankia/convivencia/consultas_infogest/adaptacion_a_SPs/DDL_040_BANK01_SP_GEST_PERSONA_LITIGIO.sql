--/*
--#########################################
--## AUTOR=David González
--## FECHA_CREACION=20151101
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=BKREC-1335
--## PRODUCTO=NO
--## 
--## Finalidad: 
--## INSTRUCCIONES:  
--## VERSIONES:
--##        	0.1 Versión inicial
--##		
--#########################################
--*/
 
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;

CREATE OR REPLACE PROCEDURE GEST_PERSONA_LITIGIO AUTHID CURRENT_USER AS

BEGIN
/* v0.1 */

	INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOG VALUES (#ESQUEMA_MINIREC#.S_RCV_GEST_LOG.NEXTVAL, 'RCV_GEST_PERSONA_LITIGIO', 'INSERT EN MINIREC.RCV_GEST_PERSONA_LITIGIO', 'INICIO', TO_CHAR(SYSTIMESTAMP, 'DD/MM/RR HH24:MI:SS'));

	DBMS_OUTPUT.PUT_LINE('[INFO] La tabla MINIREC.RCV_GEST_PERSONA_LITIGIO va a ser truncada.');

	#ESQUEMA_MINIREC#.OPERACION_DDL.DDL_TABLE('TRUNCATE','RCV_GEST_PERSONA_LITIGIO');

COMMIT;

	DBMS_OUTPUT.PUT_LINE('[INFO] Tabla MINIREC.RCV_GEST_PERSONA_LITIGIO truncada.');

	DBMS_OUTPUT.PUT_LINE('[INFO] Se van a insertar registros en MINIREC.RCV_GEST_PERSONA_LITIGIO.');

INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_PERSONA_LITIGIO
	SELECT DISTINCT GUI.ID_PERSONA_RCV 				AS ID_PERSONA_RCV
		 , GUI.NUMERO_PERSONA 						AS NUMERO_PERSONA
		 , DECODE(TDI.DD_TDI_CODIGO
				 ,'1','D'
				 ,'2','C'
				 ,'3','T'
				 ,'4','P'
				 ,'5','E'
				 ,'7','F'
				 ,'8','I'
				 ,'9','M'
				 ,'J','J'
				 ,'F','N'
				 ,'P','S'
				 ,'N') 								AS TIPO_DOC
		 , PER.PER_DOC_ID 							AS DOCUMENTO
		 , NVL(PER.PER_NOM50,'Nombre Tit. Exp.') 	AS NOMBRE 
	FROM #ESQUEMA_MINIREC#.RCV_GEST_PERSONA_PDM 	GUI
	   , #ESQUEMA#.DD_TDI_TIPO_DOCUMENTO_ID 		TDI
	   , #ESQUEMA#.PER_PERSONAS 					PER
	WHERE GUI.ID_PERSONA_RCV = PER.PER_ID
		AND PER.DD_TDI_ID = TDI.DD_TDI_ID;
	  
COMMIT;


	DBMS_OUTPUT.PUT_LINE('[INFO] Registros insertados en MINIREC.RCV_GEST_PERSONA_LITIGIO.');

	DBMS_OUTPUT.PUT_LINE('[FIN]: Script ejecutado correctamente');
	
	INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOG VALUES (#ESQUEMA_MINIREC#.S_RCV_GEST_LOG.NEXTVAL, 'RCV_GEST_PERSONA_LITIGIO', 'INSERT EN MINIREC.RCV_GEST_PERSONA_LITIGIO', 'FIN', TO_CHAR(SYSTIMESTAMP, 'DD/MM/RR HH24:MI:SS'));


EXCEPTION
	
	WHEN OTHERS THEN
     
		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion: '||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
		DBMS_OUTPUT.put_line(SQLERRM);

	ROLLBACK;
	RAISE;          

END GEST_PERSONA_LITIGIO;
/

EXIT;
