--/*
--#########################################
--## AUTOR=David González
--## FECHA_CREACION=20151101
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=BKREC-1335
--## PRODUCTO=NO
--## 
--## Finalidad: 
--## INSTRUCCIONES:  
--## VERSIONES:
--##        	0.1 Versión inicial
--##		
--#########################################
--*/
 
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;

CREATE OR REPLACE PROCEDURE GEST_HITOS_INTERV AUTHID CURRENT_USER AS

BEGIN
/* v0.1 */
	
	INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOG VALUES (#ESQUEMA_MINIREC#.S_RCV_GEST_LOG.NEXTVAL, 'RCV_GEST_HITOS_INTERV_PDM', 'INSERT EN MINIREC.RCV_GEST_HITOS_INTERV_PDM', 'INICIO', TO_CHAR(SYSTIMESTAMP, 'DD/MM/RR HH24:MI:SS'));

	DBMS_OUTPUT.PUT_LINE('[INFO] La tabla MINIREC.RCV_GEST_HITOS_INTERV_PDM va a ser truncada.');

	#ESQUEMA_MINIREC#.OPERACION_DDL.DDL_TABLE('TRUNCATE','RCV_GEST_HITOS_INTERV_PDM');
	

COMMIT;

	DBMS_OUTPUT.PUT_LINE('[INFO] Tabla MINIREC.RCV_GEST_HITOS_INTERV_PDM truncada.');

	DBMS_OUTPUT.PUT_LINE('[INFO] Se van a insertar registros en MINIREC.RCV_GEST_HITOS_INTERV_PDM.');

INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_HITOS_INTERV_PDM
	SELECT GUI.ID_PROCEDI                		  		AS ID_PROCEDI
		 , GUI.ID_PROCEDI_RCV                     		AS ID_PROCEDI_RCV
		 , GUI.ID_PERSONA_RCV                     		AS ID_PERSONA_RCV
		 , GUI.NUMERO_PERSONA                     		AS NUMERO_PERSONA
		 , TRD.COD_HITO_NAL                       		AS HITO
		 , NULL                                   		AS ID_TAR_RCV
		 , NULL                                   		AS TAREA_RCV
		 , CASE WHEN MIN(TRUNC(TAR.TAR_FECHA_INI)) 
				  IN (to_date('09/04/15','DD/MM/YYYY'),to_date('07/03/15','DD/MM/YYYY'))
				  THEN NULL
				  ELSE MIN(TRUNC(TAR.TAR_FECHA_INI)) 
		   END                                    	   	AS FECHA_INICIO
		 , MAX(TAR.TAR_FECHA_FIN)                      	AS FECHA_FIN
		 , MAX(TAR.TAR_FECHA_VENC)                     	AS FECHA_LIMITE
		 , CASE WHEN MIN(TAR.TAR_TAREA_FINALIZADA) = 0
				 AND MIN(TAR.BORRADO) = 0
				 THEN 'S'
				 ELSE 'N'
		   END 											AS ACTIVO
	FROM #ESQUEMA_MINIREC#.RCV_GEST_PERSONA_PDM  		GUI
		 , #ESQUEMA#.PRC_PER                 	  		PRP
		 , #ESQUEMA#.TAR_TAREAS_NOTIFICACIONES   		TAR
		 , #ESQUEMA#.TEX_TAREA_EXTERNA           		TEX
		 , #ESQUEMA#.TAP_TAREA_PROCEDIMIENTO     		TAP
		 , #ESQUEMA#.AUX_THR_TRADUC_HITOS_RECNAL 		TRD
		 , #ESQUEMA#.PRC_PROCEDIMIENTOS 				PRC
	WHERE SUBSTR(TRD.COD_HITO_NAL,1,1) = 'A'
		AND TAP.TAP_CODIGO = TRD.TAP_CODIGO
		AND GUI.ID_PERSONA_RCV = PRP.PER_ID
		AND GUI.ID_PROCEDI_RCV = PRP.PRC_ID
		AND PRP.PRC_ID = PRC.PRC_ID
		AND PRC.PRC_ID = TAR.PRC_ID
		AND TAR.TAR_ID = TEX.TAR_ID
		AND TEX.TAP_ID = TAP.TAP_ID
		AND PRC.DD_TPO_ID = TAP.DD_TPO_ID
	GROUP BY GUI.ID_PROCEDI
		 , GUI.ID_PROCEDI_RCV  
		 , GUI.ID_PERSONA_RCV 
		 , GUI.NUMERO_PERSONA 
		 , TRD.COD_HITO_NAL;
	 
COMMIT;


	DBMS_OUTPUT.PUT_LINE('[INFO] Registros insertados en MINIREC.RCV_GEST_HITOS_INTERV_PDM.');

	DBMS_OUTPUT.PUT_LINE('[FIN]: Script ejecutado correctamente');
	
	INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOG VALUES (#ESQUEMA_MINIREC#.S_RCV_GEST_LOG.NEXTVAL, 'RCV_GEST_HITOS_INTERV_PDM', 'INSERT EN MINIREC.RCV_GEST_HITOS_INTERV_PDM', 'FIN', TO_CHAR(SYSTIMESTAMP, 'DD/MM/RR HH24:MI:SS'));


EXCEPTION
	
	WHEN OTHERS THEN
     
		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion: '||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
		DBMS_OUTPUT.put_line(SQLERRM);

	ROLLBACK;
	RAISE;          

END GEST_HITOS_INTERV;
/

EXIT;

