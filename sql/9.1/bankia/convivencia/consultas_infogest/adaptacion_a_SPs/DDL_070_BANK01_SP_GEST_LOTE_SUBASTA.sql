--/*
--#########################################
--## AUTOR=David González
--## FECHA_CREACION=20151101
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=BKREC-1335
--## PRODUCTO=NO
--## 
--## Finalidad: 
--## INSTRUCCIONES:  
--## VERSIONES:
--##        	0.1 Versión inicial
--##		
--#########################################
--*/
 
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;

CREATE OR REPLACE PROCEDURE GEST_LOTE_SUBASTA AUTHID CURRENT_USER AS

BEGIN
/* v0.1 */
	
	INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOG VALUES (#ESQUEMA_MINIREC#.S_RCV_GEST_LOG.NEXTVAL, 'RCV_GEST_LOTE_SUBASTA', 'INSERT EN MINIREC.RCV_GEST_LOTE_SUBASTA', 'INICIO', TO_CHAR(SYSTIMESTAMP, 'DD/MM/RR HH24:MI:SS'));

	DBMS_OUTPUT.PUT_LINE('[INFO] La tabla MINIREC.RCV_GEST_LOTE_SUBASTA va a ser truncada.');

	#ESQUEMA_MINIREC#.OPERACION_DDL.DDL_TABLE('TRUNCATE','RCV_GEST_LOTE_SUBASTA');

COMMIT;

	DBMS_OUTPUT.PUT_LINE('[INFO] Tabla MINIREC.RCV_GEST_LOTE_SUBASTA truncada.');

	DBMS_OUTPUT.PUT_LINE('[INFO] Se van a insertar registros en MINIREC.RCV_GEST_LOTE_SUBASTA.');

INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOTE_SUBASTA
	SELECT 
	   A.ID_PROCEDI
	  ,A.ID_ASUNTO_RCV
	  ,A.ID_PROCEDI_RCV
	  ,LOS.LOS_NUM_LOTE 						LOTE
	  , A.ID_PROPUESTA_RCV
	  ,DECODE(ESU.DD_ESU_CODIGO,'CEL','S',' ') 	AS CELEBRADA
	  ,SUB.SUB_FECHA_SENYALAMIENTO 				FECHA_SUBASTA
	  ,MAX(MIG.CON_POSTORES)  					POSTORES
	  ,DECODE(MAX(BAD.BIE_ADJ_CESION_REMATE),1,'CES',DECODE(MIN(UPPER(EAD.DD_EAD_DESCRIPCION)),'ENTIDAD','ADJ',null,null,'TER')) 	RESULTADO_SUBASTA
	  ,DECODE(MAX(BAD.BIE_ADJ_CESION_REMATE),1,'1',DECODE(MIN(UPPER(EAD.DD_EAD_DESCRIPCION)),'ENTIDAD','1',null,null,'2'))  		ID_RESULTADO_SUBASTA_RCV
	  ,DECODE(MAX(BAD.BIE_ADJ_CESION_REMATE),1,'CESION',MIN(UPPER(EAD.DD_EAD_DESCRIPCION)))   										RESULTADO_SUBASTA_RCV       
	  ,MIN(EAD.DD_EAD_CODIGO)             					ENTIDAD_ADJ_RCV			
	  ,DECODE(MAX(BAD.BIE_ADJ_CESION_REMATE),1,'S',' ') 	CESION_REMATE_RCV 
	FROM #ESQUEMA_MINIREC#.RCV_GEST_PROPUESTA A
		INNER JOIN #ESQUEMA#.SUB_SUBASTA 				SUB 
			ON A.ID_PROPUESTA_RCV = SUB.PRC_ID
		INNER JOIN #ESQUEMA#.LOS_LOTE_SUBASTA 			LOS 
			ON SUB.SUB_ID = LOS.SUB_ID
		INNER JOIN #ESQUEMA#.LOB_LOTE_BIEN 				LOB 
			ON LOS.LOS_ID = LOB.LOS_ID
		INNER JOIN #ESQUEMA#.BIE_ADJ_ADJUDICACION 		BAD 
			ON LOB.BIE_ID = BAD.BIE_ID
		LEFT JOIN #ESQUEMA#.DD_EAD_ENTIDAD_ADJUDICA 	EAD 
			ON BAD.DD_EAD_ID  = EAD.DD_EAD_ID
		LEFT JOIN #ESQUEMA#.DD_ESU_ESTADO_SUBASTA 		ESU 
			ON SUB.DD_ESU_ID = ESU.DD_ESU_ID
		LEFT JOIN #ESQUEMA#.MIG_PROCS_SUBASTAS_LOTES 	MIG 
			ON SUB.CD_SUBASTA_ORIG = MIG.CD_SUBASTA
	GROUP BY A.ID_PROCEDI
	  ,A.ID_ASUNTO_RCV
	  ,A.ID_PROCEDI_RCV
	  ,LOS.LOS_NUM_LOTE
	  , A.ID_PROPUESTA_RCV
	  ,ESU.DD_ESU_CODIGO
	  ,SUB.SUB_FECHA_SENYALAMIENTO;  
	  
COMMIT;


	DBMS_OUTPUT.PUT_LINE('[INFO] Registros insertados en MINIREC.RCV_GEST_LOTE_SUBASTA.');

	DBMS_OUTPUT.PUT_LINE('[FIN]: Script ejecutado correctamente');
	
	INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOG VALUES (#ESQUEMA_MINIREC#.S_RCV_GEST_LOG.NEXTVAL, 'RCV_GEST_LOTE_SUBASTA', 'INSERT EN MINIREC.RCV_GEST_LOTE_SUBASTA', 'FIN', TO_CHAR(SYSTIMESTAMP, 'DD/MM/RR HH24:MI:SS'));


EXCEPTION
	
	WHEN OTHERS THEN
     
		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion: '||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
		DBMS_OUTPUT.put_line(SQLERRM);

	ROLLBACK;
	RAISE;          

END GEST_LOTE_SUBASTA;
/

EXIT;
