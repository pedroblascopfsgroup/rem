--/*
--#########################################
--## AUTOR=David González
--## FECHA_CREACION=20151101
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=BKREC-1335
--## PRODUCTO=NO
--## 
--## Finalidad: 
--## INSTRUCCIONES:  
--## VERSIONES:
--##        	0.1 Versión inicial
--##		
--#########################################
--*/
 
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;

CREATE OR REPLACE PROCEDURE GEST_LOTE_PROPUESTA AUTHID CURRENT_USER AS

BEGIN
/* v0.1 */

	INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOG VALUES (#ESQUEMA_MINIREC#.S_RCV_GEST_LOG.NEXTVAL, 'RCV_GEST_LOTE_PROPUESTA', 'INSERT EN MINIREC.RCV_GEST_LOTE_PROPUESTA', 'INICIO', TO_CHAR(SYSTIMESTAMP, 'DD/MM/RR HH24:MI:SS'));

	DBMS_OUTPUT.PUT_LINE('[INFO] La tabla MINIREC.RCV_GEST_LOTE_PROPUESTA va a ser truncada.');

	#ESQUEMA_MINIREC#.OPERACION_DDL.DDL_TABLE('TRUNCATE','RCV_GEST_LOTE_PROPUESTA');

COMMIT;

	DBMS_OUTPUT.PUT_LINE('[INFO] Tabla MINIREC.RCV_GEST_LOTE_PROPUESTA truncada.');

	DBMS_OUTPUT.PUT_LINE('[INFO] Se van a insertar registros en MINIREC.RCV_GEST_LOTE_PROPUESTA.');

INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOTE_PROPUESTA
	SELECT
		A.ID_ASUNTO_RCV
		,A.ID_PROCEDI_RCV
		,A.ID_PROCEDI
		,A.ID_PROPUESTA_RCV
		,LOS.LOS_NUM_LOTE 									LOTE
		,DECODE(MAX(MIG.CON_POSTORES),0,'N',NULL,'N',1,'S') CON_POSTORES
		,MIN(LOS.LOS_PUJA_POSTORES_DESDE) 					PUJAR_DESDE	
		,MAX(LOS.LOS_PUJA_POSTORES_HASTA) 					PUJAR_HASTA	
		,MAX(LOS.LOS_PUJA_POSTORES_HASTA) 					PRESENTAR_SI	
		,MAX(LOS.LOS_PUJA_POSTORES_HASTA) 					NO_INTERVENIR_SI
		,SUM(BAD.BIE_ADJ_IMPORTE_ADJUDICACION) 				IMPORTE_ADJ	
	FROM 
		#ESQUEMA_MINIREC#.RCV_GEST_PROPUESTA 	A
		,#ESQUEMA#.SUB_SUBASTA 				 	SUB
		,#ESQUEMA#.BIE_ADJ_ADJUDICACION      	BAD 
		,#ESQUEMA#.LOB_LOTE_BIEN             	LOB
		,#ESQUEMA#.LOS_LOTE_SUBASTA          	LOS
		,#ESQUEMA#.MIG_PROCS_SUBASTAS_LOTES  	MIG
	WHERE A.ID_PROPUESTA_RCV = SUB.PRC_ID
		AND SUB.SUB_ID = LOS.SUB_ID
		AND LOS.LOS_ID = LOB.LOS_ID
		AND LOB.BIE_ID = BAD.BIE_ID
		AND MIG.CD_SUBASTA = SUB.CD_SUBASTA_ORIG
	GROUP BY A.ID_ASUNTO_RCV
			 ,A.ID_PROCEDI_RCV
			 ,A.ID_PROCEDI
			 ,A.ID_PROPUESTA_RCV
			 ,LOS.LOS_NUM_LOTE;
          
COMMIT;


	DBMS_OUTPUT.PUT_LINE('[INFO] Registros insertados en MINIREC.RCV_GEST_LOTE_PROPUESTA.');

	DBMS_OUTPUT.PUT_LINE('[FIN]: Script ejecutado correctamente');
	
	INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOG VALUES (#ESQUEMA_MINIREC#.S_RCV_GEST_LOG.NEXTVAL, 'RCV_GEST_LOTE_PROPUESTA', 'INSERT EN MINIREC.RCV_GEST_LOTE_PROPUESTA', 'FIN', TO_CHAR(SYSTIMESTAMP, 'DD/MM/RR HH24:MI:SS'));


EXCEPTION
	
	WHEN OTHERS THEN
     
		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion: '||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
		DBMS_OUTPUT.put_line(SQLERRM);

	ROLLBACK;
	RAISE;          

END GEST_LOTE_PROPUESTA;
/

EXIT;
