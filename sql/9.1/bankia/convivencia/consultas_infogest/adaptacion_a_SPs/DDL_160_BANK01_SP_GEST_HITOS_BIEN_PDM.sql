--/*
--#########################################
--## AUTOR=David González
--## FECHA_CREACION=20151101
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=BKREC-1335
--## PRODUCTO=NO
--## 
--## Finalidad: 
--## INSTRUCCIONES:  
--## VERSIONES:
--##        	0.1 Versión inicial
--##		
--#########################################
--*/
 
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;

CREATE OR REPLACE PROCEDURE GEST_HITOS_BIEN_PDM AUTHID CURRENT_USER AS

BEGIN
/* v0.1 */

	INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOG VALUES (#ESQUEMA_MINIREC#.S_RCV_GEST_LOG.NEXTVAL, 'RCV_GEST_HITOS_BIEN_PDM', 'INSERT EN MINIREC.RCV_GEST_HITOS_BIEN_PDM', 'INICIO', TO_CHAR(SYSTIMESTAMP, 'DD/MM/RR HH24:MI:SS'));

	DBMS_OUTPUT.PUT_LINE('[INFO] La tabla MINIREC.RCV_GEST_HITOS_BIEN_PDM va a ser truncada.');

	#ESQUEMA_MINIREC#.OPERACION_DDL.DDL_TABLE('TRUNCATE','RCV_GEST_HITOS_BIEN_PDM');

COMMIT;

	DBMS_OUTPUT.PUT_LINE('[INFO] Tabla MINIREC.RCV_GEST_HITOS_BIEN_PDM truncada.');

	DBMS_OUTPUT.PUT_LINE('[INFO] Se van a insertar registros en MINIREC.RCV_GEST_HITOS_BIEN_PDM.');

INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_HITOS_BIEN_PDM
	SELECT DISTINCT 
		   GUI.ID_PROCEDI_RCV    		  	AS ID_PROCEDI_RCV
		 , GUI.ID_PROCEDI                 	AS ID_PROCEDI
		 , GUI.ID_BIEN_RCV                	AS ID_BIEN_RCV
		 , GUI.ID_BIEN                    	AS ID_BIEN
		 , AUX.COD_HITO_NAL               	AS HITO
		 , NULL                           	AS ID_TAR_RCV
		 , NULL                           	AS TAREA_RCV
		 , TO_DATE(TRUNC(MAX(TAR.TAR_FECHA_INI)),'DD/MM/YY') 		AS FECHA_INICIO
		 , TO_DATE(TRUNC(MAX(TAR.TAR_FECHA_FIN)),'DD/MM/YY') 		AS FECHA_FIN
		 , TO_DATE(TRUNC(MAX(TAR.TAR_FECHA_VENC_REAL)),'DD/MM/YY') 	AS FECHA_LIMITE
		 , CASE WHEN MIN(nvl(TAR.TAR_TAREA_FINALIZADA,0)) = 0
				 AND MIN(TAR.BORRADO) = 0 
				 THEN 'S' 
				 ELSE 'N' 
			END								AS ACTIVO 
	  FROM #ESQUEMA_MINIREC#.RCV_GEST_BIEN_PDM 		GUI
		 , #ESQUEMA#.PRC_PROCEDIMIENTOS 			PRC
		 , #ESQUEMA#.PRB_PRC_BIE 					PRB
		 , #ESQUEMA#.TAR_TAREAS_NOTIFICACIONES 		TAR
		 , #ESQUEMA#.TEX_TAREA_EXTERNA 				TEX
		 , #ESQUEMA#.TAP_TAREA_PROCEDIMIENTO 		TAP
		 , #ESQUEMA#.DD_TPO_TIPO_PROCEDIMIENTO 		TPO
		 , #ESQUEMA#.AUX_THR_TRADUC_HITOS_RECNAL 	AUX
	 WHERE GUI.ID_ASUNTO_RCV = PRC.ASU_ID
		 AND   GUI.ID_BIEN_RCV = PRB.BIE_ID
		 AND   PRC.PRC_ID = PRB.PRC_ID
		 AND   PRC.DD_TPO_ID = TPO.DD_TPO_ID 
		 AND   TPO.DD_TPO_CODIGO  IN ('P401','P409','P413','P416','P417','P418','P419','P09')
		 AND   TPO.DD_TPO_ID = TAP.DD_TPO_ID 
		 AND   TPO.DD_TPO_CODIGO = AUX.DD_TPO_CODIGO
		 AND   TAP.TAP_CODIGO = AUX.TAP_CODIGO
		 AND   PRC.PRC_ID = TAR.PRC_ID
		 AND   TAR.TAR_ID = TEX.TAR_ID 
		 AND   TEX.TAP_ID = TAP.TAP_ID
	 GROUP BY 
		   GUI.ID_PROCEDI_RCV
		 , GUI.ID_PROCEDI
		 , GUI.ID_BIEN_RCV
		 , GUI.ID_BIEN
		 , AUX.COD_HITO_NAL;
	 
COMMIT;

INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOG VALUES (#ESQUEMA_MINIREC#.S_RCV_GEST_LOG.NEXTVAL, 'RCV_GEST_HITOS_BIEN_PDM', 'INSERT EN MINIREC.RCV_GEST_HITOS_BIEN_PDM', 'FIN', TO_CHAR(SYSTIMESTAMP, 'DD/MM/RR HH24:MI:SS'));

INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOG VALUES (#ESQUEMA_MINIREC#.S_RCV_GEST_LOG.NEXTVAL, 'RCV_GEST_HITOS_BIEN_PDM', 'UPDATE EN MINIREC.RCV_GEST_HITOS_BIEN_PDM.FECHA_INICIO', 'INICIO', TO_CHAR(SYSTIMESTAMP, 'DD/MM/RR HH24:MI:SS'));
 
UPDATE #ESQUEMA_MINIREC#.RCV_GEST_HITOS_BIEN_PDM 
	SET FECHA_INICIO = NULL WHERE FECHA_INICIO IN (TO_DATE('09/04/15','DD/MM/YY'),TO_DATE('07/03/15','DD/MM/YY'));

COMMIT;

INSERT INTO #ESQUEMA_MINIREC#.RCV_GEST_LOG VALUES (#ESQUEMA_MINIREC#.S_RCV_GEST_LOG.NEXTVAL, 'RCV_GEST_HITOS_BIEN_PDM', 'UPDATE EN MINIREC.RCV_GEST_HITOS_BIEN_PDM.FECHA_INICIO', 'FIN', TO_CHAR(SYSTIMESTAMP, 'DD/MM/RR HH24:MI:SS'));


	DBMS_OUTPUT.PUT_LINE('[INFO] Registros insertados en MINIREC.RCV_GEST_HITOS_BIEN_PDM.');

	DBMS_OUTPUT.PUT_LINE('[FIN]: Script ejecutado correctamente');
	
	


EXCEPTION
	
	WHEN OTHERS THEN
     
		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion: '||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
		DBMS_OUTPUT.put_line(SQLERRM);

	ROLLBACK;
	RAISE;          

END GEST_HITOS_BIEN_PDM;
/

EXIT;
