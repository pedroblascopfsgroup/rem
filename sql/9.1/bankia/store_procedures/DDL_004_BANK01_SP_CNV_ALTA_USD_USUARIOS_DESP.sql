--/*
--##########################################
--## AUTOR=David Gonz치lez
--## FECHA_CREACION=20151020
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.2
--## INCIDENCIA_LINK=BKREC-1114
--## PRODUCTO=NO
--## 
--## Finalidad: 
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versi칩n inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
create or replace PROCEDURE CNV_ALTA_USD_USUARIOS_DESP AS
  /*
   * CONSTANTES
   */
   C_USUCNV VARCHAR2(10 CHAR);

   /*
    * VARIABLES
    */
    V_FECHA_RECH TIMESTAMP;
    
BEGIN
/* v0.2 */

  /*
   * CONSTANTES
   */
   C_USUCNV := 'CONVIVE_F2';

   /*
    * Gesti칩n de rechazos
    */
  SELECT SYSDATE INTO V_FECHA_RECH FROM DUAL;

  INSERT INTO CNV_AUX_DESPACHOS_ACT_RECHAZOS
  WITH CNV_OK AS (
    SELECT *
    FROM #ESQUEMA#.CNV_AUX_DESPACHOS_ACT
    WHERE CD_DESPACHO IN (SELECT DES_CODIGO FROM #ESQUEMA#.DES_DESPACHO_EXTERNO WHERE BORRADO = 0 AND CD_DESPACHO IS NOT NULL)
      AND CD_ACTOR  IN (SELECT USU_USERNAME FROM #ESQUEMA_MASTER#.USU_USUARIOS WHERE BORRADO = 0)
  )
  SELECT V_FECHA_RECH, D.*
  FROM #ESQUEMA#.CNV_AUX_DESPACHOS_ACT D
    WHERE NOT EXISTS (SELECT 1 FROM #ESQUEMA#.CNV_OK WHERE CD_DESPACHO = D.CD_DESPACHO AND CD_ACTOR = D.CD_ACTOR);


  /*
   * Alta registros en USD_USUARIOS_DESPACHOS
   */
  INSERT INTO #ESQUEMA#.USD_USUARIOS_DESPACHOS(USD_ID, USU_ID, DES_ID, USD_GESTOR_DEFECTO, USD_SUPERVISOR
    , VERSION, BORRADO, FECHACREAR, USUARIOCREAR)
  WITH DES_USU AS (
    SELECT DES_ID, COUNT(1) N_USU FROM #ESQUEMA#.USD_USUARIOS_DESPACHOS WHERE BORRADO = 0 GROUP BY DES_ID
  )
  SELECT #ESQUEMA#.S_USD_USUARIOS_DESPACHOS.NEXTVAL, USU.USU_ID, DES.DES_ID
    , CASE
      WHEN (DES_USU.N_USU IS NULL) OR (DES_USU.N_USU = 0) THEN 1
      ELSE 0
      END USD_GESTOR_DEFECTO
    , 0 USD_SUPERVISOR
    , 0, 0, SYSDATE, C_USUCNV
  FROM #ESQUEMA#.CNV_AUX_DESPACHOS_ACT CNV
    JOIN #ESQUEMA_MASTER#.USU_USUARIOS USU ON CNV.CD_ACTOR = USU.USU_USERNAME
    JOIN #ESQUEMA#.DES_DESPACHO_EXTERNO DES ON CNV.CD_DESPACHO = DES.DES_CODIGO
    LEFT JOIN #ESQUEMA#.DES_USU ON DES.DES_ID = DES_USU.DES_ID
    WHERE NOT EXISTS (
      SELECT 1 FROM #ESQUEMA#.CNV_AUX_DESPACHOS_ACT_RECHAZOS WHERE CD_DESPACHO = CNV.CD_DESPACHO AND CD_ACTOR = CNV.CD_ACTOR AND FECHA_RECH = V_FECHA_RECH
    )
    AND NOT EXISTS (
      SELECT 1 FROM #ESQUEMA#.USD_USUARIOS_DESPACHOS WHERE USU_ID = USU.USU_ID AND DES_ID = DES.DES_ID
    );

  COMMIT;
  
EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecuci칩n:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
  
  
END CNV_ALTA_USD_USUARIOS_DESP;
/

EXIT;
