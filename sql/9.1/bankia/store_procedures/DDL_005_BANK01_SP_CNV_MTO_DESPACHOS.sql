--/*
--##########################################
--## AUTOR=David González
--## FECHA_CREACION=20151027
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.3
--## INCIDENCIA_LINK=BKREC-1114
--## PRODUCTO=NO
--## 
--## Finalidad: 
--## INSTRUCCIONES:  
--## VERSIONES:
--##        	0.1 Versión inicial
--##		0.2 Adaptacion a plantilla
--##		
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
create or replace PROCEDURE CNV_MTO_DESPACHOS AS
/*

    CONSTANTES
    */
    C_USUCNV VARCHAR2(10 CHAR);

/*

    VARIABLES
    */
    V_FECHA_RECH TIMESTAMP;
    
    
BEGIN
/* v0.3 */
    
    
    /*
    CONSTANTES
    */
    C_USUCNV := 'CONVIVE_F2';

/*

    GestiÃ³n de rechazos
    */
    SELECT SYSDATE INTO V_FECHA_RECH FROM DUAL;

INSERT INTO #ESQUEMA#.CNV_AUX_DESPACHOS_RECHAZOS
SELECT SYSDATE, D.*
FROM #ESQUEMA#.CNV_AUX_DESPACHOS D
WHERE CD_DESPACHO IS NULL
OR NOMBRE_DESPACHO IS NULL
OR TIPO_DESPACHO IS NULL;

/*

    Mantenimiento de los despachos no rechazados
    */
    MERGE INTO #ESQUEMA#.DES_DESPACHO_EXTERNO DES
    USING (
    SELECT CNV.CD_DESPACHO, CNV.NOMBRE_DESPACHO, TDE.DD_TDE_ID, CNV.DOMICILIO, CNV.LOCALIDAD, CNV.CODIGO_POSTAL
    , CNV.PERSONA_CONTACTO, CNV.TELEFONO_CONTACTO_1, CNV.TELEFONO_CONTACTO_2,
    (case cnv.situacion
    when 2 then 1
    else 0
    end ) as borrado
    FROM #ESQUEMA#.CNV_AUX_DESPACHOS CNV
    LEFT JOIN #ESQUEMA_MASTER#.DD_TDE_TIPO_DESPACHO TDE ON TO_CHAR(CNV.TIPO_DESPACHO) = TDE.DD_TDE_CODIGO
    WHERE CD_DESPACHO IS NOT NULL AND CD_DESPACHO NOT IN (
    SELECT CD_DESPACHO FROM #ESQUEMA#.CNV_AUX_DESPACHOS_RECHAZOS WHERE FECHA_RECH = V_FECHA_RECH
    )
    ) CNV
    ON (DES.DES_CODIGO = CNV.CD_DESPACHO)
    WHEN MATCHED THEN UPDATE SET
    DES.DES_DESPACHO = CNV.NOMBRE_DESPACHO
    , DES.DES_DOMICILIO = CNV.DOMICILIO
    , DES.DES_DOMICILIO_PLAZA = CNV.LOCALIDAD
    , DES.DES_CODIGO_POSTAL = CNV.CODIGO_POSTAL
    , DES.DES_PERSONA_CONTACTO = CNV.PERSONA_CONTACTO
    , DES.DES_TELEFONO1 = CNV.TELEFONO_CONTACTO_1
    , DES.DES_TELEFONO2 = CNV.TELEFONO_CONTACTO_2
    , DES.USUARIOMODIFICAR = C_USUCNV
    , DES.FECHAMODIFICAR = SYSDATE
    , DES.BORRADO = CNV.BORRADO
    WHEN NOT MATCHED THEN INSERT (DES_ID, DES_CODIGO, DES_DESPACHO, DD_TDE_ID, DES_DOMICILIO, DES_DOMICILIO_PLAZA, DES_CODIGO_POSTAL
    , DES_PERSONA_CONTACTO, DES_TELEFONO1, DES_TELEFONO2
    , ZON_ID
    , VERSION, USUARIOCREAR, FECHACREAR, BORRADO)
    VALUES (
    #ESQUEMA#.S_DES_DESPACHO_EXTERNO.NEXTVAL, CNV.CD_DESPACHO, CNV.NOMBRE_DESPACHO, CNV.DD_TDE_ID, CNV.DOMICILIO, CNV.LOCALIDAD, CNV.CODIGO_POSTAL
    , CNV.PERSONA_CONTACTO, CNV.TELEFONO_CONTACTO_1, CNV.TELEFONO_CONTACTO_2
    , (SELECT ZON_ID FROM #ESQUEMA#.ZON_ZONIFICACION WHERE ZON_NUM_CENTRO = '00000000100')
    , 0, C_USUCNV, SYSDATE, 0
    );

COMMIT;

EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;


END CNV_MTO_DESPACHOS;
/

EXIT;

