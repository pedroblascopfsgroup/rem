
--[ FINALIZACION DE PROCEDIMIENTOS POR VENTA DE CARTERA]

----## BUSCAR TODAS LAS TAREAS VINCULADAS AL PRC_ID Y FINALIZARLAS ##
-- FINALIZAMOS TAREAS (TAR_TAREAS_NOTIFICACIONES) QUE CONTENGAN EL PRC_ID QUE TENEMOS EN PROCEDIMIENTOS_A_CERRAR (FIN_AUX_PRC_CERRAR_FINAL)

  UPDATE BANK01.TAR_TAREAS_NOTIFICACIONES TAR SET
  TAR.USUARIOMODIFICAR = 'BKREC-1494',
  TAR.FECHAMODIFICAR = SYSDATE,
  TAR.TAR_TAREA_FINALIZADA = 1,
  TAR.TAR_FECHA_FIN = SYSDATE
  WHERE TAR.TAR_ID IN (
    SELECT DISTINCT TAR.TAR_ID 
    FROM BANK01.TAR_TAREAS_NOTIFICACIONES TAR 
      INNER JOIN BANK01.FIN_AUX_PRC_CERRAR_FINAL CER 
        ON TAR.PRC_ID = CER.PRC_ID
        AND TAR.TAR_TAREA_FINALIZADA != 1
        AND TAR.BORRADO = 0
  )
  ;
  
-- BORRAMOS TAREAS EXTERNAS (TEX_TAREAS_EXTERNAS) QUE CONTENGAN EL PRC_ID QUE TENEMOS EN PROCEDIMIENTOS_A_CERRAR (FIN_AUX_PRC_CERRAR_FINAL)
  
  UPDATE BANK01.TEX_TAREA_EXTERNA TEX SET
  TEX.USUARIOMODIFICAR = 'BKREC-1494',
  TEX.FECHAMODIFICAR = SYSDATE,
  TEX.USUARIOBORRAR = 'BKREC-1494',
  TEX.FECHABORRAR = SYSDATE,
  TEX.BORRADO = 1
  WHERE TEX.TAR_ID IN (
    SELECT DISTINCT TAR.TAR_ID 
    FROM BANK01.TAR_TAREAS_NOTIFICACIONES TAR 
      INNER JOIN BANK01.FIN_AUX_PRC_CERRAR_FINAL CER 
        ON TAR.PRC_ID = CER.PRC_ID
        AND TAR.TAR_TAREA_FINALIZADA != 1
  )
  AND TEX.BORRADO = 0
  ;

----## BUSCAR EL PRC_ID Y FINALIZARLO: PONER MOTIVO "VENTA DE CARTERA" * A FALTA DE METER TEXTO_VENTA ##
-- FINALIZAMOS (CERRAMOS) PROCEDIMIENTOS QUE CONTENGAN EL PRC_ID QUE TENEMOS EN PROCEDIMIENTOS_A_CERRAR (FIN_AUX_PRC_CERRAR_FINAL)

  UPDATE BANK01.PRC_PROCEDIMIENTOS PRC SET
  PRC.USUARIOMODIFICAR = 'BKREC-1494',
  PRC.FECHAMODIFICAR = SYSDATE,
  PRC.DD_EPR_ID = (SELECT DD_EPR_ID FROM BANKMASTER.DD_EPR_ESTADO_PROCEDIMIENTO WHERE DD_EPR_DESCRIPCION = 'Cerrado')
  WHERE PRC.PRC_ID IN (
    SELECT DISTINCT PRC.PRC_ID 
    FROM BANK01.PRC_PROCEDIMIENTOS PRC 
      INNER JOIN BANK01.FIN_AUX_PRC_CERRAR_FINAL CER 
        ON PRC.PRC_ID = CER.PRC_ID
        AND PRC.BORRADO = 0
        AND PRC.DD_EPR_ID != (SELECT DD_EPR_ID FROM BANKMASTER.DD_EPR_ESTADO_PROCEDIMIENTO WHERE DD_EPR_DESCRIPCION = 'Cerrado')
  )
  ;
  
-- INDICAMOS LA DECISION FINALIZAR EN DECISIONES PROCEDIMIENTOS QUE CONTENGAN EL PRC_ID QUE TENEMOS EN PROCEDIMIENTOS_A_CERRAR (FIN_AUX_PRC_CERRAR_FINAL)
  
  UPDATE BANK01.DPR_DECISIONES_PROCEDIMIENTOS DPR SET
  DPR.USUARIOMODIFICAR = 'BKREC-1494',
  DPR.FECHAMODIFICAR = SYSDATE,
  DPR.DD_DFI_ID = (SELECT DFI.DD_DFI_ID FROM BANK01.DD_DFI_DECISION_FINALIZAR DFI WHERE DFI.DD_DFI_DESCRIPCION = 'Venta de cartera')
  WHERE DPR.PRC_ID IN (
  SELECT PRC.PRC_ID 
  FROM BANK01.DPR_DECISIONES_PROCEDIMIENTOS DPR 
    INNER JOIN BANK01.FIN_AUX_PRC_CERRAR_FINAL PRC 
      ON DPR.PRC_ID = PRC.PRC_ID 
      AND DPR.DD_DFI_ID != (SELECT DFI.DD_DFI_ID FROM BANK01.DD_DFI_DECISION_FINALIZAR DFI WHERE DFI.DD_DFI_DESCRIPCION = 'Venta de cartera')
      AND DPR.BORRADO = 0
)
;

----## BUSCAR EL ASU_ID Y FINALIZARLO ## 
-- FINALIZAMOS (CERRAMOS) ASUNTOS QUE CONTENGAN EL ASU_ID QUE TENEMOS EN PROCEDIMIENTOS_A_CERRAR (FIN_AUX_PRC_CERRAR_FINAL)

  UPDATE BANK01.ASU_ASUNTOS ASU SET
  ASU.USUARIOMODIFICAR = 'BKREC-1494',
  ASU.FECHAMODIFICAR = SYSDATE,
  ASU.DD_EAS_ID = (SELECT DD_EAS_ID FROM BANKMASTER.DD_EAS_ESTADO_ASUNTOS WHERE DD_EAS_DESCRIPCION = 'Cerrado')
  WHERE ASU.ASU_ID IN (
    SELECT DISTINCT ASU.ASU_ID 
    FROM BANK01.ASU_ASUNTOS ASU
      INNER JOIN BANK01.FIN_AUX_PRC_CERRAR_FINAL CER
        ON ASU.ASU_ID = CER.ASU_ID
        AND ASU.DD_EAS_ID != (SELECT DD_EAS_ID FROM BANKMASTER.DD_EAS_ESTADO_ASUNTOS WHERE DD_EAS_DESCRIPCION = 'Cerrado')
        AND ASU.BORRADO = 0
  )
  ;
