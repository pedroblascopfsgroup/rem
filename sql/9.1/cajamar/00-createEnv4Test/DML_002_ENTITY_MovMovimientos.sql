WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

BEGIN

EXECUTE IMMEDIATE 'ANALYZE TABLE CM01.MOV_MOVIMIENTOS  COMPUTE STATISTICS';
COMMIT;

UPDATE CM01.MOV_MOVIMIENTOS SET
  MOV_POS_VIVA_VENCIDA = ABS(MOV_POS_VIVA_VENCIDA)
  ,MOV_SALDO_DUDOSO = ABS(MOV_SALDO_DUDOSO)
  ,MOV_INT_REMUNERATORIOS = ABS(MOV_INT_REMUNERATORIOS)
  ,MOV_RIESGO = ABS(MOV_RIESGO)
  ,MOV_DEUDA_IRREGULAR = ABS(MOV_DEUDA_IRREGULAR)
  ,MOV_FECHA_POS_VENCIDA = CASE WHEN MOV_DEUDA_IRREGULAR != 0 THEN (MOV_CNT_FECHA_INI_EPI_IRREG + 25) ELSE MOV_FECHA_POS_VENCIDA END;
COMMIT;


EXCEPTION
  WHEN OTHERS THEN
    ERR_NUM := SQLCODE;
    ERR_MSG := SQLERRM;
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecuci√≥n:'||TO_CHAR(ERR_NUM));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(ERR_MSG);
    ROLLBACK;
    RAISE;   
END;
/
EXIT;
