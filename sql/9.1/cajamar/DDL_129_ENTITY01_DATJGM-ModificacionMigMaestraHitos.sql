--/*
--##########################################
--## AUTOR=JUAN GALLEGO MOLERO
--## FECHA_CREACION=20150930
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=CMREC-911
--## PRODUCTO=NO
--## 
--## Finalidad: Modificacion columna MIG_MAESTRA_HITOS
--## INSTRUCCIONES:  Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versi√≥n inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;


DECLARE

 V_ESQUEMA VARCHAR2(25 CHAR):=   '#ESQUEMA#'; 			-- Configuracion Esquema
 V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; 		-- Configuracion Esquema Master
 TABLA VARCHAR(30) :='MIG_MAESTRA_HITOS';
 err_num NUMBER;
 err_msg VARCHAR2(2048 CHAR); 
 V_MSQL VARCHAR2(8500 CHAR);
 V_LENGTH_HITO_ACTUAL NUMBER(5);
 V_LENGTH_ULTIMO_HITO NUMBER(5);


BEGIN 

  V_LENGTH_ULTIMO_HITO:=0;
  V_LENGTH_HITO_ACTUAL:=0;

  BEGIN 
	  -- MIRA DE CUANTOS CARACTERES ES LA COLUMNA
	  select  DATA_PRECISION INTO V_LENGTH_HITO_ACTUAL
	  from ALL_TAB_COLUMNS
	  WHERE TABLE_NAME = 'MIG_MAESTRA_HITOS'
		  AND COLUMN_NAME = 'COD_HITO_ACTUAL';
  
	  DBMS_OUTPUT.PUT_LINE('LA COLUMNA COD_HITO_ACTUAL ES UN NUMBER DE '||V_LENGTH_HITO_ACTUAL);
  
	  -- CAMBIA A CARACTER CORRECTO COD_HITO_ACTUAL
	   IF V_LENGTH_HITO_ACTUAL <=2 then
		   DBMS_OUTPUT.put_line('COD_HITO_ACTUAL YA ES NUMBER IGUAL O MAYOR DE 2');
	   ELSE
		   V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||TABLA||' MODIFY COD_HITO_ACTUAL NUMBER(5)';
		   EXECUTE IMMEDIATE V_MSQL;
		   DBMS_OUTPUT.put_line('COD_HITO_ACTUAL MODIFICADO A NUMBER DE 5');
	   END IF;
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||TABLA||' ADD COD_HITO_ACTUAL NUMBER(5) NOT NULL';
      EXECUTE IMMEDIATE V_MSQL;
  END;
       
 BEGIN
  Select  DATA_PRECISION INTO V_LENGTH_ULTIMO_HITO 
  from ALL_TAB_COLUMNS
  WHERE TABLE_NAME = 'MIG_MAESTRA_HITOS'
	  AND COLUMN_NAME ='ULTIMO_HITO';
  
  DBMS_OUTPUT.PUT_LINE('LA COLUMNA ULTIMO_HITO ES UN NUMBER DE '||V_LENGTH_ULTIMO_HITO);     

   -- FINALIZA COD_HITO_ACTUAL
  
   -- CAMBIA A CARACTER ULTIMO_HITO
   IF V_LENGTH_ULTIMO_HITO >=2 then
	   DBMS_OUTPUT.put_line('ULTIMO_HITO YA ES NUMBER IGUAL O MAYOR DE 2');
   ELSE
	   V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||TABLA||' MODIFY ULTIMO_HITO NUMBER(5)';
	   EXECUTE IMMEDIATE V_MSQL;
	   DBMS_OUTPUT.put_line('ULTIMO_HITO MODIFICADO A NUMBER DE 5');
   END IF;
      
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||TABLA||' ADD ULTIMO_HITO NUMBER(5) NOT NULL';
      EXECUTE IMMEDIATE V_MSQL;
  END;    
--FIN ULTIMO HITO

--Excepciones

EXCEPTION
WHEN OTHERS THEN  
  err_num := SQLCODE;
  err_msg := SQLERRM;

  DBMS_OUTPUT.put_line('Error:'||TO_CHAR(err_num));
  DBMS_OUTPUT.put_line(err_msg);
  
  ROLLBACK;
  RAISE;
END;
/
EXIT;
