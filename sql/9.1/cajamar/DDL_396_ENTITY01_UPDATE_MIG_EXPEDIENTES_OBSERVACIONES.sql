--/*
--##########################################
--## AUTOR=Lorenzo Lerate
--## FECHA_CREACION=20160406
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=CMREC-2926
--## PRODUCTO=NO
--## 
--## Finalidad: Alter tabla MIG_EXPEDIENTES_OBSERVACIONES columna USU_OBSERVACION a VARCHAR2(250 CHAR)
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 VersiÃ³n inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;

DECLARE

 V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; 			-- Configuracion Esquema
 V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; 		-- Configuracion Esquema Master
 TABLA VARCHAR(30) :='MIG_EXPEDIENTES_OBSERVACIONES';
 ITABLE_SPACE VARCHAR(25) :='#TABLESPACE_INDEX#';
 err_num NUMBER;
 err_msg VARCHAR2(2048 CHAR); 
 V_MSQL VARCHAR2(8500 CHAR);
 V_EXISTE NUMBER (1);


BEGIN 

--Validamos si la tabla existe antes de crearla

  SELECT COUNT(*) INTO V_EXISTE
    FROM ALL_TABLES
  WHERE TABLE_NAME = TABLA;

  
  V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.'||TABLA||'';
              
  IF V_EXISTE = 1 THEN   
     EXECUTE IMMEDIATE V_MSQL;
     DBMS_OUTPUT.PUT_LINE(TABLA||' BORRADA');
  ELSE   
     DBMS_OUTPUT.PUT_LINE(TABLA||' NO EXISTE -> NO BORRADA');
  END IF;   
  
  
   V_MSQL := 'CREATE TABLE '||V_ESQUEMA||'.'||TABLA||
   '(	"MIG_EXP_OBS_ID" NUMBER(16,0), 
	"CD_OBSERVACION" NUMBER(16,0), 
	"CD_EXPEDIENTE" NUMBER(16,0), 
	"CODIGO_TIPO" VARCHAR2(10 BYTE), 
	"FECHA_OBSERVACION" DATE, 
	"USU_OBSERVACION" VARCHAR2(150 CHAR)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "DRECOVERYONL8M"';
              
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE(TABLA||' CREADA');

--Fin crear tabla

	V_MSQL := 'CREATE UNIQUE INDEX '||V_ESQUEMA||'."PK_MIG_EXP_OBS_ID" ON '||V_ESQUEMA||'.'||TABLA||
   ' ("MIG_EXP_OBS_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "IRECOVERYONL8M"';
  
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('CREADO INDICE PARA '||TABLA);
	
	V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||TABLA||' ADD CONSTRAINT "PK_MIG_EXP_OBS_ID" PRIMARY KEY ("MIG_EXP_OBS_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "IRECOVERYONL8M"  ENABLE';
  
  EXECUTE IMMEDIATE V_MSQL;

  EXECUTE IMMEDIATE ('ALTER TABLE '||V_ESQUEMA||'.'||TABLA||' MODIFY ("CD_EXPEDIENTE" NOT NULL ENABLE)');
  EXECUTE IMMEDIATE ('ALTER TABLE '||V_ESQUEMA||'.'||TABLA||' MODIFY ("CD_OBSERVACION" NOT NULL ENABLE)');
  EXECUTE IMMEDIATE ('ALTER TABLE '||V_ESQUEMA||'.'||TABLA||' MODIFY ("MIG_EXP_OBS_ID" NOT NULL ENABLE)');
  
  DBMS_OUTPUT.PUT_LINE('MODIFICACIONES EN '||TABLA);
--Excepciones
          
EXCEPTION
WHEN OTHERS THEN  
  err_num := SQLCODE;
  err_msg := SQLERRM;

  DBMS_OUTPUT.put_line('Error:'||TO_CHAR(err_num));
  DBMS_OUTPUT.put_line(err_msg);
  
  ROLLBACK;
  RAISE;
END;
/
EXIT
