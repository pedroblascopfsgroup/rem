--/*
--##########################################
--## AUTOR=JOSE MANUEL PEREZ BARBERÁ
--## FECHA_CREACION=20160126
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=CMREC-1589
--## PRODUCTO=NO
--## 
--## Finalidad: Limpieza de fechas incorrectas '30/11/03 00:00:00,000000000' en Bienes
--##                               , esquema CM01.
--## INSTRUCCIONES:  Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##		0.2 Ampliación a todas las fechas relacionadas con Bienes incorrectas.
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;


DECLARE

 V_ESQUEMA VARCHAR2(25 CHAR):=   '#ESQUEMA#'; 			-- Configuracion Esquema
 V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; 		-- Configuracion Esquema Master
 TABLA VARCHAR(30 CHAR) :='BIE_VALORACIONES';
 TABLA2 VARCHAR(30 CHAR) :='BIE_DATOS_REGISTRALES';
 TABLA3 VARCHAR(30 CHAR) :='BIE_ADICIONAL';
 TABLA4 VARCHAR(30 CHAR) :='BIE_BIEN_ENTIDAD';
 TABLA5 VARCHAR(30 CHAR) :='BIE_CNT';
 err_num NUMBER;
 err_msg VARCHAR2(2048 CHAR); 
 V_MSQL VARCHAR2(8500 CHAR);
 S_MSQL VARCHAR2(8500 CHAR);
 V_EXISTE NUMBER (1);

BEGIN 
  
  --BIE_VALORACIONES.BIE_FECHA_VALOR_SUBJETIVO Y BIE_VALORACIONES.BIE_FECHA_VALOR_APRECIACION
  V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||TABLA||' 
			SET BIE_FECHA_VALOR_SUBJETIVO = NULL
			WHERE USUARIOCREAR = ''APROV_BIEN'' AND (USUARIOMODIFICAR = ''APROV_BIEN'' OR USUARIOMODIFICAR IS NULL)
			AND BIE_FECHA_VALOR_SUBJETIVO IS NOT NULL 
			AND LENGTH(EXTRACT(YEAR FROM BIE_FECHA_VALOR_SUBJETIVO)) = 1';
  
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] Campos BIE_VALORACIONES.BIE_FECHA_VALOR_SUBJETIVO actualizados a null.');
  
  --BIE_VALORACIONES.BIE_FECHA_VALOR_SUBJETIVO Y BIE_VALORACIONES.BIE_FECHA_VALOR_APRECIACION
  V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||TABLA||' 
			SET BIE_FECHA_VALOR_APRECIACION = NULL
			WHERE USUARIOCREAR = ''APROV_BIEN'' AND (USUARIOMODIFICAR = ''APROV_BIEN'' OR USUARIOMODIFICAR IS NULL)
			AND BIE_FECHA_VALOR_APRECIACION IS NOT NULL
			AND LENGTH(EXTRACT(YEAR FROM BIE_FECHA_VALOR_APRECIACION)) = 1';
  
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] Campos BIE_VALORACIONES.BIE_FECHA_VALOR_APRECIACION actualizados a null.');
  
  --BIE_VALORACIONES.BIE_FECHA_VALOR_TASACION
  V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||TABLA||' 
			SET BIE_FECHA_VALOR_TASACION = NULL
			WHERE USUARIOCREAR = ''APROV_BIEN'' AND (USUARIOMODIFICAR = ''APROV_BIEN'' OR USUARIOMODIFICAR IS NULL)
			AND BIE_FECHA_VALOR_TASACION IS NOT NULL
			AND LENGTH(EXTRACT(YEAR FROM BIE_FECHA_VALOR_TASACION)) = 1';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] Campos BIE_VALORACIONES.BIE_FECHA_VALOR_TASACION actualizados a null.');
  
  --BIE_DATOS_REGISTRALES.BIE_DREG_FECHA_INSCRIPCION
  V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||TABLA2||' 
			SET BIE_DREG_FECHA_INSCRIPCION = NULL
			WHERE USUARIOCREAR = ''APROV_BIEN'' AND (USUARIOMODIFICAR = ''APROV_BIEN'' OR USUARIOMODIFICAR IS NULL)
			AND BIE_DREG_FECHA_INSCRIPCION IS NOT NULL
			AND LENGTH(EXTRACT(YEAR FROM BIE_DREG_FECHA_INSCRIPCION)) = 1';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] Campos BIE_DATOS_REGISTRALES.BIE_DREG_FECHA_INSCRIPCION actualizados a null.');
  
  --BIE_ADICIONAL.BIE_ADI_FECHAMATRICULA
  V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||TABLA3||' 
			SET BIE_ADI_FECHAMATRICULA = NULL
			WHERE USUARIOCREAR = ''APROV_BIEN'' AND (USUARIOMODIFICAR = ''APROV_BIEN'' OR USUARIOMODIFICAR IS NULL)
			AND BIE_ADI_FECHAMATRICULA IS NOT NULL
			AND LENGTH(EXTRACT(YEAR FROM BIE_ADI_FECHAMATRICULA)) = 1';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] Campos BIE_ADICIONAL.BIE_ADI_FECHAMATRICULA actualizados a null.');	
  	
  --BIE_BIEN_ENTIDAD.BIE_DREG_FECHA_INSCRIPCION
  V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||TABLA4||' 
			SET BIE_DREG_FECHA_INSCRIPCION = NULL
			WHERE USUARIOCREAR = ''APROV_BIEN'' AND (USUARIOMODIFICAR = ''APROV_BIEN'' OR USUARIOMODIFICAR IS NULL)
			AND BIE_DREG_FECHA_INSCRIPCION IS NOT NULL
			AND LENGTH(EXTRACT(YEAR FROM BIE_DREG_FECHA_INSCRIPCION)) = 1';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] Campos BIE_BIEN_ENTIDAD.BIE_DREG_FECHA_INSCRIPCION actualizados a null.');	
  
  --BIE_BIEN_ENTIDAD.BIE_FECHA_VALOR_SUBJETIVO
  V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||TABLA4||' 
			SET BIE_FECHA_VALOR_SUBJETIVO = NULL
			WHERE USUARIOCREAR = ''APROV_BIEN'' AND (USUARIOMODIFICAR = ''APROV_BIEN'' OR USUARIOMODIFICAR IS NULL)
			AND BIE_FECHA_VALOR_SUBJETIVO IS NOT NULL
			AND LENGTH(EXTRACT(YEAR FROM BIE_FECHA_VALOR_SUBJETIVO)) = 1';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] Campos BIE_BIEN_ENTIDAD.BIE_FECHA_VALOR_SUBJETIVO actualizados a null.');	
  
  --BIE_BIEN_ENTIDAD.BIE_FECHA_VALOR_APRECIACION
  V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||TABLA4||' 
			SET BIE_FECHA_VALOR_APRECIACION = NULL
			WHERE USUARIOCREAR = ''APROV_BIEN'' AND (USUARIOMODIFICAR = ''APROV_BIEN'' OR USUARIOMODIFICAR IS NULL)
			AND BIE_FECHA_VALOR_APRECIACION IS NOT NULL
			AND LENGTH(EXTRACT(YEAR FROM BIE_FECHA_VALOR_APRECIACION)) = 1';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] Campos BIE_BIEN_ENTIDAD.BIE_FECHA_VALOR_APRECIACION actualizados a null.');	
  
  --BIE_BIEN_ENTIDAD.BIE_FECHA_VALOR_TASACION
  V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||TABLA4||' 
			SET BIE_FECHA_VALOR_TASACION = NULL
			WHERE USUARIOCREAR = ''APROV_BIEN'' AND (USUARIOMODIFICAR = ''APROV_BIEN'' OR USUARIOMODIFICAR IS NULL)
			AND BIE_FECHA_VALOR_TASACION IS NOT NULL
			AND LENGTH(EXTRACT(YEAR FROM BIE_FECHA_VALOR_TASACION)) = 1';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] Campos BIE_BIEN_ENTIDAD.BIE_FECHA_VALOR_TASACION actualizados a null.');	
  
  --BIE_BIEN_ENTIDAD.BIE_ADI_FECHAMATRICULA
  V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||TABLA4||' 
			SET BIE_ADI_FECHAMATRICULA = NULL
			WHERE USUARIOCREAR = ''APROV_BIEN'' AND (USUARIOMODIFICAR = ''APROV_BIEN'' OR USUARIOMODIFICAR IS NULL)
			AND BIE_ADI_FECHAMATRICULA IS NOT NULL
			AND LENGTH(EXTRACT(YEAR FROM BIE_ADI_FECHAMATRICULA)) = 1';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] Campos BIE_BIEN_ENTIDAD.BIE_ADI_FECHAMATRICULA actualizados a null.');	
  
  --BIE_BIEN_ENTIDAD.BIE_FECHA_VERIFICACION
  V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||TABLA4||' 
			SET BIE_FECHA_VERIFICACION = NULL
			WHERE USUARIOCREAR = ''APROV_BIEN'' AND (USUARIOMODIFICAR = ''APROV_BIEN'' OR USUARIOMODIFICAR IS NULL)
			AND BIE_FECHA_VERIFICACION IS NOT NULL
			AND LENGTH(EXTRACT(YEAR FROM BIE_FECHA_VERIFICACION)) = 1';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] Campos BIE_BIEN_ENTIDAD.BIE_FECHA_VERIFICACION actualizados a null.');	
  
  --BIE_CNT.BIE_CNT_FECHA_INICIO
  V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||TABLA5||' 
			SET BIE_CNT_FECHA_INICIO = NULL
			WHERE (USUARIOCREAR = ''APROV_BCNT'' OR USUARIOCREAR = ''ETL_BIE'') AND (USUARIOMODIFICAR = ''UPP_ETL_BIE'' OR USUARIOMODIFICAR IS NULL)
			AND BIE_CNT_FECHA_INICIO IS NOT NULL
			AND LENGTH(EXTRACT(YEAR FROM BIE_CNT_FECHA_INICIO)) = 1';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] Campos BIE_CNT.BIE_CNT_FECHA_INICIO actualizados a null.');	
  
  --BIE_CNT.BIE_CNT_FECHA_CIERRE
  V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||TABLA5||' 
			SET BIE_CNT_FECHA_CIERRE = NULL
			WHERE (USUARIOCREAR = ''APROV_BCNT'' OR USUARIOCREAR = ''ETL_BIE'') AND (USUARIOMODIFICAR = ''UPP_ETL_BIE'' OR USUARIOMODIFICAR IS NULL)
			AND BIE_CNT_FECHA_CIERRE IS NOT NULL
			AND LENGTH(EXTRACT(YEAR FROM BIE_CNT_FECHA_CIERRE)) = 1';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] Campos BIE_CNT.BIE_CNT_FECHA_CIERRE actualizados a null.');	

EXCEPTION
WHEN OTHERS THEN  
  err_num := SQLCODE;
  err_msg := SQLERRM;

  DBMS_OUTPUT.put_line('Error:'||TO_CHAR(err_num));
  DBMS_OUTPUT.put_line(err_msg);
  
  ROLLBACK;
  RAISE;
END;
/
EXIT;   
