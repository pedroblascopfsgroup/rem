--/*
--##########################################
--## AUTOR=Daniel Albert Pérez
--## FECHA_CREACION=20160706
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2.7
--## INCIDENCIA_LINK=RECOVERY-257
--## PRODUCTO=NO
--## Finalidad: DML reparación asuntos CAJAMAR
--##           
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON

DECLARE

  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

BEGIN

	DELETE FROM
	  #ESQUEMA#.PRC_PER
	WHERE
	  (PRC_ID, PER_ID) IN
		(
		  SELECT DISTINCT
			PP.PRC_ID
			, PP.PER_ID
		  FROM
			#ESQUEMA#.ASU_ASUNTOS A
		  INNER JOIN
			#ESQUEMA#.PRC_PROCEDIMIENTOS P
			ON P.ASU_ID = A.ASU_ID
		  INNER JOIN
			#ESQUEMA#.PRC_PER PP
			ON P.PRC_ID = PP.PRC_ID
		  WHERE
			A.DD_EAS_ID = (SELECT DD_EAS_ID FROM #ESQUEMA_MASTER#.DD_EAS_ESTADO_ASUNTOS WHERE DD_EAS_CODIGO = '03')
			AND A.DD_TAS_ID = (SELECT DD_TAS_ID FROM #ESQUEMA_MASTER#.DD_TAS_TIPOS_ASUNTO WHERE DD_TAS_CODIGO = '01')
			AND A.USUARIOCREAR = 'ALTAASUNCM'
			AND A.BORRADO = 0
		  MINUS
		  SELECT DISTINCT
			P.PRC_ID
			, CP.PER_ID
		  FROM
			#ESQUEMA#.ASU_ASUNTOS A
		  INNER JOIN
			#ESQUEMA#.PRC_PROCEDIMIENTOS P
			ON P.ASU_ID = A.ASU_ID
		  INNER JOIN
			#ESQUEMA#.PRC_CEX PC
			ON PC.PRC_ID = P.PRC_ID
		  INNER JOIN
			#ESQUEMA#.CEX_CONTRATOS_EXPEDIENTE CX
			ON CX.CEX_ID = PC.CEX_ID
		  INNER JOIN
			#ESQUEMA#.CNT_CONTRATOS C
			ON C.CNT_ID = CX.CNT_ID
		  INNER JOIN
			#ESQUEMA#.CPE_CONTRATOS_PERSONAS CP
			ON CP.CNT_ID = C.CNT_ID
		  INNER JOIN
			#ESQUEMA#.DD_TIN_TIPO_INTERVENCION T
			ON T.DD_TIN_ID = CP.DD_TIN_ID AND T.DD_TIN_TITULAR = 1
		  WHERE
			A.DD_EAS_ID = (SELECT DD_EAS_ID FROM #ESQUEMA_MASTER#.DD_EAS_ESTADO_ASUNTOS WHERE DD_EAS_CODIGO = '03')
			AND A.DD_TAS_ID = (SELECT DD_TAS_ID FROM #ESQUEMA_MASTER#.DD_TAS_TIPOS_ASUNTO WHERE DD_TAS_CODIGO = '01')
			AND A.USUARIOCREAR = 'ALTAASUNCM'
			AND A.BORRADO = 0
		);

  COMMIT;

EXCEPTION
    WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
      DBMS_OUTPUT.put_line('-----------------------------------------------------------');
      DBMS_OUTPUT.put_line(ERR_MSG);
      ROLLBACK;
      RAISE;

END;
/

EXIT;
