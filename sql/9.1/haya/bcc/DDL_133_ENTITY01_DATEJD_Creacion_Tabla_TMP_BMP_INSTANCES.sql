--##########################################
--## AUTOR=Enrique Jimenez Diaz
--## FECHA_CREACION=20151015
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=CMREC-915
--## PRODUCTO=NO
--## 
--## Finalidad: Crea la tabla necesaria para el ALTA de BMPs para Concursal
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versiion inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

 V_ESQUEMA VARCHAR2(25 CHAR):=   '#ESQUEMA#'; 			-- Configuracion Esquema #ESQUEMA#
 V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; 		-- Configuracion Esquema Master  #ESQUEMA_MASTER#
 TABLA VARCHAR(30) :='TMP_ALTA_BPM_INSTANCES';
 err_num NUMBER;
 err_msg VARCHAR2(2048 CHAR);
 V_MSQL VARCHAR2(2500 CHAR);
 V_MSQL2 VARCHAR2(2500 CHAR);
 V_EXISTE NUMBER (1):=null;


BEGIN

  SELECT COUNT(*) INTO V_EXISTE
  FROM ALL_TABLES
  WHERE TABLE_NAME = ''||TABLA||'';

 
  IF V_EXISTE = 1 THEN   
     EXECUTE IMMEDIATE ('DROP TABLE '||V_ESQUEMA||'.'||TABLA );
     DBMS_OUTPUT.PUT_LINE(''||TABLA||' BORRADA');
  END IF;   

  V_MSQL2 := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.'||TABLA||'  
         (
	"PRC_ID" NUMBER(16,0) NOT NULL ENABLE, 
	"DEF_ID" NUMBER(16,0) NOT NULL ENABLE, 
	"NODE_ID" NUMBER(16,0) NOT NULL ENABLE, 
	"TAP_CODIGO" VARCHAR2(100 CHAR) NOT NULL ENABLE, 
	"TEX_ID" NUMBER(16,0) NOT NULL ENABLE, 
	"FORK_NODE" NUMBER(16,0), 
	"INST_ID" NUMBER(16,0) NOT NULL ENABLE, 
	"TOKEN_PADRE_ID" NUMBER(16,0), 
	"MODULE_PADRE_ID" NUMBER(16,0), 
	"VMAP_PADRE_ID" NUMBER(16,0),
	"TOKEN_ID" NUMBER(16,0), 
	"MODULE_ID" NUMBER(16,0), 
	"VMAP_ID" NUMBER(16,0)
	) ON COMMIT DELETE ROWS';

     EXECUTE IMMEDIATE V_MSQL2;
     DBMS_OUTPUT.PUT_LINE(''||TABLA||' CREADA');

EXCEPTION
WHEN OTHERS THEN
  err_num := SQLCODE;
  err_msg := SQLERRM;

  DBMS_OUTPUT.put_line('Error:'||TO_CHAR(err_num));
  DBMS_OUTPUT.put_line(err_msg);

  ROLLBACK;
  RAISE;
  
END;
/
EXIT;
