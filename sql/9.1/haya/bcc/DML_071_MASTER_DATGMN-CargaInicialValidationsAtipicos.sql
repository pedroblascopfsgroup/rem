/--/*
--##########################################
--## AUTOR=GUSTAVO MORA
--## FECHA_CREACION=20151006
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=CMREC-532
--## PRODUCTO=NO
--## 
--## Finalidad: Limpieza y carga inicial de tablas validaciones DD_JVI_JOB_VAL_INTERFAZ, y BATCH_JOB_VALIDATION para ATIPICOS, esquema #ESQUEMA_MASTER#
--## INSTRUCCIONES:  Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--## 0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;
DECLARE
  
 TYPE T_JVI IS TABLE OF VARCHAR2(250);
 TYPE T_ARRAY_JVI IS TABLE OF T_JVI;
 
 TYPE T_JBV IS TABLE OF VARCHAR2(4000);
 TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
 
 
--/*
--##########################################
--## Configuraciones a rellenar
--##########################################
--*/
  -- Configuracion Esquemas
 V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
 V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
 seq_count NUMBER(3); -- Vble. para validar la existencia de las Secuencias.
 table_count NUMBER(3); -- Vble. para validar la existencia de las Tablas.
 v_column_count  NUMBER(3); -- Vble. para validar la existencia de las Columnas.
 v_constraint_count NUMBER(3); -- Vble. para validar la existencia de las Constraints.
 err_num  NUMBER; -- Numero de errores
 err_msg  VARCHAR2(2048); -- Mensaje de error 
 V_MSQL VARCHAR2(4000 CHAR);
 V_EXIST  NUMBER(10);
 V_ENTIDAD_ID  NUMBER(16); 
 V_ENTIDAD NUMBER(16);

 V_USUARIO_CREAR VARCHAR2(10) := 'INICIAL';

 
--Configuracion  DD_JVI_JOB_VAL_INTERFAZ para ATIPICOS
  
   V_JVI T_ARRAY_JVI := T_ARRAY_JVI(
                                    T_JVI('APR_CJM_ATC_ATIPICOS_CNT','Tabla tmp de Atípicos', 'Tabla tmp de Atípicos', 'ATIPICOS')
                                   );
  
  
 V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
-- Validaciones atipicos
               T_JBV('atc-00.countValidator',1,'select count(1) from APR_CJM_ATC_ATIPICOS_CNT  ',13,2,0)
             , T_JBV('atc-01.loadDateValidator',1,'SELECT ATC_FECHA_EXTRACCION AS ERROR_FIELD, TO_CHAR(ATC_CODIGO_ATIPICO) AS ENTITY_CODE from APR_CJM_ATC_ATIPICOS_CNT where ATC_FECHA_EXTRACCION <> to_date(#TOKEN_DATE#,''''YYYYMMDD'''') ',13,2,0)
             , T_JBV('atc-01.atcUniqueValidator',1,'select ATC_CODIGO_ATIPICO AS ERROR_FIELD, to_char(ATC_CODIGO_ATIPICO) AS ENTITY_CODE from APR_CJM_ATC_ATIPICOS_CNT group by ATC_CODIGO_ATIPICO having count(*) > 1',13,2,0)                                                                 
             , T_JBV('atc-02.insertAtcTipoProdValidator',1,'INSERT INTO DD_TPE_TIPO_PROD_ENTIDAD ( DD_TPE_ID, DD_TPR_ID, DD_TPE_CODIGO, DD_TPE_DESCRIPCION, DD_TPE_DESCRIPCION_LARGA, DD_TPE_ACTIVO, VERSION, USUARIOCREAR, FECHACREAR, BORRADO) SELECT S_DD_TPE_TIPO_PROD_ENTIDAD.NEXTVAL AS DD_TPE_ID  , DD_TPR_ID AS DD_TPR_ID , DD_TPE_CODIGO  , DD_TPE_DESCRIPCION , DD_TPE_DESCRIPCION AS DD_TPE_DESCRIPCION_LARGA , 1 AS DD_TPE_ACTIVO , 0 AS VERSION , #TOKEN_USR# AS USUARIOCREAR , sysdate AS FECHACREAR , 0 AS BORRADO from  ( SELECT DISTINCT ERROR_FIELD as DD_TPE_CODIGO, ''''Tipo producto entidad pendiente de definir (''''||ERROR_FIELD||'''')'''' as DD_TPE_DESCRIPCION FROM (SELECT ATC_TIPO_PRODUCTO AS ERROR_FIELD,  ATC_TIPO_PRODUCTO ||''''-''''|| to_char(ATC_CODIGO_ATIPICO) AS ENTITY_CODE  FROM '||V_ESQUEMA||'.APR_CJM_ATC_ATIPICOS_CNT  LEFT JOIN '||V_ESQUEMA||'.DD_TPE_TIPO_PROD_ENTIDAD on (APR_CJM_ATC_ATIPICOS_CNT.ATC_TIPO_PRODUCTO = DD_TPE_TIPO_PROD_ENTIDAD.DD_TPE_CODIGO) WHERE DD_TPE_TIPO_PROD_ENTIDAD.DD_TPE_CODIGO IS NULL   )  ), ( SELECT DD_TPR_ID FROM DD_TPR_TIPO_PROD WHERE DD_TPR_DESCRIPCION LIKE ''''%PRODUCTO NO ESPECIFICADO%'''') ',13,2,0)
             , T_JBV('atc-02.atcTipoProdValidator',1,'SELECT DISTINCT ERROR_FIELD as DD_TPE_CODIGO, ''''Tipo producto entidad pendiente de definir (''''||ERROR_FIELD||'''')'''' as DD_TPE_DESCRIPCION FROM (SELECT ATC_TIPO_PRODUCTO AS ERROR_FIELD,  ATC_TIPO_PRODUCTO ||''''-''''|| to_char(ATC_CODIGO_ATIPICO) AS ENTITY_CODE  FROM '||V_ESQUEMA||'.APR_CJM_ATC_ATIPICOS_CNT  LEFT JOIN '||V_ESQUEMA||'.DD_TPE_TIPO_PROD_ENTIDAD on (APR_CJM_ATC_ATIPICOS_CNT.ATC_TIPO_PRODUCTO = DD_TPE_TIPO_PROD_ENTIDAD.DD_TPE_CODIGO) WHERE DD_TPE_TIPO_PROD_ENTIDAD.DD_TPE_CODIGO IS NULL   ) WHERE 1=1',13,2,0)            
             , T_JBV('atc-03.insertAtcTipoAtipicoValidator',1,'INSERT INTO DD_TAT_TIPO_ATIPICO ( DD_TAT_ID, DD_TAT_CODIGO, DD_TAT_DESCRIPCION, DD_TAT_DESCRIPCION_LARGA, VERSION, USUARIOCREAR, FECHACREAR, BORRADO) SELECT S_DD_TAT_TIPO_ATIPICO.NEXTVAL AS DD_TAT_ID , DD_TAT_CODIGO  , DD_TAT_DESCRIPCION , DD_TAT_DESCRIPCION AS DD_TAT_DESCRIPCION_LARGA , 0 AS VERSION , #TOKEN_USR# AS USUARIOCREAR , sysdate AS FECHACREAR , 0 AS BORRADO from  ( SELECT DISTINCT ERROR_FIELD as DD_TAT_CODIGO, ''''Tipo Atípico pendiente de definir (''''||ERROR_FIELD||'''')'''' as DD_TAT_DESCRIPCION  FROM (SELECT ATC_TIPO_ATIPICO AS ERROR_FIELD,  ATC_TIPO_ATIPICO ||''''-''''|| to_char(ATC_CODIGO_ATIPICO) AS ENTITY_CODE  FROM '||V_ESQUEMA||'.APR_CJM_ATC_ATIPICOS_CNT  LEFT JOIN '||V_ESQUEMA||'.DD_TAT_TIPO_ATIPICO on (APR_CJM_ATC_ATIPICOS_CNT.ATC_TIPO_ATIPICO = DD_TAT_TIPO_ATIPICO.DD_TAT_CODIGO)  WHERE DD_TAT_TIPO_ATIPICO.DD_TAT_CODIGO IS NULL   )  )',13,2,0)
             , T_JBV('atc-03.atcTipoAtipicoValidator',1,'SELECT DISTINCT ERROR_FIELD as DD_TAT_CODIGO, ''''Tipo Atípico pendiente de definir (''''||ERROR_FIELD||'''')'''' as DD_TAT_DESCRIPCION  FROM (SELECT ATC_TIPO_ATIPICO AS ERROR_FIELD,  ATC_TIPO_ATIPICO ||''''-''''|| to_char(ATC_CODIGO_ATIPICO) AS ENTITY_CODE  FROM '||V_ESQUEMA||'.APR_CJM_ATC_ATIPICOS_CNT  LEFT JOIN '||V_ESQUEMA||'.DD_TAT_TIPO_ATIPICO on (APR_CJM_ATC_ATIPICOS_CNT.ATC_TIPO_ATIPICO = DD_TAT_TIPO_ATIPICO.DD_TAT_CODIGO)  WHERE DD_TAT_TIPO_ATIPICO.DD_TAT_CODIGO IS NULL ) WHERE 1=1',13,2,0)                          
             , T_JBV('atc-04.insertAtcMotivoAtipicoValidator',1,'INSERT INTO DD_MAT_MOTIVO_ATIPICO ( DD_MAT_ID, DD_MAT_CODIGO, DD_MAT_DESCRIPCION, DD_MAT_DESCRIPCION_LARGA, VERSION, USUARIOCREAR, FECHACREAR, BORRADO) SELECT S_DD_MAT_MOTIVO_ATIPICO.NEXTVAL AS DD_MAT_ID , DD_MAT_CODIGO  , DD_MAT_DESCRIPCION , DD_MAT_DESCRIPCION AS DD_MAT_DESCRIPCION_LARGA , 0 AS VERSION , #TOKEN_USR# AS USUARIOCREAR , sysdate AS FECHACREAR , 0 AS BORRADO from  ( SELECT DISTINCT ERROR_FIELD as DD_MAT_CODIGO, ''''Motivo Atípico pendiente de definir (''''||ERROR_FIELD||'''')'''' as DD_MAT_DESCRIPCION  FROM (SELECT ATC_MOTIVO_ATIPICO AS ERROR_FIELD,  ATC_MOTIVO_ATIPICO ||''''-''''|| to_char(ATC_CODIGO_ATIPICO) AS ENTITY_CODE  FROM '||V_ESQUEMA||'.APR_CJM_ATC_ATIPICOS_CNT  LEFT JOIN '||V_ESQUEMA||'.DD_MAT_MOTIVO_ATIPICO on (NVL(APR_CJM_ATC_ATIPICOS_CNT.ATC_MOTIVO_ATIPICO,''''0000'''') = DD_MAT_MOTIVO_ATIPICO.DD_MAT_CODIGO)  WHERE DD_MAT_MOTIVO_ATIPICO.DD_MAT_CODIGO IS NULL   )  )',13,2,0)
             , T_JBV('atc-04.atcMotivoAtipicoValidator',1,'SELECT DISTINCT ERROR_FIELD as DD_MAT_CODIGO, ''''Motivo Atípico pendiente de definir (''''||ERROR_FIELD||'''')'''' as DD_MAT_DESCRIPCION  FROM (SELECT ATC_MOTIVO_ATIPICO AS ERROR_FIELD,  ATC_MOTIVO_ATIPICO ||''''-''''|| to_char(ATC_CODIGO_ATIPICO) AS ENTITY_CODE  FROM '||V_ESQUEMA||'.APR_CJM_ATC_ATIPICOS_CNT  LEFT JOIN '||V_ESQUEMA||'.DD_MAT_MOTIVO_ATIPICO on (NVL(APR_CJM_ATC_ATIPICOS_CNT.ATC_MOTIVO_ATIPICO,''''0000'''') = DD_MAT_MOTIVO_ATIPICO.DD_MAT_CODIGO)  WHERE DD_MAT_MOTIVO_ATIPICO.DD_MAT_CODIGO IS NULL)  WHERE 1=1',13,2,0)                          
             , T_JBV('atc-05.atcExtraccionValidator',1,'select TO_CHAR(a.FEMAX, ''''DDMMYYYY'''') AS ERROR_FIELD, TO_CHAR(b.FCMAX, ''''DDMMYYYY'''') AS ENTITY_CODE from (select MAX(ATC_FECHA_EXTRACCION) as FEMAX, MIN(ATC_FECHA_EXTRACCION) as FEMIN from APR_CJM_ATC_ATIPICOS_CNT ) a , (select MAX(FECHACREAR) as FCMAX,  MAX(FECHAMODIFICAR) as FMMAX from ATC_ATIPICOS_CNT)  b   where a.FEMAX <= b.FCMAX  OR a.FEMAX <= b.FMMAX OR a.FEMAX <> a.FEMIN',13,2,0)               
             , T_JBV('atc-06.atcCntAtcValidator',1,'select atc.ATC_CODIGO_ATIPICO AS ERROR_FIELD, to_char(atc.ATC_CODIGO_ATIPICO)||''''-''''||to_char(ATC_NUMERO_CONTRATO)  AS ENTITY_CODE from APR_CJM_ATC_ATIPICOS_CNT atc left join CNT_CONTRATOS cnt  on atc.ATC_NUMERO_CONTRATO = cnt.CNT_CONTRATO where cnt.CNT_CONTRATO is null',13,2,0)             
             );  
             
--/*
--##########################################
--## FIN Configuraciones a rellenar
--##########################################
--*/  
 
 V_TMP_JVI T_JVI;
 V_TMP_JBV T_JBV; 

 
BEGIN

 DBMS_OUTPUT.PUT_LINE('Se borra la configuración de BATCH_JOB_VALIDATION');
 EXECUTE IMMEDIATE('DELETE FROM '|| V_ESQUEMA_MASTER ||'.BATCH_JOB_VALIDATION WHERE JOB_VAL_INTERFAZ = 13 ');
 
 
 DBMS_OUTPUT.PUT_LINE('Se borra la configuración de DD_JVI_JOB_VAL_INTERFAZ');
 EXECUTE IMMEDIATE('DELETE FROM '|| V_ESQUEMA_MASTER ||'.DD_JVI_JOB_VAL_INTERFAZ  where DD_JVI_BLOQUE = ''ATIPICOS''');
  

 
 
 DBMS_OUTPUT.PUT_LINE('Reseteamos los contadores......');
 
 V_ENTIDAD_ID:=0;
 SELECT count(*) INTO V_ENTIDAD_ID
 FROM all_sequences
 WHERE sequence_name = 'S_JVI_JOB_VAL_INTERFAZ' and sequence_owner=V_ESQUEMA_MASTER;
 
 if V_ENTIDAD_ID is not null and V_ENTIDAD_ID = 1 then
 DBMS_OUTPUT.PUT_LINE('Contador 1');
 EXECUTE IMMEDIATE('DROP SEQUENCE '|| V_ESQUEMA_MASTER || '.S_JVI_JOB_VAL_INTERFAZ');
 end if;
 
 EXECUTE IMMEDIATE('CREATE SEQUENCE '|| V_ESQUEMA_MASTER || '.S_JVI_JOB_VAL_INTERFAZ
 START WITH 13
 MAXVALUE 999999999999999999999999999
 MINVALUE 1
 NOCYCLE
 CACHE 20
 NOORDER'
  ); 
 


  V_ENTIDAD_ID:=0;
 SELECT count(*) INTO V_ENTIDAD_ID
 FROM all_sequences
 WHERE sequence_name = 'S_JVI_JOB_VAL_INTERFAZ' and sequence_owner=V_ESQUEMA_MASTER;

 DBMS_OUTPUT.PUT_LINE('Creando DD_JVI_JOB_VAL_INTERFAZ......');
 FOR I IN V_JVI.FIRST .. V_JVI.LAST
 LOOP
  V_MSQL := 'SELECT '||V_ESQUEMA_MASTER||'.S_JVI_JOB_VAL_INTERFAZ.NEXTVAL FROM DUAL';
  EXECUTE IMMEDIATE V_MSQL INTO V_ENTIDAD_ID;
 V_TMP_JVI := V_JVI(I);
 DBMS_OUTPUT.PUT_LINE('Creando JVI: '||V_TMP_JVI(1)); 

 V_MSQL := 'INSERT INTO '||V_ESQUEMA_MASTER||'.DD_JVI_JOB_VAL_INTERFAZ (DD_JVI_ID, DD_JVI_CODIGO, DD_JVI_DESCRIPCION,' ||
 'DD_JVI_DESCRIPCION_LARGA, DD_JVI_BLOQUE, VERSION, USUARIOCREAR, FECHACREAR, BORRADO) ' ||
 ' VALUES ('||  V_ENTIDAD_ID || ','''||V_TMP_JVI(1)||''','''||SUBSTR(V_TMP_JVI(2),1, 50)||''','''
  ||V_TMP_JVI(3)||''','''
  ||V_TMP_JVI(4)||''',0,'''||V_USUARIO_CREAR||''',SYSDATE,0)';
 EXECUTE IMMEDIATE V_MSQL;
 END LOOP; 
 V_TMP_JVI := NULL;


 
 --sacamos la el codigo entidad de la tabla ENTIDAD.
  V_ENTIDAD:=1;

COMMIT;
 
 V_ENTIDAD_ID:=0;

 V_MSQL := 'select ID from '||V_ESQUEMA_MASTER||'.ENTIDAD where DESCRIPCION = ''CAJAMAR''';
 EXECUTE IMMEDIATE V_MSQL INTO V_ENTIDAD;

/* select ID INTO V_ENTIDAD  from #ESQUEMA_MASTER#.ENTIDAD where DESCRIPCION = 'CAJAMAR'; */
 

 DBMS_OUTPUT.PUT_LINE('Creando BATCH_JOB_VALIDATION......');
 FOR I IN V_JBV.FIRST .. V_JBV.LAST
 LOOP
  V_MSQL := 'SELECT '||V_ESQUEMA_MASTER||'.S_BATCH_JOB_VALIDATION.NEXTVAL FROM DUAL';
  EXECUTE IMMEDIATE V_MSQL INTO V_ENTIDAD_ID;
 V_TMP_JBV := V_JBV(I);
 DBMS_OUTPUT.PUT_LINE('Creando BATCH_JOB_VALIDATION: '||V_TMP_JBV(1)); 

 V_MSQL := 'INSERT INTO '||V_ESQUEMA_MASTER||'.BATCH_JOB_VALIDATION (JOB_VAL_ID, JOB_VAL_CODIGO, JOB_VAL_ENTITY, JOB_VAL_ORDER, JOB_VAL_VALUE, JOB_VAL_INTERFAZ, JOB_VAL_SEVERITY ' ||
 ', VERSION, USUARIOCREAR, FECHACREAR, BORRADO) ' ||
 ' VALUES ('||  V_ENTIDAD_ID || ','''
  ||V_TMP_JBV(1)||''','''
  ||V_ENTIDAD||''','''
  ||V_ENTIDAD_ID||''','''
  ||V_TMP_JBV(3)||''',''' 
  ||V_TMP_JBV(4)||''','''
  ||V_TMP_JBV(5)||''',0,'''
  ||V_USUARIO_CREAR||''',SYSDATE,'''
  ||V_TMP_JBV(6)||''')';
 EXECUTE IMMEDIATE V_MSQL;
 END LOOP; 
 V_TMP_JVI := NULL; 
 

 COMMIT;

EXCEPTION

WHEN OTHERS THEN  
  err_num := SQLCODE;
  err_msg := SQLERRM;

  DBMS_OUTPUT.put_line('Error:'||TO_CHAR(err_num));
  DBMS_OUTPUT.put_line(err_msg);
  
  ROLLBACK;
  RAISE;
END;
/
EXIT;
