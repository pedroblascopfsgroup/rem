--/*
--##########################################
--## AUTOR=JAVIER DIAZ
--## FECHA_CREACION=20151228
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=CMREC-947
--## PRODUCTO=NO
--## 
--## Finalidad: CARGA DATOS EN DICCIONARIO DD_SEC_SEGMENTO_CARTERA
--##                   
--##                               , esquema CM01. Con estructura correcta
--## INSTRUCCIONES:  Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 VersiÃ³n inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE


 -- DD_SEC_SEGMENTO_CARTERA
 TYPE T_SEC IS TABLE OF VARCHAR2(2000);
 TYPE T_ARRAY_SEC IS TABLE OF T_SEC;
 
--/*
--##########################################
--## Configuraciones a rellenar
--##########################################
--*/

-- VARIABLES
 V_ESQUEMA VARCHAR2(25 CHAR):=   '#ESQUEMA#';               -- Configuracion Esquema
 V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';         -- Configuracion Esquema Master 
 TABLA VARCHAR(30) :='DD_SEC_SEGMENTO_CARTERA';
 err_num NUMBER;
 err_msg VARCHAR2(2048); 
 V_MSQL1 VARCHAR2(8500 CHAR);
 V_MSQL2 VARCHAR2(8500 CHAR);
 V_MSQL3 VARCHAR2(8500 CHAR);
 V_EXISTE NUMBER (1):=null;

-- DEFINICION ARRAY.

 V_SEC T_ARRAY_SEC := T_ARRAY_SEC(
T_SEC ( '1111','VIVIENDA HABITUAL','VIVIENDA HABITUAL','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1121','VIVIENDA OTROS USOS','VIVIENDA OTROS USOS','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1211','MICROCONSUMO - OTROS BIENES Y SERVICIOS','MICROCONSUMO - OTROS BIENES Y SERVICIOS','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1212','MICROCONSUMO - OTROS BIENES Y SERVICIOS VIVIENDA','MICROCONSUMO - OTROS BIENES Y SERVICIOS VIVIENDA','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1221','CONSUMO - AUTOMOVILES','CONSUMO - AUTOMOVILES','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1231','CONSUMO - OTROS BIENES Y SERVICIOS','CONSUMO - OTROS BIENES Y SERVICIOS','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1232','CONSUMO - OTROS BIENES Y SERVICIOS VIVIENDA','CONSUMO - OTROS BIENES Y SERVICIOS VIVIENDA','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1311','TARJETAS DE CREDITO','TARJETAS DE CREDITO','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1312','TARJETAS DE CREDITO - AUTONOMOS','TARJETAS DE CREDITO - AUTONOMOS','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1313','TARJETAS DE CREDITO - HORTICULTURA','TARJETAS DE CREDITO - HORTICULTURA','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1321','DESCUBIERTOS','DESCUBIERTOS','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1411','ACTIVIDAD EMPRESARIAL - P.FISICAS G.REAL','ACTIVIDAD EMPRESARIAL - P.FISICAS G.REAL','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1412','ACTIVIDAD EMPRESARIAL - P.FISICAS G.PERSONAL','ACTIVIDAD EMPRESARIAL - P.FISICAS G.PERSONAL','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1421','MICRO EMPRESAS G. REAL','MICRO EMPRESAS G. REAL','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1422','MICRO EMPRESAS G. PERSONAL','MICRO EMPRESAS G. PERSONAL','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1511','FINANCIACION CAMPAÑA HORTICULTURA INTENSIVA','FINANCIACION CAMPAÑA HORTICULTURA INTENSIVA','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1512','HORTICULTURA INTENSIVA-OTRAS OPERACIONES - P.FISICAS - G.R','HORTICULTURA INTENSIVA-OTRAS OPERACIONES - P.FISICAS - G.R','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1513','HORTICULTURA INTENSIVA-OTRAS OPERACIONES - P.FISICAS - G.P','HORTICULTURA INTENSIVA-OTRAS OPERACIONES - P.FISICAS - G.P','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1514','HORTICULTURA INTENSIVA-OTRAS OPERACIONES - P.JURIDICAS - G.R','HORTICULTURA INTENSIVA-OTRAS OPERACIONES - P.JURIDICAS - G.R','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1515','HORTICULTURA INTENSIVA-OTRAS OPERACIONES - P.JURIDICAS - G.P','HORTICULTURA INTENSIVA-OTRAS OPERACIONES - P.JURIDICAS - G.P','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1521','RESTO SECTOR AGROALIMENTARIO - P. FISICAS - G.R','RESTO SECTOR AGROALIMENTARIO - P. FISICAS - G.R','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1522','RESTO SECTOR AGROALIMENTARIO - P. FISICAS - G.P','RESTO SECTOR AGROALIMENTARIO - P. FISICAS - G.P','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1523','RESTO SECTOR AGROALIMENTARIO - P. JURIDICAS - G.R','RESTO SECTOR AGROALIMENTARIO - P. JURIDICAS - G.R','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '1524','RESTO SECTOR AGROALIMENTARIO - P. JURIDICAS - G.P','RESTO SECTOR AGROALIMENTARIO - P. JURIDICAS - G.P','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2111','PROMOCIONES DE VIVIENDAS - PROMOCION','PROMOCIONES DE VIVIENDAS - PROMOCION','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2112','AVALES A COMPRADORES - PROMOCION','AVALES A COMPRADORES - PROMOCION','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2121','ADQUISICIONES DE SUELO - PROMOCION','ADQUISICIONES DE SUELO - PROMOCION','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2131','OTRAS PROMOCIONES INMOBILIARIAS','OTRAS PROMOCIONES INMOBILIARIAS','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2132','RESTO DE RIESGO PROMOTOR','RESTO DE RIESGO PROMOTOR','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2211','PRODUCTORES AGROALIMENTARIOS - PEQUEÑA','PRODUCTORES AGROALIMENTARIOS - PEQUEÑA','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2212','PRODUCTORES AGROALIMENTARIOS - MEDIANA','PRODUCTORES AGROALIMENTARIOS - MEDIANA','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2213','PRODUCTORES AGROALIMENTARIOS - GRANDE','PRODUCTORES AGROALIMENTARIOS - GRANDE','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2221','COMERCIALIZADORAS AGROALIMENTARIAS - PEQUEÑA','COMERCIALIZADORAS AGROALIMENTARIAS - PEQUEÑA','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2222','COMERCIALIZADORAS AGROALIMENTARIAS - MEDIANA','COMERCIALIZADORAS AGROALIMENTARIAS - MEDIANA','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2223','COMERCIALIZADORAS AGROALIMENTARIAS - GRANDE','COMERCIALIZADORAS AGROALIMENTARIAS - GRANDE','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2231','IND.AUX.AGROALIMENTARIA PEQUEÑA','IND.AUX.AGROALIMENTARIA PEQUEÑA','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2232','IND.AUX.AGROALIMENTARIA MEDIANA','IND.AUX.AGROALIMENTARIA MEDIANA','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2233','IND.AUX.AGROALIMENTARIA GRANDE','IND.AUX.AGROALIMENTARIA GRANDE','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2311','EMPRESAS PEQUEÑAS','EMPRESAS PEQUEÑAS','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2321','EMPRESAS MEDIANAS','EMPRESAS MEDIANAS','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '2411','EMPRESAS GRANDES','EMPRESAS GRANDES','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '3111','OPERACIONES SECTOR PUBLICO','OPERACIONES SECTOR PUBLICO','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '4111','OPERACIONES I.S.L','OPERACIONES I.S.L','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '5111','ENTIDADES DE CREDITO','ENTIDADES DE CREDITO','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '5121','OTRAS INSTITUCIONES FINANCIERAS','OTRAS INSTITUCIONES FINANCIERAS','0','INICIAL','SYSDATE','null','null','null','null','0'),
T_SEC ( '9999','SIN SEGMENTO DEFINIDO','SIN SEGMENTO DEFINIDO','0','INICIAL','SYSDATE','null','null','null','null','0')


			
 );


 V_TMP_SEC T_SEC;

-- FIN ARRAY

-- SECUENCIA

BEGIN 





 V_EXISTE:=0;
 SELECT count(*) INTO V_EXISTE
 FROM all_sequences
 WHERE sequence_name = 'S_'||TABLA and sequence_owner= V_ESQUEMA;

 if V_EXISTE is null OR V_EXISTE = 0 then
     EXECUTE IMMEDIATE('CREATE SEQUENCE '||V_ESQUEMA|| '.S_'||TABLA||'
     START WITH 1
     MAXVALUE 999999999999999999999999999
     MINVALUE 1
     NOCYCLE
     CACHE 20
     NOORDER');
 end if;
 
 -- FIN SECUENCIA
 




 -- LOOP PARA RECOORER ARRAY

 FOR I IN V_SEC.FIRST .. V_SEC.LAST
 LOOP
   V_TMP_SEC := V_SEC(I);
   V_EXISTE:=0; 
   DBMS_OUTPUT.PUT_LINE('Creando '||TABLA||': '||V_TMP_SEC(1));   
   
  


   V_MSQL1 := 'SELECT COUNT(*) FROM ' || V_ESQUEMA || '.'||TABLA||' WHERE DD_SEC_CODIGO = ''' || V_TMP_SEC(1) || '''';
   EXECUTE IMMEDIATE V_MSQL1 INTO V_EXISTE;
   
  if V_EXISTE is not null and V_EXISTE = 1 then
      DBMS_OUTPUT.PUT_LINE('[ATENCION] '||TABLA||' - '||V_TMP_SEC(1) || ' YA EXISTE');



     --Actualizamos los ya existentes

 V_MSQL3 := 'UPDATE ' || V_ESQUEMA || '.'||TABLA||' 
					SET DD_SEC_DESCRIPCION = ''' || SUBSTR(V_TMP_SEC(2),1,50) || ''' ,
					    DD_SEC_DESCRIPCION_LARGA = ''' || V_TMP_SEC(3) || ''',
					    USUARIOCREAR = ''INICIAL'',
				            FECHACREAR = SYSDATE			
WHERE DD_SEC_CODIGO = ''' || V_TMP_SEC(1) || '''';

DBMS_OUTPUT.PUT_LINE(V_MSQL3);
EXECUTE IMMEDIATE V_MSQL3;
DBMS_OUTPUT.PUT_LINE('ACTUALIZAMOS DE LA TABLA '||TABLA||': '||V_TMP_SEC(1));

COMMIT;


  ELSE
  
  -- SECUENCIA INSERT
        V_MSQL1 := 'INSERT INTO ' ||V_ESQUEMA|| '.'||TABLA||' 
                    ( DD_SEC_ID, DD_SEC_CODIGO, DD_SEC_DESCRIPCION, DD_SEC_DESCRIPCION_LARGA, VERSION, USUARIOCREAR, FECHACREAR, USUARIOMODIFICAR, FECHAMODIFICAR, USUARIOBORRAR, FECHABORRAR, BORRADO)
                   VALUES (   ' || V_ESQUEMA || '.S_'||TABLA||'.NEXTVAL,'''
                        ||V_TMP_SEC(1)||q'[',']'
                        ||SUBSTR(V_TMP_SEC(2),1,50)||q'[',']'
                        ||V_TMP_SEC(3)||q'[',]'
                        ||V_TMP_SEC(4)||q'[,']' 
                        ||V_TMP_SEC(5)||q'[',]' 
                        ||V_TMP_SEC(6)||q'[,]'
                        ||V_TMP_SEC(7)||q'[,]'
                        ||V_TMP_SEC(8)||q'[,]'
                        ||V_TMP_SEC(9)||q'[,]'
                        ||V_TMP_SEC(10)||q'[,]'  
                        ||V_TMP_SEC(11)||q'[)]' 
                        ;
             
    DBMS_OUTPUT.PUT_LINE(V_MSQL1);

DBMS_OUTPUT.PUT_LINE('INSERTAMOS EN LA TABLA '||TABLA||': '||V_TMP_SEC(1));
EXECUTE IMMEDIATE V_MSQL1;

COMMIT;

     END IF;
    
 END LOOP; 


--Borramos de la tabla los no utilizados


   V_MSQL2 := 'DELETE FROM ' ||V_ESQUEMA|| '.'||TABLA||' WHERE USUARIOCREAR <> ''INICIAL''';
						
    
   EXECUTE IMMEDIATE V_MSQL2;
   DBMS_OUTPUT.PUT_LINE('BORRAMOS DE LA TABLA '||TABLA||'');

COMMIT;



-- FIN INSERT / LOOP

-- EXCEPCIONES

 EXCEPTION

 WHEN OTHERS THEN
   err_num := SQLCODE;
   err_msg := SQLERRM;

   DBMS_OUTPUT.put_line('Error:'||TO_CHAR(err_num));
   DBMS_OUTPUT.put_line(err_msg);

   ROLLBACK;
   RAISE;
 END;
  /
 EXIT;
