--/*
--##########################################
--## AUTOR=Daniel Albert Pérez
--## FECHA_CREACION=20160706
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2.7
--## INCIDENCIA_LINK=RECOVERY-257
--## PRODUCTO=NO
--## Finalidad: DML reparación asuntos HAYA
--##           
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON

DECLARE

  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

BEGIN

	MERGE INTO
	  #ESQUEMA#.PRB_PRC_BIE T1
	USING
	(
	  SELECT DISTINCT
		P.PRC_ID
		, PRB.BIE_ID
	  FROM
		#ESQUEMA#.ASU_ASUNTOS A
	  INNER JOIN
		#ESQUEMA#.PRC_PROCEDIMIENTOS P
		ON P.ASU_ID = A.ASU_ID
	  INNER JOIN
		#ESQUEMA#.PRB_PRC_BIE PRB
		ON PRB.PRC_ID = P.PRC_ID AND PRB.BORRADO = 0
	  WHERE
		A.DD_EAS_ID IN (SELECT DD_EAS_ID FROM #ESQUEMA_MASTER#.DD_EAS_ESTADO_ASUNTOS WHERE DD_EAS_CODIGO IN ('03','07','22'))
		AND A.DD_TAS_ID = (SELECT DD_TAS_ID FROM #ESQUEMA_MASTER#.DD_TAS_TIPOS_ASUNTO WHERE DD_TAS_CODIGO = '01')
		AND A.BORRADO = 0
		AND A.USUARIOCREAR = 'SINCRO_CM_HAYA'
	  MINUS
	  SELECT DISTINCT
		P.PRC_ID
		, B.BIE_ID
	  FROM
		#ESQUEMA#.ASU_ASUNTOS A
	  INNER JOIN
		#ESQUEMA#.PRC_PROCEDIMIENTOS P
		ON P.ASU_ID = A.ASU_ID
	  INNER JOIN
		#ESQUEMA#.PRC_CEX PC
		ON PC.PRC_ID = P.PRC_ID
	  INNER JOIN
		#ESQUEMA#.CEX_CONTRATOS_EXPEDIENTE CX
		ON CX.CEX_ID = PC.CEX_ID
	  INNER JOIN
		#ESQUEMA#.BIE_CNT B
		ON B.CNT_ID = CX.CNT_ID
	  WHERE
		A.DD_EAS_ID IN (SELECT DD_EAS_ID FROM #ESQUEMA_MASTER#.DD_EAS_ESTADO_ASUNTOS WHERE DD_EAS_CODIGO IN ('03','07','22'))
		AND A.DD_TAS_ID = (SELECT DD_TAS_ID FROM #ESQUEMA_MASTER#.DD_TAS_TIPOS_ASUNTO WHERE DD_TAS_CODIGO = '01')
		AND A.BORRADO = 0
		AND A.USUARIOCREAR = 'SINCRO_CM_HAYA'
	) T2
	ON
	(
	  T1.PRC_ID = T2.PRC_ID AND T1.BIE_ID = T2.BIE_ID
	)
	WHEN MATCHED
	  THEN UPDATE
		SET T1.USUARIOBORRAR = 'RECOVERY-257'
		  , T1.FECHABORRAR = SYSDATE
		  , T1.BORRADO = 1
		WHERE
		  T1.BORRADO = 0;

  COMMIT;

EXCEPTION
    WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
      DBMS_OUTPUT.put_line('-----------------------------------------------------------');
      DBMS_OUTPUT.put_line(ERR_MSG);
      ROLLBACK;
      RAISE;

END;
/

EXIT;
