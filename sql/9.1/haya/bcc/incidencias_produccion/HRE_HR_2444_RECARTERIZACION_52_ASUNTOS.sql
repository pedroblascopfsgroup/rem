WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON
set timing ON
set linesize 2000
SET VERIFY OFF
set timing on
set feedback on

DECLARE

    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar
    V_ESQUEMA VARCHAR2(25 CHAR):= 'HAYA02'; -- Configuracion Esquemas
    V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= 'HAYAMASTER'; -- Configuracion Esquemas
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

    USUARIO varchar2(50 CHAR) := 'HR-2444: RECARTERIZACION 52 ASUNTOS';

BEGIN

	DBMS_OUTPUT.PUT_LINE('[INICIO] HR-2444: RECARTERIZACION 52 ASUNTOS');

	V_SQL := 'DELETE FROM '||v_esquema||'.GAH_GESTOR_ADICIONAL_HISTORICO
		  WHERE GAH_ID IN(
				SELECT DISTINCT GAH.GAH_ID
				FROM '||v_esquema||'.ASU_aSUNTOS ASU, '||v_esquema||'.GAH_GESTOR_ADICIONAL_HISTORICO GAH, '||v_esquema||'.USD_USUARIOS_DESPACHOS USD, '||v_esquema||'.DES_DESPACHO_EXTERNO DES, '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU, '||v_esquema||'.EXP_EXPEDIENTES EXP, '||v_esquema||'.GAA_GESTOR_ADICIONAL_ASUNTO GAA
				WHERE ASU.ASU_ID = GAH.GAH_ASU_ID
				AND GAH.GAH_ASU_ID = GAA.ASU_ID
				AND ASU.EXP_ID = EXP.EXP_ID
				AND GAA.USD_ID = USD.USD_ID
				AND GAH.GAH_TIPO_GESTOR_ID = (SELECT DD_TGE_ID FROM '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = ''GEXT'')
				AND USD.DES_ID = DES.DES_ID
				AND USD.USU_ID = USU.USU_ID
				AND USU.USU_USERNAME = ''GRUPDES013''
				AND EXP.CD_EXPEDIENTE_NUSE in (
				611627200008197,
				612327200004269,
				610407180001112,
				613807180000015,
				610307180001403,
				610207180017812,
				612727200001204,
				611807180002053,
				130206890000070,
				610316500000015,
				610027200007951,
				130207180000165,
				610507180003131,
				610307180003133,
				614607180003088,
				611806890000054,
				612307180001089,
				611107180002050,
				612706890000027,
				610507180002107,
				131107180000220,
				613607180001133,
				610307180002963,
				610507180020969,
				611507180000951,
				610306890001653,
				611807180003889,
				610210210003024,
				613607180000505,
				613527200000565,
				610507180003414,
				610010210003910,
				611807180002695,
				611807180001166,
				610607180000674,
				611807180000897,
				610607180002137,
				131106890000050,
				610307180004679,
				610507180002152,
				611707180004838,
				614207180000731,
				610407180001112,
				610607180002281,
				612407180001507,
				611807180001319,
				611207180000329,
				611207180000671,
				611207180001889,
				611207180002455,
				611707180006025,
				610407180001358)
				)';

    execute immediate v_sql;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' - DELETE EN GAH_ ... '||SQL%ROWCOUNT||' Filas');
    Commit;

	V_SQL:= 'DELETE FROM '||v_esquema||'.GAA_GESTOR_ADICIONAL_ASUNTO
		 WHERE GAA_ID IN(
				SELECT DISTINCT GAA_ID
				FROM '||v_esquema||'.ASU_aSUNTOS ASU, '||v_esquema||'.GAA_GESTOR_ADICIONAL_ASUNTO GAA, '||v_esquema||'.USD_USUARIOS_DESPACHOS USD, '||v_esquema||'.DES_DESPACHO_EXTERNO DES, '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU, '||v_esquema||'.EXP_EXPEDIENTES EXP
				WHERE ASU.ASU_ID = GAA.ASU_ID
				AND ASU.EXP_ID = EXP.EXP_ID
				AND GAA.USD_ID = USD.USD_ID
				AND GAA.DD_TGE_ID = (SELECT DD_TGE_ID FROM '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = ''GEXT'')
				AND USD.DES_ID = DES.DES_ID
				AND USD.USU_ID = USU.USU_ID
				AND USU.USU_USERNAME = ''GRUPDES013''
				AND EXP.CD_EXPEDIENTE_NUSE in (
				611627200008197,
				612327200004269,
				610407180001112,
				613807180000015,
				610307180001403,
				610207180017812,
				612727200001204,
				611807180002053,
				130206890000070,
				610316500000015,
				610027200007951,
				130207180000165,
				610507180003131,
				610307180003133,
				614607180003088,
				611806890000054,
				612307180001089,
				611107180002050,
				612706890000027,
				610507180002107,
				131107180000220,
				613607180001133,
				610307180002963,
				610507180020969,
				611507180000951,
				610306890001653,
				611807180003889,
				610210210003024,
				613607180000505,
				613527200000565,
				610507180003414,
				610010210003910,
				611807180002695,
				611807180001166,
				610607180000674,
				611807180000897,
				610607180002137,
				131106890000050,
				610307180004679,
				610507180002152,
				611707180004838,
				614207180000731,
				610407180001112,
				610607180002281,
				612407180001507,
				611807180001319,
				611207180000329,
				611207180000671,
				611207180001889,
				611207180002455,
				611707180006025,
				610407180001358)
				)';

    execute immediate v_sql;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' - DELETE EN GAA_  ... '||SQL%ROWCOUNT||' Filas');
    Commit;
    

    DBMS_OUTPUT.PUT_LINE('[FIN] HR-2444: RECARTERIZACION 52 ASUNTOS');

EXCEPTION
    WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecuci√≥n:'||TO_CHAR(ERR_NUM));
      DBMS_OUTPUT.put_line(V_SQL);
      DBMS_OUTPUT.put_line('-----------------------------------------------------------');
      DBMS_OUTPUT.put_line(ERR_MSG);
      ROLLBACK;
      RAISE;

END;
/

EXIT;
