--Borrar historico > 30 dias y hoy
DELETE FROM MINIREC.H_HISTORICO_HITOS
WHERE TO_CHAR(FECHA_HISTORICO,'YYYYMMDD') LIKE TO_CHAR(SYSDATE,'YYYYMMDD')
OR TO_CHAR(FECHA_HISTORICO,'YYYYMMDD') < TO_CHAR(SYSDATE- 30,'YYYYMMDD')
;

--Transferencia de los datos al historico
INSERT INTO MINIREC.H_HISTORICO_HITOS 
(
FECHA_HISTORICO,
ASU_ID,
ID_PROCEDIMIENTO,
ENTI,
ENTIDAD,
SERVICER,
HITO_SUJETO,
HITO_CODIGO,
HITO_DESCR,
FECHA_HITO

)
SELECT 
sysdate ,
ASU_ID,
ID_PROCEDIMIENTO,
ENTI,
ENTIDAD,
SERVICER,
HITO_SUJETO,
HITO_CODIGO,
HITO_DESCR,
FECHA_HITO
FROM MINIREC.HISTORICO_HITOS;

--Truncado de tablas TDX
TRUNCATE TABLE MINIREC.HISTORICO_HITOS;

--Generacion de las tablas TDX
INSERT INTO  MINIREC.HISTORICO_HITOS
(
ASU_ID,
ID_PROCEDIMIENTO,
ENTI ,
ENTIDAD ,
SERVICER ,
HITO_SUJETO ,
HITO_CODIGO,
HITO_DESCR,
FECHA_HITO
)
SELECT DISTINCT
TAREAS.ASU_ID,
TAREAS.PRC_ID,
'2038',
'BANKIA',
'HAYA',
NULL,
TAREAS.TAP_CODIGO,
SUBSTR(TAREAS.TAP_DESCRIPCION,0,75),
TAREAS.TAR_FECHA_FIN
FROM (
		SELECT TAR.TAR_ID, TAR.PRC_ID, PRC.ASU_ID, TAR.FECHACREAR, TAR.TAR_FECHA_INI, TAR.TAR_FECHA_FIN, TAP.TAP_CODIGO, TAP.TAP_DESCRIPCION,
		TPO.DD_TPO_CODIGO, TPO.DD_TPO_DESCRIPCION
		FROM HAYA01.PRC_PROCEDIMIENTOS PRC
		  INNER JOIN HAYA01.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.PRC_ID = PRC.PRC_ID
		  INNER JOIN HAYA01.TEX_TAREA_EXTERNA TEX ON TAR.TAR_ID = TEX.TAR_ID
		  INNER JOIN HAYA01.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
		  INNER JOIN HAYA01.DD_TPO_TIPO_PROCEDIMIENTO TPO ON TAP.DD_TPO_ID = TPO.DD_TPO_ID
		  INNER JOIN MINIREC.PROCEDIMIENTO_JUDICIAL_FOTO FOTO ON PRC.ASU_ID = FOTO.ASU_ID
		WHERE TAR.TAR_TAREA_FINALIZADA = 1
		AND TAR.TAR_FECHA_FIN IS NOT NULL
	 )TAREAS;

commit;
