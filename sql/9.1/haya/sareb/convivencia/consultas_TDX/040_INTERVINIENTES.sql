--Borrado de historico
DELETE FROM MINIREC.H_INTERVINIENTES
WHERE TO_CHAR(FECHA_HISTORICO,'YYYYMMDD') LIKE TO_CHAR(SYSDATE,'YYYYMMDD')
OR TO_CHAR(FECHA_HISTORICO,'YYYYMMDD') < TO_CHAR(SYSDATE-30,'YYYYMMDD')
;



--Transferencia de los datos al historico
INSERT INTO MINIREC.H_INTERVINIENTES
(
FECHA_HISTORICO,
ASU_ID,
ID_PROCEDIMIENTO,
ENTI,
ENTIDAD,
SERVICER,
DOCUMENTO,
NOMBRE,
TIPO_REL,
ORDEN_REL,
CUENTA
)
SELECT 
sysdate ,
ASU_ID,
ID_PROCEDIMIENTO,
ENTI,
ENTIDAD,
SERVICER,
DOCUMENTO,
NOMBRE,
TIPO_REL,
ORDEN_REL,
CUENTA
FROM MINIREC.INTERVINIENTES 
;

--Truncado de tablas TDX
TRUNCATE TABLE MINIREC.INTERVINIENTES;

--Generacion de las tablas TDX
INSERT INTO  MINIREC.INTERVINIENTES
(
ASU_ID,
ID_PROCEDIMIENTO,
ENTI ,
ENTIDAD ,
SERVICER ,
DOCUMENTO ,
NOMBRE ,
TIPO_REL ,
ORDEN_REL,
CUENTA
)
SELECT 
  ASU_ID,
  PRC_ID,
  '2038' ENTI,
  'BANKIA' ENTIDAD,
  'HAYA' SERVICED,
  SUBSTR(PER_DOC_ID,0,20) ,
  PER_NOM50 ,
  TIN,  
  ROW_NUMBER () OVER (PARTITION BY PRC_ID,CNT_CONTRATO ORDER BY TIN ASC) N  
  ,SUBSTR(CNT_CONTRATO,11,17)
 
FROM(
  SELECT DISTINCT
	PRC.ASU_ID,
    PER.PER_ID,
    PRC.PRC_ID,
    PER_DOC_ID,
    PER_NOM50 ,
    CASE WHEN CPE.DD_TIN_ID=1 THEN 'TITULAR' ELSE 'AVALISTA' END AS TIN 
    ,CNT.CNT_CONTRATO
  FROM HAYA01.PRC_PROCEDIMIENTOS PRC
    INNER JOIN HAYA01.PRC_PER PRCPER ON PRC.PRC_ID=PRCPER.PRC_ID
    INNER JOIN HAYA01.PER_PERSONAS PER ON PRCPER.PER_ID=PER.PER_ID
    INNER JOIN HAYA01.PRC_CEX PRCCEX ON PRCCEX.PRC_ID=PRC.PRC_ID
    INNER JOIN HAYA01.CEX_CONTRATOS_EXPEDIENTE CEX ON CEX.CEX_ID=PRCCEX.CEX_ID
    INNER JOIN HAYA01.CNT_CONTRATOS  CNT ON CNT.CNT_ID=CEX.CNT_ID
    INNER JOIN HAYA01.CPE_CONTRATOS_PERSONAS CPE ON CNT.CNT_ID=CPE.CNT_ID AND CPE.PER_ID=PER.PER_ID
    INNER JOIN HAYA01.DD_TIN_TIPO_INTERVENCION TIN ON TIN.DD_TIN_ID=CPE.DD_TIN_ID
    INNER JOIN MINIREC.PROCEDIMIENTO_JUDICIAL_FOTO FOTO ON FOTO.ID_PROCEDIMIENTO=PRC.PRC_ID
WHERE PRC.PRC_PRC_ID IS NULL
  );
