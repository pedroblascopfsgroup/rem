--Truncado de tablas TDX
TRUNCATE TABLE MINIREC.VAL_HISTORICO_HITOS;

--Generacion de las tablas TDX
INSERT INTO  MINIREC.VAL_HISTORICO_HITOS
(
ASU_ID,
ID_PROCEDIMIENTO,
ENTI ,
ENTIDAD ,
SERVICER ,
HITO_SUJETO ,
HITO_CODIGO,
HITO_DESCR,
FECHA_HITO
)
WITH TAREAS AS(
SELECT TMP.ASU_ID,TMP.TAR_FECHA_INI, TMP.TAP_CODIGO, TMP.TAP_DESCRIPCION,TMP.FECHACREAR FROM 
  (
    SELECT TAR.ASU_ID, TAR.TAR_FECHA_INI,TAR.TAR_ID ,TAP.TAP_CODIGO, TAP.TAP_DESCRIPCION , TEX.FECHACREAR ,ROW_NUMBER () OVER (PARTITION BY TAR.ASU_ID ORDER BY TAR.TAR_ID DESC) N 
    FROM HAYA01.TAR_TAREAS_NOTIFICACIONES TAR
      INNER JOIN HAYA01.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID
      INNER JOIN HAYA01.TAP_TAREA_PROCEDIMIENTO TAP  ON TAP.TAP_ID = TEX.TAP_ID
    WHERE TAR_TAREA_FINALIZADA IS NULL OR TAR_TAREA_FINALIZADA = 0
      AND TEX.TEX_TOKEN_ID_BPM IS NOT NULL
      AND TAP.BORRADO=0
  ) TMP
  WHERE N=1
)
SELECT DISTINCT 
PRC.ASU_ID,
PRC.PRC_ID,
'2038',
'BANKIA',
'HAYA',
NULL,
TARE.TAP_CODIGO,
SUBSTR(TARE.TAP_DESCRIPCION,0,75),
TARE.TAR_FECHA_INI
FROM HAYA01.PRC_PROCEDIMIENTOS PRC
  LEFT JOIN TAREAS TARE ON TARE.ASU_ID=PRC.ASU_ID
INNER JOIN MINIREC.VAL_PROC_JUDICIAL_FOTO FOTO ON FOTO.ID_PROCEDIMIENTO=PRC.PRC_ID
WHERE PRC.PRC_PRC_ID IS NULL
ORDER BY PRC.ASU_ID, TARE.TAP_CODIGO
;

commit;
