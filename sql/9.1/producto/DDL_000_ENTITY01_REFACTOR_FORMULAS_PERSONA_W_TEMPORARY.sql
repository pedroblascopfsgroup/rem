--/*
--##########################################
--## AUTOR=BRUNO ANGLÉS ROBLES
--## FECHA_CREACION=20150927
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=X.X.X_rcXX
--## INCIDENCIA_LINK=PRODUCTO-277
--## PRODUCTO=SI
--## 
--## Finalidad: DML asociado con una refactorización de la clase Persona
--## INSTRUCCIONES: Este scritp debe ser lanzado con el usuario ENTITY
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
DECLARE
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- Numero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_MSQL VARCHAR2(4000 CHAR);

    -- Otras variables

BEGIN

    SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'PER_PERSONAS_FORMULAS';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.PER_PERSONAS_FORMULAS PURGE';
      EXECUTE IMMEDIATE V_MSQL;
    END IF;
    
    V_MSQL := 'CREATE TABLE '||V_ESQUEMA||'.PER_PERSONAS_FORMULAS
                (	PER_ID NUMBER(16,0) NOT NULL ENABLE, 
                EST_CICLO_VIDA VARCHAR2(50 CHAR), 
                DIAS_VENC_RIESGO_DIRECTO NUMBER, 
                DIAS_VENC_RIESGO_INDIRECTO NUMBER, 
                RIESGO_TOTAL NUMBER, 
                RIESGO_TOTAL_DIRECTO NUMBER, 
                RIESGO_TOTAL_INDIRECTO NUMBER, 
                SITUACION_CLIENTE VARCHAR2(50 CHAR), 
                DIAS_VENCIDO NUMBER, 
                NUM_EXP_ACTIVOS NUMBER, 
                NUM_ASU_ACTIVOS NUMBER, 
                NUM_ASU_ACTIVOS_POR_PRC NUMBER, 
                SITUACION VARCHAR2(50 CHAR), 
                RELACION_EXP VARCHAR2(10 BYTE), 
                SERV_NOMINIA_PENSION VARCHAR2(50 CHAR), 
                ULTIMA_ACTUACION VARCHAR2(50 CHAR), 
                DISPUESTO_NO_VENCIDO VARCHAR2(50 CHAR), 
                DISPUESTO_VENCIDO VARCHAR2(50 CHAR), 
                DESC_CNAE VARCHAR2(50 CHAR)
   )';
   EXECUTE IMMEDIATE V_MSQL;
   
   V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_PER_PERS_FORM_PER_ID ON '||V_ESQUEMA||'.PER_PERSONAS_FORMULAS(PER_ID)';
   EXECUTE IMMEDIATE V_MSQL;
   
  --EST_CICLO_VIDA
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_EST_CICLO_VIDA';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_EST_CICLO_VIDA PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;
  
  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_EST_CICLO_VIDA (
    PER_ID                  NUMBER(16) NOT NULL
    ,EST_CICLO_VIDA          VARCHAR2(50 CHAR) 
  )ON COMMIT DELETE ROWS';
  EXECUTE IMMEDIATE V_MSQL;

  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_EST_CIC_VID_PER_ID ON '||V_ESQUEMA||'.TMP_PER_EST_CICLO_VIDA(PER_ID)';
  EXECUTE IMMEDIATE V_MSQL;
  
  
  -- PER_MOV
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_MOV';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_MOV PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;

  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_MOV (
    PER_ID                  NUMBER(16) NOT NULL
    ,MOV_ID          NUMBER(16) NOT NULL
    ,DD_TIN_TITULAR NUMBER(16)
  )ON COMMIT PRESERVE ROWS';
  EXECUTE IMMEDIATE V_MSQL;

  V_MSQL := 'CREATE  INDEX '||V_ESQUEMA||'.IDX_TMP_PER_MOV_PER_ID ON '||V_ESQUEMA||'.TMP_PER_MOV(PER_ID)';
  
  -- MIN_MOV_FECHA_POS_VENCIDA
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_DVENC_RIES_DIREC';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_DVENC_RIES_DIREC PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;
  
  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_DVENC_RIES_DIREC (
    PER_ID                          NUMBER(16) NOT NULL
    ,MIN_MOV_FECHA_POS_VENCIDA      NUMBER 
  )ON COMMIT DELETE ROWS';
  EXECUTE IMMEDIATE V_MSQL;
  
  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_DV_RIES_D_PER_ID ON '||V_ESQUEMA||'.TMP_PER_DVENC_RIES_DIREC(PER_ID)';
  EXECUTE IMMEDIATE V_MSQL;
  
  --DIAS_VENC_RIESGO_INDIRECTO
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_DVENC_RIES_INDIREC';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_DVENC_RIES_INDIREC PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;

  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_DVENC_RIES_INDIREC (
    PER_ID                          NUMBER(16) NOT NULL
    ,DIAS_VENC_RIESGO_INDIRECTO      NUMBER 
  )ON COMMIT DELETE ROWS';
  EXECUTE IMMEDIATE V_MSQL;

  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_DV_RIES_I_PER_ID ON '||V_ESQUEMA||'.TMP_PER_DVENC_RIES_INDIREC(PER_ID)';
  EXECUTE IMMEDIATE V_MSQL;
  
  -- RIESGO_TOTAL
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_RIESGO_TOTAL';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_RIESGO_TOTAL PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;

  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_RIESGO_TOTAL (
    PER_ID                          NUMBER(16) NOT NULL
    ,RIESGO_TOTAL      NUMBER 
  )ON COMMIT DELETE ROWS';
  EXECUTE IMMEDIATE V_MSQL;

  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_RIES_TOTAL_PER_ID ON '||V_ESQUEMA||'.TMP_PER_RIESGO_TOTAL(PER_ID)';   
  EXECUTE IMMEDIATE V_MSQL;
  
  -- RIESGO_TOTAL_DIRECTO
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_RIESGO_TOTAL_DIRECTO';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_RIESGO_TOTAL_DIRECTO PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;

  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_RIESGO_TOTAL_DIRECTO (
    PER_ID                          NUMBER(16) NOT NULL
    ,RIESGO_TOTAL_DIRECTO      NUMBER 
  )ON COMMIT DELETE ROWS';
  EXECUTE IMMEDIATE V_MSQL;

  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_RIES_TOT_D_PER_ID ON '||V_ESQUEMA||'.TMP_PER_RIESGO_TOTAL_DIRECTO(PER_ID)'; 
  EXECUTE IMMEDIATE V_MSQL;
  
  -- RIESGO_TOTAL_INDIRECTO
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_RIESGO_TOTAL_INDIRECTO';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_RIESGO_TOTAL_INDIRECTO PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;

  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_RIESGO_TOTAL_INDIRECTO (
    PER_ID                          NUMBER(16) NOT NULL
    ,RIESGO_TOTAL_INDIRECTO      NUMBER 
  )ON COMMIT DELETE ROWS';
  EXECUTE IMMEDIATE V_MSQL;

  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_RIES_TOT_I_PER_ID ON '||V_ESQUEMA||'.TMP_PER_RIESGO_TOTAL_INDIRECTO(PER_ID)';
  EXECUTE IMMEDIATE V_MSQL;
  
  -- SITUACION_CLIENTE    
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_SITUACION_CLIENTE';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_SITUACION_CLIENTE PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;

  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_SITUACION_CLIENTE (
    PER_ID                  NUMBER(16) NOT NULL
    ,SITUACION_CLIENTE      VARCHAR2(50 CHAR)  
  )ON COMMIT DELETE ROWS';
  EXECUTE IMMEDIATE V_MSQL;

  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_SIT_CLIENTE_PER_ID ON '||V_ESQUEMA||'.TMP_PER_SITUACION_CLIENTE(PER_ID)'; 
  EXECUTE IMMEDIATE V_MSQL;
  
  --DIAS_VENCIDO
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_DIAS_VENCIDO';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_DIAS_VENCIDO PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;

  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_DIAS_VENCIDO (
    PER_ID                  NUMBER(16) NOT NULL
    ,DIAS_VENCIDO   NUMBER 
  )ON COMMIT DELETE ROWS';
  EXECUTE IMMEDIATE V_MSQL;

  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_DIAS_VENC_PER_ID ON '||V_ESQUEMA||'.TMP_PER_DIAS_VENCIDO(PER_ID)';
  EXECUTE IMMEDIATE V_MSQL;
  
  -- NUM_EXP_ACTIVOS
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_NUM_EXP_ACTIVOS';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_NUM_EXP_ACTIVOS PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;

  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_NUM_EXP_ACTIVOS (
    PER_ID                  NUMBER(16) NOT NULL
    ,NUM_EXP_ACTIVOS   NUMBER 
  )ON COMMIT DELETE ROWS'; EXECUTE IMMEDIATE V_MSQL;
  
  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_NUM_EXP_ACT_PER_ID ON '||V_ESQUEMA||'.TMP_PER_NUM_EXP_ACTIVOS(PER_ID)'; EXECUTE IMMEDIATE V_MSQL;
  
  -- NUM_ASU_ACTIVOS
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_NUM_ASU_ACTIVOS';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_NUM_ASU_ACTIVOS PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;

  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_NUM_ASU_ACTIVOS (
    PER_ID                  NUMBER(16) NOT NULL
    ,NUM_ASU_ACTIVOS   NUMBER 
  )ON COMMIT DELETE ROWS'; EXECUTE IMMEDIATE V_MSQL;
  
  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_NUM_ASU_ACT_PER_ID ON '||V_ESQUEMA||'.TMP_PER_NUM_ASU_ACTIVOS(PER_ID)'; EXECUTE IMMEDIATE V_MSQL;

  
-- NUM_ASU_ACTIVOS_POR_PRC
 SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_NUM_ASU_ACT_POR_PRC';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_NUM_ASU_ACT_POR_PRC PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;

  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_NUM_ASU_ACT_POR_PRC(
    PER_ID                  NUMBER(16) NOT NULL
    ,NUM_ASU_ACTIVOS_POR_PRC   NUMBER 
  )ON COMMIT DELETE ROWS'; EXECUTE IMMEDIATE V_MSQL;
  
  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_P_N_AS_A_P_PRC_PER_ID ON '||V_ESQUEMA||'.TMP_PER_NUM_ASU_ACT_POR_PRC(PER_ID)'; EXECUTE IMMEDIATE V_MSQL;

  -- SITUACION
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_SITUACION';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_SITUACION PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;
  
  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_SITUACION(
    PER_ID                  NUMBER(16) NOT NULL
    ,SITUACION   VARCHAR2(50 CHAR) 
  )ON COMMIT DELETE ROWS'; EXECUTE IMMEDIATE V_MSQL;
  
  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_SITUACION_PER_ID ON '||V_ESQUEMA||'.TMP_PER_SITUACION(PER_ID)'; EXECUTE IMMEDIATE V_MSQL;
  
  -- RELACION_EXP
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_RELACION_EXP';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_RELACION_EXP PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;
  
  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_RELACION_EXP (
    PER_ID                  NUMBER(16) NOT NULL
    ,RELACION_EXP   VARCHAR2(50 CHAR) 
  )ON COMMIT DELETE ROWS'; EXECUTE IMMEDIATE V_MSQL;
  
  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_REL_EXP_PER_ID ON '||V_ESQUEMA||'.TMP_PER_RELACION_EXP(PER_ID)'; EXECUTE IMMEDIATE V_MSQL;
  
  -- SERV_NOMINIA_PENSION
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_SERV_NOMINIA_PENSION';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_SERV_NOMINIA_PENSION PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;
  
  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_SERV_NOMINIA_PENSION (
    PER_ID                  NUMBER(16) NOT NULL
    ,SERV_NOMINIA_PENSION   VARCHAR2(50 CHAR) 
  )ON COMMIT DELETE ROWS'; EXECUTE IMMEDIATE V_MSQL;
  
  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_TMP_PER_S_N_P_PER_ID ON '||V_ESQUEMA||'.TMP_PER_SERV_NOMINIA_PENSION(PER_ID)'; EXECUTE IMMEDIATE V_MSQL;
  
  
  -- ULTIMA_ACTUACION
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_ULTIMA_ACTUACION';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_ULTIMA_ACTUACION PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;

  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_ULTIMA_ACTUACION (
    PER_ID                  NUMBER(16) NOT NULL
    ,ULTIMA_ACTUACION   VARCHAR2(50 CHAR) 
  )ON COMMIT DELETE ROWS';
  EXECUTE IMMEDIATE V_MSQL;

  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_ULTIMA_ACT_PER_ID ON '||V_ESQUEMA||'.TMP_PER_ULTIMA_ACTUACION(PER_ID)';
  EXECUTE IMMEDIATE V_MSQL;
  
  -- DISPUESTO_NO_VENCIDO
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_DISPUESTO_NO_VENCIDO';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_DISPUESTO_NO_VENCIDO PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;
  
  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_DISPUESTO_NO_VENCIDO (
    PER_ID                  NUMBER(16) NOT NULL
    ,DISPUESTO_NO_VENCIDO   VARCHAR2(50 CHAR) 
  )ON COMMIT DELETE ROWS'; EXECUTE IMMEDIATE V_MSQL;
  
  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_DISP_NO_VEN_PER_ID ON '||V_ESQUEMA||'.TMP_PER_DISPUESTO_NO_VENCIDO(PER_ID)'; EXECUTE IMMEDIATE V_MSQL;
  
  -- DISPUESTO_VENCIDO
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_DISPUESTO_VENCIDO';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_DISPUESTO_VENCIDO PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;
  
  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_DISPUESTO_VENCIDO (
    PER_ID                  NUMBER(16) NOT NULL
    ,DISPUESTO_VENCIDO   VARCHAR2(50 CHAR) 
  )ON COMMIT DELETE ROWS'; EXECUTE IMMEDIATE V_MSQL;
  
  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_DISP_VEN_PER_ID ON '||V_ESQUEMA||'.TMP_PER_DISPUESTO_VENCIDO(PER_ID)'; EXECUTE IMMEDIATE V_MSQL;
  
  -- DESC_CNAE
  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE OWNER = V_ESQUEMA AND TABLE_NAME = 'TMP_PER_DESC_CNAE';
    IF TABLE_COUNT > 0 THEN
      V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.TMP_PER_DESC_CNAE PURGE';
      EXECUTE IMMEDIATE V_MSQL;
  END IF;
  
  V_MSQL := 'CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_PER_DESC_CNAE (
    PER_ID                  NUMBER(16) NOT NULL
    ,DESC_CNAE   VARCHAR2(50 CHAR) 
  )ON COMMIT DELETE ROWS'; EXECUTE IMMEDIATE V_MSQL;
  
  V_MSQL := 'CREATE INDEX '||V_ESQUEMA||'.IDX_TMP_PER_DESC_CNAE_PER_ID ON '||V_ESQUEMA||'.TMP_PER_DESC_CNAE(PER_ID)'; EXECUTE IMMEDIATE V_MSQL;  
  


 EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;

 

END;
/

EXIT;
