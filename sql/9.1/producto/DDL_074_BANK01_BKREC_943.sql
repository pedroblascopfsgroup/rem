--/*
--##########################################
--## AUTOR=JORGE ROS
--## FECHA_CREACION=20151015
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.1.16-bk
--## INCIDENCIA_LINK=BKREC-943
--## PRODUCTO=SI
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
DECLARE
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA_ENTIDAD#'; -- Configuracion Esquemas
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_COLS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    CUENTA NUMBER(10);  -- Vble. auxiliar para ver si existe el indice a crear.
BEGIN	
  
  -- CREACION DE INDICE EXP_EXPEDIENTES_INDEX_6
  DBMS_OUTPUT.PUT_LINE('INICIO CREATE INDEX '|| V_ESQUEMA ||'.EXP_EXPEDIENTES_INDEX_6...');
  SELECT COUNT(*) INTO CUENTA FROM ALL_INDEXES WHERE INDEX_NAME = 'EXP_EXPEDIENTES_INDEX_6' AND TABLE_OWNER=V_ESQUEMA AND TABLE_NAME='EXP_EXPEDIENTES';    
  IF CUENTA=0 THEN
	  EXECUTE IMMEDIATE 'CREATE INDEX '|| V_ESQUEMA ||'.EXP_EXPEDIENTES_INDEX_6 ON '|| V_ESQUEMA ||'.EXP_EXPEDIENTES (LOWER(EXP_DESCRIPCION) ASC, EXP_ID)';  
     DBMS_OUTPUT.PUT_LINE('CREATE INDEX '|| V_ESQUEMA ||'.EXP_EXPEDIENTES_INDEX_6...Creado');
  ELSE
     DBMS_OUTPUT.PUT_LINE('CREATE INDEX '|| V_ESQUEMA ||'.EXP_EXPEDIENTES_INDEX_6... YA EXISTE');
  END IF;


  -- CREACION DE INDICE ZON_ZONIFICACION_INDEX_3
  DBMS_OUTPUT.PUT_LINE('INICIO CREATE INDEX '|| V_ESQUEMA ||'.ZON_ZONIFICACION_INDEX_3...');
  SELECT COUNT(*) INTO CUENTA FROM ALL_INDEXES WHERE INDEX_NAME = 'ZON_ZONIFICACION_INDEX_3' AND TABLE_OWNER=V_ESQUEMA AND TABLE_NAME='ZON_ZONIFICACION';    
  IF CUENTA=0 THEN
	  EXECUTE IMMEDIATE 'CREATE INDEX '|| V_ESQUEMA ||'.ZON_ZONIFICACION_INDEX_3 ON '|| V_ESQUEMA ||'.ZON_ZONIFICACION (SUBSTR(ZON_COD, 1, 2))';  
     DBMS_OUTPUT.PUT_LINE('CREATE INDEX '|| V_ESQUEMA ||'.ZON_ZONIFICACION_INDEX_3...Creado');
  ELSE
     DBMS_OUTPUT.PUT_LINE('CREATE INDEX '|| V_ESQUEMA ||'.ZON_ZONIFICACION_INDEX_3... YA EXISTE');
  END IF;


  -- CREACION DE INDICE PERSONAS_EXPEDIENTE_INDEX_3
  DBMS_OUTPUT.PUT_LINE('INICIO CREATE INDEX '|| V_ESQUEMA ||'.PEX_PERSONAS_EXPE_INDEX_3...');
  SELECT COUNT(*) INTO CUENTA FROM ALL_INDEXES WHERE INDEX_NAME = 'PEX_PERSONAS_EXPE_INDEX_3' AND TABLE_OWNER=V_ESQUEMA AND TABLE_NAME='PEX_PERSONAS_EXPEDIENTE';    
  IF CUENTA=0 THEN
	  EXECUTE IMMEDIATE 'CREATE INDEX '|| V_ESQUEMA ||'.PEX_PERSONAS_EXPE_INDEX_3 ON '|| V_ESQUEMA ||'.PEX_PERSONAS_EXPEDIENTE (PEX_PASE, EXP_ID)';  
     DBMS_OUTPUT.PUT_LINE('CREATE INDEX '|| V_ESQUEMA ||'.PEX_PERSONAS_EXPE_INDEX_3...Creado');
  ELSE
     DBMS_OUTPUT.PUT_LINE('CREATE INDEX '|| V_ESQUEMA ||'.PEX_PERSONAS_EXPE_INDEX_3... YA EXISTE');
  END IF;	

EXCEPTION
  WHEN OTHERS THEN
    ERR_NUM := SQLCODE;
    ERR_MSG := SQLERRM;
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(ERR_MSG);
    ROLLBACK;
    RAISE;   
END;
/

EXIT;
