--/*
--##########################################
--## AUTOR=LUIS RUIZ
--## FECHA_CREACION=20160212
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.1.19
--## INCIDENCIA_LINK=BKREC-1285
--## PRODUCTO=SI
--##
--## Finalidad:
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##        0.2 Filtramos entrada a _CNT_DET_EFICACIA_MES EFI a mes vencido.
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
CREATE OR REPLACE PROCEDURE RERA_CALCULO_RAS_RANKING AUTHID CURRENT_USER AS

     V_FCFIN  TIMESTAMP;

BEGIN

    --** Calculamos porcentaje de recuperación
    DELETE FROM #ESQUEMA#.TMP_RAS_RANKING_SUBCARTERA_POR;
    COMMIT;

    INSERT INTO #ESQUEMA#.TMP_RAS_RANKING_SUBCARTERA_POR
    SELECT MES_ID,
      ESQUEMA_ER_ID,
      SUBCARTERA_ER_ID,
      AGENCIA_ER_ID,
      SUM(NVL(ER_IMPORTE_COBRO,0))             AS TOT_IMPORTE_COBRO,
      SUM(NVL(ER_DEUDA_IRREGULAR_STOCK_INI,0)) AS TOT_DEUDA_IRREGULAR_STOCK_INI,
      SUM(NVL(ER_DEUDA_IRREGULAR_ENTRADAS,0))  AS TOT_DEUDA_IRREGULAR_ENTRADAS,
      decode((SUM(NVL(ER_DEUDA_IRREGULAR_STOCK_INI,0)) + SUM(NVL(ER_DEUDA_IRREGULAR_ENTRADAS,0))),0,0,
       (SUM(NVL(ER_IMPORTE_COBRO,0)) / (SUM(NVL(ER_DEUDA_IRREGULAR_STOCK_INI,0)) + SUM(NVL(ER_DEUDA_IRREGULAR_ENTRADAS,0)))) *100) AS TOT_PORCENTAJE
    FROM RECOVERY_BANKIA_DWH.H_CNT_DET_EFICACIA_MES EFI
       , (SELECT DISTINCT 'RAS' ORIGEN, TO_CHAR(FECHA_HIST,'YYYYMM') AS FECHA_HIST FROM #ESQUEMA#.H_RAS_RANKING_SUBCARTERA) RAS
    WHERE TRIM(TO_CHAR(MES_ID,'000000')) = FECHA_HIST(+) AND ORIGEN IS NULL
      AND TRIM(TO_CHAR(MES_ID,'000000')) <> TO_CHAR(SYSDATE,'YYYYMM') --filtramos mes en curso
    GROUP BY MES_ID,
      ESQUEMA_ER_ID,
      SUBCARTERA_ER_ID,
      AGENCIA_ER_ID;
    COMMIT;

    #ESQUEMA#.OPERACION_DDL.DDL_TABLE('STATS','TMP_RAS_RANKING_SUBCARTERA_POR');


    --** Calculamos ranking e Historificamos
    INSERT INTO #ESQUEMA#.H_RAS_RANKING_SUBCARTERA
    (FECHA_HIST, H_RAS_ID, RAS_ID, RCF_SCA_ID, RCF_AGE_ID, RAS_POSICION, RAS_PORCENTAJE, VERSION, USUARIOCREAR, FECHACREAR)
    SELECT last_day(to_date(TRIM(TO_CHAR(MES_ID,'000000')),'yyyymm')),
      #ESQUEMA#.S_H_RAS_RANKING_SUBCARTERA.NEXTVAL,
      #ESQUEMA#.S_RAS_RANKING_SUBCARTERA.NEXTVAL,
      SUBCARTERA_ER_ID,
      agencia_er_id,
      rank() over (partition BY mes_id, ESQUEMA_ER_ID, SUBCARTERA_ER_ID order by TOT_PORCENTAJE DESC) ranking,
      TOT_PORCENTAJE,
      0, 'REC-BATCH', SYSDATE
    FROM #ESQUEMA#.TMP_RAS_RANKING_SUBCARTERA_POR
    WHERE TOT_PORCENTAJE > 0;
    COMMIT;

    #ESQUEMA#.OPERACION_DDL.DDL_TABLE('STATS','H_RAS_RANKING_SUBCARTERA');
    -- Vemos cual es el ultimo mes
    SELECT MAX(FECHA_HIST) INTO V_FCFIN FROM #ESQUEMA#.H_RAS_RANKING_SUBCARTERA;

    --** Calculamos y guardamos ranking por agencia-subcartera del ultimo mes
    DELETE #ESQUEMA#.RAS_RANKING_SUBCARTERA;
    COMMIT;

    INSERT INTO #ESQUEMA#.RAS_RANKING_SUBCARTERA
    ( RAS_ID, RCF_SCA_ID, RCF_AGE_ID, RAS_POSICION, RAS_PORCENTAJE, VERSION, USUARIOCREAR, FECHACREAR)
    SELECT  RAS_ID, RCF_SCA_ID, RCF_AGE_ID, RAS_POSICION, RAS_PORCENTAJE, VERSION, USUARIOCREAR, FECHACREAR
    FROM #ESQUEMA#.H_RAS_RANKING_SUBCARTERA
    WHERE FECHA_HIST = V_FCFIN;
    COMMIT;

    #ESQUEMA#.OPERACION_DDL.DDL_TABLE('STATS','RAS_RANKING_SUBCARTERA');
    COMMIT;

EXCEPTION
     WHEN OTHERS THEN

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------');
          DBMS_OUTPUT.put_line(SQLERRM);

          ROLLBACK;
          RAISE;

END RERA_CALCULO_RAS_RANKING;
/

EXIT;
