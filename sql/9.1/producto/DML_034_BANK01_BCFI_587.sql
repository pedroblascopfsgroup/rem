--/*
--##########################################
--## AUTOR=ALBERTO RAMÍREZ LOSILLA
--## FECHA_CREACION=20150630
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.1
--## INCIDENCIA_LINK=BCFI-587
--## PRODUCTO=SI
--## Finalidad: Adaptar el script de bruno para crear los registros relacionados con ciclo de recobro
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_COUNT NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  V_NUM_AGENCIAS NUMBER;
  V_RCF_SCA_ID NUMBER;
  
  -- Constantes
  C_CODIGO_ESTADO_ESQUEMA VARCHAR2(5 CHAR);
  C_DESCRIPCION_ESTADO_ESQUEMA VARCHAR2(30 CHAR);
  C_NOMBRE_ESQUEMA VARCHAR2(30 CHAR);
  C_USERNAME_USUARIO_ESQUEMA VARCHAR2(30 CHAR);
  C_NOMBRE_CARTERA VARCHAR2(30 CHAR);
  C_NOMBRE_SUBCARTERA VARCHAR2(30 CHAR);
  C_ITINERARIO_METAS_VOLANTES VARCHAR2(50 CHAR);
  
BEGIN
	
  DBMS_OUTPUT.PUT_LINE('[INICIO] ');
  
  -- Estado para el equema de recobro
  C_CODIGO_ESTADO_ESQUEMA:= '''MAN''';
  C_DESCRIPCION_ESTADO_ESQUEMA:= '''Esquema manual''';
  
  --Esquema de recobro
  C_NOMBRE_ESQUEMA:= '''Expedientes manuales''';
  C_USERNAME_USUARIO_ESQUEMA:= '''A121671''';
  
  -- Cartera
  C_NOMBRE_CARTERA:= '''EXPEDIENTES MANUALES''';
  
  -- Subcartera
  C_NOMBRE_SUBCARTERA:= '''EXPEDIENTES MANUALES''';
  C_ITINERARIO_METAS_VOLANTES:= '''MODELO DE METAS VOLANTES INICIAL''';
  
  ------------------------
  -- Empiezan los inserts
  ------------------------
  
    --Estado del esquema
  DBMS_OUTPUT.PUT_LINE('[INFO]: Insertando estado esquema...');
  
  V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.RCF_DD_EES_ESTADO_ESQUEMA WHERE RCF_DD_EES_CODIGO = '||C_CODIGO_ESTADO_ESQUEMA;
  EXECUTE IMMEDIATE V_SQL INTO V_COUNT;
  
  IF (V_COUNT = 0) THEN
    V_MSQL := 'Insert into '||V_ESQUEMA||'.RCF_DD_EES_ESTADO_ESQUEMA (RCF_DD_EES_ID,RCF_DD_EES_CODIGO,RCF_DD_EES_DESCRIPCION,RCF_DD_EES_DESCRIPCION_LARGA
      ,VERSION,USUARIOCREAR,FECHACREAR,USUARIOMODIFICAR,FECHAMODIFICAR,USUARIOBORRAR,FECHABORRAR,BORRADO) 
    values 
    ('||V_ESQUEMA||'.S_RCF_DD_EES_ESTADO_ESQUEMA.NEXTVAL,'||C_CODIGO_ESTADO_ESQUEMA||','||C_DESCRIPCION_ESTADO_ESQUEMA||','||C_DESCRIPCION_ESTADO_ESQUEMA||',''0'',''BCFI-587''
      ,SYSDATE,null,null,null,null,''0'')';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('[INFO]: Estado esquema insertado.');
  ELSE
  	DBMS_OUTPUT.PUT_LINE('[INFO]: Ya existe el estado esquema.');
  END IF;
  
  -- Esquema de recobro
  
  DBMS_OUTPUT.PUT_LINE('[INFO]: Insertando esquema...');
  
  V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.RCF_ESQ_ESQUEMA WHERE RCF_ESQ_NOMBRE = '||C_NOMBRE_ESQUEMA;
  EXECUTE IMMEDIATE V_SQL INTO V_COUNT;

  IF (V_COUNT = 0) THEN
    V_MSQL:= 'Insert into '||V_ESQUEMA||'.RCF_ESQ_ESQUEMA (RCF_ESQ_ID,RCF_ESQ_NOMBRE,RCF_ESQ_DESCRIPCION
        , RCF_DD_EES_ID
        , RCF_ESQ_FECHA_ALTA, RCF_ESQ_FECHA_LIB, RCF_ESQ_FECHA_FIN_TRANSICION, RCF_FECHA_DESACT, RCF_ESQ_ID_ANTERIOR, RCF_ESQ_ID_SIGUIENTE, RCF_DD_MTR_ID, RCF_ESQ_PLAZO
        , USU_ID
        , RCF_ID_GRUPO_VERSION, RCF_VERSION, RCF_MAJOR_RELEASE, RCF_MINOR_RELEASE
        ,VERSION,USUARIOCREAR,FECHACREAR,USUARIOMODIFICAR,FECHAMODIFICAR,USUARIOBORRAR,FECHABORRAR,BORRADO
    ) values (
      '||V_ESQUEMA||'.S_RCF_ESQ_ESQUEMA.NEXTVAL,'||C_NOMBRE_ESQUEMA||','||C_NOMBRE_ESQUEMA||'
      ,(SELECT RCF_DD_EES_ID FROM '||V_ESQUEMA||'.RCF_DD_EES_ESTADO_ESQUEMA WHERE RCF_DD_EES_CODIGO = '||C_CODIGO_ESTADO_ESQUEMA||')
      ,SYSDATE,null,null,null,null,null,NULL, NULL
      , (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = '||C_USERNAME_USUARIO_ESQUEMA||')
      , '||V_ESQUEMA||'.S_RCF_ESQ_ESQUEMA.CURRVAL, ''1'',''0'',''0''
      ,''0'',''BCFI-587'',SYSDATE,NULL,NULL,null,null,''0''
    )';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('[INFO]: Esquema insertado.');
  ELSE
  	DBMS_OUTPUT.PUT_LINE('[INFO]: Ya existe el esquema.');
  END IF;
  
  --Cartera
  DBMS_OUTPUT.PUT_LINE('[INFO]: Insertando cartera...');

  
  V_SQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.RCF_CAR_CARTERA WHERE RCF_CAR_NOMBRE = '||C_NOMBRE_CARTERA;
  EXECUTE IMMEDIATE V_SQL INTO V_COUNT;
  
  IF (V_COUNT = 0) THEN
    V_MSQL:= 'Insert into '||V_ESQUEMA||'.RCF_CAR_CARTERA (RCF_CAR_ID, RCF_CAR_NOMBRE, RCF_CAR_DESCRIPCION ,RD_ID
      , RCF_DD_ECM_ID
      , RCF_CAR_FECHA_ALTA
      , USU_ID
      ,VERSION,USUARIOCREAR,FECHACREAR,USUARIOMODIFICAR,FECHAMODIFICAR,USUARIOBORRAR,FECHABORRAR,BORRADO
    ) values (
      '||V_ESQUEMA||'.S_RCF_CAR_CARTERA.NEXTVAL,'||C_NOMBRE_CARTERA||','||C_NOMBRE_CARTERA||',1
      , (SELECT RCF_DD_ECM_ID FROM '||V_ESQUEMA||'.RCF_DD_ECM_ESTADO_COMPONENT WHERE RCF_DD_ECM_CODIGO = ''BLQ'')
      , SYSDATE
      , (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = '||C_USERNAME_USUARIO_ESQUEMA||')
      , ''0'',''BCFI-587'',SYSDATE,NULL,NULL,null,null,''0'')';
   EXECUTE IMMEDIATE V_MSQL;
   DBMS_OUTPUT.PUT_LINE('[INFO]: Cartera insertado.');
  ELSE
  	DBMS_OUTPUT.PUT_LINE('[INFO]: Ya existe la cartera.');
  END IF;
  
  -- Esquema / Cartera
  DBMS_OUTPUT.PUT_LINE('[INFO]: Insertando Esquema / Cartera...');
  
  V_SQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.RCF_ESC_ESQUEMA_CARTERAS WHERE
    RCF_ESQ_ID = (SELECT RCF_ESQ_ID FROM '||V_ESQUEMA||'.RCF_ESQ_ESQUEMA WHERE RCF_ESQ_NOMBRE = '||C_NOMBRE_ESQUEMA||')
    AND RCF_CAR_ID = (SELECT RCF_CAR_ID FROM '||V_ESQUEMA||'.RCF_CAR_CARTERA WHERE RCF_CAR_NOMBRE = '||C_NOMBRE_CARTERA||')';
  EXECUTE IMMEDIATE V_SQL INTO V_COUNT;
    
  IF (V_COUNT = 0) THEN
    V_MSQL:= 'Insert into '||V_ESQUEMA||'.RCF_ESC_ESQUEMA_CARTERAS (RCF_ESC_ID
      , RCF_ESQ_ID
      , RCF_CAR_ID
      , DD_TCE_ID
      , RCF_ESC_PRIORIDAD
      , DD_TGC_ID
      , DD_AER_ID,VERSION,USUARIOCREAR,FECHACREAR,USUARIOMODIFICAR,FECHAMODIFICAR,USUARIOBORRAR,FECHABORRAR,BORRADO
      ) values (
        '||V_ESQUEMA||'.S_RCF_ESC_ESQUEMA_CARTERAS.NEXTVAL
        ,(SELECT RCF_ESQ_ID FROM '||V_ESQUEMA||'.RCF_ESQ_ESQUEMA WHERE RCF_ESQ_NOMBRE = '||C_NOMBRE_ESQUEMA||')
        ,(SELECT RCF_CAR_ID FROM '||V_ESQUEMA||'.RCF_CAR_CARTERA WHERE RCF_CAR_NOMBRE = '||C_NOMBRE_CARTERA||')
        ,(SELECT DD_TCE_ID FROM '||V_ESQUEMA||'.RCF_DD_TCE_TIPO_CARTERA_ESQ WHERE DD_TCE_CODIGO = ''GES'')
        ,''1''
        ,(SELECT DD_TGC_ID FROM '||V_ESQUEMA||'.RCF_DD_TGC_TIPO_GESTION_CART WHERE DD_TGC_CODIGO = ''GC'')
        ,null,''0'',''BCFI-587'',SYSDATE,null,null,null,null,''0'')';
  	EXECUTE IMMEDIATE V_MSQL;
  	DBMS_OUTPUT.PUT_LINE('[INFO]: Cartera / Esquema insertada.');
  ELSE
  	DBMS_OUTPUT.PUT_LINE('[INFO]: Ya exite la Cartera / Esquema.');
  END IF;
  
  -- Subcartera
  DBMS_OUTPUT.PUT_LINE('[INFO]: Insertando SubCartera...');
  
  V_SQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.RCF_SCA_SUBCARTERA WHERE RCF_ESC_ID IN (
    SELECT RCF_ESC_ID 
    FROM '||V_ESQUEMA||'.RCF_ESC_ESQUEMA_CARTERAS 
    WHERE RCF_ESQ_ID = (SELECT RCF_ESQ_ID FROM '||V_ESQUEMA||'.RCF_ESQ_ESQUEMA WHERE RCF_ESQ_NOMBRE = '||C_NOMBRE_ESQUEMA||')
      AND RCF_CAR_ID = (SELECT RCF_CAR_ID FROM '||V_ESQUEMA||'.RCF_CAR_CARTERA WHERE RCF_CAR_NOMBRE = '||C_NOMBRE_CARTERA||')
  )';
  EXECUTE IMMEDIATE V_SQL INTO V_COUNT;
  
  IF (V_COUNT = 0) THEN
    V_MSQL := 'Insert into '||V_ESQUEMA||'.RCF_SCA_SUBCARTERA (RCF_SCA_ID
      , RCF_ESC_ID
      , RCF_SCA_NOMBRE, RCF_SCA_PARTICION
      , RCF_DD_TPR_ID
      ,RCF_ITV_ID
      , RCF_MFA_ID, RCF_POA_ID, RCF_MOR_ID,VERSION,USUARIOCREAR,FECHACREAR,USUARIOMODIFICAR,FECHAMODIFICAR,USUARIOBORRAR,FECHABORRAR,BORRADO
    ) values (
      '||V_ESQUEMA||'.S_RCF_SCA_SUBCARTERA.NEXTVAL
      ,(SELECT RCF_ESC_ID 
          FROM '||V_ESQUEMA||'.RCF_ESC_ESQUEMA_CARTERAS 
          WHERE RCF_ESQ_ID = (SELECT RCF_ESQ_ID FROM '||V_ESQUEMA||'.RCF_ESQ_ESQUEMA WHERE RCF_ESQ_NOMBRE = '||C_NOMBRE_ESQUEMA||')
            AND RCF_CAR_ID = (SELECT RCF_CAR_ID FROM '||V_ESQUEMA||'.RCF_CAR_CARTERA WHERE RCF_CAR_NOMBRE = '||C_NOMBRE_CARTERA||')
        )
      ,'||C_NOMBRE_SUBCARTERA||',''100''
      ,(SELECT RCF_DD_TPR_ID FROM '||V_ESQUEMA||'.RCF_DD_TPR_TIPO_REPARTO_SUBC WHERE RCF_DD_TPR_CODIGO = ''EST'')
      , (SELECT RCF_ITV_ID FROM '||V_ESQUEMA||'.RCF_ITV_ITI_METAS_VOLANTES WHERE RCF_ITV_NOMBRE = '||C_ITINERARIO_METAS_VOLANTES||')
      , NULL, NULL, NULL, ''0'', ''BCFI-587'', SYSDATE, NULL, NULL,null,null,''0'')';
 
 	EXECUTE IMMEDIATE V_MSQL;
  	DBMS_OUTPUT.PUT_LINE('[INFO]: SubCartera insertada.');     
 ELSE
 	DBMS_OUTPUT.PUT_LINE('[INFO]: Ya existe la SubCartera.');     
 END IF;
      
    -- Subcartera / Agencias
  DBMS_OUTPUT.PUT_LINE('[INFO]: Insertando SubCartera / Agencia...');
  
  V_SQL:= 'SELECT RCF_SCA_ID FROM '||V_ESQUEMA||'.RCF_SCA_SUBCARTERA WHERE RCF_ESC_ID IN (
        SELECT RCF_ESC_ID 
        FROM '||V_ESQUEMA||'.RCF_ESC_ESQUEMA_CARTERAS 
        WHERE RCF_ESQ_ID = (SELECT RCF_ESQ_ID FROM '||V_ESQUEMA||'.RCF_ESQ_ESQUEMA WHERE RCF_ESQ_NOMBRE = '||C_NOMBRE_ESQUEMA||')
          AND RCF_CAR_ID = (SELECT RCF_CAR_ID FROM '||V_ESQUEMA||'.RCF_CAR_CARTERA WHERE RCF_CAR_NOMBRE = '||C_NOMBRE_CARTERA||')
  )';
  EXECUTE IMMEDIATE V_SQL INTO V_RCF_SCA_ID;
    
  V_SQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.RCF_SUA_SUBCARTERA_AGENCIAS WHERE RCF_SCA_ID = '||V_RCF_SCA_ID;
  EXECUTE IMMEDIATE V_SQL INTO V_COUNT;
  
  V_SQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.RCF_AGE_AGENCIAS WHERE BORRADO = 0';
  EXECUTE IMMEDIATE V_SQL INTO V_NUM_AGENCIAS;  
  
  IF (V_COUNT <> V_NUM_AGENCIAS) THEN
      V_MSQL:= 'INSERT INTO '||V_ESQUEMA||'.RCF_SUA_SUBCARTERA_AGENCIAS (RCF_SUA_ID, RCF_AGE_ID, RCF_SCA_ID, RCF_SUA_COEFICIENTE, VERSION, USUARIOCREAR, FECHACREAR, BORRADO)
      SELECT '||V_ESQUEMA||'.S_RCF_SUA_SUBCARTERA_AGENCIAS.NEXTVAL, AGE.RCF_AGE_ID
        , '||V_RCF_SCA_ID||'
        , 0, 0, ''BCFI-587'', SYSDATE, 0
      FROM '||V_ESQUEMA||'.RCF_AGE_AGENCIAS AGE
      WHERE NOT EXISTS (
        SELECT 1 FROM '||V_ESQUEMA||'.RCF_SUA_SUBCARTERA_AGENCIAS WHERE RCF_AGE_ID = AGE.RCF_AGE_ID AND RCF_SCA_ID = '||V_RCF_SCA_ID||'
      )';
      
     EXECUTE IMMEDIATE V_MSQL;
     DBMS_OUTPUT.PUT_LINE('[INFO]: SubCartera / Agencia insertada'); 
      
  ELSE
     DBMS_OUTPUT.PUT_LINE('[INFO]: Ya existe la SubCartera / Agencia');
  
  END IF;
  ----------------------
  -- Fin de los inserts
  -----------------------
 
  COMMIT;
  DBMS_OUTPUT.PUT_LINE('[FIN] ');
  
  EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
	END;
/
EXIT;