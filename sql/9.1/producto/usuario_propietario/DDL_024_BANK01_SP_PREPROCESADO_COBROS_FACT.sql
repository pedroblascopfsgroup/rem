--/*
--##########################################
--## AUTOR=Rubén Rovira
--## FECHA_CREACION=20151027
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.2
--## INCIDENCIA_LINK=BKREC-58
--## PRODUCTO=NO
--## 
--## Finalidad: 
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;

create or replace PROCEDURE PREPROCESADO_COBROS_FACT AUTHID CURRENT_USER 
AS
      V_LAST_BATCH_EXECUTION DATE;
      V_LAST_DATE_PREPROCESS DATE;

    BEGIN

      IF TO_CHAR(SYSDATE,'HH24:MM:SS') BETWEEN '00:00:00' AND '18:00:00'
       THEN V_LAST_BATCH_EXECUTION := TRUNC(SYSDATE-1);
       ELSE V_LAST_BATCH_EXECUTION := TRUNC(SYSDATE);
      END IF;

      SELECT TRUNC(MAX(CCR_FECHA)) INTO V_LAST_DATE_PREPROCESS FROM #ESQUEMA#.CCR_CONTROL_COBROS_RECOBRO;

      IF (V_LAST_DATE_PREPROCESS IS NULL) THEN
        SELECT V_LAST_BATCH_EXECUTION - 1 INTO V_LAST_DATE_PREPROCESS FROM DUAL;
      END IF;
      DBMS_OUTPUT.PUT_LINE('Ultima fecha preprocesado Cobros: '||V_LAST_DATE_PREPROCESS);

      V_LAST_DATE_PREPROCESS := V_LAST_DATE_PREPROCESS + 1;
      DBMS_OUTPUT.PUT_LINE('Procesando cobros del dia: '||V_LAST_DATE_PREPROCESS||' al dia: '||V_LAST_BATCH_EXECUTION);

      INSERT INTO #ESQUEMA#.CPR_COBROS_PAGOS_RECOBRO
          (CPR_ID, CPA_ID, CPA_FECHA, CNT_ID, EXP_ID, RCF_AGE_ID, RCF_SCA_ID, FECHA_INI_IRREGU, FECHA_POS_VENCIDA)
        WITH DIAS AS (
              SELECT /*+ MATERIALIZE */ DISTINCT TRUNC(FECHA_HIST) FECHA_HIST FROM #ESQUEMA#.H_REC_FICHERO_CONTRATOS WHERE TRUNC(FECHA_HIST) <> TO_DATE('14/11/2014','dd/MM/yyyy'))
           , CPA_FECHA_HIST AS (
              SELECT /*+ MATERIALIZE */ CPA.CPA_ID, MAX(TRUNC(D.FECHA_HIST)) FECHA_REPARTO
              FROM #ESQUEMA#.CPA_COBROS_PAGOS CPA
                JOIN DIAS D ON TRUNC(CPA.CPA_FECHA_VALOR) >= TRUNC(D.FECHA_HIST)
              WHERE TRUNC(CPA.FECHACREAR) BETWEEN V_LAST_DATE_PREPROCESS AND V_LAST_BATCH_EXECUTION
              GROUP BY CPA.CPA_ID)
           , VALORES AS (
              SELECT /*+ MATERIALIZE */ DISTINCT
                  CPA.CPA_ID,
                  CPA_FECHA_VALOR,
                  CPA.CNT_ID, CRE.EXP_ID, HREC.RCF_AGE_ID, CRE.RCF_SCA_ID,
                  HREC.FECHA_INI_IRREGU, HREC.FECHA_POS_VENCIDA
              FROM #ESQUEMA#.CPA_COBROS_PAGOS CPA
                INNER JOIN CPA_FECHA_HIST ON CPA.CPA_ID = CPA_FECHA_HIST.CPA_ID
                INNER JOIN #ESQUEMA#.H_REC_FICHERO_CONTRATOS HREC ON CPA.CNT_ID = SUBSTR(HREC.ID_ENVIO,9)
                  AND TRUNC(HREC.FECHA_HIST) =  TRUNC(CPA_FECHA_HIST.FECHA_REPARTO)
                INNER JOIN #ESQUEMA#.CRC_CICLO_RECOBRO_CNT CRC ON CPA.CNT_ID = CRC.CNT_ID
                  AND HREC.ID_ENVIO = CRC.CRC_ID_ENVIO
                  AND TRUNC(CPA.CPA_FECHA_VALOR)  BETWEEN TRUNC(CRC.CRC_FECHA_ALTA) AND (TRUNC(NVL(CRC.CRC_FECHA_BAJA,SYSDATE))-1)
                  AND CRC.BORRADO = 0
                INNER JOIN #ESQUEMA#.CRE_CICLO_RECOBRO_EXP CRE ON CRC.CRE_ID = CRE.CRE_ID
                  AND CRE.RCF_SCA_ID = HREC.RCF_SCA_ID AND CRE.RCF_AGE_ID = HREC.RCF_AGE_ID
                  AND CRE.BORRADO = 0
              WHERE CPA.BORRADO = 0 AND CPA.CPA_COBRO_FACTURABLE = 1 AND TRUNC(CPA.FECHACREAR) BETWEEN V_LAST_DATE_PREPROCESS AND V_LAST_BATCH_EXECUTION )
      SELECT #ESQUEMA#.S_CPR_COBROS_PAGOS_RECOBRO.NEXTVAL CPR_ID, VALORES.* FROM VALORES;

      WHILE V_LAST_DATE_PREPROCESS <= V_LAST_BATCH_EXECUTION
      LOOP

        INSERT INTO #ESQUEMA#.CCR_CONTROL_COBROS_RECOBRO (CCR_ID, CCR_FECHA)
        VALUES (#ESQUEMA#.S_CCR_CONTROL_COBROS_RECOBRO.NEXTVAL, V_LAST_DATE_PREPROCESS);

        V_LAST_DATE_PREPROCESS:=V_LAST_DATE_PREPROCESS + 1;

      END LOOP;

      COMMIT;

    EXCEPTION
      WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('ERROR: '||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.PUT_LINE(SQLERRM);
        ROLLBACK;
        RAISE;

    END PREPROCESADO_COBROS_FACT;
/

EXIT;
