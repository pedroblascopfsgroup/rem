--/*
--#########################################
--## AUTOR=DAVID GONZALEZ
--## FECHA_CREACION=20160706
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-661
--## PRODUCTO=NO
--## 
--## Finalidad: Merge entre TMP_GESTORES_PROVINCIAS y ACT_GES_DISTRIBUCION.
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

	V_MSQL VARCHAR2(32000 CHAR); 
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; 
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';
	V_SQL VARCHAR2(4000 CHAR);
	V_NUM NUMBER(16);
	ERR_NUM NUMBER(25);  
	ERR_MSG VARCHAR2(1024 CHAR); 

BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INICIO DEL PROCESO.');
  
  --NUEVA PROVINCIA-ACTIVOS A GESTIONAR; MELILLA, NATALIA HORCAJO GAVIRA
  EXECUTE IMMEDIATE '
  SELECT COUNT(*) FROM '||V_ESQUEMA||'.ACT_GES_DISTRIBUCION WHERE COD_PROVINCIA = ''52'' AND PROVINCIA = ''MELILLA''
  '
  INTO V_NUM
  ;
  
  IF V_NUM < 1 THEN
    EXECUTE IMMEDIATE'
    INSERT INTO '||V_ESQUEMA||'.ACT_GES_DISTRIBUCION (
      COD_PROVINCIA,
      PROVINCIA,
      COD_MUNICIPIO,
      MUNICIPIO,
      COD_POSTAL,
      USUARIO_GESTION_ACTIVOS,
      NOMBRE_GESTION_ACTIVOS,
      VERSION,
      USUARIOCREAR,
      FECHACREAR,
      USUARIOMODIFICAR,
      FECHAMODIFICAR,
      USUARIOBORRAR,
      FECHABORRAR,
      BORRADO
    ) VALUES (
      ''52'',
      ''MELILLA'',
      NULL,
      NULL,
      NULL,
      NULL,
      NULL,
      0,
      ''HREOS-661'',
      SYSDATE,
      NULL,
      NULL,
      NULL,
      NULL,
      0
      )
    '
    ;
  END IF;
	
	--GESTORES QUE HAN CAMBIADO Y QUE MODIFICAREMOS
	EXECUTE IMMEDIATE '
	MERGE INTO '||V_ESQUEMA||'.ACT_GES_DISTRIBUCION GES USING
	(
		SELECT 
		GES.COD_PROVINCIA, 
		GES.PROVINCIA, 
		GES.COD_MUNICIPIO, 
		GES.MUNICIPIO, 
		GES.COD_POSTAL, 
		GES.USUARIO_GESTION_ACTIVOS, 
		GES.NOMBRE_GESTION_ACTIVOS, 
		TMP.USUARIO_GESTION_ACTIVOS AS USUARIO_NUEVO, 
		TMP.NOMBRE_GESTION_ACTIVOS AS NOMBRE_NUEVO
		FROM '||V_ESQUEMA||'.ACT_GES_DISTRIBUCION GES 
		INNER JOIN '||V_ESQUEMA||'.TMP_GESTORES_PROVINCIAS TMP 
		  ON TMP.COD_PROVINCIA = GES.COD_PROVINCIA
		WHERE GES.COD_MUNICIPIO IS NULL
		AND GES.COD_POSTAL IS NULL
		AND (GES.USUARIO_GESTION_ACTIVOS != TMP.USUARIO_GESTION_ACTIVOS
      OR (GES.USUARIO_GESTION_ACTIVOS IS NULL AND TMP.USUARIO_GESTION_ACTIVOS IS NOT NULL))
	) TMP
	ON (GES.COD_PROVINCIA = TMP.COD_PROVINCIA) 
	WHEN MATCHED THEN UPDATE SET
	GES.USUARIO_GESTION_ACTIVOS = TMP.USUARIO_NUEVO,
	GES.NOMBRE_GESTION_ACTIVOS = TMP.NOMBRE_NUEVO,
	USUARIOMODIFICAR = ''HREOS-661'',
	FECHAMODIFICAR = SYSDATE
	WHERE GES.COD_MUNICIPIO IS NULL
	AND GES.COD_POSTAL IS NULL
	'
	;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] '||SQL%ROWCOUNT||' GESTORES ACTUALIZADOS EN ACT_GES_DISTRIBUCION.');
	
	--COMMIT;
	
EXCEPTION

   WHEN OTHERS THEN
   
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;
/

EXIT
