--/*
--###########################################
--## AUTOR=Teresa Alonso
--## FECHA_CREACION=20170511
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-2022
--## PRODUCTO=NO
--## 
--## Finalidad: Re-asignar gestores de activo (por numero activo) al gestor adelaroja 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

BEGIN	

	DBMS_OUTPUT.PUT_LINE('[INICIO] COMIENZA EL PROCESO PARA LA RE-ASIGNACIÓN DE GESTORES PARA ');
	DBMS_OUTPUT.PUT_LINE('         ACTIVOS ASIGNADOS POR DEFECTO A OTRO GESTOR'||CHR(10));
	
	EXECUTE IMMEDIATE '
	SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''TMP_GEST_ACT'' AND OWNER = '''||V_ESQUEMA||'''
	'
	INTO V_NUM
	;
	
	IF V_NUM > 0 THEN
  
    EXECUTE IMMEDIATE '
		TRUNCATE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
	
		EXECUTE IMMEDIATE '
		DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
		
	END IF;

	EXECUTE IMMEDIATE '
	CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_GEST_ACT ON COMMIT PRESERVE ROWS AS (
	
	SELECT
	GEE_ID,
	GESTOR_CORRECTO,
	DD_TGE_ID,
	'||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL AS GEH_ID,
	ACT_ID
	FROM (
	
		SELECT DISTINCT
		GEE.GEE_ID,
		GEE.DD_TGE_ID,
		GES.USUARIO_GESTION_ACTIVOS AS GESTOR_CORRECTO,
		GAC.ACT_ID
		FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
		INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
			ON GAC.GEE_ID = GEE.GEE_ID
		INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT
			ON ACT.ACT_ID = GAC.ACT_ID
		INNER JOIN '||V_ESQUEMA||'.BIE_BIEN BIE
			ON BIE.BIE_ID = ACT.BIE_ID
		INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION LOC
			ON LOC.BIE_ID = BIE.BIE_ID
		LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_PRV_PROVINCIA PRV
			ON LOC.DD_PRV_ID = PRV.DD_PRV_ID
		LEFT JOIN '||V_ESQUEMA||'.ACT_GES_DISTRIBUCION GES
			ON GES.COD_PROVINCIA = PRV.DD_PRV_CODIGO
		LEFT JOIN '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU
			ON USU.USU_ID = GEE.USU_ID
		LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR TGE
			ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
		LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_UPO_UNID_POBLACIONAL UPO
			ON UPO.DD_UPO_CODIGO = GES.COD_MUNICIPIO
		WHERE TGE.DD_TGE_CODIGO = ''GACT''

		AND ACT.ACT_NUM_ACTIVO_UVEM in (
			''13353084'',
			''15426760'',
			''21513332'',
			''26138344'',
			''26139859'',
			''26138110'',
			''26139490'',
			''26388833'',
			''24185626'',
			''27912311'',
			''27912059'',
			''27912545'',
			''27912662'',
			''27912779'',
			''27912428'',
			''27912176'',
			''27912293'',
			''26138461'',
			''26138695'',
			''26139373'',
			''26139625'',
			''27911030'',
			''27911867'',
			''27910604'',
			''27910838'',
			''27911264'',
			''23351408'',
			''23352671'',
			''23352203'',
			''23351390'',
			''23349879'',
			''23351876'',
			''23350847'',
			''26139022'',
			''26138830'',
			''26139139'',
			''26138578'',
			''26138713'',
			''26139742'',
			''26139256'',
			''26139508'',
			''27910586'',
			''27911984'',
			''27911147'',
			''26138227'',
			''21519308'',
			''27910469'',
			''27910955'',
			''27910721'',
			''27910352'',
			''23351993'',
			''23350613'',
			''23352437'',
			''23350478'',
			''23352554'',
			''23351156'',
			''23352806'',
			''23349996'',
			''23352185'',
			''23350361'',
			''23350595'',
			''23352788'',
			''23350010'',
			''23351759'',
			''23349762'',
			''23350244'',
			''23353115'',
			''23351039'',
			''23347218'',
			''23353097'',
			''23352923'',
			''23352068'',
			''23351273'',
			''26138092'',
			''23822576'',
			''23822225'',
			''26648274'',
			''28995620'',
			''26691091'',
			''28995737'',
			''23822342'',
			''23822459'',
			''24165915'',
			''16374637'',
			''22012423'',
			''15908052'',
			''21509979'',
			''19244209'',
			''22031087'',
			''18690825'',
			''18715961'',
			''21514847'',
			''22959228'',
			''22958784'',
			''21514730'',
			''21514964'',
			''15412091'',
			''22959111'',
			''22958919'',
			''22959093'',
			''22958802'',
			''19825701'',
			''21671384'',
			''21672062'',
			''21672296'',
			''21672431'',
			''21672665'',
			''21673226'',
			''21673829'',
			''21674021'',
			''21674138'',
			''21674507'',
			''20657981'',
			''20836684'',
			''20837245'',
			''21859285'',
			''21675302'',
			''21671519'',
			''21672917'',
			''21674741'',
			''21674858'',
			''21675284'',
			''21675419'',
			''21671402'',
			''21671636'',
			''21671870'',
			''21671987'',
			''21672179'',
			''21672800'',
			''21673109'',
			''21673460'',
			''21673694'',
			''21673946'',
			''21674255'',
			''21674624'',
			''21674975'',
			''21675167'',
			''21859537'',
			''21859654'',
			''21859906'',
			''21860136'',
			''20836819'',
			''20836936'',
			''20837011'',
			''20837128'',
			''20837362'',
			''21860487'',
			''21861048'',
			''21861768'',
			''21859303'',
			''21859420'',
			''21860973'',
			''20836702'',
			''20837479'',
			''21859771'',
			''21860253'',
			''21860370'',
			''21860505'',
			''21860622'',
			''21860856'',
			''21861165'',
			''21675536'',
			''21671753'',
			''21672314'',
			''21672548'',
			''21672782'',
			''21673091'',
			''21673343'',
			''21673577'',
			''21673712'',
			''21674372'',
			''21674489'',
			''21675050'',
			''20837596'',
			''22858392'',
			''22860272'',
			''22860407'',
			''22860524'',
			''21859168'',
			''21859888'',
			''21860019'',
			''21860739'',
			''21861282'',
			''22858410'',
			''22858995'',
			''22860389'',
			''21517349'',
			''21518513'',
			''21517232'',
			''21516923'',
			''21516788'',
			''21518378'',
			''21516554'',
			''21516437'',
			''21518261'',
			''21518630'',
			''21516671'',
			''21518747'',
			''21517718'',
			''21518864'',
			''21517583'',
			''21516806'',
			''21517115'',
			''21518027'',
			''21516203'',
			''21517466'',
			''21518144'',
			''21517835'',
			''21516320'',
			''21517601'',
			''21517952'',
			''21517097'',
			''21518495'',
			''21516185'',
			''24759337'',
			''22765313'',
			''27911633'',
			''27911516'',
			''27911750'',
			''27911498'',
			''27911381'',
			''28480257'',
			''28480140'',
			''28480374'',
			''28480743'',
			''28480491'',
			''28480626'',
			''28480509'',
			''28480860'',
			''28480977'',
			''28481052'' 
						)
		AND USU.USU_USERNAME not in (''adelaroja'') 
		AND GES.PROVINCIA IS NOT NULL
		AND GES.MUNICIPIO IS NULL
		AND GEE.BORRADO = 0
	)
	)
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE VA A ACTUALIZAR EL GESTOR A '||V_NUM||' ACTIVOS.');
 
	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZANDO USU_ID EN GEE_GESTOR_ENTIDAD...');
	
	EXECUTE IMMEDIATE '
	MERGE INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE USING
	(
	SELECT 
	TMPGEST.GEE_ID,
	TMPGEST.ACT_ID,
	USU.USU_ID
	FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMPGEST
	LEFT JOIN '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU
		ON USU.USU_USERNAME = ''adelaroja'' 
	) TMP
	ON (GEE.GEE_ID = TMP.GEE_ID)
	WHEN MATCHED THEN UPDATE SET
	GEE.USU_ID = TMP.USU_ID,  
	GEE.USUARIOMODIFICAR = ''HREOS-2022-1'',
	GEE.FECHAMODIFICAR = SYSDATE
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] GEE_GESTOR_ENTIDAD ACTUALIZADA...'||V_NUM||' REGISTROS.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZANDO GEH_FECHA_HASTA EN GEH_GESTOR_ENTIDAD_HIST PARA DAR DE BAJA EL ANTERIOR GESTOR...');
	
	EXECUTE IMMEDIATE '
	MERGE INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH USING
	(
	WITH ACT AS (
    SELECT DISTINCT
    TMP.ACT_ID,
    GAH.GEH_ID,
    TMP.DD_TGE_ID,
    (SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME =  ''adelaroja'' ) AS USU_ID 
    FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
    LEFT JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
      ON GAH.ACT_ID = TMP.ACT_ID
    LEFT JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
      ON GAC.ACT_ID = TMP.ACT_ID
    LEFT JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
      ON GEE.GEE_ID = GAC.GEE_ID
    WHERE GAH.ACT_ID IS NOT NULL
    AND GEE.USUARIOMODIFICAR = ''HREOS-2022-1''
  )
  SELECT GEH.GEH_ID
  FROM ACT
  INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
    ON GEH.GEH_ID = ACT.GEH_ID
  WHERE GEH.USU_ID != ACT.USU_ID
  AND GEH.DD_TGE_ID = ACT.DD_TGE_ID
	) TMP
	ON (GEH.GEH_ID = TMP.GEH_ID)
	WHEN MATCHED THEN UPDATE SET
	GEH.GEH_FECHA_HASTA = SYSDATE,
	GEH.USUARIOMODIFICAR = ''HREOS-2022-1'',
	GEH.FECHAMODIFICAR = SYSDATE
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] GEH_GESTOR_ENTIDAD_HIST ACTUALIZADA...'||V_NUM||' REGISTROS.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTANDO NUEVOS REGISTROS EN GEH_GESTOR_ENTIDAD_HIST PARA DAR DE ALTA EL NUEVO GESTOR...');
	
	EXECUTE IMMEDIATE '
	INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
	(GEH_ID,
	USU_ID,
	DD_TGE_ID,
	GEH_FECHA_DESDE,
	USUARIOCREAR,
	FECHACREAR,
	BORRADO
	)
	SELECT
	GEH_ID,
	(SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME = ''adelaroja'' ) AS USU_ID, 
	DD_TGE_ID,
	SYSDATE AS GEH_FECHA_DESDE,
	''HREOS-2022-1'' AS USUARIOCREAR,
	SYSDATE AS FECHACREAR,
	0 AS BORRADO
	FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS '||V_NUM||' REGISTROS EN GEH_GESTOR_ENTIDAD_HIST.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTANDO NUEVOS REGISTROS EN GAH_GESTOR_ACTIVO_HISTORICO PARA RELACIONAR LOS REGISTROS DE');
	DBMS_OUTPUT.PUT_LINE('       GEH_GESTOR_ENTIDAD_HIST CON LOS ACTIVOS...');
	
	EXECUTE IMMEDIATE '
	INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
	(GEH_ID,
	ACT_ID
	)
	SELECT 
	GEH_ID,
	ACT_ID
	FROM '||V_ESQUEMA||'.TMP_GEST_ACT
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS '||V_NUM||' REGISTROS EN GAH_GESTOR_ACTIVO_HISTORICO.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] GESTORES ACTUALIZADOS CORRECTAMENTE.'||CHR(10));

--      HREOS-2022-1:No asignar gestores a las tareas afectadas  	
--	DBMS_OUTPUT.PUT_LINE('[INFO] SE VAN A RE-ASIGNAR LOS GESTORES PARA LAS TAREAS AFECTADAS...');
	
--	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZANDO USU_ID EN TAC_TAREAS_ACTIVO...');
	
--	EXECUTE IMMEDIATE '
--	MERGE INTO '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC USING
--	(
--	SELECT
--	TAC.TAR_ID,
--	TAC.ACT_ID,
--	TAC.USU_ID,
--	GEE.GEE_ID,
--	GEE.DD_TGE_ID as GEE_DD_TGE_ID,
--	TAP.DD_TGE_ID as TAP_DD_TGE_ID,
--	GEE.USU_ID as USU_ID_NEW
--	FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC 
--	INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR
--	  ON TAR.TAR_ID = TAC.TAR_ID
--	INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX
--	  ON TEX.TAR_ID = TAR.TAR_ID
--	INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP
--	  ON TAP.TAP_ID = TEX.TAP_ID
--	INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC 
--	  ON GAC.ACT_ID = TAC.ACT_ID
--	INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE 
--	  ON GEE.GEE_ID = GAC.GEE_ID
--	WHERE GEE.DD_TGE_ID = (select dd_tge_id from remmaster.dd_tge_tipo_gestor where dd_tge_codigo = ''GACT'')
--	AND TAP.DD_TGE_ID = (select dd_tge_id from remmaster.dd_tge_tipo_gestor where dd_tge_codigo = ''GACT'') 
--	AND TAC.USU_ID != GEE.USU_ID
--	AND TAR.TAR_FECHA_FIN IS NULL
--	--AND TAC.BORRADO = 0
--	--AND TAR.BORRADO = 0
--	--AND TEX.BORRADO = 0
--	--AND TAP.BORRADO = 0
--	AND GEE.BORRADO = 0
--	AND GEE.USUARIOMODIFICAR = ''HREOS-2022-1''
--	) TMP
--	ON (TAC.TAR_ID = TMP.TAR_ID)
--	WHEN MATCHED THEN UPDATE SET
--	TAC.USU_ID = TMP.USU_ID_NEW,
--	TAC.USUARIOMODIFICAR = ''HREOS-2022-1'',
--	TAC.FECHAMODIFICAR = SYSDATE
--	'
--	;
--	
--	V_NUM := SQL%ROWCOUNT;
--	
--	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZADOS '||V_NUM||' REGISTROS EN TAC_TAREAS_ACTIVOS.');
--	
--	DBMS_OUTPUT.PUT_LINE('[INFO] TAREAS ACTUALIZADAS.'||CHR(10));
--
	 
 	EXECUTE IMMEDIATE '
	SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''TMP_GEST_ACT'' AND OWNER = '''||V_ESQUEMA||'''
	'
	INTO V_NUM
	;

	IF V_NUM > 0 THEN
  
    EXECUTE IMMEDIATE '
		TRUNCATE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
	
		EXECUTE IMMEDIATE '
		DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
		
	END IF;
	
	DBMS_OUTPUT.PUT_LINE('[FIN]  PROCESO FINALIZADO CORRECTAMENTE ');
 
EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
