--/*
--###########################################
--## AUTOR=Teresa Alonso
--## FECHA_CREACION=20170511
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-2022
--## PRODUCTO=NO
--## 
--## Finalidad: Re-asignar gestores de activo (por numero activo) al gestor ibenedito
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

BEGIN	

	DBMS_OUTPUT.PUT_LINE('[INICIO] COMIENZA EL PROCESO PARA LA RE-ASIGNACIÓN DE GESTORES PARA ');
	DBMS_OUTPUT.PUT_LINE('         ACTIVOS ASIGNADOS POR DEFECTO A OTRO GESTOR'||CHR(10));
	
	EXECUTE IMMEDIATE '
	SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''TMP_GEST_ACT'' AND OWNER = '''||V_ESQUEMA||'''
	'
	INTO V_NUM
	;
	
	IF V_NUM > 0 THEN
  
    EXECUTE IMMEDIATE '
		TRUNCATE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
	
		EXECUTE IMMEDIATE '
		DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
		
	END IF;

	EXECUTE IMMEDIATE '
	CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_GEST_ACT ON COMMIT PRESERVE ROWS AS (
	
	SELECT
	GEE_ID,
	GESTOR_CORRECTO,
	DD_TGE_ID,
	'||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL AS GEH_ID,
	ACT_ID
	FROM (
	
		SELECT DISTINCT
		GEE.GEE_ID,
		GEE.DD_TGE_ID,
		GES.USUARIO_GESTION_ACTIVOS AS GESTOR_CORRECTO,
		GAC.ACT_ID
		FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
		INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
			ON GAC.GEE_ID = GEE.GEE_ID
		INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT
			ON ACT.ACT_ID = GAC.ACT_ID
		INNER JOIN '||V_ESQUEMA||'.BIE_BIEN BIE
			ON BIE.BIE_ID = ACT.BIE_ID
		INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION LOC
			ON LOC.BIE_ID = BIE.BIE_ID
		LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_PRV_PROVINCIA PRV
			ON LOC.DD_PRV_ID = PRV.DD_PRV_ID
		LEFT JOIN '||V_ESQUEMA||'.ACT_GES_DISTRIBUCION GES
			ON GES.COD_PROVINCIA = PRV.DD_PRV_CODIGO
		LEFT JOIN '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU
			ON USU.USU_ID = GEE.USU_ID
		LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR TGE
			ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
		LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_UPO_UNID_POBLACIONAL UPO
			ON UPO.DD_UPO_CODIGO = GES.COD_MUNICIPIO
		WHERE TGE.DD_TGE_CODIGO = ''GACT''

		AND ACT.ACT_NUM_ACTIVO_UVEM in (
			''26458142'',
			''26458979'',
			''26459054'',
			''26459774'',
			''26458745'',
			''26458025'',
			''26458511'',
			''26458628'',
			''22680657'',
			''26457698'',
			''26459540'',
			''26459171'',
			''26459288'',
			''26459657'',
			''19405259'',
			''19405493'',
			''19406288'',
			''21796785'',
			''28468112'',
			''22716034'',
			''24845663'',
			''28604756'',
			''19346056'',
			''21751696'',
			''17950733'',
			''24160248'',
			''24160365'',
			''24158503'',
			''24158971'',
			''24159649'',
			''20431879'',
			''19405979'',
			''20041566'',
			''19405025'',
			''19406054'',
			''20895643'',
			''20905198'',
			''17697442'',
			''17902969'',
			''19346173'',
			''20904538'',
			''20881226'',
			''20904772'',
			''19346290'',
			''28467668'',
			''24751303'',
			''24015197'',
			''24749054'',
			''24751420'',
			''24751771'',
			''24019583'',
			''24014537'',
			''24018554'',
			''24748979'',
			''24749774'',
			''24749891'',
			''24017876'',
			''24018437'',
			''24017759'',
			''24013742'',
			''24750256'',
			''24016613'',
			''24015566'',
			''24013490'',
			''24751654'',
			''24017993'',
			''24019349'',
			''24019466'',
			''24748493'',
			''24750373'',
			''24750490'',
			''24015683'',
			''24015332'',
			''24169446'',
			''24749306'',
			''24750625'',
			''24751285'',
			''24751888'',
			''24748511'',
			''24749423'',
			''24016730'',
			''24018320'',
			''24014303'',
			''24749909'',
			''24169329'',
			''24748745'',
			''24749288'',
			''24015449'',
			''24749540'',
			''24750859'',
			''24019601'',
			''24012713'',
			''24748628'',
			''24750139'',
			''24014420'',
			''24019232'',
			''24017525'',
			''24169194'',
			''24750508'',
			''24750742'',
			''24751537'',
			''24013373'',
			''24014285'',
			''24015215'',
			''24169212'',
			''24748862'',
			''24749657'',
			''24750976'',
			''24012578'',
			''24015080'',
			''24014051'',
			''24016127'',
			''26382623'',
			''26382254'',
			''26382506'',
			''26383418'',
			''26384078'',
			''26381711'',
			''26383301'',
			''26383769'',
			''26382137'',
			''26383283'',
			''26384330'',
			''26384447'',
			''24015935'',
			''24017156'',
			''24016244'',
			''24014888'',
			''24016478'',
			''24018788'',
			''24016964'',
			''24016010'',
			''24018185'',
			''24017642'',
			''24016595'',
			''24017408'',
			''24014168'',
			''24016361'',
			''24018671'',
			''24013625'',
			''24017039'',
			''24013022'',
			''24012695'',
			''24015701'',
			''24019097'',
			''24012947'',
			''24018203'',
			''24015818'',
			''24017390'',
			''24016847'',
			''24014654'',
			''24018923'',
			''24012830'',
			''24013508'',
			''26383535'',
			''26381945'',
			''26382371'',
			''26383886'',
			''26384213'',
			''26383652'',
			''26383904'',
			''26382020'',
			''26382488'',
			''26381459'',
			''26381576'',
			''26382857'',
			''26382740'',
			''26382974'',
			''26381342'',
			''26384195'',
			''26381225'',
			''26381828'',
			''26383166'',
			''20495281'',
			''26383049'',
			''26381693'',
			''20495398'',
			''24017273'',
			''24019115'',
			''24013139'',
			''24013859'',
			''24014771'',
			''24013976'',
			''24014906'',
			''17643234'',
			''17644632'',
			''28123539'',
			''26224319'',
			''26225717'',
			''26226512'',
			''26227541'',
			''17643585'',
			''17643720'',
			''28124100'',
			''28124703'',
			''24018068'',
			''26220536'',
			''26221448'',
			''26221682'',
			''26222360'',
			''26223038'',
			''26224184'',
			''26224202'',
			''26224670'',
			''26220050'',
			''26222729'',
			''26223758'',
			''26224787'',
			''26226980'',
			''26227055'',
			''26228939'',
			''26230198'',
			''26231479'',
			''26232040'',
			''26232877'',
			''26233069'',
			''26233789'',
			''26234116'',
			''26235262'',
			''26235496'',
			''26236309'',
			''26237707'',
			''26238016'',
			''26239414'',
			''26239531'',
			''26240850'',
			''24289783'',
			''26457833'',
			''17633437'',
			''17643468'',
			''17644983'',
			''28124082'',
			''28124217'',
			''28124685'',
			''26222594'',
			''26223992'',
			''26227658'',
			''26228102'',
			''26231011'',
			''26231596'',
			''26233186'',
			''26241276'',
			''26242557'',
			''26243235'',
			''26244498'',
			''26244867'',
			''24289549'',
			''24289315'',
			''26229131'',
			''26229617'',
			''26236291'',
			''26236660'',
			''26237689'',
			''26240130'',
			''26242071'',
			''26242323'',
			''26242674'',
			''26243604'',
			''26245311'',
			''26226143'',
			''26229734'',
			''26229851'',
			''26231614'',
			''26234233'',
			''26235379'',
			''26239162'',
			''26241042'',
			''26242791'',
			''26243469'',
			''26243721'',
			''26243955'',
			''26244516'',
			''26245662'',
			''26246709'',
			''24290265'',
			''21236061'',
			''14201551'',
			''21723913'',
			''21724222'',
			''21724690'',
			''14201317'',
			''14201920'',
			''21722146'',
			''21724456'',
			''21724942'',
			''21721603'',
			''21721720'',
			''21722263'',
			''21723895'',
			''21724708'',
			''24714968'',
			''24714482'',
			''24714851'',
			''27380683'',
			''24716072'',
			''24715646'',
			''24716810'',
			''24716207'',
			''24714617'',
			''24715997'',
			''24713570'',
			''24715394'',
			''27379130'',
			''27379598'',
			''27379616'',
			''28424052'',
			''28424286'',
			''27379013'',
			''27380080'',
			''28423491'',
			''27379850'',
			''28424169'',
			''17698120'',
			''17698588'',
			''17698237'',
			''17698354'',
			''26460490'',
			''19161863'',
			''19164734'',
			''19165394'',
			''19175812'',
			''19165880'',
			''19162289'',
			''19163102'',
			''19166675'',
			''19162424'',
			''19164851'',
			''19165277'',
			''19165646'',
			''15383737'',
			''19147408'',
			''19161746'',
			''19161980'',
			''19162172'',
			''24290868'',
			''24290148'',
			''24289666'',
			''24291060'',
			''24290634'',
			''24290751'',
			''27147617'',
			''16507049'',
			''16507283'',
			''16507652'',
			''16506371'',
			''24290382'',
			''24290985'',
			''24291177'',
			''24290400'',
			''16507886'',
			''26460022'',
			''23035375'',
			''26460625'',
			''14201803'',
			''26459909'',
			''14201668'',
			''14201200'',
			''19380843'',
			''26458862'',
			''28424304'',
			''28423743'',
			''28423977'',
			''28424772'',
			''24289432'',
			''19381035'',
			''26459891'',
			''24289297'',
			''24289801'',
			''24290517'',
			''24289918'',
			''24290031'',
			''26460373'',
			''26460256'',
			''26460508'',
			''26460139'',
			''20495533'',
			''25063835'',
			''20495650'',
			''25063718'',
			''14201434'',
			''28123773'',
			''28123890'',
			''28123908'',
			''14201065'',
			''14201785'',
			''17643351'',
			''17643954'',
			''17644497'',
			''17644866'',
			''17645175'',
			''14201182'',
			''19381152'',
			''19380960'',
			''28124568'',
			''19381269'',
			''17644146'',
			''17643603'',
			''17644749'',
			''28424421'',
			''17644515'',
			''28123422'',
			''28423860'',
			''26220887'',
			''26223641'',
			''26228687'',
			''26229014'',
			''26229482'',
			''26230936'',
			''26222126'',
			''26223272'',
			''26227910'',
			''26228219'',
			''26232643'',
			''26233807'',
			''26234584'',
			''26240481'',
			''26240967'',
			''26241528'',
			''20495416'',
			''20495884'',
			''28423374'',
			''26220905'',
			''26221196'',
			''26223155'',
			''26225600'',
			''26225951'',
			''26226260'',
			''26230216'',
			''26233321'',
			''26234602'',
			''26235145'',
			''26235514'',
			''26235865'',
			''26237104'',
			''26242440'',
			''26246826'',
			''20495047'',
			''26232760'',
			''26233204'',
			''26236174'',
			''26236543'',
			''26236912'',
			''26237824'',
			''26241411'',
			''26242206'',
			''26242926'',
			''26243838'',
			''26245914'',
			''20495164'',
			''20495767'',
			''28124820'',
			''28125246'',
			''28423509'',
			''26223389'',
			''26223407'',
			''26223875'',
			''26230567'',
			''26232274'',
			''26232994'',
			''26236057'',
			''26237338'',
			''26237572'',
			''26238250'',
			''26238853'',
			''26244750'',
			''26245293'',
			''26245896'',
			''26221214'',
			''26221565'',
			''26222477'',
			''26222612'',
			''26222846'',
			''26225582'',
			''26227172'',
			''26227289'',
			''26227775'',
			''26228336'',
			''26228570'',
			''26229968'',
			''26230684'',
			''26233672'',
			''26234467'',
			''26236777'',
			''26238367'',
			''26238484'',
			''26239648'',
			''26240733'',
			''26241393'',
			''26245545'',
			''26246088'',
			''26246106'',
			''26246691'',
			''26220419'',
			''26221934'',
			''26222243'',
			''26224553'',
			''26225348'',
			''26226746'',
			''26226863'',
			''26227892'',
			''26228822'',
			''26229248'',
			''26230702'',
			''26232157'',
			''26232391'',
			''26233924'',
			''28124334'',
			''28423626'',
			''28124451'',
			''28124937'',
			''26220284'',
			''26220302'',
			''26224067'',
			''26238970'',
			''26239396'',
			''26239882'',
			''26243586'',
			''26220770'',
			''26221079'',
			''26221817'',
			''26222963'',
			''26225114'',
			''26228453'',
			''26229365'',
			''26229500'',
			''26230450'',
			''26230819'',
			''26231245'',
			''26224436'',
			''26225231'',
			''26225465'',
			''26227307'',
			''26231128'',
			''26231848'',
			''26234836'',
			''26235748'',
			''26236426'',
			''26246223'',
			''26246457'',
			''26246574'',
			''28424538'',
			''28424655'',
			''26234350'',
			''26234719'',
			''26237221'',
			''26237941'',
			''26239900'',
			''26240598'',
			''26240616'',
			''26241159'',
			''26241879'',
			''26243352'',
			''26246340'',
			''26240013'',
			''26239279'',
			''26241645'',
			''26241996'',
			''26242809'',
			''26244030'',
			''26244633'',
			''26239045'',
			''26240364'',
			''26243001'',
			''26244264'',
			''26244381'',
			''26245176'',
			''26245779'',
			''26239765'',
			''26240247'',
			''26241762'',
			''26242188'',
			''26243118'',
			''26244147'',
			''26244984'',
			''26245059'',
			''26245428'',
			''21721468'',
			''21722866'',
			''21723175'',
			''21724825'',
			''17644380'',
			''28123305'',
			''21723427'',
			''21725251'',
			''28125012'',
			''21723661'',
			''21724339'',
			''17643837'',
			''28123656'',
			''26224922'',
			''26221331'',
			''21721351'',
			''21721954'',
			''21725134'',
			''17644029'',
			''28123287'',
			''28125129'',
			''26226377'',
			''26228705'',
			''26230333'',
			''26232526'',
			''26233438'',
			''26235982'',
			''26236894'',
			''26237455'',
			''26238502'',
			''26221700'',
			''26222009'',
			''26223524'',
			''26226494'',
			''26230081'',
			''26232409'',
			''26238133'',
			''26238736'',
			''26225096'',
			''26225834'',
			''26226629'',
			''26227424'',
			''26231731'',
			''26233555'',
			''26234098'',
			''26234953'',
			''26235028'',
			''26237086'',
			''26238619'',
			''26220167'',
			''26220653'',
			''26224805'',
			''26226026'',
			''26228084'',
			''26231362'',
			''26231965'',
			''26235631'',
			''21722029'',
			''21723292'',
			''21724573'',
			''21725017'',
			''21722380'',
			''21723544'',
			''21723310'',
			''21725368'',
			''19162910'',
			''19165763'',
			''19165160'',
			''19165997'',
			''19166558'',
			''21721234'',
			''21721585'',
			''21721837'',
			''19162541'',
			''19173133'',
			''19166072'',
			''21725485'',
			''21722497'',
			''21722983'',
			''21723778'',
			''21724087'',
			''21724105'',
			''21725503'',
			''19147390'',
			''19161629'',
			''19162658'',
			''19164968'',
			''19165043'',
			''19162055'',
			''19166792'',
			''19166207'',
			''24714365'',
			''24716792'',
			''24715412'',
			''24713822'',
			''24715763'',
			''24713705'',
			''24716189'',
			''24713687'',
			''24715043'',
			''24717353'',
			''27379481'',
			''27379733'',
			''24716675'',
			''16506488'',
			''16507535'',
			''16507769'',
			''16508330'',
			''27380566'',
			''27380935'',
			''16506623'',
			''16508213'',
			''16507166'',
			''27380332'',
			''27378704'',
			''27380818'',
			''16506506'',
			''24717002'',
			''24717119'',
			''24714014'',
			''24715529'',
			''24714734'',
			''24717236'',
			''24716324'',
			''24716441'',
			''24715277'',
			''17697793'',
			''17697676'',
			''17698471'',
			''17698606'',
			''24715880'',
			''24716558'',
			''24717470'',
			''24714248'',
			''17698723'',
			''27379247'',
			''24713939'',
			''27378938'',
			''27380701'',
			''24714500'',
			''24715160'',
			''24716927'',
			''24714131'',
			''27379364'',
			''27379967'',
			''16506974'',
			''16508078'',
			''27378821'',
			''27380449'',
			''28300886'',
			''16506740'',
			''27380215'',
			''16506857'',
			''16507904'',
			''16507301'',
			''16507418'',
			''19148788'',
			''19163084'',
			''19166324'',
			''19147156'',
			''19147273'',
			''19162307'',
			''19162892'',
			''19165412'',
			''19165529'',
			''19166189'',
			''19166441'',
			''17698840'',
			''25043989'',
			''24748025'',
			''19488918'',
			''25043872'',
			''26380898'',
			''27423607'',
			''24748259'',
			''28574149'',
			''28574266'',
			''20431996'',
			''19630136'',
			''26381090'',
			''26380781'',
			''26380313'',
			''25044064'',
			''25043755'',
			''25044181'',
			''28574032'',
			''24744359'',
			''24748142'',
			''24748376'',
			''26380916'',
			''24158854'',
			''24159901'',
			''26380430'',
			''26380547'',
			''24158620'',
			''24159532'',
			''20281538'',
			''21722749'',
			''21796668'',
			''22836740'',
			''22836506'',
			''22836488'',
			''22836857'',
			''19735691'',
			''24807462'',
			''17697208'',
			''26457716'',
			''26458493'',
			''26457950'',
			''26458376'',
			''26459306'',
			''24160014'',
			''24158485'',
			''24159046'',
			''24159397'',
			''24159415'',
			''24159883'',
			''21749951'',
			''19406306'',
			''26458259'',
			''26459423'',
			''22680540'',
			''19406423'',
			''22781961'',
			''19405142'',
			''21722632'',
			''20917791'',
			''24158017'',
			''22886211'',
			''24159163'',
			''24159766'',
			''24158368'',
			''24158737'',
			''24827776'',
			''24160617'',
			''20904655'',
			''25041562'',
			''24807345'',
			''17902852'',
			''17902618'',
			''21722515'',
			''28468094'',
			''28468229'',
			''21240134'',
			''21240620'',
			''21751345'',
			''21241046'',
			''21239535'',
			''21240971'',
			''21240503'',
			''22836623'',
			''17903044'',
			''17902735'',
			''19735574'',
			''17697190'',
			''17903161'',
			''21239418'',
			''21240737'',
			''21241163'',
			''21239283'',
			''21240251'',
			''21239301'',
			''21241415'',
			''21241280'',
			''21239886'',
			''21239904'',
			''21241397'',
			''21241532'',
			''21239049'',
			''21239652'',
			''21240368'',
			''21238974'',
			''21239769'',
			''21240017'',
			''21240485'',
			''21240854'',
			''21239166''
						)
		AND USU.USU_USERNAME not in (''ibenedito'') 
		AND GES.PROVINCIA IS NOT NULL
		AND GES.MUNICIPIO IS NULL
		AND GEE.BORRADO = 0
	)
	)
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE VA A ACTUALIZAR EL GESTOR A '||V_NUM||' ACTIVOS.');
 
	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZANDO USU_ID EN GEE_GESTOR_ENTIDAD...');
	
	EXECUTE IMMEDIATE '
	MERGE INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE USING
	(
	SELECT 
	TMPGEST.GEE_ID,
	TMPGEST.ACT_ID,
	USU.USU_ID
	FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMPGEST
	LEFT JOIN '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU
		ON USU.USU_USERNAME = ''ibenedito'' 
	) TMP
	ON (GEE.GEE_ID = TMP.GEE_ID)
	WHEN MATCHED THEN UPDATE SET
	GEE.USU_ID = TMP.USU_ID,
	GEE.USUARIOMODIFICAR = ''HREOS-2022-2'',
	GEE.FECHAMODIFICAR = SYSDATE
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] GEE_GESTOR_ENTIDAD ACTUALIZADA...'||V_NUM||' REGISTROS.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZANDO GEH_FECHA_HASTA EN GEH_GESTOR_ENTIDAD_HIST PARA DAR DE BAJA EL ANTERIOR GESTOR...');
	
	EXECUTE IMMEDIATE '
	MERGE INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH USING
	(
	WITH ACT AS (
    SELECT DISTINCT
    TMP.ACT_ID,
    GAH.GEH_ID,
    TMP.DD_TGE_ID,
    (SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME =  ''ibenedito'' ) AS USU_ID 
    FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
    LEFT JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
      ON GAH.ACT_ID = TMP.ACT_ID
    LEFT JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
      ON GAC.ACT_ID = TMP.ACT_ID
    LEFT JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
      ON GEE.GEE_ID = GAC.GEE_ID
    WHERE GAH.ACT_ID IS NOT NULL
    AND GEE.USUARIOMODIFICAR = ''HREOS-2022-2''
  )
  SELECT GEH.GEH_ID
  FROM ACT
  INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
    ON GEH.GEH_ID = ACT.GEH_ID
  WHERE GEH.USU_ID != ACT.USU_ID
  AND GEH.DD_TGE_ID = ACT.DD_TGE_ID
	) TMP
	ON (GEH.GEH_ID = TMP.GEH_ID)
	WHEN MATCHED THEN UPDATE SET
	GEH.GEH_FECHA_HASTA = SYSDATE,
	GEH.USUARIOMODIFICAR = ''HREOS-2022-2'',
	GEH.FECHAMODIFICAR = SYSDATE
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] GEH_GESTOR_ENTIDAD_HIST ACTUALIZADA...'||V_NUM||' REGISTROS.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTANDO NUEVOS REGISTROS EN GEH_GESTOR_ENTIDAD_HIST PARA DAR DE ALTA EL NUEVO GESTOR...');
	
	EXECUTE IMMEDIATE '
	INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
	(GEH_ID,
	USU_ID,
	DD_TGE_ID,
	GEH_FECHA_DESDE,
	USUARIOCREAR,
	FECHACREAR,
	BORRADO
	)
	SELECT
	GEH_ID,
	(SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME = ''ibenedito'' ) AS USU_ID, 
	DD_TGE_ID,
	SYSDATE AS GEH_FECHA_DESDE,
	''HREOS-2022-2'' AS USUARIOCREAR,
	SYSDATE AS FECHACREAR,
	0 AS BORRADO
	FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS '||V_NUM||' REGISTROS EN GEH_GESTOR_ENTIDAD_HIST.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTANDO NUEVOS REGISTROS EN GAH_GESTOR_ACTIVO_HISTORICO PARA RELACIONAR LOS REGISTROS DE');
	DBMS_OUTPUT.PUT_LINE('       GEH_GESTOR_ENTIDAD_HIST CON LOS ACTIVOS...');
	
	EXECUTE IMMEDIATE '
	INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
	(GEH_ID,
	ACT_ID
	)
	SELECT 
	GEH_ID,
	ACT_ID
	FROM '||V_ESQUEMA||'.TMP_GEST_ACT
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS '||V_NUM||' REGISTROS EN GAH_GESTOR_ACTIVO_HISTORICO.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] GESTORES ACTUALIZADOS CORRECTAMENTE.'||CHR(10));

--      HREOS-2022-2:No asignar gestores a las tareas afectadas  	
--	DBMS_OUTPUT.PUT_LINE('[INFO] SE VAN A RE-ASIGNAR LOS GESTORES PARA LAS TAREAS AFECTADAS...');
	
--	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZANDO USU_ID EN TAC_TAREAS_ACTIVO...');
	
--	EXECUTE IMMEDIATE '
--	MERGE INTO '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC USING
--	(
--	SELECT
--	TAC.TAR_ID,
--	TAC.ACT_ID,
--	TAC.USU_ID,
--	GEE.GEE_ID,
--	GEE.DD_TGE_ID as GEE_DD_TGE_ID,
--	TAP.DD_TGE_ID as TAP_DD_TGE_ID,
--	GEE.USU_ID as USU_ID_NEW
--	FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC 
--	INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR
--	  ON TAR.TAR_ID = TAC.TAR_ID
--	INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX
--	  ON TEX.TAR_ID = TAR.TAR_ID
--	INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP
--	  ON TAP.TAP_ID = TEX.TAP_ID
--	INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC 
--	  ON GAC.ACT_ID = TAC.ACT_ID
--	INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE 
--	  ON GEE.GEE_ID = GAC.GEE_ID
--	WHERE GEE.DD_TGE_ID = (select dd_tge_id from remmaster.dd_tge_tipo_gestor where dd_tge_codigo = ''GACT'')
--	AND TAP.DD_TGE_ID = (select dd_tge_id from remmaster.dd_tge_tipo_gestor where dd_tge_codigo = ''GACT'') 
--	AND TAC.USU_ID != GEE.USU_ID
--	AND TAR.TAR_FECHA_FIN IS NULL
--	--AND TAC.BORRADO = 0
--	--AND TAR.BORRADO = 0
--	--AND TEX.BORRADO = 0
--	--AND TAP.BORRADO = 0
--	AND GEE.BORRADO = 0
--	AND GEE.USUARIOMODIFICAR = ''HREOS-2022-2''
--	) TMP
--	ON (TAC.TAR_ID = TMP.TAR_ID)
--	WHEN MATCHED THEN UPDATE SET
--	TAC.USU_ID = TMP.USU_ID_NEW,
--	TAC.USUARIOMODIFICAR = ''HREOS-2022-2'',
--	TAC.FECHAMODIFICAR = SYSDATE
--	'
--	;
--	
--	V_NUM := SQL%ROWCOUNT;
--	
--	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZADOS '||V_NUM||' REGISTROS EN TAC_TAREAS_ACTIVOS.');
--	
--	DBMS_OUTPUT.PUT_LINE('[INFO] TAREAS ACTUALIZADAS.'||CHR(10));
--
	 
 	EXECUTE IMMEDIATE '
	SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''TMP_GEST_ACT'' AND OWNER = '''||V_ESQUEMA||'''
	'
	INTO V_NUM
	;

	IF V_NUM > 0 THEN
  
    EXECUTE IMMEDIATE '
		TRUNCATE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
	
		EXECUTE IMMEDIATE '
		DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
		
	END IF;
	
	DBMS_OUTPUT.PUT_LINE('[FIN]  PROCESO FINALIZADO CORRECTAMENTE ');
 
EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
