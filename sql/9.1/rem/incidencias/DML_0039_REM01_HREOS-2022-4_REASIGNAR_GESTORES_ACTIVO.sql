--/*
--###########################################
--## AUTOR=Teresa Alonso
--## FECHA_CREACION=20170511
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-2022
--## PRODUCTO=NO
--## 
--## Finalidad: Re-asignar gestores de activo (por numero activo) al gestor jlpelaz
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

BEGIN	

	DBMS_OUTPUT.PUT_LINE('[INICIO] COMIENZA EL PROCESO PARA LA RE-ASIGNACIÓN DE GESTORES PARA ');
	DBMS_OUTPUT.PUT_LINE('         ACTIVOS ASIGNADOS POR DEFECTO A OTRO GESTOR'||CHR(10));
	
	EXECUTE IMMEDIATE '
	SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''TMP_GEST_ACT'' AND OWNER = '''||V_ESQUEMA||'''
	'
	INTO V_NUM
	;
	
	IF V_NUM > 0 THEN
  
    EXECUTE IMMEDIATE '
		TRUNCATE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
	
		EXECUTE IMMEDIATE '
		DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
		
	END IF;

	EXECUTE IMMEDIATE '
	CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_GEST_ACT ON COMMIT PRESERVE ROWS AS (
	
	SELECT
	GEE_ID,
	GESTOR_CORRECTO,
	DD_TGE_ID,
	'||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL AS GEH_ID,
	ACT_ID
	FROM (
	
		SELECT DISTINCT
		GEE.GEE_ID,
		GEE.DD_TGE_ID,
		GES.USUARIO_GESTION_ACTIVOS AS GESTOR_CORRECTO,
		GAC.ACT_ID
		FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
		INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
			ON GAC.GEE_ID = GEE.GEE_ID
		INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT
			ON ACT.ACT_ID = GAC.ACT_ID
		INNER JOIN '||V_ESQUEMA||'.BIE_BIEN BIE
			ON BIE.BIE_ID = ACT.BIE_ID
		INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION LOC
			ON LOC.BIE_ID = BIE.BIE_ID
		LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_PRV_PROVINCIA PRV
			ON LOC.DD_PRV_ID = PRV.DD_PRV_ID
		LEFT JOIN '||V_ESQUEMA||'.ACT_GES_DISTRIBUCION GES
			ON GES.COD_PROVINCIA = PRV.DD_PRV_CODIGO
		LEFT JOIN '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU
			ON USU.USU_ID = GEE.USU_ID
		LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR TGE
			ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
		LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_UPO_UNID_POBLACIONAL UPO
			ON UPO.DD_UPO_CODIGO = GES.COD_MUNICIPIO
		WHERE TGE.DD_TGE_CODIGO = ''GACT''

		AND ACT.ACT_NUM_ACTIVO_UVEM in (
			''19922250'',
			''19922367'',
			''16597265'',
			''19586748'',
			''26745444'',
			''26388950'',
			''20787395'',
			''19402037'',
			''22866482'',
			''15458344'',
			''24138909'',
			''24139704'',
			''15728554'',
			''28990673'',
			''28991585'',
			''28992146'',
			''28994087'',
			''28994942'',
			''28995368'',
			''28991720'',
			''28992263'',
			''28992515'',
			''28993427'',
			''28991837'',
			''28993661'',
			''28995017'',
			''28989606'',
			''28991603'',
			''28993778'',
			''15728320'',
			''15728437'',
			''15728788'',
			''28989588'',
			''28990205'',
			''28990322'',
			''28990808'',
			''28993310'',
			''28993895'',
			''28989957'',
			''28990925'',
			''28991117'',
			''28992380'',
			''28993544'',
			''28994339'',
			''28994456'',
			''28991468'',
			''28992632'',
			''28992866'',
			''28993292'',
			''28994222'',
			''28994690'',
			''28990187'',
			''28990790'',
			''28992029'',
			''28991234'',
			''28992497'',
			''28990070'',
			''28994825'',
			''28989723'',
			''28990439'',
			''28992983'',
			''28993175'',
			''28993913'',
			''28994105'',
			''28991954'',
			''19431956'',
			''21825877'',
			''28990556'',
			''28991000'',
			''24211478'',
			''24212390'',
			''28995134'',
			''28989471'',
			''28991351'',
			''24211244'',
			''24212039'',
			''28989840'',
			''28995251'',
			''28993058'',
			''28994708'',
			''28992749'',
			''28994573'',
			''15728806'',
			''24211595'',
			''24211613'',
			''24211730'',
			''24212273'',
			''24212156'',
			''24211127'',
			''24211964'',
			''24211847'',
			''24211361'',
			''27372008'',
			''20516301'',
			''21788695'',
			''15355216'',
			''15031032'',
			''18825313'',
			''21789508'',
			''21789490'',
			''21789742'',
			''21789625'',
			''21737727'',
			''21788713'',
			''21789256'',
			''21737610'',
			''21789373'',
			''15961872'',
			''21788227'',
			''21788578'',
			''21788947'',
			''21788344'',
			''21789139'',
			''21788461'',
			''21789022'',
			''21788830'',
			''18825295'',
			''15031266'',
			''15030723'',
			''24741857'',
			''15031149'',
			''19693094'',
			''20516418'',
			''15355198'',
			''15355333'',
			''15355450'',
			''15355567'',
			''27281824'',
			''27282133'',
			''22614169'',
			''24136698'',
			''24136581'',
			''26198566'',
			''26377386'',
			''19380240'',
			''19825566'',
			''27281941'',
			''22619098'',
			''27281689'',
			''5317119'',
			''26744415'',
			''26745210'',
			''26745075'',
			''26744649'',
			''26744883'',
			''24136716'',
			''26377404'',
			''26376357'',
			''19380357'',
			''24118694'',
			''24118712'',
			''24118577'',
			''26745192'',
			''27282250'',
			''26744766'',
			''19825683'',
			''27281707'',
			''27282016'',
			''22614304'',
			''22614052'',
			''28995503'',
			''24136833'',
			''22614286'',
			''26388698'',
			''26745678'',
			''26744532'',
			''19380474'',
			''19825215'',
			''19825449'',
			''19825332'',
			''26376240'',
			''26376474'',
			''26377152'',
			''26377269'',
			''26377521'',
			''26376591'',
			''24136950'',
			''22613977'',
			''19612132'',
			''19385304'',
			''26745327'',
			''26744397'',
			''26744901'',
			''26745561'',
			''21158896'',
			''24139452'',
			''24138288'',
			''24138774'',
			''24138054'',
			''24139218'',
			''24139101'',
			''24138657'',
			''24137628'',
			''24679511'',
			''22619584'',
			''20516652'',
			''17806126'',
			''22817338'',
			''15867222'',
			''24118460'',
			''22619467'',
			''16749331'',
			''20516769'',
			''25083663'',
			''20516535'',
			''16785456'',
			''19718248'',
			''22619116'',
			''22619233'',
			''15458227'',
			''24139335'',
			''24139569'',
			''24138306'',
			''24138423'',
			''24138540'',
			''24137493'',
			''24137511'',
			''24138891'',
			''24137862'',
			''12924040'',
			''23913363'',
			''25078444'',
			''20302288'',
			''24139083'',
			''24139686'',
			''24137979'',
			''24139821'',
			''24139938'',
			''20515506'',
			''20516166'',
			''20516049'',
			''20516283'',
			''20515740'',
			''20515623'',
			''15458110'',
			''22781007'',
			''22619350'',
			''15796983'',
			''15998637'',
			''15998754'',
			''21370637'',
			''21393453'',
			''20485484'',
			''20485619'',
			''20485736'',
			''22979776'',
			''22980258'',
			''22981053'',
			''22984275'',
			''22984392'',
			''22992734'',
			''22992968'',
			''22993277'',
			''22994189'',
			''20485367'',
			''20485502'',
			''21393102'',
			''21393939'',
			''21393822'',
			''22993646'',
			''22993763'',
			''22993880'',
			''22994072'',
			''20801995'',
			''22991705'',
			''22993043'',
			''22993412'',
			''21393219'',
			''21393336'',
			''21393570'',
			''21393705'',
			''23904847'',
			''22991939'',
			''22992014'',
			''22992248'',
			''22992500'',
			''22993394'',
			''22993529'',
			''22978981'',
			''22979056'',
			''22979425'',
			''22980510'',
			''22980744'',
			''22984158'',
			''22875250'',
			''22985070'',
			''22985790'',
			''22989708'',
			''22990307'',
			''22990424'',
			''22954398'',
			''22978513'',
			''22978630'',
			''22978747'',
			''22978864'',
			''22980861'',
			''22984410'',
			''22984644'',
			''22984761'',
			''22985187'',
			''22985205'',
			''22985808'',
			''22986000'',
			''22989339'',
			''22979893'',
			''22979911'',
			''22980375'',
			''22980627'',
			''22980978'',
			''22985439'',
			''22985556'',
			''22985673'',
			''22990289'',
			''22984527'',
			''22984878'',
			''22984995'',
			''22985925'',
			''22990172'',
			''22992365'',
			''22991102'',
			''23905273'',
			''22980492'',
			''22980141'',
			''22980024'',
			''22992851'',
			''22979308'',
			''22991219'',
			''22991336'',
			''15961755'',
			''22989825'',
			''22991687'',
			''22990775'',
			''23905390'',
			''22990541'',
			''22991453'',
			''22979659'',
			''22992482'',
			''22989690'',
			''22993997'',
			''22989573'',
			''22989942'',
			''22989222'',
			''22991570'',
			''22979173'',
			''22989105'',
			''22991084'',
			''22990658'',
			''22979290'',
			''21393687'',
			''22979542'',
			''22992131'',
			''22993160'',
			''22990055'',
			''21296535'',
			''20281304'',
			''22991822'',
			''22990910'',
			''24162927'',
			''20805895'',
			''22850592'',
			''24048062'',
			''22850610'',
			''22850358'',
			''22850475'',
			''22850124'',
			''24999291'',
			''26388716'',
			''20026784'',
			''20027345'',
			''20027579'',
			''20028491'',
			''20029052'',
			''20029304'',
			''20026919'',
			''20027714'',
			''20027831'',
			''20028140'',
			''20029538'',
			''20029889'',
			''20026802'',
			''20027696'',
			''20029655'',
			''20026433'',
			''20028023'',
			''20028743'',
			''20029421'',
			''20026667'',
			''20028626'',
			''20028860'',
			''20029169'',
			''20027093'',
			''20027228'',
			''20028257'',
			''20028509'',
			''20029286'',
			''20026316'',
			''20027111'',
			''20027462'',
			''20027948'',
			''20028977'',
			''20029772'',
			''20026550'',
			''20028374'',
			''22815865'',
			''22815982'',
			''22816291'',
			''22816309'',
			''22816426'',
			''22816777'',
			''22816543'',
			''22816894'',
			''22816912'',
			''22817086'',
			''22817104'',
			''22817455'',
			''22817572'',
			''24484549'',
			''22816057'',
			''22816174'',
			''22816660'',
			''15791937'',
			''28637504''
						)
		AND USU.USU_USERNAME not in (''jlpelaz'') 
		AND GES.PROVINCIA IS NOT NULL
		AND GES.MUNICIPIO IS NULL
		AND GEE.BORRADO = 0

	)
	)
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE VA A ACTUALIZAR EL GESTOR A '||V_NUM||' ACTIVOS.');
 
	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZANDO USU_ID EN GEE_GESTOR_ENTIDAD...');
	
	EXECUTE IMMEDIATE '
	MERGE INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE USING
	(
	SELECT 
	TMPGEST.GEE_ID,
	TMPGEST.ACT_ID,
	USU.USU_ID
	FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMPGEST
	LEFT JOIN '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU
		ON USU.USU_USERNAME = ''jlpelaz'' 
	) TMP
	ON (GEE.GEE_ID = TMP.GEE_ID)
	WHEN MATCHED THEN UPDATE SET
	GEE.USU_ID = TMP.USU_ID,
	GEE.USUARIOMODIFICAR = ''HREOS-2022-4'',
	GEE.FECHAMODIFICAR = SYSDATE
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] GEE_GESTOR_ENTIDAD ACTUALIZADA...'||V_NUM||' REGISTROS.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZANDO GEH_FECHA_HASTA EN GEH_GESTOR_ENTIDAD_HIST PARA DAR DE BAJA EL ANTERIOR GESTOR...');
	
	EXECUTE IMMEDIATE '
	MERGE INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH USING
	(
	WITH ACT AS (
    SELECT DISTINCT
    TMP.ACT_ID,
    GAH.GEH_ID,
    TMP.DD_TGE_ID,
    (SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME =  ''jlpelaz'' ) AS USU_ID 
    FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
    LEFT JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
      ON GAH.ACT_ID = TMP.ACT_ID
    LEFT JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
      ON GAC.ACT_ID = TMP.ACT_ID
    LEFT JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
      ON GEE.GEE_ID = GAC.GEE_ID
    WHERE GAH.ACT_ID IS NOT NULL
    AND GEE.USUARIOMODIFICAR = ''HREOS-2022-4''
  )
  SELECT GEH.GEH_ID
  FROM ACT
  INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
    ON GEH.GEH_ID = ACT.GEH_ID
  WHERE GEH.USU_ID != ACT.USU_ID
  AND GEH.DD_TGE_ID = ACT.DD_TGE_ID
	) TMP
	ON (GEH.GEH_ID = TMP.GEH_ID)
	WHEN MATCHED THEN UPDATE SET
	GEH.GEH_FECHA_HASTA = SYSDATE,
	GEH.USUARIOMODIFICAR = ''HREOS-2022-4'',
	GEH.FECHAMODIFICAR = SYSDATE
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] GEH_GESTOR_ENTIDAD_HIST ACTUALIZADA...'||V_NUM||' REGISTROS.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTANDO NUEVOS REGISTROS EN GEH_GESTOR_ENTIDAD_HIST PARA DAR DE ALTA EL NUEVO GESTOR...');
	
	EXECUTE IMMEDIATE '
	INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
	(GEH_ID,
	USU_ID,
	DD_TGE_ID,
	GEH_FECHA_DESDE,
	USUARIOCREAR,
	FECHACREAR,
	BORRADO
	)
	SELECT
	GEH_ID,
	(SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME = ''jlpelaz'' ) AS USU_ID, 
	DD_TGE_ID,
	SYSDATE AS GEH_FECHA_DESDE,
	''HREOS-2022-4'' AS USUARIOCREAR,
	SYSDATE AS FECHACREAR,
	0 AS BORRADO
	FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS '||V_NUM||' REGISTROS EN GEH_GESTOR_ENTIDAD_HIST.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTANDO NUEVOS REGISTROS EN GAH_GESTOR_ACTIVO_HISTORICO PARA RELACIONAR LOS REGISTROS DE');
	DBMS_OUTPUT.PUT_LINE('       GEH_GESTOR_ENTIDAD_HIST CON LOS ACTIVOS...');
	
	EXECUTE IMMEDIATE '
	INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
	(GEH_ID,
	ACT_ID
	)
	SELECT 
	GEH_ID,
	ACT_ID
	FROM '||V_ESQUEMA||'.TMP_GEST_ACT
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS '||V_NUM||' REGISTROS EN GAH_GESTOR_ACTIVO_HISTORICO.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] GESTORES ACTUALIZADOS CORRECTAMENTE.'||CHR(10));

--      HREOS-2022-4:No asignar gestores a las tareas afectadas  	
--	DBMS_OUTPUT.PUT_LINE('[INFO] SE VAN A RE-ASIGNAR LOS GESTORES PARA LAS TAREAS AFECTADAS...');
	
--	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZANDO USU_ID EN TAC_TAREAS_ACTIVO...');
	
--	EXECUTE IMMEDIATE '
--	MERGE INTO '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC USING
--	(
--	SELECT
--	TAC.TAR_ID,
--	TAC.ACT_ID,
--	TAC.USU_ID,
--	GEE.GEE_ID,
--	GEE.DD_TGE_ID as GEE_DD_TGE_ID,
--	TAP.DD_TGE_ID as TAP_DD_TGE_ID,
--	GEE.USU_ID as USU_ID_NEW
--	FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC 
--	INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR
--	  ON TAR.TAR_ID = TAC.TAR_ID
--	INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX
--	  ON TEX.TAR_ID = TAR.TAR_ID
--	INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP
--	  ON TAP.TAP_ID = TEX.TAP_ID
--	INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC 
--	  ON GAC.ACT_ID = TAC.ACT_ID
--	INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE 
--	  ON GEE.GEE_ID = GAC.GEE_ID
--	WHERE GEE.DD_TGE_ID = (select dd_tge_id from remmaster.dd_tge_tipo_gestor where dd_tge_codigo = ''GACT'')
--	AND TAP.DD_TGE_ID = (select dd_tge_id from remmaster.dd_tge_tipo_gestor where dd_tge_codigo = ''GACT'') 
--	AND TAC.USU_ID != GEE.USU_ID
--	AND TAR.TAR_FECHA_FIN IS NULL
--	--AND TAC.BORRADO = 0
--	--AND TAR.BORRADO = 0
--	--AND TEX.BORRADO = 0
--	--AND TAP.BORRADO = 0
--	AND GEE.BORRADO = 0
--	AND GEE.USUARIOMODIFICAR = ''HREOS-2022-4''
--	) TMP
--	ON (TAC.TAR_ID = TMP.TAR_ID)
--	WHEN MATCHED THEN UPDATE SET
--	TAC.USU_ID = TMP.USU_ID_NEW,
--	TAC.USUARIOMODIFICAR = ''HREOS-2022-4'',
--	TAC.FECHAMODIFICAR = SYSDATE
--	'
--	;
--	
--	V_NUM := SQL%ROWCOUNT;
--	
--	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZADOS '||V_NUM||' REGISTROS EN TAC_TAREAS_ACTIVOS.');
--	
--	DBMS_OUTPUT.PUT_LINE('[INFO] TAREAS ACTUALIZADAS.'||CHR(10));
--
	 
 	EXECUTE IMMEDIATE '
	SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''TMP_GEST_ACT'' AND OWNER = '''||V_ESQUEMA||'''
	'
	INTO V_NUM
	;

	IF V_NUM > 0 THEN
  
    EXECUTE IMMEDIATE '
		TRUNCATE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
	
		EXECUTE IMMEDIATE '
		DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
		
	END IF;
	
	DBMS_OUTPUT.PUT_LINE('[FIN]  PROCESO FINALIZADO CORRECTAMENTE ');
 
EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
