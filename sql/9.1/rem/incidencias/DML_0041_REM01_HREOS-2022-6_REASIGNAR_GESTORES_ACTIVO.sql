--/*
--###########################################
--## AUTOR=Teresa Alonso
--## FECHA_CREACION=20170511
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-2022
--## PRODUCTO=NO
--## 
--## Finalidad: Re-asignar gestores de activo (por numero activo) al gestor rdura
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

BEGIN	

	DBMS_OUTPUT.PUT_LINE('[INICIO] COMIENZA EL PROCESO PARA LA RE-ASIGNACIÓN DE GESTORES PARA ');
	DBMS_OUTPUT.PUT_LINE('         ACTIVOS ASIGNADOS POR DEFECTO A OTRO GESTOR'||CHR(10));
	
	EXECUTE IMMEDIATE '
	SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''TMP_GEST_ACT'' AND OWNER = '''||V_ESQUEMA||'''
	'
	INTO V_NUM
	;
	
	IF V_NUM > 0 THEN
  
    EXECUTE IMMEDIATE '
		TRUNCATE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
	
		EXECUTE IMMEDIATE '
		DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
		
	END IF;

	EXECUTE IMMEDIATE '
	CREATE GLOBAL TEMPORARY TABLE '||V_ESQUEMA||'.TMP_GEST_ACT ON COMMIT PRESERVE ROWS AS (
	
	SELECT
	GEE_ID,
	GESTOR_CORRECTO,
	DD_TGE_ID,
	'||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL AS GEH_ID,
	ACT_ID
	FROM (
	
		SELECT DISTINCT
		GEE.GEE_ID,
		GEE.DD_TGE_ID,
		GES.USUARIO_GESTION_ACTIVOS AS GESTOR_CORRECTO,
		GAC.ACT_ID
		FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
		INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
			ON GAC.GEE_ID = GEE.GEE_ID
		INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT
			ON ACT.ACT_ID = GAC.ACT_ID
		INNER JOIN '||V_ESQUEMA||'.BIE_BIEN BIE
			ON BIE.BIE_ID = ACT.BIE_ID
		INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION LOC
			ON LOC.BIE_ID = BIE.BIE_ID
		LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_PRV_PROVINCIA PRV
			ON LOC.DD_PRV_ID = PRV.DD_PRV_ID
		LEFT JOIN '||V_ESQUEMA||'.ACT_GES_DISTRIBUCION GES
			ON GES.COD_PROVINCIA = PRV.DD_PRV_CODIGO
		LEFT JOIN '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU
			ON USU.USU_ID = GEE.USU_ID
		LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR TGE
			ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
		LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_UPO_UNID_POBLACIONAL UPO
			ON UPO.DD_UPO_CODIGO = GES.COD_MUNICIPIO
		WHERE TGE.DD_TGE_CODIGO = ''GACT''

		AND ACT.ACT_NUM_ACTIVO_UVEM in (
			''27220321'',
			''27223057'',
			''27222982'',
			''27220204'',
			''27220438'',
			''27222379'',
			''27219722'',
			''27219839'',
			''27220789'',
			''27222631'',
			''27223174'',
			''26175381'',
			''27219956'',
			''20020826'',
			''25072468'',
			''25072603'',
			''25077046'',
			''25076737'',
			''25077883'',
			''14597110'',
			''28638533'',
			''28571530'',
			''28571647'',
			''28570501'',
			''28570969'',
			''26175867'',
			''20134060'',
			''15737673'',
			''20134429'',
			''26327213'',
			''28571764'',
			''15737925'',
			''15737790'',
			''25072234'',
			''20133148'',
			''20734603'',
			''13400432'',
			''27886558'',
			''14568514'',
			''20850320'',
			''14568631'',
			''20850203'',
			''21585058'',
			''20734000'',
			''26188769'',
			''20132353'',
			''26327078'',
			''20792029'',
			''28571881'',
			''28572073'',
			''28572325'',
			''28570249'',
			''28570735'',
			''28570366'',
			''28572676'',
			''28572190'',
			''28570852'',
			''28571413'',
			''28571044'',
			''28571161'',
			''28570618'',
			''28571278'',
			''28571395'',
			''28572559'',
			''28572208'',
			''28572442'',
			''28570483'',
			''28571998'',
			''20003500'',
			''28622994'',
			''28623204'',
			''28623321'',
			''28624467'',
			''28631393'',
			''28621362'',
			''28635293'',
			''28635914'',
			''28623438'',
			''20002822'',
			''20003851'',
			''28622040'',
			''28622157'',
			''28623186'',
			''28623807'',
			''28625631'',
			''28625865'',
			''28627455'',
			''28628016'',
			''28629279'',
			''28631879'',
			''20003131'',
			''20004646'',
			''28621965'',
			''28623672'',
			''28627707'',
			''28628619'',
			''28633586'',
			''28633955'',
			''28621731'',
			''28634984'',
			''28636106'',
			''28625748'',
			''28634030'',
			''28614553'',
			''28636340'',
			''28636574'',
			''28636691'',
			''28636709'',
			''28636943'',
			''28637486'',
			''20003482'',
			''26188886'',
			''24002295'',
			''20003734'',
			''20003968'',
			''20004880'',
			''20003014'',
			''20004160'',
			''20005072'',
			''24065037'',
			''24066786'',
			''24066318'',
			''24064593'',
			''24066066'',
			''20005189'',
			''20004394'',
			''20003248'',
			''20004043'',
			''20004997'',
			''20003365'',
			''20004412'',
			''28621848'',
			''28623069'',
			''28624233'',
			''28624584'',
			''28626894'',
			''28624098'',
			''28624719'',
			''28625262'',
			''28627572'',
			''28628133'',
			''28630850'',
			''28633001'',
			''28633469'',
			''28633721'',
			''28633838'',
			''28635662'',
			''28627689'',
			''28627824'',
			''28629162'',
			''28631996'',
			''28632791'',
			''28632809'',
			''28634147'',
			''28623789'',
			''28623924'',
			''28624836'',
			''28624953'',
			''28625145'',
			''28629045'',
			''28621479'',
			''28636088'',
			''28636826'',
			''28627086'',
			''28628502'',
			''28635311'',
			''28635428'',
			''28627221'',
			''28630733'',
			''24745154'',
			''24746183'',
			''24747095'',
			''24745640'',
			''24744593'',
			''28625496'',
			''28625982'',
			''28631645'',
			''28621596'',
			''28634498'',
			''28635779'',
			''28625514'',
			''28626426'',
			''28630967'',
			''28631411'',
			''28632188'',
			''28632674'',
			''28632926'',
			''28633352'',
			''28622274'',
			''28622391'',
			''28622760'',
			''28626660'',
			''28627941'',
			''28629396'',
			''28630481'',
			''28633235'',
			''28621011'',
			''28636457'',
			''28637252'',
			''28637369'',
			''28620936'',
			''28621614'',
			''28634381'',
			''28635545'',
			''28622409'',
			''28623555'',
			''28624602'',
			''28626174'',
			''28628250'',
			''28630598'',
			''28631042'',
			''28631276'',
			''28634516'',
			''28634633'',
			''28634750'',
			''28634867'',
			''24065640'',
			''24065271'',
			''28622526'',
			''28622877'',
			''28625028'',
			''28626057'',
			''28626291'',
			''28626543'',
			''28625379'',
			''28626777'',
			''28626912'',
			''28627104'',
			''28628484'',
			''28632071'',
			''28632206'',
			''28631762'',
			''28633604'',
			''28621128'',
			''28621245'',
			''28636223'',
			''28637135'',
			''28633118'',
			''28635176'',
			''28637018'',
			''28627338'',
			''28631159'',
			''28631528'',
			''28635896'',
			''24065523'',
			''24066201'',
			''24065991'',
			''24065388'',
			''24065874'',
			''28622643'',
			''28624116'',
			''28626309'',
			''28628367'',
			''28628736'',
			''28628853'',
			''28628970'',
			''28630616'',
			''20004763'',
			''28632323'',
			''28634264'',
			''28635059'',
			''20002939'',
			''20003617'',
			''20004277'',
			''20004529'',
			''24065154'',
			''24066552'',
			''24064611'',
			''24064476'',
			''24066669'',
			''24065757'',
			''24066183'',
			''24066435'',
			''24064728'',
			''24064845'',
			''24066804'',
			''24065406'',
			''26437636'',
			''26437870'',
			''26438917'',
			''26439577'',
			''26439829'',
			''26442738'',
			''26444931'',
			''26445591'',
			''26446386'',
			''26446521'',
			''26446989'',
			''26448462'',
			''26450828'',
			''26451740'',
			''26452886'',
			''26453213'',
			''26453798'',
			''26454125'',
			''26455523'',
			''26455640'',
			''26442855'',
			''26443650'',
			''26444211'',
			''26444796'',
			''26447667'',
			''26448714'',
			''26449257'',
			''26452535'',
			''26455037'',
			''26456552'',
			''26457230'',
			''26457464'',
			''26438062'',
			''26438782'',
			''26440545'',
			''26442252'',
			''26443047'',
			''26446152'',
			''26439109'',
			''26439343'',
			''26440293'',
			''26441340'',
			''26443884'',
			''26444445'',
			''26445960'',
			''26446035'',
			''26447802'',
			''26449626'',
			''26449977'',
			''26451488'',
			''26454359'',
			''26455271'',
			''26456669'',
			''26457581'',
			''20016636'',
			''26446872'',
			''27250783'',
			''27250801'',
			''24024937'',
			''26174955'',
			''26174838'',
			''24746669'',
			''24745523'',
			''24746201'',
			''24746318'',
			''24746552'',
			''24747464'',
			''26175516'',
			''24746435'',
			''24745757'',
			''24744845'',
			''24747347'',
			''24747833'',
			''24746066'',
			''24747113'',
			''26174469'',
			''24744962'',
			''24744611'',
			''24747698'',
			''24747230'',
			''24745388'',
			''24747716'',
			''24744728'',
			''26438296'',
			''26440896'',
			''26441943'',
			''26442135'',
			''26446269'',
			''26449023'',
			''26450342'',
			''26451020'',
			''26451623'',
			''26451974'',
			''26454728'',
			''26455874'',
			''26455991'',
			''20016870'',
			''20017062'',
			''26438431'',
			''26440914'',
			''26441223'',
			''26441691'',
			''26444814'',
			''26445006'',
			''26445123'',
			''26446638'',
			''26447181'',
			''26448345'',
			''26450459'',
			''26450576'',
			''26452301'',
			''26452904'',
			''26454593'',
			''26454611'',
			''26440662'',
			''26456183'',
			''26456318'',
			''26442369'',
			''26442621'',
			''26444328'',
			''26445843'',
			''26449491'',
			''26451371'',
			''26453330'',
			''26453564'',
			''26453681'',
			''26457347'',
			''26438314'',
			''26439226'',
			''26439712'',
			''26440176'',
			''26440311'',
			''26441457'',
			''26443281'',
			''26443398'',
			''26444076'',
			''26448228'',
			''26448831'',
			''26449374'',
			''26450693'',
			''20016402'',
			''24745874'',
			''24746786'',
			''26175147'',
			''27221233'',
			''24745037'',
			''24745991'',
			''24744476'',
			''24746921'',
			''23990677'',
			''24025012'',
			''23990794'',
			''27147500'',
			''27147968'',
			''27148043'',
			''27466971'',
			''20036113'',
			''20036833'',
			''27148160'',
			''26437519'',
			''26441106'',
			''26441826'',
			''26443902'',
			''20623502'',
			''27466368'',
			''20036950'',
			''20624900'',
			''20625074'',
			''20625191'',
			''27467280'',
			''26444562'',
			''26444679'',
			''26445726'',
			''26447550'',
			''26448579'',
			''26449140'',
			''26450711'',
			''26454476'',
			''26456201'',
			''26456804'',
			''26437987'',
			''26445609'',
			''26447064'',
			''26447298'',
			''26449743'',
			''26450945'',
			''26451137'',
			''26451506'',
			''26453195'',
			''26454242'',
			''26455388'',
			''26457113'',
			''26439091'',
			''26439946'',
			''26442486'',
			''26443767'',
			''26447316'',
			''26448696'',
			''26449509'',
			''26450108'',
			''26451254'',
			''26452049'',
			''26452166'',
			''26452283'',
			''26453933'',
			''26455757'',
			''26457095'',
			''27148277'',
			''20623970'',
			''20625209'',
			''20625326'',
			''17658212'',
			''20016753'',
			''17658563'',
			''26438665'',
			''26440428'',
			''26440779'',
			''26441088'',
			''26441709'',
			''26443416'',
			''26448111'',
			''26450225'',
			''26452769'',
			''17658194'',
			''26453078'',
			''26454962'',
			''26456786'',
			''20016987'',
			''17658680'',
			''23990560'',
			''22913578'',
			''28573237'',
			''23990812'',
			''28573354'',
			''28572811'',
			''26342949'',
			''26343375'',
			''26437753'',
			''26439460'',
			''26440059'',
			''26443164'',
			''26445240'',
			''26445357'',
			''26446404'',
			''26448948'',
			''26450090'',
			''26451857'',
			''26452652'',
			''26455154'',
			''26456921'',
			''26438179'',
			''26438800'',
			''26441574'',
			''26342832'',
			''26443533'',
			''26343492'',
			''26447433'',
			''26447784'',
			''26452418'',
			''26453447'',
			''26453816'',
			''26454008'',
			''26472480'',
			''26344908'',
			''26344170'',
			''26344305'',
			''26442018'',
			''26444193'',
			''26447919'',
			''26449860'',
			''26454845'',
			''26455406'',
			''26456066'',
			''26456435'',
			''28242613'',
			''26438548'',
			''26439694'',
			''26442504'',
			''26442972'',
			''26445474'',
			''26446755'',
			''26448093'',
			''26342697'',
			''19438358'',
			''19438727'',
			''19440958'',
			''19445887'',
			''19448407'',
			''19448758'',
			''20016519'',
			''19434107'',
			''19439405'',
			''19440841'',
			''19449067'',
			''19450638'',
			''19375372'',
			''19446700'',
			''19447612'',
			''19439639'',
			''19441753'',
			''19447963'',
			''19448524'',
			''24893310'',
			''25156563'',
			''25157592'',
			''28242244'',
			''24893895'',
			''25157007'',
			''25156329'',
			''25156680'',
			''24893292'',
			''15510911'',
			''15515840'',
			''15523930'',
			''15509340'',
			''15514559'',
			''15515354'',
			''15516032'',
			''15514190'',
			''15514811'',
			''24061371'',
			''28466270'',
			''15510659'',
			''15515588'',
			''20017314'',
			''24061020'',
			''22586358'',
			''21746360'',
			''20925395'',
			''21744284'',
			''21745934'',
			''21745700'',
			''21745817'',
			''20034388'',
			''24226708'',
			''24227017'',
			''27467046'',
			''27467397'',
			''20037142'',
			''20037493'',
			''20037259'',
			''21746243'',
			''27466251'',
			''27466854'',
			''20037511'',
			''21745079'',
			''20034523'',
			''27466485'',
			''27466737'',
			''23769466'',
			''24227368'',
			''27147734'',
			''26343024'',
			''26343141'',
			''26344656'',
			''26344773'',
			''26343510'',
			''28573003'',
			''27466503'',
			''20036095'',
			''20036698'',
			''20017179'',
			''20037376'',
			''27467163'',
			''20036230'',
			''20036347'',
			''26344053'',
			''26344890'',
			''21735048'',
			''21744167'',
			''21744302'',
			''21744653'',
			''26342715'',
			''26343627'',
			''26343744'',
			''21744905'',
			''21745196'',
			''21745214'',
			''21745331'',
			''26344539'',
			''20132956'',
			''28573120'',
			''28572928'',
			''20133265'',
			''26343258'',
			''26344422'',
			''26342580'',
			''26343978'',
			''26343861'',
			''26344287'',
			''20035786'',
			''20036581'',
			''26288207'',
			''20133031'',
			''27466134'',
			''20035921'',
			''20036716'',
			''20036464'',
			''27466620'',
			''15894093'',
			''19439153'',
			''19441150'',
			''19441870'',
			''19446079'',
			''19447243'',
			''19446331'',
			''19448992'',
			''19449553'',
			''20037025'',
			''27147851'',
			''19434458'',
			''19440355'',
			''19441519'',
			''19446565'',
			''19446682'',
			''19448155'',
			''19449670'',
			''19433312'',
			''19433780'',
			''19448389'',
			''19448875'',
			''19449202'',
			''20017431'',
			''19433060'',
			''19446214'',
			''19450035'',
			''15893919'',
			''19434944'',
			''19441636'',
			''19445770'',
			''19446817'',
			''19447360'',
			''19450269'',
			''19450521'',
			''19434341'',
			''19446196'',
			''19447729'',
			''19450386'',
			''25155903'',
			''25156077'',
			''25156797'',
			''25156212'',
			''25156815'',
			''25157475'',
			''25157610'',
			''25156446'',
			''25157358'',
			''25156194'',
			''25157727'',
			''21745448'',
			''21746009'',
			''19434692'',
			''19439270'',
			''19439756'',
			''19440607'',
			''19449805'',
			''21744887'',
			''19438844'',
			''19447009'',
			''19447477'',
			''19435136'',
			''19439036'',
			''19445905'',
			''19447846'',
			''19440004'',
			''19440589'',
			''19446448'',
			''19447126'',
			''21745565'',
			''21744419'',
			''21745682'',
			''21746126'',
			''21744536'',
			''21744770'',
			''26288324'',
			''25155885'',
			''25156932'',
			''25155651'',
			''25157124'',
			''25157241'',
			''25155768'',
			''20623736'',
			''20623853'',
			''20624396'',
			''20624882'',
			''20623016'',
			''20624414'',
			''20624648'',
			''20623484'',
			''20624279'',
			''20623133'',
			''17657903'',
			''28242964'',
			''28242361'',
			''28242847'',
			''17658077'',
			''20623619'',
			''20624162'',
			''20624765'',
			''20623250'',
			''17658446'',
			''17658815'',
			''24226825'',
			''17658329'',
			''20925278'',
			''15508662'',
			''15510173'',
			''15515120'',
			''28243039'',
			''15509106'',
			''15509691'',
			''15513998'',
			''15515237'',
			''15508293'',
			''15511337'',
			''15514676'',
			''28242595'',
			''15509457'',
			''15511103'',
			''15524122'',
			''28242478'',
			''28242730'',
			''20924852'',
			''20924969'',
			''20925044'',
			''28241701'',
			''28241935'',
			''20925161'',
			''20924618'',
			''20924735'',
			''20034640'',
			''20034757'',
			''24226573'',
			''24226942'',
			''24227134'',
			''28242127'',
			''24893913'',
			''24894222'',
			''24227251'',
			''24894105'',
			''24226456'',
			''24226690'',
			''24894087'',
			''28242010'',
			''28241818'',
			''24893661'',
			''24893778'',
			''15509088'',
			''24061137'',
			''15508779'',
			''15510776'',
			''15514928'',
			''15515606'',
			''24061488'',
			''15508059'',
			''15511085'',
			''21748202'',
			''15516266'',
			''22586124'',
			''22585932'',
			''20035435'',
			''22586007'',
			''20034874'',
			''20035318'',
			''20034991'',
			''20035669'',
			''24061254'',
			''20035201'',
			''20035552'',
			''24893427'',
			''24893544'',
			''27254449'',
			''20622707'',
			''20622572'',
			''21748184'',
			''15508896''
						)
		AND USU.USU_USERNAME not in (''rdura'') 
		AND GES.PROVINCIA IS NOT NULL
		AND GES.MUNICIPIO IS NULL
		AND GEE.BORRADO = 0

	)
	)
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE VA A ACTUALIZAR EL GESTOR A '||V_NUM||' ACTIVOS.');
 
	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZANDO USU_ID EN GEE_GESTOR_ENTIDAD...');
	
	EXECUTE IMMEDIATE '
	MERGE INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE USING
	(
	SELECT 
	TMPGEST.GEE_ID,
	TMPGEST.ACT_ID,
	USU.USU_ID
	FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMPGEST
	LEFT JOIN '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU
		ON USU.USU_USERNAME = ''rdura'' 
	) TMP
	ON (GEE.GEE_ID = TMP.GEE_ID)
	WHEN MATCHED THEN UPDATE SET
	GEE.USU_ID = TMP.USU_ID,
	GEE.USUARIOMODIFICAR = ''HREOS-2022-6'',
	GEE.FECHAMODIFICAR = SYSDATE

	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] GEE_GESTOR_ENTIDAD ACTUALIZADA...'||V_NUM||' REGISTROS.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZANDO GEH_FECHA_HASTA EN GEH_GESTOR_ENTIDAD_HIST PARA DAR DE BAJA EL ANTERIOR GESTOR...');
	
	EXECUTE IMMEDIATE '
	MERGE INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH USING
	(
	WITH ACT AS (
    SELECT DISTINCT
    TMP.ACT_ID,
    GAH.GEH_ID,
    TMP.DD_TGE_ID,
    (SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME =  ''rdura'' ) AS USU_ID 
    FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
    LEFT JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
      ON GAH.ACT_ID = TMP.ACT_ID
    LEFT JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
      ON GAC.ACT_ID = TMP.ACT_ID
    LEFT JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
      ON GEE.GEE_ID = GAC.GEE_ID
    WHERE GAH.ACT_ID IS NOT NULL
    AND GEE.USUARIOMODIFICAR = ''HREOS-2022-6''
  )
  SELECT GEH.GEH_ID
  FROM ACT
  INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
    ON GEH.GEH_ID = ACT.GEH_ID
  WHERE GEH.USU_ID != ACT.USU_ID
  AND GEH.DD_TGE_ID = ACT.DD_TGE_ID
	) TMP
	ON (GEH.GEH_ID = TMP.GEH_ID)
	WHEN MATCHED THEN UPDATE SET
	GEH.GEH_FECHA_HASTA = SYSDATE,
	GEH.USUARIOMODIFICAR = ''HREOS-2022-6'',
	GEH.FECHAMODIFICAR = SYSDATE
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] GEH_GESTOR_ENTIDAD_HIST ACTUALIZADA...'||V_NUM||' REGISTROS.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTANDO NUEVOS REGISTROS EN GEH_GESTOR_ENTIDAD_HIST PARA DAR DE ALTA EL NUEVO GESTOR...');
	
	EXECUTE IMMEDIATE '
	INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
	(GEH_ID,
	USU_ID,
	DD_TGE_ID,
	GEH_FECHA_DESDE,
	USUARIOCREAR,
	FECHACREAR,
	BORRADO
	)
	SELECT
	GEH_ID,
	(SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME = ''rdura'' ) AS USU_ID, 
	DD_TGE_ID,
	SYSDATE AS GEH_FECHA_DESDE,
	''HREOS-2022-6'' AS USUARIOCREAR,
	SYSDATE AS FECHACREAR,
	0 AS BORRADO
	FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS '||V_NUM||' REGISTROS EN GEH_GESTOR_ENTIDAD_HIST.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTANDO NUEVOS REGISTROS EN GAH_GESTOR_ACTIVO_HISTORICO PARA RELACIONAR LOS REGISTROS DE');
	DBMS_OUTPUT.PUT_LINE('       GEH_GESTOR_ENTIDAD_HIST CON LOS ACTIVOS...');
	
	EXECUTE IMMEDIATE '
	INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
	(GEH_ID,
	ACT_ID
	)
	SELECT 
	GEH_ID,
	ACT_ID
	FROM '||V_ESQUEMA||'.TMP_GEST_ACT
	'
	;
	
	V_NUM := SQL%ROWCOUNT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS '||V_NUM||' REGISTROS EN GAH_GESTOR_ACTIVO_HISTORICO.');
	
	DBMS_OUTPUT.PUT_LINE('[INFO] GESTORES ACTUALIZADOS CORRECTAMENTE.'||CHR(10));

--      HREOS-2022-6:No asignar gestores a las tareas afectadas  	
--	DBMS_OUTPUT.PUT_LINE('[INFO] SE VAN A RE-ASIGNAR LOS GESTORES PARA LAS TAREAS AFECTADAS...');
	
--	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZANDO USU_ID EN TAC_TAREAS_ACTIVO...');
	
--	EXECUTE IMMEDIATE '
--	MERGE INTO '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC USING
--	(
--	SELECT
--	TAC.TAR_ID,
--	TAC.ACT_ID,
--	TAC.USU_ID,
--	GEE.GEE_ID,
--	GEE.DD_TGE_ID as GEE_DD_TGE_ID,
--	TAP.DD_TGE_ID as TAP_DD_TGE_ID,
--	GEE.USU_ID as USU_ID_NEW
--	FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC 
--	INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR
--	  ON TAR.TAR_ID = TAC.TAR_ID
--	INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX
--	  ON TEX.TAR_ID = TAR.TAR_ID
--	INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP
--	  ON TAP.TAP_ID = TEX.TAP_ID
--	INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC 
--	  ON GAC.ACT_ID = TAC.ACT_ID
--	INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE 
--	  ON GEE.GEE_ID = GAC.GEE_ID
--	WHERE GEE.DD_TGE_ID = (select dd_tge_id from remmaster.dd_tge_tipo_gestor where dd_tge_codigo = ''GACT'')
--	AND TAP.DD_TGE_ID = (select dd_tge_id from remmaster.dd_tge_tipo_gestor where dd_tge_codigo = ''GACT'') 
--	AND TAC.USU_ID != GEE.USU_ID
--	AND TAR.TAR_FECHA_FIN IS NULL
--	--AND TAC.BORRADO = 0
--	--AND TAR.BORRADO = 0
--	--AND TEX.BORRADO = 0
--	--AND TAP.BORRADO = 0
--	AND GEE.BORRADO = 0
--	AND GEE.USUARIOMODIFICAR = ''HREOS-2022-6''
--	) TMP
--	ON (TAC.TAR_ID = TMP.TAR_ID)
--	WHEN MATCHED THEN UPDATE SET
--	TAC.USU_ID = TMP.USU_ID_NEW,
--	TAC.USUARIOMODIFICAR = ''HREOS-2022-6'',
--	TAC.FECHAMODIFICAR = SYSDATE
--	'
--	;
--	
--	V_NUM := SQL%ROWCOUNT;
--	
--	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZADOS '||V_NUM||' REGISTROS EN TAC_TAREAS_ACTIVOS.');
--	
--	DBMS_OUTPUT.PUT_LINE('[INFO] TAREAS ACTUALIZADAS.'||CHR(10));
--
	 
 	EXECUTE IMMEDIATE '
	SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''TMP_GEST_ACT'' AND OWNER = '''||V_ESQUEMA||'''
	'
	INTO V_NUM
	;

	IF V_NUM > 0 THEN
  
    EXECUTE IMMEDIATE '
		TRUNCATE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
	
		EXECUTE IMMEDIATE '
		DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
		'
		;
		
	END IF;
	
	DBMS_OUTPUT.PUT_LINE('[FIN]  PROCESO FINALIZADO CORRECTAMENTE ');
 
EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
