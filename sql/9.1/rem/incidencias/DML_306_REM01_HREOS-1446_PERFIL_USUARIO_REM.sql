--/*
--###########################################
--## AUTOR=DANIEL GUTIÉRREZ
--## FECHA_CREACION=20170127
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.1
--## INCIDENCIA_LINK=HREOS-1438
--## PRODUCTO=NO
--## 
--## Finalidad: Modificación de perfiles y tipos de gestor de bruiz.
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  
   USU_ID NUMBER(16);
   PEF_SUPACT NUMBER(16);
   PEF_SUPADM NUMBER(16);
   PEF_GESTADM NUMBER(16);
   DES_SUPACT NUMBER(16);
   DES_SUPADM NUMBER(16);
   DES_GESTADM NUMBER(16);
   ZPU_ID_NUEVO NUMBER(16);
   USD_ID_NUEVO NUMBER(16);

BEGIN	

	DBMS_OUTPUT.PUT_LINE('[INICIO] COMIENZA EL PROCESO PARA LA REASIGNACIÓN DE PERFILES Y TIPO DE GESTORES ');
	EXECUTE IMMEDIATE 'SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU WHERE USU.USU_USERNAME = ''bruiz''' INTO USU_ID;
	EXECUTE IMMEDIATE 'SELECT PEF_ID FROM '||V_ESQUEMA||'.PEF_PERFILES PEF WHERE PEF.PEF_DESCRIPCION = ''Supervisor de activo''' INTO PEF_SUPACT;
	EXECUTE IMMEDIATE 'SELECT PEF_ID FROM '||V_ESQUEMA||'.PEF_PERFILES PEF WHERE PEF.PEF_DESCRIPCION = ''Supervisor de admisión''' INTO PEF_SUPADM;
	EXECUTE IMMEDIATE 'SELECT PEF_ID FROM '||V_ESQUEMA||'.PEF_PERFILES PEF WHERE PEF.PEF_DESCRIPCION = ''Gestor de admisión''' INTO PEF_GESTADM;
	EXECUTE IMMEDIATE 'SELECT DES_ID FROM '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO DES WHERE DES.DES_DESPACHO = ''REMSUPACT''' INTO DES_SUPACT;
	EXECUTE IMMEDIATE 'SELECT DES_ID FROM '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO DES WHERE DES.DES_DESPACHO = ''REMSUPADM''' INTO DES_SUPADM;
	EXECUTE IMMEDIATE 'SELECT DES_ID FROM '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO DES WHERE DES.DES_DESPACHO = ''REMADM''' INTO DES_GESTADM;
	
	
    DBMS_OUTPUT.PUT_LINE('MODIFICANDO ZPU - PERFIL SUPACT -> SUPADM ');
    EXECUTE IMMEDIATE'
		UPDATE '||V_ESQUEMA||'.ZON_PEF_USU ZPU SET
		ZPU.PEF_ID = '||PEF_SUPADM||',
		ZPU.FECHAMODIFICAR = SYSDATE,
		ZPU.USUARIOMODIFICAR = ''HREOS-1446''
		WHERE USU_ID = '||USU_ID||' AND PEF_ID = '||PEF_SUPACT||'';
		
				
	SELECT S_ZON_PEF_USU.NEXTVAL INTO ZPU_ID_NUEVO FROM DUAL;
    
	
	DBMS_OUTPUT.PUT_LINE('NUEVO ZPU - PERFIL GESTADM ');
	
	EXECUTE IMMEDIATE'	
		INSERT INTO '||V_ESQUEMA||'.ZON_PEF_USU ZPU
		(ZON_ID,
		PEF_ID,
		USU_ID,
		ZPU_ID,
		VERSION,
		USUARIOCREAR,
		FECHACREAR,
		BORRADO
		)VALUES(
		19504,
		'||PEF_GESTADM||',
		'||USU_ID||',
		'||ZPU_ID_NUEVO||',
		0,
		''HREOS-1446'',
		SYSDATE,
		0)';
		
		
		
		
	DBMS_OUTPUT.PUT_LINE('MODIFICANDO USD - DESPACHO SUPACT -> SUPADM ');
	    
	EXECUTE IMMEDIATE'
		UPDATE '||V_ESQUEMA||'.USD_USUARIOS_DESPACHOS USD SET
		USD.DES_ID = '||DES_SUPADM||',
		USD.FECHAMODIFICAR = SYSDATE,
		USD.USUARIOMODIFICAR = ''HREOS-1446''
		WHERE USU_ID = '||USU_ID||' AND DES_ID = '||DES_SUPACT||'';
		
				
	SELECT S_USD_USUARIOS_DESPACHOS.NEXTVAL INTO USD_ID_NUEVO FROM DUAL;
    
	
	DBMS_OUTPUT.PUT_LINE('NUEVO USD - DESPACHO GESTADM ');
	
	EXECUTE IMMEDIATE'	
		INSERT INTO '||V_ESQUEMA||'.USD_USUARIOS_DESPACHOS USD
		(USD_ID,
		USU_ID,
		DES_ID,
		USD_GESTOR_DEFECTO,
		USD_SUPERVISOR,
		VERSION,
		USUARIOCREAR,
		FECHACREAR,
		BORRADO
		)VALUES(
		'||USD_ID_NUEVO||',
		'||USU_ID||',
		'||DES_GESTADM||',
		1,
		1,
		0,
		''HREOS-1446'',
		SYSDATE,
		0)';

    
	ROLLBACK;
	
	DBMS_OUTPUT.PUT_LINE('[FIN]  PROCESO FINALIZADO CORRECTAMENTE');
	
EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
