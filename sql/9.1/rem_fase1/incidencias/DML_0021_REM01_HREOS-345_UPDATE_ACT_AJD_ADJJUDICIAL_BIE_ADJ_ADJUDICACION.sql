--/*
--#########################################
--## AUTOR=PABLO MESEGUER
--## FECHA_CREACION=20160429
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-345
--## PRODUCTO=NO
--## 
--## Finalidad: Insertar los nuevo registros en ACT_AJD_ADJJUDICIAL y actualizar los datos de BIE_ADJ_ADJUDICACION 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.      
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

  TYPE T_JUDICIAL_DATA IS TABLE OF VARCHAR2(150);
  TYPE T_ARRAY_DATA IS TABLE OF T_JUDICIAL_DATA;
  V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
			  -- ACT_PRINEX - FCH_ADJ - EEJ - EDJ - BIE_ADJ_IMP_ADJ	
	T_JUDICIAL_DATA('67846','19/05/2014','32','3','64350'),
	T_JUDICIAL_DATA('67955','01/12/2015','17','3','17077.56'),
	T_JUDICIAL_DATA('67956','01/12/2015','17','3','28898.46'),
	T_JUDICIAL_DATA('67532','09/07/2015','17','3','189290'),
	T_JUDICIAL_DATA('67556','09/02/2016','17','3','4421.42'),
	T_JUDICIAL_DATA('67613','09/02/2016','17','3','4383.66'),
	T_JUDICIAL_DATA('67619','09/02/2016','17','3','4878.43'),
	T_JUDICIAL_DATA('67635','09/02/2016','17','3','3543.74'),
	T_JUDICIAL_DATA('67574','09/02/2016','17','3','4404.8'),
	T_JUDICIAL_DATA('67598','09/02/2016','17','3','3662.38'),
	T_JUDICIAL_DATA('67602','09/02/2016','17','3','3543.74'),
	T_JUDICIAL_DATA('67659','09/02/2016','17','3','3630.47'),
	T_JUDICIAL_DATA('67745','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67766','09/02/2016','17','3','3882.95'),
	T_JUDICIAL_DATA('67708','09/02/2016','17','3','4303.01'),
	T_JUDICIAL_DATA('67710','09/02/2016','17','3','3252.46'),
	T_JUDICIAL_DATA('67715','09/02/2016','17','3','4483.79'),
	T_JUDICIAL_DATA('67717','09/02/2016','17','3','4750.42'),
	T_JUDICIAL_DATA('67721','09/02/2016','17','3','3567.38'),
	T_JUDICIAL_DATA('67722','09/02/2016','17','3','4990.62'),
	T_JUDICIAL_DATA('67731','09/02/2016','17','3','5488.91'),
	T_JUDICIAL_DATA('67689','09/02/2016','17','3','5815.22'),
	T_JUDICIAL_DATA('67694','09/02/2016','17','3','5821.07'),
	T_JUDICIAL_DATA('67674','09/02/2016','17','3','5104.22'),
	T_JUDICIAL_DATA('67679','09/02/2016','17','3','3397.75'),
	T_JUDICIAL_DATA('67540','09/02/2016','17','3','3566.92'),
	T_JUDICIAL_DATA('67547','09/02/2016','17','3','2688.2'),
	T_JUDICIAL_DATA('67554','09/02/2016','17','3','4421.41'),
	T_JUDICIAL_DATA('67640','09/02/2016','17','3','3426.38'),
	T_JUDICIAL_DATA('67564','09/02/2016','17','3','4383.66'),
	T_JUDICIAL_DATA('67566','09/02/2016','17','3','4383.66'),
	T_JUDICIAL_DATA('67568','09/02/2016','17','3','4383.66'),
	T_JUDICIAL_DATA('67580','09/02/2016','17','3','4769.48'),
	T_JUDICIAL_DATA('67588','09/02/2016','17','3','3426.38'),
	T_JUDICIAL_DATA('67589','09/02/2016','17','3','4810.83'),
	T_JUDICIAL_DATA('67591','09/02/2016','17','3','3246.78'),
	T_JUDICIAL_DATA('67593','09/02/2016','17','3','3543.74'),
	T_JUDICIAL_DATA('67594','09/02/2016','17','3','3543.74'),
	T_JUDICIAL_DATA('67595','09/02/2016','17','3','3662.38'),
	T_JUDICIAL_DATA('67601','09/02/2016','17','3','3662.38'),
	T_JUDICIAL_DATA('67645','09/02/2016','17','3','4790.22'),
	T_JUDICIAL_DATA('67740','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67758','09/02/2016','17','3','3882.95'),
	T_JUDICIAL_DATA('67707','09/02/2016','17','3','4106.65'),
	T_JUDICIAL_DATA('67680','09/02/2016','17','3','4010.62'),
	T_JUDICIAL_DATA('67693','09/02/2016','17','3','45048.38'),
	T_JUDICIAL_DATA('67730','09/02/2016','17','3','51737.29'),
	T_JUDICIAL_DATA('67701','09/02/2016','17','3','60945.65'),
	T_JUDICIAL_DATA('67700','09/02/2016','17','3','39522.75'),
	T_JUDICIAL_DATA('67557','09/02/2016','17','3','4973.95'),
	T_JUDICIAL_DATA('67599','09/02/2016','17','3','3662.38'),
	T_JUDICIAL_DATA('67652','09/02/2016','17','3','3899.1'),
	T_JUDICIAL_DATA('67735','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67762','09/02/2016','17','3','3882.95'),
	T_JUDICIAL_DATA('67662','09/02/2016','17','3','3464.73'),
	T_JUDICIAL_DATA('67672','09/02/2016','17','3','4996.61'),
	T_JUDICIAL_DATA('67684','09/02/2016','17','3','3931.19'),
	T_JUDICIAL_DATA('67541','09/02/2016','17','3','3566.92'),
	T_JUDICIAL_DATA('67553','09/02/2016','17','3','4421.41'),
	T_JUDICIAL_DATA('67548','09/02/2016','17','3','4421.41'),
	T_JUDICIAL_DATA('67623','09/02/2016','17','3','5004.08'),
	T_JUDICIAL_DATA('67628','09/02/2016','17','3','4240.24'),
	T_JUDICIAL_DATA('67642','09/02/2016','17','3','3426.38'),
	T_JUDICIAL_DATA('67562','09/02/2016','17','3','4383.66'),
	T_JUDICIAL_DATA('67592','09/02/2016','17','3','3543.74'),
	T_JUDICIAL_DATA('67648','09/02/2016','17','3','3630.47'),
	T_JUDICIAL_DATA('67651','09/02/2016','17','3','3792.48'),
	T_JUDICIAL_DATA('67733','09/02/2016','17','3','5325.69'),
	T_JUDICIAL_DATA('67738','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67747','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67753','09/02/2016','17','3','3882.95'),
	T_JUDICIAL_DATA('67754','09/02/2016','17','3','3882.95'),
	T_JUDICIAL_DATA('67764','09/02/2016','17','3','3882.95'),
	T_JUDICIAL_DATA('67681','09/02/2016','17','3','3931.19'),
	T_JUDICIAL_DATA('67685','09/02/2016','17','3','3931.2'),
	T_JUDICIAL_DATA('67546','09/02/2016','17','3','2932.01'),
	T_JUDICIAL_DATA('67550','09/02/2016','17','3','4421.42'),
	T_JUDICIAL_DATA('67617','09/02/2016','17','3','4404.8'),
	T_JUDICIAL_DATA('67632','09/02/2016','17','3','3411.53'),
	T_JUDICIAL_DATA('67633','09/02/2016','17','3','4090.36'),
	T_JUDICIAL_DATA('67636','09/02/2016','17','3','3543.74'),
	T_JUDICIAL_DATA('67637','09/02/2016','17','3','3543.75'),
	T_JUDICIAL_DATA('67638','09/02/2016','17','3','3602.41'),
	T_JUDICIAL_DATA('67570','09/02/2016','17','3','4383.66'),
	T_JUDICIAL_DATA('67596','09/02/2016','17','3','3543.74'),
	T_JUDICIAL_DATA('67600','09/02/2016','17','3','3662.38'),
	T_JUDICIAL_DATA('67688','09/02/2016','17','3','4435.31'),
	T_JUDICIAL_DATA('67644','09/02/2016','17','3','3630.48'),
	T_JUDICIAL_DATA('67656','09/02/2016','17','3','3777.85'),
	T_JUDICIAL_DATA('67734','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67736','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67741','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67743','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67749','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67760','09/02/2016','17','3','3882.95'),
	T_JUDICIAL_DATA('67719','09/02/2016','17','3','4750.44'),
	T_JUDICIAL_DATA('67724','09/02/2016','17','3','3639.74'),
	T_JUDICIAL_DATA('67698','09/02/2016','17','3','5821.07'),
	T_JUDICIAL_DATA('67666','09/02/2016','17','3','4996.61'),
	T_JUDICIAL_DATA('67682','09/02/2016','17','3','3931.19'),
	T_JUDICIAL_DATA('67691','09/02/2016','17','3','42140.15'),
	T_JUDICIAL_DATA('67555','09/02/2016','17','3','4421.42'),
	T_JUDICIAL_DATA('67603','09/02/2016','17','3','4404.8'),
	T_JUDICIAL_DATA('67607','09/02/2016','17','3','4383.66'),
	T_JUDICIAL_DATA('67609','09/02/2016','17','3','4383.66'),
	T_JUDICIAL_DATA('67611','09/02/2016','17','3','4383.66'),
	T_JUDICIAL_DATA('67621','09/02/2016','17','3','4816.18'),
	T_JUDICIAL_DATA('67626','09/02/2016','17','3','4433.69'),
	T_JUDICIAL_DATA('67641','09/02/2016','17','3','3426.38'),
	T_JUDICIAL_DATA('67582','09/02/2016','17','3','3425.05'),
	T_JUDICIAL_DATA('67597','09/02/2016','17','3','3366.43'),
	T_JUDICIAL_DATA('67643','09/02/2016','17','3','3630.47'),
	T_JUDICIAL_DATA('67649','09/02/2016','17','3','3630.47'),
	T_JUDICIAL_DATA('67650','09/02/2016','17','3','3108.74'),
	T_JUDICIAL_DATA('67657','09/02/2016','17','3','3777.85'),
	T_JUDICIAL_DATA('67660','09/02/2016','17','3','3630.47'),
	T_JUDICIAL_DATA('67750','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67756','09/02/2016','17','3','3882.95'),
	T_JUDICIAL_DATA('67759','09/02/2016','17','3','3882.95'),
	T_JUDICIAL_DATA('67767','09/02/2016','17','3','3882.95'),
	T_JUDICIAL_DATA('67705','09/02/2016','17','3','3246.02'),
	T_JUDICIAL_DATA('67711','09/02/2016','17','3','4591.57'),
	T_JUDICIAL_DATA('67727','09/02/2016','17','3','5402.93'),
	T_JUDICIAL_DATA('67729','09/02/2016','17','3','3606.21'),
	T_JUDICIAL_DATA('67697','09/02/2016','17','3','5114.01'),
	T_JUDICIAL_DATA('67670','09/02/2016','17','3','4996.61'),
	T_JUDICIAL_DATA('67676','09/02/2016','17','3','5104.22'),
	T_JUDICIAL_DATA('67683','09/02/2016','17','3','3931.19'),
	T_JUDICIAL_DATA('67545','09/02/2016','17','3','3566.91'),
	T_JUDICIAL_DATA('67558','09/02/2016','17','3','4509.78'),
	T_JUDICIAL_DATA('67549','09/02/2016','17','3','4421.42'),
	T_JUDICIAL_DATA('67615','09/02/2016','17','3','4388.11'),
	T_JUDICIAL_DATA('67630','09/02/2016','17','3','5480.66'),
	T_JUDICIAL_DATA('67639','09/02/2016','17','3','3602.41'),
	T_JUDICIAL_DATA('67576','09/02/2016','17','3','4951.82'),
	T_JUDICIAL_DATA('67653','09/02/2016','17','3','3630.47'),
	T_JUDICIAL_DATA('67739','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67744','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67746','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67751','09/02/2016','17','3','3882.95'),
	T_JUDICIAL_DATA('67725','09/02/2016','17','3','4892.84'),
	T_JUDICIAL_DATA('67686','09/02/2016','17','3','3931.19'),
	T_JUDICIAL_DATA('66965',null,'17','3','115623.2'),
	T_JUDICIAL_DATA('67543','09/02/2016','17','3','4344.01'),
	T_JUDICIAL_DATA('67559','09/02/2016','17','3','4973.95'),
	T_JUDICIAL_DATA('67551','09/02/2016','17','3','5089.55'),
	T_JUDICIAL_DATA('67605','09/02/2016','17','3','4383.66'),
	T_JUDICIAL_DATA('67625','09/02/2016','17','3','3426.38'),
	T_JUDICIAL_DATA('67560','09/02/2016','17','3','4404.8'),
	T_JUDICIAL_DATA('67572','09/02/2016','17','3','4383.66'),
	T_JUDICIAL_DATA('67578','09/02/2016','17','3','4816.18'),
	T_JUDICIAL_DATA('67583','09/02/2016','17','3','3248.45'),
	T_JUDICIAL_DATA('67584','09/02/2016','17','3','3426.38'),
	T_JUDICIAL_DATA('67586','09/02/2016','17','3','4507.08'),
	T_JUDICIAL_DATA('67647','09/02/2016','17','3','3668.74'),
	T_JUDICIAL_DATA('67654','09/02/2016','17','3','3668.74'),
	T_JUDICIAL_DATA('67655','09/02/2016','17','3','3630.47'),
	T_JUDICIAL_DATA('67658','09/02/2016','17','3','3630.47'),
	T_JUDICIAL_DATA('67661','09/02/2016','17','3','3630.47'),
	T_JUDICIAL_DATA('67737','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67742','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67748','09/02/2016','17','3','4269.8'),
	T_JUDICIAL_DATA('67702','09/02/2016','17','3','4138.33'),
	T_JUDICIAL_DATA('67703','9/02/2016','17','3','3789.03'),
	T_JUDICIAL_DATA('67706','09/02/2016','17','3','3430.08'),
	T_JUDICIAL_DATA('67713','09/02/2016','17','3','4433.91'),
	T_JUDICIAL_DATA('67696','09/02/2016','17','3','5297.61'),
	T_JUDICIAL_DATA('67664','09/02/2016','17','3','5171.82'),
	T_JUDICIAL_DATA('67668','09/02/2016','17','3','4996.61'),
	T_JUDICIAL_DATA('67678','09/02/2016','17','3','3931.2'),
	T_JUDICIAL_DATA('67692','09/02/2016','17','3','42140.15'),
	T_JUDICIAL_DATA('67843',null,'17','3','35413.3'),
	T_JUDICIAL_DATA('67830','22/05/2013','17','3','123000'),
	T_JUDICIAL_DATA('67957','01/12/2015','17','3','28898.45'),
	T_JUDICIAL_DATA('67958','01/12/2015','17','3','25775.55')

  ); 
  V_TMP_TIPO_DATA T_JUDICIAL_DATA;
  
BEGIN

   DBMS_OUTPUT.PUT_LINE('[INFO] INICIO DEL PROCESO, DE INSERCION DE NUEVOS REGISTROS EN ACT_AJD_ADJJUDICIAL Y ACTUALIZACION de BIE_ADJ_ADJUDICACION');
   
   V_SQL := '
   ALTER SESSION SET NLS_DATE_FORMAT = ''DD/MM/RR''
   '
   ;
   
   EXECUTE IMMEDIATE V_SQL;
   
   FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
     LOOP
    
       V_TMP_TIPO_DATA := V_TIPO_DATA(I);
       	
       --COMPROBAMOS AL EXISTENCIA DEL ACTIVO MEDIANTE EL ACT_NUM_ACTIVO_PRINEX EN ACT_ACTIVO
       
       V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT 
       WHERE ACT_NUM_ACTIVO_PRINEX = '||V_TMP_TIPO_DATA(1)||'';
       EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
       
       --SI EXISTE, ACTUALIZAMOS SU TIPO Y SUBTIPO DE TITULO EN ACT_ACTIVO 
       
       IF V_NUM_TABLAS > 0 THEN		         
			                              
          V_SQL := '
		  MERGE INTO '||V_ESQUEMA||'.ACT_AJD_ADJJUDICIAL AJD
		  USING
		  (
		  SELECT ACT.ACT_ID AS ACT_ID, ACT.BIE_ID AS BIE_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
		  WHERE ACT.ACT_NUM_ACTIVO_PRINEX = '||V_TMP_TIPO_DATA(1)||'
		  ) TMP
		  ON (AJD.ACT_ID = TMP.ACT_ID)      
		  WHEN MATCHED THEN UPDATE 
		  SET 
		  DD_EDJ_ID = (SELECT DD_EDJ_ID FROM '||V_ESQUEMA||'.DD_EDJ_ESTADO_ADJUDICACION EDJ WHERE EDJ.DD_EDJ_CODIGO = '||V_TMP_TIPO_DATA(4)||'),
		  DD_EEJ_ID = (SELECT DD_EEJ_ID FROM '||V_ESQUEMA||'.DD_EEJ_ENTIDAD_EJECUTANTE EEJ WHERE EEJ.DD_EEJ_CODIGO = '||V_TMP_TIPO_DATA(3)||'),
		  AJD_FECHA_ADJUDICACION = '''||V_TMP_TIPO_DATA(2)||''',
		  USUARIOMODIFICAR = ''HREOS-345'',
		  FECHAMODIFICAR = SYSDATE
		  WHEN NOT MATCHED THEN INSERT
		  (AJD_ID,
		  ACT_ID,
		  BIE_ADJ_ID,
		  DD_EDJ_ID,
		  DD_EEJ_ID,
		  AJD_FECHA_ADJUDICACION,
		  USUARIOCREAR,
		  FECHACREAR)
		  VALUES
		  (S_ACT_AJD_ADJJUDICIAL.NEXTVAL,
		  (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
		  WHERE ACT.ACT_NUM_ACTIVO_PRINEX = '||V_TMP_TIPO_DATA(1)||'),
		  (SELECT BIE.BIE_ADJ_ID FROM '||V_ESQUEMA||'.BIE_ADJ_ADJUDICACION BIE
		  WHERE BIE.BIE_ID = (SELECT BIE_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT WHERE ACT.ACT_NUM_ACTIVO_PRINEX = '||V_TMP_TIPO_DATA(1)||')),
		  (SELECT DD_EDJ_ID FROM '||V_ESQUEMA||'.DD_EDJ_ESTADO_ADJUDICACION EDJ
		  WHERE EDJ.DD_EDJ_ID = '||V_TMP_TIPO_DATA(4)||'),  
		  (SELECT DD_EEJ_ID FROM '||V_ESQUEMA||'.DD_EEJ_ENTIDAD_EJECUTANTE EEJ
		  WHERE EEJ.DD_EEJ_CODIGO = '||V_TMP_TIPO_DATA(3)||'),                                                   
		  '''||V_TMP_TIPO_DATA(2)||''',                                                                                 
		  ''HREOS-345'',                                                                                    
		  SYSDATE)
          '
          ;
                            
          EXECUTE IMMEDIATE V_SQL;   
          
          V_SQL := '
		  UPDATE '||V_ESQUEMA||'.BIE_ADJ_ADJUDICACION ADJ
		  SET ADJ.BIE_ADJ_IMPORTE_ADJUDICACION = '''||V_TMP_TIPO_DATA(5)||''',
		  USUARIOMODIFICAR = ''HREOS-345'',
		  FECHAMODIFICAR = SYSDATE
		  WHERE BIE_ID = (SELECT BIE_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT WHERE ACT.ACT_NUM_ACTIVO_PRINEX = '||V_TMP_TIPO_DATA(1)||')
          '
          ;
                            
          EXECUTE IMMEDIATE V_SQL;
          
       ELSE
       
                DBMS_OUTPUT.PUT_LINE('[INFO] EL ACTIVO DE PRINEX INFORMADO '||V_TMP_TIPO_DATA(1)||' NO EXISTE EN ACT_ACTIVO');
                
       END IF;               
      
    END LOOP;
    
    COMMIT;
  
    EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.ACT_AJD_ADJJUDICIAL COMPUTE STATISTICS');
  
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.ACT_AJD_ADJJUDICIAL ANALIZADA.');
    
    EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.BIE_ADJ_ADJUDICACION COMPUTE STATISTICS');
  
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.BIE_ADJ_ADJUDICACION ANALIZADA.');
      
    DBMS_OUTPUT.PUT_LINE('[FIN] LA TABLA ACT_AJD_ADJJUDICIAL Y BIE_ADJ_ADJUDICACION SE HAN ACTUALIZADO CORRECTAMENTE');
 
 
EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
