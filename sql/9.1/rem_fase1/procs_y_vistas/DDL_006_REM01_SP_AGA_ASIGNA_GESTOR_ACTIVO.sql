--/*
--##########################################
--## AUTOR=DAVID GONZALEZ
--## FECHA_CREACION=20160519
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.1
--## INCIDENCIA_LINK=0
--## PRODUCTO=NO
--## Finalidad: Procedimiento que asigna Gestores a Activos: GESTOR DE ACTIVO (POR ACTIVO), GESTOR DE ADMISION (TODOS LOS ACTIVOS),
--##			SUPERVISOR DE ADMISION (TODOS LOS ACTIVOS), GESTORIAS DE ADMISION*, SUPERVISOR DEL ACTIVO*
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##		0.2 [HREOS-467] Se declara una variable de entrada para setear el USUARIOCREAR o USUARIOMODIFICAR en función de quien lo llame.
--##			También se añade la mejora de pasarle la variable PL_OUTPUT al ETL para que muestre los registros insertados.
--##		0.3 [HREOS-581] Sacar la provincia desde BIE_LOCALIZACION.DD_PRV_ID, en vez de BIE_LOCALIZACION.BIE_LOC_PROVINCIA
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

create or replace PROCEDURE SP_AGA_ASIGNA_GESTOR_ACTIVO (
	V_USUARIO	VARCHAR2 DEFAULT 'SP_AGA',
	PL_OUTPUT       OUT VARCHAR2
)
AS
--v0.3

V_ESQUEMA VARCHAR2(15 CHAR) := '#ESQUEMA#';
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := '#ESQUEMA_MASTER#';
V_NUM NUMBER(8);
v_count_1 NUMBER(8);

BEGIN

  DBMS_OUTPUT.PUT_LINE('[INFO] SE VA A PROCEDER A CREAR LA RELACION DE ACTIVOS CON SU GESTOR.');

  
  DBMS_OUTPUT.PUT_LINE('[INFO] CREANDO TABLA TEMPORAL TMP_GEST_ACT...');
  DBMS_OUTPUT.PUT_LINE('');

  EXECUTE IMMEDIATE '
  SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME LIKE ''TMP_GEST_ACT'' AND OWNER LIKE '''||V_ESQUEMA||'''
  '
  INTO V_NUM
  ;

  IF V_NUM != 0 THEN

    EXECUTE IMMEDIATE '
    DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
    '
    ;

  END IF;

  EXECUTE IMMEDIATE '
    CREATE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT (
      ACT_ID                      NUMBER(16,0),
      USUARIO_GESTION_ACTIVOS     VARCHAR2(10 CHAR),
      USU_ID                      NUMBER(16,0),
      NOMBRE_GESTION_ACTIVOS      VARCHAR2(150 CHAR),
      GEE_ID                      NUMBER(16,0),
      GEH_ID                      NUMBER(16,0)
    )
  '
  ;
  
--------------------------------------------------------------------
----------- ASIGNAMOS GESTORES DE ACTIVO ---------------------------
--------------------------------------------------------------------

  DBMS_OUTPUT.PUT_LINE('[INFO] --GESTORES DEL ACTIVO--');
  DBMS_OUTPUT.PUT_LINE('[INFO] RELACIONANDO ACTIVOS CON GESTORES POR CÓDIGO POSTAL...');
  DBMS_OUTPUT.PUT_LINE('');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.TMP_GEST_ACT (
    ACT_ID,
    USUARIO_GESTION_ACTIVOS,
    NOMBRE_GESTION_ACTIVOS,
    GEE_ID,
    GEH_ID
  )
  WITH GESTOR_ACTIVOS_NO_INSERTAR AS (
    SELECT DISTINCT ACT.ACT_NUM_ACTIVO, GEH.GEH_ID, GEE.GEE_ID, GEE.DD_TGE_ID, TGE.DD_TGE_DESCRIPCION
    FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
    INNER JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
      ON ACT.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
      ON GAC.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
      ON GEH.GEH_ID = GAH.GEH_ID
    INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
      ON GEE.GEE_ID = GAC.GEE_ID
    LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR TGE
      ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
    WHERE TGE.DD_TGE_ID IS NOT NULL
    AND TGE.DD_TGE_DESCRIPCION = ''Gestor de activos''
    AND GEE.BORRADO = 0
  )
  SELECT
  ACT_ID,
  USUARIO_GESTION_ACTIVOS,
  NOMBRE_GESTION_ACTIVOS,
  s_gee_gestor_entidad.NEXTVAL gee_id,
  s_geh_gestor_entidad_hist.NEXTVAL geh_id
  FROM (
  SELECT ACT.ACT_ID, ACT.ACT_NUM_ACTIVO, BIE.BIE_LOC_COD_POST, COD.*
  FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
  INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE
    ON ACT.BIE_ID = BIE.BIE_ID
  LEFT JOIN ACT_GES_DISTRIBUCION COD
    ON COD.COD_POSTAL = BIE.BIE_LOC_COD_POST
  LEFT JOIN '||V_ESQUEMA||'.TMP_GEST_ACT GEACT
    ON GEACT.ACT_ID = ACT.ACT_ID
  WHERE BIE_LOC_COD_POST IS NOT NULL
  AND BIE_LOC_COD_POST != ''0''
  AND COD.COD_POSTAL IS NOT NULL
  AND GEACT.ACT_ID IS NULL
  and NOT EXISTS (
  SELECT 1 FROM GESTOR_ACTIVOS_NO_INSERTAR TMP WHERE TMP.ACT_NUM_ACTIVO = ACT.ACT_NUM_ACTIVO
  )
  )
  '
  ;

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' TMP_GEST_ACT cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.TMP_GEST_ACT ANALIZADA.');

  DBMS_OUTPUT.PUT_LINE('[INFO] RELACIONANDO ACTIVOS CON GESTORES POR MUNICIPIO...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.TMP_GEST_ACT (
    ACT_ID,
    USUARIO_GESTION_ACTIVOS,
    NOMBRE_GESTION_ACTIVOS,
    GEE_ID,
    GEH_ID
  )
  WITH GESTOR_ACTIVOS_NO_INSERTAR AS (
    SELECT DISTINCT ACT.ACT_NUM_ACTIVO, GEH.GEH_ID, GEE.GEE_ID, GEE.DD_TGE_ID, TGE.DD_TGE_DESCRIPCION
    FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
    INNER JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
      ON ACT.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
      ON GAC.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
      ON GEH.GEH_ID = GAH.GEH_ID
    INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
      ON GEE.GEE_ID = GAC.GEE_ID
    LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR TGE
      ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
    WHERE TGE.DD_TGE_ID IS NOT NULL
    AND TGE.DD_TGE_DESCRIPCION = ''Gestor de activos''
    AND GEE.BORRADO = 0
  )
  SELECT
  ACT_ID,
  USUARIO_GESTION_ACTIVOS,
  NOMBRE_GESTION_ACTIVOS,
  s_gee_gestor_entidad.NEXTVAL gee_id,
  s_geh_gestor_entidad_hist.NEXTVAL geh_id
  FROM (
  WITH LOCALIDADES AS (
    SELECT * FROM '||V_ESQUEMA||'.ACT_GES_DISTRIBUCION WHERE COD_MUNICIPIO IS NOT NULL AND COD_POSTAL IS NULL
    )
  SELECT ACT.ACT_ID, ACT.ACT_NUM_ACTIVO, BIE.DD_UPO_ID, DD.DD_UPO_CODIGO, LOC.*
  FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
  INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE
    ON ACT.BIE_ID = BIE.BIE_ID
  LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_UPO_UNID_POBLACIONAL DD
    ON DD.DD_UPO_ID = BIE.DD_UPO_ID
  LEFT JOIN LOCALIDADES LOC
    ON LOC.COD_MUNICIPIO = DD.DD_UPO_CODIGO
  LEFT JOIN '||V_ESQUEMA||'.TMP_GEST_ACT GEACT
    ON GEACT.ACT_ID = ACT.ACT_ID
  WHERE BIE.DD_UPO_ID IS NOT NULL
  AND BIE.DD_UPO_ID != 0
  AND LOC.COD_MUNICIPIO IS NOT NULL
  AND GEACT.ACT_ID IS NULL
  and NOT EXISTS (
  SELECT 1 FROM GESTOR_ACTIVOS_NO_INSERTAR TMP WHERE TMP.ACT_NUM_ACTIVO = ACT.ACT_NUM_ACTIVO
  )
  )
  '
  ;

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' TMP_GEST_ACT cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.TMP_GEST_ACT ANALIZADA.');

  DBMS_OUTPUT.PUT_LINE('[INFO] RELACIONANDO ACTIVOS CON GESTORES POR PROVINCIA...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.TMP_GEST_ACT (
    ACT_ID,
    USUARIO_GESTION_ACTIVOS,
    NOMBRE_GESTION_ACTIVOS,
    GEE_ID,
    GEH_ID
  )
  WITH GESTOR_ACTIVOS_NO_INSERTAR AS (
    SELECT DISTINCT ACT.ACT_NUM_ACTIVO, GEH.GEH_ID, GEE.GEE_ID, GEE.DD_TGE_ID, TGE.DD_TGE_DESCRIPCION
    FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
    INNER JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
      ON ACT.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
      ON GAC.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
      ON GEH.GEH_ID = GAH.GEH_ID
    INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
      ON GEE.GEE_ID = GAC.GEE_ID
    LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR TGE
      ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
    WHERE TGE.DD_TGE_ID IS NOT NULL
    AND TGE.DD_TGE_DESCRIPCION = ''Gestor de activos''
    AND GEE.BORRADO = 0
  )
  SELECT
  ACT_ID,
  USUARIO_GESTION_ACTIVOS,
  NOMBRE_GESTION_ACTIVOS,
  s_gee_gestor_entidad.NEXTVAL gee_id,
  s_geh_gestor_entidad_hist.NEXTVAL geh_id
  FROM (
  WITH PROVINCIAS AS (
    SELECT GES.*, PRV.DD_PRV_ID
    FROM '||V_ESQUEMA||'.ACT_GES_DISTRIBUCION GES
    LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_PRV_PROVINCIA PRV
    ON PRV.DD_PRV_CODIGO = GES.COD_PROVINCIA
    WHERE COD_PROVINCIA IS NOT NULL AND COD_POSTAL IS NULL AND COD_MUNICIPIO IS NULL
    AND PRV.DD_PRV_ID IS NOT NULL
    )
  SELECT ACT.ACT_ID, ACT.ACT_NUM_ACTIVO, BIE.BIE_LOC_PROVINCIA, PRV.*
  FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
  INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE
    ON ACT.BIE_ID = BIE.BIE_ID
  LEFT JOIN PROVINCIAS PRV
    ON PRV.DD_PRV_ID = BIE.DD_PRV_ID
  LEFT JOIN '||V_ESQUEMA||'.TMP_GEST_ACT GEACT
    ON GEACT.ACT_ID = ACT.ACT_ID
  WHERE BIE.DD_PRV_ID IS NOT NULL
  AND BIE.DD_PRV_ID != 0
  AND GEACT.ACT_ID IS NULL
  and NOT EXISTS (
  SELECT 1 FROM GESTOR_ACTIVOS_NO_INSERTAR TMP WHERE TMP.ACT_NUM_ACTIVO = ACT.ACT_NUM_ACTIVO
  )
  )
  '
  ;

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' TMP_GEST_ACT cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.TMP_GEST_ACT ANALIZADA.');

  DBMS_OUTPUT.PUT_LINE('[INFO] BUSCANDO ACTIVOS QUE NO HAN SIDO RELACIONADOS CON GESTORES...');

  EXECUTE IMMEDIATE '
  SELECT COUNT(ACT_ID)
  FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
  INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE
    ON BIE.BIE_ID = ACT.BIE_ID
  WHERE ACT_ID NOT IN (SELECT ACT_ID FROM '||V_ESQUEMA||'.TMP_GEST_ACT)
  '
  INTO V_NUM
  ;

  IF V_NUM = 0 THEN

    DBMS_OUTPUT.PUT_LINE('[INFO] SE HA ASIGNADO GESTOR A TODOS LOS ACTIVOS.');

  ELSE

    DBMS_OUTPUT.PUT_LINE('[INFO] EXISTEN '||V_NUM||' ACTIVOS A LOS QUE NO SE HA ASIGNADO GESTOR. SE LES ASIGNARÁ EL GESTOR DEL ACTIVO POR DEFECTO ''lfabe''.');

  END IF;

  DBMS_OUTPUT.PUT_LINE('[INFO] ASIGNANDO USU_ID PARA CADA GESTOR.');

  EXECUTE IMMEDIATE '
  MERGE INTO '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  USING
  (SELECT DISTINCT USU.USU_ID, USU.USU_USERNAME FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU
  INNER JOIN '||V_ESQUEMA||'.TMP_GEST_ACT TMP
    ON USU.USU_USERNAME = TMP.USUARIO_GESTION_ACTIVOS) USU_ID
  ON (TMP.USUARIO_GESTION_ACTIVOS = USU_ID.USU_USERNAME)
  WHEN MATCHED THEN UPDATE
  SET TMP.USU_ID = 
  USU_ID.USU_ID
  '
  ;

  --ASIGNAMOS EL GESTOR POR DEFECTO 'GESTACT' GESTOR DE ACTIVOS, PARA LOS ACTIVOS QUE A LOS QUE NO SE LES HA ASIGNADO UN GESTOR.
  
  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.TMP_GEST_ACT (
    ACT_ID,
    GEE_ID,
    GEH_ID
  )
  WITH GESTOR_ACTIVOS_NO_INSERTAR AS (
    SELECT DISTINCT ACT.ACT_NUM_ACTIVO, GEH.GEH_ID, GEE.GEE_ID, GEE.DD_TGE_ID, TGE.DD_TGE_DESCRIPCION
    FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
    INNER JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
      ON ACT.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
      ON GAC.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
      ON GEH.GEH_ID = GAH.GEH_ID
    INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
      ON GEE.GEE_ID = GAC.GEE_ID
    LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR TGE
      ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
    WHERE TGE.DD_TGE_ID IS NOT NULL
    AND TGE.DD_TGE_DESCRIPCION = ''Gestor de activos''
    AND GEE.BORRADO = 0
  )
  SELECT
  ACT_ID,
  s_gee_gestor_entidad.NEXTVAL gee_id,
  s_geh_gestor_entidad_hist.NEXTVAL geh_id
  FROM (
  SELECT ACT.ACT_ID, ACT.ACT_NUM_ACTIVO
  FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
  INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE
    ON ACT.BIE_ID = BIE.BIE_ID
  LEFT JOIN '||V_ESQUEMA||'.TMP_GEST_ACT GEACT
    ON GEACT.ACT_ID = ACT.ACT_ID
  WHERE GEACT.ACT_ID IS NULL
  and NOT EXISTS (
  SELECT 1 FROM GESTOR_ACTIVOS_NO_INSERTAR TMP WHERE TMP.ACT_NUM_ACTIVO = ACT.ACT_NUM_ACTIVO
  )
  )
  '
  ;
  
  COMMIT;

  EXECUTE IMMEDIATE '
  UPDATE '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  SET TMP.USU_ID = (SELECT USU.USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU WHERE USU.USU_USERNAME = ''lfabe''),
  TMP.USUARIO_GESTION_ACTIVOS = (SELECT USU.USU_USERNAME FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU WHERE USU.USU_USERNAME = ''lfabe''),
  TMP.NOMBRE_GESTION_ACTIVOS = (SELECT USU.USU_NOMBRE FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU WHERE USU.USU_USERNAME = ''lfabe'')
  WHERE USU_ID IS NULL
  '
  ;

  COMMIT;

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GEE_GESTOR_ENTIDAD...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD (
  gee_id,
  usu_id,
  dd_tge_id,
  VERSION,
  usuariocrear,
  fechacrear,
  borrado
  )
  SELECT
  TMP.gee_id,
  TMP.usu_id,
  (SELECT dd_tge_id FROM '||V_ESQUEMA_MASTER||'.dd_tge_tipo_gestor WHERE dd_tge_codigo = ''GACT''),
  0,
  '''||V_USUARIO||''',
  SYSDATE,
  0
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := '[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD PARA GESTORES DEL ACTIVO. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GEE_GESTOR_ENTIDAD cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GAC_GESTOR_ADD_ACTIVO...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO (
  gee_id,
  act_id
  )
  SELECT
  TMP.gee_id,
  TMP.act_id
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO PARA GESTORES DEL ACTIVO. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GAC_GESTOR_ADD_ACTIVO cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GEH_GESTOR_ENTIDAD_HIST...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST (
  geh_id,
  usu_id,
  dd_tge_id,
  geh_fecha_desde,
  geh_fecha_hasta,
  VERSION,
  usuariocrear,
  fechacrear,
  borrado
  )
  SELECT
  tmp.geh_id,
  tmp.usu_id,
  gee.dd_tge_id,
  SYSDATE,
  NULL,
  1,
  '''||V_USUARIO||''',
  SYSDATE,
  0
  FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
  INNER JOIN '||V_ESQUEMA||'.TMP_GEST_ACT TMP
    ON TMP.GEE_ID = GEE.GEE_ID
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  --PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST PARA GESTORES DEL ACTIVO. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GEH_GESTOR_ENTIDAD_HIST cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GAH_GESTOR_ACTIVO_HISTORICO...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO (
  geh_id,
  act_id
  )
  SELECT
  TMP.geh_id,
  TMP.act_id
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO PARA GESTORES DEL ACTIVO. '||CHR(10)||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GAH_GESTOR_ACTIVO_HISTORICO cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO COMPUTE STATISTICS');
  
  EXECUTE IMMEDIATE '
  DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT PURGE
  '
  ;
  
  DBMS_OUTPUT.PUT_LINE('');
  DBMS_OUTPUT.PUT_LINE('');
----------------------------------------------------------------------
----------- ASIGNAMOS GESTORES DE ADMISION ---------------------------
----------------------------------------------------------------------

  EXECUTE IMMEDIATE '
  SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME LIKE ''TMP_GEST_ACT'' AND OWNER LIKE '''||V_ESQUEMA||'''
  '
  INTO V_NUM
  ;

  IF V_NUM != 0 THEN

    EXECUTE IMMEDIATE '
    DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
    '
    ;

  END IF;

  EXECUTE IMMEDIATE '
    CREATE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT (
      ACT_ID                      NUMBER(16,0),
      USUARIO_GESTION_ACTIVOS     VARCHAR2(10 CHAR),
      USU_ID                      NUMBER(16,0),
      NOMBRE_GESTION_ACTIVOS      VARCHAR2(150 CHAR),
      GEE_ID                      NUMBER(16,0),
      GEH_ID                      NUMBER(16,0)
    )
  '
  ;

  --ASIGNAMOS GESTORES DE ADMISION 'GESTADM' A TODOS LOS ACTIVOS

  DBMS_OUTPUT.PUT_LINE('[INFO] --GESTORES DE ADMISIÓN--');
  DBMS_OUTPUT.PUT_LINE('[INFO] SE ASIGNARÁ EL GESTOR DE ADMISIÓN POR DEFECTO ''GESTADM'' PARA TODOS LOS ACTIVOS.');
  DBMS_OUTPUT.PUT_LINE('');
  
  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.TMP_GEST_ACT (
    ACT_ID,
    GEE_ID,
    GEH_ID
  )
  WITH GESTOR_ADMISION_NO_INSERTAR AS (
    SELECT DISTINCT ACT.ACT_NUM_ACTIVO, GEH.GEH_ID, GEE.GEE_ID, GEE.DD_TGE_ID, TGE.DD_TGE_DESCRIPCION
    FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
    INNER JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
      ON ACT.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
      ON GAC.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
      ON GEH.GEH_ID = GAH.GEH_ID
    INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
      ON GEE.GEE_ID = GAC.GEE_ID
    LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR TGE
      ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
    WHERE TGE.DD_TGE_ID IS NOT NULL
    AND TGE.DD_TGE_DESCRIPCION = ''Gestor de admisión''
    AND GEE.BORRADO = 0
)
  SELECT
  ACT_ID,
  s_gee_gestor_entidad.NEXTVAL gee_id,
  s_geh_gestor_entidad_hist.NEXTVAL geh_id
  FROM (
  SELECT ACT.ACT_ID, ACT.ACT_NUM_ACTIVO
  FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
  INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE
    ON ACT.BIE_ID = BIE.BIE_ID
  LEFT JOIN '||V_ESQUEMA||'.TMP_GEST_ACT GEACT
    ON GEACT.ACT_ID = ACT.ACT_ID
  WHERE GEACT.ACT_ID IS NULL
  and NOT EXISTS (
  SELECT 1 FROM GESTOR_ADMISION_NO_INSERTAR TMP WHERE TMP.ACT_NUM_ACTIVO = ACT.ACT_NUM_ACTIVO
  )
  )
  '
  ;

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' TMP_GEST_ACT cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.TMP_GEST_ACT ANALIZADA.');
  
  EXECUTE IMMEDIATE '
  UPDATE '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  SET TMP.USU_ID = (SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME = ''GESTADM'')
  '
  ;

  EXECUTE IMMEDIATE '
  UPDATE '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  SET TMP.GEE_ID = '||V_ESQUEMA||'.S_GEE_GESTOR_ENTIDAD.NEXTVAL
  '
  ;

  EXECUTE IMMEDIATE '
  UPDATE '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  SET TMP.GEH_ID = '||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL
  '
  ;

  --ASIGNAMOS GESTORES DE ADMISION

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GEE_GESTOR_ENTIDAD...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD (
  gee_id,
  usu_id,
  dd_tge_id,
  VERSION,
  usuariocrear,
  fechacrear,
  borrado
  )
  SELECT
  TMP.gee_id,
  TMP.usu_id,
  (SELECT dd_tge_id FROM '||V_ESQUEMA_MASTER||'.dd_tge_tipo_gestor WHERE dd_tge_codigo = ''GADM''),
  0,
  '''||V_USUARIO||''',
  SYSDATE,
  0
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD PARA GESTORES DE ADMISIÓN. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GEE_GESTOR_ENTIDAD cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GAC_GESTOR_ADD_ACTIVO...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO (
  gee_id,
  act_id
  )
  SELECT
  TMP.gee_id,
  TMP.act_id
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO PARA GESTORES DE ADMISIÓN. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GAC_GESTOR_ADD_ACTIVO cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GEH_GESTOR_ENTIDAD_HIST...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST (
  geh_id,
  usu_id,
  dd_tge_id,
  geh_fecha_desde,
  geh_fecha_hasta,
  VERSION,
  usuariocrear,
  fechacrear,
  borrado
  )
  SELECT
  tmp.geh_id,
  tmp.usu_id,
  gee.dd_tge_id,
  SYSDATE,
  NULL,
  1,
  '''||V_USUARIO||''',
  SYSDATE,
  0
  FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
  INNER JOIN '||V_ESQUEMA||'.TMP_GEST_ACT TMP
    ON TMP.GEE_ID = GEE.GEE_ID
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST PARA GESTORES DE ADMISIÓN. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GEH_GESTOR_ENTIDAD_HIST cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GAH_GESTOR_ACTIVO_HISTORICO...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO (
  geh_id,
  act_id
  )
  SELECT
  TMP.geh_id,
  TMP.act_id
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO PARA GESTORES DE ADMISIÓN. '||CHR(10)||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GAH_GESTOR_ACTIVO_HISTORICO cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO COMPUTE STATISTICS');

  EXECUTE IMMEDIATE '
  DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT PURGE
  '
  ;
  
----------------------------------------------------------------------
----------- ASIGNAMOS SUPERVISOR DE ADMISION -------------------------
----------------------------------------------------------------------

  EXECUTE IMMEDIATE '
  SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME LIKE ''TMP_GEST_ACT'' AND OWNER LIKE '''||V_ESQUEMA||'''
  '
  INTO V_NUM
  ;

  IF V_NUM != 0 THEN

    EXECUTE IMMEDIATE '
    DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
    '
    ;

  END IF;

  EXECUTE IMMEDIATE '
    CREATE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT (
      ACT_ID                      NUMBER(16,0),
      USUARIO_GESTION_ACTIVOS     VARCHAR2(10 CHAR),
      USU_ID                      NUMBER(16,0),
      NOMBRE_GESTION_ACTIVOS      VARCHAR2(150 CHAR),
      GEE_ID                      NUMBER(16,0),
      GEH_ID                      NUMBER(16,0)
    )
  '
  ;

  --ASIGNAMOS GESTORES DE ADMISION 'GESTADM' A TODOS LOS ACTIVOS

  DBMS_OUTPUT.PUT_LINE('[INFO] --SUPERVISOR DE ADMISIÓN--');
  DBMS_OUTPUT.PUT_LINE('[INFO] SE ASIGNARÁ EL SUPERVISOR DE ADMISIÓN ''SUPADM'' PARA TODOS LOS ACTIVOS.');
  DBMS_OUTPUT.PUT_LINE('');
  
  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.TMP_GEST_ACT (
    ACT_ID,
    GEE_ID,
    GEH_ID
  )
  WITH SUPADM_NO_INSERTAR AS (
    SELECT DISTINCT ACT.ACT_NUM_ACTIVO, GEH.GEH_ID, GEE.GEE_ID, GEE.DD_TGE_ID, TGE.DD_TGE_DESCRIPCION
    FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
    INNER JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
      ON ACT.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
      ON GAC.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
      ON GEH.GEH_ID = GAH.GEH_ID
    INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
      ON GEE.GEE_ID = GAC.GEE_ID
    LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR TGE
      ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
    WHERE TGE.DD_TGE_ID IS NOT NULL
    AND TGE.DD_TGE_DESCRIPCION = ''Supervisor de admisión''
    AND GEE.BORRADO = 0
)
  SELECT
  ACT_ID,
  s_gee_gestor_entidad.NEXTVAL gee_id,
  s_geh_gestor_entidad_hist.NEXTVAL geh_id
  FROM (
  SELECT ACT.ACT_ID, ACT.ACT_NUM_ACTIVO
  FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
  INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE
    ON ACT.BIE_ID = BIE.BIE_ID
  LEFT JOIN '||V_ESQUEMA||'.TMP_GEST_ACT GEACT
    ON GEACT.ACT_ID = ACT.ACT_ID
  WHERE GEACT.ACT_ID IS NULL
  and NOT EXISTS (
  SELECT 1 FROM SUPADM_NO_INSERTAR TMP WHERE TMP.ACT_NUM_ACTIVO = ACT.ACT_NUM_ACTIVO
  )
  )
  '
  ;

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' TMP_GEST_ACT cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.TMP_GEST_ACT ANALIZADA.');
  
  EXECUTE IMMEDIATE '
  UPDATE '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  SET TMP.USU_ID = (SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME = ''SUPADM'')
  '
  ;

  EXECUTE IMMEDIATE '
  UPDATE '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  SET TMP.GEE_ID = '||V_ESQUEMA||'.S_GEE_GESTOR_ENTIDAD.NEXTVAL
  '
  ;

  EXECUTE IMMEDIATE '
  UPDATE '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  SET TMP.GEH_ID = '||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL
  '
  ;

  --ASIGNAMOS SUPERVISOR DE ADMISION

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GEE_GESTOR_ENTIDAD...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD (
  gee_id,
  usu_id,
  dd_tge_id,
  VERSION,
  usuariocrear,
  fechacrear,
  borrado
  )
  SELECT
  TMP.gee_id,
  TMP.usu_id,
  (SELECT dd_tge_id FROM '||V_ESQUEMA_MASTER||'.dd_tge_tipo_gestor WHERE dd_tge_codigo = ''SUPADM''),
  0,
  '''||V_USUARIO||''',
  SYSDATE,
  0
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD PARA SUPERVISORES DE ADMISIÓN. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GEE_GESTOR_ENTIDAD cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GAC_GESTOR_ADD_ACTIVO...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO (
  gee_id,
  act_id
  )
  SELECT
  TMP.gee_id,
  TMP.act_id
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO PARA SUPERVISORES DE ADMISIÓN. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GAC_GESTOR_ADD_ACTIVO cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GEH_GESTOR_ENTIDAD_HIST...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST (
  geh_id,
  usu_id,
  dd_tge_id,
  geh_fecha_desde,
  geh_fecha_hasta,
  VERSION,
  usuariocrear,
  fechacrear,
  borrado
  )
  SELECT
  tmp.geh_id,
  tmp.usu_id,
  gee.dd_tge_id,
  SYSDATE,
  NULL,
  1,
  '''||V_USUARIO||''',
  SYSDATE,
  0
  FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
  INNER JOIN '||V_ESQUEMA||'.TMP_GEST_ACT TMP
    ON TMP.GEE_ID = GEE.GEE_ID
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST PARA SUPERVISORES DE ADMISIÓN. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GEH_GESTOR_ENTIDAD_HIST cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GAH_GESTOR_ACTIVO_HISTORICO...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO (
  geh_id,
  act_id
  )
  SELECT
  TMP.geh_id,
  TMP.act_id
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO PARA SUPERVISORES DE ADMISIÓN. '||CHR(10)||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GAH_GESTOR_ACTIVO_HISTORICO cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO COMPUTE STATISTICS');

  EXECUTE IMMEDIATE '
  DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT PURGE
  '
  ;
  
  
----------------------------------------------------------------------
----------- ASIGNAMOS GESTORÍAS DE ADMISION -------------------------
----------------------------------------------------------------------

  EXECUTE IMMEDIATE '
  SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME LIKE ''TMP_GEST_ACT'' AND OWNER LIKE '''||V_ESQUEMA||'''
  '
  INTO V_NUM
  ;

  IF V_NUM != 0 THEN

    EXECUTE IMMEDIATE '
    DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
    '
    ;

  END IF;

  EXECUTE IMMEDIATE '
    CREATE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT (
      ACT_ID                      NUMBER(16,0),
      USUARIO_GESTION_ACTIVOS     VARCHAR2(10 CHAR),
      USU_ID                      NUMBER(16,0),
      NOMBRE_GESTION_ACTIVOS      VARCHAR2(150 CHAR),
      GEE_ID                      NUMBER(16,0),
      GEH_ID                      NUMBER(16,0)
    )
  '
  ;

  --ASIGNAMOS GESTORÍAS DE ADMISION 'OGF' ó 'TECNOTRAMIT' A TODOS LOS ACTIVOS

  DBMS_OUTPUT.PUT_LINE('[INFO] --GESTORÍA DE ADMISIÓN--');
  DBMS_OUTPUT.PUT_LINE('[INFO] SE ASIGNARÁN LAS GESTORÍAS DE ADMISIÓN ''OGF'' ó ''TECTRAMIT'' PARA TODOS LOS ACTIVOS GESTIONADOS POR SAREB.');
  DBMS_OUTPUT.PUT_LINE('');
  
  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.TMP_GEST_ACT (
    ACT_ID,
    GEE_ID,
    GEH_ID,
    USUARIO_GESTION_ACTIVOS,
    USU_ID,
    NOMBRE_GESTION_ACTIVOS
  )
  WITH GGADM_NO_INSERTAR AS (
    SELECT DISTINCT ACT.ACT_NUM_ACTIVO, GEH.GEH_ID, GEE.GEE_ID, GEE.DD_TGE_ID, TGE.DD_TGE_DESCRIPCION
    FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
    INNER JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
      ON ACT.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
      ON GAC.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
      ON GEH.GEH_ID = GAH.GEH_ID
    INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
      ON GEE.GEE_ID = GAC.GEE_ID
    LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR TGE
      ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
    WHERE TGE.DD_TGE_ID IS NOT NULL
    AND TGE.DD_TGE_DESCRIPCION = ''Gestoría de admisión''
    AND GEE.BORRADO = 0
  ),
  CCAA AS (
    SELECT ACT.ACT_NUM_ACTIVO, CMA.DD_CMA_DESCRIPCION, PRV.DD_PRV_ID, 
    DECODE(CMA.DD_CMA_CODIGO,
    ''09'',''TECTRAMIT'',
    ''01'',''TECTRAMIT'',
    ''13'',''TECTRAMIT'',
    ''18'',''TECTRAMIT'',
    ''17'',''TECTRAMIT'',
    ''ogf'') GESTORIA
    FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
    INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE
      ON BIE.BIE_ID = ACT.BIE_ID
    LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_PRV_PROVINCIA PRV
      ON PRV.DD_PRV_ID = BIE.DD_PRV_ID
    LEFT JOIN '||V_ESQUEMA||'.ACT_CMP_COMAUTONOMA_PROVINCIA CMP
      ON CMP.DD_PRV_ID = BIE.DD_PRV_ID
    LEFT JOIN '||V_ESQUEMA||'.DD_CMA_COMAUTONOMA CMA
      ON CMA.DD_CMA_ID = CMP.DD_CMA_ID
    LEFT JOIN GGADM_NO_INSERTAR NOIN
      ON ACT.ACT_NUM_ACTIVO = NOIN.ACT_NUM_ACTIVO
    WHERE PRV.DD_PRV_ID IS NOT NULL
    AND CMP.ACT_CMP_ID IS NOT NULL
    AND CMA.DD_CMA_ID IS NOT NULL
    AND NOIN.ACT_NUM_ACTIVO IS NULL
    AND ACT.DD_CRA_ID = (SELECT DD_CRA_ID FROM '||V_ESQUEMA||'.DD_CRA_CARTERA WHERE DD_CRA_CODIGO = ''02'')
  )
  SELECT
  ACT_ID,
  s_gee_gestor_entidad.NEXTVAL gee_id,
  s_geh_gestor_entidad_hist.NEXTVAL geh_id,
  GESTORIA,
  (SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME = GESTORIA) USU_ID,
  (SELECT USU_NOMBRE FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME = GESTORIA) NOMBRE_GESTION_ACTIVOS
  FROM (
  SELECT ACT.ACT_ID, ACT.ACT_NUM_ACTIVO, CCAA.GESTORIA
  FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
  INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE
    ON ACT.BIE_ID = BIE.BIE_ID
  LEFT JOIN '||V_ESQUEMA||'.TMP_GEST_ACT GEACT
    ON GEACT.ACT_ID = ACT.ACT_ID
  LEFT JOIN CCAA
    ON CCAA.ACT_NUM_ACTIVO = ACT.ACT_NUM_ACTIVO
  WHERE GEACT.ACT_ID IS NULL
  AND CCAA.ACT_NUM_ACTIVO IS NOT NULL
  )
  '
  ;

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' TMP_GEST_ACT cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.TMP_GEST_ACT ANALIZADA.');
  /*
  EXECUTE IMMEDIATE '
  UPDATE '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  SET TMP.USU_ID = (SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME = ''SUPADM'')
  '
  ;*/
/*
  EXECUTE IMMEDIATE '
  UPDATE '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  SET TMP.GEE_ID = '||V_ESQUEMA||'.S_GEE_GESTOR_ENTIDAD.NEXTVAL
  '
  ;

  EXECUTE IMMEDIATE '
  UPDATE '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  SET TMP.GEH_ID = '||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL
  '
  ;
*/
  --ASIGNAMOS SUPERVISOR DE ADMISION

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GEE_GESTOR_ENTIDAD...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD (
  gee_id,
  usu_id,
  dd_tge_id,
  VERSION,
  usuariocrear,
  fechacrear,
  borrado
  )
  SELECT
  TMP.gee_id,
  TMP.usu_id,
  (SELECT dd_tge_id FROM '||V_ESQUEMA_MASTER||'.dd_tge_tipo_gestor WHERE dd_tge_codigo = ''GGADM''),
  0,
  '''||V_USUARIO||''',
  SYSDATE,
  0
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD PARA GESTORÍAS DE ADMISIÓN. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GEE_GESTOR_ENTIDAD cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GAC_GESTOR_ADD_ACTIVO...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO (
  gee_id,
  act_id
  )
  SELECT
  TMP.gee_id,
  TMP.act_id
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO PARA GESTORÍAS DE ADMISIÓN. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GAC_GESTOR_ADD_ACTIVO cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GEH_GESTOR_ENTIDAD_HIST...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST (
  geh_id,
  usu_id,
  dd_tge_id,
  geh_fecha_desde,
  geh_fecha_hasta,
  VERSION,
  usuariocrear,
  fechacrear,
  borrado
  )
  SELECT
  tmp.geh_id,
  tmp.usu_id,
  gee.dd_tge_id,
  SYSDATE,
  NULL,
  1,
  '''||V_USUARIO||''',
  SYSDATE,
  0
  FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
  INNER JOIN '||V_ESQUEMA||'.TMP_GEST_ACT TMP
    ON TMP.GEE_ID = GEE.GEE_ID
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST PARA GESTORÍAS DE ADMISIÓN. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GEH_GESTOR_ENTIDAD_HIST cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GAH_GESTOR_ACTIVO_HISTORICO...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO (
  geh_id,
  act_id
  )
  SELECT
  TMP.geh_id,
  TMP.act_id
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO PARA GESTORÍAS DE ADMISIÓN. '||CHR(10)||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GAH_GESTOR_ACTIVO_HISTORICO cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO COMPUTE STATISTICS');

  EXECUTE IMMEDIATE '
  DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT PURGE
  '
  ;



----------------------------------------------------------------------
----------- ASIGNAMOS SUPERVISORES DE ACTIVO -------------------------
----------------------------------------------------------------------

  EXECUTE IMMEDIATE '
  SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME LIKE ''TMP_GEST_ACT'' AND OWNER LIKE '''||V_ESQUEMA||'''
  '
  INTO V_NUM
  ;

  IF V_NUM != 0 THEN

    EXECUTE IMMEDIATE '
    DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT
    '
    ;

  END IF;

  EXECUTE IMMEDIATE '
    CREATE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT (
      ACT_ID                      NUMBER(16,0),
      USUARIO_GESTION_ACTIVOS     VARCHAR2(10 CHAR),
      USU_ID                      NUMBER(16,0),
      NOMBRE_GESTION_ACTIVOS      VARCHAR2(150 CHAR),
      GEE_ID                      NUMBER(16,0),
      GEH_ID                      NUMBER(16,0)
    )
  '
  ;

  --ASIGNAMOS SUPERVISORES DE ACTIVO SEGÚN LOS ACTIVOS QUE GESTIONEN CADA GESTOR SUPERVISADO

  DBMS_OUTPUT.PUT_LINE('[INFO] --SUPERVISOR DE ACTIVO--');
  DBMS_OUTPUT.PUT_LINE('[INFO] SE ASIGNARÁN SUPERVISORES DE ACTIVO PARA TODOS LOS ACTIVOS, EN FUNCIÓN DE LOS ACTIVOS QUE GESTIONE CADA GESTOR SUPERVISADO.');
  DBMS_OUTPUT.PUT_LINE('');
  
  /*
  DECODE(USU.USU_USERNAME,
    ''A141178'',''lfabe'',--IRENE TAVERA ALONSO - LAURA FABE HERNANDEZ
    ''A121643'',''lfabe'',--GABRIELA MORENO MARTIN - LAURA FABE HERNANDEZ
    ''A108677'',''lfabe'',--JAVIER CANOVAS ADAN - LAURA FABE HERNANDEZ
    ''MR020'',''lfabe'',--HECTOR GIMENEZ BEA - LAURA FABE HERNANDEZ
    ''A164740'',''A166039'',--JOSE BERENGUER ALEIXANDRE - JOSE LUIZ PELAZ GOMEZ
    ''A164869'',''A166039'',--ANA MEZQUITA LLORENS - JOSE LUIZ PELAZ GOMEZ
    ''A137949'',''A121298'',--ANTONIO RUIZ AVILA - ANTONIO MARTINEZ BERZOSA
    ''A166034'',''A166036'',--CARMEN KUHNEL ALEMAN - NATALIA HORCAJO GAVIRA
    ''A164878'',''bruiz'',--Belén Baviera García - BEATRIZ RUIZ FUENTES
    ''A164892'',''bruiz'',--Rafael Domínguez León - BEATRIZ RUIZ FUENTES
    ''A164755'',''bruiz'',--Sara Aragón Gutiérrez - BEATRIZ RUIZ FUENTES
    ''A136655'',''bruiz'',--Raul Durá Garcés  - BEATRIZ RUIZ FUENTES
    ''A164884'',''bruiz'',--José Pascual Lengua Vicent  - BEATRIZ RUIZ FUENTES
    ''MR006'',''cserrano'',--Maria Jesus Macip Abadia - CARMEN SERRANO MORALES
    ''MR003'',''cserrano'',--Nuria de la Ossa Montalban - CARMEN SERRANO MORALES
    ''MR004'',''cserrano'',--Maria del Mar Garcia Delgado - CARMEN SERRANO MORALES
    ''MR001'',''cserrano'',--Maria Dolores Canton Solbas - CARMEN SERRANO MORALES
    ''MR005'',''cserrano'',--Rosa Guirado Miras - CARMEN SERRANO MORALES
    ''MR010'',''cserrano'',--Maria Perez Alonso - CARMEN SERRANO MORALES
    ''NULL'')
  */
  
  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.TMP_GEST_ACT (
    ACT_ID,
    GEE_ID,
    GEH_ID,
    USUARIO_GESTION_ACTIVOS,
    USU_ID,
    NOMBRE_GESTION_ACTIVOS
  )
  WITH SUPACT_NO_INSERTAR AS (
    SELECT DISTINCT ACT.ACT_NUM_ACTIVO, ACT.ACT_ID, GEH.GEH_ID, GEE.GEE_ID, GEE.DD_TGE_ID, TGE.DD_TGE_DESCRIPCION
    FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
    INNER JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
      ON ACT.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
      ON GAC.ACT_ID = GAH.ACT_ID
    INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
      ON GEH.GEH_ID = GAH.GEH_ID
    INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
      ON GEE.GEE_ID = GAC.GEE_ID
    LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR TGE
      ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
    WHERE TGE.DD_TGE_ID IS NOT NULL
    AND TGE.DD_TGE_DESCRIPCION = ''Supervisor del activo''
    AND GEE.BORRADO = 0
  ),
  PERIMETRO AS (
    SELECT
    GEE.GEE_ID,
    GEE.DD_TGE_ID,
    GEE.USU_ID,
    USU.USU_USERNAME,
    DECODE(USU.USU_USERNAME,
    ''itavera'',''lfabe'',
    ''gmoreno'',''lfabe'',
    ''jcanovas'',''lfabe'',
    ''hgimenez'',''lfabe'',
    ''jberenguer'',''jlpelaz'',
    ''aml'',''jlpelaz'',
    ''aruiza'',''amartinezb'',
    ''ckuhnel'',''nhorcajo'',
    ''saragon'',''bruiz'',
    ''bbaviera'',''bruiz'',
    ''rdl'',''bruiz'',
    ''rdura'',''bruiz'',
    ''jlengua'',''bruiz'',
    ''mmacip'',''cserrano'',
    ''ndelaossa'',''cserrano'',
    ''mgarciade'',''cserrano'',
    ''mcanton'',''cserrano'',
    ''rguirado'',''cserrano'',
    ''mperez'',''cserrano'',
    ''lfabe'') SUPERVISOR,  
    GAC.ACT_ID
    FROM '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
    INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
      ON GEE.GEE_ID = GAC.GEE_ID
    LEFT JOIN '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU
      ON USU.USU_ID = GEE.USU_ID
    LEFT JOIN SUPACT_NO_INSERTAR NOIN
      ON NOIN.ACT_ID = GAC.ACT_ID
    WHERE GEE.DD_TGE_ID = (SELECT DD_TGE_ID FROM '||V_ESQUEMA_MASTER||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = ''GACT'')
    AND USU.USU_ID IS NOT NULL
    AND NOIN.ACT_ID IS NULL
  )
  SELECT
  ACT_ID,
  s_gee_gestor_entidad.NEXTVAL gee_id,
  s_geh_gestor_entidad_hist.NEXTVAL geh_id,
  SUPERVISOR,
  (SELECT USU_ID FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME = SUPERVISOR) USU_ID,
  (SELECT USU_NOMBRE FROM '||V_ESQUEMA_MASTER||'.USU_USUARIOS WHERE USU_USERNAME = SUPERVISOR) NOMBRE_GESTION_ACTIVOS
  FROM (
  SELECT ACT.ACT_ID, ACT.ACT_NUM_ACTIVO, PERIMETRO.SUPERVISOR
  FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
  INNER JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE
    ON ACT.BIE_ID = BIE.BIE_ID
  LEFT JOIN '||V_ESQUEMA||'.TMP_GEST_ACT GEACT
    ON GEACT.ACT_ID = ACT.ACT_ID
  LEFT JOIN PERIMETRO
    ON PERIMETRO.ACT_ID = ACT.ACT_ID
  WHERE GEACT.ACT_ID IS NULL
  AND PERIMETRO.ACT_ID IS NOT NULL
  )
  '
  ;

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' TMP_GEST_ACT cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.TMP_GEST_ACT COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.TMP_GEST_ACT ANALIZADA.');

  --ASIGNAMOS SUPERVISOR DE ACTIVO

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GEE_GESTOR_ENTIDAD...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD (
  gee_id,
  usu_id,
  dd_tge_id,
  VERSION,
  usuariocrear,
  fechacrear,
  borrado
  )
  SELECT
  TMP.gee_id,
  TMP.usu_id,
  (SELECT dd_tge_id FROM '||V_ESQUEMA_MASTER||'.dd_tge_tipo_gestor WHERE dd_tge_codigo = ''SUPACT''),
  0,
  '''||V_USUARIO||''',
  SYSDATE,
  0
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD PARA SUPERVISORES DEL ACTIVO. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GEE_GESTOR_ENTIDAD cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GAC_GESTOR_ADD_ACTIVO...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO (
  gee_id,
  act_id
  )
  SELECT
  TMP.gee_id,
  TMP.act_id
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO PARA SUPERVISORES DEL ACTIVO. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GAC_GESTOR_ADD_ACTIVO cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GEH_GESTOR_ENTIDAD_HIST...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST (
  geh_id,
  usu_id,
  dd_tge_id,
  geh_fecha_desde,
  geh_fecha_hasta,
  VERSION,
  usuariocrear,
  fechacrear,
  borrado
  )
  SELECT
  tmp.geh_id,
  tmp.usu_id,
  gee.dd_tge_id,
  SYSDATE,
  NULL,
  1,
  '''||V_USUARIO||''',
  SYSDATE,
  0
  FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
  INNER JOIN '||V_ESQUEMA||'.TMP_GEST_ACT TMP
    ON TMP.GEE_ID = GEE.GEE_ID
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST PARA SUPERVISORES DEL ACTIVO. '||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GEH_GESTOR_ENTIDAD_HIST cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST COMPUTE STATISTICS');

  DBMS_OUTPUT.PUT_LINE('[INFO] CARGANDO LA TABLA GAH_GESTOR_ACTIVO_HISTORICO...');

  EXECUTE IMMEDIATE '
  INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO (
  geh_id,
  act_id
  )
  SELECT
  TMP.geh_id,
  TMP.act_id
  FROM '||V_ESQUEMA||'.TMP_GEST_ACT TMP
  WHERE TMP.USU_ID IS NOT NULL
  '
  ;
  
  v_count_1 := SQL%ROWCOUNT;
  PL_OUTPUT := PL_OUTPUT||'[INFO] INSERTADOS '||v_count_1||' REGISTROS EN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO PARA SUPERVISORES DEL ACTIVO. '||CHR(10)||CHR(10);

  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' GAH_GESTOR_ACTIVO_HISTORICO cargada. '||v_count_1||' Filas.');

  COMMIT;

  EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO COMPUTE STATISTICS');

  EXECUTE IMMEDIATE '
  DROP TABLE '||V_ESQUEMA||'.TMP_GEST_ACT PURGE
  '
  ;


  DBMS_OUTPUT.PUT_LINE('[OK] - PROCESO FINALIZADO.');
  
	
EXCEPTION

    WHEN OTHERS THEN

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion: '||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);

    ROLLBACK;
    RAISE;

END SP_AGA_ASIGNA_GESTOR_ACTIVO;
/
