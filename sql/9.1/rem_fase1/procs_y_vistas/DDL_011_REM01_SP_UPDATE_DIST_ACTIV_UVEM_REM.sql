--/*
--##########################################
--## AUTOR=JAVIER DIAZ
--## FECHA_CREACION=20160627
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.1
--## INCIDENCIA_LINK=0
--## PRODUCTO=NO
--## Finalidad: Procedimiento que actualiza información de los activos a partir de un fichero proveniente de UVEM- 
--##			tabla APR_AUX_DATOS_ACTIVO, con datos procedentes de UVEM. INFOCOMERCIAL-DISTRIBUCIÓN
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

create or replace PROCEDURE SP_UPDATE_DIST_ACTIV_UVEM_REM (P_TEXTO OUT VARCHAR2,
P_DIST_NEW OUT VARCHAR2,
P_DIST_MODIF OUT VARCHAR2

) AS
--V0.1 Versión  hito : 1.0.8-rem


V_ESQUEMA VARCHAR2(15 CHAR) := '#ESQUEMA#';
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := '#ESQUEMA_MASTER#';



 err_num NUMBER;
 err_msg VARCHAR2(2048);

   UPDATE_DIST NUMBER(10,0) := 0;
   NUEVOS_DIST NUMBER(10,0) := 0;
   V_VIV  NUMBER(10,0) := 0;
   R_DIST NUMBER(10,0) := 0;
      V_MSQL_DIST VARCHAR2(8500 CHAR);
      V_MSQL_DIST_I VARCHAR2(8500 CHAR);

      REG_DIST VARCHAR2(4000 CHAR);

V_VALIDA_VIV VARCHAR2(1600 CHAR);
DD_TPH_ID NUMBER(2);
  DIS_NUM_PLANTA NUMBER(16);
  DIS_CANTIDAD NUMBER(8);
  DIS_SUPERFICIE NUMBER(16,2);
  ICO_ACT_DIST NUMBER(16);
ICO_ID_DIST NUMBER(16);
DIS_ID NUMBER(16);


CURSOR C_INFO_DIST
    IS
SELECT 
A.A1 ICO_ACT_DIST,
B.B1 ICO_ID_DIST,
B.B2 DIS_NUM_PLANTA,
B.B3 DD_TPH_ID,
B.B4 DIS_CANTIDAD,
B.B5 DIS_SUPERFICIE,
A.DIS_ID
FROM 
(SELECT DIS.DIS_ID, DIS.ICO_ID A1, DIS.DIS_NUM_PLANTA A2, DIS.DD_TPH_ID A3 FROM REM01.ACT_DIS_DISTRIBUCION DIS) A,

(
SELECT INFO.ICO_ID B1, DIST.DIS_NUM_PLANTA B2, TPH.DD_TPH_ID B3, DIST.DIS_CANTIDAD B4, DIS_SUPERFICIE B5 FROM REM01.APR_AUX_INFOCOMERCIAL_DIST DIST,
REM01.ACT_ACTIVO ACT, 
REM01.APR_AUX_DATOS_ACTIVO DAT,
REM01.ACT_ICO_INFO_COMERCIAL INFO,
REM01.DD_TPH_TIPO_HABITACULO TPH
WHERE ACT.ACT_NUM_ACTIVO = DIST.ACT_NUMERO_ACTIVO
AND DAT.ACT_NUMERO_ACTIVO = DIST.ACT_NUMERO_ACTIVO
AND  INFO.ACT_ID = ACT.ACT_ID
AND DIST.TIPO_HABITACULO = TPH.DD_TPH_CODIGO (+)

) B

WHERE A.A1 (+) = B.B1 
AND   A.A2 (+) = B.B2 
AND   A.A3 (+) = B.B3 


;

BEGIN


OPEN C_INFO_DIST;
    FETCH C_INFO_DIST INTO 
    ICO_ACT_DIST,
    ICO_ID_DIST,
    DIS_NUM_PLANTA,
    DD_TPH_ID,
    DIS_CANTIDAD,
    DIS_SUPERFICIE,
    DIS_ID
    ;
    WHILE C_INFO_DIST%found
    LOOP
    
    
P_TEXTO := 'INFO: EL PROCESO DE ACTUALIZACIÓN DE INFOCOMERCIAL-DISTRIBUCIÓN HA FINALIZADO CORRECTAMENTE';
  
  IF ICO_ACT_DIST IS NULL THEN
  
 
 
 
  ---------- VALIDAMOS ANTES DE INSERTAR QUE EL ICO_ID EXISTE EN ACT_VIV_VIVIENDA
    
    V_VALIDA_VIV := '
  SELECT COUNT(*) FROM 
'||V_ESQUEMA||'.ACT_VIV_VIVIENDA VIV
WHERE 
VIV.ICO_ID = '||ICO_ID_DIST||'
  '
  ;
  

  
  EXECUTE IMMEDIATE V_VALIDA_VIV INTO V_VIV;

  IF V_VIV > 0 THEN
  
  

  
  V_MSQL_DIST_I := 'INSERT INTO '||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION (
DIS_ID,
ICO_ID,
DIS_NUM_PLANTA,
DD_TPH_ID,
DIS_CANTIDAD,
DIS_SUPERFICIE,
USUARIOCREAR,
FECHACREAR
 )
  VALUES (
  
  '||V_ESQUEMA||'.S_ACT_DIS_DISTRIBUCION.NEXTVAL,
  '||ICO_ID_DIST||',
  '||DIS_NUM_PLANTA||',
  '||DD_TPH_ID||',
  '||DIS_CANTIDAD||',
  '||DIS_SUPERFICIE||',
   ''ACT_UVEM'',
   SYSDATE
   )';

EXECUTE IMMEDIATE V_MSQL_DIST_I;
 
--DBMS_OUTPUT.PUT_LINE(V_MSQL_DIST_I);
 
  NUEVOS_DIST := NUEVOS_DIST + 1;
  END IF;
  
  ELSE 
  
  
  ---------COMPROBAMOS LAS FILAS CON DATOS NUEVOS PROVENIENTES DEL FICHERO PARA ACTUALIZAR SÓLO ESOS REGISTROS----------

REG_DIST := '
SELECT COUNT(*) FROM (
SELECT 
DIS.DIS_ID,
DIST.DIS_NUM_PLANTA,
TPH.DD_TPH_ID,
DIST.DIS_CANTIDAD,
DIST.DIS_SUPERFICIE
FROM 
'||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION  DIS,
'||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL ICO,
'||V_ESQUEMA||'.ACT_ACTIVO ACT,
'||V_ESQUEMA||'.APR_AUX_INFOCOMERCIAL_DIST DIST,
'||V_ESQUEMA||'.DD_TPH_TIPO_HABITACULO TPH
WHERE 
DIS.ICO_ID = ICO.ICO_ID
AND ACT.ACT_ID = ICO.ACT_ID
AND ACT.ACT_NUM_ACTIVO = DIST.ACT_NUMERO_ACTIVO
AND DIST.TIPO_HABITACULO = TPH.DD_TPH_CODIGO
AND DIST.DIS_NUM_PLANTA = DIS.DIS_NUM_PLANTA
AND DIS.DD_TPH_ID = TPH.DD_TPH_ID
AND DIS_ID = '||DIS_ID||'
MINUS
SELECT 
DIS.DIS_ID,
DIS.DIS_NUM_PLANTA,
DIS.DD_TPH_ID,
DIS.DIS_CANTIDAD,
DIS.DIS_SUPERFICIE
FROM 
'||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION  DIS,
'||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL ICO,
'||V_ESQUEMA||'.ACT_ACTIVO ACT,
'||V_ESQUEMA||'.APR_AUX_INFOCOMERCIAL_DIST DIST,
'||V_ESQUEMA||'.DD_TPH_TIPO_HABITACULO TPH
WHERE 
DIS.ICO_ID = ICO.ICO_ID
AND ACT.ACT_ID = ICO.ACT_ID
AND ACT.ACT_NUM_ACTIVO = DIST.ACT_NUMERO_ACTIVO
AND DIST.TIPO_HABITACULO = TPH.DD_TPH_CODIGO
AND DIST.DIS_NUM_PLANTA = DIS.DIS_NUM_PLANTA
AND DIS.DD_TPH_ID = TPH.DD_TPH_ID
AND DIS_ID = '||DIS_ID||'
)
  '
  ;
  
  --DBMS_OUTPUT.PUT_LINE(REG_DIST);
  
  EXECUTE IMMEDIATE REG_DIST INTO R_DIST;

  IF R_DIST > 0 THEN
  
  
  V_MSQL_DIST := 'UPDATE '||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION
  SET 
      DIS_NUM_PLANTA = '''||DIS_NUM_PLANTA||''',
      DD_TPH_ID = '''||DD_TPH_ID||''',
      DIS_CANTIDAD = '''||DIS_CANTIDAD||''',
      DIS_SUPERFICIE = '''||DIS_SUPERFICIE||''',
      USUARIOMODIFICAR = ''ACT_UVEM'',
      FECHAMODIFICAR = SYSDATE
      WHERE DIS_ID = '||DIS_ID||'
      ';

--DBMS_OUTPUT.PUT_LINE(V_MSQL_DIST);

EXECUTE IMMEDIATE V_MSQL_DIST;

  
     UPDATE_DIST :=  UPDATE_DIST + 1;
     
     END IF;
  
  END IF;
  
 
 

 
 FETCH C_INFO_DIST INTO
    ICO_ACT_DIST,
    ICO_ID_DIST,
    DIS_NUM_PLANTA,
    DD_TPH_ID,
    DIS_CANTIDAD,
    DIS_SUPERFICIE,
    DIS_ID
    ;
    END LOOP;
    CLOSE C_INFO_DIST;

COMMIT;


  
  
  
  
  

        
              
        
                    DBMS_OUTPUT.PUT_LINE('REGISTROS ACTUALIZADOS EN  ACT_DIS_DISTRIBUCION : '||UPDATE_DIST||'');
               
                P_DIST_MODIF := 'REGISTROS ACTUALIZADOS EN  ACT_DIS_DISTRIBUCION : '||UPDATE_DIST||'';
               
                DBMS_OUTPUT.PUT_LINE('REGISTROS INSERTADOS EN ACT_DIS_DISTRIBUCION : '||NUEVOS_DIST||'');
                
                 P_DIST_NEW := 'REGISTROS INSERTADOS EN ACT_DIS_DISTRIBUCION : '||NUEVOS_DIST||'';
              
      


 


 EXCEPTION

 WHEN OTHERS THEN
   err_num := SQLCODE;
   err_msg := SQLERRM;

   DBMS_OUTPUT.put_line('Error:'||TO_CHAR(err_num));
   DBMS_OUTPUT.put_line(err_msg);
   P_TEXTO := 'Error:'||TO_CHAR(err_num)||'['||err_msg||']'; 

   ROLLBACK;
   RAISE;


END SP_UPDATE_DIST_ACTIV_UVEM_REM;

/
