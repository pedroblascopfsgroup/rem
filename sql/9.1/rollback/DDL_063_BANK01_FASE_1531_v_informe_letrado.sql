--/*
--##########################################
--## AUTOR=OSCAR DORADO
--## FECHA_CREACION=20150803
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.1.14-bk
--## INCIDENCIA_LINK=FASE-1521 	
--## PRODUCTO=SI
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_MSQL         VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA      VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M    VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL          VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS   NUMBER(16); -- Vble. para validar la existencia de una tabla.  
    ERR_NUM        NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG        VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

    V_TEXT1        VARCHAR2(2400 CHAR); -- Vble. auxiliar
    
    TYPE T_ESQUEMA IS TABLE OF VARCHAR2(30) INDEX BY BINARY_INTEGER;
    V_ESQUEMA_GRANT T_ESQUEMA;

BEGIN
    

V_MSQL := '
  CREATE OR REPLACE FORCE VIEW '||V_ESQUEMA||'.VINFSUBASTALETRADO AS 
  WITH
VALORES_DEMANDA AS (
  SELECT /*+ MATERIALIZE */ TEV.TEV_NOMBRE, TEV.TEV_VALOR, TAR.PRC_ID
  FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR
    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID
      INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TEX.TAP_ID = TAP.TAP_ID
        INNER JOIN '||V_ESQUEMA||'.TFI_TAREAS_FORM_ITEMS TFI ON  TAP.TAP_ID = TFI.TAP_ID
          INNER JOIN '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR TEV ON TEV.TEX_ID = TEX.TEX_ID AND UPPER(TFI.TFI_NOMBRE) = UPPER(TEV.TEV_NOMBRE)
  WHERE NOT TEV.TEV_VALOR IS NULL
  AND TAP.TAP_CODIGO IN (''P01_DemandaCertificacionCargas'',
                                 ''P17_InterposicionDemandaMasBienes'',
                                 ''P04_InterposicionDemanda'',
                                 ''P25_interposicionDemanda'',
                                 ''P15_InterposicionDemandaMasBienes'',
                                 ''P03_InterposicionDemanda'',
                                 ''P02_InterposicionDemanda'')
),
VALORES_SENYALAMIENTO AS (
  SELECT /*+ MATERIALIZE */ TEV.TEV_NOMBRE, TEV.TEV_VALOR, TAR.PRC_ID, TAP.TAP_CODIGO
  FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR
    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID
      INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TEX.TAP_ID = TAP.TAP_ID
        INNER JOIN '||V_ESQUEMA||'.TFI_TAREAS_FORM_ITEMS TFI ON  TAP.TAP_ID = TFI.TAP_ID
          INNER JOIN '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR TEV ON TEV.TEX_ID = TEX.TEX_ID AND UPPER(TFI.TFI_NOMBRE) = UPPER(TEV.TEV_NOMBRE)
  WHERE NOT TEV.TEV_VALOR IS NULL
    AND TAP.TAP_CODIGO IN (''P401_SenyalamientoSubasta'',''P409_SenyalamientoSubasta'')
),
DESPACHOS_PROCURADORES AS (
  SELECT /*+ MATERIALIZE */ DISTINCT GAA.ASU_ID, DES.DES_ID, DES.DES_DESPACHO
  FROM '||V_ESQUEMA||'.GAA_GESTOR_ADICIONAL_ASUNTO GAA
    INNER JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON GAA.DD_TGE_ID = TGE.DD_TGE_ID AND TGE.DD_TGE_CODIGO = ''PROC''
    INNER JOIN '||V_ESQUEMA||'.USD_USUARIOS_DESPACHOS USD ON GAA.USD_ID = USD.USD_ID
    INNER JOIN '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO DES ON USD.DES_ID = DES.DES_ID
  WHERE GAA.BORRADO = 0
),
DESPACHOS_LETRADO AS (
  SELECT /*+ MATERIALIZE */ DISTINCT GAA.ASU_ID, DES.DES_ID, DES.DES_DESPACHO
  FROM '||V_ESQUEMA||'.GAA_GESTOR_ADICIONAL_ASUNTO GAA
    INNER JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON GAA.DD_TGE_ID = TGE.DD_TGE_ID AND TGE.DD_TGE_CODIGO = ''GEXT''
    INNER JOIN '||V_ESQUEMA||'.USD_USUARIOS_DESPACHOS USD ON GAA.USD_ID = USD.USD_ID
    INNER JOIN '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO DES ON USD.DES_ID = DES.DES_ID
),
CONTRATOS_MAYORES AS (
  SELECT /*+ MATERIALIZE */ PRC_ID, CNT_ID, CNT_NUM
  FROM (
    SELECT /*+ MATERIALIZE */PRC_ID, CNT_ID, ROW_NUMBER() OVER (PARTITION BY PRC_ID ORDER BY SUMA DESC) CNT_NUM
    FROM
      (SELECT /*+ MATERIALIZE */ (MOV.MOV_POS_VIVA_NO_VENCIDA + MOV.MOV_POS_VIVA_VENCIDA) SUMA, MOV.CNT_ID, PRCCEX.PRC_ID
      FROM '||V_ESQUEMA||'.PRC_CEX PRCCEX
        INNER JOIN '||V_ESQUEMA||'.CEX_CONTRATOS_EXPEDIENTE CEX ON PRCCEX.CEX_ID = CEX.CEX_ID
        INNER JOIN '||V_ESQUEMA||'.MOV_MOVIMIENTOS MOV ON CEX.CNT_ID = MOV.CNT_ID  AND MOV.MOV_FECHA_EXTRACCION = (SELECT /*+ MATERIALIZE */ MAX(MOV_FECHA_EXTRACCION) FROM '||V_ESQUEMA||'.MOV_MOVIMIENTOS)
    )
  ) WHERE CNT_NUM = 1
),
FIADORES AS (
  SELECT /*+ MATERIALIZE */ COUNT(1) NFIADORES , CPE.CNT_ID
  FROM '||V_ESQUEMA||'.CPE_CONTRATOS_PERSONAS CPE
    LEFT JOIN '||V_ESQUEMA||'.DD_TIN_TIPO_INTERVENCION TIN ON CPE.DD_TIN_ID = TIN.DD_TIN_ID AND TIN.DD_TIN_CODIGO IN (30, 31)
  GROUP BY CPE.CNT_ID
),
DOCADJUNTO AS (
  SELECT /*+ MATERIALIZE */ COUNT(1) NDOCS, ADA.ASU_ID, TFA.DD_TFA_CODIGO
  FROM '||V_ESQUEMA||'.ADA_ADJUNTOS_ASUNTOS ADA
    LEFT JOIN '||V_ESQUEMA||'.DD_TFA_FICHERO_ADJUNTO TFA ON ADA.DD_TFA_ID = TFA.DD_TFA_ID
  GROUP BY ADA.ASU_ID, TFA.DD_TFA_CODIGO
),
TITULARES AS (
SELECT /*+ MATERIALIZE */ * FROM (
SELECT CNT.CNT_ID, PER.PER_NOM50, ROW_NUMBER() OVER (PARTITION BY CNT.CNT_ID ORDER BY CPE.CPE_ORDEN) NUM
FROM '||V_ESQUEMA||'.CNT_CONTRATOS CNT
  INNER JOIN '||V_ESQUEMA||'.CPE_CONTRATOS_PERSONAS CPE ON CNT.CNT_ID = CPE.CNT_ID
    INNER JOIN '||V_ESQUEMA||'.DD_TIN_TIPO_INTERVENCION TIN ON CPE.DD_TIN_ID = TIN.DD_TIN_ID AND TIN.DD_TIN_CODIGO = 20
  LEFT JOIN '||V_ESQUEMA||'.PER_PERSONAS PER ON CPE.PER_ID = PER.PER_ID
) WHERE NUM = 1
),
TIPOS_SUBASTA AS (
  SELECT /*+ MATERIALIEZE */ LOS.SUB_ID ,SUM(BIE.BIE_TIPO_SUBASTA) TIPO_SUBASTA
    FROM '||V_ESQUEMA||'.LOS_LOTE_SUBASTA LOS
      LEFT JOIN '||V_ESQUEMA||'.LOB_LOTE_BIEN LOBLOTE ON LOS.LOS_ID = LOBLOTE.LOS_ID
        LEFT JOIN '||V_ESQUEMA||'.BIE_BIEN BIE ON LOBLOTE.BIE_ID = BIE.BIE_ID
  GROUP BY LOS.SUB_ID
),
TIPO_PROCEDIMIENTO AS (
SELECT /*+ MATERIALIZE */ ASU_ID, DD_TPO_DESCRIPCION
FROM (
  SELECT PRC.ASU_ID, DDTPO.DD_TPO_DESCRIPCION, ROW_NUMBER() OVER (PARTITION BY PRC.ASU_ID ORDER BY PRC.PRC_ID DESC) NUM
    FROM '||V_ESQUEMA||'.PRC_PROCEDIMIENTOS PRC
      INNER JOIN '||V_ESQUEMA||'.DD_TPO_TIPO_PROCEDIMIENTO DDTPO ON PRC.DD_TPO_ID = DDTPO.DD_TPO_ID
    WHERE DDTPO.DD_TPO_CODIGO IN (''P01'',''P02'',''P03'',''P04'',''P15'',''P17'',''P25'')
) WHERE NUM = 1)
SELECT
  SUB.SUB_ID
  ,PRC.PRC_COD_PROC_EN_JUZGADO NUMERO_AUTO
  ,DD_JUZ.DD_JUZ_DESCRIPCION NUMERO_JUZ
  ,DD_PLA.DD_PLA_DESCRIPCION PROV_JUZ
  ,SUBSTR(CNT.CNT_CONTRATO,11,17) || ''/'' || DDAPO.DD_APO_DESCRIPCION NUM_OPERACION
  ,OFI.OFI_NOMBRE CENTRO
  ,TIT.PER_NOM50 TITULAR
  ,CASE WHEN FIA.NFIADORES >0 THEN 1 ELSE 0 END FIADORES
  ,TPROCEDI.DD_TPO_DESCRIPCION TPO_PROCEDI
  ,DESP_LET.DES_DESPACHO LETRADO
  ,DESP_PROC.DES_DESPACHO PROCURADOR
  ,VFDEMANDA.TEV_VALOR FDEMANDA
  ,SUB.SUB_FECHA_SENYALAMIENTO FSUBASTA
  ,TPOSUB.TIPO_SUBASTA TPO_SUBASTA
  ,PRC.PRC_SALDO_RECUPERACION PRINCIPAL_DEMANDA
  ,CASE WHEN INTSUBASTA.TEV_VALOR IS NULL THEN ''0'' ELSE INTSUBASTA.TEV_VALOR END INT_MORATORIOS
  ,CASE WHEN CLETRADO.TEV_VALOR IS NULL THEN ''0'' ELSE CLETRADO.TEV_VALOR END MINUTA_LETRADO
  ,CASE WHEN CPROCURADOR.TEV_VALOR IS NULL THEN ''0'' ELSE CPROCURADOR.TEV_VALOR END MINUTA_PROCURADOR
  ,CASE WHEN MOV.MOV_ENTREGAS_A_CUENTA IS NULL THEN 0 ELSE MOV.MOV_ENTREGAS_A_CUENTA END ENTREGAS_CUENTA
  ,ASU.ASU_OBSERVACION COMENTARIOS
  ,CASE WHEN CERTCARGAS.NDOCS >0 THEN 1 ELSE 0 END CERTCARGAS
  ,CASE WHEN EDICTO.NDOCS >0 THEN 1 ELSE 0 END EDICTO
  ,CASE WHEN AVALUO.NDOCS >0 THEN 1 ELSE 0 END AVALUO
FROM  SUB_SUBASTA SUB
  LEFT JOIN '||V_ESQUEMA||'.DD_TSU_TIPO_SUBASTA DD_TSU ON SUB.DD_TSU_ID = DD_TSU.DD_TSU_ID
  LEFT JOIN '||V_ESQUEMA||'.TIPOS_SUBASTA TPOSUB ON TPOSUB.SUB_ID = SUB.SUB_ID
  LEFT JOIN '||V_ESQUEMA||'.ASU_ASUNTOS ASU ON SUB.ASU_ID = ASU.ASU_ID
    LEFT JOIN '||V_ESQUEMA||'.DESPACHOS_LETRADO DESP_LET ON DESP_LET.ASU_ID = ASU.ASU_ID
    LEFT JOIN '||V_ESQUEMA||'.DESPACHOS_PROCURADORES DESP_PROC ON DESP_PROC.ASU_ID = ASU.ASU_ID
    LEFT JOIN '||V_ESQUEMA||'.TIPO_PROCEDIMIENTO TPROCEDI ON ASU.ASU_ID = TPROCEDI.ASU_ID
  LEFT JOIN '||V_ESQUEMA||'.PRC_PROCEDIMIENTOS PRC ON SUB.PRC_ID = PRC.PRC_ID
    LEFT JOIN '||V_ESQUEMA||'.DD_JUZ_JUZGADOS_PLAZA DD_JUZ ON PRC.DD_JUZ_ID = DD_JUZ.DD_JUZ_ID
    LEFT JOIN '||V_ESQUEMA||'.DD_PLA_PLAZAS DD_PLA ON DD_JUZ.DD_PLA_ID = DD_PLA.DD_PLA_ID
    LEFT JOIN '||V_ESQUEMA||'.VALORES_DEMANDA VDEMANDA ON PRC.PRC_ID = VDEMANDA.PRC_ID  AND UPPER(VDEMANDA.TEV_NOMBRE) = UPPER(''principalDemanda'')
    LEFT JOIN '||V_ESQUEMA||'.VALORES_DEMANDA VFDEMANDA ON PRC.PRC_ID = VFDEMANDA.PRC_ID  AND UPPER(VFDEMANDA.TEV_NOMBRE) IN (''FECHASOLICITUD'', ''FECHADEMANDA'')
    LEFT JOIN '||V_ESQUEMA||'.CONTRATOS_MAYORES CNTMAY ON PRC.PRC_ID = CNTMAY.PRC_ID
        LEFT JOIN '||V_ESQUEMA||'.MOV_MOVIMIENTOS MOV ON CNTMAY.CNT_ID = MOV.CNT_ID
        LEFT JOIN '||V_ESQUEMA||'.CNT_CONTRATOS CNT ON CNTMAY.CNT_ID = CNT.CNT_ID
          LEFT JOIN '||V_ESQUEMA||'.DD_APO_APLICATIVO_ORIGEN DDAPO ON CNT.DD_APO_ID = DDAPO.DD_APO_ID
          LEFT JOIN '||V_ESQUEMA||'.OFI_OFICINAS OFI ON CNT.OFI_ID = OFI.OFI_ID
          LEFT JOIN '||V_ESQUEMA||'.FIADORES FIA ON CNT.CNT_ID = FIA.CNT_ID
          LEFT JOIN '||V_ESQUEMA||'.TITULARES TIT ON CNT.CNT_ID = TIT.CNT_ID
    LEFT JOIN '||V_ESQUEMA||'.DOCADJUNTO CERTCARGAS ON ASU.ASU_ID = CERTCARGAS.ASU_ID AND CERTCARGAS.DD_TFA_CODIGO IN (''CCB'',''CCH'')
    LEFT JOIN '||V_ESQUEMA||'.DOCADJUNTO EDICTO ON ASU.ASU_ID = EDICTO.ASU_ID AND EDICTO.DD_TFA_CODIGO IN (''ESRAS'')
    LEFT JOIN '||V_ESQUEMA||'.DOCADJUNTO AVALUO ON ASU.ASU_ID = AVALUO.ASU_ID AND AVALUO.DD_TFA_CODIGO IN (''AVPR'')
    LEFT JOIN '||V_ESQUEMA||'.VALORES_SENYALAMIENTO INTSUBASTA ON PRC.PRC_ID = INTSUBASTA.PRC_ID AND UPPER(INTSUBASTA.TEV_NOMBRE) = UPPER(''INTERESES'')
    LEFT JOIN '||V_ESQUEMA||'.VALORES_SENYALAMIENTO CLETRADO ON PRC.PRC_ID = CLETRADO.PRC_ID AND UPPER(CLETRADO.TEV_NOMBRE) = UPPER(''COSTASLETRADO'')
    LEFT JOIN '||V_ESQUEMA||'.VALORES_SENYALAMIENTO CPROCURADOR ON PRC.PRC_ID = CPROCURADOR.PRC_ID AND UPPER(CPROCURADOR.TEV_NOMBRE) = UPPER(''COSTASPROCURADOR'')';
    EXECUTE IMMEDIATE V_MSQL;     
    DBMS_OUTPUT.PUT_LINE('[INFO] Vista modificada');
    
    
EXCEPTION
  WHEN OTHERS THEN
    ERR_NUM := SQLCODE;
    ERR_MSG := SQLERRM;
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(ERR_MSG);
    ROLLBACK;
    RAISE;   
END;
/
EXIT;
