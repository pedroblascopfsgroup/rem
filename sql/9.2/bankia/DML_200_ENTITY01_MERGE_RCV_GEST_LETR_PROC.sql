--/*
--##########################################
--## AUTOR=Rafael Aracil López
--## FECHA_CREACION=20160629
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=1.0
--## INCIDENCIA_LINK=RECOVERY-2110
--## PRODUCTO=SI
--## Finalidad: MERGE DATOS EN TABLA  RCV_GEST_LETR_PROC
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_ESQUEMA_MINIREC VARCHAR2(25 CHAR):= '#ESQUEMA_MINIREC#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    
    V_NUM NUMBER; 
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
BEGIN


DBMS_OUTPUT.PUT_LINE('[INFO] MERGEAMOS REGISTROS EN '||V_ESQUEMA||'.RCV_GEST_LETR_PROC');


execute immediate'
MERGE INTO '||V_ESQUEMA_MINIREC||'.RCV_GEST_LETR_PROC A
USING
(
WITH 
PROVINCIA_POR_DESPACHO AS ( 
  select DEA.DES_ID, PRV.DD_PRV_DESCRIPCION, ROW_NUMBER () OVER (PARTITION BY DEA.DES_ID ORDER BY DEA.FECHAMODIFICAR DESC) R
  from '||V_ESQUEMA||'.DEA_DESPACHO_EXTRAS_AMBITO DEA
  inner join '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA PRV ON PRV.DD_PRV_ID = DEA.DD_PRV_ID
  where DEA.BORRADO !=1
)
select 
    DES.DES_ID DES_ID,
    DCE.DD_DCE_DESCRIPCION COD_EST_ASE,
    DID.DD_DID_CODIGO IVA_DES, 
    DCV.DD_DCV_CODIGO CONTRATO_VIGOR, 
    DCP.DD_DCP_CODIGO CLASIFIC_PERFIL,
    DRE.DD_DRE_CODIGO REL_ENTIDAD, 
    ''RECOVEC-2110'' USUARIOMODIFICAR,
    SYSDATE FECHAMODIFICAR
from '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO DES
inner join '||V_ESQUEMA_M||'.DD_TDE_TIPO_DESPACHO TDE ON TDE.DD_TDE_ID = DES.DD_TDE_ID AND TDE.DD_TDE_CODIGO in (''1'',''2'')
left join '||V_ESQUEMA||'.DEE_DESPACHO_EXTRAS DEE ON DEE.DES_ID = DES.DES_ID
left join '||V_ESQUEMA||'.DD_TDI_TIPO_DOCUMENTO_ID TDI ON TDI.DD_TDI_ID = DEE.DD_TDI_ID
left join PROVINCIA_POR_DESPACHO PPD ON PPD.DES_ID = DES.DES_ID AND PPD.R = 1
LEFT JOIN '||V_ESQUEMA||'.DD_DCV_DESPACHO_CNT_VIGOR DCV ON DEE.DD_DCV_ID = DCV.DD_DCV_ID
LEFT JOIN '||V_ESQUEMA||'.DD_DCP_DESPACHO_CLASI_PERFIL DCP ON DEE.DD_DCP_ID = DCP.DD_DCP_ID
LEFT JOIN '||V_ESQUEMA||'.DD_DRE_DESPACHO_REL_ENTIDAD DRE ON DRE.DD_DRE_ID = DEE.DD_DRE_ID
LEFT JOIN '||V_ESQUEMA||'.DD_DCE_DESPACHO_COD_ESTADO DCE ON DEE.DD_DCE_ID = DCE.DD_DCE_ID
LEFT JOIN '||V_ESQUEMA||'.DD_DID_DESPACHO_IVA_DES DID ON DID.DD_DID_ID = DEE.DD_DID_ID
) B
ON ( A.DES_ID=B.DES_ID )
WHEN MATCHED THEN UPDATE SET
A.COD_EST_ASE=B.COD_EST_ASE,
A.IVA_DES=B.IVA_DES,
A.CONTRATO_VIGOR=B.CONTRATO_VIGOR,
A.CLASIFIC_PERFIL=B.CLASIFIC_PERFIL,
A.REL_ENTIDAD=B.REL_ENTIDAD';

DBMS_OUTPUT.PUT_LINE('[INFO] Registros MERGEADOS en '||V_ESQUEMA_MINIREC||'.RCV_GEST_LETR_PROC');



	
    COMMIT;
	
EXCEPTION
  WHEN OTHERS THEN
    ERR_NUM := SQLCODE;
    ERR_MSG := SQLERRM;
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(ERR_MSG);
    ROLLBACK;
    RAISE;   
    
END;
/

EXIT;