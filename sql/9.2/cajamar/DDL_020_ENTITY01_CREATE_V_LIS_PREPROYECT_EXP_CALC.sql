--/*
--##########################################
--## AUTOR=BRUNO ANGLES
--## FECHA_CREACION=20160229
--## ARTEFACTO=web
--## VERSION_ARTEFACTO=9.1.0-cj-rc37.6-patch22
--## INCIDENCIA_LINK=CMREC-2355
--## PRODUCTO=NO
--## Finalidad: DDL crear vista para Proyectado / Preproyectado
--##           
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TS_INDEX VARCHAR2(25 CHAR):= '#TABLESPACE_INDEX#'; -- Configuracion Indice
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_COUNT NUMBER(16); -- Vble. para validar la existencia de una tabla.  
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

    V_TEXT1 VARCHAR2(2400 CHAR); -- Vble. auxiliar
    
    V_ESQUEMA_MIN VARCHAR2(25 CHAR):= '#ESQUEMA_MINI#'; -- Configuracion Esquema minirec
    V_ESQUEMA_DWH VARCHAR2(25 CHAR):= '#ESQUEMA_DWH#'; -- Configuracion Esquema recovery_bankia_dwh
    V_ESQUEMA_STG VARCHAR2(25 CHAR):= '#ESQUEMA_STG#'; -- Configuracion Esquema recovery_bankia_datastage

    BEGIN
	    
	 -- Añadir camo DATA_RULE_ENGINE.PER_RIESGO_TOTAL
    DBMS_OUTPUT.PUT_LINE('[INFO] Creando vista ' || V_ESQUEMA || '.V_LIS_PREPROYECT_EXP_CALC...');
	V_SQL := 'CREATE OR REPLACE VIEW V_LIS_PREPROYECT_EXP_CALC (EXP_ID
, DIAS_VENCIDOS, COD_TRAMO, RIESGO_TOTAL_EXP, DEUDA_IRREGULAR_EXP, FECHA_PREV_REGU_CNT, FECHA_PASE_A_MORA_EXP
, PER_DOC_ID, PER_NOM_COMPLETO) AS
WITH EXP_BASE AS (
    SELECT EXP.EXP_ID
        , CEX.CNT_ID
        , CASE WHEN MOV.MOV_FECHA_POS_VENCIDA IS NOT NULL THEN
              CASE WHEN TRUNC(SYSDATE-MOV.MOV_FECHA_POS_VENCIDA)  < 0 THEN 0 ELSE TRUNC(SYSDATE-MOV.MOV_FECHA_POS_VENCIDA) END
          ELSE 0
          END DIAS_VENCIDOS
        , NVL(MOV.MOV_DEUDA_IRREGULAR, 0) MOV_DEUDA_IRREGULAR
        , NVL(MOV.MOV_RIESGO, 0) MOV_RIESGO
        , ACU.ACU_FECHA_LIMITE
    FROM ' || V_ESQUEMA || '.EXP_EXPEDIENTES EXP
      JOIN ' || V_ESQUEMA || '.CEX_CONTRATOS_EXPEDIENTE CEX ON EXP.EXP_ID = CEX.EXP_ID AND CEX.BORRADO = 0
      JOIN ' || V_ESQUEMA || '.CNT_CONTRATOS CNT ON CEX.CNT_ID = CNT.CNT_ID AND CNT.BORRADO = 0
      JOIN ' || V_ESQUEMA || '.MOV_MOVIMIENTOS MOV ON CNT.CNT_ID = MOV.CNT_ID AND CNT.CNT_FECHA_EXTRACCION = MOV.MOV_FECHA_EXTRACCION
      LEFT JOIN ' || V_ESQUEMA || '.TEA_CNT ON TEA_CNT.CNT_ID = CEX.CNT_ID AND TEA_CNT.BORRADO = 0
			LEFT JOIN ' || V_ESQUEMA || '.TEA_TERMINOS_ACUERDO TEA ON TEA.TEA_ID = TEA_CNT.TEA_ID AND TEA.BORRADO = 0
			LEFT JOIN ' || V_ESQUEMA || '.ACU_ACUERDO_PROCEDIMIENTOS ACU ON ACU.ACU_ID = TEA.ACU_ID AND ACU.BORRADO = 0
    WHERE EXP.BORRADO = 0
  )
  , EXP_AGREGADO AS (
    SELECT E.EXP_ID
        , E.CNT_ID
        , MAX(DIAS_VENCIDOS) OVER (PARTITION BY EXP_ID) DIAS_VENCIDOS
        , SUM(MOV_DEUDA_IRREGULAR) OVER (PARTITION BY EXP_ID) DEUDA_IRREGULAR_EXP 
        , SUM(MOV_RIESGO) OVER (PARTITION BY EXP_ID) RIESGO_TOTAL_EXP
        , MAX(ACU_FECHA_LIMITE) OVER (PARTITION BY CNT_ID) FECHA_PREV_REGU_CNT
    FROM EXP_BASE E
  )
  SELECT E.EXP_ID
      , E.DIAS_VENCIDOS
      , NVL(T.DD_TDV_CODIGO,''-'') COD_TRAMO
      , E.RIESGO_TOTAL_EXP
      , E.DEUDA_IRREGULAR_EXP
      , E.FECHA_PREV_REGU_CNT
      , CASE WHEN E.DIAS_VENCIDOS < 0 THEN NULL ELSE TRUNC((SYSDATE+90) - E.DIAS_VENCIDOS) END FECHA_PASE_A_MORA_EXP
      , TITU.PER_DOC_ID
      , TITU.PER_NOM_COMPLETO
  FROM EXP_AGREGADO E
    LEFT JOIN (
      SELECT CPE.CNT_ID, PER.PER_DOC_ID, UPPER(PER.PER_NOMBRE || '' '' || PER.PER_APELLIDO1 || '' '' || PER.PER_APELLIDO2) PER_NOM_COMPLETO
      FROM ' || V_ESQUEMA || '.CPE_CONTRATOS_PERSONAS CPE
        JOIN ' || V_ESQUEMA || '.DD_TIN_TIPO_INTERVENCION TIN ON CPE.DD_TIN_ID = TIN.DD_TIN_ID AND TIN.DD_TIN_TITULAR = 1
        JOIN ' || V_ESQUEMA || '.PER_PERSONAS PER ON CPE.PER_ID = PER.PER_ID AND PER.BORRADO = 0
      WHERE CPE.BORRADO = 0
    ) TITU ON E.CNT_ID = TITU.CNT_ID
    LEFT JOIN ' || V_ESQUEMA || '.DD_TDV_TRAMOS_DIAS_VENCIDOS T ON E.DIAS_VENCIDOS BETWEEN T.DD_TDV_DIA_INICIO AND T.DD_TDV_DIA_FIN
  WHERE E.DEUDA_IRREGULAR_EXP > 0
	';
		  
	EXECUTE IMMEDIATE V_SQL;
    
EXCEPTION
  WHEN OTHERS THEN
    ERR_NUM := SQLCODE;
    ERR_MSG := SQLERRM;
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(ERR_MSG);
    ROLLBACK;
    RAISE;   
END;
/
EXIT;