--/*
--##########################################
--## AUTOR=PEDRO_BLASCO
--## FECHA_CREACION=20160317
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=CMREC-1849
--## PRODUCTO=NO
--## Finalidad: DML para crear nuevos tipos de burofax de Cajamar
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
set linesize 2000
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

   V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
   V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master

   V_NUM_REGS NUMBER(16); -- Vble. para validar la existencia de un registro   
   ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
   ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

   V_DDNAME VARCHAR2(50 CHAR):= 'DD_PCO_BFT_TIPO';
   V_SEQNAME VARCHAR2(50 CHAR):= 'S_DD_PCO_BFT_TIPO';
   V_PREFIJO VARCHAR2(50 CHAR) := 'DD_PCO_BFT_';

   V_MERGE  VARCHAR2(4000 CHAR) := 'MERGE INTO ' || V_ESQUEMA || '.' || V_DDNAME|| ' tabla  ' || 
    ' USING (SELECT :id id, :codigo codigo, :des descripcion, :des_l descripcion_larga, :planti plantilla, ''INICIAL'' usuariocrear, sysdate fechacrear from DUAL) actual ' ||
    ' ON (tabla.' || V_PREFIJO || 'CODIGO=actual.codigo) ' ||
    ' WHEN NOT MATCHED THEN ' ||
    ' INSERT (' || V_PREFIJO || 'ID, ' || V_PREFIJO || 'CODIGO, ' || V_PREFIJO || 'DESCRIPCION, ' || V_PREFIJO || 'DESCRIPCION_LARGA, ' || V_PREFIJO || 'PLANTILLA, usuariocrear, fechacrear) ' ||
    ' VALUES (actual.id, actual.codigo, actual.descripcion, actual.descripcion_larga, actual.plantilla, actual.usuariocrear, actual.fechacrear) ' ||
    ' WHEN MATCHED THEN ' ||
    ' UPDATE SET tabla.' || V_PREFIJO || 'DESCRIPCION=actual.descripcion, tabla.' || V_PREFIJO || 'DESCRIPCION_LARGA=actual.descripcion_larga, tabla.' || V_PREFIJO || 'PLANTILLA=actual.plantilla,BORRADO=0'  ;
         
    --Valores a insertar
    TYPE T_TIPO IS TABLE OF VARCHAR2(4000 CHAR);
    TYPE T_ARRAY IS TABLE OF T_TIPO;
    V_TIPO T_ARRAY := T_ARRAY(
      T_TIPO('BF_AVAL', 'Aval', 
          'EN SU CALIDAD DE ${tipoIntervencion} DE LA POLIZA DE RELEVACION DE FIANZA No ${CODIGO_DE_CONTRATO} CONCEDIDA CON FECHA ${FECFORMALIZ} POR UN LÍMITE DE ${CAL_RUT_POLIZA} EUROS, LE NOTIFICAMOS QUE POR RAZÓN DE DICHA PÓLIZA SE ADEUDA A ${GEN_ENT_N}, LA CANTIDAD DE ${CAPITALCER} EUROS DE PRINCIPAL Y ${DEMORACER} EUROS DE INTERESES MORATORIOS PACTADOS, ASCENDIENDO EL TOTAL DE LA DEUDA POR LOS CONCEPTOS EXPRESADOS A LA CANTIDAD DE ${IMPCER} EUROS AL DÍA ${FECHA_CIERRE_LIQUIDACION}, IMPORTE CUYO PAGO LE REQUERIMOS A EFECTOS DE LO DISPUESTO EN LOS ARTICULOS 572 Y 573 DE LA LEY DE ENJUICIAMIENTO CIVIL. <br/><br/>RECUERDE QUE POR EL IMPAGO DE SU DEUDA SUS DATOS PUEDEN SER INCORPORADOS A FICHEROS DE CUMPLIMIENTO O INCUMPLIMIENTO DE OBLIGACIONES DINERARIAS.<br/><br/>${GEN_ENT_N}<br/>${LOCCRD}'),
      T_TIPO('BF_CARTERA', 'Cartera', 
          'EN SU CALIDAD DE ${tipoIntervencion} DE LA PÓLIZA DE GARANTÍA Y AFIANZAMIENTO DE OPERACIONES MERCANTILES No ${CODIGO_DE_CONTRATO} FORMALIZADA EL DÍA ${FECFORMALIZ} POR UN PRINCIPAL DE ${CAL_RUT_POLIZA} EUROS, LE NOTIFICAMOS QUE POR RAZÓN DE DICHA PÓLIZA SE ADEUDA A ${GEN_ENT_N} LA CANTIDAD DE ${CAPITALCER} EUROS EN CONCEPTO DE PRINCIPAL MÁS ${DEMORACER} EUROS DE INTERESES MORATORIOS PACTADOS, ASCENDIENDO EL TOTAL DE LA DEUDA POR LOS CONCEPTOS EXPRESADOS A LA CANDIDAD DE ${IMPCER} EUROS AL DÍA ${FECHA_CIERRE_LIQUIDACION}, IMPORTE CUYO PAGO LE REQUERIMOS A EFECTOS DE LO DISPUESTO EN LOS ARTICULOS 572 Y 573 DE LA LEY DE ENJUICIAMIENTO CIVIL. <br/><br/>RECUERDE QUE POR EL IMPAGO DE SU DEUDA SUS DATOS PUEDEN SER INCORPORADOS A FICHEROS DE CUMPLIMIENTO O INCUMPLIMIENTO DE OBLIGACIONES DINERARIAS.<br/><br/>${GEN_ENT_N}<br/>${LOCCRD}'),
      T_TIPO('BF_COMERCIO_EXTERIOR', 'Comercio Exterior', 
          'EN SU CALIDAD DE ${tipoIntervencion} DE LA PÓLIZA DE CRÉDITO PARA OPERACIONES DE COMERCIO EXTERIOR No ${CODIGO_DE_CONTRATO} FORMALIZADA EL DÍA ${FECFORMALIZ} POR UN LÍMITE DE ${CAL_RUT_POLIZA} EUROS, LE NOTIFICAMOS QUE POR INCUMPLIMIENTO DE LAS OBLIGACIONES DE PAGO PACTADAS, SE ADEUDA A ${GEN_ENT_N}, LA CANTIDAD DE ${CAPITALCER} EUROS DE PRINCIPAL, ${IMPINTERESTELEG} EUROS DE INTERESES REMUNERATORIOS PACTADOS Y ${DEMORACER} EUROS DE INTERESES MORATORIOS PACTADOS, ASCENDIENDO EL TOTAL DE LA DEUDA A LA CANTIDAD DE ${IMPCER} EUROS AL DÍA ${FECHA_CIERRE_LIQUIDACION}, IMPORTE CUYO PAGO LE REQUERIMOS A EFECTOS DE LO DISPUESTO EN LOS ARTICULOS 572 Y 573 DE LA LEY DE ENJUICIAMIENTO CIVIL. <br/><br/>RECUERDE QUE POR EL IMPAGO DE SU DEUDA SUS DATOS PUEDEN SER INCORPORADOS A FICHEROS DE CUMPLIMIENTO O INCUMPLIMIENTO DE OBLIGACIONES DINERARIAS.<br/><br/>${GEN_ENT_N}<br/>${LOCCRD}'),
      T_TIPO('BF_CREDITO', 'Crédito', 
          'EN SU CALIDAD DE ${tipoIntervencion} DE LA PÓLIZA DE CRÉDITO EN CUENTA CORRIENTE No ${CODIGO_DE_CONTRATO} CONCEDIDA EL DÍA ${FECFORMALIZ} POR UN LÍMITE DE ${CAL_RUT_POLIZA} EUROS, LE NOTIFICAMOS QUE POR RAZÓN DE DICHA PÓLIZA SE ADEUDA A ${GEN_ENT_N}, POR IMPORTE DE ${CAPITALCER} EUROS EN CONCEPTO DE CREDITO DISPUESTO Y NO DEVUELTO, ${INTERESCER} EUROS DE INTERESES REMUNERATORIOS PACTADOS, ${IMPINTERESTELEG} EUROS DE INTERESES SOBRE CRÉDITO EXCEDIDO DISPUESTO, ${IMPCOMITELEG} EUROS DE COMISIONES PACTADAS Y NO PAGADAS Y ${DEMORACER} EUROS EN CONCEPTO DE IMPORTE DE DEMORA DE LA LIQUIDACION, ASCENDIENDO EL TOTAL DE LA DEUDA POR LOS CONCEPTOS EXPRESADOS A LA CANTIDAD DE ${FECHA_CIERRE_LIQUIDACION} EUROS AL DÍA ${IMPCER}, IMPORTE CUYO PAGO LE REQUERIMOS A EFECTOS DE LO DISPUESTO EN LOS ARTICULOS 572 Y 573 DE LA LEY DE ENJUICIAMIENTO CIVIL. <br/><br/>RECUERDE QUE POR EL IMPAGO DE SU DEUDA SUS DATOS PUEDEN SER INCORPORADOS A FICHEROS DE CUMPLIMIENTO O INCUMPLIMIENTO DE OBLIGACIONES DINERARIAS.<br/><br/>${GEN_ENT_N}<br/>${LOCCRD}'),
      T_TIPO('BF_LEASING', 'Leasing', 
          'EN SU CALIDAD DE ${tipoIntervencion} DEL CONTRATO DE ARRENDAMIENTO FINANCIERO No ${CODIGO_DE_CONTRATO} CONCEDIDA EL DÍA ${FECFORMALIZ}, LE NOTIFICAMOS QUE POR INCUMPLIMIENTO DE LAS OBLIGACIONES DE PAGO PACTADAS HEMOS DADO POR VENCIDO ANTICIPADAMENTE EL CONTRATO, RESULTANDO UNA DEUDA A FAVOR DE ${GEN_ENT_N}, AL DÍA ${FECHA_CIERRE_LIQUIDACION} POR IMPORTE DE ${CAPITALCER} EUROS EN CONCEPTO DE CUOTAS MÁS IVA VENCIDAS E IMPAGADAS, ${INTERESCER} EUROS DE PRINCIPAL E INTERESES PENDIENTES MÁS IVA Y ${DEMORACER} EUROS DE INTERESES MORATORIOS PACTADOS, ASCENDIENDO EL TOTAL DE LA DEUDA POR LOS CONCEPTOS EXPRESADOS A LA CANTIDAD DE ${IMPCER} EUROS AL HABERSE RESUELTO DE PLENO DERECHO EN VIRTUD DE LO PACTADO EN LA CONDICIÓN GENERAL DECIMOTERCERA 3o-A, IMPORTE CUYO PAGO LE REQUERIMOS A EFECTOS DE LO DISPUESTO EN LOS ARTICULOS 572 Y 573 DE LA LEY DE ENJUICIAMIENTO CIVIL. <br/><br/>RECUERDE QUE POR EL IMPAGO DE SU DEUDA SUS DATOS PUEDEN SER INCORPORADOS A FICHEROS DE CUMPLIMIENTO O INCUMPLIMIENTO DE OBLIGACIONES DINERARIAS.<br/><br/>${GEN_ENT_N}<br/>${LOCCRD}'),
      T_TIPO('BF_PRESTAMO_HIPO', 'Préstamo Hipotecario', 
          'EN SU CALIDAD DE ${tipoIntervencion} DEL PRESTAMO HIPOTECARIO No ${CODIGO_DE_CONTRATO} FORMALIZADO EL DIA ${FECFORMALIZ} ANTE EL NOTARIO ${nombreNotario} POR UN PRINCIPAL DE ${CAL_RUT_POLIZA} EUROS, LE NOTIFICAMOS QUE POR INCUMPLIMIENTO DE LAS OBLIGACIONES DE PAGO PACTADAS, HEMOS DADO POR VENCIDO ANTICIPADAMENTE EL PRÉSTAMO HIPOTECARIO, RESULTANDO UNA DEUDA A FAVOR DE ${GEN_ENT_N}, POR IMPORTE DE ${CAPITALCER} EUROS DE PRINCIPAL, ${INTERESCER} EUROS DE INTERESES REMUNERATORIOS PACTADOS Y ${DEMORACER} EUROS DE INTERESES MORATORIOS PACTADOS, ASCENDIENDO EL TOTAL DE LA DEUDA POR LOS CONCEPTOS EXPRESADOS A LA CANTIDAD DE ${IMPCER} EUROS AL DÍA ${FECHA_CIERRE_LIQUIDACION}, IMPORTE CUYO PAGO LE REQUERIMOS A EFECTOS DE LO DISPUESTO EN LOS ARTICULOS 572 Y 573 DE LA LEY DE ENJUICIAMIENTO CIVIL. <br/><br/>RECUERDE QUE POR EL IMPAGO DE SU DEUDA SUS DATOS PUEDEN SER INCORPORADOS A FICHEROS DE CUMPLIMIENTO O INCUMPLIMIENTO DE OBLIGACIONES DINERARIAS.<br/><br/>${GEN_ENT_N}<br/>${LOCCRD}'),
      T_TIPO('BF_PRESTAMO_PERS', 'Préstamo Personal', 
        'EN SU CALIDAD DE ${tipoIntervencion} DEL PRESTAMO PERSONAL No ${CODIGO_DE_CONTRATO} CONCEDIDO EL DIA ${FECFORMALIZ} ANTE EL NOTARIO ${nombreNotario} POR UN PRINCIPAL DE ${CAL_RUT_POLIZA} EUROS, LE NOTIFICAMOS QUE POR INCUMPLIMIENTO DE LAS OBLIGACIONES DE PAGO PACTADAS, HEMOS DADO POR VENCIDO ANTICIPADAMENTE EL PRÉSTAMO PERSONAL, RESULTANDO UNA DEUDA A FAVOR DE ${GEN_ENT_N}, POR IMPORTE DE ${CAPITALCER} EUROS DE PRINCIPAL, ${INTERESCER} EUROS DE INTERESES REMUNERATORIOS PACTADOS Y ${DEMORACER} EUROS DE INTERESES MORATORIOS PACTADOS, ASCENDIENDO EL TOTAL DE LA DEUDA POR LOS CONCEPTOS EXPRESADOS A LA CANTIDAD DE ${IMPCER} EUROS AL DÍA ${FECHA_CIERRE_LIQUIDACION}, IMPORTE CUYO PAGO LE REQUERIMOS A EFECTOS DE LO DISPUESTO EN LOS ARTICULOS 572 Y 573 DE LA LEY DE ENJUICIAMIENTO CIVIL. <br/><br/>RECUERDE QUE POR EL IMPAGO DE SU DEUDA SUS DATOS PUEDEN SER INCORPORADOS A FICHEROS DE CUMPLIMIENTO O INCUMPLIMIENTO DE OBLIGACIONES DINERARIAS.<br/><br/>${GEN_ENT_N}<br/>${LOCCRD}')
    ); 
    V_TMP_TIPO T_TIPO;

    V_ENTIDAD_ID NUMBER(16);
    
    V_BORRADO_LOGICO VARCHAR2(2000 CHAR) := 'UPDATE ' || V_ESQUEMA || '.' || V_DDNAME || ' SET BORRADO=1';
    V_OBTENER_ID VARCHAR2(2000 CHAR) := 'SELECT ' || V_ESQUEMA || '.' || V_SEQNAME || '.NEXTVAL FROM DUAL';
    V_SELECT_ID  VARCHAR2(2000 CHAR) := 'SELECT COUNT(*) FROM ' || V_ESQUEMA || '.' || V_DDNAME || ' WHERE ' || V_PREFIJO || 'ID=:1';
  
BEGIN

  -- Borrado lógico los valores preexistentes en el diccionario
  DBMS_OUTPUT.PUT_LINE('[INICIO] '||V_ESQUEMA||'.' || V_DDNAME ||'... Borrando datos previos en el diccionario');
  EXECUTE IMMEDIATE V_BORRADO_LOGICO;
  
  -- LOOP Insertando valores en la tabla del diccionario
  DBMS_OUTPUT.PUT_LINE('[INICIO] '||V_ESQUEMA||'.' || V_DDNAME ||'... Empezando a insertar datos en el diccionario');
  FOR I IN V_TIPO.FIRST .. V_TIPO.LAST
  LOOP
    V_TMP_TIPO := V_TIPO(I);
    LOOP
      --Obtenemos el ID correspondiente al siguiente valor de la secuencia 
      --DBMS_OUTPUT.PUT_LINE(V_OBTENER_ID);
      EXECUTE IMMEDIATE V_OBTENER_ID INTO V_ENTIDAD_ID;
      --Comprobamos que no exista ese ID como identificador de ningún registro
      --DBMS_OUTPUT.PUT_LINE(V_SELECT_ID);
      EXECUTE IMMEDIATE V_SELECT_ID INTO V_NUM_REGS USING V_ENTIDAD_ID;
      EXIT WHEN V_NUM_REGS=0;
    END LOOP;
    -- Ejecutamos el merge que ya comprueba si existe el código, en cuyo caso lo que hace es actualizar valores del registro
    --DBMS_OUTPUT.PUT_LINE(V_MERGE);
    EXECUTE IMMEDIATE V_MERGE USING V_ENTIDAD_ID, V_TMP_TIPO(1), V_TMP_TIPO(2), V_TMP_TIPO(2), V_TMP_TIPO(3);
    DBMS_OUTPUT.PUT_LINE('INSERTANDO: ' || V_ENTIDAD_ID || ', '''||V_TMP_TIPO(1)||''','''||TRIM(V_TMP_TIPO(2))||'''');
  END LOOP;
  COMMIT;
  DBMS_OUTPUT.PUT_LINE('[FIN] '||V_ESQUEMA||'.' || V_DDNAME ||'... Datos del diccionario insertado');

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.PUT_LINE('KO no modificado');
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;

/

EXIT
