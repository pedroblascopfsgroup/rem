--/*
--##########################################
--## AUTOR=CLV
--## FECHA_CREACION=20160727
--## ARTEFACTO=BATCH
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=RECOVERY-2495
--## PRODUCTO=NO
--## 
--## Finalidad: 
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_MSQL         VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA      VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M    VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL          VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS   NUMBER(16); -- Vble. para validar la existencia de una tabla.  
    ERR_NUM        NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG        VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

    V_TEXT1        VARCHAR2(2400 CHAR); -- Vble. auxiliar
    
BEGIN
     
    V_MSQL := 'delete from '||V_ESQUEMA||'.RIESGO_OPE_DATOS_GENER_CONVIV';
    EXECUTE IMMEDIATE V_MSQL;

    V_MSQL := 'delete from '||V_ESQUEMA||'.RIESGO_OPE_REG_BAJA_CONVIV';
    EXECUTE IMMEDIATE V_MSQL;
    
    V_MSQL := 'delete from '||V_ESQUEMA||'.RIESGO_OPE_REG_CONTROL_CONVIV';
    EXECUTE IMMEDIATE V_MSQL;
    
    V_MSQL := 'delete from '||V_ESQUEMA||'.RIESGO_OPE_REG_RECUPER_CONVIV';
    EXECUTE IMMEDIATE V_MSQL;
   

    V_MSQL := '
	INSERT INTO '||V_ESQUEMA||'.RIESGO_OPE_DATOS_GENER_CONVIV(
	TIPO_REGISTRO, NUMERO_CONTRATO
	,FECHA_EXPEDIENTE
	,CENTRO_ESTUDIO_EXPEDIENTE
	,CAPITAL_DOTADO
	,FECHA_DOTADO
	,SITUACION_OPERACION
	,SITUACION_CONTABLE
	,IMPORTE_CONCEDIDO
	,CAPITAL_VIVO
	,CODIGO_PRODUCTO
	,IDENTIFICACION_TITULAR
	,TIPO_EVENTO
	,FECHA_SIT_CONTABLE
	,OBSERVACIONES
	,ENVIADO
	,USUARIOCREAR
	,FECHACREAR
	,USUARIOMODIFICAR
	,FECHAMODIFICAR)
	SELECT distinct 
	''DAT'' TIPO_REGISTRO,
	CNT.CNT_CONTRATO NUMERO_CONTRATO,
	(SELECT distinct TRUNC(TAR.TAR_FECHA_FIN)
	   FROM 
		     '||V_ESQUEMA||'.PRC_PROCEDIMIENTOS PRC,
		     '||V_ESQUEMA||'.PCO_PRC_PROCEDIMIENTOS PCO,
		     '||V_ESQUEMA||'.PRC_CEX PCEX,
		     '||V_ESQUEMA||'.CEX_CONTRATOS_EXPEDIENTE CEX
		    ,'||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR
		    ,'||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX 
		    ,'||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP 
	WHERE PRC.PRC_ID = PCO.PRC_ID
	    AND PCEX.PRC_ID = PRC.PRC_ID 
	    AND CEX.CEX_ID = PCEX.CEX_ID
	    AND PRC.ASU_ID = TAR.ASU_ID
	     AND TAR.TAR_ID = TEX.TAR_ID 
	     AND TEX.TAP_ID=TAP.TAP_ID 
	     AND TAP.BORRADO=0 
	     AND TAP.TAP_CODIGO=''PCO_RevisarExpedientePreparar''
	     and tar_tarea_finalizada = 1   
	    AND PRC.BORRADO = 0
	    AND PCO.BORRADO = 0
	    AND CEX.BORRADO = 0
	    AND CEX.CNT_ID = CNT.CNT_ID
	    AND ROWNUM = 1
	    )FECHA_ESTUDIO_EXP,
	CNT.DD_GES_ID CENTRO_ESTUDIO,
	(SELECT MOV.MOV_PROVISION FROM '||V_ESQUEMA||'.MOV_MOVIMIENTOS MOV WHERE MOV.CNT_ID = CNT.CNT_ID
	AND MOV.MOV_FECHA_EXTRACCION = (SELECT MAX(MOV_FECHA_EXTRACCION) FROM '||V_ESQUEMA||'.MOV_MOVIMIENTOS M WHERE M.CNT_ID = CNT.CNT_ID 
	)
	) CAPITAL_DOTADO,
	TO_DATE((select IAC_VALUE FROM '||V_ESQUEMA||'.EXT_IAC_INFO_ADD_CONTRATO EXT WHERE EXT.CNT_ID = CNT.CNT_ID AND EXT.dd_ifc_id = 36)) FECHA_DOTADO,
	(select IAC_VALUE FROM '||V_ESQUEMA||'.EXT_IAC_INFO_ADD_CONTRATO EXT WHERE EXT.CNT_ID = CNT.CNT_ID AND EXT.dd_ifc_id = 10 and EXT.IAC_VALUE = 10) SITUACION_OPERACION,
	(select SUBSTR(EFC.DD_EFC_CODIGO,2) from '||V_ESQUEMA||'.DD_EFC_ESTADO_FINAN_CNT EFC WHERE EFC.DD_EFC_ID = CNT.DD_EFC_ID) SITUACION_CONTABLE,
	CNT.CNT_LIMITE_INI IMPORTE_CONCEDIDO,
	(SELECT nvl(MOV.mov_pos_viva_vencida,0) + nvl(mov.mov_pos_viva_no_vencida,0) 
	   FROM '||V_ESQUEMA||'.MOV_MOVIMIENTOS MOV 
	  WHERE MOV.CNT_ID = CNT.CNT_ID
	    AND MOV.MOV_FECHA_EXTRACCION = (SELECT MAX(MOV_FECHA_EXTRACCION) FROM '||V_ESQUEMA||'.MOV_MOVIMIENTOS M WHERE M.CNT_ID = CNT.CNT_ID ))CAPITAL_VIVO,
	(select TPR.DD_TPR_CODIGO from '||V_ESQUEMA||'.DD_TPR_TIPO_PROD TPR WHERE TPR.DD_TPR_ID = CNT.dd_tpr_id) CODIGO_PRODUCTO,
	(select tpe.dd_tpe_codigo from '||V_ESQUEMA_M||'.DD_TPE_TIPO_PERSONA tpe where TPE.dd_tpe_id = per.dd_tpe_id) IDENTIFICACION_TITULAR,
	RIO.dd_rio_codigo TIPO_EVENTO,
	CNT.CNT_FECHA_EFC FECHA_SIT_CONTABLE,
	substrb(replace(replace(CRI.CRI_OBSERVACIONES, chr(13),''),chr(10),''),500) OBSERVACIONES,
	''NO'',
	''ETL_CONVIV'' USUARIOCREAR,
	to_date(''20160414'',''YYYYMMDD'') FECHACREAR,
	''ETL_CONVIV'' USUARIOMODIFICAR,
	to_date(''20160414'',''YYYYMMDD'') FECHAMODIFICAR
	FROM 
	'||V_ESQUEMA||'.CNT_CONTRATOS CNT,
	'||V_ESQUEMA||'.CPE_CONTRATOS_PERSONAS CPE,
	'||V_ESQUEMA||'.PER_PERSONAS PER,
	'||V_ESQUEMA||'.RIESGO_OPE_DATOS_GENER_CONVIV ROP,
	'||V_ESQUEMA||'.CRI_CONTRATO_RIESGOOPERACIONAL CRI,
	'||V_ESQUEMA||'.DD_RIO_RIESGO_OPERACIONAL RIO,
	'||V_ESQUEMA||'.CPE_CONTRATOS_PERSONAS REL
	WHERE CNT.CNT_ID = CPE.CNT_ID
	AND CPE.PER_ID = PER.PER_ID
	AND  CNT.CNT_ID  = REL.CNT_ID 
	AND  REL.CPE_ORDEN = (SELECT MIN(CPE_ORDEN) CPE_ORDEN FROM '||V_ESQUEMA||'.CPE_CONTRATOS_PERSONAS CPE WHERE CPE.CNT_ID = CNT.CNT_ID)
	AND  PER.PER_ID  = REL.PER_ID
	AND  ROP.NUMERO_CONTRATO (+) = CNT.CNT_CONTRATO 
	AND  REL.CPE_TIPO_INTERV_ORIGINAL = ''01''
	AND CRI.CNT_ID = CNT.CNT_ID
	AND CRI.DD_RIO_ID = RIO.DD_RIO_ID
	AND RIO.DD_RIO_CODIGO <> ''00''/* != DE RIESGO OPERACIONAL*/
	and exists (select 1 from '||V_ESQUEMA||'.DD_EFC_ESTADO_FINAN_CNT EFC WHERE EFC.DD_EFC_ID = CNT.DD_EFC_ID AND EFC.dd_efc_codigo = ''054'') ';
     
    commit;

EXCEPTION
  WHEN OTHERS THEN
    ERR_NUM := SQLCODE;
    ERR_MSG := SQLERRM;
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(ERR_MSG);
    ROLLBACK;
    RAISE;   
END;
/
EXIT;
