--/*
--##########################################
--## AUTOR=DANIEL ALBERT PÉREZ
--## FECHA_CREACION=20160229
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HR-2023
--## PRODUCTO=NO
--## 
--## Finalidad: Añadir un registro en usuarios, despachos y su relación
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;

DECLARE
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- Numero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_MSQL VARCHAR2(4000 CHAR);
    V_USUARIO_CREAR VARCHAR2(10) := 'MIGRAPCO';

--USU_USUARIOS

    TYPE T_USU_USUARIOS IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_USU IS TABLE OF T_USU_USUARIOS;

    V_USU_USUARIOS T_ARRAY_USU := T_ARRAY_USU(
									T_USU_USUARIOS('1','PENDIENTE DE MIGRACION', 'Pendiente de migración'));
    V_USU_ID NUMBER(16,0);
    V_TMP_USU_USUARIOS T_USU_USUARIOS;
    
--DES_DESPACHO_EXTERNO

    TYPE T_DES_DESPACHO_EXTERNO IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DES IS TABLE OF T_DES_DESPACHO_EXTERNO;

    V_DES_DESPACHO_EXTERNO T_ARRAY_DES := T_ARRAY_DES(
									T_DES_DESPACHO_EXTERNO('''PENDIENTE DE MIGRACION'''));
    V_DES_ID NUMBER(16,0);
    V_TMP_DES_DESPACHO_EXTERNO T_DES_DESPACHO_EXTERNO;
    
--USD_USUARIOS_DESPACHOS
    
    TYPE T_USD IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_USD IS TABLE OF T_USD;

    V_USD T_ARRAY_USD := T_ARRAY_USD(
									T_USD('(SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''PENDIENTE DE MIGRACION'')', '(SELECT DES_ID FROM '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO WHERE DES_DESPACHO = ''PENDIENTE DE MIGRACION'')', '0', '0'));
    V_USD_ID NUMBER(16,0);
    V_TMP_USD T_USD;

BEGIN

--USU_USUARIOS

    DBMS_OUTPUT.PUT_LINE('************** Comprobando si existe el registro en USU_USUARIOS **************');
    DBMS_OUTPUT.PUT_LINE('SELECT COUNT(*) FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''PENDIENTE DE MIGRACION''');
    V_MSQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''PENDIENTE DE MIGRACION'''; 
    EXECUTE IMMEDIATE V_MSQL INTO table_count;
	
  IF table_count = 0 THEN
    DBMS_OUTPUT.PUT_LINE('************** Insertando en USU_USUARIOS **************');
    FOR I IN V_USU_USUARIOS.FIRST .. V_USU_USUARIOS.LAST
    LOOP
      V_MSQL := 'SELECT '||V_ESQUEMA_M||'.S_USU_USUARIOS.NEXTVAL FROM DUAL';
      EXECUTE IMMEDIATE V_MSQL
      INTO V_USU_ID;
      V_TMP_USU_USUARIOS := V_USU_USUARIOS(I);     
      DBMS_OUTPUT.PUT_LINE('Insertando USU_USUARIOS: '||V_USU_ID||' USU_USERNAME = '|| V_TMP_USU_USUARIOS(2));
      V_MSQL := 'INSERT INTO '||V_ESQUEMA_M||'.USU_USUARIOS (USU_ID, ENTIDAD_ID, USU_USERNAME, USU_NOMBRE, USUARIOCREAR, FECHACREAR) 
      VALUES ('||V_USU_ID||','||V_TMP_USU_USUARIOS(1)||','''||V_TMP_USU_USUARIOS(2)||''','''||V_TMP_USU_USUARIOS(3)||''','''||V_USUARIO_CREAR||''', SYSDATE)';
      DBMS_OUTPUT.PUT_LINE(V_MSQL);
      EXECUTE IMMEDIATE V_MSQL;
END LOOP; --LOOP TIPO_ACTOR 
ELSE DBMS_OUTPUT.PUT_LINE('************** YA EXISTE EL REGISTRO EN USU_USUARIOS **************');
END IF;
COMMIT;
   V_TMP_USU_USUARIOS:= NULL;
   V_USU_USUARIOS:= NULL;
   table_count:= NULL;

--DES_DESPACHO_EXTERNO
    
    DBMS_OUTPUT.PUT_LINE('************** Comprobando si existe el registro en DES_DESPACHO_EXTERNO **************');
    DBMS_OUTPUT.PUT_LINE('SELECT COUNT(*) FROM '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO WHERE DES_DESPACHO = ''PENDIENTE DE MIGRACION''');
    V_MSQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO WHERE DES_DESPACHO = ''PENDIENTE DE MIGRACION'''; 
    EXECUTE IMMEDIATE V_MSQL INTO table_count;
	
  IF table_count = 0 THEN
    DBMS_OUTPUT.PUT_LINE('************** Insertando en DES_DESPACHO_EXTERNO **************');
    FOR I IN V_DES_DESPACHO_EXTERNO.FIRST .. V_DES_DESPACHO_EXTERNO.LAST
    LOOP
      V_MSQL := 'SELECT '||V_ESQUEMA||'.S_DES_DESPACHO_EXTERNO.NEXTVAL FROM DUAL';
      EXECUTE IMMEDIATE V_MSQL
      INTO V_DES_ID;
      V_TMP_DES_DESPACHO_EXTERNO := V_DES_DESPACHO_EXTERNO(I);     
      DBMS_OUTPUT.PUT_LINE('Insertando DES_DESPACHO_EXTERNO: '||V_DES_ID||' DES_DESPACHO = '|| V_TMP_DES_DESPACHO_EXTERNO(1));
      V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO (DES_ID, DES_DESPACHO, USUARIOCREAR, FECHACREAR) 
      VALUES ('||V_DES_ID||','||V_TMP_DES_DESPACHO_EXTERNO(1)||','''||V_USUARIO_CREAR||''', SYSDATE)';
      DBMS_OUTPUT.PUT_LINE(V_MSQL);
      EXECUTE IMMEDIATE V_MSQL;
END LOOP; --LOOP TIPO_ACTOR 
ELSE DBMS_OUTPUT.PUT_LINE('************** YA EXISTE EL REGISTRO EN DES_DESPACHO_EXTERNO **************');
END IF;
COMMIT;
   V_TMP_DES_DESPACHO_EXTERNO:= NULL;
   V_DES_DESPACHO_EXTERNO:= NULL;
   table_count:= NULL;

--USD_USUARIOS_DESPACHOS

    DBMS_OUTPUT.PUT_LINE('************** Comprobando si existe el registro en USD_USUARIOS_DESPACHOS  **************');
    DBMS_OUTPUT.PUT_LINE('SELECT COUNT(*) FROM '||V_ESQUEMA||'.USD_USUARIOS_DESPACHOS WHERE USU_ID = (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''PENDIENTE DE MIGRACION'') 
                          AND DES_ID = (SELECT DES_ID FROM '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO WHERE DES_DESPACHO = ''PENDIENTE DE MIGRACION'')');
    V_MSQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.USD_USUARIOS_DESPACHOS WHERE USU_ID = (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''PENDIENTE DE MIGRACION'') 
                          AND DES_ID = (SELECT DES_ID FROM '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO WHERE DES_DESPACHO = ''PENDIENTE DE MIGRACION'')'; 
    EXECUTE IMMEDIATE V_MSQL INTO table_count;
	
  IF table_count = 0 THEN
    DBMS_OUTPUT.PUT_LINE('************** Insertando en USD_USUARIOS_DESPACHOS **************');
    FOR I IN V_USD.FIRST .. V_USD.LAST
    LOOP
      V_MSQL := 'SELECT '||V_ESQUEMA||'.S_USD_USUARIOS_DESPACHOS.NEXTVAL FROM DUAL';
      EXECUTE IMMEDIATE V_MSQL 
      INTO V_USD_ID;
      V_TMP_USD := V_USD(I);     
      DBMS_OUTPUT.PUT_LINE('Insertando USUARIO DESPACHO: '|| V_USD_ID ||' USU_ID = '|| V_TMP_USD(1)||' DES_ID = '||V_TMP_USD(2));      
      V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.USD_USUARIOS_DESPACHOS (USD_ID, USU_ID, DES_ID, USD_GESTOR_DEFECTO, USD_SUPERVISOR, USUARIOCREAR, FECHACREAR) 
      VALUES ('||V_USD_ID||','||V_TMP_USD(1)||','||V_TMP_USD(2)||','''||V_TMP_USD(3)||''','''||V_TMP_USD(4)||''','''||V_USUARIO_CREAR||''', SYSDATE)';
      DBMS_OUTPUT.PUT_LINE(V_MSQL);
      EXECUTE IMMEDIATE V_MSQL;
END LOOP; --LOOP USD
ELSE DBMS_OUTPUT.PUT_LINE('************** YA EXISTE EL REGISTRO EN USD_USUARIOS_DESPACHOS **************');
END IF;
COMMIT;
   V_TMP_USD:= NULL;
   V_USD:= NULL;
   table_count:= NULL;
	
	
  EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.put_line('-----------------------------------------------------------');
      DBMS_OUTPUT.put_line(SQLERRM);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
