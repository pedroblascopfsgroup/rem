--/*
--#########################################
--## AUTOR=Sergio Giménez Mota
--## FECHA_CREACION=20190709
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.9.0
--## INCIDENCIA_LINK=NO
--## PRODUCTO=NO
--## 
--## Finalidad: Creación de tabla 'AUX_TDP_SDP'
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

V_MSQL VARCHAR2(32000 CHAR);
TABLE_COUNT NUMBER(1,0) := 0;
V_ESQUEMA VARCHAR2(20 CHAR) := '#ESQUEMA#';
V_ESQUEMA_M VARCHAR2(20 CHAR) := '#ESQUEMA_MASTER#';
V_TABLESPACE_IDX VARCHAR2(30 CHAR) := '#TABLESPACE_INDEX#';
V_TABLA VARCHAR2(40 CHAR) := 'AUX_TDP_SDP';

TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;

V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    T_TIPO_DATA(1, 1),
    T_TIPO_DATA(2, 2),
    T_TIPO_DATA(3, 3),
    T_TIPO_DATA(4, 4),
    T_TIPO_DATA(5, 5),
    T_TIPO_DATA(6, 6),
    T_TIPO_DATA(7, 7),
    T_TIPO_DATA(8, 21),
    T_TIPO_DATA(9, 22),
    T_TIPO_DATA(10, 23),
    T_TIPO_DATA(11, 24),
    T_TIPO_DATA(12, 25),
    T_TIPO_DATA(13, 26),
    T_TIPO_DATA(14, 41),
    T_TIPO_DATA(15, 42),
    T_TIPO_DATA(16, 43),
    T_TIPO_DATA(17, 44)
); 

V_TMP_TIPO_DATA T_TIPO_DATA;

BEGIN

SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE TABLE_NAME = ''||V_TABLA||'' AND OWNER= ''||V_ESQUEMA||'';

IF TABLE_COUNT > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] TABLA '||V_ESQUEMA||'.'||V_TABLA||' YA EXISTENTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'DROP TABLE '||V_ESQUEMA||'.'||V_TABLA||' CASCADE CONSTRAINTS';
    
END IF;

V_MSQL := '
CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||'
(
    DD_SDP_ID NUMBER(16,0),
    DD_TDP_ID NUMBER(16,0)
)';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO]: TABLA CREADA CORRECTAMENTE');

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.DD_SDP_ID IS ''Subtipo''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.DD_TDP_ID IS ''Tipo''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] COMENTARIOS CREADOS');

FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST

    LOOP
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);  
    
        V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (DD_SDP_ID, DD_TDP_ID) VALUES('''||TRIM(V_TMP_TIPO_DATA(1))||''', '''||TRIM(V_TMP_TIPO_DATA(2))||''')';

        EXECUTE IMMEDIATE V_MSQL;
        DBMS_OUTPUT.PUT_LINE('[INFO]: REGISTRO INSERTADO CORRECTAMENTE');
    
    END LOOP;

COMMIT;

EXCEPTION

WHEN OTHERS THEN
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------');
    DBMS_OUTPUT.put_line(SQLERRM);
    ROLLBACK;
    RAISE;

END;
/

EXIT;
