--/*
--#########################################
--## AUTOR=Sergio Giménez Mota
--## FECHA_CREACION=20190710
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-6638
--## PRODUCTO=NO
--## 
--## Finalidad: Creación de tabla 'DD_JCP_JUNTA_COMUNIDADES'
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

V_MSQL VARCHAR2(32000 CHAR);
TABLE_COUNT NUMBER(1,0) := 0;
V_ESQUEMA VARCHAR2(20 CHAR) := '#ESQUEMA#';
V_ESQUEMA_M VARCHAR2(20 CHAR) := '#ESQUEMA_MASTER#';
V_TABLA VARCHAR2(40 CHAR) := 'DD_JCP_JUNTA_COMUNIDADES';
V_NUM_TABLAS NUMBER(16);

TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    T_TIPO_DATA('01', 'Junta General Ordinaria', 'Junta General Ordinaria'),
    T_TIPO_DATA('02', 'Junta Extraordinaria', 'Junta Extraordinaria')
); 
V_TMP_TIPO_DATA T_TIPO_DATA;

BEGIN

SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE TABLE_NAME = ''||V_TABLA||'' AND OWNER= ''||V_ESQUEMA||'';

IF TABLE_COUNT > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] TABLA '||V_ESQUEMA||'.'||V_TABLA||' YA EXISTENTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO');
    EXECUTE IMMEDIATE 'DROP TABLE '||V_ESQUEMA||'.'||V_TABLA||' CASCADE CONSTRAINTS';
    
END IF;

V_MSQL := '
CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||'
(
    DD_JCP_ID                       NUMBER(16,0) NOT NULL,
    DD_JCP_CODIGO                   VARCHAR2(20 CHAR) NOT NULL,
    DD_JCP_DESCRIPCION              VARCHAR2(50 CHAR),
    DD_JCP_DESCRIPCION_LARGA        VARCHAR2(100),
    USUARIOCREAR    	            VARCHAR2(10),
    FECHACREAR          	        DATE NOT NULL,
    USUARIOMODIFICAR    	        VARCHAR2(10),
    FECHAMODIFICAR      	        DATE,	 
    VERSION                   	    NUMBER(38,0) DEFAULT 0 NOT NULL,
    USUARIOBORRAR             	    VARCHAR2(50),
    FECHABORRAR               	    DATE,
    BORRADO                  	    NUMBER(1, 0) DEFAULT 0 NOT NULL
)';

EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' CREADA');

V_MSQL := 'SELECT COUNT(1) FROM ALL_SEQUENCES WHERE SEQUENCE_NAME = ''S_'||V_TABLA||''' AND SEQUENCE_OWNER = '''||V_ESQUEMA||'''';
EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;

IF V_NUM_TABLAS = 0 THEN
        V_MSQL := 'CREATE SEQUENCE '||V_ESQUEMA||'.S_'||V_TABLA||'';		
	    EXECUTE IMMEDIATE V_MSQL;		
	    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.S_'||V_TABLA||' creada');
END IF;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT '||V_TABLA||'_PK PRIMARY KEY (DD_JCP_ID))';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||'_PK creada.');

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.DD_JCP_ID IS ''DD Junta comunidad de propietarios''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.DD_JCP_CODIGO IS ''DD junta comunidad de propietarios código''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.DD_JCP_DESCRIPCION IS ''DD Junta comunidad de propietarios descripcion''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.DD_JCP_DESCRIPCION_LARGA IS ''DD Junta comunidad de propietarios descripción larga''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO]: COMENTARIOS CREADOS');

DBMS_OUTPUT.PUT_LINE('[INFO]: INSERCION EN DD_JCP_JUNTA_COMUNIDADES');
    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
        LOOP
            V_TMP_TIPO_DATA := V_TIPO_DATA(I);  
        
            DBMS_OUTPUT.PUT_LINE('[INFO]: INSERTAMOS EL REGISTRO '''|| TRIM(V_TMP_TIPO_DATA(1)) ||'''');   
            V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (' ||
                        'DD_JCP_ID, DD_JCP_CODIGO, DD_JCP_DESCRIPCION, DD_JCP_DESCRIPCION_LARGA, VERSION, USUARIOCREAR, FECHACREAR, BORRADO) ' ||
                        'VALUES('||V_ESQUEMA||'.S_'||V_TABLA||'.NEXTVAL'||', '''||TRIM(V_TMP_TIPO_DATA(1))||''', '''||TRIM(V_TMP_TIPO_DATA(2))||''','''||TRIM(V_TMP_TIPO_DATA(3))||''', 0, ''HREOS-6638'', SYSDATE, 0)';
            EXECUTE IMMEDIATE V_MSQL;
            DBMS_OUTPUT.PUT_LINE('[INFO]: REGISTRO INSERTADO CORRECTAMENTE');
        END LOOP;

COMMIT;

EXCEPTION

WHEN OTHERS THEN
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------');
    DBMS_OUTPUT.put_line(SQLERRM);
    ROLLBACK;
    RAISE;

END;
/

EXIT;
