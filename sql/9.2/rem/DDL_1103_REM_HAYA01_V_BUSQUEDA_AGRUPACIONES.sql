--/*
--##########################################
--## AUTOR=BENJAMIN GUERRERO
--## FECHA_CREACION=20151222
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.1
--## INCIDENCIA_LINK=0
--## PRODUCTO=NO
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.    
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- N?mero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_MSQL VARCHAR2(4000 CHAR); 

    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_AGRUPACIONES' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_AGRUPACIONES';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_AGRUPACIONES' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_AGRUPACIONES';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES... borrada OK');
  END IF;

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES...');
  EXECUTE IMMEDIATE 'CREATE VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_AGRUPACIONES 
	AS

		SELECT 
		  	AGR.AGR_ID,
		  	AGR.DD_TAG_ID, 
		  	AGR.AGR_NUM_AGRUP_REM,
	        AGR.AGR_NOMBRE,
	        AGR.AGR_DESCRIPCION,
	        AGR.AGR_FECHA_ALTA,
	        AGR.AGR_FECHA_BAJA,
			AGR.AGR_PUBLICADO,
	        (SELECT COUNT(AGRACTIVO.ACT_ID) FROM ACT_AGA_AGRUPACION_ACTIVO AGRACTIVO WHERE AGRACTIVO.AGR_ID = AGR.AGR_ID AND AGR.BORRADO = 0) as activos,
			(SELECT COUNT(AGRACTIVO.ACT_ID) FROM ACT_AGA_AGRUPACION_ACTIVO AGRACTIVO WHERE AGRACTIVO.AGR_ID = AGR.AGR_ID and AGR.AGR_PUBLICADO = 1 AND AGR.BORRADO = 0)  as publicados,
			DECODE( OBR.DD_PRV_ID, '''', RES.DD_PRV_ID, OBR.DD_PRV_ID) provincia,
			DECODE( OBR.DD_LOC_ID, '''', RES.DD_LOC_ID, OBR.DD_LOC_ID) localidad,
			DECODE( OBR.ONV_DIRECCION, '''', RES.RES_DIRECCION, OBR.ONV_DIRECCION) direccion
  			
		FROM ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR
		LEFT JOIN ' || V_ESQUEMA || ' .ACT_ONV_OBRA_NUEVA OBR ON (AGR.AGR_ID=OBR.AGR_ID)
    	LEFT JOIN ' || V_ESQUEMA || ' .ACT_RES_RESTRINGIDA RES ON (AGR.AGR_ID=RES.AGR_ID)
		WHERE AGR.BORRADO = 0';

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES...Creada OK');
  
END;
/

EXIT;