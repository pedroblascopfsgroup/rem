--/*
--##########################################
--## AUTOR=Teresa Alonso
--## FECHA_CREACION=20170301
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-1573
--## PRODUCTO=NO
--## Finalidad: Interfaz Stock REM - UVEM
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLESPACE_IDX VARCHAR2(25 CHAR):= '#TABLESPACE_INDEX#'; -- Configuracion Tablespace de Indices
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.  
    V_NUM_SEQ NUMBER(16); -- Vble. para validar la existencia de una secuencia.  
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

    V_TEXT1 VARCHAR2(2400 CHAR); -- Vble. auxiliar 
    V_TEXT_TABLA VARCHAR2(2400 CHAR) := 'APR_AUX_ACT_FILTRO'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_COMMENT_TABLE VARCHAR2(500 CHAR):= 'Tabla auxiliar para almacenar la información de las tablas de activo procedente de BD REM.'; -- Vble. para los comentarios de las tablas

BEGIN
	
	DBMS_OUTPUT.PUT_LINE('********' ||V_TEXT_TABLA|| '********'); 
	DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TEXT_TABLA||'... Comprobaciones previas');

	-- Verificar si la tabla ya existe
	V_MSQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TEXT_TABLA||''' and owner = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;	
	IF V_NUM_TABLAS = 1 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] ' || V_ESQUEMA || '.'||V_TEXT_TABLA||'... Ya existe. Se borrará.');
		EXECUTE IMMEDIATE 'DROP TABLE '||V_ESQUEMA||'.'||V_TEXT_TABLA||' CASCADE CONSTRAINTS';
		
	END IF;

	-- Comprobamos si existe la secuencia
	V_SQL := 'SELECT COUNT(1) FROM ALL_SEQUENCES WHERE SEQUENCE_NAME = ''S_'||V_TEXT_TABLA||''' and SEQUENCE_OWNER = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS; 
	IF V_NUM_TABLAS = 1 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] '|| V_ESQUEMA ||'.S_'||V_TEXT_TABLA||'... Ya existe. Se borrará.');  
		EXECUTE IMMEDIATE 'DROP SEQUENCE '||V_ESQUEMA||'.S_'||V_TEXT_TABLA||'';
		
	END IF; 
	
	-- Creamos la tabla
	DBMS_OUTPUT.PUT_LINE('[INFO] ' ||V_ESQUEMA|| '.'||V_TEXT_TABLA||'...');
	V_MSQL := 'CREATE TABLE ' ||V_ESQUEMA||'.'||V_TEXT_TABLA||'
	(
		ACT_ID			NUMBER(16,0),
		NUMERO_ACTIVO		NUMBER(16,0), 
		ACT_NUM_ACTIVO_REM 	NUMBER(16,0),
		COACES			VARCHAR2(9 CHAR) NOT NULL, 

		COESVE			VARCHAR2(2 CHAR),
		BIACSI			VARCHAR2(1 CHAR),
		FERLL6			VARCHAR2(8 CHAR), 
		CORPRO			VARCHAR2(2 CHAR) ,
		IMVACT			VARCHAR2(15 CHAR) ,
		FEVACT			VARCHAR2(8 CHAR) ,
		OBRTOR			VARCHAR2(40 CHAR) ,

		BIACSU			VARCHAR2(1 CHAR),

		APRESH			VARCHAR2(1 CHAR),

		POPROP			VARCHAR2(6 CHAR) ,

		COGRAP			VARCHAR2(2 CHAR) ,

		COSPAT    		VARCHAR2(5 CHAR),

		FEFOAC			VARCHAR2(8 CHAR),
		FEREPO 			VARCHAR2(8 CHAR), 
		FESELA			VARCHAR2(8 CHAR),
		FERELA			VARCHAR2(8 CHAR),
		BINOCU			VARCHAR2(1 CHAR),
		FICOAR 			VARCHAR2(8 CHAR), 
		QCRSMR 			VARCHAR2(1 CHAR),
		QFRSMR 			VARCHAR2(8 CHAR),
		BIARRE 			VARCHAR2(1 CHAR),
		FFCOAR			VARCHAR2(8 CHAR),
		COSOCU			VARCHAR2(2 CHAR),
		NOARRE 			VARCHAR2(35 CHAR),
		COENOR			VARCHAR2(5 CHAR),
		IDCOEQ			VARCHAR2(5 CHAR),
		FEPHAC 			VARCHAR2(8 CHAR),
		FEPREG 			VARCHAR2(8 CHAR),
		FEINAU 			VARCHAR2(8 CHAR),
		FEENAG			VARCHAR2(8 CHAR),
		FEEAAU			VARCHAR2(8 CHAR),
		FESEPR			VARCHAR2(8 CHAR),
		FEADAC			VARCHAR2(8 CHAR),
		FETIFI			VARCHAR2(8 CHAR),
		IDAUTO			VARCHAR2(10 CHAR),	
		NOCURA			VARCHAR2(40 CHAR),
		FESEPO			VARCHAR2(8 CHAR),
		IMPADJ			VARCHAR2(15 CHAR)



	)
	LOGGING 
	NOCOMPRESS 
	NOCACHE
	NOPARALLEL
	NOMONITORING
	';
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] ' ||V_ESQUEMA||'.'||V_TEXT_TABLA||'... Tabla creada.');


	-- Creamos sequence
--	V_MSQL := 'CREATE SEQUENCE '||V_ESQUEMA||'.S_'||V_TEXT_TABLA||'';		
--	EXECUTE IMMEDIATE V_MSQL;		
--	DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.S_'||V_TEXT_TABLA||'... Secuencia creada');
	
	
	-- Creamos comentario	
	V_MSQL := 'COMMENT ON TABLE '||V_ESQUEMA||'.'||V_TEXT_TABLA||' IS '''||V_COMMENT_TABLE||'''';		
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] ' ||V_ESQUEMA||'.'||V_TEXT_TABLA||'... Comentario creado.');
	
	
	DBMS_OUTPUT.PUT_LINE('[INFO] ' ||V_ESQUEMA||'.'||V_TEXT_TABLA||'... OK');

        EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.ACT_ID IS ''Código identificador único del activo''';
        EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.NUMERO_ACTIVO IS ''Código identificador único del activo en HAYA''';
        EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.ACT_NUM_ACTIVO_REM IS ''Código identificador único del activo en REM''';
        EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.COACES IS ''Código identificador único del activo en UVEM''';

	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.COESVE IS ''COD_ESTADO_VENTA_ACTIVO 9(2)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.BIACSI IS ''LLAVES_NECESARIAS X(1)''';	
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FERLL6 IS ''FEC_RECEP_LLAVES 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.CORPRO IS ''REGIMEN_PROTECCION 9(2)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.IMVACT IS ''IMPORTE VENTA EXTERNA 9(13)V99''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FEVACT IS ''FECHA DE VENTA EXTERNA 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.OBRTOR IS ''TEXTO VENTA EXTERNA X(40)''';

	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.BIACSU IS ''INDICADOR_ACTIVO_COMERCIALIZAB X(1)''';

	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.APRESH IS ''INDICADOR_RESIDENCIA_HABITUAL X(1)''';

	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.POPROP IS ''PORCENTAJE_PROPIEDAD 9(3)V9(3)''';

	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.COGRAP IS ''GRADO_PROPIEDAD 9(2)''';

	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.COSPAT IS ''COD_SOC_PATRIMONIAL 9(5)''';

        EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FEFOAC IS ''FEC_FORMALIZACION 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FEREPO IS ''FECHA REALIZADA POSESION 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FESELA IS ''FEC_SENIALADO_LANZAMIENTO 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FERELA IS ''FEC_REALIZADO_LANZAMIENTO 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.BINOCU IS ''INDICADOR OCUPADO X(1)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FICOAR IS ''FEC_INICIO_CONTRATO 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.QCRSMR IS ''COD_RESOL_MORATORIA X(1)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.QFRSMR IS ''FEC_RESOLUCION_MORATORIA 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.BIARRE IS ''INMUEBLE_ARRENDADO X(1)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FFCOAR IS ''FECHA_FIN_CONTRATO 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.COSOCU IS ''INDICADOR OCUPADO X(1)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.NOARRE IS ''NOMBRE_ARRENDATARIO X(35)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.COENOR IS ''EMPRESA_ORIGEN_ACTIVO 9(5)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.IDCOEQ IS ''COD_SOC_PROPIETARIA_ANT 9(5)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FEPHAC IS ''FEC_PRESENTACION_HACIENDA 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FEPREG IS ''FEC_PRESENTACION_REGISTRO 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FEINAU IS ''FEC_INSCRIPCION_TITULO 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FEENAG IS ''FEC_ENTREGA_TITULO_GESTOR 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FEEAAU IS ''FEC_ENVIO_AUTO_ADICCION 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FESEPR IS ''FEC_SEGUNDA_PRESEN_REG 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FEADAC IS ''FEC_ADJUDICACION  9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FETIFI IS ''FEC_TITULO_FIRME  9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.IDAUTO IS ''NUM_AUTOS_JUZGADO X(10)''';	
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.NOCURA IS ''NOMBRE_PROCURADOR X(40)''';	
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.FESEPO IS ''FEC_SENIALADA_POSESION 9(8)''';
	EXECUTE IMMEDIATE 'COMMENT ON COLUMN '||V_TEXT_TABLA||'.IMPADJ IS ''IMPORTE DE ADJUDICACIÓN 9(13)V99''';


COMMIT;



EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.PUT_LINE('KO no modificada');
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;

/

EXIT;
