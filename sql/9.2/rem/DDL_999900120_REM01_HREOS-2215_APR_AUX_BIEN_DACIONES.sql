--/*
--#########################################
--## AUTOR=MARÍA VILLANUEVA
--## FECHA_CREACION=20170609
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-2215
--## PRODUCTO=NO
--## 
--## Finalidad: Creación de tabla desnormalizada para la carga de bienes de dación y todas sus auxiliares
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

	V_MSQL VARCHAR2(32000 CHAR); 
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; 
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';
	V_SQL VARCHAR2(4000 CHAR);
	V_NUM NUMBER(16);
	ERR_NUM NUMBER(25);  
	ERR_MSG VARCHAR2(1024 CHAR); 

	


BEGIN	

	DBMS_OUTPUT.PUT_LINE('[INFO] INICIO DEL PROCESO.');
	
	V_MSQL := '
	SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''APR_AUX_BIEN_DACIONES'' AND OWNER = '''||V_ESQUEMA||'''
	'
	;
	EXECUTE IMMEDIATE V_MSQL INTO V_NUM;
	
	IF V_NUM != 0 THEN
	
		DBMS_OUTPUT.PUT_LINE('[INFO] LA TABLA APR_AUX_BIEN_DACIONES YA EXISTE.');
		
		
		
	ELSE
	
		DBMS_OUTPUT.PUT_LINE('[INFO] LA TABLA APR_AUX_BIEN_DACIONES NO EXISTE. SE CREARÁ.');
		
	

	EXECUTE IMMEDIATE '
	CREATE TABLE APR_AUX_BIEN_DACIONES (
	BIE_ID NUMBER(16,0) NOT NULL ENABLE, 
	DTYPE VARCHAR2(20 CHAR) NOT NULL ENABLE, 
	DD_SPO_ID NUMBER(16,0), 
	BIE_VIVIENDA_HABITUAL NUMBER(1,0), 
	BIE_NUMERO_ACTIVO VARCHAR2(50 BYTE), 
	BIE_LICENCIA_PRI_OCUPACION VARCHAR2(50 BYTE), 
	BIE_PRIMERA_TRANSMISION VARCHAR2(50 BYTE), 
	BIE_CONTRATO_ALQUILER VARCHAR2(150 BYTE), 
	BIE_OBRA_EN_CURSO NUMBER(1,0), 
	BIE_TIPO_SUBASTA NUMBER(16,2), 
	BIE_CODIGO_EXTERNO VARCHAR2(20 BYTE), 
	DD_TRI_ID NUMBER(16,0), 
	BIE_FECHA_DUE_D TIMESTAMP (6), 
	BIE_FECHA_SOLICITUD_DUE_D TIMESTAMP (6), 
	BIE_USO_PROMOTOR_MAYOR2 VARCHAR2(50 BYTE), 
	BIE_TRANSMITENTE_PROMOTOR VARCHAR2(50 BYTE), 
	BIE_ARRENDADO_SIN_OPC_COMPRA VARCHAR2(50 BYTE), 
	BIE_DUE_DILLIGENCE NUMBER(1,0), 
	BIE_PORCT_IMP_COMPRA NUMBER(5,2), 
	DD_QCI_ID NUMBER(16,0), 
	DD_TRIV_ID NUMBER(16,0), 
	DD_TPI_ID NUMBER(16,0), 
	DD_TPIV_ID NUMBER(16,0), 
	DD_IPR_ID NUMBER(16,0), 
	BIE_CODIGO_BIEN VARCHAR2(50 CHAR), 
	BIE_ENTIDAD_ID VARCHAR2(20 CHAR), 
	BIE_DREG_NUM_FINCA VARCHAR2(50 BYTE), 
	BIE_LOC_NOMBRE_VIA VARCHAR2(100 CHAR), 
	BIE_LOC_NUMERO_DOMICILIO VARCHAR2(100 CHAR), 
	BIE_LOC_PORTAL VARCHAR2(10 CHAR), 
	BIE_LOC_BLOQUE VARCHAR2(10 CHAR), 
	BIE_LOC_ESCALERA VARCHAR2(10 CHAR), 
	BIE_LOC_PISO VARCHAR2(10 CHAR), 
	BIE_LOC_PUERTA VARCHAR2(10 CHAR), 
	BIE_LOC_BARRIO VARCHAR2(100 CHAR), 
	BIE_LOC_MUNICIPIO VARCHAR2(100 CHAR), 
	BIE_LOC_PROVINCIA VARCHAR2(2 CHAR), 
	DD_LOC_ID NUMBER(16,0), 
	DD_UPO_ID NUMBER(16,0), 
	DD_TVI_ID NUMBER(16,0), 
	DD_CIC_ID NUMBER(16,0), 
	BIE_CAR_ID NUMBER(16,0), 
	DD_TPC_ID NUMBER(16,0), 
	BIE_CAR_LETRA VARCHAR2(50 CHAR), 
	BIE_CAR_TITULAR VARCHAR2(50 CHAR), 
	BIE_CAR_IMPORTE_REGISTRAL NUMBER(16,2), 
	BIE_CAR_IMPORTE_ECONOMICO NUMBER(16,2), 
	BIE_CAR_REGISTRAL NUMBER(1,0), 
	DD_SIC_ID NUMBER(16,0), 
	BIE_CAR_FECHA_PRESENTACION DATE, 
	BIE_CAR_FECHA_INSCRIPCION DATE, 
	BIE_CAR_FECHA_CANCELACION DATE, 
	BIE_CAR_ECONOMICA NUMBER(1,0), 
	DD_SIC_ID2 NUMBER(16,0), 
	BIE_VAL_ID NUMBER(16,0), 
	BIE_RESPUESTA_CONSULTA VARCHAR2(250 BYTE), 
	BIE_VALOR_TASACION_EXT NUMBER(16,2), 
	BIE_F_TAS_EXTERNA DATE, 
	DD_TRA_ID NUMBER(16,0), 
	BIE_F_SOL_TASACION DATE, 
	BIE_CD_NUITA NUMBER(20,0), 
	BIE_ADI_ID NUMBER(16,0), 
	BIE_ADI_NOM_EMPRESA VARCHAR2(150 CHAR), 
	BIE_ADI_CIF_EMPRESA VARCHAR2(20 CHAR), 
	BIE_ADI_COD_IAE VARCHAR2(50 CHAR), 
	BIE_ADI_DES_IAE VARCHAR2(150 CHAR), 
	DD_TPB_ID NUMBER(16,0), 
	DD_TPN_ID NUMBER(16,0), 
	BIE_ADI_VALORACION NUMBER(16,2), 
	BIE_ADI_ENTIDAD VARCHAR2(150 CHAR), 
	BIE_ADI_NUM_CUENTA VARCHAR2(150 CHAR), 
	BIE_ADI_MATRICULA VARCHAR2(50 CHAR), 
	BIE_ADI_BASTIDOR VARCHAR2(50 CHAR), 
	BIE_ADI_MODELO VARCHAR2(50 CHAR), 
	BIE_ADI_MARCA VARCHAR2(50 CHAR), 
	BIE_ADI_FECHAMATRICULA TIMESTAMP (6), 
	BIE_ADI_FFIN_REV_CARGA DATE, 
	BIE_ADI_SIN_CARGA NUMBER(1,0), 
	BIE_ADI_OBS_CARGA VARCHAR2(250 CHAR), 
	BIE_ADI_DEUDA_SEGUN_JUZ NUMBER(16,2), 
	BIE_ADI_CAN_CARGAS_RESUMEN VARCHAR2(500 CHAR), 
	BIE_ADI_CAN_CARGAS_PROPUESTA VARCHAR2(500 CHAR), 
	DD_TBI_ID NUMBER(16,0), 
	BIE_PARTICIPACION NUMBER(3,0), 
	BIE_VALOR_ACTUAL NUMBER(16,2), 
	BIE_IMPORTE_CARGAS NUMBER(16,2), 
	BIE_SUPERFICIE NUMBER(16,2), 
	BIE_POBLACION VARCHAR2(50 CHAR), 
	BIE_DATOS_REGISTRALES VARCHAR2(50 CHAR), 
	BIE_REFERENCIA_CATASTRAL VARCHAR2(50 CHAR), 
	BIE_DESCRIPCION VARCHAR2(250 CHAR), 
	BIE_FECHA_VERIFICACION DATE, 
	DD_ORIGEN_ID NUMBER(16,0), 
	BIE_MARCA_EXTERNOS NUMBER(1,0), 
	DD_TPO_CARGA_ID NUMBER(16,0), 
	BIE_CODIGO_INTERNO NUMBER(16,0), 
	BIE_SOLVENCIA_NO_ENCONTRADA NUMBER(1,0), 
	BIE_OBSERVACIONES VARCHAR2(2000 CHAR), 
	BIE_LOC_ID NUMBER(16,0), 
	BIE_LOC_POBLACION VARCHAR2(250 CHAR), 
	BIE_LOC_DIRECCION VARCHAR2(250 CHAR), 
	BIE_LOC_COD_POST VARCHAR2(250 CHAR), 
	DD_PRV_ID NUMBER(16,0), 
	BIE_DREG_ID NUMBER(16,0), 
	BIE_DREG_REFERENCIA_CATASTRAL VARCHAR2(50 CHAR), 
	BIE_DREG_SUPERFICIE NUMBER(16,2), 
	BIE_DREG_SUPERFICIE_CONSTRUIDA NUMBER(16,2), 
	BIE_DREG_TOMO VARCHAR2(50 CHAR), 
	BIE_DREG_LIBRO VARCHAR2(50 CHAR), 
	BIE_DREG_FOLIO VARCHAR2(50 CHAR), 
	BIE_DREG_INSCRIPCION VARCHAR2(50 CHAR), 
	BIE_DREG_FECHA_INSCRIPCION TIMESTAMP (6), 
	BIE_DREG_NUM_REGISTRO VARCHAR2(50 CHAR), 
	BIE_DREG_MUNICIPIO_LIBRO VARCHAR2(50 CHAR), 
	BIE_DREG_CODIGO_REGISTRO VARCHAR2(50 CHAR), 
	BIE_FECHA_VALOR_SUBJETIVO TIMESTAMP (6), 
	BIE_IMPORTE_VALOR_SUBJETIVO NUMBER(16,2), 
	BIE_FECHA_VALOR_APRECIACION TIMESTAMP (6), 
	BIE_IMPORTE_VALOR_APRECIACION NUMBER(16,2), 
	BIE_FECHA_VALOR_TASACION TIMESTAMP (6), 
	BIE_IMPORTE_VALOR_TASACION NUMBER(16,2), 
	FECHA_TITULO DATE, 
	TRAMITADOR_TITULO VARCHAR2(250 CHAR), 
	FECHA_FIRMA_TITULO DATE, 
	VALOR_ADQUISICION NUMBER(16,2), 
	NUM_REFERENCIA VARCHAR2(50 CHAR), 
	VERSION NUMBER(38,0) NOT NULL ENABLE, 
	USUARIOCREAR CHAR(10 BYTE), 
	FECHACREAR TIMESTAMP (6) NOT NULL ENABLE, 
	USUARIOMODIFICAR VARCHAR2(50 CHAR), 
	FECHAMODIFICAR TIMESTAMP (6), 
	USUARIOBORRAR VARCHAR2(50 CHAR), 
	FECHABORRAR TIMESTAMP (6), 
	BORRADO NUMBER(1,0) NOT NULL ENABLE,
	BIE_REFERENCIA_MUEBLE VARCHAR2(50 CHAR)
		)
	'
	;

	DBMS_OUTPUT.PUT_LINE('[INFO] LA TABLA APR_AUX_BIEN_DACIONES CREADA.');
  COMMIT;
  END IF;
  
  DBMS_OUTPUT.PUT_LINE('[INFO] PROCESO FINALIZADO.');

         
EXCEPTION

   WHEN OTHERS THEN
   
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;
/
EXIT
