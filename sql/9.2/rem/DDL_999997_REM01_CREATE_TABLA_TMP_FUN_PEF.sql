--/*
--######################################### 
--## AUTOR=Vicente Martinez Cifre
--## FECHA_CREACION=20181106
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-4476
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##      
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE

  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; 	-- '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';	-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para almacenar la sentencia.    
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.

  V_TABLA_TMP VARCHAR2(30 CHAR) := 'TMP_FUN_PEF';  -- Tabla objetivo

BEGIN

    DBMS_OUTPUT.PUT_LINE('[INICIO]');

--    ######################################
--    ########   CREACION TABLA    #########
--    ######################################

    DBMS_OUTPUT.PUT_LINE('  [INFO] '||V_ESQUEMA||'.'||V_TABLA_TMP||'... COMPROBACIONES PREVIAS');   

    -- Verificar si la tabla ya existe
    V_SQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA_TMP||''' AND OWNER = '''||V_ESQUEMA||'''';
    EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS; 
    IF V_NUM_TABLAS = 1 THEN
      DBMS_OUTPUT.PUT_LINE('  [INFO] ' ||V_ESQUEMA|| '.'||V_TABLA_TMP||'... YA EXISTE. SE BORRARÁ.');
      EXECUTE IMMEDIATE 'DROP TABLE '||V_ESQUEMA||'.'||V_TABLA_TMP||' CASCADE CONSTRAINTS';    
    END IF;

    -- Creamos la tabla
    DBMS_OUTPUT.PUT_LINE('  [INFO] CREANDO ' ||V_ESQUEMA|| '.'||V_TABLA_TMP||'...');

    EXECUTE IMMEDIATE  '
      CREATE TABLE ' ||V_ESQUEMA||'.'||V_TABLA_TMP||'
      (
		  FUNCION VARCHAR2(128 CHAR) 
			, HAYAGESTADM VARCHAR(1 CHAR)
			,HAYASUPADM VARCHAR(1 CHAR)
			,HAYAGESACT VARCHAR(1 CHAR)
			,HAYASUPACT VARCHAR(1 CHAR)
			,HAYACAL VARCHAR(1 CHAR)
			,HAYASUPCAL VARCHAR(1 CHAR)
			,HAYAGESTPREC VARCHAR(1 CHAR)
			,HAYASUPPREC VARCHAR(1 CHAR)
			,HAYAGESTPUBL VARCHAR(1 CHAR)
			,HAYASUPPUBL VARCHAR(1 CHAR)
			,HAYAFSV VARCHAR(1 CHAR)
			,HAYAGBOINM VARCHAR(1 CHAR)
			,HAYASBOINM VARCHAR(1 CHAR)
			,HAYAGBOFIN VARCHAR(1 CHAR)
			,HAYASBOFIN VARCHAR(1 CHAR)
			,HAYAGESTCOMRET VARCHAR(1 CHAR)
			,HAYASUPCOMRET VARCHAR(1 CHAR)
			,HAYAGESTCOMSIN VARCHAR(1 CHAR)
			,HAYASUPCOMSIN VARCHAR(1 CHAR)
			,HAYAGESTFORM VARCHAR(1 CHAR)
			,HAYASUPFORM VARCHAR(1 CHAR)
			,HAYAADM VARCHAR(1 CHAR)
			,HAYASADM VARCHAR(1 CHAR)
			,HAYALLA VARCHAR(1 CHAR)
			,HAYASLLA VARCHAR(1 CHAR)
			,PERFGCCBANKIA VARCHAR(1 CHAR)
			,PERFGCCLIBERBANK VARCHAR(1 CHAR)
			,GESTOADM VARCHAR(1 CHAR)
			,GESTIAFORM VARCHAR(1 CHAR)
			,HAYAGESTADMT VARCHAR(1 CHAR)
			,GESTOCED VARCHAR(1 CHAR)
			,GESTOPLUS VARCHAR(1 CHAR)
			,GESTOPDV VARCHAR(1 CHAR)
			,HAYAPROV VARCHAR(1 CHAR)
			,HAYACERTI VARCHAR(1 CHAR)
			,HAYACONSU VARCHAR(1 CHAR)
			,HAYASUPER VARCHAR(1 CHAR)
			,HAYAGESTCOM VARCHAR(1 CHAR)
			,HAYASUPCOM VARCHAR(1 CHAR)
      		,HAYAGOLDTREE VARCHAR(1 CHAR)
			,FVDNEGOCIO VARCHAR(1 CHAR)
			,FVDBACKOFERTA VARCHAR(1 CHAR)
			,FVDBACKVENTA VARCHAR(1 CHAR)
			,SUPFVD VARCHAR(1 CHAR)
			,GESRES VARCHAR(1 CHAR)
			,SUPRES VARCHAR(1 CHAR)
			,GESMIN VARCHAR(1 CHAR)
			,SUPMIN VARCHAR(1 CHAR)
			,GESPROV VARCHAR(1 CHAR)
			,GESTSUE VARCHAR(1 CHAR)
			,GESTEDI VARCHAR(1 CHAR)
			,VALORACIONES VARCHAR(1 CHAR)
			,PMSVVC VARCHAR(1 CHAR)
			,FTI VARCHAR(1 CHAR)
	      ,HAYAGESTFORMADM VARCHAR(1 CHAR)
		  ,APROBCERB VARCHAR(1 CHAR)
	      ,SUPERFORM VARCHAR(1 CHAR)
	      ,SUPERGESTACT VARCHAR(1 CHAR)
	      ,SUPERADMIN VARCHAR(1 CHAR)
	      ,SUPERPUBLI VARCHAR(1 CHAR)
	      ,SUPERMIDDLE VARCHAR(1 CHAR)
	      ,SUPERFRONT VARCHAR(1 CHAR)
	      ,SUPERPLANIF VARCHAR(1 CHAR)
      )
      LOGGING 
      NOCOMPRESS 
      NOCACHE
      NOPARALLEL
      NOMONITORING
    '
    ;

    DBMS_OUTPUT.PUT_LINE('  [INFO] ' ||V_ESQUEMA||'.'||V_TABLA_TMP||'... TABLA CREADA.');

    DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------');
    DBMS_OUTPUT.put_line(SQLERRM);
    ROLLBACK;
    RAISE;

END;

/

EXIT