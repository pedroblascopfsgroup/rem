-/*
--######################################### 
--## AUTOR=Sergio GImenez
--## FECHA_CREACION=20190718
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-6639
--## PRODUCTO=NO
--## 
--## Finalidad: Creación de tablas de tablas auxiliares de aprovisionamiento para fichero de gestorias NOMGESTORIA_GASTOS_GR_YYYYMMDD.dat
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

V_MSQL VARCHAR2(32000 CHAR);
TABLE_COUNT NUMBER(1,0) := 0;
V_ESQUEMA VARCHAR2(20 CHAR) := '#ESQUEMA#';
V_ESQUEMA_M VARCHAR2(20 CHAR) := '#ESQUEMA_MASTER#';
V_TABLA VARCHAR2(40 CHAR) := '';
V_COLUMN VARCHAR2(100 CHAR) := '';
V_COLUMN_EXISTS NUMBER := 0;  
V_IS_NULLABLE NUMBER := 0; 

BEGIN

/****************************** APR_AUX_GES_GASTOS_GR ******************************/
V_TABLA := 'APR_AUX_GES_GASTOS_GR';

/***** FECHA_REC_PROP *****/
V_COLUMN := 'FECHA_REC_PROP';

SELECT COUNT(*) INTO V_COLUMN_EXISTS FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = V_TABLA AND COLUMN_NAME = V_COLUMN AND OWNER = V_ESQUEMA;

IF V_COLUMN_EXISTS > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] LA COLUMNA YA EXISTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' DROP COLUMN '||V_COLUMN||'';
END IF;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD '||V_COLUMN||' DATE';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' columna añadida');

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.'||V_COLUMN||' IS ''Fecha recepción del gasto por parte de la propiedad.''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' comentario añadido');

COMMIT;

/***** FECHA_REC_GEST *****/
V_COLUMN := 'FECHA_REC_GEST';

SELECT COUNT(*) INTO V_COLUMN_EXISTS FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = V_TABLA AND COLUMN_NAME = V_COLUMN AND OWNER = V_ESQUEMA;

IF V_COLUMN_EXISTS > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] LA COLUMNA YA EXISTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' DROP COLUMN '||V_COLUMN||'';
END IF;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD '||V_COLUMN||' DATE';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' columna añadida');

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.'||V_COLUMN||' IS ''Fecha recepción del gasto por parte de la gestoría/proveedor.''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' comentario añadido');

COMMIT;

/***** FECHA_REC_HAYA *****/
V_COLUMN := 'FECHA_REC_HAYA';

SELECT COUNT(*) INTO V_COLUMN_EXISTS FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = V_TABLA AND COLUMN_NAME = V_COLUMN AND OWNER = V_ESQUEMA;

IF V_COLUMN_EXISTS > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] LA COLUMNA YA EXISTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' DROP COLUMN '||V_COLUMN||'';
END IF;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD '||V_COLUMN||' DATE';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' columna añadida');

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.'||V_COLUMN||' IS ''Fecha recepción del gasto por parte de Haya.''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' comentario añadido');

COMMIT;

/****************************** APR_AUX_GES_GASTOS_GR_REJ ******************************/
V_TABLA := 'APR_AUX_GES_GASTOS_GR_REJ';

/***** FECHA_REC_PROP *****/
V_COLUMN := 'FECHA_REC_PROP';

SELECT COUNT(*) INTO V_COLUMN_EXISTS FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = V_TABLA AND COLUMN_NAME = V_COLUMN AND OWNER = V_ESQUEMA;

IF V_COLUMN_EXISTS > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] LA COLUMNA YA EXISTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' DROP COLUMN '||V_COLUMN||'';
END IF;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD '||V_COLUMN||' DATE';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' columna añadida');

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.'||V_COLUMN||' IS ''Fecha recepción del gasto por parte de la propiedad.''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' comentario añadido');

COMMIT;

/***** FECHA_REC_GEST *****/
V_COLUMN := 'FECHA_REC_GEST';

SELECT COUNT(*) INTO V_COLUMN_EXISTS FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = V_TABLA AND COLUMN_NAME = V_COLUMN AND OWNER = V_ESQUEMA;

IF V_COLUMN_EXISTS > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] LA COLUMNA YA EXISTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' DROP COLUMN '||V_COLUMN||'';
END IF;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD '||V_COLUMN||' DATE';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' columna añadida');

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.'||V_COLUMN||' IS ''Fecha recepción del gasto por parte de la gestoría/proveedor.''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' comentario añadido');

COMMIT;

/***** FECHA_REC_HAYA *****/
V_COLUMN := 'FECHA_REC_HAYA';

SELECT COUNT(*) INTO V_COLUMN_EXISTS FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = V_TABLA AND COLUMN_NAME = V_COLUMN AND OWNER = V_ESQUEMA;

IF V_COLUMN_EXISTS > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] LA COLUMNA YA EXISTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' DROP COLUMN '||V_COLUMN||'';
END IF;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD '||V_COLUMN||' DATE';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' columna añadida');

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.'||V_COLUMN||' IS ''Fecha recepción del gasto por parte de Haya.''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' comentario añadido');

COMMIT;

/****************************** H_GGR_GES_GASTOS_RECH ******************************/
V_TABLA := 'H_GGR_GES_GASTOS_RECH';

/***** FECHA_REC_PROP *****/
V_COLUMN := 'FECHA_REC_PROP';

SELECT COUNT(*) INTO V_COLUMN_EXISTS FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = V_TABLA AND COLUMN_NAME = V_COLUMN AND OWNER = V_ESQUEMA;

IF V_COLUMN_EXISTS > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] LA COLUMNA YA EXISTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' DROP COLUMN '||V_COLUMN||'';
END IF;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD '||V_COLUMN||' VARCHAR2(50)';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' columna añadida');

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.'||V_COLUMN||' IS ''Fecha recepción del gasto por parte de la propiedad.''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' comentario añadido');

COMMIT;

/***** FECHA_REC_GEST *****/
V_COLUMN := 'FECHA_REC_GEST';

SELECT COUNT(*) INTO V_COLUMN_EXISTS FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = V_TABLA AND COLUMN_NAME = V_COLUMN AND OWNER = V_ESQUEMA;

IF V_COLUMN_EXISTS > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] LA COLUMNA YA EXISTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' DROP COLUMN '||V_COLUMN||'';
END IF;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD '||V_COLUMN||' VARCHAR2(50)';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' columna añadida');

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.'||V_COLUMN||' IS ''Fecha recepción del gasto por parte de la gestoría/proveedor.''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' comentario añadido');

COMMIT;

/***** FECHA_REC_HAYA *****/
V_COLUMN := 'FECHA_REC_HAYA';

SELECT COUNT(*) INTO V_COLUMN_EXISTS FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = V_TABLA AND COLUMN_NAME = V_COLUMN AND OWNER = V_ESQUEMA;

IF V_COLUMN_EXISTS > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] LA COLUMNA YA EXISTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' DROP COLUMN '||V_COLUMN||'';
END IF;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD '||V_COLUMN||' VARCHAR2(50)';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' columna añadida');

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.'||V_COLUMN||' IS ''Fecha recepción del gasto por parte de Haya.''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' comentario añadido');

COMMIT;

EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/

EXIT;

