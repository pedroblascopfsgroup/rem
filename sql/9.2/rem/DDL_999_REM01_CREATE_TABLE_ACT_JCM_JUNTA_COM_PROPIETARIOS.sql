--/*
--#########################################
--## AUTOR=Sergio Giménez Mota
--## FECHA_CREACION=20190711
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-6638
--## PRODUCTO=NO
--## 
--## Finalidad: Creación de tabla 'ACT_JCM_JUNTA_COM_PROPIETARIOS'
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

V_MSQL VARCHAR2(32000 CHAR);
TABLE_COUNT NUMBER(1,0) := 0;
V_ESQUEMA VARCHAR2(20 CHAR) := '#ESQUEMA#';
V_ESQUEMA_M VARCHAR2(20 CHAR) := '#ESQUEMA_MASTER#';
V_TABLA VARCHAR2(40 CHAR) := 'ACT_JCM_JUNTA_COM_PROPIETARIOS';
V_NUM_TABLAS NUMBER(16);

BEGIN

SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE TABLE_NAME = ''||V_TABLA||'' AND OWNER= ''||V_ESQUEMA||'';

IF TABLE_COUNT > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] TABLA '||V_ESQUEMA||'.'||V_TABLA||' YA EXISTENTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'DROP TABLE '||V_ESQUEMA||'.'||V_TABLA||' CASCADE CONSTRAINTS';
    
END IF;

V_MSQL := '
CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||'
(
    JCM_ID                          NUMBER(16,0) NOT NULL,
    ACT_ID                          NUMBER(16,0) NOT NULL,
    JCM_COMUNIDAD                   NUMBER(16,0) NOT NULL,
    DD_JCP_ID                       NUMBER(16, 0) NOT NULL,
    JCM_FECHA_JUNTA                 DATE NOT NULL,
    JCM_PORCENTAJE_PARTICIPACION    NUMBER(5, 2),
    JCM_PROMOCION_MAYOR_50          NUMBER(16, 0),
    JCM_PROMOCION_ENTRE_20_50       NUMBER(16, 0),
    JCM_ACT_JUDIC_CON_PROMOCION     NUMBER(16, 0),
    JCM_DERRAMA_MAYOR_5000          NUMBER(16, 0),
    JCM_MODIFICACIONES_ESTATUTOS    NUMBER(16, 0),
    JCM_ITE                         NUMBER(16, 0),
    JCM_ACTUACIONES_CONTRA_MOROSOS  NUMBER(16, 0),
    JCM_MODIFICA_CUOTA              NUMBER(16, 0),
    JCM_OTROS                       VARCHAR2(100 CHAR),
    JCM_IMPORTE                     NUMBER(16, 2),
    JCM_CUOTA_ORDINARIA             NUMBER(16, 2),
    JCM_CUOTA_EXTRA                 NUMBER(16, 2),
    JCM_SUMINISTROS                 NUMBER(16, 2),
    JCM_PROPUESTA                   VARCHAR2(100 CHAR),
    JCM_GUION_DE_VOTO               VARCHAR2(100 CHAR),
    JCM_INDICACIONES                VARCHAR2(100 CHAR),
    USUARIOCREAR    	            VARCHAR2(10),
    FECHACREAR          	        DATE NOT NULL,
    USUARIOMODIFICAR    	        VARCHAR2(10),
    FECHAMODIFICAR      	        DATE,	 
    VERSION                   	    NUMBER(38,0) DEFAULT 0 NOT NULL,
    USUARIOBORRAR             	    VARCHAR2(50),
    FECHABORRAR               	    DATE,
    BORRADO                  	    NUMBER(1, 0) DEFAULT 0 NOT NULL
)';

EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' CREADA');

V_MSQL := 'SELECT COUNT(1) FROM ALL_SEQUENCES WHERE SEQUENCE_NAME = ''S_'||V_TABLA||''' AND SEQUENCE_OWNER = '''||V_ESQUEMA||'''';
EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;

IF V_NUM_TABLAS = 0 THEN
    V_MSQL := 'CREATE SEQUENCE '||V_ESQUEMA||'.S_'||V_TABLA||'';		
    EXECUTE IMMEDIATE V_MSQL;		
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.S_'||V_TABLA||'... Secuencia creada');
END IF;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT '||V_TABLA||'_PK PRIMARY KEY (JCM_ID))';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||'_PK creada.');

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT FK_JCM_ACT_ID FOREIGN KEY (ACT_ID) REFERENCES '||V_ESQUEMA||'.ACT_ACTIVO (ACT_ID))';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] FK_JCM_ACT_ID creada.');

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT FK_JCM_DD_JCP_ID FOREIGN KEY (DD_JCP_ID) REFERENCES '||V_ESQUEMA||'.DD_JCP_JUNTA_COMUNIDADES (DD_JCP_ID))';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] FK_JCM_DD_JCP_ID creada.');

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT FK_JCM_COMUNIDAD FOREIGN KEY (JCM_COMUNIDAD) REFERENCES '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR (PVE_ID))';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] FK_JCM_PVE_ID creada.');

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT FK_JCM_PROMOCION_MAYOR_50 FOREIGN KEY (JCM_PROMOCION_MAYOR_50) REFERENCES '||V_ESQUEMA_M||'.DD_SIN_SINO (DD_SIN_ID))';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT FK_JCM_PROMOCION_ENTRE_20_50 FOREIGN KEY (JCM_PROMOCION_ENTRE_20_50) REFERENCES '||V_ESQUEMA_M||'.DD_SIN_SINO (DD_SIN_ID))';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT FK_JCM_ACT_JUDIC_CON_PROMOCION FOREIGN KEY (JCM_ACT_JUDIC_CON_PROMOCION) REFERENCES '||V_ESQUEMA_M||'.DD_SIN_SINO (DD_SIN_ID))';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT FK_JCM_DERRAMA_MAYOR_5000 FOREIGN KEY (JCM_DERRAMA_MAYOR_5000) REFERENCES '||V_ESQUEMA_M||'.DD_SIN_SINO (DD_SIN_ID))';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT FK_JCM_MODIFICACIONES_ESTATUTOS FOREIGN KEY (JCM_MODIFICACIONES_ESTATUTOS) REFERENCES '||V_ESQUEMA_M||'.DD_SIN_SINO (DD_SIN_ID))';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT FK_JCM_ITE FOREIGN KEY (JCM_ITE) REFERENCES '||V_ESQUEMA_M||'.DD_SIN_SINO (DD_SIN_ID))';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT FK_JCM_ACTUACIONES_CONTRA_MOROSOS FOREIGN KEY (JCM_ACTUACIONES_CONTRA_MOROSOS) REFERENCES '||V_ESQUEMA_M||'.DD_SIN_SINO (DD_SIN_ID))';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT FK_JCM_MODIFICA_CUOTA FOREIGN KEY (JCM_MODIFICA_CUOTA) REFERENCES '||V_ESQUEMA_M||'.DD_SIN_SINO (DD_SIN_ID))';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_ID IS ''Junta comunidad de propietarios''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.ACT_ID IS ''Activo''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.DD_JCP_ID IS ''DD junta comunidad de propietarios''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_FECHA_JUNTA IS ''Fecha de la junta''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_COMUNIDAD IS ''Comunidad''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_PORCENTAJE_PARTICIPACION IS ''Porcentaje participación''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_PROMOCION_MAYOR_50 IS ''Promoción mayor que 50''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_PROMOCION_ENTRE_20_50 IS ''Promoción entre 20 y 50''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_ACT_JUDIC_CON_PROMOCION IS ''Activo judicial con promoción''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_DERRAMA_MAYOR_5000 IS ''Derrama mayor de 5000 euros''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_MODIFICACIONES_ESTATUTOS IS ''Modificación de los estatutos''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_ACTUACIONES_CONTRA_MOROSOS IS ''Actuación contra morosos''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_MODIFICA_CUOTA IS ''Modificación de la cuota''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_ITE IS ''Inspección técnica de edificios''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_OTROS IS ''Otros''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_IMPORTE IS ''Importe''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_CUOTA_ORDINARIA IS ''Cuota ordinaria''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_CUOTA_EXTRA IS ''Cuota extraordinaria''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_SUMINISTROS IS ''Suministros''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_PROPUESTA IS ''Propuesta''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_GUION_DE_VOTO IS ''Guión de voto''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.JCM_INDICACIONES IS ''Indicaciones''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] COMENTARIOS CREADOS');

COMMIT;

EXCEPTION

WHEN OTHERS THEN
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------');
    DBMS_OUTPUT.put_line(SQLERRM);
    ROLLBACK;
    RAISE;

END;
/

EXIT;
