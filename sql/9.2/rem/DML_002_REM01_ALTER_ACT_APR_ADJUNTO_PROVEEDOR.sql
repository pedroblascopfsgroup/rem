--/*
--#########################################
--## AUTOR=Sergio Giménez Mota
--## FECHA_CREACION=20190709
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.9.0
--## INCIDENCIA_LINK=NO
--## PRODUCTO=NO
--## 
--## Finalidad: Modificación de tabla 'ACT_APR_ADJUNTO_PROVEEDOR'
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

V_MSQL VARCHAR2(32000 CHAR);
TABLE_COUNT NUMBER(1,0) := 0;
V_ESQUEMA VARCHAR2(20 CHAR) := '#ESQUEMA#';
V_ESQUEMA_M VARCHAR2(20 CHAR) := '#ESQUEMA_MASTER#';
V_TABLA VARCHAR2(40 CHAR) := 'ACT_APR_ADJUNTO_PROVEEDOR';
V_COLUMN_EXISTS NUMBER := 0;  
V_IS_NULLABLE NUMBER := 0; 

BEGIN

SELECT COUNT(*) INTO V_COLUMN_EXISTS FROM ALL_TAB_COLUMNS WHERE TABLE_NAME ='ACT_APR_ADJUNTO_PROVEEDOR' AND COLUMN_NAME = 'DD_SDP_ID' AND OWNER = 'REM01';

IF V_COLUMN_EXISTS > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] LA COLUMNA YA EXISTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' DROP COLUMN DD_SDP_ID';
END IF;

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD DD_SDP_ID NUMBER(16,0)';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' columna añadida');

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.DD_SDP_ID IS ''Subtipo de documento''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' comentario añadido');

V_MSQL := 'ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||' ADD (CONSTRAINT FK_APR_DD_SDP_ID FOREIGN KEY (DD_SDP_ID) REFERENCES '||V_ESQUEMA||'.DD_SDP_SUBTIPO_DOC_PROVEEDOR (DD_SDP_ID))';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] ' ||V_ESQUEMA||'.'||V_TABLA||'_FK... FK creada.');

DBMS_OUTPUT.PUT_LINE('[INFO]: Mergeo en ACT_APR_ADJUNTO_PROVEEDOR');
V_MSQL := '
    MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' apr
    USING (
        SELECT * FROM aux_tdp_sdp
    ) tmp
    ON (tmp.dd_tdp_id = apr.dd_tdp_id)
    WHEN MATCHED THEN
    UPDATE
    SET 
    apr.dd_sdp_id = tmp.dd_sdp_id,
    apr.usuariomodificar = ''HREOS-6927'',
    apr.fechamodificar = SYSDATE
';
EXECUTE IMMEDIATE V_MSQL;

SELECT COUNT(*) INTO V_IS_NULLABLE 
FROM ALL_TAB_COLUMNS 
WHERE TABLE_NAME ='ACT_APR_ADJUNTO_PROVEEDOR' 
AND COLUMN_NAME = 'DD_TDP_ID' 
AND OWNER = 'REM01'
AND NULLABLE = 'Y'
;

IF V_IS_NULLABLE > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] EL CAMPO YA ES NULLABLE. SE PROCEDE A INSERTAR.');

    V_MSQL := '
    UPDATE '||V_ESQUEMA||'.'||V_TABLA||'
    SET (DD_TDP_ID) = NULL
    ';
    EXECUTE IMMEDIATE V_MSQL;
ELSE
    DBMS_OUTPUT.PUT_LINE('[INFO]: SE PONE EL CAMPO A NULL');
    V_MSQL := '
    ALTER TABLE '||V_ESQUEMA||'.'||V_TABLA||'
    MODIFY (DD_TDP_ID NULL)
    ';
    EXECUTE IMMEDIATE V_MSQL;
        
    V_MSQL := '
    UPDATE '||V_ESQUEMA||'.'||V_TABLA||'
    SET (DD_TDP_ID) = NULL
    ';
    EXECUTE IMMEDIATE V_MSQL;
END IF;

COMMIT;

EXCEPTION

WHEN OTHERS THEN
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------');
    DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;

END;
/

EXIT;
