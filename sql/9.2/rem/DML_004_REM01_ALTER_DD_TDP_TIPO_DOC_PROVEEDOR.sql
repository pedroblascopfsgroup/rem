--/*
--#########################################
--## AUTOR=Sergio Giménez Mota
--## FECHA_CREACION=20190709
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.9.0
--## INCIDENCIA_LINK=NO
--## PRODUCTO=NO
--## 
--## Finalidad: Modificación de tabla 'DD_TDP_TIPO_DOC_PROVEEDOR'
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

V_MSQL VARCHAR2(32000 CHAR);
TABLE_COUNT NUMBER(1,0) := 0;
V_ESQUEMA VARCHAR2(20 CHAR) := '#ESQUEMA#';
V_ESQUEMA_M VARCHAR2(20 CHAR) := '#ESQUEMA_MASTER#';
V_TABLA VARCHAR2(40 CHAR) := 'DD_TDP_TIPO_DOC_PROVEEDOR';

TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;

V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    T_TIPO_DATA(1, '01', 'Juntas de compensación', 'Juntas de compensación'),
    T_TIPO_DATA(2, '02', 'Comunidades de vecinos', 'Comunidades de vecinos')
);

V_TMP_TIPO_DATA T_TIPO_DATA;

BEGIN

V_MSQL := '
ALTER TABLE '||V_ESQUEMA||'.ACT_APR_ADJUNTO_PROVEEDOR
DISABLE CONSTRAINT FK_APR_DD_TDP_ID
';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := '
ALTER TABLE '||V_ESQUEMA||'.DD_SDP_SUBTIPO_DOC_PROVEEDOR
DISABLE CONSTRAINT FK_SDP_DD_TDP_ID
';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' CONSTRAINTS DESHABILITADAS');

V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.'||V_TABLA||'';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' registros eliminados');

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.DD_TDP_ID IS ''Tipo''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.DD_TDP_CODIGO IS ''Tipo codigo''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.DD_TDP_DESCRIPCION IS ''Tipo descripción''';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'COMMENT ON COLUMN '||V_ESQUEMA||'.'||V_TABLA||'.DD_TDP_DESCRIPCION_LARGA IS ''Tipo descripción larga''';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] COMENTARIOS CREADOS');


DBMS_OUTPUT.PUT_LINE('[INFO]: Insercion en DD_TDP_TIPO_DOC_PROVEEDOR');
    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST

        LOOP
            V_TMP_TIPO_DATA := V_TIPO_DATA(I);  
        
            DBMS_OUTPUT.PUT_LINE('[INFO]: INSERTAMOS EL REGISTRO '''|| TRIM(V_TMP_TIPO_DATA(1)) ||'''');   
            V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (' ||
                        'DD_TDP_ID, DD_TDP_CODIGO, DD_TDP_DESCRIPCION, DD_TDP_DESCRIPCION_LARGA, VERSION, USUARIOCREAR, FECHACREAR, BORRADO) ' ||
                        'VALUES('''||TRIM(V_TMP_TIPO_DATA(1))||''', '''||TRIM(V_TMP_TIPO_DATA(2))||''','''||TRIM(V_TMP_TIPO_DATA(3))||''','''||TRIM(V_TMP_TIPO_DATA(4))||''', 0, ''DML'',SYSDATE, 0)';
            EXECUTE IMMEDIATE V_MSQL;
            DBMS_OUTPUT.PUT_LINE('[INFO]: REGISTRO INSERTADO CORRECTAMENTE');
        END LOOP;

V_MSQL := '
ALTER TABLE '||V_ESQUEMA||'.ACT_APR_ADJUNTO_PROVEEDOR
DISABLE CONSTRAINT FK_APR_DD_TDP_ID
';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := '
ALTER TABLE '||V_ESQUEMA||'.DD_SDP_SUBTIPO_DOC_PROVEEDOR
DISABLE CONSTRAINT FK_SDP_DD_TDP_ID
';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' CONSTRAINTS HABILITADAS');

COMMIT;

EXCEPTION

WHEN OTHERS THEN
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------');
    DBMS_OUTPUT.put_line(SQLERRM);
    ROLLBACK;
    RAISE;

END;
/

EXIT;
