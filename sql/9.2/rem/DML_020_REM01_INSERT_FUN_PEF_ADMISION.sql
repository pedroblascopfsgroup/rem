--/*
--##########################################
--## AUTOR=Daniel Algaba
--## FECHA_CREACION=20190903
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-7466
--## PRODUCTO=NO
--##
--## Finalidad: Script que añade en FUN_PEF los datos añadidos en T_ARRAY_DATA.
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	
    V_USUARIO VARCHAR2(50 CHAR) := 'HREOS-7466'; -- USUARIO CREAR/MODIFICAR
    V_TABLA VARCHAR2(50 CHAR) := 'FUN_PEF';
    V_ENTIDAD_ID NUMBER(16);
    V_ID NUMBER(16);
    
    TYPE T_FUNCION IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_FUNCION IS TABLE OF T_FUNCION;

    V_FUNCION T_ARRAY_FUNCION := T_ARRAY_FUNCION(
      T_FUNCION('BOTON_CREAR_NOTIFICACION','BOTON_CREAR_NOTIFICACION'),
      T_FUNCION('BOTON_CREAR_TRAMITE','BOTON_CREAR_TRAMITE'),
      T_FUNCION('CARGA_MASIVA_IMPUESTOS','CARGA_MASIVA_IMPUESTOS'),
      T_FUNCION('EDITAR_AGRUPACION','EDITAR_AGRUPACION'),
      T_FUNCION('EDITAR_CHECKING_DOC_ADMISION','EDITAR_CHECKING_DOC_ADMISION'),
      T_FUNCION('EDITAR_LIST_ACTIVOS_TRABAJO','EDITAR_LIST_ACTIVOS_TRABAJO'),
      T_FUNCION('EDITAR_LIST_AGRUPACIONES','EDITAR_LIST_AGRUPACIONES'),
      T_FUNCION('EDITAR_LIST_PRESUPUESTOS_TRABAJO','EDITAR_LIST_PRESUPUESTOS_TRABAJO'),
      T_FUNCION('EDITAR_LIST_PROVSUPLI_TRABAJO','EDITAR_LIST_PROVSUPLI_TRABAJO'),
      T_FUNCION('EDITAR_LIST_RECARGOS_TRABAJO','EDITAR_LIST_RECARGOS_TRABAJO'),
      T_FUNCION('EDITAR_LIST_TARIFAS_TRABAJO','EDITAR_LIST_TARIFAS_TRABAJO'),
      T_FUNCION('EDITAR_TAB_DIARIO_GESTIONES_EXPEDIENTES','EDITAR_TAB_DIARIO_GESTIONES_EXPEDIENTES'),
      T_FUNCION('EDITAR_TAB_LISTA_ACTIVOS_AGRUPACION','EDITAR_TAB_FOTOS_AGRUPACION'),
      T_FUNCION('EDITAR_TAB_OBSERVACIONES_AGRUPACION','EDITAR_TAB_LISTA_ACTIVOS_AGRUPACION'),
      T_FUNCION('MASIVO_OK_TECNICO','EDITAR_TAB_OBSERVACIONES_AGRUPACION'),
      T_FUNCION('MASIVO_PLUSVALIA','MASIVO_OK_TECNICO'),
      T_FUNCION('MENU_COMERCIAL','MASIVO_PLUSVALIA'),
      T_FUNCION('MENU_MASIVO','MENU_COMERCIAL'),
      T_FUNCION('MENU_PRECIOS','MENU_MASIVO'),
      T_FUNCION('MENU_PUBLICACION','MENU_PRECIOS'),
      T_FUNCION('ROLE_PUEDE_VER_AGREGAR_CONVENIO_GUARDAR','MENU_PUBLICACION'),
      T_FUNCION('ROLE_PUEDE_VER_BOTON_EDITAR_PROPUESTA_CANCEL_CARGA','MOSTRAR_COMBO_GESTORES'),
      T_FUNCION('ROLE_PUEDE_VER_BOTON_EDITAR_REVISION_CARGA','ROLE_PUEDE_VER_AGREGAR_CONVENIO_GUARDAR'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_ADJUNTOS_CONTRATOS','ROLE_PUEDE_VER_BOTON_EDITAR_PROPUESTA_CANCEL_CARGA'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_ADJUNTOS_PERSONAS','ROLE_PUEDE_VER_BOTON_EDITAR_REVISION_CARGA'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_ASUNTO_ADJUNTO','ROLE_PUEDE_VER_BOTONES_ADJUNTOS_CONTRATOS'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_ASUNTO_ADJUNTO_CONTRATOS','ROLE_PUEDE_VER_BOTONES_ADJUNTOS_PERSONAS'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_ASUNTO_ADJUNTO_EXPEDIENTES','ROLE_PUEDE_VER_BOTONES_ASUNTO_ADJUNTO'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_ASUNTO_ADJUNTO_PERSONAS','ROLE_PUEDE_VER_BOTONES_ASUNTO_ADJUNTO_CONTRATOS'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_ASUNTO_TAB_ADJUNTO','ROLE_PUEDE_VER_BOTONES_ASUNTO_ADJUNTO_EXPEDIENTES'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_ASUNTO_TAB_ADJUNTO_CONTRATO','ROLE_PUEDE_VER_BOTONES_ASUNTO_ADJUNTO_PERSONAS'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_ASUNTO_TAB_ADJUNTO_EXPE','ROLE_PUEDE_VER_BOTONES_ASUNTO_TAB_ADJUNTO'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_ASUNTO_TAB_ADJUNTO_PERSONAS','ROLE_PUEDE_VER_BOTONES_ASUNTO_TAB_ADJUNTO_CONTRATO'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_CONCURSO_CONVENIO','ROLE_PUEDE_VER_BOTONES_ASUNTO_TAB_ADJUNTO_EXPE'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_CREDITO','ROLE_PUEDE_VER_BOTONES_ASUNTO_TAB_ADJUNTO_PERSONAS'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_DECISIONES','ROLE_PUEDE_VER_BOTONES_CONCURSO_CONVENIO'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_EMBARGO_PROCEDIMIENTO','ROLE_PUEDE_VER_BOTONES_CREDITO'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_PROCEDIMIENTO_ADJUNTOS','ROLE_PUEDE_VER_BOTONES_DECISIONES'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_PROCEDIMIENTO_ADJUNTOS_CNT','ROLE_PUEDE_VER_BOTONES_EMBARGO_PROCEDIMIENTO'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_PROCEDIMIENTO_ADJUNTOS_EXPE','ROLE_PUEDE_VER_BOTONES_PROCEDIMIENTO_ADJUNTOS'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_PROCEDIMIENTO_ADJUNTOS_PER','ROLE_PUEDE_VER_BOTONES_PROCEDIMIENTO_ADJUNTOS_CNT'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_RECURSOS_GUARDAR_REVISADO','ROLE_PUEDE_VER_BOTONES_PROCEDIMIENTO_ADJUNTOS_EXPE'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_SUBASTA_ACCIONES','ROLE_PUEDE_VER_BOTONES_PROCEDIMIENTO_ADJUNTOS_PER'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_SUBASTA_BIENES_LOTES','ROLE_PUEDE_VER_BOTONES_RECURSOS_GUARDAR_REVISADO'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_TAREAS_PROCEDIMIENTO','ROLE_PUEDE_VER_BOTONES_SUBASTA_ACCIONES'),
      T_FUNCION('ROLE_PUEDE_VER_BOTONES_TAREAS_PROCURADORES','ROLE_PUEDE_VER_BOTONES_SUBASTA_BIENES_LOTES'),
      T_FUNCION('ROLE_PUEDE_VER_BOTON_MODIFICAR_ANALISIS_ASUNTO','ROLE_PUEDE_VER_BOTONES_TAREAS_PROCEDIMIENTO'),
      T_FUNCION('ROLE_PUEDE_VER_BOTON_RECURSO_NUEVO','ROLE_PUEDE_VER_BOTONES_TAREAS_PROCURADORES'),
      T_FUNCION('ROLE_PUEDE_VER_EDITAR_CONVENIO_GUARDAR','ROLE_PUEDE_VER_BOTON_MODIFICAR_ANALISIS_ASUNTO'),
      T_FUNCION('ROLE_PUEDE_VER_ROLE_BOTON_ALTA_DIRECCIONES','ROLE_PUEDE_VER_BOTON_RECURSO_NUEVO'),
      T_FUNCION('ROLE_PUEDE_VER_TAREA_TIPO_COMUNICACION','ROLE_PUEDE_VER_EDITAR_CONVENIO_GUARDAR'),
      T_FUNCION('SUBIR_FOTOS_TRABAJO_SOLICITANTE','ROLE_PUEDE_VER_ROLE_BOTON_ALTA_DIRECCIONES'),
      T_FUNCION('TAB_ACTIVO_ACTUACIONES','ROLE_PUEDE_VER_TAREA_TIPO_COMUNICACION'),
      T_FUNCION('TAB_ACTIVO_ADMINISTRACION','SUBIR_FOTOS_TRABAJO_SOLICITANTE'),
      T_FUNCION('TAB_ACTIVO_GESTION','TAB_ACTIVO_ACTUACIONES'),
      T_FUNCION('TAB_ACTIVO_PRECIOS','TAB_ACTIVO_ADMINISTRACION'),
      T_FUNCION('TAB_ACTIVO_PUBLICACION','TAB_ACTIVO_GESTION'),
      T_FUNCION('TAB_ACTIVOS_COMERCIALIZABLES_EXPEDIENTES','TAB_ACTIVO_PRECIOS'),
      T_FUNCION('TAB_ACTIVO_VALORACIONES','TAB_ACTIVO_PUBLICACION'),
      T_FUNCION('TAB_AGRUPACION_FICHA','TAB_ACTIVOS_COMERCIALIZABLES_EXPEDIENTES'),
      T_FUNCION('TAB_AGRUPACION_FOTOS','TAB_ACTIVO_VALORACIONES'),
      T_FUNCION('TAB_AGRUPACION_LISTADO_ACTIVOS','TAB_AGRUPACION_FICHA'),
      T_FUNCION('TAB_AGRUPACION_OBSERVACIONES','TAB_AGRUPACION_FOTOS'),
      T_FUNCION('TAB_AGRUPACION_SUBDIVISIONES','TAB_AGRUPACION_LISTADO_ACTIVOS'),
      T_FUNCION('TAB_ASUNTO_ACUERDOS','TAB_AGRUPACION_OBSERVACIONES'),
      T_FUNCION('TAB_ASUNTO_ADJUNTOS','TAB_AGRUPACION_SUBDIVISIONES'),
      T_FUNCION('TAB_ASUNTO_CONVENIOS','TAB_ASUNTO_ACUERDOS'),
      T_FUNCION('TAB_ASUNTO_FASECOMUN','TAB_ASUNTO_ADJUNTOS'),
      T_FUNCION('TAB_ASUNTO_TITULOS','TAB_ASUNTO_CONVENIOS'),
      T_FUNCION('TAB_ATIPICOS','TAB_ASUNTO_FASECOMUN'),
      T_FUNCION('TAB_BIEN_DATOSENTIDAD','TAB_ASUNTO_TITULOS'),
      T_FUNCION('TAB_BIEN_PROCEDIMIENTOS','TAB_ATIPICOS'),
      T_FUNCION('TAB_BIEN_RELACIONES','TAB_BIEN_DATOSENTIDAD'),
      T_FUNCION('TAB_COMERCIAL_AGRUPACION','TAB_BIEN_PROCEDIMIENTOS'),
      T_FUNCION('TAB_COMERCIAL_VISITAS','TAB_BIEN_RELACIONES'),
      T_FUNCION('TAB_COMPRADORES_EXPEDIENTES','TAB_COMERCIAL_AGRUPACION'),
      T_FUNCION('TAB_CONDICIONES_EXPEDIENTES','TAB_COMERCIAL_VISITAS'),
      T_FUNCION('TAB_CONFIGURACION_PUBLICACION','TAB_COMPRADORES_EXPEDIENTES'),
      T_FUNCION('TAB_DATOS_BASICOS_EXPEDIENTES','TAB_CONDICIONES_EXPEDIENTES'),
      T_FUNCION('TAB_DATOS_BASICOS_OFERTA_EXPEDIENTES','TAB_CONFIGURACION_PUBLICACION'),
      T_FUNCION('TAB_DATOS_PUBLICACION','TAB_DATOS_BASICOS_EXPEDIENTES'),
      T_FUNCION('TAB_DIARIO_GESTIONES_EXPEDIENTES','TAB_DATOS_BASICOS_OFERTA_EXPEDIENTES'),
      T_FUNCION('TAB_DOCUMENTOS_AGRUPACION','TAB_DATOS_PUBLICACION'),
      T_FUNCION('TAB_DOCUMENTOS_EXPEDIENTES','TAB_DIARIO_GESTIONES_EXPEDIENTES'),
      T_FUNCION('TAB_FORMALIZACION_EXPEDIENTES','TAB_DOCUMENTOS_AGRUPACION'),
      T_FUNCION('TAB_GESTION_ECONOMICA_EXPEDIENTES','TAB_DOCUMENTOS_EXPEDIENTES'),
      T_FUNCION('TAB_GESTION_PROVISIONES_ADMINISTRACION','TAB_FORMALIZACION_EXPEDIENTES'),
      T_FUNCION('TAB_GESTORES_EXPEDIENTES','TAB_GESTION_ECONOMICA_EXPEDIENTES'),
      T_FUNCION('TAB_HISTORICO_PROPUESTA_PRECIOS','TAB_GESTION_PROVISIONES_ADMINISTRACION'),
      T_FUNCION('TAB_HIST_PETICIONES','TAB_GESTORES_EXPEDIENTES'),
      T_FUNCION('TAB_OFERTA_EXPEDIENTES','TAB_HISTORICO_PROPUESTA_PRECIOS'),
      T_FUNCION('TAB_OFERTAS_COMERCIAL','TAB_HIST_PETICIONES'),
      T_FUNCION('TAB_PRC_ADJUNTO','TAB_OFERTA_EXPEDIENTES'),
      T_FUNCION('TAB_PRC_CONTRATO','TAB_OFERTAS_COMERCIAL'),
      T_FUNCION('TAB_PRC_DECISION','TAB_PRC_ADJUNTO'),
      T_FUNCION('TAB_PRESUPUESTO_ASIGNADO_ACTIVO','TAB_PRC_CONTRATO'),
      T_FUNCION('TAB_PROPUESTAS_PRECIO','TAB_PRC_DECISION'),
      T_FUNCION('TAB_PUBLICACION_ACTIVOS','TAB_PRESUPUESTO_ASIGNADO_ACTIVO'),
      T_FUNCION('TAB_RESERVA_EXPEDIENTES','TAB_PROPUESTAS_PRECIO'),
      T_FUNCION('TAB_SEGUIMIENTO_AGRUPACION','TAB_PUBLICACION_ACTIVOS'),
      T_FUNCION('TAB_TANTEO_RETRACTO_OFERTA_EXPEDIENTES','TAB_RESERVA_EXPEDIENTES'),
      T_FUNCION('TAB_TASACIONES','TAB_SEGUIMIENTO_AGRUPACION'),
      T_FUNCION('TAB_TRÁMITES_EXPEDIENTES','TAB_TANTEO_RETRACTO_OFERTA_EXPEDIENTES'),
      T_FUNCION('TAB_VALORACIONES_PRECIOS','TAB_TASACIONES'),
      T_FUNCION('TAB_VISITAS_COMERCIAL','TAB_TRÁMITES_EXPEDIENTES'),
      T_FUNCION('TRABAJO_FOTOPROV_ADD','TAB_VALORACIONES_PRECIOS'),
      T_FUNCION('NULL','TAB_VISITAS_COMERCIAL'),
      T_FUNCION('NULL','TRABAJO_FOTOPROV_ADD')
    ); 
    V_TMP_FUNCION T_FUNCION;
    
BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');
	 
    -- LOOP para insertar los valores en ZON_PEF_USU -----------------------------------------------------------------
    DBMS_OUTPUT.PUT_LINE('[INFO]: INSERCION EN '||V_TABLA||'] ');
     FOR I IN V_FUNCION.FIRST .. V_FUNCION.LAST
      LOOP
        V_TMP_FUNCION := V_FUNCION(I);

          -- Gestor admisión
    			V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA||' FP
                    JOIN '||V_ESQUEMA||'.PEF_PERFILES PEF ON PEF.PEF_ID = FP.PEF_ID AND PEF.BORRADO = 0
                    JOIN '||V_ESQUEMA_M||'.FUN_FUNCIONES FUN ON FP.FUN_ID = FUN.FUN_ID AND FUN.BORRADO = 0
                    WHERE PEF.PEF_CODIGO = ''HAYAGESTADM'' AND FP.BORRADO = 0 AND FUN.FUN_DESCRIPCION = '''||V_TMP_FUNCION(1)||'''';       
    			EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;

    			-- Si existe la FILA
    			IF V_NUM_TABLAS > 0 OR ''||V_TMP_FUNCION(1)||'' = 'NULL' THEN	  
    				DBMS_OUTPUT.PUT_LINE('[INFO] El perfil Gestor de admisión ya tiene la función '||V_TMP_FUNCION(1)||'');
    			ELSE
    				V_MSQL := 'INSERT INTO '||V_ESQUEMA_M||'.'||V_TABLA||'' ||
    							' (FUN_ID, PEF_ID, FP_ID, VERSION, USUARIOCREAR, FECHACREAR, BORRADO)' || 
    							'(SELECT FUN_ID FROM '||V_ESQUEMA_M||'.FUN_FUNCIONES FUN WHERE FUN.FUN_DESCRIPCION = '''||V_TMP_FUNCION(1)||''')' ||
    							',(SELECT PEF_ID FROM '||V_ESQUEMA||'.PEF_PERFILES PEF WHERE PEF.PEF_CODIGO = ''HAYAGESTADM'')' ||
                  ',SELECT '||V_ESQUEMA_M||'.S_'||V_TABLA||'.NEXTVAL' ||
    							',0, '''||V_USUARIO||''', SYSDATE, 0 FROM DUAL';
    				EXECUTE IMMEDIATE V_MSQL;
    				DBMS_OUTPUT.PUT_LINE('[INFO] Insertados correctamente la función '||V_TMP_FUNCION(1)||' para el perfil Gestor de admisión');
    		  END IF;	

          -- Supervisor admisión
          V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA||' FP
                    JOIN '||V_ESQUEMA||'.PEF_PERFILES PEF ON PEF.PEF_ID = FP.PEF_ID AND PEF.BORRADO = 0
                    JOIN '||V_ESQUEMA_M||'.FUN_FUNCIONES FUN ON FP.FUN_ID = FUN.FUN_ID AND FUN.BORRADO = 0
                    WHERE PEF.PEF_CODIGO = ''HAYASUPADM'' AND FP.BORRADO = 0 AND FUN.FUN_DESCRIPCION = '''||V_TMP_FUNCION(2)||'''';
          EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
          
          -- Si existe la FILA
          IF V_NUM_TABLAS > 0 OR ''||V_TMP_FUNCION(2)||'' = 'NULL' THEN    
            DBMS_OUTPUT.PUT_LINE('[INFO] El perfil Supervisor de admisión ya tiene la función '||V_TMP_FUNCION(2)||'');
          ELSE
            V_MSQL := 'INSERT INTO '||V_ESQUEMA_M||'.'||V_TABLA||'' ||
                  ' (FUN_ID, PEF_ID, FP_ID, VERSION, USUARIOCREAR, FECHACREAR, BORRADO)' || 
                  '(SELECT FUN_ID FROM '||V_ESQUEMA_M||'.FUN_FUNCIONES FUN WHERE FUN.FUN_DESCRIPCION = '''||V_TMP_FUNCION(2)||''')' ||
                  ',(SELECT PEF_ID FROM '||V_ESQUEMA||'.PEF_PERFILES PEF WHERE PEF.PEF_CODIGO = ''HAYASUPADM'')' ||
                  ',SELECT '||V_ESQUEMA_M||'.S_'||V_TABLA||'.NEXTVAL' ||
                  ',0, '''||V_USUARIO||''', SYSDATE, 0 FROM DUAL';
            EXECUTE IMMEDIATE V_MSQL;
            DBMS_OUTPUT.PUT_LINE('[INFO] Insertados correctamente la función '||V_TMP_FUNCION(2)||' para el perfil Supervisor de admisión');
          END IF; 

      END LOOP;
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN]: '||V_TABLA||' ACTUALIZADO CORRECTAMENTE ');
   

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;
/
EXIT;
