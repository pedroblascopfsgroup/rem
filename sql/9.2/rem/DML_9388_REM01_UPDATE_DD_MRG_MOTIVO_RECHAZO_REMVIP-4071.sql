--/*
--#########################################
--## AUTOR=Oscar Diestre Pérez
--## FECHA_CREACION=20190828
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-4071
--## PRODUCTO=NO
--## 
--## Finalidad: Modificar el criterio de rechazo de anulaciones de gasto
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-3186';

	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_SQL VARCHAR2(4000 CHAR);


BEGIN

	DBMS_OUTPUT.PUT_LINE('[INICIO]');

	V_SQL := ' UPDATE '||V_ESQUEMA||'.DD_MRG_MOTIVO_RECHAZO_GASTO
		   SET QUERY_ITER = ''JOIN GPV_GASTOS_PROVEEDOR GPV ON GPV.GPV_NUM_GASTO_GESTORIA = AUX.COD_GASTO_GESTORIA AND GPV.DD_GRF_ID = 	#TOKEN_IDGESTORIA# JOIN GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID JOIN GPV_ACT GA ON GPV.GPV_ID = GA.GPV_ID JOIN ACT_ACTIVO ACT ON ACT.ACT_ID = GA.ACT_ID WHERE AUX.TIPO_ENVIO LIKE ''''04'''' AND  (AUX.COD_ACTIVO       <> ACT.ACT_NUM_ACTIVO or AUX.PRINCIPAL <> GDE.GDE_PRINCIPAL_NO_SUJETO or AUX.RECARGO <> GDE.GDE_RECARGO or AUX.INT_DEMORA <> GDE.GDE_INTERES_DEMORA or AUX.COSTAS <> GDE.GDE_COSTAS or AUX.OTROS_INCREMENTOS <> GDE.GDE_OTROS_INCREMENTOS or AUX.PROVISIONES_Y_SUPL <> GDE.GDE_PROV_SUPLIDOS or AUX.IMPORTE_PAGADO <> GDE.GDE_IMPORTE_PAGADO)''
WHERE DD_MRG_CODIGO = ''F08'' ';

	EXECUTE IMMEDIATE V_SQL;
	DBMS_OUTPUT.PUT_LINE('[FIN] Actualizado el registro en DD_MRG_MOTIVO_RECHAZO ');
	COMMIT;

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      DBMS_OUTPUT.PUT_LINE(V_SQL);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
