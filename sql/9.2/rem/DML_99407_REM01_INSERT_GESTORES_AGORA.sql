--/*
--/*
--###########################################
--## AUTOR=VICTOR OLIVARES
--## FECHA_CREACION=20190307
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-5575
--## PRODUCTO=NO
--## 
--## Finalidad: Carga gestores para la cartera Agora
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial Aleix Arnau
--##	    0.2 Actualización gestor formalización y subcarteras   
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
	ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
 
	V_TICKET VARCHAR2(25 CHAR) := 'HREOS-5575';
	V_AUX VARCHAR(25 CHAR);
	V_AUX_USU VARCHAR(25 CHAR);


  
	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(200);
	TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
	V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
	--T_TIPO_DATA('Tipo Gestor',Cartera,SubcarteraCodigoProvincia,Código municipio,'Username Gestor','Gestor');

		


		--ALTA GESTORES AGORA--

		T_TIPO_DATA('GACT',07,135,null,null,'amonge','Alfredo Leonardo Monge'),
		T_TIPO_DATA('GALQ',07,135,null,null,'dleganes','Daniel Leganés'),
		T_TIPO_DATA('SCOM',07,135,null,null,'pdorado','Paula Dorado'),
		T_TIPO_DATA('GIAADMT',07,135,null,null,'ogf02','OGF Administración'),
		T_TIPO_DATA('GFORM',07,135,null,null,'chernandez','Cristina Hernández Martín'),
		T_TIPO_DATA('GIAFORM',07,135,null,null,'ogf03','OGF Formalización'),
		T_TIPO_DATA('GTOADM',07,135,null,null,'ogf01','OGF Admisión'),
		T_TIPO_DATA('GCOMAG',07,135,null,null,'rjimeno','Raúl Jimeno'),
		T_TIPO_DATA('GCOMAG',07,135,null,null,'pgarcia','Pedro García'),
		T_TIPO_DATA('PTEC',07,135,null,null,'A82451410','HOMESERVE ASISTENCIA SPAIN, S.A.U.'),
		T_TIPO_DATA('GPUBL',07,135,null,null,'arueda','Anselmo Rueda'),
		T_TIPO_DATA('SFORM',07,135,null,null,'lsoriano','Lucía Soriano'),
		T_TIPO_DATA('GACT',07,137,null,null,'amonge','Alfredo Leonardo Monge'),
		T_TIPO_DATA('GALQ',07,137,null,null,'dleganes','Daniel Leganés'),
		T_TIPO_DATA('SCOM',07,137,null,null,'pdorado','Paula Dorado'),
		T_TIPO_DATA('GIAADMT',07,137,null,null,'ogf02','OGF Administración'),
		T_TIPO_DATA('GFORM',07,137,null,null,'chernandez','Cristina Hernández Martín'),
		T_TIPO_DATA('GIAFORM',07,137,null,null,'ogf03','OGF Formalización'),
		T_TIPO_DATA('GTOADM',07,137,null,null,'ogf01','OGF Admisión'),
		T_TIPO_DATA('GCOMAG',07,137,null,null,'rjimeno','Raúl Jimeno'),
		T_TIPO_DATA('GCOMAG',07,137,null,null,'pgarcia','Pedro García'),
		T_TIPO_DATA('PTEC',07,137,null,null,'A82451410','HOMESERVE ASISTENCIA SPAIN, S.A.U.'),
		T_TIPO_DATA('GPUBL',07,137,null,null,'arueda','Anselmo Rueda'),
		T_TIPO_DATA('SFORM',07,137,null,null,'lsoriano','Lucía Soriano')


		--T_TIPO_DATA('Tgestor',cartera,provincia,municipio,username,nombreUsuario')



	); 
	V_TMP_TIPO_DATA T_TIPO_DATA;
  	
  
	IN_ACT_GES VARCHAR2 (32000) := q'[INSERT INTO #ESQUEMA#.ACT_GES_DIST_GESTORES 
					(ID,TIPO_GESTOR,COD_CARTERA,COD_SUBCARTERA,COD_PROVINCIA,COD_MUNICIPIO,USERNAME,NOMBRE_USUARIO,VERSION,USUARIOCREAR,FECHACREAR,BORRADO) 
					VALUES 
					(#ESQUEMA#.S_ACT_GES_DIST_GESTORES.NEXTVAL,:1,:2,:3,:4,:5,:6,:7,0,'HREOS-5575',sysdate,0)]';

	SEL_USU VARCHAR2 (32000) := q'[SELECT COUNT(1) FROM #ESQUEMA_MASTER#.USU_USUARIOS WHERE USU_USERNAME = :1]';

	SEL_ACT_GES VARCHAR2 (32000) := q'[SELECT COUNT(1) FROM #ESQUEMA#.ACT_GES_DIST_GESTORES WHERE 
						TIPO_GESTOR = :1 AND COD_CARTERA = :2 AND COD_SUBCARTERA = :3 AND COD_PROVINCIA = :4 AND COD_MUNICIPIO = :5 AND USERNAME = :6]';


	--ALTA GESTORES AGORA--
	--PENDIENTE ESPECIFICAR SI ES NECESARIO DDL PARA CAMPO SUBCARTERA EN TABLA ACT_GES_DIST_GESTORES
	DEL_GES_ACT VARCHAR2(32000) := q'[DELETE FROM #ESQUEMA#.ACT_GES_DIST_GESTORES WHERE TIPO_GESTOR = 'GACT' AND COD_CARTERA IN (07) AND COD_SUBCARTERA IN (135) OR COD_SUBCARTERA IN (137)]';
	DEL_GES_ALQ VARCHAR2(32000) := q'[DELETE FROM #ESQUEMA#.ACT_GES_DIST_GESTORES WHERE TIPO_GESTOR = 'GALQ' AND COD_CARTERA IN (07) AND COD_SUBCARTERA IN (135) OR COD_SUBCARTERA IN (137)]';
	DEL_GES_SCOM VARCHAR2(32000) := q'[DELETE FROM #ESQUEMA#.ACT_GES_DIST_GESTORES WHERE TIPO_GESTOR = 'SCOM' AND COD_CARTERA IN (07) AND COD_SUBCARTERA IN (135) OR COD_SUBCARTERA IN (137)]';
	DEL_GES_GIAADMT VARCHAR2(32000) := q'[DELETE FROM #ESQUEMA#.ACT_GES_DIST_GESTORES WHERE TIPO_GESTOR = 'GIAADMT' AND COD_CARTERA IN (07) AND COD_SUBCARTERA IN (135) OR COD_SUBCARTERA IN (137)]';
	DEL_GES_GFORM VARCHAR2(32000) := q'[DELETE FROM #ESQUEMA#.ACT_GES_DIST_GESTORES WHERE TIPO_GESTOR = 'GFORM' AND COD_CARTERA IN (07) AND COD_SUBCARTERA IN (135) OR COD_SUBCARTERA IN (137)]';
	DEL_GES_GIAFORM VARCHAR2(32000) := q'[DELETE FROM #ESQUEMA#.ACT_GES_DIST_GESTORES WHERE TIPO_GESTOR = 'GIAFORM' AND COD_CARTERA IN (07) AND COD_SUBCARTERA IN (135) OR COD_SUBCARTERA IN (137)]';
	DEL_GES_GTOADM VARCHAR2(32000) := q'[DELETE FROM #ESQUEMA#.ACT_GES_DIST_GESTORES WHERE TIPO_GESTOR = 'GTOADM' AND COD_CARTERA IN (07) AND COD_SUBCARTERA IN (135) OR COD_SUBCARTERA IN (137)]';
	DEL_GES_GCOMAG VARCHAR2(32000) := q'[DELETE FROM #ESQUEMA#.ACT_GES_DIST_GESTORES WHERE TIPO_GESTOR = 'GCOMAG' AND COD_CARTERA IN (07) AND COD_SUBCARTERA IN (135) OR COD_SUBCARTERA IN (137)]';
	DEL_GES_PTEC VARCHAR2(32000) := q'[DELETE FROM #ESQUEMA#.ACT_GES_DIST_GESTORES WHERE TIPO_GESTOR = 'PTEC' AND COD_CARTERA IN (07) AND COD_SUBCARTERA IN (135) OR COD_SUBCARTERA IN (137)]';
	DEL_GES_GPUBL VARCHAR2(32000) := q'[DELETE FROM #ESQUEMA#.ACT_GES_DIST_GESTORES WHERE TIPO_GESTOR = 'GPUBL' AND COD_CARTERA IN (07) AND COD_SUBCARTERA IN (135) OR COD_SUBCARTERA IN (137)]';
	DEL_GES_SFORM VARCHAR2(32000) := q'[DELETE FROM #ESQUEMA#.ACT_GES_DIST_GESTORES WHERE TIPO_GESTOR = 'SFORM' AND COD_CARTERA IN (07) AND COD_SUBCARTERA IN (135) OR COD_SUBCARTERA IN (137)]';
	

	
BEGIN	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');
	EXECUTE IMMEDIATE DEL_GES_ACT;
	DBMS_OUTPUT.PUT_LINE('[BORRADA CONFIGURACION ANTERIOR GESTORES ACTIVO]');
	EXECUTE IMMEDIATE DEL_GES_ALQ;
	DBMS_OUTPUT.PUT_LINE('[BORRADA CONFIGURACION ANTERIOR GESTORES ALQUILER]');

	--AGORA--
	EXECUTE IMMEDIATE DEL_GES_SCOM;
	DBMS_OUTPUT.PUT_LINE('[BORRADA CONFIGURACION ANTERIOR SUPERVISOR COMERCIAL]');
	EXECUTE IMMEDIATE DEL_GES_GIAADMT;
	DBMS_OUTPUT.PUT_LINE('[BORRADA CONFIGURACION ANTERIOR GESTORIAS DE ADMINISTRACIÓN]');
	EXECUTE IMMEDIATE DEL_GES_GFORM;
	DBMS_OUTPUT.PUT_LINE('[BORRADA CONFIGURACION ANTERIOR GESTOR DE FORMALIZACIÓN]');
	EXECUTE IMMEDIATE DEL_GES_GIAFORM;
	DBMS_OUTPUT.PUT_LINE('[BORRADA CONFIGURACION ANTERIOR GESTORIAS DE FORMALIZACIÓN]');
	EXECUTE IMMEDIATE DEL_GES_GTOADM;
	DBMS_OUTPUT.PUT_LINE('[BORRADA CONFIGURACION ANTERIOR GESTORIAS DE ADMISION]');
	EXECUTE IMMEDIATE DEL_GES_GCOMAG;
	DBMS_OUTPUT.PUT_LINE('[BORRADA CONFIGURACION ANTERIOR GESTORES COMERCIALES AGORA]');
	EXECUTE IMMEDIATE DEL_GES_PTEC;
	DBMS_OUTPUT.PUT_LINE('[BORRADA CONFIGURACION ANTERIOR PROVEEDORES TÉCNICOS]');
	EXECUTE IMMEDIATE DEL_GES_GPUBL;
	DBMS_OUTPUT.PUT_LINE('[BORRADA CONFIGURACION ANTERIOR GESTORES DE PUBLICACIONES]');
	EXECUTE IMMEDIATE DEL_GES_SFORM;
	DBMS_OUTPUT.PUT_LINE('[BORRADA CONFIGURACION ANTERIOR SUPERVISOR DE FORMALIZACIÓN]');




	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
    	LOOP
		V_TMP_TIPO_DATA := V_TIPO_DATA(I);
		DBMS_OUTPUT.PUT_LINE('[COMPROBACION] ');
		EXECUTE IMMEDIATE SEL_USU INTO V_AUX_USU USING V_TMP_TIPO_DATA(6);
		EXECUTE IMMEDIATE SEL_ACT_GES INTO V_AUX USING V_TMP_TIPO_DATA(1), V_TMP_TIPO_DATA(2), V_TMP_TIPO_DATA(3), V_TMP_TIPO_DATA(4), V_TMP_TIPO_DATA(5), V_TMP_TIPO_DATA(6); 

		IF V_AUX_USU = 1 THEN 
			IF V_AUX = 0 THEN
				DBMS_OUTPUT.PUT_LINE('INSERT REGISTRO '|| I);

				EXECUTE IMMEDIATE IN_ACT_GES USING V_TMP_TIPO_DATA(1),V_TMP_TIPO_DATA(2),V_TMP_TIPO_DATA(3),V_TMP_TIPO_DATA(4),V_TMP_TIPO_DATA(5),V_TMP_TIPO_DATA(6),V_TMP_TIPO_DATA(7);

				DBMS_OUTPUT.PUT_LINE('[OK] '|| V_TMP_TIPO_DATA(6));
			ELSE DBMS_OUTPUT.PUT_LINE('[KO] COUNT REGISTRO GESTOR  '|| V_AUX_USU);
			END IF; 
		ELSE
			DBMS_OUTPUT.PUT_LINE('[KO] ERROR USUARIO NO ENCONTRADO O ERRONEO '|| V_TMP_TIPO_DATA(6));
		END IF;		
        
	END LOOP;
    
	COMMIT;
	DBMS_OUTPUT.PUT_LINE('[FIN]: PROCESO ACTUALIZADO CORRECTAMENTE ');
 

EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
