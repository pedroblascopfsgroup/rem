--/*
--##########################################
--## AUTOR=Juan Beltran
--## FECHA_CREACION=20190912
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-7668
--## PRODUCTO=NO
--##
--## Finalidad: Script que actualiza DD_CCA_ID
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    CUENTA NUMBER; -- Contador   
   
    
BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');
	SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'DD_PRV_PROVINCIA' AND OWNER=V_ESQUEMA_M AND OBJECT_TYPE='TABLE';  
   
	IF CUENTA>0 THEN
    	DBMS_OUTPUT.PUT_LINE('UPDATE '|| V_ESQUEMA_M ||'.DD_PRV_PROVINCIA...');
    	
    	-- Andalucía
	   	DBMS_OUTPUT.PUT_LINE('Andalucía');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''01''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''4'',''11'',''14'',''18'',''21'',''23'',''29'',''41'')';  		
	    
    	-- Aragón
    	DBMS_OUTPUT.PUT_LINE('Aragón');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''02''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''22'',''44'',''50'')';
		 
		-- Asturias
		DBMS_OUTPUT.PUT_LINE('Asturias');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''03''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''33'')';
		 
		-- Baleares
		DBMS_OUTPUT.PUT_LINE('Baleares');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''04''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''7'')';
		 
		-- Canarias
		DBMS_OUTPUT.PUT_LINE('Canarias');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''05''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''35'',''38'')';
		 
		 -- Cantabria
		 DBMS_OUTPUT.PUT_LINE('Cantabria');
		 EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''06''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''39'')';
		 
		-- Castilla y León
		DBMS_OUTPUT.PUT_LINE('Castilla y León');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''07''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''5'',''9'',''24'',''34'',''37'',''40'',''42'',''47'',''49'')';
		 
		-- Castilla-La Mancha
		DBMS_OUTPUT.PUT_LINE('Castilla-La Mancha');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''08''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''2'',''13'',''16'',''19'',''45'')';
		 
		-- Cataluña
		DBMS_OUTPUT.PUT_LINE('Cataluña');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''09''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''8'',''17'',''25'',''43'')';
		 
		-- Comunitat Valenciana
		DBMS_OUTPUT.PUT_LINE('Comunitat Valenciana');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''10''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''3'',''12'',''46'')';
		 
 		-- Extremadura
 		DBMS_OUTPUT.PUT_LINE('Extremadura');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''11''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''6'',''10'')';
		 
		-- Galicia
		DBMS_OUTPUT.PUT_LINE('Galicia');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''12''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''15'',''27'',''32'',''36'')';
		 
		-- Madrid
		DBMS_OUTPUT.PUT_LINE('Madrid');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''13''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''28'')';
		 
		-- Murcia
		DBMS_OUTPUT.PUT_LINE('Murcia');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''14''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''30'')';
		 
		-- Navarra
		DBMS_OUTPUT.PUT_LINE('Navarra');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''15''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''31'')';
		 
		-- País Vasco
		DBMS_OUTPUT.PUT_LINE('País Vasco');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''16''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''1'',''48'',''20'')';
		 
		-- La Rioja
		DBMS_OUTPUT.PUT_LINE('La Rioja');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''17''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''26'')';
		 
		-- Ceuta
		DBMS_OUTPUT.PUT_LINE('Ceuta');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''18''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''51'')';
		 
		-- Melilla
		DBMS_OUTPUT.PUT_LINE('Melilla');
	    EXECUTE IMMEDIATE 'UPDATE ' || V_ESQUEMA_M || '.DD_PRV_PROVINCIA PRV 
		 SET PRV.DD_CCA_ID = 
		    (SELECT DD_CCA_ID
        		FROM REMMASTER.DD_CCA_COMUNIDAD
		        WHERE DD_CCA_CODIGO = ''19''),
		 USUARIOMODIFICAR = ''HREOS-7668'',
		 FECHAMODIFICAR = SYSDATE 
		 WHERE DD_PRV_CODIGO IN(''52'')';
		 
	    
	END IF;
	
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN]: DD_PRV_PROVINCIA ACTUALIZADO CORRECTAMENTE ');
   

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;
/
EXIT
   
