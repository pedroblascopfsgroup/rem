--/*
--###########################################
--## AUTOR=Vicente Martinez Cifre
--## FECHA_CREACION=20181105
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-9999
--## PRODUCTO=NO
--## 
--## Finalidad: Creacion de Usuarios REM
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  
BEGIN	

DBMS_OUTPUT.PUT_LINE('[INICIO]');

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS T1 USING (
    SELECT DISTINCT ECO.ECO_NUM_EXPEDIENTE, TAC.TAR_ID, TAC.TRA_ID, GEE.USU_ID 
    FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO
    JOIN '||V_ESQUEMA||'.GCO_GESTOR_ADD_ECO GCO ON GCO.ECO_ID = ECO.ECO_ID
    JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GCO.GEE_ID
    JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
    JOIN '||V_ESQUEMA||'.ACT_TBJ_TRABAJO TRA ON eco.TBJ_ID = TRA.TBJ_ID 
    JOIN '||V_ESQUEMA||'.ACT_TRA_TRAMITE ATR ON ATR.TBJ_ID = TRA.TBJ_ID
    JOIN '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC ON ATR.TRA_ID = TAC.TRA_ID
    JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
    JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TXT ON TXT.TAR_ID = TAR.TAR_ID
    JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TXT.TAP_ID = TAP.TAP_ID
    WHERE TAP.TAP_CODIGO = ''T013_ResultadoPBC'' 
    AND TAR.TAR_TAREA_FINALIZADA = 0 AND TGE.DD_TGE_CODIGO = ''GFORM'' AND TAC.USU_ID <> GEE.USU_ID 
    AND ECO.ECO_NUM_EXPEDIENTE IN (102050, 108877, 110858, 110858, 112780, 112780, 113189, 126089, 129622, 132495, 131915, 132452, 135027, 135054, 135051, 134248, 134687, 
    134062, 133117, 133789, 108875, 133405, 110404, 134751, 134734, 133307, 133472, 134721, 111289, 134217, 133423, 133158, 134983, 112152, 133638, 133599, 132123, 132123, 
    113056, 131271, 113178, 113237, 113430, 131304, 131266, 131411, 131264, 132199, 131501, 130927, 131664, 130901, 134158, 132079, 131512, 131163, 130174, 130174, 129835, 
    130013, 129835, 130169, 129835, 129735, 131016, 129662, 128930, 130335, 131020, 134765, 133764, 132575, 132508, 132459, 131973, 131973, 131973, 132511, 131973, 131994, 
    132253, 132281, 132310, 131628, 131372, 131523, 131382, 131618, 132082, 131510, 130766, 130766, 130765, 132353, 133624, 128657, 128198, 127639, 127666, 127639, 127666, 
    128690, 127703, 127587, 127729, 127697, 127364, 127654, 127367, 126971, 127029, 127078, 127078, 127208, 119482, 118897, 118785, 118829, 118645, 118645, 118686, 129307, 
    129261, 128759, 128812, 120951, 120633, 120360, 120346, 120301, 120254, 120048, 120050, 119481, 119099, 119100, 118830, 118826, 118688, 118440, 118440, 118440, 116173, 
    115647, 115646, 113329, 115244, 114811, 114809, 114565, 114297, 114299, 114806, 114119, 134921, 134920, 134521, 134623, 134513, 134268, 134760, 134581, 134824, 134321, 
    133862, 133902, 133874, 133711, 133438, 133752, 133749, 111518, 111519, 132651, 133321, 132761, 112639, 134642, 132624, 132710, 131612, 131718, 131782, 131775, 131612, 
    114263, 114263, 131547, 131759, 114345, 131627, 133960, 131623, 131617, 114612, 131071, 131615, 131615, 134633, 130449, 130452, 131702, 130258, 130203, 130511, 130385, 
    130203, 130258, 130276, 129281, 129467, 129152, 129564, 121047, 121047, 120877, 120877, 118196, 118077, 126295, 126295, 126295, 125897, 105353, 126295, 126295, 126295, 
    125998, 79750, 128829, 128791, 120798, 121037, 129351, 129090, 120966, 79026, 104306, 95439, 131046, 130509, 130324, 130967, 130812, 130512, 130585, 130355, 130122, 130896, 
    130432, 129741, 132029, 78963, 91746, 78867, 69443, 130421, 115918, 128757, 87864, 106511, 130592, 120998, 130962, 87935, 88755, 94790, 98863, 131019, 130727, 130944, 97222, 
    128626, 100457, 96894, 85285, 106318, 96910, 67396, 127192, 134548, 130520, 130858, 134155, 100121, 131120, 131077, 130359, 134599, 134029, 133712, 133552, 133505, 132861, 
    132851, 134519, 133107, 132734, 132100, 131840, 131334, 133611, 130675, 131192, 130947, 130867, 86836, 94009, 106733, 103504, 105953, 107371, 107491, 131272, 81691, 128181, 
    130861, 132115, 84987, 132361, 133078, 132288, 131255, 132975, 132309, 132307, 132665, 133055, 130993, 130708, 132102, 132083, 130844, 132099, 131400, 127565, 132363, 131198, 
    126041, 126775, 129996, 112634, 116367, 113381, 129671, 131128, 134244, 130776, 129713, 131584, 129637, 132161, 129684, 114862, 130729, 130084, 128124, 127856, 132328, 132698, 
    125833, 129813, 129447, 129688, 129961, 127389, 130548, 129383, 129046, 115729, 132472, 127564, 127315, 117877, 130376, 130984, 130238, 132828, 131093, 133763, 114273, 132025, 
    129942, 134049, 132829, 134237, 134344, 130953, 132202, 134005, 132634, 134755, 111144, 104411, 95934, 94285, 78722, 127501, 98053, 118842, 114394, 121232, 120917, 126751, 128078, 
    116239, 128587, 128613, 128211, 115938, 132708, 132910, 132974, 133020, 120398, 134011, 133010, 128342, 118425, 132853, 132706, 105818, 76552, 40690, 84391, 134369, 134045, 133531, 
    134349, 133140, 133511, 132941, 132808, 132725, 132484, 132483, 132467, 132803, 132711, 132745, 132311, 131896, 129186, 132152, 133946, 132191, 95253, 96627, 127676, 129193, 129192, 
    130536, 127538, 128880, 129210, 130529, 130339, 130360, 130782, 130260, 129191, 129207, 126869, 131393, 130537, 127981, 115767, 103110, 127541, 132188, 129540, 130347, 108271, 128009, 
    128002, 128984, 128126, 126480, 129698, 84875, 127480, 118795, 127591, 128904, 126852, 131566, 128886, 133994, 113800, 94246 )
    ) T2
    ON (T1.TAR_ID = T2.TAR_ID AND T1.TRA_ID = T2.TRA_ID)
    WHEN MATCHED THEN UPDATE
    SET T1.USU_ID = T2.USU_ID, T1.USUARIOMODIFICAR = ''REMVIP-2492'', T1.FECHAMODIFICAR = SYSDATE';

  EXECUTE IMMEDIATE V_MSQL;

  DBMS_OUTPUT.put_line('Se han actualizado '||SQL%ROWCOUNT||' registros');
    
   COMMIT;
   
DBMS_OUTPUT.PUT_LINE('[FIN]');
 

EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
