--/*
--##########################################
--## AUTOR=Matias Garcia-Argudo
--## FECHA_CREACION=20181228
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-4940
--## PRODUCTO=NO
--## Finalidad: Inserta y elimina registros en la tabla CMU_CONFIG_MUNICIPIOS
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
set linesize 2000
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

   V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
   V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
   V_SQL VARCHAR2(4000 CHAR); -- Sentencia a ejecutar.
   V_MSQL VARCHAR2(32000 CHAR); -- Contador de apariciones en una tabla.    
   ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
   ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

   V_DDNAME VARCHAR2(50 CHAR):= 'DD_LOC_LOCALIDAD';
   V_TABLE VARCHAR2(50 CHAR):= 'CMU_CONFIG_MUNICIPIOS'; -- Nombre de la tabla
   COUNTER NUMBER(10):=0;  -- Vble. para validar la existencia de una tabla.
    --Valores a insertar
    TYPE T_TIPO IS TABLE OF VARCHAR2(4000 CHAR);
    TYPE T_ARRAY IS TABLE OF T_TIPO;
    V_TIPO T_ARRAY := T_ARRAY(T_TIPO('08001'),T_TIPO('08003'),T_TIPO('08006'),T_TIPO('08007'),T_TIPO('08009'),T_TIPO('08011'),T_TIPO('08015'),T_TIPO('08019'),T_TIPO('08020'),T_TIPO('08022'),T_TIPO('08029'),
      T_TIPO('08030'),T_TIPO('08031'),T_TIPO('08032'),T_TIPO('08033'),T_TIPO('08035'),T_TIPO('08037'),T_TIPO('08040'),T_TIPO('08041'),T_TIPO('08041'),T_TIPO('08046'),T_TIPO('08047'),T_TIPO('08051'),T_TIPO('08054'),
      T_TIPO('08056'),T_TIPO('08067'),T_TIPO('08068'),T_TIPO('08072'),T_TIPO('08073'),T_TIPO('08074'),T_TIPO('08076'),T_TIPO('08077'),T_TIPO('08086'),T_TIPO('08088'),T_TIPO('08089'),T_TIPO('08091'),T_TIPO('08092'),
      T_TIPO('08096'),T_TIPO('08098'),T_TIPO('08100'),T_TIPO('08101'),T_TIPO('08102'),T_TIPO('08105'),T_TIPO('08106'),T_TIPO('08107'),T_TIPO('08108'),T_TIPO('08110'),T_TIPO('08112'),T_TIPO('08112'),T_TIPO('08113'),
      T_TIPO('08114'),T_TIPO('08115'),T_TIPO('08117'),T_TIPO('08118'),T_TIPO('08120'),T_TIPO('08121'),T_TIPO('08123'),T_TIPO('08124'),T_TIPO('08125'),T_TIPO('08126'),T_TIPO('08135'),T_TIPO('08136'),T_TIPO('08141'),
      T_TIPO('08143'),T_TIPO('08147'),T_TIPO('08155'),T_TIPO('08156'),T_TIPO('08157'),T_TIPO('08158'),T_TIPO('08159'),T_TIPO('08161'),T_TIPO('08163'),T_TIPO('08167'),T_TIPO('08169'),T_TIPO('08172'),T_TIPO('08180'),
      T_TIPO('08181'),T_TIPO('08184'),T_TIPO('08187'),T_TIPO('08191'),T_TIPO('08194'),T_TIPO('08196'),T_TIPO('08197'),T_TIPO('08200'),T_TIPO('08202'),T_TIPO('08204'),T_TIPO('08205'),T_TIPO('08208'),T_TIPO('08209'),
      T_TIPO('08211'),T_TIPO('08211'),T_TIPO('08213'),T_TIPO('08214'),T_TIPO('08217'),T_TIPO('08218'),T_TIPO('08219'),T_TIPO('08221'),T_TIPO('08230'),T_TIPO('08231'),T_TIPO('08235'),T_TIPO('08238'),T_TIPO('08240'),
      T_TIPO('08244'),T_TIPO('08245'),T_TIPO('08246'),T_TIPO('08250'),T_TIPO('08251'),T_TIPO('08252'),T_TIPO('08260'),T_TIPO('08261'),T_TIPO('08262'),T_TIPO('08263'),T_TIPO('08264'),T_TIPO('08266'),T_TIPO('08267'),
      T_TIPO('08270'),T_TIPO('08270'),T_TIPO('08274'),T_TIPO('08279'),T_TIPO('08281'),T_TIPO('08282'),T_TIPO('08283'),T_TIPO('08284'),T_TIPO('08285'),T_TIPO('08289'),T_TIPO('08295'),T_TIPO('08298'),T_TIPO('08300'),
      T_TIPO('08301'),T_TIPO('08302'),T_TIPO('08305'),T_TIPO('08307'),T_TIPO('08904'),T_TIPO('08905'),T_TIPO('17015'),T_TIPO('17015'),T_TIPO('17019'),T_TIPO('17022'),T_TIPO('17023'),T_TIPO('17034'),T_TIPO('17047'),
      T_TIPO('17048'),T_TIPO('17056'),T_TIPO('17062'),T_TIPO('17066'),T_TIPO('17073'),T_TIPO('17079'),T_TIPO('17089'),T_TIPO('17092'),T_TIPO('17095'),T_TIPO('17110'),T_TIPO('17114'),T_TIPO('17117'),T_TIPO('17118'),
      T_TIPO('17137'),T_TIPO('17141'),T_TIPO('17147'),T_TIPO('17152'),T_TIPO('17155'),T_TIPO('17160'),T_TIPO('17163'),T_TIPO('17167'),T_TIPO('17169'),T_TIPO('17180'),T_TIPO('17181'),T_TIPO('17182'),T_TIPO('17185'),
      T_TIPO('17186'),T_TIPO('17199'),T_TIPO('17202'),T_TIPO('17215'),T_TIPO('17221'),T_TIPO('17226'),T_TIPO('25003'),T_TIPO('25011'),T_TIPO('25012'),T_TIPO('25016'),T_TIPO('25019'),T_TIPO('25021'),T_TIPO('25027'),
      T_TIPO('25034'),T_TIPO('25040'),T_TIPO('25050'),T_TIPO('25051'),T_TIPO('25058'),T_TIPO('25072'),T_TIPO('25093'),T_TIPO('25099'),T_TIPO('25110'),T_TIPO('25120'),T_TIPO('25135'),T_TIPO('25137'),T_TIPO('25158'),
      T_TIPO('25171'),T_TIPO('25172'),T_TIPO('25173'),T_TIPO('25203'),T_TIPO('25207'),T_TIPO('25209'),T_TIPO('25217'),T_TIPO('25234'),T_TIPO('25243'),T_TIPO('25244'),T_TIPO('43004'),T_TIPO('43011'),T_TIPO('43012'),
      T_TIPO('43014'),T_TIPO('43016'),T_TIPO('43037'),T_TIPO('43038'),T_TIPO('43042'),T_TIPO('43044'),T_TIPO('43047'),T_TIPO('43051'),T_TIPO('43055'),T_TIPO('43060'),T_TIPO('43064'),T_TIPO('43086'),T_TIPO('43092'),
      T_TIPO('43093'),T_TIPO('43094'),T_TIPO('43100'),T_TIPO('43104'),T_TIPO('43123'),T_TIPO('43131'),T_TIPO('43133'),T_TIPO('43136'),T_TIPO('43136'),T_TIPO('43138'),T_TIPO('43139'),T_TIPO('43145'),T_TIPO('43148'),
      T_TIPO('43153'),T_TIPO('43155'),T_TIPO('43156'),T_TIPO('43161'),T_TIPO('43163'),T_TIPO('43163'),T_TIPO('43171'),T_TIPO('43171'),T_TIPO('43904'),T_TIPO('43905'),T_TIPO('43905'),T_TIPO('43907')); 
    V_TMP_TIPO T_TIPO;

BEGIN

  DBMS_OUTPUT.PUT_LINE('[FIN] '||COUNTER||'... Datos del INICIO ');
  V_SQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TABLE||''' AND OWNER = '''||V_ESQUEMA||''' ';
  execute immediate V_SQL into COUNTER;

  DBMS_OUTPUT.PUT_LINE('[FIN] '||COUNTER||'... Datos del COUNTER');

  IF COUNTER > 0 THEN

  V_SQL  := 'UPDATE '||V_ESQUEMA||'.'|| V_TABLE ||' SET BORRADO = 1, FECHAMODIFICAR = SYSDATE, USUARIOMODIFICAR = ''HREOS-4940'' 
  WHERE DD_LOC_ID NOT IN (SELECT LOC.DD_LOC_ID FROM '||V_ESQUEMA_M||'.'||V_DDNAME||' LOC WHERE LOC.DD_LOC_CODIGO IN (''08001'',''08003'',''08006'',''08007'',''08009'',''08011'',
  ''08015'',''08019'',''08020'',''08022'',''08029'',''08030'',''08031'',''08032'',''08033'',''08035'',''08037'',''08040'',''08041'',''08041'',''08046'',''08047'',''08051'',''08054'',
  ''08056'',''08067'',''08068'',''08072'',''08073'',''08074'',''08076'',''08077'',''08086'',''08088'',''08089'',''08091'',''08092'',''08096'',''08098'',''08100'',''08101'',''08102'',
  ''08105'',''08106'',''08107'',''08108'',''08110'',''08112'',''08112'',''08113'',''08114'',''08115'',''08117'',''08118'',''08120'',''08121'',''08123'',''08124'',''08125'',''08126'',
  ''08135'',''08136'',''08141'',''08143'',''08147'',''08155'',''08156'',''08157'',''08158'',''08159'',''08161'',''08163'',''08167'',''08169'',''08172'',''08180'',''08181'',''08184'',
  ''08187'',''08191'',''08194'',''08196'',''08197'',''08200'',''08202'',''08204'',''08205'',''08208'',''08209'',''08211'',''08211'',''08213'',''08214'',''08217'',''08218'',''08219'',
  ''08221'',''08230'',''08231'',''08235'',''08238'',''08240'',''08244'',''08245'',''08246'',''08250'',''08251'',''08252'',''08260'',''08261'',''08262'',''08263'',''08264'',''08266'',
  ''08267'',''08270'',''08270'',''08274'',''08279'',''08281'',''08282'',''08283'',''08284'',''08285'',''08289'',''08295'',''08298'',''08300'',''08301'',''08302'',''08305'',''08307'',
  ''08904'',''08905'',''17015'',''17015'',''17019'',''17022'',''17023'',''17034'',''17047'',''17048'',''17056'',''17062'',''17066'',''17073'',''17079'',''17089'',''17092'',''17095'',
  ''17110'',''17114'',''17117'',''17118'',''17137'',''17141'',''17147'',''17152'',''17155'',''17160'',''17163'',''17167'',''17169'',''17180'',''17181'',''17182'',''17185'',''17186'',
  ''17199'',''17202'',''17215'',''17221'',''17226'',''25003'',''25011'',''25012'',''25016'',''25019'',''25021'',''25027'',''25034'',''25040'',''25050'',''25051'',''25058'',''25072'',
  ''25093'',''25099'',''25110'',''25120'',''25135'',''25137'',''25158'',''25171'',''25172'',''25173'',''25203'',''25207'',''25209'',''25217'',''25234'',''25243'',''25244'',''43004'',
  ''43011'',''43012'',''43014'',''43016'',''43037'',''43038'',''43042'',''43044'',''43047'',''43051'',''43055'',''43060'',''43064'',''43086'',''43092'',''43093'',''43094'',''43100'',
  ''43104'',''43123'',''43131'',''43133'',''43136'',''43136'',''43138'',''43139'',''43145'',''43148'',''43153'',''43155'',''43156'',''43161'',''43163'',''43163'',''43171'',''43171'',
  ''43904'',''43905'',''43905'',''43907''))';

  execute immediate V_SQL;
  -- LOOP Insertando valores en la tabla del diccionario
  

  END IF;

  COMMIT;
  DBMS_OUTPUT.PUT_LINE('[FIN] '||V_ESQUEMA||'.' || V_DDNAME ||'... Datos del diccionario insertado');

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.PUT_LINE('KO no modificado');
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;

/

EXIT