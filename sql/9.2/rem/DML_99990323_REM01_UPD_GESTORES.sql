--/*
--##########################################
--## AUTOR=DAP
--## FECHA_CREACION=20180215
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=2.0.15
--## INCIDENCIA_LINK=HREOS-3783
--## PRODUCTO=NO
--##
--## Finalidad: Introducir gestores
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

   V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar        
   V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
   V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
   V_COUNT NUMBER(16); -- Vble. para contar.
   ERR_NUM NUMBER(25); -- Vble. auxiliar para registrar errores en el script.
   ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
   V_TABLA VARCHAR2(27 CHAR) := 'ACT_GES_DIST_GESTORES'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
   V_USUARIO VARCHAR2(32 CHAR) := 'HREOS-3783';

BEGIN

   DBMS_OUTPUT.PUT_LINE('[INICIO]');

   V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD T1
      USING (SELECT GEE.GEE_ID, USU.USU_ID
          FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
          JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_ID = ACT.DD_SCM_ID 
              AND SCM.DD_SCM_CODIGO <> ''05'' AND SCM.DD_SCM_CODIGO <> ''06''
          JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
          JOIN '||V_ESQUEMA||'.DD_SCR_SUBCARTERA SCR ON SCR.DD_CRA_ID = CRA.DD_CRA_ID AND SCR.DD_SCR_ID = ACT.DD_SCR_ID
              AND SCR.DD_SCR_CODIGO <> DECODE(CRA.DD_CRA_CODIGO, ''01'', ''01'', ''02'', ''03'', ''03'', ''05'', ''04'', ''10'', ''05'', ''12'', ''09'', ''21'')
          JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE ON BIE.BIE_ID = ACT.BIE_ID
          JOIN '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA PRV ON PRV.DD_PRV_ID = BIE.DD_PRV_ID AND PRV.DD_PRV_CODIGO IN (''12'',''30'')
          JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GAC.ACT_ID = ACT.ACT_ID
          JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID AND GEE.BORRADO = 0
          JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_ID = GEE.DD_TGE_ID AND TGE.DD_TGE_CODIGO IN (''GGADM'',''GIAFORM'') 
          LEFT JOIN '||V_ESQUEMA||'.ACT_GES_DIST_GESTORES GES ON GES.TIPO_GESTOR = TGE.DD_TGE_CODIGO AND GES.COD_PROVINCIA = PRV.DD_PRV_CODIGO
              AND CRA.DD_CRA_CODIGO = LPAD(TO_CHAR(GES.COD_CARTERA),2,''0'')
          LEFT JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON USU.USU_USERNAME = GES.USERNAME) T2
      ON (T1.GEE_ID = T2.GEE_ID)
      WHEN MATCHED THEN UPDATE SET
          T1.USU_ID = T2.USU_ID, T1.USUARIOMODIFICAR = ''HREOS-3783'', T1.FECHAMODIFICAR = SYSDATE
      WHERE T1.USU_ID <> T2.USU_ID';
   EXECUTE IMMEDIATE V_MSQL;
   DBMS_OUTPUT.PUT_LINE('  [INFO] '||SQL%ROWCOUNT||' gestores en GEE actualizado');
   
   V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST T1
      USING (SELECT GEE.GEH_ID, USU.USU_ID
          FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
          JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_ID = ACT.DD_SCM_ID 
              AND SCM.DD_SCM_CODIGO <> ''05'' AND SCM.DD_SCM_CODIGO <> ''06''
          JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
          JOIN '||V_ESQUEMA||'.DD_SCR_SUBCARTERA SCR ON SCR.DD_CRA_ID = CRA.DD_CRA_ID AND SCR.DD_SCR_ID = ACT.DD_SCR_ID
              AND SCR.DD_SCR_CODIGO <> DECODE(CRA.DD_CRA_CODIGO, ''01'', ''01'', ''02'', ''03'', ''03'', ''05'', ''04'', ''10'', ''05'', ''12'', ''09'', ''21'')
          JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE ON BIE.BIE_ID = ACT.BIE_ID
          JOIN '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA PRV ON PRV.DD_PRV_ID = BIE.DD_PRV_ID AND PRV.DD_PRV_CODIGO IN (''12'',''30'')
          JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAC ON GAC.ACT_ID = ACT.ACT_ID
          JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEE ON GEE.GEH_ID = GAC.GEH_ID AND GEE.BORRADO = 0
          JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_ID = GEE.DD_TGE_ID AND TGE.DD_TGE_CODIGO IN (''GGADM'',''GIAFORM'') 
          LEFT JOIN '||V_ESQUEMA||'.ACT_GES_DIST_GESTORES GES ON GES.TIPO_GESTOR = TGE.DD_TGE_CODIGO AND GES.COD_PROVINCIA = PRV.DD_PRV_CODIGO
              AND CRA.DD_CRA_CODIGO = LPAD(TO_CHAR(GES.COD_CARTERA),2,''0'')
          LEFT JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON USU.USU_USERNAME = GES.USERNAME) T2
      ON (T1.GEH_ID = T2.GEH_ID)
      WHEN MATCHED THEN UPDATE SET
          T1.USU_ID = T2.USU_ID, T1.USUARIOMODIFICAR = ''HREOS-3783'', T1.FECHAMODIFICAR = SYSDATE
      WHERE T1.USU_ID <> T2.USU_ID';
   EXECUTE IMMEDIATE V_MSQL;
   DBMS_OUTPUT.PUT_LINE('  [INFO] '||SQL%ROWCOUNT||' gestores en GEH actualizado');
   
   COMMIT;
   DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
   WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
      DBMS_OUTPUT.PUT_LINE(ERR_MSG);
      ROLLBACK;
      RAISE;
END;
/
EXIT;