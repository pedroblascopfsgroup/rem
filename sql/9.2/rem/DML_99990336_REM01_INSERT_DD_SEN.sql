--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20180524
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.17
--## INCIDENCIA_LINK=REMVIP-783
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##   
--## INSTRUCCIONES:  
--## VERSIONES:
--##   0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar
    V_ESQUEMA VARCHAR2(30 CHAR):= 'REM01'; --'#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(30 CHAR):= 'REMMASTER'; --'#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(30 CHAR):= 'DD_SEN_SUB_ERR_GASTO_NKNM28';
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USUARIO VARCHAR2(50 CHAR):= 'REMVIP-783';
	DD_SEN_DESCRIPCION VARCHAR2(250 CHAR);
	DD_SEN_CODIGO VARCHAR2(50 CHAR);
	PL_OUTPUT VARCHAR2(32000 CHAR);

    TYPE T_JBV IS TABLE OF VARCHAR2(250 CHAR);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 

	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
		T_JBV('USUARIO NO AUTORIZADO A REALIZAR ACCION SOLICITADA', 'GMEUSNAE'),
		T_JBV('USUARIO NO AUTORIZADO A REALIZAR ALTA', 'GMEUNALE'),
		T_JBV('USUARIO NO AUTORIZADO A REALIZAR BAJA', 'GMEUNBAE'),
		T_JBV('USUARIO NO AUTORIZADO A REALIZAR MODIFICACION', 'GMEUNMOE'),
		T_JBV('CODIGO DISCRIMINADOR NO VALIDO', 'GMEDINVE'),
		T_JBV('VALOR NO VALIDO CODIGO INDICADOR NEGOCIABLE', 'GMECV01E'),
		T_JBV('VALOR NO VALIDO CODIGO INDICADOR ORIGEN DE LA ACCION  ', 'GMECV02E'),
		T_JBV('VALOR NO VALIDO CODIGO ESTADO DEL GASTO', 'GMECV03E'),
		T_JBV('VALOR NO VALIDO CODIGO GRUPO DE GASTO PARA ACTUALIZACION DE ACCIONES', 'GMECV04E'),
		T_JBV('VALOR NO VALIDO CODIGO MONEDA', 'GMECV05E'),
		T_JBV('SE DEBE TECLEAR FECHA FIN PERIODO VER PERIODICIDAD', 'GMEFFINE'),
		T_JBV('USUARIO NO AUTORIZADO A REALIZAR ACCION SOLICITADA', 'GMEUSNAE'),
		T_JBV('USUARIO NO AUTORIZADO A REALIZAR ALTA', 'GMEUNALE'),
		T_JBV('USUARIO NO AUTORIZADO A REALIZAR BAJA', 'GMEUNBAE'),
		T_JBV('USUARIO NO AUTORIZADO A REALIZAR MODIFICACION', 'GMEUNMOE'),
		T_JBV('CODIGO DISCRIMINADOR NO VALIDO', 'GMEDINVE'),
		T_JBV('VALOR NO VALIDO CODIGO INDICADOR NEGOCIABLE', 'GMECV01E'),
		T_JBV('VALOR NO VALIDO CODIGO INDICADOR ORIGEN DE LA ACCION', 'GMECV02E'),
		T_JBV('VALOR NO VALIDO CODIGO ESTADO DEL GASTO', 'GMECV03E'),
		T_JBV('VALOR NO VALIDO CODIGO GRUPO DE GASTO PARA ACTUALIZACION DE ACCIONES', 'GMECV04E'),
		T_JBV('VALOR NO VALIDO CODIGO MONEDA', 'GMECV05E'),
		T_JBV('SE DEBE TECLEAR FECHA FIN PERIODO VER PERIODICIDAD', 'GMEFFINE'),
		T_JBV('CON FIN PERIODO, PERIODICIDAD DEBE SER VARIOS PERIODOS', 'GMEFPTPE'),
		T_JBV('NO SE PUEDEN ACTUALIZAR ACCIONES DE HONORARIOS', 'GMENMHOE'),
		T_JBV('ALTA ACCION CON PRESUPUESTO NO AUTOMATICO, NO TECLEAR FECHAS INICIO Y FIN REA', 'GMEFEACE'),
		T_JBV('NO EXISTE UN PRESUPUESTO APROBADO, NO TECLEAR FECHAS INICIO Y FIN REAL ACCION', 'GMENOAPE'),
		T_JBV('EL IMPORTE DE DESCUENTO ES MAYOR QUE EL IMPORTE DEL GASTO', 'GMEIDMIE'),
		T_JBV('OBLIGATORIO TODOS LOS DATOS DE PAGO POR CONEXION', 'GMECONXE'),
		T_JBV('ERROR, LECTURA CONCEPTO CONTABLES CONTACTAR CON INFORMATICA', 'GMECCNEE'),
		T_JBV('ACCION NO MODIFICABLE POR SU SITUACION', 'GMEANMSE'),
		T_JBV('YA EXISTE LA ACCION', 'GMEAAYEE'),
		T_JBV('NO EXISTE LA ACCION A MODIFICAR', 'GMEAMNEE'),
		T_JBV('NO EXISTE LA ACCION A DAR DE BAJA', 'GMEABNEE'),
		T_JBV('NO ENCONTRADO TIPO/SUBTIPO DE ACCION', 'GMENETSE'),
		T_JBV('USUARIO PETICIONARIO NO ENCONTRADO', 'GMEEN01E'),
		T_JBV('OBLIGATORIO TIPO DE ACCION', 'GMEEN02E'),
		T_JBV('FECHA PREVISTA INICIO DEBE SER ME NOR A FECHA PREVISTA FIN', 'GMEEN05E'),
		T_JBV('OBLIGATORIO PETICIONARIO DE LA ACCION, USUARIO O ENTIDAD/OFICINA', 'GMEEN06E'),
		T_JBV('PETICIONARIO DEBE SER USUARIO O ENTIDAD/OFICINA, NO AMBOS', 'GMEEN07E'),
		T_JBV('PARA ENTIDAD PETICIONARIA SELECCIONADA OBLIGATORIO TECLEAR OFICINA', 'GMEEN08E'),
		T_JBV('SI OFICINA PETICIONARIA TECLEAR TAMBIEN LA ENTIDAD', 'GMEEN09E'),
		T_JBV('NO EXISTE LA ENTIDAD PETICIONARIA', 'GMEENTIE'),
		T_JBV('NO EXISTE LA ENTIDAD/OFICINA PETICIONARIA', 'GMECENTE'),
		T_JBV('OBLIGATORIO INDICAR DATOS DEL PROVEEDOR', 'GMEEN10E'),
		T_JBV('PARA EL ALTA DE UNA ACCION EL NUMERO DE ACCION (NUACCI) DEBE SER 0', 'GMEETPAE'),
		T_JBV('EL AñO DE LA FECHA PREVISTA INICIO NO PUEDE SER INFERIOR A 1995', 'GMEFMA1E'),
		T_JBV('EL AñO DE LA FECHA PREVISTA INICIO ES SUPERIOR EN DOS AÑOS AL DIA DE HOY', 'GMEFMY1E'),
		T_JBV('EL AñO DE LA FECHA PREVISTA FIN NO PUEDE SER INFERIOR A 1995', 'GMEFMA2E'),
		T_JBV('EL AñO DE LA FECHA PREVISTA FIN ES SUPERIOR EN DOS AñOS AL DIA DE HOY   ', 'GMEFMY2E'),
		T_JBV('EL AñO DE LA FECHA INICIO REAL NO PUEDE SER INFERIOR A 1995', 'GMEFMA3E'),
		T_JBV('EL AñO DE LA FECHA INICIO REAL ES SUPERIOR EN DOS AÑOS AL DIA DE HOY', 'GMEFMY3E'),
		T_JBV('EL AñO DE LA FECHA FIN REAL NO PUEDE SER INFERIOR A 1995', 'GMEFMA4E'),
		T_JBV('EL AñO DE LA FECHA FIN REAL ES SUPERIOR EN DOS AÑOS AL DIA DE HOY', 'GMEFMY4E'),
		T_JBV('NO MODIFICAR IMPORTE REAL DE LA ACCION', 'GMENMIRE'),
		T_JBV('ERROR CODIGO DE SITUACION INCOMPATIBLE CON BAJA', 'GMEEBCSE'),
		T_JBV('ERROR CODIGO DE SITUACION INCOMPATIBLE CON BAJA', 'GMEEBC2E'),
		T_JBV('ERROR, ACCION MANUAL TIENE PRESUPUESTO APROBADO', 'GMEPRAPE'),
		T_JBV('ACCION CON PRESUESTO MANUAL APROBADO, NO SE PEUDE DAR DE BAJA', 'GMEACPAE'),
		T_JBV('NO ENCONTRADO PROVEEDOR', 'GMENEPVE'),
		T_JBV('PARA MODIFICACION O BAJA ACCION EL NUMERO DE ACCION (NUACCI) NO PUEDE SER 0', 'GMEETP0E'),
		T_JBV('AGRUPACION NO ES DE PROVISION DE FONDOS', 'GMENEAPE'),
		T_JBV('ALTA TIPO DE ACCION PARA PROVISION DE FONDOS DEBE SER DE PRESUPUESTO AUTOMATI', 'GMEPFPAE'),
		T_JBV('FECHA INICIO REAL DEBE SER MENOR A FECHA FIN REAL', 'GMEEN11E'),
		T_JBV('ACCION CON PRESUPUESTO FACTURADO, NO SE PUEDE ACTUALIZAR', 'GMEAPF1E'),
		T_JBV('ACCION CON PRESUPUESTO FACTURADO, NO SE PUEDE ACTUALIZAR', 'GMEAPF2E'),
		T_JBV('VALOR NO VALIDO PERIODICIDAD DE PAGO', 'GMECV06E'),
		T_JBV('ERROR, SERVICIO SECUNDARIO NCNB09.CONTACTAR CON INFORMATICA', 'GMESEP1E'),
		T_JBV('USUARIO NO AUTORIZADO A MODIFICAR ACCION DADA DE ALTA AUTOMATICAMENTE', 'GMESCA1E'),
		T_JBV('USUARIO NO AUTORIZADO A DAR DE BAJA ACCION DADA DE ALTA AUTOMATICAMENTE', 'GMESCA2E'),
		T_JBV('ENTIDAD DEL ACTIVO NO ES VALIDA PARA ACCIONES', 'GMEENTAE'),
		T_JBV('ENTIDAD DEL ACTIVO DE LA AGRUPACION NO ES VALIDA PARA ACCIONES', 'GMEENTLE'),
		T_JBV('ALTA TIPO ACCION AJUSTES SE DEBE REALIZAR DESDE BOTON AJUSTES EN LA FACTURA  ', 'GMETAJUE'),
		T_JBV('SOCIEDAD PATRIMONIAL DEL ACTIVO NO VALIDA PARA ACCIONES', 'GMESP0AE'),
		T_JBV('SOCIEDAD PATRIMONIAL DEL ACTIVO DEL LOTE NO VALIDA PARA ACCIONES', 'GMESP0LE'),
		T_JBV('TIPO ACCION NO VALIDA,ACTIVO ORIGEN NO INTEGRADA SIN Nº FICHA INM', 'GMETANVE'),
		T_JBV('EL INDICADOR DE ACCION ACTIVABLE DEL TIPO/SUBTIPO ACCION NO ESTA ESPECIFICADO', 'GMEITSAE'),
		T_JBV('ALTA ACCION NO POSIBLE POR PROHIBICION OPERAR CON PROVEEDOR PBC&FT', 'GMEPBCAE'),
		T_JBV('MODIFICACION PROVEEEDOR NO POSIBLE, PROVEEDOR CON PROHIBICION OPERAR PBC&FT', 'GMEPBCME'),
		T_JBV('CODIGO DISCRIMINADOR FUNCION NO VALIDO', 'GMEDFN1E'),
		T_JBV('CODIGO DISCRIMINADOR Y DISCRIMINADOR FUNCION NO COMPATIBLES', 'GMEDFN2E'),
		T_JBV('VALOR NO VALIDO INDICADOR ICONO IPLUS', 'GMECV07E'),
		T_JBV('ACCION NO ES DE ACTIVO INDIVIDUAL', 'GMECT01E'),
		T_JBV('ACCION FACTURADA', 'GMECT02E'),
		T_JBV('ACCION YA ESTA VERIRICADA ', 'GMECT03E'),
		T_JBV('TIPO ACCION NO ES DE HONORARIOS', 'GMECT04E'),
		T_JBV('FACTURA NO SE ENCUENTRA RECHAZADA', 'GMECT05E'),
		T_JBV('USUARIO NO AUTORIZADO A ACTUALIZAR LA ACCION DEL ACTIVO', 'GMESCA3E'),
		T_JBV('USUARIO NO AUTORIZADO A ACTUALIZAR LA ACCION DEL ACTIVO', 'GMESCA4E'),
		T_JBV('TIPO ACCION NO PERMITADA A SOCIEDAD PATRIMONIAL DISTINTA A SAREB', 'GMETPASE'),
		T_JBV('TIPO ACCION ESTA DADA DE BAJA', 'GMETABJE')
	); 
	V_TMP_JBV T_JBV;

BEGIN

	PL_OUTPUT := '[INICIO]' || CHR(10);

	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	LOOP

		V_TMP_JBV := V_JBV(I);

			DD_SEN_DESCRIPCION  := UPPER(SUBSTR(TRIM(V_TMP_JBV(1)),1,1)) || LOWER(SUBSTR(TRIM(V_TMP_JBV(1)),2));
			DD_SEN_CODIGO  := TRIM(V_TMP_JBV(2));

		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (DD_SEN_ID, DD_SEG_ID, DD_SEN_CODIGO, DD_SEN_DESCRIPCION, DD_SEN_DESCRIPCION_LARGA, USUARIOCREAR, FECHACREAR) 
			SELECT '||V_ESQUEMA||'.S_'||V_TABLA||'.NEXTVAL, SEG.DD_SEG_ID, '''||DD_SEN_CODIGO||''', '''||DD_SEN_DESCRIPCION||''', '''||DD_SEN_DESCRIPCION||''', '''||V_USUARIO||''', SYSDATE
			FROM '||V_ESQUEMA||'.DD_SEG_SUBTIPO_ERROR_GASTO SEG
			JOIN '||V_ESQUEMA||'.DD_TEG_TIPO_ERROR_GASTO TEG ON TEG.DD_TEG_ID = SEG.DD_TEG_ID
			WHERE SEG.DD_SEG_CODIGO = ''300'' AND TEG.DD_TEG_CODIGO = ''04'' AND NOT EXISTS (
					SELECT 1
					FROM '||V_ESQUEMA||'.'||V_TABLA||' SEN
					WHERE SEG.DD_SEG_ID = SEN.DD_SEG_ID AND SEN.DD_SEN_CODIGO = '''||DD_SEN_CODIGO||'''
				)';
		EXECUTE IMMEDIATE V_SQL;
		
		IF SQL%ROWCOUNT = 1 THEN
			PL_OUTPUT := PL_OUTPUT || '	[INFO] Se ha creado el subtipo error de gasto NKNM28' || DD_SEN_DESCRIPCION || CHR(10);
		ELSIF SQL%ROWCOUNT = 0 THEN
			PL_OUTPUT := PL_OUTPUT || '	[INFO] Ya existe el subtipo error de gasto NKNM28' || DD_SEN_DESCRIPCION || CHR(10);
		END IF;

	END LOOP;

	PL_OUTPUT := PL_OUTPUT || '[FIN]' || CHR(10);

	COMMIT;

	DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);

EXCEPTION
    WHEN OTHERS THEN
 PL_OUTPUT := PL_OUTPUT ||'[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE) || CHR(10);
 PL_OUTPUT := PL_OUTPUT ||'-----------------------------------------------------------' || CHR(10);
 PL_OUTPUT := PL_OUTPUT ||SQLERRM || CHR(10);
 DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
 ROLLBACK;
 RAISE;
END;
/
EXIT;