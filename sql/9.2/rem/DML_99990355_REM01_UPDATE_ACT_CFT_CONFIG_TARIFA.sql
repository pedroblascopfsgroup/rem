--/*
--##########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20181008
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-1729
--## PRODUCTO=NO
--##
--## Finalidad: Script que modifica tarifas en ACT_CFT_CONFIG_TARIFA
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_NUM_SEQUENCE NUMBER(16); -- Vble. auxiliar para almacenar el número de secuencia actual.
    V_NUM_MAXID NUMBER(16); -- Vble. auxiliar para almacenar el número de secuencia máxima utilizada en los registros.
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates

    V_TEXT_TABLA VARCHAR2(27 CHAR) := 'ACT_CFT_CONFIG_TARIFA'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_USU_MODIFICAR VARCHAR2(30 CHAR) := '''REMVIP-1729'''; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.

    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    --	TIPO_TARIFA_CODIGO,	PRECIO_UNITARIO,	CODIGO_CARTERA
	 T_TIPO_DATA('VER2','57.56','02'),
	 T_TIPO_DATA('OM237','5.67','02'),
	 T_TIPO_DATA('OM1','9.51','02'),
	 T_TIPO_DATA('OM228','184.03','02'),
	 T_TIPO_DATA('OM3','88.10','02'),
	 T_TIPO_DATA('OM4','87.64','02'),
	 T_TIPO_DATA('OM5','117.53','02'),
	 T_TIPO_DATA('OM206','300.00','02'),
	 T_TIPO_DATA('VACI-LIMP3','120.37','02'),
	 T_TIPO_DATA('OM211','210.32','02'),
	 T_TIPO_DATA('OM141','24.95','02'),
	 T_TIPO_DATA('SAB-CER8','42.27','02'),
	 T_TIPO_DATA('SOL4','0.12','02'),
	 T_TIPO_DATA('OM13','44.05','02'),
	 T_TIPO_DATA('OM14','60.31','02'),
	 T_TIPO_DATA('OM15','78.87','02'),
	 T_TIPO_DATA('OM16','147.95','02'),
	 T_TIPO_DATA('OM17','70.11','02'),
	 T_TIPO_DATA('OM18','99.55','02'),
	 T_TIPO_DATA('OM19','140.58','02'),
	 T_TIPO_DATA('OM20','212.91','02'),
	 T_TIPO_DATA('OM21','111.86','02'),
	 T_TIPO_DATA('OM38','2.97','02'),
	 T_TIPO_DATA('OM23','90.65','02'),
	 T_TIPO_DATA('OM40','3.41','02'),
	 T_TIPO_DATA('OM25','90.65','02'),
	 T_TIPO_DATA('OM26','26.99','02'),
	 T_TIPO_DATA('OM28','39.61','02'),
	 T_TIPO_DATA('OM29','23.60','02'),
	 T_TIPO_DATA('OM91','84.63','02'),
	 T_TIPO_DATA('OM31','39.18','02'),
	 T_TIPO_DATA('OM32','36.28','02'),
	 T_TIPO_DATA('OM33','22.17','02'),
	 T_TIPO_DATA('OM34','21.39','02'),
	 T_TIPO_DATA('OM35','82.48','02'),
	 T_TIPO_DATA('OM36','107.22','02'),
	 T_TIPO_DATA('OM88','67.02','02'),
	 T_TIPO_DATA('OM89','86.81','02'),
	 T_TIPO_DATA('OM90','94.45','02'),
	 T_TIPO_DATA('OM42','4.14','02'),
	 T_TIPO_DATA('BOL5','120.00','02'),
	 T_TIPO_DATA('BOL3','412.40','02'),
	 T_TIPO_DATA('BOL2','257.75','02'),
	 T_TIPO_DATA('OM45','79.64','02'),
	 T_TIPO_DATA('BOL1','150.00','02'),
	 T_TIPO_DATA('OM44','4.21','02'),
	 T_TIPO_DATA('OM46','4.95','02'),
	 T_TIPO_DATA('OM50','5.16','02'),
	 T_TIPO_DATA('OM122','5.60','02'),
	 T_TIPO_DATA('OM51','86.81','02'),
	 T_TIPO_DATA('OM236','5.67','02'),
	 T_TIPO_DATA('OM48','6.06','02'),
	 T_TIPO_DATA('OM259','22.88','02'),
	 T_TIPO_DATA('OM52','6.37','02'),
	 T_TIPO_DATA('OM159','6.47','02'),
	 T_TIPO_DATA('OM266','4.70','02'),
	 T_TIPO_DATA('OM58','31.54','02'),
	 T_TIPO_DATA('OM59','10.05','02'),
	 T_TIPO_DATA('OM270','3.04','02'),
	 T_TIPO_DATA('OM265','1.84','02'),
	 T_TIPO_DATA('OM269','2.07','02'),
	 T_TIPO_DATA('OM124','10.87','02'),
	 T_TIPO_DATA('OM123','6.92','02'),
	 T_TIPO_DATA('OM171','7.49','02'),
	 T_TIPO_DATA('OM247','8.30','02'),
	 T_TIPO_DATA('OM76','8.66','02'),
	 T_TIPO_DATA('OM75','8.66','02'),
	 T_TIPO_DATA('OM125','8.71','02'),
	 T_TIPO_DATA('OM197','11.95','02'),
	 T_TIPO_DATA('SOL1','0.36','02'),
	 T_TIPO_DATA('SOL2','0.77','02'),
	 T_TIPO_DATA('OM166','43.30','02'),
	 T_TIPO_DATA('OM167','41.24','02'),
	 T_TIPO_DATA('OM168','73.78','02'),
	 T_TIPO_DATA('OM164','35.84','02'),
	 T_TIPO_DATA('OM162','25.17','02'),
	 T_TIPO_DATA('OM163','49.80','02'),
	 T_TIPO_DATA('OM77','8.25','02'),
	 T_TIPO_DATA('OM78','23.74','02'),
	 T_TIPO_DATA('OM74','8.25','02'),
	 T_TIPO_DATA('SOL5','2.64','02'),
	 T_TIPO_DATA('OM73','12.37','02'),
	 T_TIPO_DATA('OM161','13.40','02'),
	 T_TIPO_DATA('OM258','13.51','02'),
	 T_TIPO_DATA('OM198','14.93','02'),
	 T_TIPO_DATA('OM169','76.86','02'),
	 T_TIPO_DATA('OM165','61.39','02'),
	 T_TIPO_DATA('OM24','16.41','02'),
	 T_TIPO_DATA('SOL6','17.78','02'),
	 T_TIPO_DATA('OM196','19.32','02'),
	 T_TIPO_DATA('OM257','19.38','02'),
	 T_TIPO_DATA('OM97','341.69','02'),
	 T_TIPO_DATA('OM267','19.84','02'),
	 T_TIPO_DATA('OM242','20.48','02'),
	 T_TIPO_DATA('OM67','21.20','02'),
	 T_TIPO_DATA('OM69','66.11','02'),
	 T_TIPO_DATA('OM68','65.21','02'),
	 T_TIPO_DATA('OM70','96.54','02'),
	 T_TIPO_DATA('OM104','14.90','02'),
	 T_TIPO_DATA('OM105','4.10','02'),
	 T_TIPO_DATA('OM106','5.84','02'),
	 T_TIPO_DATA('OM107','22.69','02'),
	 T_TIPO_DATA('OM108','37.77','02'),
	 T_TIPO_DATA('OM109','35.87','02'),
	 T_TIPO_DATA('OM110','43.08','02'),
	 T_TIPO_DATA('OM111','56.47','02'),
	 T_TIPO_DATA('OM112','69.20','02'),
	 T_TIPO_DATA('OM113','67.13','02'),
	 T_TIPO_DATA('OM114','60.28','02'),
	 T_TIPO_DATA('OM115','66.57','02'),
	 T_TIPO_DATA('OM116','77.39','02'),
	 T_TIPO_DATA('OM117','24.49','02'),
	 T_TIPO_DATA('OM118','20.42','02'),
	 T_TIPO_DATA('OM119','27.22','02'),
	 T_TIPO_DATA('OM120','31.54','02'),
	 T_TIPO_DATA('OM121','36.02','02'),
	 T_TIPO_DATA('OM71','119.71','02'),
	 T_TIPO_DATA('OM72','18.74','02'),
	 T_TIPO_DATA('OM199','21.33','02'),
	 T_TIPO_DATA('VER3','21.59','02'),
	 T_TIPO_DATA('OM126','9.95','02'),
	 T_TIPO_DATA('OM127','25.27','02'),
	 T_TIPO_DATA('OM128','60.50','02'),
	 T_TIPO_DATA('OM129','80.50','02'),
	 T_TIPO_DATA('OM130','142.11','02'),
	 T_TIPO_DATA('OM131','210.28','02'),
	 T_TIPO_DATA('OM132','36.40','02'),
	 T_TIPO_DATA('TAP1','23.00','02'),
	 T_TIPO_DATA('OM134','68.82','02'),
	 T_TIPO_DATA('OM67','23.97','02'),
	 T_TIPO_DATA('OM260','24.51','02'),
	 T_TIPO_DATA('OM268','27.56','02'),
	 T_TIPO_DATA('SAB-CER9','43.30','02'),
	 T_TIPO_DATA('OM137','28.07','02'),
	 T_TIPO_DATA('OM138','41.24','02'),
	 T_TIPO_DATA('OM139','49.23','02'),
	 T_TIPO_DATA('OM140','56.15','02'),
	 T_TIPO_DATA('OM8','28.07','02'),
	 T_TIPO_DATA('OM142','31.14','02'),
	 T_TIPO_DATA('OM143','39.80','02'),
	 T_TIPO_DATA('OM144','47.68','02'),
	 T_TIPO_DATA('OM145','25.78','02'),
	 T_TIPO_DATA('OM146','30.93','02'),
	 T_TIPO_DATA('OM147','41.24','02'),
	 T_TIPO_DATA('OM148','50.61','02'),
	 T_TIPO_DATA('OM149','36.09','02'),
	 T_TIPO_DATA('OM150','24.54','02'),
	 T_TIPO_DATA('OM151','25.78','02'),
	 T_TIPO_DATA('OM152','18.76','02'),
	 T_TIPO_DATA('OM153','27.21','02'),
	 T_TIPO_DATA('OM154','19.43','02'),
	 T_TIPO_DATA('OM155','6.76','02'),
	 T_TIPO_DATA('OM156','30.91','02'),
	 T_TIPO_DATA('OM157','30.91','02'),
	 T_TIPO_DATA('OM158','22.79','02'),
	 T_TIPO_DATA('OM186','28.15','02'),
	 T_TIPO_DATA('OM30','29.60','02'),
	 T_TIPO_DATA('OM233','21.91','02'),
	 T_TIPO_DATA('OM234','39.44','02'),
	 T_TIPO_DATA('OM235','74.49','02'),
	 T_TIPO_DATA('OM203','31.92','02'),
	 T_TIPO_DATA('OM43','32.48','02'),
	 T_TIPO_DATA('OM256','33.73','02'),
	 T_TIPO_DATA('TAP2','34.00','02'),
	 T_TIPO_DATA('OM202','34.60','02'),
	 T_TIPO_DATA('OM39','34.62','02'),
	 T_TIPO_DATA('OM170','5.90','02'),
	 T_TIPO_DATA('OM82','36.09','02'),
	 T_TIPO_DATA('OM172','8.69','02'),
	 T_TIPO_DATA('OM173','3.52','02'),
	 T_TIPO_DATA('OM174','18.95','02'),
	 T_TIPO_DATA('OM175','18.95','02'),
	 T_TIPO_DATA('OM176','18.95','02'),
	 T_TIPO_DATA('OM177','18.95','02'),
	 T_TIPO_DATA('OM178','18.95','02'),
	 T_TIPO_DATA('OM179','18.95','02'),
	 T_TIPO_DATA('OM180','18.95','02'),
	 T_TIPO_DATA('OM181','18.95','02'),
	 T_TIPO_DATA('OM182','18.95','02'),
	 T_TIPO_DATA('OM183','18.95','02'),
	 T_TIPO_DATA('OM184','17.63','02'),
	 T_TIPO_DATA('OM185','16.24','02'),
	 T_TIPO_DATA('SAB-CER7','40.00','02'),
	 T_TIPO_DATA('OM187','20.95','02'),
	 T_TIPO_DATA('OM188','17.32','02'),
	 T_TIPO_DATA('OM189','16.78','02'),
	 T_TIPO_DATA('OM190','16.24','02'),
	 T_TIPO_DATA('OM191','16.24','02'),
	 T_TIPO_DATA('OM192','125.00','02'),
	 T_TIPO_DATA('OM193','75.25','02'),
	 T_TIPO_DATA('SAB-CER10','42.51','02'),
	 T_TIPO_DATA('OM205','412.40','02'),
	 T_TIPO_DATA('OM204','412.40','02'),
	 T_TIPO_DATA('OM272','46.00','02'),
	 T_TIPO_DATA('OM37','46.23','02'),
	 T_TIPO_DATA('OM273','121.55','02'),
	 T_TIPO_DATA('OM133','46.40','02'),
	 T_TIPO_DATA('OM9','48.37','02'),
	 T_TIPO_DATA('OM248','53.13','02'),
	 T_TIPO_DATA('SOL7','54.30','02'),
	 T_TIPO_DATA('OM100','146.84','02'),
	 T_TIPO_DATA('OM101','104.44','02'),
	 T_TIPO_DATA('OM102','120.92','02'),
	 T_TIPO_DATA('OM84','90.82','02'),
	 T_TIPO_DATA('OM85','107.33','02'),
	 T_TIPO_DATA('OM103','209.84','02'),
	 T_TIPO_DATA('OM81','30.93','02'),
	 T_TIPO_DATA('OM231','157.74','02'),
	 T_TIPO_DATA('OM232','227.85','02'),
	 T_TIPO_DATA('OM229','113.93','02'),
	 T_TIPO_DATA('OM230','131.45','02'),
	 T_TIPO_DATA('BOL4','90.00','02'),
	 T_TIPO_DATA('ANTIOC1','788.72','02'),
	 T_TIPO_DATA('LPO1','103.10','02'),
	 T_TIPO_DATA('LPO2','40.00','02'),
	 T_TIPO_DATA('INF4','21.65','02'),
	 T_TIPO_DATA('OM253','216.86','02'),
	 T_TIPO_DATA('OM254','236.01','02'),
	 T_TIPO_DATA('OM225','30.93','02'),
	 T_TIPO_DATA('OM271','56.88','02'),
	 T_TIPO_DATA('OM209','58.77','02'),
	 T_TIPO_DATA('OM10','64.05','02'),
	 T_TIPO_DATA('OM261','73.47','02'),
	 T_TIPO_DATA('OM244','73.62','02'),
	 T_TIPO_DATA('OM243','73.72','02'),
	 T_TIPO_DATA('OM92','61.97','02'),
	 T_TIPO_DATA('OM93','83.30','02'),
	 T_TIPO_DATA('OM94','95.18','02'),
	 T_TIPO_DATA('OM95','105.13','02'),
	 T_TIPO_DATA('OM262','82.83','02'),
	 T_TIPO_DATA('OM223','74.11','02'),
	 T_TIPO_DATA('OM255','80.43','02'),
	 T_TIPO_DATA('SAB-CER2','113.29','02'),
	 T_TIPO_DATA('OM218','61.86','02'),
	 T_TIPO_DATA('SAB-CER3','127.03','02'),
	 T_TIPO_DATA('SAB-CER4','169.69','02'),
	 T_TIPO_DATA('OM221','9.28','02'),
	 T_TIPO_DATA('SAB-CER1','77.74','02'),
	 T_TIPO_DATA('SAB-CER5','89.85','02'),
	 T_TIPO_DATA('OM251','80.73','02'),
	 T_TIPO_DATA('OM49','80.83','02'),
	 T_TIPO_DATA('OM226','39.03','02'),
	 T_TIPO_DATA('OM227','165.75','02'),
	 T_TIPO_DATA('OM41','86.38','02'),
	 T_TIPO_DATA('OM11','10.79','02'),
	 T_TIPO_DATA('OM12','38.44','02'),
	 T_TIPO_DATA('OM47','89.89','02'),
	 T_TIPO_DATA('OM222','90.20','02'),
	 T_TIPO_DATA('SAB-CER6','9.28','02'),
	 T_TIPO_DATA('OM252','90.42','02'),
	 T_TIPO_DATA('OM6','92.10','02'),
	 T_TIPO_DATA('OM27','25.69','02'),
	 T_TIPO_DATA('OM22','152.24','02'),
	 T_TIPO_DATA('OM238','49.49','02'),
	 T_TIPO_DATA('TAP3','10.74','02'),
	 T_TIPO_DATA('OM54','50.94','02'),
	 T_TIPO_DATA('OM53','40.60','02'),
	 T_TIPO_DATA('OM55','63.41','02'),
	 T_TIPO_DATA('SS3','14.12','02'),
	 T_TIPO_DATA('ALR5','92.69','02'),
	 T_TIPO_DATA('OM56','84.71','02'),
	 T_TIPO_DATA('OM63','33.51','02'),
	 T_TIPO_DATA('OM62','22.17','02'),
	 T_TIPO_DATA('OM64','79.90','02'),
	 T_TIPO_DATA('OM65','103.10','02'),
	 T_TIPO_DATA('OM61','29.15','02'),
	 T_TIPO_DATA('OM60','20.62','02'),
	 T_TIPO_DATA('OM79','30.93','02'),
	 T_TIPO_DATA('OM80','20.62','02'),
	 T_TIPO_DATA('OM57','24.09','02'),
	 T_TIPO_DATA('OM201','107.22','02'),
	 T_TIPO_DATA('OM7','116.17','02'),
	 T_TIPO_DATA('OM200','119.08','02'),
	 T_TIPO_DATA('OM2','129.57','02'),
	 T_TIPO_DATA('OM208','145.17','02'),
	 T_TIPO_DATA('OM210','157.74','02'),
	 T_TIPO_DATA('OM81','137.12','02'),
	 T_TIPO_DATA('OM220','162.30','02'),
	 T_TIPO_DATA('SOL9','166.67','02'),
	 T_TIPO_DATA('OM263','175.27','02'),
	 T_TIPO_DATA('OM160','178.24','02'),
	 T_TIPO_DATA('OM217','216.51','02'),
	 T_TIPO_DATA('OM249','241.30','02'),
	 T_TIPO_DATA('VACI-LIMP2','194.50','02'),
	 T_TIPO_DATA('VACI-LIMP1','66.76','02'),
	 T_TIPO_DATA('SOL10','256.07','02'),
	 T_TIPO_DATA('OM207','258.41','02'),
	 T_TIPO_DATA('OM212','262.91','02'),
	 T_TIPO_DATA('SOL11','264.32','02'),
	 T_TIPO_DATA('OM264','350.54','02'),
	 T_TIPO_DATA('OM250','350.76','02'),
	 T_TIPO_DATA('OM213','355.20','02'),
	 T_TIPO_DATA('OM224','135.42','02'),
	 T_TIPO_DATA('SOL12','280.00','02'),
	 T_TIPO_DATA('SOL8','179.67','02'),
	 T_TIPO_DATA('OM239','1488.33','02'),
	 T_TIPO_DATA('OM216','288.07','02'),
	 T_TIPO_DATA('OM214','220.64','02'),
	 T_TIPO_DATA('OM215','265.65','02'),
	 T_TIPO_DATA('OM219','30.93','02'),
	 T_TIPO_DATA('VER1','36.09','02')
    ); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

BEGIN	

	DBMS_OUTPUT.PUT_LINE('[INICIO]');


	-- LOOP para insertar los valores --
	DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICACIÓN EN '||V_TEXT_TABLA);
	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
	LOOP

		V_TMP_TIPO_DATA := V_TIPO_DATA(I);

		-- Comprobar el dato a insertar.
		V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE 
						DD_TTF_ID = (SELECT DD_TTF_ID FROM '||V_ESQUEMA||'.DD_TTF_TIPO_TARIFA WHERE DD_TTF_CODIGO = '''||V_TMP_TIPO_DATA(1)||''') 
						AND DD_CRA_ID = (SELECT DD_CRA_ID FROM '||V_ESQUEMA||'.DD_CRA_CARTERA WHERE DD_CRA_CODIGO = '''||V_TMP_TIPO_DATA(3)||''')';
		EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;

        IF V_NUM_TABLAS > 0 THEN

        	V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||V_TEXT_TABLA||' CFT 
        				SET	CFT.CFT_PRECIO_UNITARIO = '||V_TMP_TIPO_DATA(2)||',
        				CFT.USUARIOMODIFICAR = '||V_USU_MODIFICAR||',
        				CFT.FECHAMODIFICAR = SYSDATE
        				WHERE CFT.DD_TTF_ID = (SELECT DD_TTF_ID FROM '||V_ESQUEMA||'.DD_TTF_TIPO_TARIFA WHERE DD_TTF_CODIGO = '''||V_TMP_TIPO_DATA(1)||''') 
        				AND CFT.DD_CRA_ID = (SELECT DD_CRA_ID FROM '||V_ESQUEMA||'.DD_CRA_CARTERA WHERE DD_CRA_CODIGO = '''||V_TMP_TIPO_DATA(3)||''')';
			EXECUTE IMMEDIATE V_MSQL;
			DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICACIÓN EN '||V_TEXT_TABLA);
			DBMS_OUTPUT.PUT_LINE('ACTUALIZADA LA TARIFA DEL TIPO : '||TRIM(V_TMP_TIPO_DATA(1))||' EN LA CARTERA CON CÓDIGO: '||TRIM(V_TMP_TIPO_DATA(3))||' A '||TRIM(V_TMP_TIPO_DATA(2)));
			V_COUNT_UPDATE := V_COUNT_UPDATE + 1;

		END IF;
	END LOOP;

	COMMIT;
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado en total '||V_COUNT_UPDATE||' registros en la tabla ACT_CFT_CONFIG_TARIFA');
	DBMS_OUTPUT.PUT_LINE('[FIN]: TABLA '||V_TEXT_TABLA||' ACTUALIZADA CORRECTAMENTE ');


EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;
/
EXIT
