--/*
--##########################################
--## AUTOR=DAVID GONZALEZ
--## FECHA_CREACION=20160422
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.1
--## INCIDENCIA_LINK=0
--## PRODUCTO=NO
--##
--## Finalidad: Script que añade en USD_USUARIOS_DESPACHOS los datos añadidos en T_ARRAY_FUNCION
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	
    V_TEXT1 VARCHAR2(2400 CHAR); -- Vble. auxiliar
    V_ENTIDAD_ID NUMBER(16);
    V_ID NUMBER(16);
    
    TYPE T_FUNCION IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_FUNCION IS TABLE OF T_FUNCION;
    V_FUNCION T_ARRAY_FUNCION := T_ARRAY_FUNCION(
      T_FUNCION('B87105821', 'REMPROV'),
	  T_FUNCION('B98562036', 'REMPROV'),
	  T_FUNCION('B82450727', 'REMPROV'),
	  T_FUNCION('B98306012', 'REMPROV'),
	  T_FUNCION('21430198V', 'REMPROV'),
	  T_FUNCION('22518378K', 'REMPROV'),
	  T_FUNCION('B96565981', 'REMPROV'),
	  T_FUNCION('B58409269', 'REMPROV'),
	  T_FUNCION('B66610239', 'REMPROV'),
	  T_FUNCION('01073243V', 'REMPROV'),
	  T_FUNCION('E98442098', 'REMPROV'),
	  T_FUNCION('B35921642', 'REMPROV'),
	  T_FUNCION('B97387088', 'REMPROV'),
	  T_FUNCION('B85736023', 'REMPROV'),
	  T_FUNCION('B26459560', 'REMPROV'),
	  T_FUNCION('7804975V', 'REMPROV'),
	  T_FUNCION('B85343721', 'REMPROV'),
	  T_FUNCION('B96818828', 'REMPROV'),
	  T_FUNCION('J82522061', 'REMPROV'),
	  T_FUNCION('J64395726', 'REMPROV'),
	  T_FUNCION('B85752905', 'REMPROV'),
	  T_FUNCION('A28346054', 'REMPROV'),
	  T_FUNCION('B97518138', 'REMPROV'),
	  T_FUNCION('B85345452', 'REMPROV'),
	  T_FUNCION('B63899660', 'REMPROV'),
	  T_FUNCION('B72265986', 'REMPROV'),
	  T_FUNCION('B86546900', 'REMPROV'),
	  T_FUNCION('77614922L', 'REMPROV'),
	  T_FUNCION('B85097962', 'REMPROV'),
	  T_FUNCION('A80241789', 'REMPROV'),
	  T_FUNCION('42793075B', 'REMPROV'),
	  T_FUNCION('B98020001', 'REMPROV'),
	  T_FUNCION('B95299947', 'REMPROV'),
	  T_FUNCION('B03830510', 'REMPROV'),
	  T_FUNCION('A80884372', 'REMPROV'),
	  T_FUNCION('33399807N', 'REMPROV'),
	  T_FUNCION('B93115921', 'REMPROV'),
	  T_FUNCION('B90107731', 'REMPROV'),
	  T_FUNCION('B86880127', 'REMPROV'),
	  T_FUNCION('A78601945', 'REMPROV'),
	  T_FUNCION('B98493190', 'REMPROV'),
	  T_FUNCION('B84105899', 'REMPROV'),
	  T_FUNCION('A79222709', 'REMPROV'),
	  T_FUNCION('B05201249', 'REMPROV'),
	  T_FUNCION('43512163G', 'REMPROV'),
	  T_FUNCION('07214799K', 'REMPROV'),
	  T_FUNCION('B80463565', 'REMPROV'),
	  T_FUNCION('32403209G', 'REMPROV'),
	  T_FUNCION('E83658567', 'REMPROV'),
	  T_FUNCION('22685627Z', 'REMPROV'),
	  T_FUNCION('B85884336', 'REMPROV'),
	  T_FUNCION('B85735967', 'REMPROV'),
	  T_FUNCION('A84259027', 'REMPROV'),
	  T_FUNCION('B91703777', 'REMPROV'),
	  T_FUNCION('B29830577', 'REMPROV'),
	  T_FUNCION('B45608270', 'REMPROV'),
	  T_FUNCION('50801610S', 'REMPROV'),
	  T_FUNCION('05239632V', 'REMPROV'),
	  T_FUNCION('B82622713', 'REMPROV'),
	  T_FUNCION('J82985573', 'REMPROV'),
	  T_FUNCION('B19504851', 'REMPROV'),
	  T_FUNCION('25108836N', 'REMPROV'),
	  T_FUNCION('22470753Y', 'REMPROV'),
	  T_FUNCION('22624330N', 'REMPROV'),
	  T_FUNCION('B84216993', 'REMPROV'),
	  T_FUNCION('B83580803', 'REMPROV'),
	  T_FUNCION('J91899609', 'REMPROV'),
	  T_FUNCION('E84026277', 'REMPROV'),
	  T_FUNCION('B82802075', 'REMPROV'),
	  T_FUNCION('B98658206', 'REMPROV'),
	  T_FUNCION('B63572267', 'REMPROV'),
	  T_FUNCION('B82270240', 'REMPROV'),
	  T_FUNCION('B97999254', 'REMPROV'),
	  T_FUNCION('B98438633', 'REMPROV'),
	  T_FUNCION('B96595897', 'REMPROV'),
	  T_FUNCION('B64381387', 'REMPROV'),
	  T_FUNCION('A28430882', 'REMPROV'),
	  T_FUNCION('B46635991', 'REMPROV'),
	  T_FUNCION('B50919604', 'REMPROV'),
	  T_FUNCION('A82451410', 'REMPROV'),
	  T_FUNCION('B60985421', 'REMPROV'),
	  T_FUNCION('B82127358', 'REMPROV'),
	  T_FUNCION('78472108H', 'REMPROV'),
	  T_FUNCION('A50001726', 'REMPROV'),
	  T_FUNCION('A78798998', 'REMPROV'),
	  T_FUNCION('B35828995', 'REMPROV'),
	  T_FUNCION('B91236398', 'REMPROV'),
	  T_FUNCION('B86797065', 'REMPROV'),
	  T_FUNCION('N0066973I', 'REMPROV'),
	  T_FUNCION('B65737322', 'REMPROV'),
	  T_FUNCION('B86689494', 'REMPROV'),
	  T_FUNCION('E07306210', 'REMPROV'),
	  T_FUNCION('A62690953', 'REMPROV'),
	  T_FUNCION('B12640637', 'REMPROV'),
	  T_FUNCION('B98278799', 'REMPROV'),
	  T_FUNCION('B98350077', 'REMPROV'),
	  T_FUNCION('B86561677', 'REMPROV'),
	  T_FUNCION('B98257116', 'REMPROV'),
	  T_FUNCION('A04337309', 'REMPROV'),
	  T_FUNCION('B65428583', 'REMPROV'),
	  T_FUNCION('B04604195', 'REMPROV'),
	  T_FUNCION('B23657521', 'REMPROV'),
	  T_FUNCION('B98327943', 'REMPROV'),
	  T_FUNCION('B85084135', 'REMPROV'),
	  T_FUNCION('B45684677', 'REMPROV'),
	  T_FUNCION('B04466256', 'REMPROV'),
	  T_FUNCION('B28205904', 'REMPROV'),
	  T_FUNCION('B92418524', 'REMPROV'),
	  T_FUNCION('B98380629', 'REMPROV'),
	  T_FUNCION('B04485686', 'REMPROV'),
	  T_FUNCION('A04028023', 'REMPROV'),
	  T_FUNCION('B04405403', 'REMPROV'),
	  T_FUNCION('A04048088', 'REMPROV'),
	  T_FUNCION('B18386375', 'REMPROV'),
	  T_FUNCION('B04524583', 'REMPROV'),
	  T_FUNCION('B61425682', 'REMPROV'),
	  T_FUNCION('B04490587', 'REMPROV'),
	  T_FUNCION('B04307120', 'REMPROV'),
	  T_FUNCION('B08658601', 'REMPROV'),
	  T_FUNCION('A48027056', 'REMPROV'),
	  T_FUNCION('B04341699', 'REMPROV'),
	  T_FUNCION('B04630075', 'REMPROV'),
	  T_FUNCION('A83263772', 'REMPROV'),
	  T_FUNCION('A81948077', 'REMPROV'),
	  T_FUNCION('A15168156', 'REMPROV'),
	  T_FUNCION('B96836739', 'REMPROV'),
	  T_FUNCION('B29770922', 'REMPROV'),
	  T_FUNCION('J04678785', 'REMPROV'),
	  T_FUNCION('A46092128', 'REMPROV'),
	  T_FUNCION('A04038014', 'REMPROV'),
	  T_FUNCION('B04482691', 'REMPROV'),
	  T_FUNCION('A04028205', 'REMPROV'),
	  T_FUNCION('B04254793', 'REMPROV'),
	  T_FUNCION('B02118115', 'REMPROV'),
	  T_FUNCION('B30473599', 'REMPROV'),
	  T_FUNCION('E04711990', 'REMPROV'),
	  T_FUNCION('A54496005', 'REMPROV'),
	  T_FUNCION('B73156424', 'REMPROV'),
	  T_FUNCION('B04336301', 'REMPROV'),
	  T_FUNCION('20447058N', 'REMPROV'),
	  T_FUNCION('73760763Q', 'REMPROV'),
	  T_FUNCION('B57657207', 'REMPROV'),
	  T_FUNCION('B04264982', 'REMPROV'),
	  T_FUNCION('B04229548', 'REMPROV'),
	  T_FUNCION('B04506614', 'REMPROV'),
	  T_FUNCION('B04697728', 'REMPROV'),
	  T_FUNCION('A82838350', 'REMPROV'),
	  T_FUNCION('B97279012', 'REMPROV'),
	  T_FUNCION('B53966560', 'REMPROV'),
	  T_FUNCION('A79252219', 'REMPROV'),
	  T_FUNCION('B24503245', 'REMPROV'),
	  T_FUNCION('B54624119', 'REMPROV'),
	  T_FUNCION('B85030641', 'REMPROV'),
	  T_FUNCION('B96534805', 'REMPROV'),
	  T_FUNCION('A03319530', 'REMPROV'),
	  T_FUNCION('B92687458', 'REMPROV')    
    ); 
    V_TMP_FUNCION T_FUNCION;
    V_PERFILES VARCHAR2(100 CHAR) := '%';  -- Cambiar por ALGÚN PERFIL para otorgar permisos a ese perfil.
    V_MSQL_1 VARCHAR2(4000 CHAR);
    
BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');

	
	 
    -- LOOP para insertar los valores en USD_USUARIOS_DESPACHOS -----------------------------------------------------------------
    DBMS_OUTPUT.PUT_LINE('[INFO]: INSERCION EN USD_USUARIOS_DESPACHOS] ');
     FOR I IN V_FUNCION.FIRST .. V_FUNCION.LAST
      LOOP
            V_TMP_FUNCION := V_FUNCION(I);
			
			V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.USD_USUARIOS_DESPACHOS 
			WHERE DES_ID = 
				(SELECT DES_ID FROM '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO 
				WHERE DES_DESPACHO = '''||TRIM(V_TMP_FUNCION(2))||''') 
				AND USU_ID = 
					(SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS 
					WHERE USU_USERNAME = '''||TRIM(V_TMP_FUNCION(1))||''')';
			EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
			
			-- Si existe la FUNCION
			IF V_NUM_TABLAS > 0 THEN	  
				DBMS_OUTPUT.PUT_LINE('[INFO] Ya existen los datos en la tabla '||V_ESQUEMA||'.USD_USUARIOS_DESPACHOS...no se modifica nada.');
				
			ELSE
				V_MSQL_1 := 'INSERT INTO '||V_ESQUEMA||'.USD_USUARIOS_DESPACHOS' ||
							' (USD_ID, DES_ID, USU_ID, USD_GESTOR_DEFECTO, USD_SUPERVISOR, USUARIOCREAR, FECHACREAR, BORRADO)' || 
							' SELECT '||V_ESQUEMA||'.S_USD_USUARIOS_DESPACHOS.NEXTVAL,' ||
							' (SELECT DES_ID FROM '||V_ESQUEMA||'.DES_DESPACHO_EXTERNO WHERE DES_DESPACHO = '''||TRIM(V_TMP_FUNCION(2))||'''),' ||							
							' (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = '''||TRIM(V_TMP_FUNCION(1))||'''),' ||
							' 1,1,''DML'',SYSDATE,0 FROM DUAL';
		    	
				EXECUTE IMMEDIATE V_MSQL_1;
				DBMS_OUTPUT.PUT_LINE('[INFO] Datos de la tabla '||V_ESQUEMA||'.USD_USUARIOS_DESPACHOS insertados correctamente.');
				
		    END IF;	
      END LOOP;
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN]: USD_USUARIOS_DESPACHOS ACTUALIZADO CORRECTAMENTE ');
   

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;

/

EXIT



   
