--/*
--#########################################
--## AUTOR=MANUEL RODRIGUEZ
--## FECHA_CREACION=20161104
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-719
--## PRODUCTO=NO
--## 
--## Finalidad: BORRADO DE REGISTROS DE LA PRIMERA MIGRACION
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

BEGIN

      DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE BORRADO DE REGISTROS DE LA PRIMERA MIGRACION');
      
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_VAL_VALORACIONES');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_DIS_DISTRIBUCION');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_VIV_VIVIENDA');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_LCO_LOCAL_COMERCIAL');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_APR_PLAZA_APARCAMIENTO');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_COC_COCINA');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_BNY_BANYO');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_INS_INSTALACION');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_ZCO_ZONA_COMUN');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_INF_INFRAESTRUCTURA');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_SOL_SOLADO');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_PRV_PARAMENTO_VERTICAL');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_CRE_CARPINTERIA_EXT');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_CRI_CARPINTERIA_INT');
      OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_EDI_EDIFICIO');
      --OPERACION_DDL.DDL_TABLE('TRUNCATE', 'ACT_ICO_INFO_COMERCIAL'); 
      DELETE FROM REM01.ACT_ICO_INFO_COMERCIAL WHERE 1=1;     
      
      DELETE FROM REM01.MIG_AAA_AGRUPACION_ACTIVO_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO); --6.407 filas eliminado
      DELETE FROM REM01.MIG_AAG_AGRUPACIONES_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_AGR_AGRUPACION ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.AGR_NUM_AGRUP_UVEM = BNK.AGR_UVEM); --0 filas eliminado
      DELETE FROM REM01.MIG_ACA_CABECERA_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--36.948 filas eliminado
      --DELETE FROM REM01.MIG_ACA_CALIDADES_ACTIVO_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--36.948 filas eliminado
      DELETE FROM REM01.MIG_ACA_CARGAS_ACTIVO_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--3.745 filas eliminado
      DELETE FROM REM01.MIG_ACA_CATASTRO_ACTIVO_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--31.175 filas eliminado
      DELETE FROM REM01.MIG_ADA_DATOS_ADI_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--36.947 filas eliminado
      DELETE FROM REM01.MIG_ADJ_JUDICIAL_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--6.968 filas eliminado
      DELETE FROM REM01.MIG_ADJ_NO_JUDICIAL_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--6.425 filas eliminado
      --DELETE FROM REM01.MIG_AIA_INFCOMERCIAL_ACT_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--36.948 filas eliminado
      --DELETE FROM REM01.MIG_AID_INFCOMERCIAL_DISTR_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--67.536 filas eliminado
      DELETE FROM REM01.MIG_AML_MOVIMIENTOS_LLAVE_BNK BNK 
      WHERE EXISTS (
            SELECT 1
            FROM REM01.MIG_ALA_LLAVES_ACTIVO_BNK ALA
            INNER JOIN REM01.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = ALA.ACT_NUMERO_ACTIVO AND ACT.USUARIOCREAR = 'MIG'
            WHERE BNK.LLV_CODIGO_UVEM = ALA.LLV_CODIGO_UVEM
      );--10.546 filas eliminado
      DELETE FROM REM01.MIG_ALA_LLAVES_ACTIVO_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--18.446 filas eliminado
      DELETE FROM REM01.MIG_AOA_OBSERVACION_AGRUP_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_AGR_AGRUPACION ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.AGR_NUM_AGRUP_UVEM = BNK.AGR_UVEM);--0 filas eliminado
      DELETE FROM REM01.MIG_APA_PROP_ACTIVO_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--36.948 filas eliminado
      --DELETE FROM REM01.MIG_APC_PRECIO_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--38.731 filas eliminado
      --DELETE FROM REM01.MIG_APC_PROP_CABECERA_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_PRO_PROPIETARIO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.PRO_CODIGO_UVEM = BNK.PRO_CODIGO_UVEM);--0 filas eliminado
      DELETE FROM REM01.MIG_APC_PROP_CABECERA_BNK BNK WHERE BNK.PRO_CODIGO_UVEM IN (
		SELECT MIG.PRO_CODIGO_UVEM FROM REM01.ACT_PRO_PROPIETARIO ACT
		INNER JOIN MIG_APC_PROP_CABECERA_BNK MIG
		  ON ACT.PRO_CODIGO_UVEM = MIG.PRO_CODIGO_UVEM
		INNER JOIN DD_CRA_CARTERA CRA
			ON MIG.PRO_COD_CARTERA = CRA.DD_CRA_CODIGO
		WHERE ACT.USUARIOCREAR = 'MIG'
		AND ACT.DD_CRA_ID = CRA.DD_CRA_ID)
		 AND BNK.PRO_COD_CARTERA IN(
		SELECT MIG.PRO_COD_CARTERA FROM REM01.ACT_PRO_PROPIETARIO ACT
		INNER JOIN MIG_APC_PROP_CABECERA_BNK MIG
		  ON ACT.PRO_CODIGO_UVEM = MIG.PRO_CODIGO_UVEM
		INNER JOIN DD_CRA_CARTERA CRA
			ON MIG.PRO_COD_CARTERA = CRA.DD_CRA_CODIGO
		WHERE ACT.USUARIOCREAR = 'MIG'
		AND ACT.DD_CRA_ID = CRA.DD_CRA_ID);
      DELETE FROM REM01.MIG_APL_PLANDINVENTAS_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--36.948 filas eliminado
      DELETE FROM REM01.MIG_APT_PRESUPUESTO_TRABAJ_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_TBJ_TRABAJO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.TBJ_NUM_TRABAJO = BNK.TBJ_NUM_TRABAJO);--5.669 filas eliminado
      --DELETE FROM REM01.MIG_ASA_SUBDIVISION_AGRUP_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_AGR_AGRUPACION ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.AGR_NUM_AGRUP_UVEM = BNK.AGR_UVEM);--0 filas eliminado
      DELETE FROM REM01.MIG_ATA_TASACIONES_ACTIVO_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--25.187 filas eliminado
      DELETE FROM REM01.MIG_ATI_TITULO_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--36.948 filas eliminado
      DELETE FROM REM01.MIG_CPC_PROP_CABECERA_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_CPR_COM_PROPIETARIOS ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.CPR_COD_COM_PROP_UVEM = BNK.CPR_COD_COM_PROP_UVEM);--917 filas eliminado
      DELETE FROM REM01.MIG_ATR_TRABAJO_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_ACTIVO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.ACT_NUM_ACTIVO = BNK.ACT_NUMERO_ACTIVO);--48.930 filas eliminado
      --DELETE FROM REM01.MIG_ATR_TRABAJO_BNK BNK WHERE EXISTS (SELECT 1 FROM REM01.ACT_TBJ_TRABAJO ACT WHERE ACT.USUARIOCREAR = 'MIG' AND ACT.TBJ_NUM_TRABAJO = BNK.TBJ_NUM_TRABAJO);--77.570 filas eliminado
      DELETE FROM REM01.MIG_ATR_TRABAJO_BNK BNK WHERE EXISTS(
	  WITH BORRADO AS (
			SELECT TBJ_NUM_TRABAJO, TTR.DD_TTR_CODIGO
		FROM ACT_TBJ_TRABAJO TBJ
		INNER JOIN DD_TTR_TIPO_TRABAJO TTR
		  ON TTR.DD_TTR_ID = TBJ.DD_TTR_ID
		WHERE TBJ.USUARIOCREAR = 'MIG'
		)
	  SELECT 1 FROM BORRADO BOR
	  WHERE BOR.TBJ_NUM_TRABAJO = BNK.TBJ_NUM_TRABAJO
	  AND BOR.DD_TTR_CODIGO = BNK.TIPO_TRABAJO);
      
      COMMIT;
      
      DBMS_OUTPUT.PUT_LINE('[INFO] FIN DEL PROCESO DE BORRADO DE REGISTROS DE LA PRIMERA MIGRACION');
  
  EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;

/

EXIT;
