--/*
--##########################################
--## AUTOR=DAVID GONZALEZ
--## FECHA_CREACION=20160422
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.1
--## INCIDENCIA_LINK=0
--## PRODUCTO=NO
--## Finalidad: Carga de datos en ACT_CFD_CONFIG_DOCUMENTO
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE

V_ESQUEMA VARCHAR2(15 CHAR) := '#ESQUEMA#';
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := '#ESQUEMA_MASTER#';

BEGIN

	EXECUTE IMMEDIATE '
	TRUNCATE TABLE '||V_ESQUEMA||'.ACT_CFD_CONFIG_DOCUMENTO
	'
	;
	
	commit;

	EXECUTE IMMEDIATE '
	INSERT INTO '||V_ESQUEMA||'.ACT_CFD_CONFIG_DOCUMENTO(
	CFD_ID,
	DD_TPA_ID,
	DD_TPD_ID,
	CFD_OBLIGATORIO,
	CFD_APLICA_F_CADUCIDAD,
	CFD_APLICA_F_ETIQUETA,
	CFD_APLICA_CALIFICACION,
	USUARIOCREAR,
	FECHACREAR)
	SELECT
	'||V_ESQUEMA||'.S_ACT_CFD_CONFIG_DOCUMENTO.NEXTVAL,
	TPA.DD_TPA_ID,
	TPD.DD_TPD_ID,
	CASE WHEN  (TPA.DD_TPA_CODIGO = ''01'' AND TPD.DD_TPD_CODIGO < TO_NUMBER(''06''))
			OR (TPA.DD_TPA_CODIGO = ''02'' AND TPD.DD_TPD_CODIGO < TO_NUMBER(''06''))
			OR (TPA.DD_TPA_CODIGO = ''03'')
			OR (TPA.DD_TPA_CODIGO = ''04'' AND (TPD.DD_TPD_CODIGO < TO_NUMBER(''06'') OR TPD.DD_TPD_CODIGO =''09'' OR TPD.DD_TPD_CODIGO =''10'' OR TPD.DD_TPD_CODIGO >= TO_NUMBER(''12'')))
			OR (TPA.DD_TPA_CODIGO = ''05'' AND (TPD.DD_TPD_CODIGO < TO_NUMBER(''06'') OR TPD.DD_TPD_CODIGO =''09'' OR TPD.DD_TPD_CODIGO =''10'' OR TPD.DD_TPD_CODIGO >= TO_NUMBER(''12'')))
			OR (TPA.DD_TPA_CODIGO = ''06'' AND (TPD.DD_TPD_CODIGO < TO_NUMBER(''06'') OR TPD.DD_TPD_CODIGO =''10'' OR TPD.DD_TPD_CODIGO =''12''))
			OR (TPA.DD_TPA_CODIGO = ''07'' AND (TPD.DD_TPD_CODIGO < TO_NUMBER(''06'') OR TPD.DD_TPD_CODIGO =''10'' OR TPD.DD_TPD_CODIGO =''12''))
			OR (TPA.DD_TPA_CODIGO = ''08'' AND (TPD.DD_TPD_CODIGO < TO_NUMBER(''06'') OR TPD.DD_TPD_CODIGO >= TO_NUMBER(''12'')))	
		THEN 1
		ELSE 0
	END CFD_OBLIGATORIO,
	CASE TPD.DD_TPD_CODIGO
	  WHEN ''10''
		THEN 0
	  WHEN ''13''
		THEN 0
	  WHEN ''14''
		THEN 0
	  WHEN ''15''
		THEN 0
	  ELSE 1
	END CFD_APLICA_F_CADUCIDAD,
	CASE TPD.DD_TPD_CODIGO
	  WHEN ''09''
		THEN 1
	  ELSE NULL
	END CFD_APLICA_F_ETIQUETA,
	CASE TPD.DD_TPD_CODIGO
	  WHEN ''09''
		THEN 1
	  ELSE NULL
	END CFD_APLICA_CALIFICACION,
	''MIG'',
	SYSDATE
	FROM '||V_ESQUEMA||'.DD_TPA_TIPO_ACTIVO TPA,
	DD_TPD_TIPO_DOCUMENTO TPD
	'
	;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.ACT_CFD_CONFIG_DOCUMENTO cargada. '||SQL%ROWCOUNT||' Filas.');
  
	COMMIT;

EXCEPTION

	WHEN OTHERS THEN

		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion: '||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------');
		DBMS_OUTPUT.put_line(SQLERRM);

    ROLLBACK;
    RAISE;

END;
/
EXIT
