WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET TIMING ON;

DECLARE
    
    ERR_NUM    NUMBER(25);
    ERR_MSG    VARCHAR2(1024 CHAR);  
    EXISTE     NUMBER;
    V_SQL      VARCHAR2(1000);
    
    TYPE T_TABLAS IS TABLE OF VARCHAR2(70);      
    TYPE T_ARRAY_TABLAS IS TABLE OF T_TABLAS;
    V_TEMP_TABLAS  T_TABLAS;
        
    V_TABLA T_ARRAY_TABLAS := T_ARRAY_TABLAS
        (T_TABLAS('REM01','MIG_ACA_CABECERA_BNK')
		,T_TABLAS('REM01','MIG_ATI_TITULO_BNK')
		,T_TABLAS('REM01','MIG_APL_PLANDINVENTAS_BNK')
		,T_TABLAS('REM01','MIG_ADJ_JUDICIAL_BNK')
		,T_TABLAS('REM01','MIG_ADJ_NO_JUDICIAL_BNK')
		,T_TABLAS('REM01','MIG_ADA_DATOS_ADI_BNK')
		,T_TABLAS('REM01','MIG_CPC_PROP_CABECERA_BNK')
		,T_TABLAS('REM01','MIG_CPC_PROP_CUOTAS_BNK')
		,T_TABLAS('REM01','MIG_APC_PROP_CABECERA_BNK')
		,T_TABLAS('REM01','MIG_APA_PROP_ACTIVO_BNK')
		,T_TABLAS('REM01','MIG_ACA_CATASTRO_ACTIVO_BNK')
		,T_TABLAS('REM01','MIG_ACA_CARGAS_ACTIVO_BNK')
		,T_TABLAS('REM01','MIG_AOA_OCUPANTES_ACTIVO_BNK')
		,T_TABLAS('REM01','MIG_ALA_LLAVES_ACTIVO_BNK')
		,T_TABLAS('REM01','MIG_AML_MOVIMIENTOS_LLAVE_BNK')
		,T_TABLAS('REM01','MIG_APC_PRECIO_BNK')
		,T_TABLAS('REM01','MIG_ATA_TASACIONES_ACTIVO_BNK')
		,T_TABLAS('REM01','MIG_AIA_INFOCOMERCIAL_ACTIVO_BNK')
		,T_TABLAS('REM01','MIG_AOA_OBSERVACIONES_ACTIVOS_BNK')
		,T_TABLAS('REM01','MIG_ACA_CALIDADES_ACTIVO_BNK')
		,T_TABLAS('REM01','MIG_AID_INFOCOMERCIAL_DISTRIBUCION_BNK')
		,T_TABLAS('REM01','MIG_AIC_IMAGENES_CABECERA_BNK')
		,T_TABLAS('REM01','MIG_AIA_IMAGENES_ACTIVO_BNK')
		,T_TABLAS('REM01','MIG_ADA_DOCUMENTOS_ACTIVO_BNK')
		,T_TABLAS('REM01','MIG_ADMISION_DOCUMENTOS_BNK')
		,T_TABLAS('REM01','MIG_AAA_AGRUPACIONES_ACTIVO_BNK')
		,T_TABLAS('REM01','MIG_AAG_AGRUPACIONES_BNK')
		,T_TABLAS('REM01','MIG_AOA_OBSERVACIONES_AGRUP_BNK')
		,T_TABLAS('REM01','MIG_AIA_IMAGENES_AGRUPACION_BNK')
		,T_TABLAS('REM01','MIG_ASA_SUBDIVISIONES_AGRUPACION_BNK')
		,T_TABLAS('REM01','MIG_AIS_IMAGENES_SUBDIVISION_BNK')
		,T_TABLAS('REM01','MIG_PRESUPUESTO_ACTIVO_BNK')
		,T_TABLAS('REM01','MIG_APR_PROVEEDORES_BNK')
		,T_TABLAS('REM01','MIG_APC_PROVEEDOR_CONTACTO_BNK')
		,T_TABLAS('REM01','MIG_AEP_ENTIDAD_PROVEEDOR_BNK')
		,T_TABLAS('REM01','MIG_ATR_TRABAJO_BNK')
		,T_TABLAS('REM01','MIG_APT_PRESUPUESTO_TRABAJO_BNK')
		,T_TABLAS('REM01','MIG_APS_PROVISION_SUPLIDO_BNK')
		);

BEGIN
                
    --** Actualiza estadisticas de tablas de interface tras loader
    FOR I IN V_TABLA.FIRST .. V_TABLA.LAST
    LOOP
          
        V_TEMP_TABLAS := V_TABLA(I);
        EXISTE := 0;
        V_SQL:= 'SELECT COUNT(*) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TEMP_TABLAS(2)||''' AND OWNER = '''||V_TEMP_TABLAS(1)||'''';
        EXECUTE IMMEDIATE V_SQL INTO EXISTE;
        IF (EXISTE>0) 
          THEN 
		
		
		
            EXECUTE IMMEDIATE('ANALYZE TABLE '||V_TEMP_TABLAS(1)||'.'||V_TEMP_TABLAS(2)||' COMPUTE STATISTICS');
            DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' Estadisticas sobre '||V_TEMP_TABLAS(1)||'.'||V_TEMP_TABLAS(2)||' actualizadas.');
          ELSE 
            DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' La tabla '||V_TEMP_TABLAS(1)||'.'||V_TEMP_TABLAS(2)||' no existe.');
        END IF;
     
    END LOOP;
  
EXCEPTION
  WHEN OTHERS THEN
    ERR_NUM := SQLCODE;
    ERR_MSG := SQLERRM;
    DBMS_OUTPUT.put_line('[ERROR] - '||to_char(sysdate,'HH24:MI:SS')||' Error actualizando estadisticas.');
    DBMS_OUTPUT.put_line('[ERROR] - '||to_char(sysdate,'HH24:MI:SS')||' Se ha producido un error en la ejecuci√≥n:'||TO_CHAR(ERR_NUM));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(ERR_MSG);
    ROLLBACK;
    RAISE;   

END;
/

EXIT;
