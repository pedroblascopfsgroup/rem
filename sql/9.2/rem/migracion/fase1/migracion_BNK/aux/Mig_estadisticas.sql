WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET TIMING ON;

DECLARE
    
    ERR_NUM    NUMBER(25);
    ERR_MSG    VARCHAR2(1024 CHAR);  
    EXISTE     NUMBER;
    V_SQL      VARCHAR2(1000);
    
    TYPE T_TABLAS IS TABLE OF VARCHAR2(70);      
    TYPE T_ARRAY_TABLAS IS TABLE OF T_TABLAS;
    V_TEMP_TABLAS  T_TABLAS;
        
    V_TABLA T_ARRAY_TABLAS := T_ARRAY_TABLAS
        (T_TABLAS('HAYA01','MIG_ACA_CABECERA')
		,T_TABLAS('HAYA01','MIG_ATI_TITULO')
		,T_TABLAS('HAYA01','MIG_APL_PLANDINVENTAS')
		,T_TABLAS('HAYA01','MIG_ADJ_JUDICIAL')
		,T_TABLAS('HAYA01','MIG_ADJ_NO_JUDICIAL')
		,T_TABLAS('HAYA01','MIG_ADA_DATOS_ADI')
		,T_TABLAS('HAYA01','MIG_CPC_PROP_CABECERA')
		,T_TABLAS('HAYA01','MIG_CPC_PROP_CUOTAS')
		,T_TABLAS('HAYA01','MIG_APC_PROP_CABECERA')
		,T_TABLAS('HAYA01','MIG_APA_PROP_ACTIVO')
		,T_TABLAS('HAYA01','MIG_ACA_CATASTRO_ACTIVO')
		,T_TABLAS('HAYA01','MIG_ACA_CARGAS_ACTIVO')
		,T_TABLAS('HAYA01','MIG_AOA_OCUPANTES_ACTIVO')
		,T_TABLAS('HAYA01','MIG_ALA_LLAVES_ACTIVO')
		,T_TABLAS('HAYA01','MIG_AML_MOVIMIENTOS_LLAVE')
		,T_TABLAS('HAYA01','MIG_APC_PRECIO')
		,T_TABLAS('HAYA01','MIG_ATA_TASACIONES_ACTIVO')
		,T_TABLAS('HAYA01','MIG_AIA_INFOCOMERCIAL_ACTIVO')
		,T_TABLAS('HAYA01','MIG_AOA_OBSERVACIONES_ACTIVOS')
		,T_TABLAS('HAYA01','MIG_ACA_CALIDADES_ACTIVO')
		,T_TABLAS('HAYA01','MIG_AID_INFOCOMERCIAL_DISTRIBUCION')
		,T_TABLAS('HAYA01','MIG_AIC_IMAGENES_CABECERA')
		,T_TABLAS('HAYA01','MIG_AIA_IMAGENES_ACTIVO')
		,T_TABLAS('HAYA01','MIG_ADA_DOCUMENTOS_ACTIVO')
		,T_TABLAS('HAYA01','MIG_ADMISION_DOCUMENTOS')
		,T_TABLAS('HAYA01','MIG_AAA_AGRUPACIONES_ACTIVO')
		,T_TABLAS('HAYA01','MIG_AAG_AGRUPACIONES')
		,T_TABLAS('HAYA01','MIG_AOA_OBSERVACIONES_AGRUP')
		,T_TABLAS('HAYA01','MIG_AIA_IMAGENES_AGRUPACION')
		,T_TABLAS('HAYA01','MIG_ASA_SUBDIVISIONES_AGRUPACION')
		,T_TABLAS('HAYA01','MIG_AIS_IMAGENES_SUBDIVISION')
		,T_TABLAS('HAYA01','MIG_PRESUPUESTO_ACTIVO')
		,T_TABLAS('HAYA01','MIG_APR_PROVEEDORES')
		,T_TABLAS('HAYA01','MIG_APC_PROVEEDOR_CONTACTO')
		,T_TABLAS('HAYA01','MIG_AEP_ENTIDAD_PROVEEDOR')
		,T_TABLAS('HAYA01','MIG_ATR_TRABAJO')
		,T_TABLAS('HAYA01','MIG_APT_PRESUPUESTO_TRABAJO')
		,T_TABLAS('HAYA01','MIG_APS_PROVISION_SUPLIDO')
		);

BEGIN
                
    --** Actualiza estadisticas de tablas de interface tras loader
    FOR I IN V_TABLA.FIRST .. V_TABLA.LAST
    LOOP
          
        V_TEMP_TABLAS := V_TABLA(I);
        EXISTE := 0;
        V_SQL:= 'SELECT COUNT(*) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TEMP_TABLAS(2)||''' AND OWNER = '''||V_TEMP_TABLAS(1)||'''';
        EXECUTE IMMEDIATE V_SQL INTO EXISTE;
        IF (EXISTE>0) 
          THEN 
		
		
		
            EXECUTE IMMEDIATE('ANALYZE TABLE '||V_TEMP_TABLAS(1)||'.'||V_TEMP_TABLAS(2)||' COMPUTE STATISTICS');
            DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' Estadisticas sobre '||V_TEMP_TABLAS(1)||'.'||V_TEMP_TABLAS(2)||' actualizadas.');
          ELSE 
            DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' La tabla '||V_TEMP_TABLAS(1)||'.'||V_TEMP_TABLAS(2)||' no existe.');
        END IF;
     
    END LOOP;
  
EXCEPTION
  WHEN OTHERS THEN
    ERR_NUM := SQLCODE;
    ERR_MSG := SQLERRM;
    DBMS_OUTPUT.put_line('[ERROR] - '||to_char(sysdate,'HH24:MI:SS')||' Error actualizando estadisticas.');
    DBMS_OUTPUT.put_line('[ERROR] - '||to_char(sysdate,'HH24:MI:SS')||' Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(ERR_MSG);
    ROLLBACK;
    RAISE;   

END;
/

EXIT;
