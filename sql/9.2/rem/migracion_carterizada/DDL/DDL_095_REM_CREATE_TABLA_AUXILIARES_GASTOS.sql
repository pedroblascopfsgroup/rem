--/*
--##########################################
--## AUTOR=DAP
--## FECHA_CREACION=20170927
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=p2.0.6-170728
--## INCIDENCIA_LINK=HREOS-2898
--## PRODUCTO=NO
--##
--## Finalidad: Crear tabla nueva
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versi√≥n inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

  V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; -- Configuracion Esquema Master
  TABLESPACE VARCHAR2(25 CHAR) := 'REM_IDX';
  V_TABLA VARCHAR(30) :='MIG_AUX_GASTOS_FILTRO';
  err_num NUMBER;
  err_msg VARCHAR2(2048);
  V_EXISTE NUMBER (1);
  V_MSQL VARCHAR2(4000 CHAR);

BEGIN

  --TABLA ACTIVOS_A_BORRAR
  V_MSQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA||''' AND OWNER = '''||V_ESQUEMA||''' ';
  EXECUTE IMMEDIATE V_MSQL INTO V_EXISTE;

  IF V_EXISTE = 1 THEN
    V_MSQL := 'DROP TABLE '||V_TABLA||' PURGE';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('TABLA '||V_TABLA||' BORRADA.');
  END IF;

  V_MSQL := '  
  CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||'
   (  DD_TGA_CODIGO    VARCHAR2(50 CHAR)
      ,DD_TPR_CODIGO   VARCHAR2(50 CHAR)
      ,DD_STG_CODIGO   VARCHAR2(50 CHAR)
      ,PRIORIDAD       NUMBER(1)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE '||TABLESPACE;
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('TABLA '||V_TABLA||' CREADA.');

--DAMOS GRANTS
  V_MSQL := 'SELECT COUNT(1) FROM ALL_USERS WHERE USERNAME = ''PFSREM'' ';
  EXECUTE IMMEDIATE V_MSQL INTO V_EXISTE;
  IF V_EXISTE = 1 THEN
    EXECUTE IMMEDIATE 'GRANT SELECT, INSERT, UPDATE, DELETE ON '||V_TABLA||' TO PFSREM';
  END IF;

  V_TABLA  :='MIG_AUX_GASTOS_FILTRADOS';

--TABLA ACTIVOS_A_BORRAR
  V_MSQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA||''' AND OWNER = '''||V_ESQUEMA||''' ';
  EXECUTE IMMEDIATE V_MSQL INTO V_EXISTE;

  IF V_EXISTE = 1 THEN
    V_MSQL := 'DROP TABLE '||V_TABLA||' PURGE';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('TABLA '||V_TABLA||' BORRADA.');
  END IF;

  V_MSQL := '  
  CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||'
   (  "GPV_NUM_GASTO_HAYA" NUMBER(16,0) NOT NULL ENABLE, 
      "VALIDACION" NUMBER(1)
   ) 
  TABLESPACE '||TABLESPACE;
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('TABLA '||V_TABLA||' CREADA.');

--DAMOS GRANTS
  V_MSQL := 'SELECT COUNT(1) FROM ALL_USERS WHERE USERNAME = ''PFSREM'' ';
  EXECUTE IMMEDIATE V_MSQL INTO V_EXISTE;
  IF V_EXISTE = 1 THEN
    EXECUTE IMMEDIATE 'GRANT SELECT, INSERT, UPDATE, DELETE ON '||V_TABLA||' TO PFSREM';
  END IF;

EXCEPTION
  WHEN OTHERS THEN
    err_num := SQLCODE;
    err_msg := SQLERRM;
    DBMS_OUTPUT.put_line('Error:'||TO_CHAR(err_num));
    DBMS_OUTPUT.put_line(err_msg);
    ROLLBACK;
    RAISE;
END;
/
EXIT
