--/*
--#########################################
--## AUTOR=GUILLEM REY
--## FECHA_CREACION=20170608
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-2209
--## PRODUCTO=NO
--## 
--## Finalidad: Proceso de migración MIG2_PVC_PROVEEDOR_CONTACTO -> ACT_PVC_PROVEEDOR_CONTACTO
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

AUX_PVE_COD_UVEM  #ESQUEMA#.MIG2_PVC_PROVEEDOR_CONTACTO.PVE_COD_UVEM%TYPE;
AUX_PVC_NOMBRE  #ESQUEMA#.MIG2_PVC_PROVEEDOR_CONTACTO.PVC_NOMBRE%TYPE;
AUX_PVC_COD_DIRECCION #ESQUEMA#.MIG2_PVC_PROVEEDOR_CONTACTO.PVC_COD_DIRECCION%TYPE;
AUX_PVC_IND_PRINCIPAL #ESQUEMA#.MIG2_PVC_PROVEEDOR_CONTACTO.PVC_IND_PRINCIPAL%TYPE;
AUX_PVC_COD_CARGO #ESQUEMA#.MIG2_PVC_PROVEEDOR_CONTACTO.PVC_COD_CARGO%TYPE;
AUX_PVC_CARGO #ESQUEMA#.MIG2_PVC_PROVEEDOR_CONTACTO.PVC_CARGO%TYPE;
AUX_PVC_FECHA_ALTA #ESQUEMA#.MIG2_PVC_PROVEEDOR_CONTACTO.PVC_FECHA_ALTA%TYPE;
AUX_PVC_FECHA_BAJA #ESQUEMA#.MIG2_PVC_PROVEEDOR_CONTACTO.PVC_FECHA_BAJA%TYPE;
AUX_PVC_OBSERVACIONES #ESQUEMA#.MIG2_PVC_PROVEEDOR_CONTACTO.PVC_OBSERVACIONES%TYPE;
TABLE_COUNT NUMBER(10,0) := 0;
TABLE_COUNT_2 NUMBER(10,0) := 0;
V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
V_USUARIO VARCHAR2(50 CHAR) := '#USUARIO_MIGRACION#';
V_TABLA VARCHAR2(40 CHAR) := 'ACT_PVC_PROVEEDOR_CONTACTO';
V_TABLA_MIG VARCHAR2(40 CHAR) := 'MIG2_PVC_PROVEEDOR_CONTACTO';
V_SENTENCIA VARCHAR2(32000 CHAR);
V_REG_MIG NUMBER(10,0) := 0;
V_REG_INSERTADOS NUMBER(10,0) := 0;
V_REJECTS NUMBER(10,0) := 0;
V_COD NUMBER(10,0) := 0;
V_OBSERVACIONES VARCHAR2(3000 CHAR) := '';

--Cursor que almacena los objetos del esquema 
      CURSOR OBJETOS_USUARIO IS 
      SELECT PVE_COD_UVEM
          ,PVC_NOMBRE
		  ,PVC_COD_DIRECCION
		  ,PVC_IND_PRINCIPAL
		  ,PVC_COD_CARGO
		  ,PVC_CARGO
		  ,PVC_FECHA_ALTA
		  ,PVC_FECHA_BAJA
		  ,PVC_OBSERVACIONES FROM (
SELECT MIG.PVE_COD_UVEM
		  ,MIG.PVC_NOMBRE
		  ,MIG.PVC_COD_DIRECCION
		  ,MIG.PVC_IND_PRINCIPAL
		  ,MIG.PVC_COD_CARGO
		  ,MIG.PVC_CARGO
		  ,MIG.PVC_FECHA_ALTA
		  ,MIG.PVC_FECHA_BAJA
		  ,MIG.PVC_OBSERVACIONES, 
		  ROW_NUMBER()
   OVER (PARTITION BY MIG.PVE_COD_UVEM, MIG.PVC_NOMBRE 
   ORDER BY MIG.PVC_PROVINCIA,
    MIG.PVC_CP,
    MIG.PVC_DIRECCION,
    MIG.PVC_TELF1,
    MIG.PVC_TELF2,
    MIG.PVC_FAX,
    MIG.PVC_EMAIL,
    MIG.PVC_IND_PRINCIPAL,
    MIG.PVC_COD_CARGO,
    MIG.PVC_CARGO,
    MIG.PVC_FECHA_ALTA,
    MIG.PVC_FECHA_BAJA,
    MIG.PVC_OBSERVACIONES,
    MIG.PVC_COD_DIRECCION,
    MIG.PVC_COD_USUARIO) AS ORDEN 
FROM MIG2_PVC_PROVEEDOR_CONTACTO MIG
INNER JOIN ACT_PVE_PROVEEDOR PVE
  ON PVE.PVE_COD_UVEM = MIG.PVE_COD_UVEM
INNER JOIN ACT_PVC_PROVEEDOR_CONTACTO PVC
  ON PVC.PVE_ID = PVE.PVE_ID
WHERE PVC.PVC_NOMBRE = MIG.PVC_NOMBRE)
WHERE ORDEN = 1
AND MIG.VALIDACION = 0;
      
BEGIN
	
	  --Inicio del proceso de volcado sobre ACT_PVC_PROVEEDOR_CONTACTO
      DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
      
      /*V_SENTENCIA := '
        MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' PVC
        USING ( SELECT
				PVE.PVE_ID,
				PRV.DD_PRV_ID,
				USU.USU_ID,
				TDI.DD_TDI_ID,
				MIG.PVC_DOCUMENTO,
				MIG.PVC_NOMBRE,
				MIG.PVC_APELLIDO1,
				MIG.PVC_APELLIDO2,
				MIG.PVC_CP,
				MIG.PVC_DIRECCION,
				MIG.PVC_TELF1,
				MIG.PVC_TELF2,
				MIG.PVC_FAX,
				MIG.PVC_EMAIL,
				MIG.PVC_IND_PRINCIPAL,
				CPC.DD_CPC_ID,
				MIG.PVC_CARGO,
				MIG.PVC_FECHA_ALTA,
				MIG.PVC_FECHA_BAJA,
				MIG.PVC_OBSERVACIONES,
				PRD.PRD_ID	
				FROM '||V_ESQUEMA||'.'||V_TABLA_MIG||' MIG
				INNER JOIN '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR PVE
					ON PVE.PVE_COD_UVEM = MIG.PVE_COD_UVEM
				LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_PRV_PROVINCIA PRV
					ON PRV.DD_PRV_CODIGO = MIG.PVC_PROVINCIA
				LEFT JOIN '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU
					ON USU.USU_USERNAME = MIG.PVC_COD_USUARIO 					
				LEFT JOIN '||V_ESQUEMA||'.DD_TDI_TIPO_DOCUMENTO_ID TDI
					ON TDI.DD_TDI_CODIGO = MIG.PVC_TIPO_DOCUMENTO
				LEFT JOIN '||V_ESQUEMA||'.DD_CPC_CARGO_PROV_CONTACTO CPC
					ON CPC.DD_CPC_CODIGO = MIG.PVC_COD_CARGO
				LEFT JOIN '||V_ESQUEMA||'.ACT_PRD_PROVEEDOR_DIRECCION PRD
					ON PRD.PVE_COD_DIRECC_UVEM = MIG.PVC_COD_DIRECCION
			  ) AUX
		ON (PVC.PVE_ID = AUX.PVE_ID)
		WHEN MATCHED THEN UPDATE SET
		  PRD_ID = AUX.PRD_ID
		  ,PVC_PRINCIPAL = AUX.PVC_IND_PRINCIPAL
		  ,DD_CPC_ID = AUX.DD_CPC_ID
		  ,PVC_CARGO = AUX.PVC_CARGO
		  ,PVC_FECHA_ALTA = AUX.PVC_FECHA_ALTA
		  ,PVC_FECHA_BAJA = AUX.PVC_FECHA_BAJA
		  ,PVC_OBSERVACIONES = AUX.PVC_OBSERVACIONES
          ,PVC.USUARIOMODIFICAR = ''MIG2''
          ,PVC.FECHAMODIFICAR = SYSDATE
      WHEN NOT MATCHED THEN INSERT (
			PVC_ID
			,PVC.PVE_ID
			,PVC.DD_PRV_ID
			,PVC.USU_ID
			,PVC.DD_TDI_ID
			,PVC.PVC_DOCIDENTIF
			,PVC.PVC_NOMBRE
			,PVC.PVC_APELLID01
			,PVC.PVC_APELLID02
			,PVC.PVC_CP
			,PVC.PVC_DIRECCION
			,PVC.PVC_TELF1
			,PVC.PVC_TELF2
			,PVC.PVC_FAX
			,PVC.PVC_EMAIL	
			,PVC.PVC_PRINCIPAL
			,PVC.DD_CPC_ID
			,PVC.PVC_CARGO
			,PVC.PVC_FECHA_ALTA
			,PVC.PVC_FECHA_BAJA
			,PVC.PVC_OBSERVACIONES
			,PVC.VERSION
			,PVC.USUARIOCREAR
			,PVC.FECHACREAR
			,PVC.BORRADO)
      VALUES (
				'||V_ESQUEMA||'.S_'||V_TABLA||'.NEXTVAL,
				AUX.PVE_ID,
				AUX.DD_PRV_ID,
				AUX.USU_ID,
				AUX.DD_TDI_ID,
				AUX.PVC_DOCUMENTO,
				AUX.PVC_NOMBRE,
				AUX.PVC_APELLIDO1,
				AUX.PVC_APELLIDO2,
				AUX.PVC_CP,
				AUX.PVC_DIRECCION,
				AUX.PVC_TELF1,
				AUX.PVC_TELF2,
				AUX.PVC_FAX,
				AUX.PVC_EMAIL,
				AUX.PVC_IND_PRINCIPAL,
				AUX.DD_CPC_ID,
				AUX.PVC_CARGO,
				AUX.PVC_FECHA_ALTA,
				AUX.PVC_FECHA_BAJA,
				AUX.PVC_OBSERVACIONES,
				''0'',
				''MIG2'',
          		SYSDATE,
          		0)
      '
      ;
      EXECUTE IMMEDIATE V_SENTENCIA	;*/
      
    OPEN OBJETOS_USUARIO;                                     
      
      --Bucle que recorre el cursor ejecutando las sentencias
      LOOP
        FETCH OBJETOS_USUARIO INTO AUX_PVE_COD_UVEM, AUX_PVC_NOMBRE, AUX_PVC_COD_DIRECCION, AUX_PVC_IND_PRINCIPAL, AUX_PVC_COD_CARGO, AUX_PVC_CARGO, AUX_PVC_FECHA_ALTA, AUX_PVC_FECHA_BAJA, AUX_PVC_OBSERVACIONES;
        EXIT WHEN OBJETOS_USUARIO%NOTFOUND;
		  V_SENTENCIA := '
          UPDATE '||V_ESQUEMA||'.ACT_PVC_PROVEEDOR_CONTACTO PVC
		  SET 
			   PRD_ID = (SELECT PRD.PRD_ID FROM '||V_ESQUEMA||'.ACT_PRD_PROVEEDOR_DIRECCION PRD WHERE PRD.PVE_COD_DIRECC_UVEM = '''||AUX_PVC_COD_DIRECCION||''')
			  ,PVC_PRINCIPAL = '''||AUX_PVC_IND_PRINCIPAL||'''
			  ,DD_CPC_ID = (SELECT CPC.DD_CPC_ID FROM '||V_ESQUEMA||'.DD_CPC_CARGO_PROV_CONTACTO CPC WHERE CPC.DD_CPC_CODIGO = '''||AUX_PVC_COD_CARGO||''' )
			  ,PVC_CARGO = '''||AUX_PVC_CARGO||'''
			  ,PVC_FECHA_ALTA = '''||AUX_PVC_FECHA_ALTA||'''
			  ,PVC_FECHA_BAJA = '''||AUX_PVC_FECHA_BAJA||'''
			  ,PVC_OBSERVACIONES = '''||AUX_PVC_OBSERVACIONES||'''
			  ,PVC.USUARIOMODIFICAR = '||V_USUARIO||'
			  ,PVC.FECHAMODIFICAR = SYSDATE
		  WHERE PVC.PVE_ID = (SELECT PVE_ID FROM '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR PVE WHERE PVE.PVE_COD_UVEM = '''||AUX_PVE_COD_UVEM||''' AND PVE.PVE_ID = PVC.PVE_ID)
		  AND PVC.PVC_NOMBRE = '''||AUX_PVC_NOMBRE||'''
		  '
		;
		EXECUTE IMMEDIATE V_SENTENCIA;
		            
      END LOOP;
      DBMS_OUTPUT.PUT_LINE('[INFO] Objetos actualizados de '||V_ESQUEMA||' -> ('||OBJETOS_USUARIO%ROWCOUNT||')');
      CLOSE OBJETOS_USUARIO;
      
      V_SENTENCIA := '
      MERGE INTO '||V_ESQUEMA||'.ACT_PVC_PROVEEDOR_CONTACTO PVC
        USING ( SELECT
				PVE.PVE_ID,
				PRV.DD_PRV_ID,
				USU.USU_ID,
				TDI.DD_TDI_ID,
				MIG.PVC_DOCUMENTO,
				MIG.PVC_NOMBRE,
				MIG.PVC_APELLIDO1,
				MIG.PVC_APELLIDO2,
				MIG.PVC_CP,
				MIG.PVC_DIRECCION,
				MIG.PVC_TELF1,
				MIG.PVC_TELF2,
				MIG.PVC_FAX,
				MIG.PVC_EMAIL,
				MIG.PVC_IND_PRINCIPAL,
				CPC.DD_CPC_ID,
				MIG.PVC_CARGO,
				MIG.PVC_FECHA_ALTA,
				MIG.PVC_FECHA_BAJA,
				MIG.PVC_OBSERVACIONES,
				PRD.PRD_ID	
				FROM '||V_ESQUEMA||'.MIG2_PVC_PROVEEDOR_CONTACTO MIG
				INNER JOIN '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR PVE
					ON PVE.PVE_COD_UVEM = MIG.PVE_COD_UVEM
				LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_PRV_PROVINCIA PRV
					ON PRV.DD_PRV_CODIGO = MIG.PVC_PROVINCIA
				LEFT JOIN '||V_ESQUEMA_MASTER||'.USU_USUARIOS USU
					ON USU.USU_USERNAME = MIG.PVC_COD_USUARIO 					
				LEFT JOIN '||V_ESQUEMA||'.DD_TDI_TIPO_DOCUMENTO_ID TDI
					ON TDI.DD_TDI_CODIGO = MIG.PVC_TIPO_DOCUMENTO
				LEFT JOIN '||V_ESQUEMA||'.DD_CPC_CARGO_PROV_CONTACTO CPC
					ON CPC.DD_CPC_CODIGO = MIG.PVC_COD_CARGO
				LEFT JOIN '||V_ESQUEMA||'.ACT_PRD_PROVEEDOR_DIRECCION PRD
					ON PRD.PVE_COD_DIRECC_UVEM = MIG.PVC_COD_DIRECCION
				WHERE MIG.VALIDACION = 0
			  ) AUX
		ON (PVC.PVE_ID = AUX.PVE_ID AND PVC.PVC_NOMBRE = AUX.PVC_NOMBRE)
      WHEN NOT MATCHED THEN INSERT (
			PVC_ID
			,PVC.PVE_ID
			,PVC.DD_PRV_ID
			,PVC.USU_ID
			,PVC.DD_TDI_ID
			,PVC.PVC_DOCIDENTIF
			,PVC.PVC_NOMBRE
			,PVC.PVC_APELLID01
			,PVC.PVC_APELLID02
			,PVC.PVC_CP
			,PVC.PVC_DIRECCION
			,PVC.PVC_TELF1
			,PVC.PVC_TELF2
			,PVC.PVC_FAX
			,PVC.PVC_EMAIL	
			,PVC.PVC_PRINCIPAL
			,PVC.DD_CPC_ID
			,PVC.PVC_CARGO
			,PVC.PVC_FECHA_ALTA
			,PVC.PVC_FECHA_BAJA
			,PVC.PVC_OBSERVACIONES
			,PVC.VERSION
			,PVC.USUARIOCREAR
			,PVC.FECHACREAR
			,PVC.BORRADO)
      VALUES (
				'||V_ESQUEMA||'.S_ACT_PVC_PROVEEDOR_CONTACTO.NEXTVAL,
				AUX.PVE_ID,
				AUX.DD_PRV_ID,
				AUX.USU_ID,
				AUX.DD_TDI_ID,
				AUX.PVC_DOCUMENTO,
				AUX.PVC_NOMBRE,
				AUX.PVC_APELLIDO1,
				AUX.PVC_APELLIDO2,
				AUX.PVC_CP,
				AUX.PVC_DIRECCION,
				AUX.PVC_TELF1,
				AUX.PVC_TELF2,
				AUX.PVC_FAX,
				AUX.PVC_EMAIL,
				AUX.PVC_IND_PRINCIPAL,
				AUX.DD_CPC_ID,
				AUX.PVC_CARGO,
				AUX.PVC_FECHA_ALTA,
				AUX.PVC_FECHA_BAJA,
				AUX.PVC_OBSERVACIONES,
				''0'',
				'||V_USUARIO||',
          		SYSDATE,
          		0)
      '
      ;
      EXECUTE IMMEDIATE V_SENTENCIA	;
      
      DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' cargada. '||SQL%ROWCOUNT||' Filas.');
      
      COMMIT;
      
      EXECUTE IMMEDIATE('ANALYZE TABLE '||V_ESQUEMA||'.'||V_TABLA||' COMPUTE STATISTICS');
      
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' ANALIZADA.');

EXCEPTION
      WHEN OTHERS THEN
            DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
            DBMS_OUTPUT.put_line('-----------------------------------------------------------');
            DBMS_OUTPUT.put_line(SQLERRM);
            ROLLBACK;
            RAISE;
END;

/

EXIT;