--/*
--######################################### 
--## AUTOR=DAP
--## FECHA_CREACION=20170616
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-2264
--## PRODUCTO=NO
--## 
--## Finalidad: Actualización de secuencias usadas en las tablas de volcado
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
  
  TYPE T_VIC IS TABLE OF VARCHAR2(4000 CHAR);
  TYPE T_ARRAY_VIC IS TABLE OF T_VIC;
  TABLE_COUNT NUMBER(3); 											-- Vble. para validar la existencia de las Tablas.
  err_num NUMBER; 													-- Numero de errores
  err_msg VARCHAR2(2048); 											-- Mensaje de error
  V_ID VARCHAR2(30 CHAR);
  V_MSQL VARCHAR2(4000 CHAR);
  V_EXIST NUMBER(10);
  V_SEC NUMBER(16);

  V_VIC T_ARRAY_VIC := T_ARRAY_VIC(
    T_VIC('REM01.S_TBJ_NUM_TRABAJO','REM01.ACT_TBJ_TRABAJO','TBJ_NUM_TRABAJO'),
    T_VIC('REM01.S_OFR_TIA_TIT_ADICIONALES','OFR_TIA_TITULARES_ADICIONALES','TIA_ID'),
    T_VIC('REM01.S_COE_CONDICIONANTES_EXP','REM01.COE_CONDICIONANTES_EXPEDIENTE','COE_ID'),
    T_VIC('REM01.S_ECO_NUM_EXPEDIENTE','REM01.ECO_EXPEDIENTE_COMERCIAL','ECO_NUM_EXPEDIENTE'),
    T_VIC('REM01.S_VIS_NUM_VISITA','REM01.VIS_VISITAS','VIS_NUM_VISITA'),
    T_VIC('REM01.S_CLC_REM_ID','REM01.CLC_CLIENTE_COMERCIAL','CLC_REM_ID'),
    T_VIC('REM01.S_ACT_NUM_ACTIVO_REM','REM01.ACT_ACTIVO','ACT_NUM_ACTIVO_REM'),
    T_VIC('REM01.S_ZON_PEF_USU','REM01.ZON_PEF_USU','ZPU_ID'),
    T_VIC('REM01.S_USD_USUARIOS_DESPACHOS','REM01.USD_USUARIOS_DESPACHOS','USD_ID'),
    T_VIC('REM01.S_ACT_CPR_COM_PROPIETARIOS','REM01.ACT_CPR_COM_PROPIETARIOS','CPR_ID'),
    T_VIC('REM01.S_ACT_ACTIVO','REM01.ACT_ACTIVO','ACT_ID'),
    T_VIC('REM01.S_BIE_BIEN','REM01.BIE_BIEN','BIE_ID'),
    T_VIC('REM01.S_BIE_ADJ_ADJUDICACION','REM01.BIE_ADJ_ADJUDICACION','BIE_ADJ_ID'),
    T_VIC('REM01.S_ACT_ADM_INF_ADMINISTRATIVA','REM01.ACT_ADM_INF_ADMINISTRATIVA','ADM_ID'),
    T_VIC('REM01.S_ACT_SPS_SIT_POSESORIA','REM01.ACT_SPS_SIT_POSESORIA','SPS_ID'),
    T_VIC('REM01.S_ACT_TIT_TITULO','REM01.ACT_TIT_TITULO','TIT_ID'),
    T_VIC('REM01.S_ACT_VAL_VALORACIONES','REM01.ACT_VAL_VALORACIONES','VAL_ID'),
    T_VIC('REM01.S_ACT_PDV_PLAN_DIN_VENTAS','REM01.ACT_PDV_PLAN_DIN_VENTAS','PDV_ID'),
    T_VIC('REM01.S_ACT_ABA_ACTIVO_BANCARIO','REM01.ACT_ABA_ACTIVO_BANCARIO','ABA_ID'),
    T_VIC('REM01.S_ACT_AJD_ADJJUDICIAL','REM01.ACT_AJD_ADJJUDICIAL','AJD_ID'),
    T_VIC('REM01.S_ACT_ADN_ADJNOJUDICIAL','REM01.ACT_ADN_ADJNOJUDICIAL','ADN_ID'),
    T_VIC('REM01.S_BIE_CAR_CARGAS','REM01.BIE_CAR_CARGAS','BIE_CAR_ID'),
    T_VIC('REM01.S_ACT_CRG_CARGAS','REM01.ACT_CRG_CARGAS','CRG_ID'),
    T_VIC('REM01.S_BIE_VALORACIONES','REM01.BIE_VALORACIONES','BIE_VAL_ID'),
    T_VIC('REM01.S_ACT_TAS_TASACION','REM01.ACT_TAS_TASACION','TAS_ID'),
    T_VIC('REM01.S_ACT_PRO_PROPIETARIO','REM01.ACT_PRO_PROPIETARIO','PRO_ID'),
    T_VIC('REM01.S_ACT_PAC_PROPIETARIO_ACTIVO','REM01.ACT_PAC_PROPIETARIO_ACTIVO','PAC_ID'),
    T_VIC('REM01.S_ACT_ICO_INFO_COMERCIAL','REM01.ACT_ICO_INFO_COMERCIAL','ICO_ID'),
    T_VIC('REM01.S_ACT_EDI_EDIFICIO','REM01.ACT_EDI_EDIFICIO','EDI_ID'),
    T_VIC('REM01.S_ACT_DIS_DISTRIBUCION','REM01.ACT_DIS_DISTRIBUCION','DIS_ID'),
    T_VIC('REM01.S_ACT_AGR_AGRUPACION','REM01.ACT_AGR_AGRUPACION','AGR_ID'),
    T_VIC('REM01.S_ACT_AGR_AGRUPACION','REM01.ACT_AGR_AGRUPACION','AGR_ID'),
    T_VIC('REM01.S_ACT_AGA_AGRUPACION_ACTIVO','REM01.ACT_AGA_AGRUPACION_ACTIVO','AGA_ID'),
    T_VIC('REM01.S_ACT_AGO_AGRUPACION_OBS','REM01.ACT_AGO_AGRUPACION_OBS','AGO_ID'),
    T_VIC('REM01.S_ACT_CAT_CATASTRO','REM01.ACT_CAT_CATASTRO','CAT_ID'),
    T_VIC('REM01.S_ACT_LLV_LLAVE','REM01.ACT_LLV_LLAVE','LLV_ID'),
    T_VIC('REM01.S_ACT_MLV_MOVIMIENTO_LLAVE','REM01.ACT_MLV_MOVIMIENTO_LLAVE','MLV_ID'),
    T_VIC('REM01.S_ACT_PVC_PROVEEDOR_CONTACTO','REM01.ACT_PVC_PROVEEDOR_CONTACTO','PVC_ID'),
    T_VIC('REM01.S_ACT_PVC_PROVEEDOR_CONTACTO','REM01.ACT_PVC_PROVEEDOR_CONTACTO','PVC_ID'),
    T_VIC('REM01.S_ACT_TBJ_TRABAJO','REM01.ACT_TBJ_TRABAJO','TBJ_ID'),
    T_VIC('REM01.S_ACT_PRT_PRESUPUESTO_TRABAJO','REM01.ACT_PRT_PRESUPUESTO_TRABAJO','PRT_ID'),
    T_VIC('REM01.S_CLC_CLIENTE_COMERCIAL','REM01.CLC_CLIENTE_COMERCIAL','CLC_ID'),
    T_VIC('REM01.S_ECO_EXPEDIENTE_COMERCIAL','REM01.ECO_EXPEDIENTE_COMERCIAL','ECO_ID'),
    T_VIC('REM01.S_COM_COMPRADOR','REM01.COM_COMPRADOR','COM_ID'),
    T_VIC('REM01.S_TXO_TEXTOS_OFERTA','REM01.TXO_TEXTOS_OFERTA','TXO_ID'),
    T_VIC('REM01.S_POS_POSICIONAMIENTO','REM01.POS_POSICIONAMIENTO','POS_ID'),
    T_VIC('REM01.S_SUB_SUBSANACIONES','REM01.SUB_SUBSANACIONES','SUB_ID'),
    T_VIC('REM01.S_ACT_HEP_HIST_EST_PUBLICACION','REM01.ACT_HEP_HIST_EST_PUBLICACION','HEP_ID'),
    T_VIC('REM01.S_ACT_COE_CONDICION_ESPECIFICA','REM01.ACT_COE_CONDICION_ESPECIFICA','COE_ID'),
    T_VIC('REM01.S_ACT_HVA_HIST_VALORACIONES','REM01.ACT_HVA_HIST_VALORACIONES','HVA_ID'),
    T_VIC('REM01.S_ACT_EJE_EJERCICIO','REM01.ACT_EJE_EJERCICIO','EJE_ID'),
    T_VIC('REM01.S_GIC_GASTOS_INFO_CONTABILIDAD','REM01.GIC_GASTOS_INFO_CONTABILIDAD','GIC_ID'),
    T_VIC('REM01.S_GEE_GESTOR_ENTIDAD','REM01.GEE_GESTOR_ENTIDAD','GEE_ID'),
    T_VIC('REM01.S_GEH_GESTOR_ENTIDAD_HIST','REM01.GEH_GESTOR_ENTIDAD_HIST','GEH_ID'),
    T_VIC('REM01.S_ACT_TBJ_TRABAJO','REM01.ACT_TBJ_TRABAJO','TBJ_ID'),
    T_VIC('REM01.S_ACT_TRA_TRAMITE','REM01.ACT_TRA_TRAMITE','TRA_ID'),
    T_VIC('REM01.S_TAR_TAREAS_NOTIFICACIONES','REM01.TAR_TAREAS_NOTIFICACIONES','TAR_ID'),
    T_VIC('REM01.S_TEX_TAREA_EXTERNA','REM01.TEX_TAREA_EXTERNA','TEX_ID'),
    T_VIC('REM01.S_ACT_AOB_ACTIVO_OBS','REM01.ACT_AOB_ACTIVO_OBS','AOB_ID'),
    T_VIC('REM01.S_ACT_PVE_PROVEEDOR','REM01.ACT_PVE_PROVEEDOR','PVE_ID'),
    T_VIC('REM01.S_ACT_CRI_CARPINTERIA_INT','REM01.ACT_CRI_CARPINTERIA_INT','CRI_ID'),
    T_VIC('REM01.S_ACT_CRE_CARPINTERIA_EXT','REM01.ACT_CRE_CARPINTERIA_EXT','CRE_ID'),
    T_VIC('REM01.S_ACT_PRV_PARAMENTO_VERTICAL','REM01.ACT_PRV_PARAMENTO_VERTICAL','PRV_ID'),
    T_VIC('REM01.S_ACT_SOL_SOLADO','REM01.ACT_SOL_SOLADO','SOL_ID'),
    T_VIC('REM01.S_ACT_INF_INFRAESTRUCTURA','REM01.ACT_INF_INFRAESTRUCTURA','INF_ID'),
    T_VIC('REM01.S_ACT_ZCO_ZONA_COMUN','REM01.ACT_ZCO_ZONA_COMUN','ZCO_ID'),
    T_VIC('REM01.S_ACT_INS_INSTALACION','REM01.ACT_INS_INSTALACION','INS_ID'),
    T_VIC('REM01.S_ACT_BNY_BANYO','REM01.ACT_BNY_BANYO','BNY_ID'),
    T_VIC('REM01.S_ACT_COC_COCINA','REM01.ACT_COC_COCINA','COC_ID'),
    T_VIC('REM01.S_ACT_PRD_PROVEEDOR_DIRECCION','REM01.ACT_PRD_PROVEEDOR_DIRECCION','PRD_ID'),
    T_VIC('REM01.S_ACT_ADO_ADMISION_DOCUMENTO','REM01.ACT_ADO_ADMISION_DOCUMENTO','ADO_ID'),
    T_VIC('REM01.S_VIS_VISITAS','REM01.VIS_VISITAS','VIS_ID'),
    T_VIC('REM01.S_OFR_OFERTAS','REM01.OFR_OFERTAS','OFR_ID'),
    T_VIC('REM01.S_RES_RESERVAS','REM01.RES_RESERVAS','RES_ID'),
    T_VIC('REM01.S_GEX_GASTOS_EXPEDIENTE','REM01.GEX_GASTOS_EXPEDIENTE','GEX_ID'),
    T_VIC('REM01.S_FOR_FORMALIZACION','REM01.FOR_FORMALIZACION','FOR_ID'),
    T_VIC('REM01.S_PRP_PROPUESTAS_PRECIOS','REM01.PRP_PROPUESTAS_PRECIOS','PRP_ID'),
    T_VIC('REM01.S_PRG_PROVISION_GASTOS','REM01.PRG_PROVISION_GASTOS','PRG_ID'),
    T_VIC('REM01.S_GPV_GASTOS_PROVEEDOR','REM01.GPV_GASTOS_PROVEEDOR','GPV_ID'),
    T_VIC('REM01.S_GPV_ACT','REM01.GPV_ACT','GPV_ACT_ID'),
    T_VIC('REM01.S_GPV_TBJ','REM01.GPV_TBJ','GPV_TBJ_ID'),
    T_VIC('REM01.S_GDE_GASTOS_DETALLE_ECONOMICO','REM01.GDE_GASTOS_DETALLE_ECONOMICO','GDE_ID'),
    T_VIC('REM01.S_GGE_GASTOS_GESTION','REM01.GGE_GASTOS_GESTION','GGE_ID'),
    T_VIC('REM01.S_GIM_GASTOS_IMPUGNACION','REM01.GIM_GASTOS_IMPUGNACION','GIM_ID'),
    T_VIC('REM01.S_ACT_PAC_PERIMETRO_ACTIVO','REM01.ACT_PAC_PERIMETRO_ACTIVO','PAC_ID'),
    T_VIC('REM01.S_ACT_ETP_ENTIDAD_PROVEEDOR','REM01.ACT_ETP_ENTIDAD_PROVEEDOR','ETP_ID'),
    T_VIC('REM01.S_ACT_HAL_HIST_ALQUILERES','REM01.ACT_HAL_HIST_ALQUILERES','HAL_ID'));
  V_TMP_VIC T_VIC;

BEGIN

    DBMS_OUTPUT.PUT_LINE('[INICIO]  Inicio del proceso');

    FOR I IN V_VIC.FIRST .. V_VIC.LAST
        LOOP
            V_TMP_VIC := V_VIC(I);
            V_SEC := NULL;
            V_MSQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = REPLACE(REPLACE('''||V_TMP_VIC(2)||''',''REM01.'',''''),''REMMASTER.'','''') ';
            EXECUTE IMMEDIATE V_MSQL INTO V_EXIST;
            
            IF V_EXIST = 0 THEN
                DBMS_OUTPUT.PUT_LINE('  [WARNING]   No existe la tabla: '''||V_TMP_VIC(2)||''' ');
            ELSE
                V_MSQL := 'SELECT COUNT(1) FROM ALL_SEQUENCES WHERE SEQUENCE_NAME = REPLACE(REPLACE('''||V_TMP_VIC(1)||''',''REM01.'',''''),''REMMASTER.'','''') ';
                EXECUTE IMMEDIATE V_MSQL INTO V_EXIST;
                IF V_EXIST = 0 THEN
                    DBMS_OUTPUT.PUT_LINE('  [WARNING]   No existe la secuencia: '''||V_TMP_VIC(1)||''' ');
                ELSE
                    --DBMS_OUTPUT.PUT_LINE('  [INFO]      Existe la línea: T_VIC('''||V_TMP_VIC(1)||''','''||V_TMP_VIC(2)||''','''||V_TMP_VIC(3)||''')');
                    V_MSQL := 'SELECT MAX('||V_TMP_VIC(3)||')+1 FROM '||V_TMP_VIC(2)||'';
                    EXECUTE IMMEDIATE V_MSQL INTO V_SEC;
                    IF V_SEC IS NULL THEN
                        DBMS_OUTPUT.PUT_LINE('  [INFO]  La secuencia '||V_TMP_VIC(1)||' no se actualizará.');
                    ELSE
                        V_MSQL := 'DROP SEQUENCE '||V_TMP_VIC(1);
                        EXECUTE IMMEDIATE V_MSQL;
                        V_MSQL := 'CREATE SEQUENCE '||V_TMP_VIC(1)||' MINVALUE '||V_SEC||' MAXVALUE 999999999999999999999999999 INCREMENT BY 1 START WITH '||V_SEC||' CACHE 20 NOORDER NOCYCLE';		
                        EXECUTE IMMEDIATE V_MSQL;
                        DBMS_OUTPUT.PUT_LINE('  [INFO]  El MINVALUE para la secuencia '||V_TMP_VIC(1)||' será '||V_SEC||'.');
                    END IF;
                END IF;
            END IF;
        END LOOP;
    
    V_TMP_VIC := NULL;

    COMMIT;
    
    DBMS_OUTPUT.PUT_LINE('[FIN] Creación secuencias terminada.');

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        DBMS_OUTPUT.put_line('[ERROR]   No existe PK para la tabla:'||V_TMP_VIC(2));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR]   Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT

