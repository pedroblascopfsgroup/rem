--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20170612
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-2209
--## PRODUCTO=NO
--## 
--## Finalidad: Proceso de migración 'MIG_ADA_DATOS_ADI' -> 'ACT_ADM_INF_ADMINISTRATIVA', 'ACT_SPS_SIT_POSESORIA',
--##														'BIE_DATOS_REGISTRALES', 'ACT_REG_INFO_REGISTRAL', 'ACT_LOC_LOCALIZACION',
--##														'BIE_LOCALIZACION (MERGE)', 'ACT_ACTIVO (MERGE)'
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
V_USUARIO VARCHAR2(50 CHAR) := '#USUARIO_MIGRACION#';
V_TABLA VARCHAR2(30 CHAR) := 'ACT_ADM_INF_ADMINISTRATIVA';
V_TABLA_2 VARCHAR2(30 CHAR) := 'ACT_SPS_SIT_POSESORIA';
V_TABLA_3 VARCHAR2(30 CHAR) := 'BIE_DATOS_REGISTRALES';
V_TABLA_4 VARCHAR2(30 CHAR) := 'ACT_REG_INFO_REGISTRAL';
V_TABLA_5 VARCHAR2(30 CHAR) := 'BIE_LOCALIZACION';
V_TABLA_6 VARCHAR2(30 CHAR) := 'ACT_LOC_LOCALIZACION';
V_TABLA_7 VARCHAR2(30 CHAR) := 'ACT_ACTIVO';
V_TABLA_MIG VARCHAR2(40 CHAR) := 'MIG_ADA_DATOS_ADI';
V_SENTENCIA VARCHAR2(2000 CHAR);

BEGIN
  
    -------
  
	DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA_2||'. [SITUACION POSESORIA ACTIVO]');

	EXECUTE IMMEDIATE ('
	MERGE INTO '||V_ESQUEMA||'.'||V_TABLA_2||' T1
	USING (SELECT act.act_id, MIG.SPS_RIESGO_OCUPACION,	MIG.SPS_RENTA_MENSUAL                                     SPS_RENTA_MENSUAL
		FROM '||V_ESQUEMA||'.'||V_TABLA_MIG||' MIG
		JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = MIG.ACT_NUMERO_ACTIVO AND ACT.BORRADO = 0
		WHERE MIG.VALIDACION IN (0,1) ) T2
	ON (T1.ACT_ID = T2.ACT_ID)
	WHEN MATCHED THEN UPDATE SET
		T1.SPS_RIESGO_OCUPACION = T2.SPS_RIESGO_OCUPACION
		, T1.SPS_RENTA_MENSUAL = T2.SPS_RENTA_MENSUAL
	')
	;
    
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_2||' actualizada. '||SQL%ROWCOUNT||' Filas.');
  
  COMMIT;
  
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_2||''',''10''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_2||' ANALIZADA.');
  
	-------
   
	DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA_3||'. [DATOS REGISTRALES BIENES]');

	EXECUTE IMMEDIATE ('
	MERGE INTO '||V_ESQUEMA||'.'||V_TABLA_3||' T1
	USING ( SELECT ACT.ACT_ID, mig.MUNICIPIO_REGISTRO                        							  BIE_DREG_MUNICIPIO_LIBRO,
	'''||V_USUARIO||'''                                                      USUARIOMODIFICAR,
	SYSDATE                                                      FECHAMODIFICAR,
	(SELECT DD_LOC_ID
	FROM '||V_ESQUEMA_MASTER||'.DD_LOC_LOCALIDAD
	WHERE DD_LOC_CODIGO = MIG.MUNICIPIO)                      DD_LOC_ID,
	(SELECT DD_PRV_ID
	FROM '||V_ESQUEMA_MASTER||'.DD_PRV_PROVINCIA
	WHERE DD_PRV_CODIGO = MIG.PROVINCIA)                      DD_PRV_ID
	FROM '||V_ESQUEMA||'.'||V_TABLA_MIG||' MIG
	JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = MIG.ACT_NUMERO_ACTIVO
	WHERE MIG.VALIDACION IN (0,1) ) T2
	ON (T1.ACT_ID = T2.ACT_ID)
	WHEN MATCHED THEN UPDATE SET
		T1.BIE_DREG_MUNICIPIO_LIBRO = T2.BIE_DREG_MUNICIPIO_LIBRO, T1.USUARIOMODIFICAR = T2.USUARIOMODIFICAR, T1.FECHAMODIFICAR = T2.FECHAMODIFICAR
		, t1.DD_LOC_ID = t2.DD_LOC_ID, T1.DD_PRV_ID = T2.DD_PRV_ID
  ')
  ;
    
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_3||' cargada. '||SQL%ROWCOUNT||' Filas.');
  
  COMMIT;
  
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_3||''',''10''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_3||' ANALIZADA.');
  
  --------
    
	  
	DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA_5||'. [LOCALIZACION BIEN]');
	
  EXECUTE IMMEDIATE ('
  MERGE INTO '||V_ESQUEMA||'.'||V_TABLA_5||' T1
  USING ( SELECT ACT.BIE_ID, MIG.MUNICIPIO			        											BIE_LOC_POBLACION,
  MIG.LOC_NOMBRE_VIA||'',''||MIG.LOC_NUMERO_DOMICILIO				        							BIE_LOC_DIRECCION,
  MIG.LOC_COD_POST													                                    BIE_LOC_COD_POST,
  '''||V_USUARIO||'''                                                                                   USUARIOMODIFICAR,
  SYSDATE                                                                                      			FECHAMODIFICAR,
  DD.DD_PRV_ID							              													DD_PRV_ID,
  MIG.LOC_NOMBRE_VIA												                                    BIE_LOC_NOMBRE_VIA,
  MIG.LOC_NUMERO_DOMICILIO											                               		BIE_LOC_NUMERO_DOMICILIO,
  MIG.LOC_ESCALERA													                                    BIE_LOC_ESCALERA,
  MIG.LOC_PISO														                                    BIE_LOC_PISO,
  MIG.LOC_PUERTA													                                    BIE_LOC_PUERTA,
  MIG.MUNICIPIO														                                    BIE_LOC_MUNICIPIO,
  MIG.PROVINCIA														                                    BIE_LOC_PROVINCIA,
  (SELECT DD_LOC_ID
    FROM '||V_ESQUEMA_MASTER||'.DD_LOC_LOCALIDAD
    WHERE DD_LOC_CODIGO = MIG.MUNICIPIO)							                       				DD_LOC_ID,
  (SELECT DD_UPO_ID
    FROM '||V_ESQUEMA_MASTER||'.DD_UPO_UNID_POBLACIONAL
    WHERE DD_UPO_CODIGO = MIG.UNIDAD_INFERIOR_MUNICIPIO)			      								DD_UPO_ID,
  (SELECT DD_TVI_ID
    FROM '||V_ESQUEMA_MASTER||'.DD_TVI_TIPO_VIA
    WHERE DD_TVI_CODIGO = MIG.TIPO_VIA)								                           			DD_TVI_ID,
  FROM '||V_ESQUEMA||'.'||V_TABLA_MIG||' MIG
  JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = MIG.ACT_NUMERO_ACTIVO
  LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_PRV_PROVINCIA DD
	ON DD.DD_PRV_CODIGO = MIG.PROVINCIA
  WHERE DD.DD_PRV_CODIGO IS NOT NULL
  AND MIG.VALIDACION IN (0,1)) T2
  ON (T1.BIE_ID = T2.BIE_ID)
  WHEN MATCHED THEN UPDATE SET
T1.BIE_LOC_POBLACION =					T2.BIE_LOC_POBLACION,
T1.BIE_LOC_DIRECCION =					T2.BIE_LOC_DIRECCION,
T1.BIE_LOC_COD_POST =					T2.BIE_LOC_COD_POST,
T1.USUARIOMODIFICAR = 					T2.USUARIOMODIFICAR,
T1.FECHAMODIFICAR =						T2.FECHAMODIFICAR,
T1.DD_PRV_ID = 							T2.DD_PRV_ID,
T1.BIE_LOC_NOMBRE_VIA =					T2.BIE_LOC_NOMBRE_VIA,
T1.BIE_LOC_NUMERO_DOMICILIO =			T2.BIE_LOC_NUMERO_DOMICILIO,
T1.BIE_LOC_ESCALERA =					T2.BIE_LOC_ESCALERA,
T1.BIE_LOC_PISO = 						T2.BIE_LOC_PISO,
T1.BIE_LOC_PUERTA =						T2.BIE_LOC_PUERTA,
T1.BIE_LOC_MUNICIPIO = 					T2.BIE_LOC_MUNICIPIO,
T1.BIE_LOC_PROVINCIA =					T2.BIE_LOC_PROVINCIA,
T1.DD_LOC_ID =							T2.DD_LOC_ID,
T1.DD_UPO_ID =							T2.DD_UPO_ID,
T1.DD_TVI_ID =							T2.DD_TVI_ID
  ')
  ;
    
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_5||' cargada. '||SQL%ROWCOUNT||' Filas.');
  
  COMMIT;
  
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_5||''',''10''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_5||' ANALIZADA.');
  
  --------

	DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA_6||'. [LOCALIZACION ACTIVO]');

	EXECUTE IMMEDIATE ('
	MERGE INTO '||V_ESQUEMA||'.'||V_TABLA_6||' T1 
	USING (SELECT ACT.ACT_ID,
	(SELECT DD_TUB_ID
	FROM '||V_ESQUEMA||'.DD_TUB_TIPO_UBICACION
	WHERE DD_TUB_CODIGO = MIG.TIPO_UBICACION)                 	DD_TUB_ID,
	MIG.LOC_LONGITUD                                          	LOC_LONGITUD,
	MIG.LOC_LATITUD                                           	LOC_LATITUD,
	'''||V_USUARIO||'''                                   		USUARIOMODIFICAR,
	SYSDATE 													FECHAMODIFICAR
	FROM '||V_ESQUEMA||'.'||V_TABLA_MIG||' MIG
    JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = MIG.ACT_NUMERO_ACTIVO
    JOIN '||V_ESQUEMA||'.'||V_TABLA_5||' BIE_LOC ON BIE_LOC.BIE_LOC_ID = MIG.BIE_LOC_ID
	WHERE MIG.VALIDACION IN (0,1)) T2
	ON (T1.ACT_ID = T2.ACT_ID)
	WHEN MATCHED THEN UPDATE SET
	T1.DD_TUB_ID = T2.DD_TUB_ID,
	T1.LOC_LONGITUD = T2.LOC_LONGITUD,
	T1.LOC_LATITUD = T2.LOC_LATITUD,
	T1.USUARIOMODIFICAR = T2.USUARIOMODIFICAR,
	T1.FECHAMODIFICA = T2.FECHAMODIFICAR

  ')
  ;
    
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_6||' cargada. '||SQL%ROWCOUNT||' Filas.');
  
  COMMIT;
  
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_6||''',''10''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_6||' ANALIZADA.');

  
  EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/

EXIT;
