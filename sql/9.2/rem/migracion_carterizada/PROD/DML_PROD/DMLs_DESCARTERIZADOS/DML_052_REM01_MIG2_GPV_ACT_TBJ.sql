--/*
--#########################################
--## AUTOR=GUILLEM REY
--## FECHA_CREACION=20170608
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-2209
--## PRODUCTO=NO
--## 
--## Finalidad: Proceso de migración MIG2_GPV_ACT_TBJ -> GPV_ACT & GPC_TBJ
--##                    
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

TABLE_COUNT    NUMBER(10,0) := 0;
TABLE_COUNT_2 NUMBER(10,0) := 0;
TABLE_COUNT_3 NUMBER(10,0) := 0;
V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01'; --REM01
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER'; --REMMASTER
V_USUARIO VARCHAR2(50 CHAR) := '#USUARIO_MIGRACION#';
V_TABLA_1 VARCHAR2(40 CHAR) := 'GPV_ACT';
V_TABLA_2 VARCHAR2(40 CHAR) := 'GPV_TBJ';
V_TABLA_MIG VARCHAR2(40 CHAR) := 'MIG2_GPV_ACT_TBJ';
V_SENTENCIA VARCHAR2(32000 CHAR);
TYPE T_TABLAS IS TABLE OF VARCHAR2(150);      
    TYPE T_ARRAY_TABLAS IS TABLE OF T_TABLAS;          
    V_TEMP_TABLAS  T_TABLAS;
    C_TABLA T_ARRAY_TABLAS := T_ARRAY_TABLAS(T_TABLAS('REM01','GPV_GASTOS_PROVEEDOR'));

BEGIN

          --Inicio del proceso de volcado sobre GPV_ACT
      DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA_1||'.');
      
      V_SENTENCIA := '
        INSERT INTO REM01.GPV_ACT (GPV_ACT_ID, GPV_ID, ACT_ID)
SELECT REM01.S_GPV_ACT.NEXTVAL, T2.GPV_ID, T3.ACT_ID
FROM REM01.MIG2_GPV_ACT_TBJ T1
JOIN REM01.GPV_GASTOS_PROVEEDOR T2 ON T1.GPT_GPV_ID = T2.GPV_NUM_GASTO_HAYA
JOIN REM01.ACT_ACTIVO T3 ON T1.GPT_ACT_NUMERO_ACTIVO = T3.ACT_NUM_ACTIVO
LEFT JOIN REM01.GPV_ACT T4 ON T4.GPV_ID = T2.GPV_ID AND T3.ACT_ID = T4.ACT_ID
WHERE T1.VALIDACION = 0 AND T4.GPV_ACT_ID IS NULL
                '
                ;
      EXECUTE IMMEDIATE V_SENTENCIA;

      V_SENTENCIA := '';
      
      DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_2||' cargada. '||SQL%ROWCOUNT||' Filas.'); 

      EXECUTE IMMEDIATE 'MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
    USING (SELECT T1.GPV_ID, T2.PRO_ID
        FROM REM01.GPV_ACT T1
        JOIN REM01.ACT_PAC_PROPIETARIO_ACTIVO T2 ON T1.ACT_ID = T2.ACT_ID AND T2.BORRADO = 0) T2
    ON (T1.GPV_ID = T2.GPV_ID)
    WHEN MATCHED THEN UPDATE SET
        T1.PRO_ID = T2.PRO_ID
    WHERE T1.PRO_ID IS NULL AND T1.USUARIOCREAR = '''||V_USUARIO||''' ';
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR actualizada (PROPIETARIO GASTO). '||SQL%ROWCOUNT||' Filas.');
      
      --Inicio del proceso de volcado sobre GPV_TBJ
      DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA_2||'.');
      
      V_SENTENCIA := '
        INSERT INTO REM01.GPV_TBJ (GPV_TBJ_ID, GPV_ID, TBJ_ID, USUARIOCREAR, FECHACREAR)
WITH TBJ_DUP AS (
    SELECT GPT_TBJ_NUM_TRABAJO
    FROM REM01.MIG2_GPV_ACT_TBJ
    WHERE GPT_TBJ_NUM_TRABAJO IS NOT NULL
    GROUP BY GPT_TBJ_NUM_TRABAJO
    HAVING COUNT(1) = 1)
SELECT REM01.S_GPV_TBJ.NEXTVAL, T2.GPV_ID, T3.TBJ_ID, '''||V_USUARIO||''', SYSDATE
FROM REM01.MIG2_GPV_ACT_TBJ T1
JOIN REM01.GPV_GASTOS_PROVEEDOR T2 ON T2.GPV_NUM_GASTO_HAYA = T1.GPT_GPV_ID
JOIN REM01.ACT_TBJ_TRABAJO T3 ON T3.TBJ_NUM_TRABAJO = T1.GPT_TBJ_NUM_TRABAJO
JOIN TBJ_DUP T4 ON T4.GPT_TBJ_NUM_TRABAJO = T3.TBJ_NUM_TRABAJO
LEFT JOIN REM01.GPV_TBJ T5 ON T5.GPV_ID = T2.GPV_ID AND T5.TBJ_ID = T3.TBJ_ID
WHERE T1.VALIDACION = 0 AND T5.GPV_TBJ_ID IS NULL

                '
                ;
      EXECUTE IMMEDIATE V_SENTENCIA     ;
      

      
      COMMIT;
      
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_1||''',''1''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;

      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_2||''',''1''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
     
      
      V_SENTENCIA := '
        MERGE INTO GPV_ACT GAS
        USING (
          WITH NUM_ACTIVOS AS(
            SELECT GPT_GPV_ID, COUNT(1) AS NUM_ACTIVOS
            FROM MIG2_GPV_ACT_TBJ
            WHERE VALIDACION = 0
            GROUP BY GPT_GPV_ID)
          SELECT GPV.GPV_ID, ACT.ACT_ID, ROUND(100/AUX.NUM_ACTIVOS,4) AS PORCENTAJE
          FROM MIG2_GPV_ACT_TBJ MIG2
          JOIN NUM_ACTIVOS AUX ON MIG2.GPT_GPV_ID = AUX.GPT_GPV_ID
          JOIN REM01.GPV_GASTOS_PROVEEDOR GPV ON GPV.GPV_NUM_GASTO_HAYA = MIG2.GPT_GPV_ID
          JOIN REM01.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = MIG2.GPT_ACT_NUMERO_ACTIVO
          JOIN REM01.GPV_ACT T1 ON T1.GPV_ID = GPV.GPV_ID AND T1.ACT_ID = ACT.ACT_ID
          WHERE MIG2.VALIDACION = 0) AUX
        ON (GAS.GPV_ID = AUX.GPV_ID AND GAS.ACT_ID = AUX.ACT_ID)
        WHEN MATCHED THEN UPDATE SET
        GAS.GPV_PARTICIPACION_GASTO = AUX.PORCENTAJE';
      EXECUTE IMMEDIATE V_SENTENCIA;
      
      DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_1||' actualizada (GPV_PARTICIPACION_GASTO). '||SQL%ROWCOUNT||' Filas.');
     
      V_SENTENCIA := '
        MERGE INTO ACT_TBJ GAS
        USING (
          WITH NUM_ACTIVOS AS(
            SELECT GPT_TBJ_NUM_TRABAJO, COUNT(1) AS NUM_ACTIVOS
            FROM (SELECT DISTINCT GPT_TBJ_NUM_TRABAJO, GPT_ACT_NUMERO_ACTIVO
                FROM MIG2_GPV_ACT_TBJ
                WHERE VALIDACION = 0)
            GROUP BY GPT_TBJ_NUM_TRABAJO)
          SELECT DISTINCT TBJ.TBJ_ID, ACT.ACT_ID, ROUND(100/AUX.NUM_ACTIVOS,4) AS PORCENTAJE
          FROM MIG2_GPV_ACT_TBJ MIG2
          JOIN NUM_ACTIVOS AUX ON MIG2.GPT_TBJ_NUM_TRABAJO = AUX.GPT_TBJ_NUM_TRABAJO
          JOIN REM01.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = MIG2.GPT_ACT_NUMERO_ACTIVO
          JOIN REM01.ACT_TBJ_TRABAJO TBJ ON TBJ.TBJ_NUM_TRABAJO = MIG2.GPT_TBJ_NUM_TRABAJO
          JOIN REM01.ACT_TBJ T1 ON T1.TBJ_ID = TBJ.TBJ_ID AND T1.ACT_ID = ACT.ACT_ID
          WHERE MIG2.VALIDACION = 0) AUX
        ON (GAS.TBJ_ID = AUX.TBJ_ID AND GAS.ACT_ID = AUX.ACT_ID)
        WHEN MATCHED THEN UPDATE SET
        GAS.ACT_TBJ_PARTICIPACION = AUX.PORCENTAJE';
      EXECUTE IMMEDIATE V_SENTENCIA;
      
      DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_1||' actualizada (GPV_PARTICIPACION_GASTO). '||SQL%ROWCOUNT||' Filas.');
      

      COMMIT;
     DBMS_OUTPUT.PUT_LINE('ACTIVAMOS RESTRICCIONES CLAVE AJENA' );
 
 FOR I IN C_TABLA.FIRST .. C_TABLA.LAST
 LOOP
      V_TEMP_TABLAS := C_TABLA(I);
     
      FOR J IN (SELECT TABLE_NAME, CONSTRAINT_NAME FROM SYS.USER_CONSTRAINTS WHERE CONSTRAINT_TYPE IN('R','C')
                AND STATUS='DISABLED' AND TABLE_NAME = V_TEMP_TABLAS(2))
      LOOP
          BEGIN                
                     EXECUTE IMMEDIATE 'ALTER TABLE '||V_ESQUEMA||'.' || J.TABLE_NAME || ' ENABLE CONSTRAINT ' || J.CONSTRAINT_NAME;
                     
       EXCEPTION WHEN OTHERS THEN
             NULL;
       END;
      END LOOP;            
 END LOOP; 

 DBMS_OUTPUT.PUT_LINE('FALTAN ACTIVAR RESTRICCIONES' );

  FOR J IN (SELECT TABLE_NAME, CONSTRAINT_NAME
              FROM SYS.USER_CONSTRAINTS
             WHERE  STATUS='DISABLED')
   LOOP
  BEGIN                
EXECUTE IMMEDIATE 'ALTER TABLE '||V_ESQUEMA||'.' || J.TABLE_NAME || ' ENABLE CONSTRAINT ' || J.CONSTRAINT_NAME;
 
  EXCEPTION WHEN OTHERS THEN
  NULL;
  END;
  END LOOP;  

  FOR J IN (SELECT TABLE_NAME, CONSTRAINT_NAME
              FROM SYS.USER_CONSTRAINTS
             WHERE  STATUS='DISABLED')
   LOOP
  BEGIN                
EXECUTE IMMEDIATE 'ALTER TABLE '||V_ESQUEMA||'.' || J.TABLE_NAME || ' ENABLE CONSTRAINT ' || J.CONSTRAINT_NAME;  
  EXCEPTION WHEN OTHERS THEN
  DBMS_OUTPUT.PUT_LINE('TABLA: '||J.TABLE_NAME||', RESTRICCION: '||J.CONSTRAINT_NAME);
  END;
  END LOOP;

  REM01.OPERACION_DDL.DDL_TABLE('ANALYZE','GPV_GASTOS_PROVEEDOR',1);
     
EXCEPTION
      WHEN OTHERS THEN
            DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
            DBMS_OUTPUT.put_line('-----------------------------------------------------------');
            DBMS_OUTPUT.put_line(SQLERRM);
            ROLLBACK;
            RAISE;
END;

/

EXIT;
