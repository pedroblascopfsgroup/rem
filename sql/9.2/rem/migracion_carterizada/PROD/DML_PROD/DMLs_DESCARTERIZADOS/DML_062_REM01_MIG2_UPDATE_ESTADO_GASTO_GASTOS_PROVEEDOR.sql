--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20170612
--## ARTEFACTO=migracion
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-2209
--## PRODUCTO=NO
--## 
--## Finalidad: Proceso de migración Fase 2, para la actualizacion de estados del gasto.
--##                    
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

    V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
    V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
    V_TABLA VARCHAR2(40 CHAR) := 'GPV_GASTOS_PROVEEDOR';
    V_SENTENCIA VARCHAR2(32000 CHAR);
    V_REG_ACTUALIZADOS NUMBER(10,0) := 0;
    V_REG_TOTAL NUMBER(10,0) := 0;
      
BEGIN
    
    DBMS_OUTPUT.PUT_LINE('------------------------------------------------------------------------------------') ;
    DBMS_OUTPUT.PUT_LINE('PROCESO DE ACTUALIZACION DE ESTADOS DE GASTOS PARA LAS GASTOS MIGRADOS EN FASE 2....') ;
    DBMS_OUTPUT.PUT_LINE('------------------------------------------------------------------------------------') ;

    --ACTUALIZACION DE GASTOS CON ESTADO '01 - PENDIENTE AUTOMATIZAR'
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' GPV
        USING ( SELECT GPV.GPV_ID FROM '||V_ESQUEMA||'.'||V_TABLA||' GPV
                INNER JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE
                  ON GGE.GPV_ID = GPV.GPV_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH
                  ON GGE.DD_EAH_ID = EAH.DD_EAH_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAP_ESTADOS_AUTORIZ_PROP EAP
                  ON GGE.DD_EAP_ID = EAP.DD_EAP_ID
                WHERE EAH.DD_EAH_CODIGO = ''01''
                AND EAP.DD_EAP_CODIGO = ''01''
                ) AUX
                ON (GPV.GPV_ID = AUX.GPV_ID)
                WHEN MATCHED THEN UPDATE SET
                  GPV.DD_EGA_ID = (SELECT DD_EGA_ID FROM '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''01'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. 01 - PENDIENTE AUTOMATIZAR');
    
    
    --ACTUALIZACION DE GASTOS CON ESTADO '02 - RECHAZO ADMINISTRACION'
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' GPV
        USING ( SELECT GPV.GPV_ID FROM '||V_ESQUEMA||'.'||V_TABLA||' GPV
                INNER JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE
                  ON GGE.GPV_ID = GPV.GPV_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH
                  ON GGE.DD_EAH_ID = EAH.DD_EAH_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAP_ESTADOS_AUTORIZ_PROP EAP
                  ON GGE.DD_EAP_ID = EAP.DD_EAP_ID
                WHERE EAH.DD_EAH_CODIGO = ''02''
                AND EAP.DD_EAP_CODIGO = ''01''
                ) AUX
                ON (GPV.GPV_ID = AUX.GPV_ID)
                WHEN MATCHED THEN UPDATE SET
                  GPV.DD_EGA_ID = (SELECT DD_EGA_ID FROM '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''02'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. 02 - RECHAZO ADMINISTRACION');
    
    
    --ACTUALIZACION DE GASTOS CON ESTADO '03 - AUTORIZADO ADMINISTRACION'
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' GPV
        USING ( SELECT GPV.GPV_ID FROM '||V_ESQUEMA||'.'||V_TABLA||' GPV
                INNER JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE
                  ON GGE.GPV_ID = GPV.GPV_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH
                  ON GGE.DD_EAH_ID = EAH.DD_EAH_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAP_ESTADOS_AUTORIZ_PROP EAP
                  ON GGE.DD_EAP_ID = EAP.DD_EAP_ID
                WHERE EAH.DD_EAH_CODIGO = ''03''
                AND EAP.DD_EAP_CODIGO = ''01''
                ) AUX
                ON (GPV.GPV_ID = AUX.GPV_ID)
                WHEN MATCHED THEN UPDATE SET
                  GPV.DD_EGA_ID = (SELECT DD_EGA_ID FROM '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''03'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. 03 - AUTORIZADO ADMINISTRACION');
    
    
    --ACTUALIZACION DE GASTOS CON ESTADO '04 - CONTABILIZADO'
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' GPV
        USING ( SELECT GPV.GPV_ID FROM '||V_ESQUEMA||'.'||V_TABLA||' GPV
                INNER JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE
                  ON GGE.GPV_ID = GPV.GPV_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH
                  ON GGE.DD_EAH_ID = EAH.DD_EAH_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAP_ESTADOS_AUTORIZ_PROP EAP
                  ON GGE.DD_EAP_ID = EAP.DD_EAP_ID
                INNER JOIN '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD GIC
                  ON GIC.GPV_ID = GPV.GPV_ID
                WHERE EAH.DD_EAH_CODIGO = ''03''
                AND EAP.DD_EAP_CODIGO = ''07''
                AND GIC.GIC_FECHA_CONTABILIZACION IS NOT NULL
                ) AUX
                ON (GPV.GPV_ID = AUX.GPV_ID)
                WHEN MATCHED THEN UPDATE SET
                  GPV.DD_EGA_ID = (SELECT DD_EGA_ID FROM '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''04'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. 04 - CONTABILIZADO');
    
    
    --ACTUALIZACION DE GASTOS CON ESTADO '05 - PAGADO'
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' GPV
        USING ( SELECT GPV.GPV_ID FROM '||V_ESQUEMA||'.'||V_TABLA||' GPV
                INNER JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE
                  ON GGE.GPV_ID = GPV.GPV_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH
                  ON GGE.DD_EAH_ID = EAH.DD_EAH_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAP_ESTADOS_AUTORIZ_PROP EAP
                  ON GGE.DD_EAP_ID = EAP.DD_EAP_ID
                INNER JOIN '||V_ESQUEMA||'.GDE_GASTOS_DETALLE_ECONOMICO GDE
                  ON GDE.GPV_ID = GPV.GPV_ID
                WHERE EAH.DD_EAH_CODIGO = ''03''
                AND EAP.DD_EAP_CODIGO = ''07''
                AND GDE.GDE_FECHA_PAGO IS NOT NULL
                ) AUX
                ON (GPV.GPV_ID = AUX.GPV_ID)
                WHEN MATCHED THEN UPDATE SET
                  GPV.DD_EGA_ID = (SELECT DD_EGA_ID FROM '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''05'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. 05 - PAGADO');
    
    
    --ACTUALIZACION DE GASTOS CON ESTADO '06 - ANULADO'
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' GPV
        USING ( SELECT GPV.GPV_ID FROM '||V_ESQUEMA||'.'||V_TABLA||' GPV
                INNER JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE
                  ON GGE.GPV_ID = GPV.GPV_ID
                WHERE GGE.GGE_FECHA_ANULACION IS NOT NULL
                ) AUX
                ON (GPV.GPV_ID = AUX.GPV_ID)
                WHEN MATCHED THEN UPDATE SET
                  GPV.DD_EGA_ID = (SELECT DD_EGA_ID FROM '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''06'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. 06 - ANULADO');
    
    
    --ACTUALIZACION DE GASTOS CON ESTADO '07 - RETENIDO'
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' GPV
        USING ( SELECT GPV.GPV_ID FROM '||V_ESQUEMA||'.'||V_TABLA||' GPV
                INNER JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE
                  ON GGE.GPV_ID = GPV.GPV_ID
                WHERE GGE.GGE_FECHA_RP IS NOT NULL
                ) AUX
                ON (GPV.GPV_ID = AUX.GPV_ID)
                WHEN MATCHED THEN UPDATE SET
                  GPV.DD_EGA_ID = (SELECT DD_EGA_ID FROM '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''07'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. 07 - RETENIDO');
    
    
    --ACTUALIZACION DE GASTOS CON ESTADO '08 - RECHAZO PROPIETARIO'
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' GPV
        USING ( SELECT GPV.GPV_ID FROM '||V_ESQUEMA||'.'||V_TABLA||' GPV
                INNER JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE
                  ON GGE.GPV_ID = GPV.GPV_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH
                  ON GGE.DD_EAH_ID = EAH.DD_EAH_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAP_ESTADOS_AUTORIZ_PROP EAP
                  ON GGE.DD_EAP_ID = EAP.DD_EAP_ID
                WHERE EAH.DD_EAH_CODIGO = ''02''
                AND EAP.DD_EAP_CODIGO = ''02'' OR EAP.DD_EAP_CODIGO = ''03'' OR EAP.DD_EAP_CODIGO = ''04''
                ) AUX
                ON (GPV.GPV_ID = AUX.GPV_ID)
                WHEN MATCHED THEN UPDATE SET
                  GPV.DD_EGA_ID = (SELECT DD_EGA_ID FROM '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''08'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. 08 - RECHAZO PROPIETARIO');
    
    
    --ACTUALIZACION DE GASTOS CON ESTADO '09 - AUTORIZADO PROPIETARIO'
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' GPV
        USING ( SELECT GPV.GPV_ID FROM '||V_ESQUEMA||'.'||V_TABLA||' GPV
                INNER JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE
                  ON GGE.GPV_ID = GPV.GPV_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH
                  ON GGE.DD_EAH_ID = EAH.DD_EAH_ID
                INNER JOIN '||V_ESQUEMA||'.DD_EAP_ESTADOS_AUTORIZ_PROP EAP
                  ON GGE.DD_EAP_ID = EAP.DD_EAP_ID
                WHERE EAH.DD_EAH_CODIGO = ''03''
                AND (EAP.DD_EAP_CODIGO = ''05'' OR EAP.DD_EAP_CODIGO = ''06'')
                ) AUX
                ON (GPV.GPV_ID = AUX.GPV_ID)
                WHEN MATCHED THEN UPDATE SET
                  GPV.DD_EGA_ID = (SELECT DD_EGA_ID FROM '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''09'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. 09 - AUTORIZADO PROPIETARIO');   
    
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA||''',''10''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' ANALIZADA.');
    
    COMMIT;
      
EXCEPTION
      WHEN OTHERS THEN
            DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
            DBMS_OUTPUT.put_line('-----------------------------------------------------------');
            DBMS_OUTPUT.put_line(SQLERRM);
            ROLLBACK;
            RAISE;
END;

/

EXIT;
