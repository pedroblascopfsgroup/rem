--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20170801
--## ARTEFACTO=migracion
--## VERSION_ARTEFACTO=2.0.7
--## INCIDENCIA_LINK=HREOS-2567
--## PRODUCTO=NO
--## 
--## Finalidad: Proceso de migración Fase 2, para la actualizacion de estados del gasto.
--##                    
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

    V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
    V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
    V_TABLA VARCHAR2(40 CHAR) := 'GPV_GASTOS_PROVEEDOR';
    V_SENTENCIA VARCHAR2(32000 CHAR);
    V_REG_ACTUALIZADOS NUMBER(10,0) := 0;
    V_REG_TOTAL NUMBER(10,0) := 0;
      
BEGIN
    
    DBMS_OUTPUT.PUT_LINE('------------------------------------------------------------------------------------') ;
    DBMS_OUTPUT.PUT_LINE('PROCESO DE ACTUALIZACION DE ESTADOS DE GASTOS PARA LAS GASTOS MIGRADOS EN FASE 2....') ;
    DBMS_OUTPUT.PUT_LINE('------------------------------------------------------------------------------------') ;

    --GASTOS CON ESTADO ANULADO
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
            USING (SELECT GPV.GPV_ID 
                FROM REM01.GPV_GASTOS_PROVEEDOR GPV
                JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
                JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
                JOIN REM01.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
                WHERE GGE.GGE_FECHA_ANULACION IS NOT NULL AND GPV.DD_EGA_ID IS NULL) T2
            ON (T1.GPV_ID = T2.GPV_ID)
            WHEN MATCHED THEN UPDATE SET
                T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''06'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS CON ESTADO ANULADO');
    
    
    --GASTOS CON ESTADO PAGADO
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAP_ESTADOS_AUTORIZ_PROP EAP ON GGE.DD_EAP_ID = EAP.DD_EAP_ID AND EAP.DD_EAP_CODIGO IN (''05'',''06'',''07'')
            WHERE (GDE.GDE_FECHA_PAGO IS NOT NULL OR GIC.GIC_FECHA_CONTABILIZACION IS NOT NULL OR GGE.GGE_FECHA_EAP IS NOT NULL) AND GPV.DD_EGA_ID IS NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''05'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS CON ESTADO PAGADO');
    
    
    --GASTOS EN ESTADO RECHAZADO PROPIETARIO
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAP_ESTADOS_AUTORIZ_PROP EAP ON GGE.DD_EAP_ID = EAP.DD_EAP_ID AND EAP.DD_EAP_CODIGO IN (''02'',''03'',''04'')
            WHERE GGE.GGE_FECHA_EAP IS NOT NULL AND GPV.DD_EGA_ID IS NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''08'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS EN ESTADO RECHAZADO PROPIETARIO');
    
    
    --GASTOS EN ESTADO INCOMPLETO
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
            WHERE GGE.GGE_FECHA_EAH IS NULL AND GPV.DD_EGA_ID IS NULL AND (GPV.PVE_ID_EMISOR IS NULL OR GPV.DD_TGA_ID IS NULL 
                OR GPV.DD_STG_ID IS NULL OR GPV.GPV_FECHA_EMISION IS NULL OR GPV.GPV_REF_EMISOR IS NULL 
                OR GPV.DD_TPE_ID IS NULL OR GPV.DD_TOG_ID IS NULL OR GDE.GDE_PRINCIPAL_NO_SUJETO IS NULL)) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''12'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS EN ESTADO INCOMPLETO');
    
    
    --GASTOS EN ESTADO PENDIENTE DE AUTORIZAR
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
            WHERE GGE.GGE_FECHA_EAH IS NULL AND GPV.DD_EGA_ID IS NULL AND GPV.PVE_ID_EMISOR IS NOT NULL AND GPV.DD_TGA_ID IS NOT NULL 
                AND GPV.DD_STG_ID IS NOT NULL AND GPV.GPV_FECHA_EMISION IS NOT NULL AND GPV.GPV_REF_EMISOR IS NOT NULL 
                AND GPV.DD_TPE_ID IS NOT NULL AND GPV.DD_TOG_ID IS NOT NULL AND GDE.GDE_PRINCIPAL_NO_SUJETO IS NOT NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''01'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS EN ESTADO PENDIENTE DE AUTORIZAR');
    
    
    --GASTOS EN ESTADO AUTORIZADO HRE
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH ON GGE.DD_EAH_ID = EAH.DD_EAH_ID AND EAH.DD_EAH_CODIGO = ''03''
            WHERE GGE.GGE_FECHA_EAH IS NOT NULL AND GPV.DD_EGA_ID IS NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''03'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS EN ESTADO AUTORIZADO HRE');
    
    
    --GASTOS EN ESTADO RECHAZADO HRE
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    V_SENTENCIA := '
        MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH ON GGE.DD_EAH_ID = EAH.DD_EAH_ID AND EAH.DD_EAH_CODIGO = ''02''
            WHERE GGE.GGE_FECHA_EAH IS NOT NULL AND GPV.DD_EGA_ID IS NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''02'')
    '
    ;
    EXECUTE IMMEDIATE V_SENTENCIA;
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
     
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS EN ESTADO RECHAZADO HRE');   
    
    V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA||''',''10''); END;';
    EXECUTE IMMEDIATE V_SENTENCIA;
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' ANALIZADA.');
    
    COMMIT;
      
EXCEPTION
      WHEN OTHERS THEN
            DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
            DBMS_OUTPUT.put_line('-----------------------------------------------------------');
            DBMS_OUTPUT.put_line(SQLERRM);
            ROLLBACK;
            RAISE;
END;

/

EXIT;
