--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20171010
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-2204
--## PRODUCTO=NO
--## 
--## Finalidad: Proceso de migración de gestores de ofertas.
--##                    
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

  V_ESQUEMA VARCHAR2(30 CHAR):= 'REM01'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(30 CHAR):= 'REMMASTER'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(32000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

  USUARIO_MIGRACION VARCHAR2(50 CHAR):= '#USUARIO_MIGRACION#';

BEGIN
      
      DBMS_OUTPUT.PUT_LINE('[INICIO]');

     EXECUTE IMMEDIATE 'UPDATE REM01.GEE_GESTOR_ENTIDAD SET USUARIOMODIFICAR = NULL WHERE USUARIOCREAR = '''||USUARIO_MIGRACION||''' AND USUARIOMODIFICAR IS NOT NULL';
      EXECUTE IMMEDIATE 'UPDATE REM01.GEH_GESTOR_ENTIDAD_HIST SET USUARIOMODIFICAR = NULL WHERE USUARIOCREAR = '''||USUARIO_MIGRACION||''' AND USUARIOMODIFICAR IS NOT NULL';
      COMMIT;
       -------------------------------------------------
      --INSERCION EN GEE_GESTOR_ENTIDAD--
      -------------------------------------------------
      
      DBMS_OUTPUT.PUT_LINE('  [INFO] INSERCION EN GEE_GESTOR_ENTIDAD ');
      
       V_SQL := '
		INSERT INTO /*+ APPEND */ REM01.GEE_GESTOR_ENTIDAD (GEE_ID, USU_ID, DD_TGE_ID, USUARIOCREAR, FECHACREAR, USUARIOMODIFICAR)
		SELECT REM01.S_GEE_GESTOR_ENTIDAD.NEXTVAL, USU.USU_ID, TGE.DD_TGE_ID, '''||USUARIO_MIGRACION||''', SYSDATE, ECO.ECO_ID
		FROM REM01.MIG2_GEO_GESTORES_OFERTAS GEO
		JOIN REM01.OFR_OFERTAS OFR ON OFR.OFR_NUM_OFERTA = GEO.GEO_COD_OFERTA AND OFR.BORRADO = 0
		JOIN REMMASTER.USU_USUARIOS USU ON USU.USU_USERNAME = GEO.GEO_GESTOR_ACTIVO AND USU.BORRADO = 0
		JOIN REMMASTER.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_CODIGO = GEO.GEO_TIPO_GESTOR AND TGE.BORRADO = 0
		JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID AND ECO.BORRADO = 0
		LEFT JOIN REM01.GCO_GESTOR_ADD_ECO GCO ON GCO.ECO_ID = ECO.ECO_ID
		LEFT JOIN REM01.GEE_GESTOR_ENTIDAD GEE ON GEE.USU_ID = USU.USU_ID AND GEE.DD_TGE_ID = TGE.DD_TGE_ID 
		    AND GEE.GEE_ID = GCO.GEE_ID
		WHERE GEO.VALIDACION = 0 AND GEE.GEE_ID IS NULL
      '
      ;
      EXECUTE IMMEDIATE V_SQL;
      
      DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD cargada. '||SQL%ROWCOUNT||' Filas.');     
	  
	  -------------------------------------------------
      --INSERCION EN GCO_GESTOR_ADD_ECO--
      -------------------------------------------------
      
      DBMS_OUTPUT.PUT_LINE('  [INFO] INSERCION EN GCO_GESTOR_ADD_ECO ');
      
       V_SQL := '
		INSERT INTO /*+ APPEND */ REM01.GCO_GESTOR_ADD_ECO (GEE_ID, ECO_ID)
		SELECT GEE.GEE_ID, TO_NUMBER(GEE.USUARIOMODIFICAR)
		FROM REM01.GEE_GESTOR_ENTIDAD GEE
		LEFT JOIN REM01.GCO_GESTOR_ADD_ECO GCO ON GCO.GEE_ID = GEE.GEE_ID AND TO_CHAR(GCO.ECO_ID) = GEE.USUARIOMODIFICAR
		WHERE GEE.USUARIOCREAR = '''||USUARIO_MIGRACION||''' AND GEE.USUARIOMODIFICAR IS NOT NULL AND GCO.GEE_ID IS NULL
      '
      ;
      EXECUTE IMMEDIATE V_SQL;
      
      DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.GCO_GESTOR_ADD_ECO cargada. '||SQL%ROWCOUNT||' Filas.'); 

      -------------------------------------------------
      --INSERCION EN GEH_GESTOR_ENTIDAD_HIST--
      -------------------------------------------------
      
      DBMS_OUTPUT.PUT_LINE('  [INFO] INSERCION EN GEH_GESTOR_ENTIDAD_HIST ');
      
       V_SQL := '
		INSERT INTO /*+ APPEND */ REM01.GEH_GESTOR_ENTIDAD_HIST (GEH_ID, USU_ID, DD_TGE_ID, GEH_FECHA_DESDE
		    , USUARIOCREAR, FECHACREAR, USUARIOMODIFICAR)
		SELECT S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL, GEE.USU_ID, GEE.DD_TGE_ID
		    , SYSDATE, '''||USUARIO_MIGRACION||''', SYSDATE, ECO.ECO_ID
		FROM REM01.MIG2_GEO_GESTORES_OFERTAS GEO
		JOIN REM01.OFR_OFERTAS OFR ON OFR.OFR_NUM_OFERTA = GEO.GEO_COD_OFERTA AND OFR.BORRADO = 0
		JOIN REMMASTER.USU_USUARIOS USU ON USU.USU_USERNAME = GEO.GEO_GESTOR_ACTIVO AND USU.BORRADO = 0
		JOIN REMMASTER.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_CODIGO = GEO.GEO_TIPO_GESTOR AND TGE.BORRADO = 0
		JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID AND ECO.BORRADO = 0
		LEFT JOIN REM01.GCH_GESTOR_ECO_HISTORICO GCO ON GCO.ECO_ID = ECO.ECO_ID
		LEFT JOIN REM01.GEH_GESTOR_ENTIDAD_HIST GEE ON GEE.USU_ID = USU.USU_ID AND GEE.DD_TGE_ID = TGE.DD_TGE_ID 
		    AND GEE.GEH_ID = GCO.GEH_ID
		WHERE GEO.VALIDACION = 0 AND GEE.GEH_ID IS NULL
      '
      ;
      EXECUTE IMMEDIATE V_SQL;
      
      DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST cargada. '||SQL%ROWCOUNT||' Filas.'); 

      -------------------------------------------------
      --INSERCION EN GCH_GESTOR_ECO_HISTORICO--
      -------------------------------------------------
      
      DBMS_OUTPUT.PUT_LINE('  [INFO] INSERCION EN GCH_GESTOR_ECO_HISTORICO ');
      
       V_SQL := '
		INSERT INTO /*+ APPEND */ REM01.GCH_GESTOR_ECO_HISTORICO (GEH_ID, ECO_ID)
		SELECT GEE.GEH_ID, TO_NUMBER(GEE.USUARIOMODIFICAR)
		FROM REM01.GEH_GESTOR_ENTIDAD_HIST GEE
		LEFT JOIN REM01.GCH_GESTOR_ECO_HISTORICO GCO ON GCO.GEH_ID = GEE.GEH_ID AND TO_CHAR(GCO.ECO_ID) = GEE.USUARIOMODIFICAR
		WHERE GEE.USUARIOCREAR = '''||USUARIO_MIGRACION||''' AND GEE.USUARIOMODIFICAR IS NOT NULL AND GCO.GEH_ID IS NULL
      '
      ;
      EXECUTE IMMEDIATE V_SQL;
      
      DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.GCH_GESTOR_ECO_HISTORICO cargada. '||SQL%ROWCOUNT||' Filas.');

       V_SQL := 'UPDATE REM01.GEE_GESTOR_ENTIDAD SET USUARIOMODIFICAR = NULL WHERE USUARIOCREAR = '''||USUARIO_MIGRACION||''' AND USUARIOMODIFICAR IS NOT NULL AND FECHAMODIFICAR IS NULL';
       EXECUTE IMMEDIATE V_SQL;

       V_SQL := 'UPDATE REM01.GEH_GESTOR_ENTIDAD_HIST SET USUARIOMODIFICAR = NULL WHERE USUARIOCREAR = '''||USUARIO_MIGRACION||''' AND USUARIOMODIFICAR IS NOT NULL AND FECHAMODIFICAR IS NULL';
       EXECUTE IMMEDIATE V_SQL;

      DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.GCH_GESTOR_ECO_HISTORICO cargada. '||SQL%ROWCOUNT||' Filas.');

      COMMIT; 
      
      /*DBMS_OUTPUT.PUT_LINE('  [INFO] Analizando tablas.');

      V_SQL := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'',''GEE_GESTOR_ENTIDAD'',''1''); END;';
      EXECUTE IMMEDIATE V_SQL;
      DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla GEE_GESTOR_ENTIDAD analizada.');

      V_SQL := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'',''GCO_GESTOR_ADD_ECO'',''1''); END;';
      EXECUTE IMMEDIATE V_SQL;
      DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla GCO_GESTOR_ADD_ECO analizada.');

      V_SQL := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'',''GEH_GESTOR_ENTIDAD_HIST'',''1''); END;';
      EXECUTE IMMEDIATE V_SQL;
      DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla GEH_GESTOR_ENTIDAD_HIST analizada.');

      V_SQL := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'',''GCH_GESTOR_ECO_HISTORICO'',''1''); END;';
      EXECUTE IMMEDIATE V_SQL;
      DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla GCH_GESTOR_ECO_HISTORICO analizada.');*/
      
      DBMS_OUTPUT.PUT_LINE('[FIN] - '||to_char(sysdate,'HH24:MI:SS'));
      
EXCEPTION
      WHEN OTHERS THEN
            DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
            DBMS_OUTPUT.put_line('-----------------------------------------------------------');
            DBMS_OUTPUT.put_line(SQLERRM);
            ROLLBACK;
            RAISE;
END;

/

EXIT;