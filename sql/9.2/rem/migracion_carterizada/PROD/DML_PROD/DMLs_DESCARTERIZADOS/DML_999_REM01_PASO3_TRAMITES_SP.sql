--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20170719
--## ARTEFACTO=migracion
--## VERSION_ARTEFACTO=2.0.7
--## INCIDENCIA_LINK=HREOS-2366
--## PRODUCTO=NO
--## 
--## Finalidad: Proceso de migración Fase 2, para la generacion de tramites, BPM.
--##                    
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
 V_USUARIO VARCHAR2(200);
 PL_OUTPUT VARCHAR2(20000);

BEGIN
 V_USUARIO := '#USUARIO_MIGRACION#';

execute immediate 'MERGE INTO TAC_TAREAS_ACTIVOS T1
USING (SELECT T6.TAR_ID, T6.TRA_ID, T6.ACT_ID, T4.LCO_GESTOR_COMERCIAL
    FROM OFR_OFERTAS T1
    JOIN ACT_AGR_AGRUPACION T2 ON T1.AGR_ID = T2.AGR_ID AND T2.BORRADO = 0
    JOIN DD_TAG_TIPO_AGRUPACION T3 ON T3.DD_TAG_ID = T2.DD_TAG_ID AND T3.DD_TAG_CODIGO = ''14''
    JOIN ACT_LCO_LOTE_COMERCIAL T4 ON T4.AGR_ID = T2.AGR_ID
    JOIN ACT_OFR T5 ON T5.OFR_ID = T1.OFR_ID
    JOIN ECO_EXPEDIENTE_COMERCIAL T7 ON T7.OFR_ID = T1.OFR_ID
    JOIN TAC_TAREAS_ACTIVOS T6 ON T6.ACT_ID = T5.ACT_ID AND T6.USUARIOCREAR = '''||V_USUARIO||'''
    JOIN TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = T6.TAR_ID
    JOIN TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID
    JOIN TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID AND TAP.TAP_CODIGO IN (''T013_DefinicionOferta'',''T013_RespuestaOfertante'',''T013_InstruccionesReserva'')
    WHERE T4.LCO_GESTOR_COMERCIAL IS NOT NULL) T2
ON (T1.TAR_ID = T2.TAR_ID AND T1.TRA_ID = T2.TRA_ID AND T1.ACT_ID = T2.ACT_ID)
WHEN MATCHED THEN UPDATE SET
    T1.USU_ID = T2.LCO_GESTOR_COMERCIAL, T1.SUP_ID = T2.LCO_GESTOR_COMERCIAL';
    
execute immediate 'MERGE INTO TAC_TAREAS_ACTIVOS T1
USING (SELECT T6.TAR_ID, T6.TRA_ID, T6.ACT_ID, T12.USU_ID
    FROM OFR_OFERTAS T1
    JOIN ACT_AGR_AGRUPACION T2 ON T1.AGR_ID = T2.AGR_ID AND T2.BORRADO = 0
    JOIN DD_TAG_TIPO_AGRUPACION T3 ON T3.DD_TAG_ID = T2.DD_TAG_ID AND T3.DD_TAG_CODIGO <> ''14''
    JOIN ACT_OFR T5 ON T5.OFR_ID = T1.OFR_ID
    JOIN ECO_EXPEDIENTE_COMERCIAL T7 ON T7.OFR_ID = T1.OFR_ID
    JOIN TAC_TAREAS_ACTIVOS T6 ON T6.ACT_ID = T5.ACT_ID AND T6.USUARIOCREAR = '''||V_USUARIO||'''
    JOIN TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = T6.TAR_ID
    JOIN TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID
    JOIN TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID AND TAP.TAP_CODIGO IN (''T013_DefinicionOferta'',''T013_RespuestaOfertante'')
    JOIN ACT_PVE_PROVEEDOR T4 ON T4.PVE_ID = T1.PVE_ID_PRESCRIPTOR
    JOIN DD_TPR_TIPO_PROVEEDOR T9 ON T9.DD_TPR_ID = T4.DD_TPR_ID AND T9.DD_TPR_CODIGO = ''18''
    JOIN ACT_ACTIVO T10 ON T10.ACT_ID = T5.ACT_ID AND T10.BORRADO = 0
    JOIN GAC_GESTOR_ADD_ACTIVO T11 ON T11.ACT_ID = T10.ACT_ID
    JOIN GEE_GESTOR_ENTIDAD T12 ON T12.GEE_ID = T11.GEE_ID
    JOIN REMMASTER.DD_TGE_TIPO_GESTOR T13 ON T13.DD_TGE_ID = T12.DD_TGE_ID AND T13.DD_TGE_CODIGO = ''FVDBACKOFR'') T2
ON (T1.TAR_ID = T2.TAR_ID AND T1.TRA_ID = T2.TRA_ID AND T1.ACT_ID = T2.ACT_ID)
WHEN MATCHED THEN UPDATE SET
    T1.USU_ID = T2.USU_ID';
    
execute immediate 'MERGE INTO TAC_TAREAS_ACTIVOS T1
USING (SELECT T6.TAR_ID, T6.TRA_ID, T6.ACT_ID, T12.USU_ID
    FROM OFR_OFERTAS T1
    JOIN ACT_AGR_AGRUPACION T2 ON T1.AGR_ID = T2.AGR_ID AND T2.BORRADO = 0
    JOIN DD_TAG_TIPO_AGRUPACION T3 ON T3.DD_TAG_ID = T2.DD_TAG_ID AND T3.DD_TAG_CODIGO <> ''14''
    JOIN ACT_OFR T5 ON T5.OFR_ID = T1.OFR_ID
    JOIN ECO_EXPEDIENTE_COMERCIAL T7 ON T7.OFR_ID = T1.OFR_ID
    JOIN TAC_TAREAS_ACTIVOS T6 ON T6.ACT_ID = T5.ACT_ID AND T6.USUARIOCREAR = '''||V_USUARIO||'''
    JOIN TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = T6.TAR_ID
    JOIN TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID
    JOIN TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID AND TAP.TAP_CODIGO IN (''T013_DefinicionOferta'',''T013_RespuestaOfertante'')
    JOIN ACT_PVE_PROVEEDOR T4 ON T4.PVE_ID = T1.PVE_ID_PRESCRIPTOR
    JOIN DD_TPR_TIPO_PROVEEDOR T9 ON T9.DD_TPR_ID = T4.DD_TPR_ID AND T9.DD_TPR_CODIGO = ''18''
    JOIN ACT_ACTIVO T10 ON T10.ACT_ID = T5.ACT_ID AND T10.BORRADO = 0
    JOIN GAC_GESTOR_ADD_ACTIVO T11 ON T11.ACT_ID = T10.ACT_ID
    JOIN GEE_GESTOR_ENTIDAD T12 ON T12.GEE_ID = T11.GEE_ID
    JOIN REMMASTER.DD_TGE_TIPO_GESTOR T13 ON T13.DD_TGE_ID = T12.DD_TGE_ID AND T13.DD_TGE_CODIGO = ''SCOM'') T2
ON (T1.TAR_ID = T2.TAR_ID AND T1.TRA_ID = T2.TRA_ID AND T1.ACT_ID = T2.ACT_ID)
WHEN MATCHED THEN UPDATE SET
    T1.SUP_ID = T2.USU_ID';
    
execute immediate 'MERGE INTO TAC_TAREAS_ACTIVOS T1
USING (SELECT T6.TAR_ID, T6.TRA_ID, T6.ACT_ID, T12.USU_ID
    FROM OFR_OFERTAS T1
    JOIN ACT_AGR_AGRUPACION T2 ON T1.AGR_ID = T2.AGR_ID AND T2.BORRADO = 0
    JOIN DD_TAG_TIPO_AGRUPACION T3 ON T3.DD_TAG_ID = T2.DD_TAG_ID AND T3.DD_TAG_CODIGO <> ''14''
    JOIN ACT_OFR T5 ON T5.OFR_ID = T1.OFR_ID
    JOIN ECO_EXPEDIENTE_COMERCIAL T7 ON T7.OFR_ID = T1.OFR_ID
    JOIN TAC_TAREAS_ACTIVOS T6 ON T6.ACT_ID = T5.ACT_ID AND T6.USUARIOCREAR = '''||V_USUARIO||'''
    JOIN TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = T6.TAR_ID
    JOIN TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID
    JOIN TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID AND TAP.TAP_CODIGO = ''T013_InstruccionesReserva''
    JOIN ACT_PVE_PROVEEDOR T4 ON T4.PVE_ID = T1.PVE_ID_PRESCRIPTOR
    JOIN DD_TPR_TIPO_PROVEEDOR T9 ON T9.DD_TPR_ID = T4.DD_TPR_ID AND T9.DD_TPR_CODIGO = ''18''
    JOIN ACT_ACTIVO T10 ON T10.ACT_ID = T5.ACT_ID AND T10.BORRADO = 0
    JOIN GAC_GESTOR_ADD_ACTIVO T11 ON T11.ACT_ID = T10.ACT_ID
    JOIN GEE_GESTOR_ENTIDAD T12 ON T12.GEE_ID = T11.GEE_ID
    JOIN REMMASTER.DD_TGE_TIPO_GESTOR T13 ON T13.DD_TGE_ID = T12.DD_TGE_ID AND T13.DD_TGE_CODIGO = ''FVDBACKVNT'') T2
ON (T1.TAR_ID = T2.TAR_ID AND T1.TRA_ID = T2.TRA_ID AND T1.ACT_ID = T2.ACT_ID)
WHEN MATCHED THEN UPDATE SET
    T1.USU_ID = T2.USU_ID';
    
execute immediate 'MERGE INTO TAC_TAREAS_ACTIVOS T1
USING (SELECT T6.TAR_ID, T6.TRA_ID, T6.ACT_ID, T12.USU_ID
    FROM OFR_OFERTAS T1
    JOIN ACT_AGR_AGRUPACION T2 ON T1.AGR_ID = T2.AGR_ID AND T2.BORRADO = 0
    JOIN DD_TAG_TIPO_AGRUPACION T3 ON T3.DD_TAG_ID = T2.DD_TAG_ID AND T3.DD_TAG_CODIGO <> ''14''
    JOIN ACT_OFR T5 ON T5.OFR_ID = T1.OFR_ID
    JOIN ECO_EXPEDIENTE_COMERCIAL T7 ON T7.OFR_ID = T1.OFR_ID
    JOIN TAC_TAREAS_ACTIVOS T6 ON T6.ACT_ID = T5.ACT_ID AND T6.USUARIOCREAR = '''||V_USUARIO||'''
    JOIN TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = T6.TAR_ID
    JOIN TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID
    JOIN TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID AND TAP.TAP_CODIGO = ''T013_InstruccionesReserva''
    JOIN ACT_PVE_PROVEEDOR T4 ON T4.PVE_ID = T1.PVE_ID_PRESCRIPTOR
    JOIN DD_TPR_TIPO_PROVEEDOR T9 ON T9.DD_TPR_ID = T4.DD_TPR_ID AND T9.DD_TPR_CODIGO = ''18''
    JOIN ACT_ACTIVO T10 ON T10.ACT_ID = T5.ACT_ID AND T10.BORRADO = 0
    JOIN GAC_GESTOR_ADD_ACTIVO T11 ON T11.ACT_ID = T10.ACT_ID
    JOIN GEE_GESTOR_ENTIDAD T12 ON T12.GEE_ID = T11.GEE_ID
    JOIN REMMASTER.DD_TGE_TIPO_GESTOR T13 ON T13.DD_TGE_ID = T12.DD_TGE_ID AND T13.DD_TGE_CODIGO = ''SCOM'') T2
ON (T1.TAR_ID = T2.TAR_ID AND T1.TRA_ID = T2.TRA_ID AND T1.ACT_ID = T2.ACT_ID)
WHEN MATCHED THEN UPDATE SET
    T1.SUP_ID = T2.USU_ID';
    
execute immediate 'MERGE INTO TAC_TAREAS_ACTIVOS T1
USING (SELECT T6.TAR_ID, T6.TRA_ID, T6.ACT_ID, T12.USU_ID
    FROM TAC_TAREAS_ACTIVOS T6 
    JOIN TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = T6.TAR_ID
    JOIN TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID
    JOIN TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID AND TAP.TAP_CODIGO = ''T013_ResultadoPBC''
    JOIN ACT_ACTIVO T10 ON T10.ACT_ID = T6.ACT_ID AND T10.BORRADO = 0
    JOIN GAC_GESTOR_ADD_ACTIVO T11 ON T11.ACT_ID = T10.ACT_ID
    JOIN GEE_GESTOR_ENTIDAD T12 ON T12.GEE_ID = T11.GEE_ID
    JOIN REMMASTER.DD_TGE_TIPO_GESTOR T13 ON T13.DD_TGE_ID = T12.DD_TGE_ID AND T13.DD_TGE_CODIGO = ''GFORM''
    WHERE T6.USUARIOCREAR = '''||V_USUARIO||''') T2
ON (T1.TAR_ID = T2.TAR_ID AND T1.TRA_ID = T2.TRA_ID AND T1.ACT_ID = T2.ACT_ID)
WHEN MATCHED THEN UPDATE SET
    T1.SUP_ID = T2.USU_ID';
    
execute immediate 'MERGE INTO TAC_TAREAS_ACTIVOS T1
USING (SELECT T6.TAR_ID, T6.TRA_ID, T6.ACT_ID, T12.USU_ID
    FROM TAC_TAREAS_ACTIVOS T6 
    JOIN TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = T6.TAR_ID
    JOIN TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID
    JOIN TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID AND TAP.TAP_CODIGO = ''T013_ResultadoPBC''
    JOIN ACT_ACTIVO T10 ON T10.ACT_ID = T6.ACT_ID AND T10.BORRADO = 0
    JOIN GAC_GESTOR_ADD_ACTIVO T11 ON T11.ACT_ID = T10.ACT_ID
    JOIN GEE_GESTOR_ENTIDAD T12 ON T12.GEE_ID = T11.GEE_ID
    JOIN REMMASTER.DD_TGE_TIPO_GESTOR T13 ON T13.DD_TGE_ID = T12.DD_TGE_ID AND T13.DD_TGE_CODIGO = ''SFORM''
    WHERE T6.USUARIOCREAR = '''||V_USUARIO||''') T2
ON (T1.TAR_ID = T2.TAR_ID AND T1.TRA_ID = T2.TRA_ID AND T1.ACT_ID = T2.ACT_ID)
WHEN MATCHED THEN UPDATE SET
    T1.SUP_ID = T2.USU_ID';

 PL_OUTPUT := NULL;

 REM01.ALTA_BPM_INSTANCES ( V_USUARIO, PL_OUTPUT );
 DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
 COMMIT;
      
EXCEPTION
      WHEN OTHERS THEN
            DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
            DBMS_OUTPUT.put_line('-----------------------------------------------------------');
            DBMS_OUTPUT.put_line(SQLERRM);
            ROLLBACK;
            RAISE;
END;

/

EXIT;