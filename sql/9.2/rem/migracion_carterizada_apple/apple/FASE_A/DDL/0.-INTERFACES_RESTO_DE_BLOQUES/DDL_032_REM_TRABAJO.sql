--/*
--#########################################
--## AUTOR=CLV
--## FECHA_CREACION=201600802
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-719
--## PRODUCTO=NO
--## 
--## Finalidad: Creación de tabla de migración 'MIG_ATR_TRABAJO'
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

TABLE_COUNT NUMBER(1,0) := 0;
V_ESQUEMA_1 VARCHAR2(20 CHAR) := 'REM01';
V_ESQUEMA_2 VARCHAR2(20 CHAR) := 'REM01'; --SE CREA UNA SEGUNDA VARIABLE DE ESQUEMA POR SI EN ALGÚN MOMENTO QUEREMOS CREAR LA TABLA EN UN ESQUEMA DIFERENTE AL DEL USUARIO QUE LA ACCEDE O VICEVERSA
V_TABLESPACE_IDX VARCHAR2(30 CHAR) := '#TABLESPACE_INDEX#';
V_TABLA VARCHAR2(40 CHAR) := 'MIG_ATR_TRABAJO';

BEGIN

SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE TABLE_NAME = ''||V_TABLA||'' AND OWNER= ''||V_ESQUEMA_1||'';

IF TABLE_COUNT > 0 THEN

    DBMS_OUTPUT.PUT_LINE('[INFO] TABLA '||V_ESQUEMA_1||'.'||V_TABLA||' YA EXISTENTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'DROP TABLE '||V_ESQUEMA_1||'.'||V_TABLA||'';
    
END IF;

EXECUTE IMMEDIATE '
CREATE TABLE '||V_ESQUEMA_1||'.'||V_TABLA||'
(
	ACT_NUMERO_ACTIVO					NUMBER(16,0)					NOT NULL,
	AGR_EXTERNO							NUMBER(16,0)					NOT NULL,
	TBJ_NUM_TRABAJO						NUMBER(16,0)					NOT NULL,
	PVC_DOCIDENTIF						VARCHAR2(20 CHAR)				NOT NULL,
	TIPO_TRABAJO						VARCHAR2(20 CHAR)				NOT NULL,
	SUBTIPO_TRABAJO						VARCHAR2(20 CHAR)				NOT NULL,
	ESTADO_TRABAJO						VARCHAR2(20 CHAR)				NOT NULL,
	TBJ_DESCRIPCION						VARCHAR2(256 CHAR),
	TBJ_FECHA_SOLICITUD					DATE							NOT NULL,
	TBJ_FECHA_APROBACION				DATE,
	TBJ_FECHA_INICIO					DATE,
	TBJ_FECHA_FIN						DATE							NOT NULL,
	TBJ_FECHA_FIN_COMPROMISO			DATE,
	TBJ_FECHA_TOPE						DATE,
	TBJ_FECHA_HORA_CONCRETA				TIMESTAMP,
	TBJ_URGENTE							NUMBER(1,0),
	TBJ_CON_RIESGO_TERCEROS				NUMBER(1,0),
	TBJ_CUBRE_SEGURO					NUMBER(1,0),
	TBJ_CIA_ASEGURADORA					VARCHAR2(256 CHAR),
	TIPO_CALIDAD						VARCHAR2(20 CHAR),
	TBJ_TERCERO_NOMBRE					VARCHAR2(256 CHAR),
	TBJ_TERCERO_EMAIL					VARCHAR2(256 CHAR),
	TBJ_TERCERO_DIRECCION				VARCHAR2(256 CHAR),
	TBJ_TERCERO_CONTACTO				VARCHAR2(256 CHAR),
	TBJ_TERCERO_TEL1					VARCHAR2(16 CHAR),
	TBJ_TERCERO_TEL2					VARCHAR2(16 CHAR),
	TBJ_IMPORTE_PENAL_DIARIO			NUMBER(16,2),
	TBJ_OBSERVACIONES					VARCHAR2(1024 CHAR),
	TBJ_CONTINUO_OBSERVACIONES			VARCHAR2(1024 CHAR),
	TBJ_IMPORTE_TOTAL					NUMBER(16,2),
	TBJ_TARIFICADO                		NUMBER(1,0)                     NOT NULL,
    TBJ_FECHA_RECHAZO             		DATE                            NOT NULL,
    TBJ_MOTIVO_RECHAZO            		VARCHAR2(1024 CHAR),
    TBJ_FECHA_ELECCION_PROVEEDOR  		DATE,
    TBJ_FECHA_EJECUTADO           		DATE,
    TBJ_FECHA_ANULACION           		DATE                           	NOT NULL,
    TBJ_FECHA_VALIDACION          		DATE,
    TBJ_FECHA_CIERRE_ECONOMICO    		DATE,
    TBJ_FECHA_PAGO                		DATE                            NOT NULL,
    TBJ_FECHA_EMISION_FACTURA     		DATE                     		NOT NULL,
    TBJ_GESTOR_ACTIVO_RESPONSABLE 		NUMBER(16,0)         			NOT NULL,
    TBJ_SUPERVISOR_ACT_RESPONSABLE		NUMBER(16,0)        			NOT NULL,
    STR_TARIFA_PLANA              		NUMBER(1,0)                     NOT NULL,
    TBJ_RESPONSABLE_TRABAJO       		NUMBER(16,2)               		NOT NULL
, VALIDACION NUMBER(1) DEFAULT 0 NOT NULL )'
;

DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA_1||'.'||V_TABLA||' CREADA');  

IF V_ESQUEMA_2 != V_ESQUEMA_1 THEN

	EXECUTE IMMEDIATE 'GRANT ALL ON "'||V_ESQUEMA_1||'"."'||V_TABLA||'" TO "'||V_ESQUEMA_2||'" WITH GRANT OPTION';
	DBMS_OUTPUT.PUT_LINE('[INFO] PERMISOS SOBRE LA TABLA '||V_ESQUEMA_1||'.'||V_TABLA||' OTORGADOS A '||V_ESQUEMA_2||''); 

END IF;

EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.ACT_NUMERO_ACTIVO IS ''Código identificador único del activo''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.AGR_EXTERNO IS ''Código identificador único de la agrupación en UVEM.''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_NUM_TRABAJO IS ''Numero Trabajo''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.PVC_DOCIDENTIF IS ''Número de documento identificativo del contacto''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TIPO_TRABAJO IS ''Tipo de trabajo solicitado (Código según Dic. Datos).''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.SUBTIPO_TRABAJO IS ''Subtipo de trabajo solicitado (Código según Dic. Datos).''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.ESTADO_TRABAJO IS ''Estado trabajo solicitado (Código según Dic. Datos).''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_DESCRIPCION IS ''Descripción del trabajo solicitado.''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_SOLICITUD IS ''Fecha solicitud del trabajo solicitado''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_APROBACION IS ''Fecha aprobación del trabajo solicitado''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_INICIO IS ''Fecha real de inicio del trabajo''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_FIN IS ''Fecha real de finalización del trabajo''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_FIN_COMPROMISO IS ''Fecha compromiso del trabajo solicitado''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_TOPE IS ''Fecha tope del trabajo solicitado''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_HORA_CONCRETA IS ''Fecha con hora concreta de finalización del trabajo solicitado''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_URGENTE IS ''Indicador si el trabajo es urgente o no.''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_CON_RIESGO_TERCEROS IS ''Indicador si el trabajo es con riesgo a terceros o no.''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_CUBRE_SEGURO IS ''Indicador si el trabajo lo cubre el seguro o no.''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_CIA_ASEGURADORA IS ''Compañía aseguradora''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TIPO_CALIDAD IS ''Tipo de calidad del trabajo (Código según Dic. Datos).''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_TERCERO_NOMBRE IS ''Nombre trabajo a terceros''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_TERCERO_EMAIL IS ''Email trabajo a terceros''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_TERCERO_DIRECCION IS ''Dirección trabajo a terceros''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_TERCERO_CONTACTO IS ''Contacto trabajo a terceros''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_TERCERO_TEL1 IS ''Teléfono 1 trabajo a terceros .''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_TERCERO_TEL2 IS ''Teléfono 12trabajo a terceros .''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_IMPORTE_PENAL_DIARIO IS ''Importe penalización diario''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_OBSERVACIONES IS ''Observaciones''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_CONTINUO_OBSERVACIONES IS ''Observaciones trabajo continuo''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_IMPORTE_TOTAL IS ''Importe total del trabajo''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_TARIFICADO IS ''''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_RECHAZO IS ''''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_MOTIVO_RECHAZO IS ''''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_ELECCION_PROVEEDOR IS ''''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_EJECUTADO IS ''''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_ANULACION IS ''''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_VALIDACION IS ''''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_CIERRE_ECONOMICO IS ''''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_PAGO IS ''''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO. IS ''''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_FECHA_EMISION_FACTURA IS ''Fecha de emisión de la factura''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_GESTOR_ACTIVO_RESPONSABLE IS ''Código único del cliente comercial que es gestor de activo responsable.''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_SUPERVISOR_ACT_RESPONSABLE IS ''Código único del cliente comercial que es supervisor de activo responsable.''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.STR_TARIFA_PLANA IS ''''';
EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA_1 || '.MIG_ATR_TRABAJO.TBJ_RESPONSABLE_TRABAJO IS ''Responsable del trabajo''';

EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/

EXIT;

