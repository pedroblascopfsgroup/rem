--/*
--##########################################
--## AUTOR=DAP
--## FECHA_CREACION=20170927
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=p2.0.6-170728
--## INCIDENCIA_LINK=HREOS-2898
--## PRODUCTO=NO
--##
--## Finalidad: Crear tabla nueva
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

  V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; -- Configuracion Esquema Master
  TABLESPACE VARCHAR2(25 CHAR) := 'REM_IDX';
  V_TABLA VARCHAR(30) :='MIG_AUX_ACT_PVE_PROVEEDOR';
  err_num NUMBER;
  err_msg VARCHAR2(2048);
  V_EXISTE NUMBER (1);
  V_MSQL VARCHAR2(4000 CHAR);

BEGIN

  --TABLA ACTIVOS_A_BORRAR
  V_MSQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA||''' AND OWNER = '''||V_ESQUEMA||''' ';
  EXECUTE IMMEDIATE V_MSQL INTO V_EXISTE;

  IF V_EXISTE = 1 THEN
    V_MSQL := 'DROP TABLE '||V_TABLA||' PURGE';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('TABLA '||V_TABLA||' BORRADA.');
  END IF;

  V_MSQL := '  
  CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||'
   (  "PVE_ID" NUMBER(16,0), 
  "PVE_COD_UVEM" VARCHAR2(50 CHAR), 
  "DD_TPR_ID" NUMBER(16,0)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE '||TABLESPACE;
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('TABLA '||V_TABLA||' CREADA.');
  V_MSQL := '
  CREATE UNIQUE INDEX '||V_ESQUEMA||'."PK_MIG_AUX_ACT_PVE" ON '||V_ESQUEMA||'.'||V_TABLA||' ("PVE_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE '||TABLESPACE;
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('ÍNDICE "PK_MIG_AUX_ACT_PVE" CREADO.');

  V_MSQL := '
    CREATE INDEX "REM01"."IDX_PVE_UVEM_EMISOR" ON "REM01"."MIG_AUX_ACT_PVE_PROVEEDOR" ("PVE_COD_UVEM") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 COMPUTE STATISTICS 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE '||TABLESPACE;
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('ÍNDICE "IDX_PVE_UVEM_EMISOR" CREADO.');

--DAMOS GRANTS
  V_MSQL := 'SELECT COUNT(1) FROM ALL_USERS WHERE USERNAME = ''PFSREM'' ';
  EXECUTE IMMEDIATE V_MSQL INTO V_EXISTE;
  IF V_EXISTE = 1 THEN
    EXECUTE IMMEDIATE 'GRANT SELECT, INSERT, UPDATE, DELETE ON '||V_TABLA||' TO PFSREM';
  END IF;

EXCEPTION
  WHEN OTHERS THEN
    err_num := SQLCODE;
    err_msg := SQLERRM;
    DBMS_OUTPUT.put_line('Error:'||TO_CHAR(err_num));
    DBMS_OUTPUT.put_line(err_msg);
    ROLLBACK;
    RAISE;
END;
/
EXIT
