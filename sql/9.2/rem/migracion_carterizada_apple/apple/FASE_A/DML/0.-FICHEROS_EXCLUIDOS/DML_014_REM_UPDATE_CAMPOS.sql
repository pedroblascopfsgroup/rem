--/*
--##########################################
--## AUTOR=DANIEL ALBERT PÉREZ
--## FECHA_CREACION=20170915
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.6
--## INCIDENCIA_LINK=HREOS-2841
--## PRODUCTO=NO
--## 
--## Finalidad: 
--## INSTRUCCIONES:  Rellenar el array
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;

DECLARE
   
  V_ESQUEMA          VARCHAR2(25 CHAR):= 'REM01';   -- '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M   VARCHAR2(25 CHAR):= 'REMMASTER';  -- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  TABLE_COUNT number(3);                      -- Vble. para validar la existencia de las Tablas.
  err_num NUMBER;                           -- Numero de errores
  err_msg VARCHAR2(2048);                       -- Mensaje de error
  V_MSQL VARCHAR2(4000 CHAR);
  V_EXIST NUMBER(10);

BEGIN

    DBMS_OUTPUT.PUT_LINE('[INICIO] Inicio del proceso.');

    V_MSQL := '
        MERGE INTO REM01.MIG_ACA_CABECERA T1
        USING REM01.MIG_UPDATE_CAMPOS T2
        ON (T1.ACT_NUMERO_ACTIVO = T2.ACT_NUMERO_ACTIVO)
        WHEN MATCHED THEN UPDATE SET
            T1.ACT_NUMERO_PRINEX = T2.ACT_NUMERO_PRINEX, T1.ACT_NUMERO_UVEM = T2.ACT_NUMERO_UVEM
            , T1.ACT_DESCRIPCION = T2.ACT_DESCRIPCION, T1.ACT_RATING = T2.ACT_RATING
            , T1.ESTADO_ADMISION = T2.ESTADO_ADMISION, T1.ESTADO_GESTION = T2.ESTADO_GESTION
            , T1.SITUACION_COMERCIAL = T2.SITUACION_COMERCIAL';
    EXECUTE IMMEDIATE V_MSQL;

    DBMS_OUTPUT.PUT_LINE('[FIN] Corregimos '||SQL%ROWCOUNT||' filas en MIG_ACA_CABECERA.');    

    V_MSQL := '
        MERGE INTO REM01.MIG_APA_PROP_ACTIVO T1
        USING REM01.MIG_UPDATE_CAMPOS T2
        ON (T1.ACT_NUMERO_ACTIVO = T2.ACT_NUMERO_ACTIVO)
        WHEN MATCHED THEN UPDATE SET
            T1.PRO_CODIGO_UVEM = T2.PRO_CODIGO_UVEM, T1.GRADO_PROPIEDAD = T2.GRADO_PROPIEDAD
            , T1.PORCENTAJE = T2.PORCENTAJE';
    EXECUTE IMMEDIATE V_MSQL;

    DBMS_OUTPUT.PUT_LINE('[FIN] Corregimos '||SQL%ROWCOUNT||' filas en MIG_APA_PROP_ACTIVO.');    

    V_MSQL := '
        MERGE INTO REM01.MIG_ADA_DATOS_ADI T1
        USING REM01.MIG_UPDATE_CAMPOS T2
        ON (T1.ACT_NUMERO_ACTIVO = T2.ACT_NUMERO_ACTIVO)
        WHEN MATCHED THEN UPDATE SET
            T1.SPS_CON_TITULO = T2.SPS_CON_TITULO, T1.SPS_ACC_TAPIADO = T2.SPS_ACC_TAPIADO
            , T1.SPS_RIESGO_OCUPACION = T2.SPS_RIESGO_OCUPACION, T1.ESTADO_OBRA_NUEVA = T2.ESTADO_OBRA_NUEVA
            , T1.LOC_LATITUD = T2.LOC_LATITUD, T1.LOC_LONGITUD = T2.LOC_LONGITUD
            , T1.ACT_LLV_NECESARIAS = T2.ACT_LLV_NECESARIAS';
    EXECUTE IMMEDIATE V_MSQL;

    DBMS_OUTPUT.PUT_LINE('[FIN] Corregimos '||SQL%ROWCOUNT||' filas en MIG_ADA_DATOS_ADI.'); 

    V_MSQL := '
        MERGE INTO REM01.MIG2_ACT_ACTIVO T1
        USING REM01.MIG_UPDATE_CAMPOS T2
        ON (T1.ACT_NUMERO_ACTIVO = T2.ACT_NUMERO_ACTIVO)
        WHEN MATCHED THEN UPDATE SET
            T1.ACT_COD_SUBCARTERA = T2.ACT_COD_SUBCARTERA, T1.ACT_COD_TIPO_COMERCIALIZACION = T2.ACT_COD_TIPO_COMERCIALIZACION
            , T1.ACT_COD_TIPO_ALQUILER = T2.ACT_COD_TIPO_ALQUILER, T1.ACT_FECHA_VENTA = T2.ACT_FECHA_VENTA
            , T1.ACT_IMPORTE_VENTA = T2.ACT_IMPORTE_VENTA, T1.SELLO_CALIDAD = T2.SELLO_CALIDAD
            , T1.GESTOR_CALIDAD = T2.GESTOR_CALIDAD, T1.FECHA_CALIDAD = T2.FECHA_CALIDAD';
    EXECUTE IMMEDIATE V_MSQL;

    DBMS_OUTPUT.PUT_LINE('[FIN] Corregimos '||SQL%ROWCOUNT||' filas en MIG2_ACT_ACTIVO.'); 

    V_MSQL := '
        MERGE INTO REM01.MIG_ADJ_JUDICIAL T1
        USING REM01.MIG_UPDATE_CAMPOS T2
        ON (T1.ACT_NUMERO_ACTIVO = T2.ACT_NUMERO_ACTIVO)
        WHEN MATCHED THEN UPDATE SET
            T1.ADJ_FECHA_SEN_POSESION = T2.ADJ_FECHA_SEN_POSESION';
    EXECUTE IMMEDIATE V_MSQL;

    DBMS_OUTPUT.PUT_LINE('[FIN] Corregimos '||SQL%ROWCOUNT||' filas en MIG_ADJ_JUDICIAL.'); 
    
    V_MSQL := '
        MERGE INTO REM01.MIG_ATI_TITULO T1
        USING REM01.MIG_UPDATE_CAMPOS T2
        ON (T1.ACT_NUMERO_ACTIVO = T2.ACT_NUMERO_ACTIVO)
        WHEN MATCHED THEN UPDATE SET
            T1.TIT_FECHA_INSC_REG = T2.TIT_FECHA_INSC_REG';
    EXECUTE IMMEDIATE V_MSQL;
    
    DBMS_OUTPUT.PUT_LINE('[FIN] Corregimos '||SQL%ROWCOUNT||' filas en MIG_ATI_TITULO.'); 
    
    COMMIT;
    
    DBMS_OUTPUT.PUT_LINE('[FIN] Fin del proceso.');  

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------');
    DBMS_OUTPUT.put_line(SQLERRM);
    ROLLBACK;
    RAISE;

END;
/
EXIT
