--/*
--#########################################
--## AUTOR=GUILLEM REY
--## FECHA_CREACION=20170608
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-2209
--## PRODUCTO=NO
--## 
--## Finalidad: Proceso de migraci칩n MIG2_GIC_GASTOS_INFO_CONTABI -> GIC_GASTOS_INFO_CONTABILIDAD
--##                    
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versi칩n inicial
--#########################################
--*/

--Para permitir la visualizaci칩n de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

	TABLE_COUNT_1 NUMBER(10,0) := 0;
	TABLE_COUNT_2 NUMBER(10,0) := 0;
      V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01'; --REM01
      V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER'; --REMMASTER
	V_USUARIO VARCHAR2(50 CHAR) := '#USUARIO_MIGRACION#';
	V_TABLA VARCHAR2(40 CHAR) := 'GIC_GASTOS_INFO_CONTABILIDAD';
	V_TABLA_MIG VARCHAR2(40 CHAR) := 'MIG2_GIC_GASTOS_INFO_CONTABI';
	V_SENTENCIA VARCHAR2(32000 CHAR);

BEGIN
	  --INSERCION DE LOS EJERCICIOS INEXISTENTES
	  DBMS_OUTPUT.PUT_LINE('[INFO] ['||V_TABLA||'] INSERTAMOS LOS EJERCICIOS INEXISTENTES EN ACT_EJE_EJERCICIO...');

      V_SENTENCIA := '
            INSERT INTO ACT_EJE_EJERCICIO (EJE_ID, EJE_ANYO, EJE_FECHAINI, EJE_FECHAFIN
                , EJE_DESCRIPCION, USUARIOCREAR, FECHACREAR)
            SELECT S_ACT_EJE_EJERCICIO.NEXTVAL, T1.*
            FROM (SELECT DISTINCT MIG.GIC_EJERCICIO, TO_DATE(MIG.GIC_EJERCICIO||''0101'',''YYYYMMDD''), TO_DATE(MIG.GIC_EJERCICIO||''1231'',''YYYYMMDD'')
                ,''Ejercicio correspondiente al a침o ''||MIG.GIC_EJERCICIO, '''||V_USUARIO||''', SYSDATE
            FROM MIG2_GIC_GASTOS_INFO_CONTABI MIG
            WHERE NOT EXISTS (SELECT 1 FROM ACT_EJE_EJERCICIO EJE WHERE EJE.EJE_ANYO = MIG.GIC_EJERCICIO)
            AND MIG.VALIDACION = 0) T1';
      EXECUTE IMMEDIATE V_SENTENCIA;

      DBMS_OUTPUT.PUT_LINE('[INFO] Ejercicio creados en '||V_ESQUEMA||'.ACT_EJE_EJERCICIO -> ('||SQL%ROWCOUNT||')');    
      
      --Inicio del proceso de volcado sobre GIC_GASTOS_INFO_CONTABILIDAD
      DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
      
      EXECUTE IMMEDIATE '
            INSERT INTO REM01.GIC_GASTOS_INFO_CONTABILIDAD (GIC_ID, GPV_ID, EJE_ID, GIC_FECHA_CONTABILIZACION, DD_DEG_ID_CONTABILIZA
                , GIC_FECHA_DEVENGO_ESPECIAL, DD_TPE_ID_ESPECIAL, USUARIOCREAR, FECHACREAR, GIC_CUENTA_CONTABLE_ESP, GIC_PTDA_PRESUPUESTARIA_ESP
                , GIC_CUENTA_CONTABLE
                , GIC_PTDA_PRESUPUESTARIA)
            SELECT REM01.S_GIC_GASTOS_INFO_CONTABILIDAD.NEXTVAL, GPV.GPV_ID, EJE.EJE_ID, MIG2.GIC_FECHA_CONTABILIZACION, DEP.DD_DEP_ID
                , MIG2.GIC_FECHA_DEVENGO_ESPECIAL, TPE.DD_TPE_ID, '''||V_USUARIO||''', SYSDATE, MIG2.GIC_COD_CUENTA_CONT_ESPECIAL, MIG2.GIC_COD_PAR_PRESUP_ESPECIAL
                , CASE WHEN GDE.DD_TIT_ID IS NULL AND CCC.CCC_ARRENDAMIENTO = 0 AND CCC.BORRADO = 0 THEN CCC.CCC_CUENTA_CONTABLE ELSE MIG2.GIC_COD_CUENTA_CONTABLE END GIC_CUENTA_CONTABLE
                , CASE WHEN GDE.DD_TIT_ID IS NULL AND CPP.CPP_ARRENDAMIENTO = 0 AND CPP.BORRADO = 0 THEN CPP.CPP_PARTIDA_PRESUPUESTARIA ELSE MIG2.GIC_COD_PARTIDA_PRESUPUES END GIC_PTDA_PRESUPUESTARIA
            FROM REM01.MIG2_GIC_GASTOS_INFO_CONTABI MIG2
            JOIN REM01.GPV_GASTOS_PROVEEDOR GPV ON GPV.GPV_NUM_GASTO_HAYA = MIG2.GIC_GPV_ID
            JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GPV.GPV_ID = GDE.GPV_ID
            JOIN REM01.ACT_EJE_EJERCICIO EJE ON EJE.EJE_ANYO = MIG2.GIC_EJERCICIO AND EJE.BORRADO = 0
            LEFT JOIN REM01.DD_DEP_DESTINATARIOS_PAGO DEP ON DEP.DD_DEP_CODIGO = MIG2.GIC_COD_DESTINA_CONTABILIZA AND DEP.BORRADO = 0
            LEFT JOIN REM01.DD_TPE_TIPOS_PERIOCIDAD TPE ON TPE.DD_TPE_CODIGO = MIG2.GIC_COD_PERIODICIDAD_ESPECIAL AND TPE.BORRADO = 0 
            LEFT JOIN REM01.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
            LEFT JOIN REM01.CPP_CONFIG_PTDAS_PREP CPP ON GPV.DD_STG_ID = CPP.DD_STG_ID AND GIC.EJE_ID = CPP.EJE_ID
            LEFT JOIN REM01.CCC_CONFIG_CTAS_CONTABLES CCC ON GPV.DD_STG_ID = CCC.DD_STG_ID AND GIC.EJE_ID = CCC.EJE_ID
            WHERE MIG2.VALIDACION = 0 AND GIC.GPV_ID IS NULL';
      
      DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' cargada. '||SQL%ROWCOUNT||' Filas.');     
      
      COMMIT;
      
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA||''',''1''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
  
      COMMIT;

EXCEPTION
      WHEN OTHERS THEN
            DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
            DBMS_OUTPUT.put_line('-----------------------------------------------------------');
            DBMS_OUTPUT.put_line(SQLERRM);
            ROLLBACK;
            RAISE;
END;

/

EXIT;
