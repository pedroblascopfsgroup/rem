--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20170622
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-2209
--## PRODUCTO=NO
--## 
--## Finalidad: Proceso de migración 'MIG_ADJ_JUDICIAL' -> 'ACT_AJD_ADJUDICIAL', 'BIE_ADJ_ADJUDICACION (Merge)'
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01'; --REM01
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER'; --REMMASTER
V_USUARIO VARCHAR2(50 CHAR) := '#USUARIO_MIGRACION#';
V_TABLA VARCHAR2(40 CHAR) := 'ACT_AJD_ADJJUDICIAL';
V_TABLA_2 VARCHAR2(40 CHAR) := 'BIE_ADJ_ADJUDICACION';
V_TABLA_MIG VARCHAR2(40 CHAR) := 'MIG_ADJ_JUDICIAL';
V_SENTENCIA VARCHAR2(2000 CHAR);

BEGIN
  
    DBMS_OUTPUT.PUT_LINE('[INICIO] Comienza la migración de ACTIVOS JUDICIALES');

    -------------------------------------------------
    --INSERCION EN ACT_AJD_ADJJUDICIAL--
    -------------------------------------------------
    DBMS_OUTPUT.PUT_LINE('	[INFO] INSERCION EN ACT_AJD_ADJJUDICIAL');


	EXECUTE IMMEDIATE ('
	INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (
		AJD_ID,
		ACT_ID,
		BIE_ADJ_ID,
		DD_JUZ_ID,
		DD_PLA_ID,
		DD_EDJ_ID,
		DD_EEJ_ID,
		AJD_FECHA_ADJUDICACION,
		AJD_NUM_AUTO,
		AJD_PROCURADOR,
		AJD_LETRADO,
		AJD_ID_ASUNTO,
		VERSION,
		USUARIOCREAR,
		FECHACREAR,
		USUARIOMODIFICAR,
		FECHAMODIFICAR,
		USUARIOBORRAR,
		FECHABORRAR,
		BORRADO,
		AJD_EXP_DEF_TESTI
	)
	SELECT
		'||V_ESQUEMA||'.S_ACT_AJD_ADJJUDICIAL.NEXTVAL         			AJD_ID,
		AUX.*
		FROM (
			SELECT
				ACT.ACT_ID												ACT_ID,
				BIE.BIE_ADJ_ID											BIE_ADJ_ID,
				(SELECT DD_JUZ_ID
				  FROM '||V_ESQUEMA||'.DD_JUZ_JUZGADOS_PLAZA
				  WHERE DD_JUZ_CODIGO = MIG.JUZGADO)                  	DD_JUZ_ID,
				(SELECT DD_PLA_ID
				  FROM '||V_ESQUEMA||'.DD_PLA_PLAZAS
				  WHERE DD_PLA_CODIGO = MIG.PLAZA_JUZGADO)            	DD_PLA_ID,
				(SELECT DD_EDJ_ID
				  FROM '||V_ESQUEMA||'.DD_EDJ_ESTADO_ADJUDICACION
				  WHERE DD_EDJ_CODIGO = MIG.ESTADO_ADJUDICACION)      	DD_EDJ_ID,
				(SELECT DD_EEJ_ID
				  FROM '||V_ESQUEMA||'.DD_EEJ_ENTIDAD_EJECUTANTE
				  WHERE DD_EEJ_CODIGO = MIG.ENTIDAD_EJECUTANTE)       	DD_EEJ_ID,
				MIG.AJD_FECHA_ADJUDICACION                            	AJD_FECHA_ADJUDICACION,
				MIG.AJD_NUM_AUTO                                      	AJD_NUM_AUTO,
				MIG.AJD_PROCURADOR                                    	AJD_PROCURADOR,
				MIG.AJD_LETRADO                                       	AJD_LETRADO,
				MIG.AJD_ID_ASUNTO                                     	AJD_ID_ASUNTO,
				''0''                                                 	VERSION,
				'''||V_USUARIO||'''                                     USUARIOCREAR,
				SYSDATE                                               	FECHACREAR,
				NULL                                                  	USUARIOMODIFICAR,
				NULL                                                  	FECHAMODIFICAR,
				NULL                                                  	USUARIOBORRAR,
				NULL                                                  	FECHABORRAR,
				0                                                     	BORRADO,
				MIG.AJD_EXP_DEF_TESTI									AJD_EXP_DEF_TESTI
	FROM '||V_ESQUEMA||'.'||V_TABLA_MIG||' 			MIG
    JOIN '||V_ESQUEMA||'.ACT_ACTIVO 				ACT ON ACT.ACT_NUM_ACTIVO = MIG.ACT_NUMERO_ACTIVO AND ACT.BORRADO = 0
    JOIN '||V_ESQUEMA||'.BIE_ADJ_ADJUDICACION 		BIE ON BIE.BIE_ID = ACT.BIE_ID AND BIE.BORRADO = 0
    WHERE MIG.VALIDACION = 0 
      AND NOT EXISTS (
						SELECT 1 
						FROM '||V_ESQUEMA||'.'||V_TABLA||' AUX 
						WHERE AUX.ACT_ID = ACT.ACT_ID AND AUX.BORRADO = 0
	                 )
    ) AUX
    ');
  
    DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' cargada. '||SQL%ROWCOUNT||' Filas.');
  
 
    -------------------------------------------------
    --MERGE EN BIE_ADJ_ADJUDICACION--
    -------------------------------------------------
    DBMS_OUTPUT.PUT_LINE('	[INFO] MERGE EN BIE_ADJ_ADJUDICACION');
	

	EXECUTE IMMEDIATE ('
	MERGE INTO '||V_ESQUEMA||'.'||V_TABLA_2||' BIE_ADJ 
	USING (
		SELECT AJD.BIE_ADJ_ID, 
			   MIG.*,
			   TIT.*
		FROM '||V_ESQUEMA||'.'||V_TABLA||' 				AJD
		INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO 			ACTIV  ON ACTIV.ACT_ID = AJD.ACT_ID
		INNER JOIN '||V_ESQUEMA||'.'||V_TABLA_MIG||' 	MIG    ON MIG.ACT_NUMERO_ACTIVO = ACTIV.ACT_NUM_ACTIVO
		LEFT JOIN '||V_ESQUEMA||'.ACT_TIT_TITULO		TIT	   ON TIT.ACT_ID = ACTIV.ACT_ID
		WHERE MIG.VALIDACION = 0
	) TMP
	ON (BIE_ADJ.BIE_ADJ_ID = TMP.BIE_ADJ_ID)
	WHEN MATCHED THEN UPDATE SET
		BIE_ADJ.BIE_ADJ_F_DECRETO_N_FIRME = TMP.BIE_ADJ_F_DECRETO_N_FIRME,
		BIE_ADJ.BIE_ADJ_F_DECRETO_FIRME = TMP.AJD_FECHA_DECRETO_FIRME,
		BIE_ADJ.BIE_ADJ_F_ENTREGA_GESTOR = TMP.TIT_FECHA_ENTREGA_GESTORIA,
		BIE_ADJ.BIE_ADJ_F_PRESEN_HACIENDA = TMP.TIT_FECHA_PRESENT1_REG,
		BIE_ADJ.BIE_ADJ_F_SEGUNDA_PRESEN = TMP.TIT_FECHA_PRESENT2_REG,
		BIE_ADJ.BIE_ADJ_F_RECPCION_TITULO = TMP.TIT_FECHA_RETIRADA_REG,		
		BIE_ADJ.BIE_ADJ_F_INSCRIP_TITULO = TMP.BIE_ADJ_F_INSCRIP_TITULO,
		BIE_ADJ.BIE_ADJ_F_ENVIO_ADICION = TMP.BIE_ADJ_F_ENVIO_ADICION,
		BIE_ADJ.BIE_ADJ_F_PRESENT_REGISTRO = TMP.TIT_FECHA_ENTREGA_GESTORIA,
		BIE_ADJ.BIE_ADJ_F_SOL_POSESION = TMP.BIE_ADJ_F_SOL_POSESION,
		BIE_ADJ.BIE_ADJ_F_SEN_POSESION = TMP.BIE_ADJ_F_SEN_POSESION,
		BIE_ADJ.BIE_ADJ_F_REA_POSESION = TMP.BIE_ADJ_F_REA_POSESION,
		BIE_ADJ.BIE_ADJ_F_SOL_LANZAMIENTO = TMP.BIE_ADJ_F_SOL_LANZAMIENTO,
		BIE_ADJ.BIE_ADJ_F_SEN_LANZAMIENTO = TMP.BIE_ADJ_F_SEN_LANZAMIENTO,
		BIE_ADJ.BIE_ADJ_F_REA_LANZAMIENTO = TMP.BIE_ADJ_F_REA_LANZAMIENTO,
		BIE_ADJ.BIE_ADJ_F_SOL_MORATORIA = TMP.BIE_ADJ_F_SOL_MORATORIA,
		BIE_ADJ.BIE_ADJ_F_RES_MORATORIA = TMP.BIE_ADJ_F_RES_MORATORIA,
		BIE_ADJ.BIE_ADJ_F_CONTRATO_ARREN = TMP.BIE_ADJ_F_CONTRATO_ARREN,
		BIE_ADJ.BIE_ADJ_F_CAMBIO_CERRADURA = TMP.BIE_ADJ_F_CAMBIO_CERRADURA,
		BIE_ADJ.BIE_ADJ_F_ENVIO_LLAVES = TMP.BIE_ADJ_F_ENVIO_LLAVES,
		BIE_ADJ.BIE_ADJ_F_RECEP_DEPOSITARIO = TMP.BIE_ADJ_F_RECEP_DEPOSITARIO,
		BIE_ADJ.BIE_ADJ_F_ENVIO_DEPOSITARIO = TMP.BIE_ADJ_F_ENVIO_DEPOSITARIO,
		BIE_ADJ.BIE_ADJ_OCUPADO = TMP.BIE_ADJ_OCUPADO,
		BIE_ADJ.BIE_ADJ_POSIBLE_POSESION = TMP.BIE_ADJ_POSIBLE_POSESION,
		BIE_ADJ.BIE_ADJ_OCUPANTES_DILIGENCIA = TMP.BIE_ADJ_OCUPANTES_DILIGENCIA,
		BIE_ADJ.BIE_ADJ_LANZAMIENTO_NECES = TMP.BIE_ADJ_LANZAMIENTO_NECES,
		BIE_ADJ.BIE_ADJ_ENTREGA_VOLUNTARIA = TMP.BIE_ADJ_ENTREGA_VOLUNTARIA,
		BIE_ADJ.BIE_ADJ_NECESARIA_FUERA_PUB = TMP.BIE_ADJ_NECESARIA_FUERA_PUB,
		BIE_ADJ.BIE_ADJ_EXISTE_INQUILINO = TMP.BIE_ADJ_EXISTE_INQUILINO,
		BIE_ADJ.BIE_ADJ_LLAVES_NECESARIAS = TMP.BIE_ADJ_LLAVES_NECESARIAS,
		BIE_ADJ.BIE_ADJ_GESTORIA_ADJUDIC = TMP.BIE_ADJ_GESTORIA_ADJUDIC,
		BIE_ADJ.BIE_ADJ_NOMBRE_ARRENDATARIO = TMP.BIE_ADJ_NOMBRE_ARRENDATARIO,
		BIE_ADJ.BIE_ADJ_NOMBRE_DEPOSITARIO = TMP.BIE_ADJ_NOMBRE_DEPOSITARIO,
		BIE_ADJ.BIE_ADJ_NOMBRE_DEPOSITARIO_F = TMP.BIE_ADJ_NOMBRE_DEPOSITARIO_F,
		BIE_ADJ.DD_EAD_ID = (SELECT DD_EAD_ID FROM '||V_ESQUEMA||'.DD_EAD_ENTIDAD_ADJUDICA WHERE DD_EAD_CODIGO = TMP.DD_EAD_ID),
		BIE_ADJ.DD_SIT_ID = (SELECT DD_SIT_ID FROM '||V_ESQUEMA||'.DD_SIT_SITUACION_TITULO WHERE DD_SIT_CODIGO = TMP.DD_SIT_ID),
		BIE_ADJ.DD_FAV_ID = (SELECT DD_FAV_ID FROM '||V_ESQUEMA_MASTER||'.DD_FAV_FAVORABLE WHERE DD_FAV_CODIGO = TMP.DD_FAV_ID),
		BIE_ADJ.BIE_ADJ_F_RECEP_DEPOSITARIO_F = TMP.BIE_ADJ_F_RECEP_DEPOSITARIO_F,
		BIE_ADJ.DD_TFO_ID = (SELECT DD_TFO_ID FROM '||V_ESQUEMA||'.DD_TFO_TIPO_FONDO WHERE DD_TFO_CODIGO = TMP.DD_TFO_ID),
		BIE_ADJ.BIE_ADJ_REQ_SUBSANACION = TMP.BIE_ADJ_REQ_SUBSANACION,
		BIE_ADJ.BIE_ADJ_NOTIF_DEMANDADOS = TMP.BIE_ADJ_NOTIF_DEMANDADOS,
		BIE_ADJ.BIE_ADJ_F_REV_PROP_CAN = TMP.BIE_ADJ_F_REV_PROP_CAN,
		BIE_ADJ.BIE_ADJ_F_PROP_CAN = TMP.BIE_ADJ_F_PROP_CAN,
		BIE_ADJ.BIE_ADJ_F_REV_CARGAS = TMP.BIE_ADJ_F_REV_CARGAS,
		BIE_ADJ.BIE_ADJ_F_PRES_INS_ECO = TMP.BIE_ADJ_F_PRES_INS_ECO,
		BIE_ADJ.BIE_ADJ_F_PRES_INS = TMP.BIE_ADJ_F_PRES_INS,
		BIE_ADJ.BIE_ADJ_F_CAN_REG_ECO = TMP.BIE_ADJ_F_CAN_REG_ECO,
		BIE_ADJ.BIE_ADJ_F_CAN_REG = TMP.BIE_ADJ_F_CAN_REG,
		BIE_ADJ.BIE_ADJ_F_CAN_ECO = TMP.BIE_ADJ_F_CAN_ECO,
		BIE_ADJ.BIE_ADJ_F_LIQUIDACION = TMP.BIE_ADJ_F_LIQUIDACION,
		BIE_ADJ.BIE_ADJ_F_RECEPCION = TMP.BIE_ADJ_F_RECEPCION,
		BIE_ADJ.BIE_ADJ_F_CANCELACION = TMP.BIE_ADJ_F_CANCELACION,
		BIE_ADJ.BIE_ADJ_IMPORTE_ADJUDICACION = TMP.BIE_ADJ_IMPORTE_ADJUDICACION,
		BIE_ADJ.BIE_ADJ_CESION_REMATE = TMP.BIE_ADJ_CESION_REMATE,
		BIE_ADJ.BIE_ADJ_CESION_REMATE_IMP = TMP.BIE_ADJ_CESION_REMATE_IMP,
		BIE_ADJ.DD_DAD_ID = (SELECT DD_DAD_ID FROM '||V_ESQUEMA_MASTER||'.DD_DAD_DOC_ADJUDICACION WHERE DD_DAD_CODIGO = TMP.DD_DAD_ID),
		BIE_ADJ.BIE_ADJ_F_CONTABILIDAD = TMP.BIE_ADJ_F_CONTABILIDAD,
		BIE_ADJ.BIE_ADJ_POSTORES = TMP.BIE_ADJ_POSTORES
	');
  
    DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_2||' actualizada. '||SQL%ROWCOUNT||' Filas. Merge.');
  

   /*
   --YA SE CALCULA EN EL DML DE DATOS_ADICIONALES
   EXECUTE IMMEDIATE 'MERGE INTO ACT_SPS_SIT_POSESORIA T1
		USING (SELECT DISTINCT T1.ACT_ID, T4.BIE_ADJ_F_REA_POSESION
		    FROM ACT_SPS_SIT_POSESORIA T1
		    JOIN ACT_AJD_ADJJUDICIAL T2 ON T1.ACT_ID = T2.ACT_ID AND T2.BORRADO = 0
		    JOIN ACT_ACTIVO T3 ON T3.ACT_ID = T2.ACT_ID AND T3.BORRADO = 0
		    JOIN BIE_ADJ_ADJUDICACION T4 ON T4.BIE_ID = T3.BIE_ID AND T4.BORRADO = 0
		    WHERE T1.BORRADO = 0 AND T4.BIE_ADJ_F_REA_POSESION IS NOT NULL AND T1.SPS_FECHA_TOMA_POSESION IS NULL) T2
		ON (T1.ACT_ID = T2.ACT_ID)
		WHEN MATCHED THEN UPDATE SET
		    T1.SPS_FECHA_TOMA_POSESION = T2.BIE_ADJ_F_REA_POSESION';

   DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.ACT_SPS_SIT_POSESORIA actualizada. '||SQL%ROWCOUNT||' Filas. Merge.');
   */


   V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''STATS'','''||V_TABLA ||''',''10''); END;';
   EXECUTE IMMEDIATE V_SENTENCIA;
   V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''STATS'','''||V_TABLA_2||''',''10''); END;';
   EXECUTE IMMEDIATE V_SENTENCIA;

   COMMIT; 
      
   DBMS_OUTPUT.PUT_LINE('[FIN] Acaba la migración de ACTIVOS JUDICIALES'); 


EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT;
