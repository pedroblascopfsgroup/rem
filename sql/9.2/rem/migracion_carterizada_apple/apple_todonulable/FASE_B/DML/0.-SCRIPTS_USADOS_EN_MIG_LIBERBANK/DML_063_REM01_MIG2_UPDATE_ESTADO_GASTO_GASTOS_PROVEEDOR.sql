--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20170801
--## ARTEFACTO=migracion
--## VERSION_ARTEFACTO=2.0.7
--## INCIDENCIA_LINK=HREOS-2567
--## PRODUCTO=NO
--## 
--## Finalidad: Proceso de migración Fase 2, para la actualizacion de estados del gasto.
--##                    
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

    V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
    V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
    V_TABLA VARCHAR2(40 CHAR) := 'GPV_GASTOS_PROVEEDOR';
    V_SENTENCIA VARCHAR2(32000 CHAR);
    V_REG_ACTUALIZADOS NUMBER(10,0) := 0;
    V_REG_TOTAL NUMBER(10,0) := 0;
    V_USUARIO VARCHAR2(50 CHAR) := '#USUARIO_MIGRACION#';
      
BEGIN
    
    DBMS_OUTPUT.PUT_LINE('------------------------------------------------------------------------------------') ;
    DBMS_OUTPUT.PUT_LINE('                   PROCESO DE ACTUALIZACION DE ESTADOS DE GASTOS PARA LOS GASTOS....') ;
    DBMS_OUTPUT.PUT_LINE('------------------------------------------------------------------------------------') ;

    --GASTOS CON ESTADO ANULADO
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    --Poner fecha cuando no la tengan de estado de autorizacion propietario
    EXECUTE IMMEDIATE 'MERGE INTO REM01.GGE_GASTOS_GESTION T1
        USING REM01.DD_EAP_ESTADOS_AUTORIZ_PROP T2
        ON (T1.DD_EAP_ID = T2.DD_EAP_ID AND T2.DD_EAP_CODIGO IN (''02'',''03'',''04'',''05'',''06'',''07''))
        WHEN MATCHED THEN UPDATE SET
            T1.GGE_FECHA_EAP = SYSDATE
        WHERE T1.USUARIOCREAR = '''||V_USUARIO||''' AND T1.GGE_FECHA_EAP IS NULL';
    --Poner fecha contabilización a gastos Autorizado por contabilidad
    EXECUTE IMMEDIATE 'MERGE INTO REM01.GIC_GASTOS_INFO_CONTABILIDAD T1
        USING (SELECT DISTINCT T1.GIC_ID
            FROM REM01.GIC_GASTOS_INFO_CONTABILIDAD T1
            JOIN REM01.GGE_GASTOS_GESTION T2 ON T1.GPV_ID = T2.GPV_ID 
            JOIN REM01.DD_EAP_ESTADOS_AUTORIZ_PROP T3 ON T3.DD_EAP_ID = T2.DD_EAP_ID AND T3.DD_EAP_CODIGO = ''07''
            WHERE T1.USUARIOCREAR = '''||V_USUARIO||''' AND T1.GIC_FECHA_CONTABILIZACION IS NULL) T2
        ON (T1.GIC_ID = T2.GIC_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.GIC_FECHA_CONTABILIZACION = SYSDATE';
    --Si un gastos tiene fecha de anulación, su estado será Anulado.
    EXECUTE IMMEDIATE 'MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''' AND GGE.GGE_FECHA_ANULACION IS NOT NULL AND GPV.DD_EGA_ID IS NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''06'')';
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS CON ESTADO ANULADO');
/*    
    --GASTOS CON ESTADO PAGADO
    EXECUTE IMMEDIATE 'MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAP_ESTADOS_AUTORIZ_PROP EAP ON GGE.DD_EAP_ID = EAP.DD_EAP_ID
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''' AND ((GDE.GDE_FECHA_PAGO IS NOT NULL OR GIC.GIC_FECHA_CONTABILIZACION IS NOT NULL) AND EAP.DD_EAP_CODIGO = ''07'') AND GPV.DD_EGA_ID IS NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''05'')';
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS CON ESTADO PAGADO');
   
    EXECUTE IMMEDIATE 'MERGE INTO REM01.GDE_GASTOS_DETALLE_ECONOMICO T1
        USING (SELECT GDE.GDE_ID, NVL(GIC.GIC_FECHA_CONTABILIZACION,GGE.GGE_FECHA_EAP) FECHA_PAGO
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAP_ESTADOS_AUTORIZ_PROP EAP ON GGE.DD_EAP_ID = EAP.DD_EAP_ID AND EAP.DD_EAP_CODIGO = ''07''
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''' AND GDE.GDE_FECHA_PAGO IS NULL AND GPV.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''05'')) T2
        ON (T1.GDE_ID = T2.GDE_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.GDE_FECHA_PAGO = T2.FECHA_PAGO';
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. FECHA PAGO EN GASTOS CON ESTADO PAGADO');
*/    
-- Modificado SHG (Inicio)    
    --GASTOS CON ESTADO PAGADO
    EXECUTE IMMEDIATE 'MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAP_ESTADOS_AUTORIZ_PROP EAP ON GGE.DD_EAP_ID = EAP.DD_EAP_ID
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''' AND ((GDE.GDE_FECHA_PAGO IS NOT NULL) AND EAP.DD_EAP_CODIGO = ''07'') AND GPV.DD_EGA_ID IS NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''05'')';
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS CON ESTADO PAGADO');
   
    EXECUTE IMMEDIATE 'MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAP_ESTADOS_AUTORIZ_PROP EAP ON GGE.DD_EAP_ID = EAP.DD_EAP_ID
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''' AND ((GIC.GIC_FECHA_CONTABILIZACION IS NOT NULL) AND EAP.DD_EAP_CODIGO = ''07'') AND GPV.DD_EGA_ID IS NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''04'')';
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS CON ESTADO PAGADO');
    
-- Modificado SHG (Fin) 



    --GASTOS CON ESTADO AUTORIZADO ADMINISTRACIÓN
    EXECUTE IMMEDIATE 'MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAP_ESTADOS_AUTORIZ_PROP EAP ON GGE.DD_EAP_ID = EAP.DD_EAP_ID
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''' AND EAP.DD_EAP_CODIGO IN (''05'',''06'') AND GPV.DD_EGA_ID IS NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''03'')';
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS CON ESTADO AUTORIZADO ADMINISTRACIÓN');

    --GASTOS EN ESTADO RECHAZADO PROPIETARIO
    EXECUTE IMMEDIATE '
        MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAP_ESTADOS_AUTORIZ_PROP EAP ON GGE.DD_EAP_ID = EAP.DD_EAP_ID AND EAP.DD_EAP_CODIGO IN (''02'',''03'',''04'')
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''' AND GGE.GGE_FECHA_EAP IS NOT NULL AND GPV.DD_EGA_ID IS NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''08'')';
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS EN ESTADO RECHAZADO PROPIETARIO');

    --GASTOS EN ESTADO INCOMPLETO
    EXECUTE IMMEDIATE 'MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''' AND GGE.DD_EAP_ID IS NULL AND GPV.DD_EGA_ID IS NULL AND 
                (GPV.PVE_ID_EMISOR IS NULL OR GPV.DD_TGA_ID IS NULL OR GPV.DD_STG_ID IS NULL 
                OR GPV.GPV_FECHA_EMISION IS NULL OR GPV.GPV_REF_EMISOR IS NULL OR GPV.DD_TPE_ID IS NULL 
                OR GPV.DD_TOG_ID IS NULL OR GDE.GDE_PRINCIPAL_NO_SUJETO IS NULL)) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''12'')';
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS EN ESTADO INCOMPLETO');
    
    --GASTOS EN ESTADO PENDIENTE DE AUTORIZAR
    V_SENTENCIA := '
        MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH ON EAH.DD_EAH_ID = GGE.DD_EAH_ID AND EAH.DD_EAH_CODIGO = ''01''
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''' AND GPV.DD_EGA_ID IS NULL AND GPV.PVE_ID_EMISOR IS NOT NULL AND GPV.DD_TGA_ID IS NOT NULL 
                AND GPV.DD_STG_ID IS NOT NULL AND GPV.GPV_FECHA_EMISION IS NOT NULL AND GPV.GPV_REF_EMISOR IS NOT NULL 
                AND GPV.DD_TPE_ID IS NOT NULL AND GPV.DD_TOG_ID IS NOT NULL AND GDE.GDE_PRINCIPAL_NO_SUJETO IS NOT NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''01'')';
    EXECUTE IMMEDIATE V_SENTENCIA;
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS EN ESTADO PENDIENTE DE AUTORIZAR');
    
    
    --GASTOS EN ESTADO AUTORIZADO HRE
    EXECUTE IMMEDIATE 'MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH ON GGE.DD_EAH_ID = EAH.DD_EAH_ID AND EAH.DD_EAH_CODIGO = ''03''
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''' AND GPV.DD_EGA_ID IS NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''03'')';
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS EN ESTADO AUTORIZADO HRE');
    
    EXECUTE IMMEDIATE 'MERGE INTO REM01.GGE_GASTOS_GESTION T1
        USING (SELECT GGE.GGE_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH ON GGE.DD_EAH_ID = EAH.DD_EAH_ID AND EAH.DD_EAH_CODIGO = ''03''
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''' AND GPV.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''03'') 
                AND GGE.GGE_FECHA_EAH IS NULL) T2
        ON (T1.GGE_ID = T2.GGE_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.GGE_FECHA_EAH = SYSTIMESTAMP';
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. FECHA AUTORIZACION HRE EN GASTOS EN ESTADO AUTORIZADO HRE');
    
    --GASTOS EN ESTADO RECHAZADO HRE
    EXECUTE IMMEDIATE 'MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
        USING (SELECT GPV.GPV_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH ON GGE.DD_EAH_ID = EAH.DD_EAH_ID AND EAH.DD_EAH_CODIGO = ''02''
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''' AND GPV.DD_EGA_ID IS NULL) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''02'')';
        
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT; 
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. GASTOS EN ESTADO RECHAZADO HRE');
    
    EXECUTE IMMEDIATE '
        MERGE INTO REM01.GGE_GASTOS_GESTION T1
        USING (SELECT GGE.GGE_ID 
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
            JOIN REM01.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH ON GGE.DD_EAH_ID = EAH.DD_EAH_ID AND EAH.DD_EAH_CODIGO = ''02''
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''' AND GPV.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''02'') 
                AND GGE.GGE_FECHA_EAH IS NULL) T2
        ON (T1.GGE_ID = T2.GGE_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.GGE_FECHA_EAH = SYSTIMESTAMP';
    
    V_REG_ACTUALIZADOS := SQL%ROWCOUNT;
    V_REG_TOTAL := V_REG_TOTAL + V_REG_ACTUALIZADOS;
    DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.GGE_GASTOS_GESTION ACTUALIZADAS. '||V_REG_ACTUALIZADOS||' Filas. FECHA RECHAZO HRE EN GASTOS EN ESTADO RECHAZADO HRE');
    
    EXECUTE IMMEDIATE 'MERGE INTO REM01.GGE_GASTOS_GESTION T1
        USING (SELECT GPV.GPV_ID
            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
            JOIN REM01.DD_EGA_ESTADOS_GASTO EGA ON EGA.DD_EGA_ID = GPV.DD_EGA_ID AND EGA.DD_EGA_CODIGO = ''08''
            WHERE GPV.USUARIOCREAR = '''||V_USUARIO||''') T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EAH_ID = (SELECT DD_EAH_ID FROM REM01.DD_EAH_ESTADOS_AUTORIZ_HAYA WHERE DD_EAH_CODIGO = ''01'')
        WHERE T1.DD_EAH_ID <> (SELECT DD_EAH_ID FROM REM01.DD_EAH_ESTADOS_AUTORIZ_HAYA WHERE DD_EAH_CODIGO = ''01'')';

        DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.GGE_GASTOS_GESTION actualizada (DD_EAH_ID). '||SQL%ROWCOUNT||' Filas.');
    COMMIT;
      
EXCEPTION
      WHEN OTHERS THEN
            DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
            DBMS_OUTPUT.put_line('-----------------------------------------------------------');
            DBMS_OUTPUT.put_line(SQLERRM);
            ROLLBACK;
            RAISE;
END;

/

EXIT;
