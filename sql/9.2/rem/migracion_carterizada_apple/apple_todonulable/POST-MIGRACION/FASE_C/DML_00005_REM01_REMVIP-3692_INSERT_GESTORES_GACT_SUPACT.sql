--/*
--#########################################
--## AUTOR=Albert Pastor
--## FECHA_CREACION=20190323
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.17
--## INCIDENCIA_LINK=REMVIP3692
--## PRODUCTO=NO
--## 
--## Finalidad: Actualización tabla 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    TABLE_COUNT NUMBER(1,0) := 0;
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	V_USU VARCHAR2(30 CHAR):= 'REMVIP3692';
BEGIN


SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE TABLE_NAME = ''||V_USU||'' AND OWNER= ''||V_ESQUEMA||'';

IF TABLE_COUNT > 0 THEN

   DBMS_OUTPUT.PUT_LINE('[INFO] TABLA '||V_ESQUEMA||'.'||V_USU||' YA EXISTENTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
   EXECUTE IMMEDIATE 'DROP TABLE '||V_ESQUEMA||'.'||V_USU||'';
   
   DBMS_OUTPUT.PUT_LINE('[INFO] TABLA AUX ELIMINADA');

END IF;

V_MSQL := 'CREATE TABLE '||V_ESQUEMA||'.'||V_USU||' (
ACT_ID NUMBER(16),
USU_ID_GEE NUMBER(16),
USU_ID_DIST NUMBER(16),
GEE_CUR NUMBER(16),
GEH_CUR NUMBER(16),
GEH_NEXT NUMBER(16))';

EXECUTE IMMEDIATE V_MSQL;


DBMS_OUTPUT.PUT_LINE('[INFO] TABLA AUX CREADA');

V_MSQL := '
INSERT INTO '||V_ESQUEMA||'.'||V_USU||'
(ACT_ID,GEE_CUR,USU_ID_GEE)
SELECT ACT.ACT_ID, GEE.GEE_ID, GEE.USU_ID
FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE 
INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GAC.GEE_ID = GEE.GEE_ID
INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON GAC.ACT_ID = ACT.ACT_ID
INNER JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON ACT.DD_CRA_ID = CRA.DD_CRA_ID
INNER JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON GEE.DD_TGE_ID = TGE.DD_TGE_ID
INNER JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_ID = ACT.DD_SCM_ID
WHERE CRA.DD_CRA_CODIGO IN (''07'')
AND GEE.BORRADO = 0
and tge.dd_tge_codigo in (''GACT'')
AND ACT.ACT_ID IN (SELECT ACT.ACT_ID
FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE 
INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GAC.GEE_ID = GEE.GEE_ID
INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON GAC.ACT_ID = ACT.ACT_ID
INNER JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON ACT.DD_CRA_ID = CRA.DD_CRA_ID
INNER JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON GEE.DD_TGE_ID = TGE.DD_TGE_ID
INNER JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_ID = ACT.DD_SCM_ID
WHERE CRA.DD_CRA_CODIGO IN (''07'')
AND GEE.BORRADO = 0
and usu_id = (SELECT USU_ID FROM '||V_ESQUEMA_M||'.usu_usuarios WHERE USU_USERNAME = ''bbaviera'')
)
';
EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('[INFO] AUX CON  '|| SQL%ROWCOUNT ||' FILAS ');

V_MSQL := '
MERGE INTO '||V_ESQUEMA||'.'||V_USU||' AUX
USING(
SELECT ACT_ID, USU_ID
FROM '||V_ESQUEMA||'.V_GESTORES_ACTIVO VGES
INNER JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU
ON VGES.USERNAME = USU.USU_USERNAME
WHERE VGES.DD_CRA_CODIGO IN (07)
AND VGES.TIPO_GESTOR = ''GACT'') TMP
ON (TMP.ACT_ID = AUX.ACT_ID)
WHEN MATCHED THEN UPDATE
SET AUX.USU_ID_DIST = TMP.USU_ID ';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := '
UPDATE '||V_ESQUEMA||'.'||V_USU||' AUX
SET USU_ID_DIST = (SELECT USU_ID FROM '||V_ESQUEMA_M||'.usu_usuarios WHERE USU_USERNAME = ''bbaviera'')
';
EXECUTE IMMEDIATE V_MSQL;

-- ELIMINAR LOS DE PROVINCIAS VACÍAS
V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.'||V_USU||' WHERE USU_ID_DIST IS NULL'; 
EXECUTE IMMEDIATE V_MSQL;


V_MSQL := '
MERGE INTO '||V_ESQUEMA||'.'||V_USU||' AUX
USING(
SELECT  GEH.GEH_ID, ACT.ACT_ID
FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
INNER JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH ON GAH.GEH_ID = GEH.GEH_ID
INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON GAH.ACT_ID = ACT.ACT_ID
INNER JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON ACT.DD_CRA_ID = CRA.DD_CRA_ID
INNER JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON GEH.DD_TGE_ID = TGE.DD_TGE_ID
INNER JOIN DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_ID = ACT.DD_SCM_ID
WHERE CRA.DD_CRA_CODIGO IN (''07'')
AND DD_TGE_CODIGO = ''GACT''
AND GEH.GEH_FECHA_HASTA IS NULL 
AND GEH.BORRADO = 0
) TMP
ON (TMP.ACT_ID = AUX.ACT_ID)
WHEN MATCHED THEN UPDATE
SET AUX.GEH_CUR = TMP.GEH_ID';
EXECUTE IMMEDIATE V_MSQL;

V_MSQL := '
UPDATE '||V_ESQUEMA||'.'||V_USU||'
SET GEH_NEXT = S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL 
WHERE USU_ID_DIST <> USU_ID_GEE';
EXECUTE IMMEDIATE V_MSQL;


	DBMS_OUTPUT.PUT_LINE('[INFO] REGISTROS A MODIFICAR:  '|| SQL%ROWCOUNT ||' FILAS ');


-----PASO A TABLAS FINALES
--CAMBIO USUARIO GEE
V_MSQL := '
MERGE INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
USING 
(SELECT * FROM '||V_ESQUEMA||'.'||V_USU||' WHERE USU_ID_DIST <> USU_ID_GEE ) TMP
ON (GEE.GEE_ID = TMP.GEE_CUR)
WHEN MATCHED THEN UPDATE
SET
GEE.USU_ID = TMP.USU_ID_DIST,
GEE.USUARIOMODIFICAR = '''||V_USU||''',
GEE.FECHAMODIFICAR = SYSDATE ';
EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('[INFO] REGISTROS MODIFICADOS GEE:  '|| SQL%ROWCOUNT ||' FILAS ');

--FINALIZAMOS GEH
V_MSQL := '
MERGE INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
USING 
(SELECT * FROM '||V_ESQUEMA||'.'||V_USU||' WHERE USU_ID_DIST <> USU_ID_GEE ) TMP
ON (GEH.GEH_ID = TMP.GEH_CUR)
WHEN MATCHED THEN UPDATE
SET
GEH.GEH_FECHA_HASTA = TRUNC(SYSDATE),
GEH.USUARIOMODIFICAR = '''||V_USU||''',
GEH.FECHAMODIFICAR = SYSDATE ';
EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('[INFO] REGISTROS MODIFICADOS GEH:  '|| SQL%ROWCOUNT ||' FILAS ');

--INSERTAMOS NUEVO GEH

V_MSQL := '
INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST
(GEH_ID,
USU_ID,
DD_TGE_ID,
GEH_FECHA_DESDE,
USUARIOCREAR,
FECHACREAR)

SELECT GEH_NEXT AS GEH_ID , 
USU_ID_DIST AS USU_ID,
(SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = ''GACT''),
TRUNC(SYSDATE) AS GEH_FECHA_DESDE,
'''||V_USU||''' AS USUARIOCREAR,
SYSDATE AS FECHACREAR

FROM '||V_ESQUEMA||'.'||V_USU||' WHERE USU_ID_DIST <> USU_ID_GEE';
EXECUTE IMMEDIATE V_MSQL;


	DBMS_OUTPUT.PUT_LINE('[INFO] REGISTROS INSERTADOS GEH:  '|| SQL%ROWCOUNT ||' FILAS ');

--INSERTAMOS NUEVO GAH
V_MSQL := '
INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO
(GEH_ID, ACT_ID)
SELECT GEH_NEXT AS GEH_ID , ACT_ID FROM '||V_ESQUEMA||'.'||V_USU||' WHERE USU_ID_DIST <> USU_ID_GEE';
EXECUTE IMMEDIATE V_MSQL;


	DBMS_OUTPUT.PUT_LINE('[INFO] REGISTROS INSERTADOS GAH:  '|| SQL%ROWCOUNT ||' FILAS ');

commit;

EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        DBMS_OUTPUT.put_line(V_MSQL);
        ROLLBACK;
        RAISE;
END;
/

EXIT;
