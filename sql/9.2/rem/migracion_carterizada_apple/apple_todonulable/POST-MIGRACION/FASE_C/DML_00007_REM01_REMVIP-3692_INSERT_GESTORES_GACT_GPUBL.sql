--/*
--#########################################
--## AUTOR=Albert Pastor
--## FECHA_CREACION=20190323
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.17
--## INCIDENCIA_LINK=REMVIP-3719
--## PRODUCTO=NO
--## 
--## Finalidad: Actualización tabla 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    TABLE_COUNT NUMBER(1,0) := 0;
    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; -- Configuracion Esquema Master
	V_USU VARCHAR2(30 CHAR):= 'REMVIP3719';
BEGIN


-----PASO A TABLAS FINALES
--INSERTAMOS TANTOS REGISTROS COMO ACTIVOS EN LA GEE
V_MSQL := '
INSERT INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD
(gee_id,usu_id,
dd_tge_id, 
USUARIOCREAR, 
FECHACREAR,
USUARIOMODIFICAR,
BORRADO)
SELECT  '||V_ESQUEMA||'.S_GEE_GESTOR_ENTIDAD.nextval,
  (SELECT USU_ID FROM '||V_ESQUEMA_M||'.usu_usuarios WHERE USU_USERNAME = ''avila''),
  (SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = ''GPUBL''),
   ''MIG_APPLE'',
  sysdate,
  TO_CHAR(ACT.ACT_ID),
  0
FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
INNER JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON ACT.DD_CRA_ID = CRA.DD_CRA_ID
INNER JOIN '||V_ESQUEMA||'.DD_SCR_SUBCARTERA SCR ON SCR.DD_CRA_ID = CRA.DD_CRA_ID AND ACT.DD_SCR_ID = SCR.DD_SCR_ID
WHERE CRA.DD_CRA_CODIGO IN (''07'')
AND SCR.DD_SCR_CODIGO IN (''138'')
AND ACT.USUARIOCREAR = ''MIG_APPLE''
';
EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('[INFO] REGISTROS MODIFICADOS GEE:  '|| SQL%ROWCOUNT ||' FILAS ');

--INSERTAMOS EN LA GAC
V_MSQL := '
INSERT INTO '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
(GEE_ID, ACT_ID)
SELECT UNIQUE GEE.GEE_ID, ACT.ACT_ID
FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
INNER JOIN ACT_ACTIVO ACT ON TO_CHAR(ACT.ACT_ID) = GEE.USUARIOMODIFICAR
WHERE ACT.USUARIOCREAR = ''MIG_APPLE''
';

EXECUTE IMMEDIATE V_MSQL;

	
	V_MSQL:'UPDATE '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD
SET USUARIOMODIFICAR = NULL
WHERE USUARIOCREAR = ''MIG_APPLE''';
EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] REGISTROS MODIFICADOS GAC:  '|| SQL%ROWCOUNT ||' FILAS ');
	
	--INSERTAMOS EN LA GEH
V_MSQL := '
INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST
(GEH_ID,
USU_ID,
DD_TGE_ID, 
GEH_FECHA_DESDE,
USUARIOCREAR, 
FECHACREAR, 
USUARIOMODIFICAR,
BORRADO)
SELECT  '||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.nextval,
  (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''avila''),
  (SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = ''GPUBL''),
  SYSDATE,
   ''MIG_APPLE'',
  SYSDATE,
  TO_CHAR(ACT.ACT_ID),
  0
FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
INNER JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON ACT.DD_CRA_ID = CRA.DD_CRA_ID
INNER JOIN '||V_ESQUEMA||'.DD_SCR_SUBCARTERA SCR ON SCR.DD_CRA_ID = CRA.DD_CRA_ID AND ACT.DD_SCR_ID = SCR.DD_SCR_ID
WHERE CRA.DD_CRA_CODIGO IN (''07'')
AND SCR.DD_SCR_CODIGO IN (''138'')
AND ACT.USUARIOCREAR = ''MIG_APPLE''
';
EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('[INFO] REGISTROS MODIFICADOS GEH:  '|| SQL%ROWCOUNT ||' FILAS ');
	
	--INSERTAMOS EN LA GAH
V_MSQL := '
INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
(GEH_ID, ACT_ID) 
SELECT UNIQUE GEH.GEH_ID, 
ACT.ACT_ID
FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON TO_CHAR(ACT.ACT_ID) = GEH.USUARIOMODIFICAR 
WHERE ACT.USUARIOCREAR = ''MIG_APPLE''
';
EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('[INFO] REGISTROS MODIFICADOS GAH:  '|| SQL%ROWCOUNT ||' FILAS ');
	
	
	V_MSQL:'UPDATE '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST
SET USUARIOMODIFICAR = NULL
WHERE USUARIOCREAR = ''MIG_APPLE''';
EXECUTE IMMEDIATE V_MSQL;

commit;



EXCEPTION

    WHEN OTHERS THEN
	DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
	DBMS_OUTPUT.put_line('-----------------------------------------------------------');
	DBMS_OUTPUT.put_line(SQLERRM);
	DBMS_OUTPUT.put_line(V_MSQL);
	ROLLBACK;
	RAISE;
END;
/
EXIT;
