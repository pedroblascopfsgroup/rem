--/*
--#########################################
--## AUTOR=Guillermo Llidó Parra
--## FECHA_CREACION=20190323
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.20
--## INCIDENCIA_LINK=REMVIP-3729
--## PRODUCTO=NO
--## 
--## Finalidad: Cambiamos el Estado de una serie de activos.
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	V_SQL 			VARCHAR2(2000 CHAR);
    TABLE_COUNT 	NUMBER(1,0) := 0;
	V_ESQUEMA 		VARCHAR2(25 CHAR):= 'REM01'; -- Configuracion Esquema
	V_ESQUEMA_M 	VARCHAR2(25 CHAR):= 'REMMASTER'; -- Configuracion Esquema Master
	V_USUARIO 		VARCHAR2(50 CHAR):= 'REMVIP-3729';

BEGIN			
			
	DBMS_OUTPUT.PUT_LINE('[INICIO] Comienza el proceso...'); 
    
    V_SQL := 'MERGE INTO '||V_ESQUEMA||'.BIE_LOCALIZACION T1 USING
				( SELECT AUX.ACT_NUMERO_ACTIVO
						,ACT.BIE_ID
						,TVI.DD_TVI_ID
						,AUX.LOC_NOMBRE_VIA
						,AUX.LOC_NUMERO_DOMICILIO
						,AUX.LOC_BLOQUE
						,AUX.LOC_ESCALERA
						,AUX.LOC_PISO
						,AUX.LOC_PUERTA
						,AUX.LOC_COD_POST
						,DDLOC.DD_LOC_ID
						,PRV.DD_PRV_ID
						,AUX.LOC_LONGITUD
						,AUX.LOC_LATITUD
				FROM '||V_ESQUEMA||'.AUX_REMVIP_3729 AUX
				 JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON AUX.ACT_NUMERO_ACTIVO = ACT.ACT_NUM_ACTIVO
				 JOIN '||V_ESQUEMA||'.ACT_LOC_LOCALIZACION LOC ON ACT.ACT_ID = LOC.ACT_ID
                 JOIN '||V_ESQUEMA||'.BIE_BIEN BIE ON BIE.BIE_ID = ACT.BIE_ID
				 JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BLOC ON BLOC.BIE_ID = ACT.BIE_ID
				 JOIN '||V_ESQUEMA_M||'.DD_TVI_TIPO_VIA TVI ON TVI.DD_TVI_CODIGO = AUX.TIPO_VIA
				 LEFT JOIN '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD DDLOC on DDLOC.DD_LOC_CODIGO = LPAD(AUX.MUNICIPIO,5,0)
				 JOIN '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA PRV ON PRV.DD_PRV_CODIGO = AUX.PROVINCIA
                ) T2
				ON (T1.BIE_ID = T2.BIE_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.DD_TVI_ID = T2.DD_TVI_ID
				,   T1.BIE_LOC_NOMBRE_VIA =  T2.LOC_NOMBRE_VIA
				,   T1.BIE_LOC_NUMERO_DOMICILIO = T2.LOC_NUMERO_DOMICILIO
				,   T1.BIE_LOC_BLOQUE = T2.LOC_BLOQUE
				,   T1.BIE_LOC_ESCALERA = T2.LOC_ESCALERA
				,   T1.BIE_LOC_PISO = T2.LOC_PISO
				,   T1.BIE_LOC_PUERTA = T2.LOC_PUERTA
				,   T1.BIE_LOC_COD_POST = T2.LOC_COD_POST
				,   T1.DD_LOC_ID = T2.DD_LOC_ID
				,   T1.DD_PRV_ID = T2.DD_PRV_ID
	';
    --DBMS_OUTPUT.PUT_LINE(V_SQL);
	EXECUTE IMMEDIATE V_SQL;
    
	DBMS_OUTPUT.PUT_LINE('	[INFO] Se han actualizado '||SQL%ROWCOUNT||' registros. En la BIE_LOCALIZACION.'); 

	
	    V_SQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_LOC_LOCALIZACION T1 USING
				(SELECT  AUX.ACT_NUMERO_ACTIVO
						,ACT.ACT_ID
						,AUX.LOC_LONGITUD
						,AUX.LOC_LATITUD
				FROM '||V_ESQUEMA||'.AUX_REMVIP_3729 AUX
				 JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON AUX.ACT_NUMERO_ACTIVO = ACT.ACT_NUM_ACTIVO
				 JOIN '||V_ESQUEMA||'.ACT_LOC_LOCALIZACION LOC ON ACT.ACT_ID = LOC.ACT_ID
                 JOIN '||V_ESQUEMA||'.BIE_BIEN BIE ON BIE.BIE_ID = ACT.BIE_ID
				 JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BLOC ON BLOC.BIE_ID = ACT.BIE_ID
				LEFT JOIN '||V_ESQUEMA_M||'.DD_TVI_TIPO_VIA TVI ON TVI.DD_TVI_CODIGO = AUX.TIPO_VIA
				LEFT JOIN '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD DDLOC on DDLOC.DD_LOC_CODIGO = LPAD(AUX.MUNICIPIO,5,0)
				LEFT JOIN '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA PRV ON PRV.DD_PRV_CODIGO = AUX.PROVINCIA) T2
				ON (T1.ACT_ID = T2.ACT_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.LOC_LONGITUD = T2.LOC_LONGITUD
				,   T1.LOC_LATITUD =  T2.LOC_LATITUD
	';
    
	EXECUTE IMMEDIATE V_SQL;
    
	DBMS_OUTPUT.PUT_LINE('	[INFO] Se han actualizado '||SQL%ROWCOUNT||' registros. En la ACT_LOC_LOCALIZACION.'); 

	COMMIT;
	DBMS_OUTPUT.PUT_LINE('[FIN]');


EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT
