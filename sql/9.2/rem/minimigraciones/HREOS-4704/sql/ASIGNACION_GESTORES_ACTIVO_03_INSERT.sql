--/*
--##########################################
--## AUTOR=Alejandro Valverde Herrera
--## FECHA_CREACION=20181105
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-4704
--## PRODUCTO=NO
--## 
--## Finalidad: INSERT MASIVO GESTORES ACT_GES_DIST_GESTORES
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
    V_SQL_1 VARCHAR2(4000 CHAR); -- Sentencia a ejecutar 1
    V_SQL_2 VARCHAR2(4000 CHAR); -- Sentencia a ejecutar 2
    V_SQL_3 VARCHAR2(4000 CHAR); -- Sentencia a ejecutar 3        
    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(30 CHAR):= 'ACT_GES_DIST_GESTORES';
    V_TABLA_TMP VARCHAR2(30 CHAR):= 'TMP_ASIGNACION_GESTORES_ACTIVO';
    V_COUNT NUMBER(16):= 0; -- Vble. para contar
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USUARIO VARCHAR2(32 CHAR):= 'HREOS-4704';

    V_DEBUG BOOLEAN := FALSE;
	
BEGIN

	--------------------------------------
	--   INSERT ACT_GES_DIST_GESTORES   --
	--------------------------------------

	IF NOT V_DEBUG THEN

		V_SQL_1 := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET BORRADO = 1, USUARIOMODIFICAR = '''||V_USUARIO||''', FECHAMODIFICAR = SYSDATE WHERE (TIPO_GESTOR = ''GPUBL'' OR TIPO_GESTOR = ''SPUBL'') AND USERNAME = ''usugrupub'' AND COD_CARTERA IS NULL AND COD_MUNICIPIO IS NULL AND COD_PROVINCIA IS NULL';

		EXECUTE IMMEDIATE V_SQL_1;
		DBMS_OUTPUT.PUT_LINE('[INFO] Se ha realizado un borrado lógico de '||SQL%ROWCOUNT||' gestores en total en la tabla ACT_GES_DIST_GESTORES');

		DBMS_OUTPUT.PUT_LINE('--INICIO INSERT GESTORES ACT_GES_DIST_GESTORES');

		V_SQL_2 := '
			INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (
				ID
				, TIPO_GESTOR
				, COD_CARTERA
				, COD_ESTADO_ACTIVO
				, COD_TIPO_COMERZIALZACION
				, COD_PROVINCIA
				, COD_MUNICIPIO
				, COD_POSTAL 
				, USERNAME
				, NOMBRE_USUARIO
				, VERSION
				, USUARIOCREAR
				, FECHACREAR
				, USUARIOMODIFICAR
				, FECHAMODIFICAR
				, USUARIOBORRAR
				, FECHABORRAR
				, BORRADO
				) 
				SELECT
				'||V_ESQUEMA||'.S_'||V_TABLA||'.NEXTVAL          					ID
				,TMP.PERFIL_GESTOR									TIPO_GESTOR
				,TO_NUMBER((SELECT DD_CRA_CODIGO FROM DD_CRA_CARTERA WHERE UPPER(DD_CRA_DESCRIPCION) = UPPER(TMP.CARTERA))) COD_CARTERA
				,NULL											COD_ESTADO_ACTIVO
				,NULL											COD_TIPO_COMERZIALZACION
				,TO_NUMBER((SELECT DD_PRV_CODIGO FROM '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA WHERE TO_NUMBER(DD_PRV_CODIGO) = TMP.CODPROVINCIA)) COD_PROVINCIA
				,TO_NUMBER(TMP.MUNICIPIO)								COD_MUNICIPIO
				,TMP.CP											COD_POSTAL
				,TMP.CODGESTOR										USERNAME
				,TMP.GESTOR										NOMBRE_USUARIO
				,1											VERSION
				,'''||V_USUARIO||'''									USUARIOCREAR
				,SYSDATE										FECHACREAR
				,NULL											USUARIOMODIFICAR
				,NULL											FECHAMODIFICAR
				,NULL											USUARIOBORRAR
				,NULL											FECHABORRAR	
				,0											BORRADO
				FROM '||V_ESQUEMA||'.'||V_TABLA_TMP||' TMP
					JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON TMP.CODGESTOR = USU.USU_USERNAME
					JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON UPPER(CRA.DD_CRA_DESCRIPCION) = UPPER(TMP.CARTERA)
					WHERE NOT EXISTS (SELECT * FROM '||V_ESQUEMA||'.'||V_TABLA||' AGDG WHERE AGDG.TIPO_GESTOR = ''GPUBL'' 
							AND AGDG.COD_CARTERA = TO_NUMBER(CRA.DD_CRA_CODIGO) 
							AND AGDG.COD_PROVINCIA = TO_NUMBER(TMP.CODPROVINCIA) 
							AND AGDG.COD_MUNICIPIO = TO_NUMBER(TMP.MUNICIPIO) 
							AND AGDG.USERNAME = TMP.CODGESTOR)
				 	AND USU.BORRADO = 0';
	
		EXECUTE IMMEDIATE V_SQL_2;
		DBMS_OUTPUT.PUT_LINE('[INFO] Se han insertado en total '||SQL%ROWCOUNT||' gestores en la tabla ACT_GES_DIST_GESTORES');
	    
		DBMS_OUTPUT.PUT_LINE('--INICIO INSERT SUPERVISORES ACT_GES_DIST_GESTORES');

		V_SQL_3 := '
			INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (
				ID
				, TIPO_GESTOR
				, COD_CARTERA
				, COD_ESTADO_ACTIVO
				, COD_TIPO_COMERZIALZACION
				, COD_PROVINCIA
				, COD_MUNICIPIO
				, COD_POSTAL 
				, USERNAME
				, NOMBRE_USUARIO
				, VERSION
				, USUARIOCREAR
				, FECHACREAR
				, USUARIOMODIFICAR
				, FECHAMODIFICAR
				, USUARIOBORRAR
				, FECHABORRAR
				, BORRADO
				) 
				SELECT
				'||V_ESQUEMA||'.S_'||V_TABLA||'.NEXTVAL          					ID
				,''SPUBL''										TIPO_GESTOR
				,TO_NUMBER((SELECT DD_CRA_CODIGO FROM DD_CRA_CARTERA WHERE UPPER(DD_CRA_DESCRIPCION) = UPPER(TMP.CARTERA))) COD_CARTERA
				,NULL											COD_ESTADO_ACTIVO
				,NULL											COD_TIPO_COMERZIALZACION
				,TO_NUMBER((SELECT DD_PRV_CODIGO FROM '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA WHERE TO_NUMBER(DD_PRV_CODIGO) = TMP.CODPROVINCIA)) COD_PROVINCIA
				,TO_NUMBER(TMP.MUNICIPIO)								COD_MUNICIPIO
				,TMP.CP											COD_POSTAL
				,TMP.CODSUPERVISOR									USERNAME
				,TMP.SUPERVISOR										NOMBRE_USUARIO
				,1											VERSION
				,'''||V_USUARIO||'''									USUARIOCREAR
				,SYSDATE										FECHACREAR
				,NULL											USUARIOMODIFICAR
				,NULL											FECHAMODIFICAR
				,NULL											USUARIOBORRAR
				,NULL											FECHABORRAR	
				,0											BORRADO			
			     	FROM '||V_ESQUEMA||'.'||V_TABLA_TMP||' TMP
					JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON TMP.CODGESTOR = USU.USU_USERNAME
					JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON UPPER(CRA.DD_CRA_DESCRIPCION) = UPPER(TMP.CARTERA)
					WHERE NOT EXISTS (SELECT * FROM '||V_ESQUEMA||'.'||V_TABLA||' AGDG WHERE AGDG.TIPO_GESTOR = ''SPUBL'' 
							AND AGDG.COD_CARTERA = TO_NUMBER(CRA.DD_CRA_CODIGO) 
							AND AGDG.COD_PROVINCIA = TO_NUMBER(TMP.CODPROVINCIA) 
							AND AGDG.COD_MUNICIPIO = TO_NUMBER(TMP.MUNICIPIO) 
							AND AGDG.USERNAME = TMP.CODSUPERVISOR)
				 	AND USU.BORRADO = 0';


		EXECUTE IMMEDIATE V_SQL_3;
		DBMS_OUTPUT.PUT_LINE('[INFO] Se han insertado en total '||SQL%ROWCOUNT||' supervisores en la tabla ACT_GES_DIST_GESTORES');

	ELSE
	  
		DBMS_OUTPUT.PUT_LINE(V_SQL_1||';');
		DBMS_OUTPUT.PUT_LINE(V_SQL_2||';');
		DBMS_OUTPUT.PUT_LINE(V_SQL_3||';');
      		
	END IF;
    
    	DBMS_OUTPUT.PUT_LINE( '--FIN INSERT ACT_GES_DIST_GESTORES');
   
	---------------------------
	--   PASO ESTADÍSTICAS   --
	---------------------------	

	DBMS_OUTPUT.PUT_LINE( '--INICIO ESTADÍSTICAS');
		
	IF NOT V_DEBUG THEN

		EXECUTE IMMEDIATE('begin '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''STATS'',''ACT_GES_DIST_GESTORES''); end;');

	ELSE
      
		DBMS_OUTPUT.PUT_LINE( '--ESTADÍSTICAS');      		    
		
	END IF;        
		
	DBMS_OUTPUT.PUT_LINE( '--FIN ESTADÍSTICAS');
    
    	DBMS_OUTPUT.PUT_LINE( '--FIN INSERT ACT_GES_DIST_GESTORES');
    
    	IF NOT V_DEBUG THEN
		COMMIT;
    	ELSE
		ROLLBACK;
    	END IF; 

EXCEPTION
    WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
      DBMS_OUTPUT.put_line(V_SQL_1);
      DBMS_OUTPUT.put_line(V_SQL_2);
      DBMS_OUTPUT.put_line(V_SQL_3);
      DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
      DBMS_OUTPUT.put_line(ERR_MSG);
      ROLLBACK;
      RAISE;

END; 
   
/

EXIT;
