--/* 
--#########################################
--## AUTOR=Mariam Lliso
--## FECHA_CREACION=20190402
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.9.0
--## INCIDENCIA_LINK=HREOS-5925
--## PRODUCTO=NO
--## 
--## Finalidad:Merge entre 'AUX_BOF_HREOS_5925' y las tablas FOR_FORMALIZACION y COE_CONDICIONANTES_EXPEDIENTE
--## 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/ 


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_TEXT1 VARCHAR2(2400 CHAR); -- Vble. auxiliar
    V_TABLA_FOR VARCHAR2(2400 CHAR) := 'FOR_FORMALIZACION'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_TABLA_COE VARCHAR2(2400 CHAR) := 'COE_CONDICIONANTES_EXPEDIENTE'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_TABLA_AUX VARCHAR2(2400 CHAR) := 'AUX_BOF_HREOS_5925'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_ENTIDAD_ID NUMBER(16);
    V_ID NUMBER(16);
    V_USU VARCHAR2(2400 CHAR) := 'HREOS-5925'; 
    
BEGIN	
	
DBMS_OUTPUT.PUT_LINE('[INICIO] ');
DBMS_OUTPUT.PUT_LINE('[INFO]: MERGE INTO SOBRE LA TABLA REM01.'||V_TABLA_FOR);
DBMS_OUTPUT.PUT_LINE('FILAS INSERTADAS EN LA TABLA '||V_TABLA_FOR||' ' ||SQL%ROWCOUNT);

-- MERGE

MERGE INTO REM01.FOR_FORMALIZACION FOM
  USING (
      SELECT ECO.ECO_ID, XFOM.FOR_NUMEXPEDIENTE, XFOM.DD_TIPOFINANCIACION, XFOM.FOR_CAPITALCONCEDIDO
      FROM REM01.AUX_BOF_HREOS_5925 XFOM
        JOIN REM01.OFR_OFERTAS OFR ON OFR.OFR_NUM_OFERTA = XFOM.OFR_NUM_OFERTA
        JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
        JOIN REM01.FOR_FORMALIZACION FOX ON FOX.ECO_ID = ECO.ECO_ID
  ) AUX
  ON (FOM.ECO_ID = AUX.ECO_ID)
  WHEN MATCHED THEN UPDATE SET
    FOM.FOR_NUMEXPEDIENTE = AUX.FOR_NUMEXPEDIENTE
  , FOM.DD_TRC_ID = (SELECT TRC.DD_TRC_ID FROM REM01.DD_TRC_TIPO_RIESGO_CLASE TRC
                        WHERE TRC.DD_TRC_CODIGO = AUX.DD_TIPOFINANCIACION)
  , FOM.FOR_CAPITALCONCEDIDO = AUX.FOR_CAPITALCONCEDIDO
  , FOM.USUARIOMODIFICAR = 'HREOS-5925'
  , FOM.FECHAMODIFICAR = SYSDATE
  ;


COMMIT;

DBMS_OUTPUT.PUT_LINE('[FIN]: TABLA '||V_TABLA_FOR||' ACTUALIZADA CORRECTAMENTE ');

DBMS_OUTPUT.PUT_LINE('[INFO]: MERGE INTO SOBRE LA TABLA REM01.'||V_TABLA_FOR);
DBMS_OUTPUT.PUT_LINE('FILAS INSERTADAS EN LA TABLA '||V_TABLA_FOR||' ' ||SQL%ROWCOUNT);

-- MERGE

MERGE INTO REM01.COE_CONDICIONANTES_EXPEDIENTE COE
  USING (
      SELECT ECO.ECO_ID, COE.DD_ESTADOFINANCIACION, COE.COE_INICIO_FINANCIACION, COE.COE_FIN_FINANCIACION, COE.DD_ENTIDADFINANCIERA
      FROM REM01.AUX_BOF_HREOS_5925 COE
        JOIN REM01.OFR_OFERTAS OFR ON OFR.OFR_NUM_OFERTA = COE.OFR_NUM_OFERTA
        JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
        JOIN REM01.FOR_FORMALIZACION FOX ON FOX.ECO_ID = ECO.ECO_ID
  ) AUX
  ON (COE.ECO_ID = AUX.ECO_ID)
  WHEN MATCHED THEN UPDATE SET
    COE.DD_ESF_ID = (SELECT ESF.DD_ESF_ID FROM REM01.DD_ESF_ESTADOS_FINANCIACION ESF 
                        WHERE ESF.DD_ESF_CODIGO = AUX.DD_ESTADOFINANCIACION)
  , COE.COE_INICIO_FINANCIACION = AUX.COE_INICIO_FINANCIACION
  , COE.COE_FIN_FINANCIACION  = AUX.COE_FIN_FINANCIACION
  , COE.USUARIOMODIFICAR = 'HREOS-5925'
  , COE.FECHAMODIFICAR = SYSDATE
  , COE.DD_ETF_ID = (SELECT ETF.DD_ETF_ID FROM REM01.DD_ETF_ENTIDAD_FINANCIERA ETF 
                        WHERE ETF.DD_ETF_CODIGO = AUX.DD_ENTIDADFINANCIERA)
  ;

COMMIT;
DBMS_OUTPUT.PUT_LINE('[FIN]: TABLA '||V_TABLA_COE||' ACTUALIZADA CORRECTAMENTE ');
DBMS_OUTPUT.PUT_LINE('[INFO]: MERGE INTO SOBRE LA TABLA REM01.'||V_TABLA_COE);
DBMS_OUTPUT.PUT_LINE('FILAS INSERTADAS EN LA TABLA '||V_TABLA_COE||' ' ||SQL%ROWCOUNT);
DBMS_OUTPUT.PUT_LINE('[FIN] DML');

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;
/

EXIT