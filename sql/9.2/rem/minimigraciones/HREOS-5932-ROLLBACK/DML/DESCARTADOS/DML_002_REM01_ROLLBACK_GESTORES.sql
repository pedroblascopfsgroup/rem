--/*
--##########################################
--## AUTOR=Guillermo Llidó Parra
--## FECHA_CREACION=20190530
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-5932
--## PRODUCTO=NO
--## Finalidad: Rollback Ofertas , Expedientes y Tramites.
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    err_num NUMBER; -- Numero de error.
    err_msg VARCHAR2(2048); -- Mensaje de error.
    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; -- Configuracion Esquemas.
    V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= 'REMMASTER'; -- Configuracion Esquemas.
    V_USUARIOMODIFICAR VARCHAR(100 CHAR):= '';
    V_MSQL VARCHAR2(4000 CHAR);
    
	V_TABLA_BACKUP VARCHAR2(100 CHAR);
	V_ESQUEMA_BACKUP VARCHAR2(100 CHAR);
	
BEGIN

  DBMS_OUTPUT.put_line('[INICIO] Ejecutando [GESTORES]  ...........');


/**
 ROLLBACK GESTORES DE LOS ACTIVOS
**/

		DBMS_OUTPUT.put_line('	[INFO] Se realiza rollback sobre tabla GAC_GESTOR_ADD_ACTIVO ');
		
		-- OBTENEMOS LA TABLA BACKUP
		V_MSQL := 'SELECT TABLA_BACKUP FROM '||V_ESQUEMA||'.AUX_MIG_ALQUILERES_TAB_AFEC  WHERE TABLA = ''GAC_GESTOR_ADD_ACTIVO'' ';
		EXECUTE IMMEDIATE V_MSQL INTO V_TABLA_BACKUP;
		-- OBTENEMOS EL ESQUEMA TABLA BACKUP
		V_MSQL := 'SELECT TABLESPACE_NAME FROM SYS.ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA_BACKUP||''' ';
		EXECUTE IMMEDIATE V_MSQL INTO V_ESQUEMA_BACKUP;
		
		-- BORRAMOS LOS GESTORES NUEVOS GAC
		
		V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO 
					WHERE GEE_ID IN( 
								SELECT GAC.GEE_ID FROM '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
								LEFT JOIN '||V_ESQUEMA_BACKUP||'.'||V_TABLA_BACKUP||' AUX ON (GAC.GEE_ID = AUX.GEE_ID )
								WHERE AUX.GEE_ID is null
					)';
							
		EXECUTE IMMEDIATE V_MSQL;
  		
  		DBMS_OUTPUT.PUT_LINE('	[INFO] Se ha hecho rollback de  '||SQL%ROWCOUNT||' GAC_GESTOR_ADD_ACTIVO.'); 
  		
  		-- ACTUALIZAMOS CON EL BACKUP
		
		V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC USING '||V_ESQUEMA_BACKUP||'.'||V_TABLA_BACKUP||' AUX
					ON (GAC.GEE_ID = AUX.GEE_ID AND GEE.ACT_ID = AUX.ACT_ID)
					WHEN NOT MATCHED THEN
					INSERT (GEE_ID,ACT_ID)
					VALUES (AUX.GEE_ID,AUX.ACT_ID)';
				
  		EXECUTE IMMEDIATE V_MSQL;
  		
  		DBMS_OUTPUT.PUT_LINE('	[INFO] Se ha hecho rollback de  '||SQL%ROWCOUNT||' GAC_GESTOR_ADD_ACTIVO.'); 
		
		-- OBTENEMOS LA TABLA BACKUP
		V_MSQL := 'SELECT TABLA_BACKUP FROM '||V_ESQUEMA||'.AUX_MIG_ALQUILERES_TAB_AFEC  WHERE TABLA = ''GEE_GESTOR_ENTIDAD'' ';
		EXECUTE IMMEDIATE V_MSQL INTO V_TABLA_BACKUP;
		-- OBTENEMOS EL ESQUEMA TABLA BACKUP
		V_MSQL := 'SELECT TABLESPACE_NAME FROM SYS.ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA_BACKUP||''' ';
		EXECUTE IMMEDIATE V_MSQL INTO V_ESQUEMA_BACKUP;
		
		-- BORRAMOS LOS GESTORES NUEVOS
		
		V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD 
					WHERE GEE_ID IN(
								SELECT GEE.GEE_ID FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
								LEFT JOIN '||V_ESQUEMA_BACKUP||'.'||V_TABLA_BACKUP||' AUX ON (GEE.GEE_ID = AUX.GEE_ID )
								WHERE AUX.GEE_ID is null)';
							
		EXECUTE IMMEDIATE V_MSQL;
  		
  		DBMS_OUTPUT.PUT_LINE('	[INFO] Se ha hecho rollback de  '||SQL%ROWCOUNT||' GEE_GESTOR_ENTIDAD.'); 

		-- ACTUALIZAMOS CON EL BACKUP
		
		V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE USING '||V_ESQUEMA_BACKUP||'.'||V_TABLA_BACKUP||' AUX
					ON (GEE.GEE_ID = AUX.GEE_ID)
					WHEN MATCHED THEN
					UPDATE SET 
						GEE.USU_ID              = AUX.USU_ID
					,   GEE.DD_TGE_ID           = AUX.DD_TGE_ID
					,   GEE.VERSION             = AUX.VERSION
					,   GEE.USUARIOCREAR        = AUX.USUARIOCREAR
					,   GEE.FECHACREAR          = AUX.FECHACREAR
					,   GEE.USUARIOMODIFICAR    = AUX.USUARIOMODIFICAR
					,   GEE.FECHAMODIFICAR      = AUX.FECHAMODIFICAR
					,   GEE.USUARIOBORRAR       = AUX.USUARIOBORRAR
					,   GEE.FECHABORRAR         = AUX.FECHABORRAR
					,   GEE.BORRADO             = AUX.BORRADO
					WHEN NOT MATCHED THEN
					INSERT (GEE_ID,USU_ID,DD_TGE_ID,VERSION,USUARIOCREAR,FECHACREAR,USUARIOMODIFICAR,FECHAMODIFICAR,USUARIOBORRAR,FECHABORRAR,BORRADO)
					VALUES (AUX.GEE_ID,AUX.USU_ID,AUX.DD_TGE_ID,AUX.VERSION,AUX.USUARIOCREAR,AUX.FECHACREAR,AUX.USUARIOMODIFICAR,AUX.FECHAMODIFICAR,AUX.USUARIOBORRAR,AUX.FECHABORRAR,AUX.BORRADO)';
				
  		EXECUTE IMMEDIATE V_MSQL;
  		
  		DBMS_OUTPUT.PUT_LINE('	[INFO] Se ha hecho rollback de  '||SQL%ROWCOUNT||' GEE_GESTOR_ENTIDAD.'); 
  		
  		
  		
  		
  		DBMS_OUTPUT.put_line('	[INFO] Se realiza rollback sobre tabla GAH_GESTOR_ACTIVO_HISTORICO ');
		
		-- OBTENEMOS LA TABLA BACKUP
		V_MSQL := 'SELECT TABLA_BACKUP FROM '||V_ESQUEMA||'.AUX_MIG_ALQUILERES_TAB_AFEC  WHERE TABLA = ''GAH_GESTOR_ACTIVO_HISTORICO'' ';
		EXECUTE IMMEDIATE V_MSQL INTO V_TABLA_BACKUP;
		-- OBTENEMOS EL ESQUEMA TABLA BACKUP
		V_MSQL := 'SELECT TABLESPACE_NAME FROM SYS.ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA_BACKUP||''' ';
		EXECUTE IMMEDIATE V_MSQL INTO V_ESQUEMA_BACKUP;
		
		-- BORRAMOS LOS GESTORES NUEVOS GAC
		
		V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO 
					WHERE GEH_ID IN( 
								SELECT GAH.GEH_ID FROM '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
								LEFT JOIN '||V_ESQUEMA_BACKUP||'.'||V_TABLA_BACKUP||' AUX ON (GAC.GEH_ID = AUX.GEH_ID )
								WHERE AUX.GEH_ID is null
					)';
							
		EXECUTE IMMEDIATE V_MSQL;
  		
  		DBMS_OUTPUT.PUT_LINE('	[INFO] Se ha hecho rollback de  '||SQL%ROWCOUNT||' GAH_GESTOR_ACTIVO_HISTORICO.'); 
  		
  		-- ACTUALIZAMOS CON EL BACKUP
		
		V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH USING '||V_ESQUEMA_BACKUP||'.'||V_TABLA_BACKUP||' AUX
					ON (GAH.GEH_ID = AUX.GEH_ID AND GAH.ACT_ID = AUX.ACT_ID)
					WHEN NOT MATCHED THEN
					INSERT (GEH_ID,ACT_ID)
					VALUES (AUX.GEH_ID,AUX.ACT_ID)';
				
  		EXECUTE IMMEDIATE V_MSQL;
  		
  		DBMS_OUTPUT.PUT_LINE('	[INFO] Se ha hecho rollback de  '||SQL%ROWCOUNT||' GAH_GESTOR_ACTIVO_HISTORICO.'); 
		
		-- OBTENEMOS LA TABLA BACKUP
		V_MSQL := 'SELECT TABLA_BACKUP FROM '||V_ESQUEMA||'.AUX_MIG_ALQUILERES_TAB_AFEC  WHERE TABLA = ''GEH_GESTOR_ENTIDAD_HIST'' ';
		EXECUTE IMMEDIATE V_MSQL INTO V_TABLA_BACKUP;
		-- OBTENEMOS EL ESQUEMA TABLA BACKUP
		V_MSQL := 'SELECT TABLESPACE_NAME FROM SYS.ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA_BACKUP||''' ';
		EXECUTE IMMEDIATE V_MSQL INTO V_ESQUEMA_BACKUP;
		
		-- BORRAMOS LOS GESTORES NUEVOS
		
		V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST 
					WHERE GEH_ID IN(
								SELECT GEH.GEH_ID FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
								LEFT JOIN '||V_ESQUEMA_BACKUP||'.'||V_TABLA_BACKUP||' AUX ON (GEH.GEH_ID = AUX.GEH_ID )
								WHERE AUX.GEH_ID is null)';
							
		EXECUTE IMMEDIATE V_MSQL;
  		
  		DBMS_OUTPUT.PUT_LINE('	[INFO] Se ha hecho rollback de  '||SQL%ROWCOUNT||' GEH_GESTOR_ENTIDAD_HIST.'); 

		-- ACTUALIZAMOS CON EL BACKUP
		
		V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH USING '||V_ESQUEMA_BACKUP||'.'||V_TABLA_BACKUP||' AUX
					ON (GEH.GEH_ID = AUX.GEH_ID)
					WHEN MATCHED THEN
					UPDATE SET 
						GEH.USU_ID              = AUX.USU_ID
					,   GEH.DD_TGE_ID           = AUX.DD_TGE_ID
					,   GEH.VERSION             = AUX.VERSION
					,	GEH.GEH_FECHA_DESDE     = AUX.GEH_FECHA_DESDE
					,	GEH.GEH_FECHA_HASTA 	= AUX.GEH_FECHA_HASTA
					,   GEH.USUARIOCREAR        = AUX.USUARIOCREAR
					,   GEH.FECHACREAR          = AUX.FECHACREAR
					,   GEH.USUARIOMODIFICAR    = AUX.USUARIOMODIFICAR
					,   GEH.FECHAMODIFICAR      = AUX.FECHAMODIFICAR
					,   GEH.USUARIOBORRAR       = AUX.USUARIOBORRAR
					,   GEH.FECHABORRAR         = AUX.FECHABORRAR
					,   GEH.BORRADO             = AUX.BORRADO
					WHEN NOT MATCHED THEN
					INSERT (GEH_ID,USU_ID,DD_TGE_ID,GEH_FECHA_DESDE,GEH_FECHA_HASTA,VERSION,USUARIOCREAR,FECHACREAR,USUARIOMODIFICAR,FECHAMODIFICAR,USUARIOBORRAR,FECHABORRAR,BORRADO)
					VALUES (AUX.GEE_ID,AUX.USU_ID,AUX.DD_TGE_ID,AUX.GEH_FECHA_DESDE,AUX.GEH_FECHA_HASTA,AUX.VERSION,AUX.USUARIOCREAR,AUX.FECHACREAR,AUX.USUARIOMODIFICAR,AUX.FECHAMODIFICAR,AUX.USUARIOBORRAR,AUX.FECHABORRAR,AUX.BORRADO)';
				
  		EXECUTE IMMEDIATE V_MSQL;
  		
  		DBMS_OUTPUT.PUT_LINE('	[INFO] Se ha hecho rollback de  '||SQL%ROWCOUNT||' GEH_GESTOR_ENTIDAD_HIST.'); 
  		
COMMIT;
  
 DBMS_OUTPUT.put_line('[FIN] Ejecutando [ROLLBACK GESTORES ]  ...........');

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
