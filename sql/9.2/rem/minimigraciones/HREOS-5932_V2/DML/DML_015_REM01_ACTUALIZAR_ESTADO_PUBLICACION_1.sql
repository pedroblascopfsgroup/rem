--/*
--##########################################
--## AUTOR=Guillermo Llidó Parra
--## FECHA_CREACION=20190507
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-5932
--## PRODUCTO=NO
--## Finalidad: RECALCULAR ESTADO PUBLICACION PUNTO 1.
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE ON;


DECLARE
    err_num NUMBER; -- Numero de error.
    err_msg VARCHAR2(2048); -- Mensaje de error.
    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; -- Configuracion Esquemas.
    V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= 'REMMASTER'; -- Configuracion Esquemas.
    V_USUARIOMODIFICAR VARCHAR(100 CHAR):= 'HREOS-5932';
    V_MSQL VARCHAR2(4000 CHAR);
    V_MAX_PTO_ID NUMBER(16,0);
    V_EJE_ID NUMBER(16,0);
    V_COUNT NUMBER(16):= 0;
    V_COUNT2 NUMBER(16):= 0;
    HORA_INI TIMESTAMP;
    HORA_FIN TIMESTAMP;
    v_n  INTERVAL DAY TO SECOND ;
      
    
    CURSOR ESTADO_PUBLI_RECALCULAR IS SELECT ACT.ACT_ID , ACT.ACT_NUM_ACTIVO
										FROM REM01.AUX_HREOS_5932_PERIM PERIM
										INNER JOIN REM01.ACT_ACTIVO ACT ON PERIM.ACT_NUM_ACTIVO = ACT.ACT_NUM_ACTIVO
										WHERE PERIM.USUARIOMODIFICAR = 'HREOS-5932-PUNTO1' AND PERIM.FLAG_PUBLICACION = 0
										ORDER BY PERIM.ACT_NUM_ACTIVO ASC;

    									
    						
    FILA ESTADO_PUBLI_RECALCULAR%ROWTYPE;
    
BEGIN
	
    HORA_INI := SYSTIMESTAMP;
    
    DBMS_OUTPUT.put_line('[INICIO] Ejecutando actualizacion estados publicacion ...........'||HORA_INI||' ');

     V_MSQL := 'delete from  '||V_ESQUEMA||'.AUX_HREOS_5932_PERIM AUX where act_num_activo not in (62620,
			62621,
			62622,
			62689,
			62690,
			62691,
			62834,
			62835,
			62836,
			62863,
			62864,
			62872,
			62915,
			62916,
			63010,
			63011,
			63020,
			63061,
			63062,
			63100,
			63184,
			63185,
			63189,
			63208,
			63227,
			63228,
			63248,
			63324,
			63396,
			63397,
			63398,
			63399,
			63404,
			63686,
			63950,
			64028,
			64486,
			64531,
			64588,
			64595,
			64601,
			64602,
			64747,
			64748,
			64755,
			64756,
			64757,
			64766,
			64767,
			64928,
			64935,
			64936,
			64946,
			65186,
			65187,
			65188,
			65327,
			65328,
			65329,
			65330,
			65340,
			65341,
			65342,
			65346,
			65347,
			65348,
			65387,
			65423,
			65516,
			65517,
			65525,
			65526,
			65615,
			65616,
			65617,
			65646,
			65715,
			65718,
			65882,
			65883,
			65886,
			65887,
			65902,
			66054,
			66055,
			66080,
			67046,
			68753,
			68777,
			68844,
			68845,
			68963,
			69033,
			69086,
			69244,
			69245,
			69287,
			69341,
			69363,
			69408,
			69409,
			69458,
			69709,
			70148,
			70167,
			70235,
			70423,
			70436,
			70532,
			70533,
			70535,
			70576,
			70631,
			70716,
			70742,
			70795,
			70796,
			70906,
			70956,
			71158,
			71180,
			71310,
			71311,
			71449,
			71502,
			71675,
			71718,
			71735,
			71827,
			72089,
			72392,
			72399,
			72454,
			72455,
			72456,
			72838,
			73294,
			73617,
			73847,
			74965,
			75335,
			75568,
			75646,
			75647,
			76756,
			76950,
			76954,
			76955,
			76956,
			76957,
			76958,
			76959,
			76992,
			76993,
			76994,
			76995,
			76996,
			77049,
			77050,
			77051,
			77116,
			77138,
			77160,
			77161,
			77208,
			77289,
			77383,
			77555,
			77683,
			77686,
			78345,
			78347,
			78448,
			78464,
			78465,
			78466,
			78467,
			78490,
			78559,
			78560,
			78561,
			78562,
			78563,
			78564,
			78565,
			78613,
			78614,
			78615,
			78616,
			78694,
			78986,
			79039,
			79040,
			79041,
			79115,
			79216,
			79337,
			79338,
			79426,
			79477,
			79703,
			79960,
			80234,
			80235,
			80236,
			80237,
			80648,
			80649,
			80650,
			80651,
			80652,
			80653,
			80726,
			80727,
			80799,
			80956,
			81082,
			81107,
			81226,
			82074,
			82091,
			82092,
			82093,
			82094,
			82095,
			82096,
			82097,
			82113,
			82128,
			82129,
			82130,
			82131,
			82132,
			82133,
			82134,
			82271,
			82411,
			82412,
			82413,
			82430,
			82431,
			82432,
			82433,
			82445,
			82464,
			82622,
			82724,
			82725,
			82726,
			82727,
			82728,
			82729,
			83403,
			83590,
			84036,
			84137,
			84156,
			84157,
			84364,
			84642,
			84706,
			84707,
			84891,
			84892,
			84963,
			85013,
			85014,
			85015,
			85017,
			85071,
			85072,
			85073,
			85074,
			85075,
			85076,
			85161,
			85162,
			85163,
			85164,
			85283,
			85298,
			85299,
			85300,
			85301,
			85302,
			85303,
			85304,
			85305,
			85306,
			85399,
			85400,
			85401,
			85437,
			85438,
			85453,
			85454,
			85455,
			85546,
			85547,
			85548,
			85549,
			85565,
			85566,
			85567,
			85568,
			85990,
			85991,
			85992,
			86210,
			86222,
			87640,
			87918,
			87942,
			88319,
			88911,
			88912,
			88922,
			88923,
			88941,
			89094,
			89095,
			89096,
			90591,
			90635,
			90829,
			90830,
			90845,
			90846,
			90847,
			90849,
			91086,
			91291,
			91292,
			91294,
			91295,
			91317,
			91322,
			91391,
			91445,
			91467,
			91468,
			91469,
			91514,
			91515,
			91516,
			91517,
			91518,
			91519,
			91520,
			91521,
			91606,
			91607,
			91608,
			91609,
			91625,
			91626,
			91627,
			91628,
			91874,
			91875,
			91876,
			91877,
			91878,
			91971,
			91972,
			92290,
			92396,
			92483,
			92484,
			92485,
			92542,
			92543,
			92693,
			92712,
			92713,
			92714,
			92818,
			92819,
			92838,
			92840,
			92863,
			92966,
			92967,
			92968,
			92969,
			93084,
			93108,
			93109,
			93110,
			93408,
			93709,
			93998,
			94112,
			94113,
			94114,
			94116,
			94117,
			94299,
			94301,
			94305,
			94306,
			94307,
			94308,
			94309,
			94310,
			94311,
			94419,
			94420,
			94422,
			94426,
			94427,
			94428,
			94429,
			94430,
			94647,
			94694,
			94698,
			94699,
			94700,
			94821,
			94822,
			94823,
			94824,
			94880,
			94949,
			94964,
			94990,
			95061,
			95214,
			95215,
			95236,
			95349,
			95439,
			95440,
			95550,
			95551,
			95552,
			95587,
			95630,
			95655,
			95704,
			95834,
			95890,
			95891,
			95913,
			95914,
			95935,
			95957,
			96434,
			96509,
			96559,
			96766,
			96829,
			96830,
			97224,
			97307,
			97320,
			97331,
			97332,
			97817,
			97884,
			97893,
			97894,
			97895,
			97896,
			98058,
			98399,
			98400,
			98431,
			98437,
			98438,
			98439,
			98440,
			98441,
			98442,
			98467,
			98486,
			98487,
			98530,
			98532,
			98539,
			98540,
			98541,
			98542,
			98543,
			98544,
			98560,
			98619,
			98625,
			98626,
			98672,
			98675,
			98676,
			98677,
			98678,
			98679,
			98680,
			98853,
			98855,
			98889)';

		EXECUTE IMMEDIATE V_MSQL; 


	OPEN ESTADO_PUBLI_RECALCULAR;
	
	V_COUNT := 0;
	V_COUNT2 := 0;
		
	LOOP
  		FETCH ESTADO_PUBLI_RECALCULAR INTO FILA;
  		EXIT WHEN ESTADO_PUBLI_RECALCULAR%NOTFOUND;
  				
  		REM01.SP_CAMBIO_ESTADO_PUBLICACION (FILA.ACT_ID,1,''||V_USUARIOMODIFICAR||'');
  		
  		V_MSQL := 'UPDATE '||V_ESQUEMA||'.AUX_HREOS_5932_PERIM SET FLAG_PUBLICACION = 1 WHERE ACT_NUM_ACTIVO = '||FILA.ACT_NUM_ACTIVO||'';
        
  		EXECUTE IMMEDIATE V_MSQL; 				
  		  		
  		V_COUNT := V_COUNT + 1 ;
        V_COUNT2 := V_COUNT2 +1 ;
        
        IF V_COUNT2 = 100 THEN
            
            COMMIT;
            
            DBMS_OUTPUT.PUT_LINE('	[INFO] Se actualizan '||V_COUNT2||' activos ');
            V_COUNT2 := 0;
            
        END IF;
  		
	END LOOP;
	
    DBMS_OUTPUT.PUT_LINE('	[INFO] Se actualizan '||V_COUNT2||' activos ');
    
    DBMS_OUTPUT.PUT_LINE('	[INFO] Se han RECALCULADO '||V_COUNT||' ESTADOS DE PUBLICACION ');
    
	CLOSE ESTADO_PUBLI_RECALCULAR;
	
    HORA_FIN := SYSTIMESTAMP;
    
    DBMS_OUTPUT.PUT_LINE('[FIN] Ha finalizado la ejecución ');
    
    v_n := HORA_FIN - HORA_INI;
    
    DBMS_OUTPUT.PUT_LINE('[FIN] Duración la ejecución................'||EXTRACT( SECOND FROM v_n)||' segundos ');
      
  COMMIT;
  

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
