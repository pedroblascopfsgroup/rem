--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20171219
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.10
--## INCIDENCIA_LINK=HREOS-3457
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01'; --REM01
    V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER'; --REMMASTER
    V_USUARIO VARCHAR2(50 CHAR) := 'HREOS-3457';
    V_TABLA VARCHAR2(40 CHAR) := 'OFR_OFERTAS';
    V_TABLA_MIG VARCHAR2(40 CHAR) := 'AUX_RECARGA_OFI_TRAMITACION';
    V_SENTENCIA VARCHAR2(2000 CHAR);

BEGIN

    DBMS_OUTPUT.PUT_LINE('[INICIO]');
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE ACTUALIZACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
    
    EXECUTE IMMEDIATE 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
        USING (SELECT OFR.OFR_ID, PVE.PVE_ID, ROW_NUMBER() OVER(PARTITION BY OFR.OFR_ID ORDER BY PVE.PVE_ID) RN
            FROM '||V_ESQUEMA||'.AUX_RECARGA_OFI_TRAMITACION AUX
            JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_NUM_OFERTA = AUX.OFR_COD_OFERTA
            JOIN '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR PVE ON PVE.PVE_COD_UVEM = TO_CHAR(AUX.OFR_OFICINA_TRAMITACION)) T2
        ON (T1.OFR_ID = T2.OFR_ID AND T2.RN = 1)
        WHEN MATCHED THEN UPDATE SET
            T1.PVE_ID_SUCURSAL = T2.PVE_ID, T1.USUARIOMODIFICAR = '''||V_USUARIO||''', T1.FECHAMODIFICAR = SYSDATE
        WHERE T1.PVE_ID_SUCURSAL <> T2.PVE_ID OR T1.PVE_ID_SUCURSAL IS NULL';
    DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado '||SQL%ROWCOUNT||' filas en OFR_OFERTAS (PVE_ID_SUCURSAL).');

    DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT;