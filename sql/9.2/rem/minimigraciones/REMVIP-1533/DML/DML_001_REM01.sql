--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20180714
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=?
--## INCIDENCIA_LINK=REMVIP-1533
--## PRODUCTO=NO
--## 
--## Finalidad: 
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

	V_TABLA VARCHAR2(30 CHAR) := 'AUX_CARGA_CARGAS'; -- Variable para tabla de salida para el borrado
	V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_SQL VARCHAR2(4000 CHAR);
	PL_OUTPUT VARCHAR2(32000 CHAR);
	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-1533';

BEGIN
	
	PL_OUTPUT := '[INICIO]'||CHR(10);

/*
	V_SQL := 'INSERT INTO REM01.BIE_CAR_CARGAS (
				  BIE_ID
				, BIE_CAR_ID
				, DD_TPC_ID
				, BIE_CAR_TITULAR
				, BIE_CAR_IMPORTE_REGISTRAL
				, DD_SIC_ID
				, USUARIOCREAR
				, FECHACREAR
			) SELECT
				  ACT.BIE_ID
				, REM01.S_BIE_CAR_CARGAS.NEXTVAL
				, 3
				, AUX.BIE_CAR_TITULAR
				, AUX.BIE_CAR_IMPORTE_REGISTRAL
				, SIC.DD_SIC_ID
				, '''||V_USUARIO||'''
				, SYSDATE
			FROM REM01.'||V_TABLA||' AUX
			JOIN REM01.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO_PRINEX = AUX.ACT_NUM_ACTIVO_PRINEX AND ACT.DD_CRA_ID = 43
			JOIN REM01.DD_SIC_SITUACION_CARGA SIC ON SIC.DD_SIC_DESCRIPCION = AUX.SITUACION_CARGA
	';
	*/
	
	V_SQL := 'MERGE INTO REM01.BIE_CAR_CARGAS T1 USING (
				SELECT ACT.BIE_ID, AUX.BIE_CAR_TITULAR, AUX.BIE_CAR_IMPORTE_REGISTRAL, SIC.DD_SIC_ID
				FROM REM01.'||V_TABLA||' AUX
				JOIN REM01.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO_PRINEX = AUX.ACT_NUM_ACTIVO_PRINEX AND ACT.DD_CRA_ID = 43
				JOIN REM01.DD_SIC_SITUACION_CARGA SIC ON SIC.DD_SIC_DESCRIPCION = AUX.SITUACION_CARGA
			) T2 ON (T1.BIE_ID = T2.BIE_ID)
			WHEN MATCHED THEN UPDATE SET
				  T1.BIE_CAR_TITULAR = T2.BIE_CAR_TITULAR
				, T1.BIE_CAR_IMPORTE_REGISTRAL = T2.BIE_CAR_IMPORTE_REGISTRAL
				, T1.DD_SIC_ID = T2.DD_SIC_ID
				, T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
				, T1.FECHAMODIFICAR = SYSDATE
		';
	
	EXECUTE IMMEDIATE V_SQL;
	
	PL_OUTPUT := PL_OUTPUT || '[INFO] Se han updateado '||SQL%ROWCOUNT||' cargas en la BIE_CAR_CARGAS.' || CHR(10);


/*
	V_SQL := 'INSERT INTO REM01.ACT_CRG_CARGAS (
				  CRG_ID
				, ACT_ID
				, BIE_CAR_ID
				, DD_TCA_ID
				, DD_STC_ID
				, CRG_DESCRIPCION
				, USUARIOCREAR
				, FECHACREAR
			) SELECT
				  REM01.S_ACT_CRG_CARGAS.NEXTVAL
				, ACT.ACT_ID
				, BIE.BIE_CAR_ID
				, TCA.DD_TCA_ID
				, STC.DD_STC_ID
				, AUX.CRG_DESCRIPCION
				, '''||V_USUARIO||'''
				, SYSDATE
			FROM REM01.'||V_TABLA||' AUX
			JOIN REM01.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO_PRINEX = AUX.ACT_NUM_ACTIVO_PRINEX AND ACT.DD_CRA_ID = 43
			JOIN REM01.BIE_CAR_CARGAS BIE ON BIE.BIE_ID = ACT.BIE_ID
			JOIN REM01.DD_TCA_TIPO_CARGA TCA ON TCA.DD_TCA_DESCRIPCION = AUX.TIPO_CARGA
			JOIN REM01.DD_STC_SUBTIPO_CARGA STC ON STC.DD_STC_DESCRIPCION = AUX.SUBTIPO_CARGA AND STC.DD_STC_CODIGO <> ''08''
	';
	*/
	
	
	V_SQL := 'MERGE INTO REM01.ACT_CRG_CARGAS T1 USING (
				SELECT ACT.ACT_ID, TCA.DD_TCA_ID, STC.DD_STC_ID, AUX.CRG_DESCRIPCION
				FROM REM01.'||V_TABLA||' AUX
				JOIN REM01.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO_PRINEX = AUX.ACT_NUM_ACTIVO_PRINEX AND ACT.DD_CRA_ID = 43
				JOIN REM01.BIE_CAR_CARGAS BIE ON BIE.BIE_ID = ACT.BIE_ID
				JOIN REM01.DD_TCA_TIPO_CARGA TCA ON TCA.DD_TCA_DESCRIPCION = AUX.TIPO_CARGA
				JOIN REM01.DD_STC_SUBTIPO_CARGA STC ON STC.DD_STC_DESCRIPCION = AUX.SUBTIPO_CARGA AND STC.DD_STC_CODIGO <> ''08''
			) T2 ON (T1.ACT_ID = T2.ACT_ID)
			WHEN MATCHED THEN UPDATE SET
				  T1.DD_TCA_ID = T2.DD_TCA_ID
				, T1.DD_STC_ID = T2.DD_TCA_ID
				, T1.CRG_DESCRIPCION = T2.CRG_DESCRIPCION
				, T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
				, T1.FECHAMODIFICAR = SYSDATE
		';
	
	EXECUTE IMMEDIATE V_SQL;


	COMMIT;

	PL_OUTPUT := PL_OUTPUT || '[FIN]'||CHR(10);
	DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);

EXCEPTION
    WHEN OTHERS THEN
      PL_OUTPUT := PL_OUTPUT ||'[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE)||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||'-----------------------------------------------------------'||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||SQLERRM||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||V_SQL||CHR(10);
      DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
