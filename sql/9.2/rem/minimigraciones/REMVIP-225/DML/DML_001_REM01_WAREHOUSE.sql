--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20180302
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.15
--## INCIDENCIA_LINK=REMVIP-225
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
    V_ESQUEMA_M VARCHAR2(10 CHAR) := 'REMMASTER';
    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-225';

BEGIN

    DBMS_OUTPUT.PUT_LINE('[INICIO]');
	EXECUTE IMMEDIATE 'MERGE INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD T1
		USING (
		    SELECT ACT_ID, GEE_ID, USU_ID, DD_TGE_ID 
		    FROM (
		        SELECT GAC.ACT_ID, GEE.GEE_ID, USU.USU_ID, TGE.DD_TGE_ID
		            , ROW_NUMBER() OVER(PARTITION BY ACT.ACT_ID ORDER BY TGE1.DD_TGE_ID NULLS LAST) RN
		        FROM '||V_ESQUEMA||'.AUX_GCOM AUX
		        JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = AUX.ACT
		        JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON USU.USU_USERNAME = AUX.USU
		        JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_CODIGO = AUX.TGE
		        LEFT JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GAC.ACT_ID = ACT.ACT_ID
		        LEFT JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID AND GEE.DD_TGE_ID = TGE.DD_TGE_ID
		        LEFT JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE1 ON TGE1.DD_TGE_ID = GEE.DD_TGE_ID)
		    WHERE RN = 1) T2
		ON (T1.GEE_ID = T2.GEE_ID)
		WHEN MATCHED THEN UPDATE SET
		    T1.USU_ID = T2.USU_ID, T1.USUARIOMODIFICAR = '''||V_USUARIO||''', T1.FECHAMODIFICAR = SYSDATE
		WHEN NOT MATCHED THEN INSERT (T1.GEE_ID, T1.USU_ID, T1.DD_TGE_ID, T1.USUARIOCREAR, T1.FECHACREAR, T1.USUARIOMODIFICAR)
		    VALUES ('||V_ESQUEMA||'.S_GEE_GESTOR_ENTIDAD.NEXTVAL, T2.USU_ID, T2.DD_TGE_ID, '''||V_USUARIO||''', SYSDATE, T2.ACT_ID)';
	DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||SQL%ROWCOUNT||' gestores entidad fusionados.');
    
	EXECUTE IMMEDIATE 'INSERT INTO GAC_GESTOR_ADD_ACTIVO (GEE_ID, ACT_ID)
		SELECT GEE_ID, TO_NUMBER(USUARIOMODIFICAR)
		FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD
		WHERE USUARIOCREAR = '''||V_USUARIO||''' AND TRUNC(FECHACREAR) = TRUNC(SYSDATE)';
	DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||SQL%ROWCOUNT||' gestores activos insertados.');

	EXECUTE IMMEDIATE 'MERGE INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST T1
		USING (
		    SELECT GAH.ACT_ID, USU.USU_ID, TGE.DD_TGE_ID, GEH.GEH_ID
		    FROM '||V_ESQUEMA||'.AUX_GCOM AUX
		    JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = AUX.ACT
		    JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON USU.USU_USERNAME = AUX.USU
		    JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_CODIGO = AUX.TGE
		    JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH ON GAH.ACT_ID = ACT.ACT_ID
		    JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH ON GEH.GEH_ID = GAH.GEH_ID AND GEH.DD_TGE_ID = TGE.DD_TGE_ID
		    JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE1 ON TGE1.DD_TGE_ID = GEH.DD_TGE_ID
		    WHERE GEH.GEH_FECHA_HASTA IS NULL AND USU.USU_ID <> GEH.USU_ID) T2
		ON (T1.GEH_ID = T2.GEH_ID)
		WHEN MATCHED THEN UPDATE SET
		    T1.GEH_FECHA_HASTA = SYSDATE, T1.USUARIOMODIFICAR = '''||V_USUARIO||''', T1.FECHAMODIFICAR = SYSDATE';
	DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||SQL%ROWCOUNT||' gestores entidad históricos actualizados.');
	    
	EXECUTE IMMEDIATE 'INSERT INTO GEH_GESTOR_ENTIDAD_HIST (GEH_ID, USU_ID, DD_TGE_ID
		    , GEH_FECHA_DESDE, USUARIOCREAR, FECHACREAR, USUARIOMODIFICAR)
		SELECT '||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL, USU.USU_ID, TGE.DD_TGE_ID
		    , SYSDATE, '''||V_USUARIO||''', SYSDATE, ACT.ACT_ID
		FROM '||V_ESQUEMA||'.AUX_GCOM AUX
		JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = AUX.ACT
		JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON USU.USU_USERNAME = AUX.USU
		JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_CODIGO = AUX.TGE
		WHERE NOT EXISTS (SELECT 1
		    FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
		    JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH ON GAH.GEH_ID = GEH.GEH_ID
		    WHERE GEH.GEH_FECHA_HASTA IS NULL AND TGE.DD_TGE_ID = GEH.DD_TGE_ID
		        AND ACT.ACT_ID = GAH.ACT_ID)';
	DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||SQL%ROWCOUNT||' gestores entidad históricos insertados.');
	    
	EXECUTE IMMEDIATE 'INSERT INTO GAH_GESTOR_ACTIVO_HISTORICO (GEH_ID, ACT_ID)
		SELECT GEH_ID, TO_NUMBER(USUARIOMODIFICAR)
		FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST
		WHERE USUARIOCREAR = '''||V_USUARIO||''' AND TRUNC(FECHACREAR) = TRUNC(SYSDATE)';
    DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||SQL%ROWCOUNT||' gestores activos históricos insertados.');

    DBMS_OUTPUT.PUT_LINE('[FIN]');

    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT;
