--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20180313
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.15
--## INCIDENCIA_LINK=REMVIP-282
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
    V_ESQUEMA_M VARCHAR2(10 CHAR) := 'REMMASTER';
    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-282';

BEGIN

    DBMS_OUTPUT.PUT_LINE('[INICIO]');
	EXECUTE IMMEDIATE 'MERGE INTO '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION T1
		USING (SELECT PUB.HEP_ID
		    FROM '||V_ESQUEMA||'.AUX_OCULTACION AUX
		    JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = AUX.ACT
		    JOIN '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION PUB ON PUB.ACT_ID = ACT.ACT_ID
		        AND PUB.HEP_FECHA_HASTA IS NULL) T2
		ON (T1.HEP_ID = T2.HEP_ID)
		WHEN MATCHED THEN UPDATE SET
		    T1.HEP_FECHA_HASTA = SYSDATE
		    , T1.USUARIOMODIFICAR = '''||V_USUARIO||''', T1.FECHAMODIFICAR = SYSDATE';
	DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||SQL%ROWCOUNT||' registros históricos de publicación actualizados.');

	EXECUTE IMMEDIATE 'INSERT INTO '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION (HEP_ID, ACT_ID, HEP_FECHA_DESDE, DD_POR_ID, DD_TPU_ID
		    , DD_EPU_ID, HEP_MOTIVO, USUARIOCREAR, FECHACREAR)
		SELECT '||V_ESQUEMA||'.S_ACT_HEP_HIST_EST_PUBLICACION.NEXTVAL, ACT_ID, SYSDATE, DD_POR_ID, DD_TPU_ID
		    , (SELECT DD_EPU_ID FROM '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION EPU WHERE EPU.DD_EPU_CODIGO = ''03'')
		    , ''Petición HAYA'', '''||V_USUARIO||''', SYSDATE
		FROM (
		    SELECT HEP.ACT_ID, HEP.DD_POR_ID, HEP.DD_TPU_ID
		        , ROW_NUMBER() OVER(PARTITION BY HEP.ACT_ID ORDER BY HEP.HEP_FECHA_HASTA DESC, HEP.FECHACREAR DESC) RN
		    FROM '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION HEP
		    WHERE USUARIOMODIFICAR = '''||V_USUARIO||'''
		    UNION
		    SELECT ACT.ACT_ID, NULL, NULL, 1
		    FROM '||V_ESQUEMA||'.AUX_OCULTACION AUX
		    JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = AUX.ACT
		    LEFT JOIN '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION PUB ON PUB.ACT_ID = ACT.ACT_ID
		    WHERE PUB.HEP_ID IS NULL)
		WHERE RN = 1';
	DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||SQL%ROWCOUNT||' registros históricos de publicación insertados.');

	EXECUTE IMMEDIATE 'MERGE INTO '||V_ESQUEMA||'.ACT_ACTIVO T1
		USING '||V_ESQUEMA||'.AUX_OCULTACION T2
		ON (T1.ACT_NUM_ACTIVO = T2.ACT)
		WHEN MATCHED THEN UPDATE SET
			T1.DD_EPU_ID = (SELECT DD_EPU_ID FROM '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION EPU WHERE EPU.DD_EPU_CODIGO = ''03'')
			, T1.USUARIOMODIFICAR = '''||V_USUARIO||''', T1.FECHAMODIFICAR = SYSDATE';
	DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||SQL%ROWCOUNT||' estado de publicación en el activo actualizados.');

    DBMS_OUTPUT.PUT_LINE('[FIN]');
    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT;
