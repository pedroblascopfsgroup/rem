--/*
--##########################################
--## AUTOR=Adrián Molina
--## FECHA_CREACION=20190620
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-4592
--## PRODUCTO=NO
--## Finalidad: Vista para la búsqueda de agrupaciones.
--##  
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial.
--##		0.2 No contar publicados oculto.
--##		0.3 Modificación.
--##		0.4 Corrección activos publicados.
--##		0.5 Nuevo campo en select
--##		0.6 Nuevo campo en select (código e id del tipo de alquiler)
--##		0.7 Corrección activos publicados (módulo publicaciones)
--##		0.8 Borrada vista duplicada
--##        0.9 Se modifica vista para que el AM no sea considerado activo en agrupaciones PA
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(1); -- Vble. para validar la existencia de las Tablas.
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- Numero de errores.
    err_msg VARCHAR2(2048); -- Mensaje de error.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas.
    V_MSQL VARCHAR2(4000 CHAR);


BEGIN

	SELECT COUNT(*) INTO table_count FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_AGRUPACIONES' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';
	IF table_count > 0 THEN
		DBMS_OUTPUT.PUT('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES...');
		EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_AGRUPACIONES';
		DBMS_OUTPUT.PUT_LINE('OK'); 
	END IF;

	SELECT COUNT(*) INTO table_count FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_AGRUPACIONES' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';
	IF table_count > 0 THEN
		DBMS_OUTPUT.PUT('DROP VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES...');
		EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_AGRUPACIONES';
		DBMS_OUTPUT.PUT_LINE('OK');
	END IF;

	DBMS_OUTPUT.PUT('CREATE VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES...');
	EXECUTE IMMEDIATE 'CREATE VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES
		AS SELECT
		      AGR.AGR_ID,
		      AGR.DD_TAG_ID,
		      AGR.AGR_NUM_AGRUP_REM,
		      AGR.AGR_NUM_AGRUP_UVEM,
		      AGR.AGR_NOMBRE,
		      AGR.AGR_DESCRIPCION,
		      AGR.AGR_FECHA_ALTA,
		      AGR.AGR_FECHA_BAJA,
		      AGR.AGR_INI_VIGENCIA,
		      AGR.AGR_FIN_VIGENCIA,
		      AGR.AGR_PUBLICADO,
		      NVL(AGR_P.ACTIVOS,0) AS ACTIVOS,
		      NVL(AGR_P.PUBLICADOS,0) AS PUBLICADOS,
		      COALESCE (OBR.DD_PRV_ID, RES.DD_PRV_ID, LCO.DD_PRV_ID, ASI.DD_PRV_ID, PRY.DD_PRV_ID) AS PROVINCIA,
		      COALESCE (OBR.DD_LOC_ID, RES.DD_LOC_ID, LCO.DD_LOC_ID, ASI.DD_LOC_ID, PRY.DD_LOC_ID) AS LOCALIDAD,
		      COALESCE (OBR.ONV_DIRECCION, RES.RES_DIRECCION, LCO.LCO_DIRECCION, ASI.ASI_DIRECCION, PRY.PRY_DIRECCION) AS DIRECCION,
		      AGR_P.DD_CRA_CODIGO CARTERA,
		      AGR.AGR_IS_FORMALIZACION,
			  ALQ.DD_TAL_ID AS IDTIPOALQUILER,
			  ALQ.DD_TAL_CODIGO AS CODTIPOALQUILER
		    FROM '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR
		    JOIN '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION TAG ON TAG.DD_TAG_ID = AGR.DD_TAG_ID AND TAG.BORRADO = 0
		    LEFT JOIN
		      (SELECT SUM (CASE WHEN TAGA.DD_TAG_CODIGO = ''16'' AND AGA.AGA_PRINCIPAL = 1 then 0 else 1 end) ACTIVOS,
			    SUM (CASE
		      WHEN (EPA.DD_EPA_CODIGO = ''03'' AND (TAGA.DD_TAG_CODIGO <> ''16'')) OR (EPV.DD_EPV_CODIGO = ''03''  AND (TAGA.DD_TAG_CODIGO <> ''16''))
			  OR (EPA.DD_EPA_CODIGO = ''03'' AND (TAGA.DD_TAG_CODIGO = ''16'' AND AGA.AGA_PRINCIPAL = 0)) OR (EPV.DD_EPV_CODIGO = ''03''  AND (TAGA.DD_TAG_CODIGO = ''16'' AND AGA.AGA_PRINCIPAL = 0))
		      THEN 1
		      ELSE 0
		      END) PUBLICADOS,
		      AGA.AGR_ID,
		      CRA.DD_CRA_CODIGO
		      FROM '|| V_ESQUEMA ||'.ACT_AGA_AGRUPACION_ACTIVO AGA
			  JOIN '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGRU ON AGRU.AGR_ID = AGA.AGR_ID AND AGRU.BORRADO = 0  
              JOIN '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION TAGA ON TAGA.DD_TAG_ID = AGRU.DD_TAG_ID AND TAGA.BORRADO = 0
		      LEFT JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AGA.ACT_ID AND ACT.BORRADO = 0
			    LEFT JOIN '|| V_ESQUEMA ||'.ACT_APU_ACTIVO_PUBLICACION ACT_APU ON ACT_APU.ACT_ID = AGA.ACT_ID AND ACT_APU.BORRADO = 0
			    LEFT JOIN '|| V_ESQUEMA ||'.DD_EPA_ESTADO_PUB_ALQUILER EPA ON ACT_APU.DD_EPA_ID = EPA.DD_EPA_ID AND EPA.BORRADO = 0
			    LEFT JOIN '|| V_ESQUEMA ||'.DD_EPV_ESTADO_PUB_VENTA EPV ON ACT_APU.DD_EPV_ID = EPV.DD_EPV_ID AND EPV.BORRADO = 0
		      LEFT JOIN '|| V_ESQUEMA ||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
		      WHERE AGA.BORRADO = 0
		      GROUP BY AGA.AGR_ID, CRA.DD_CRA_CODIGO) AGR_P ON AGR_P.AGR_ID = AGR.AGR_ID
		    LEFT JOIN '|| V_ESQUEMA ||'.ACT_ONV_OBRA_NUEVA OBR ON AGR.AGR_ID = OBR.AGR_ID
		    LEFT JOIN '|| V_ESQUEMA ||'.ACT_RES_RESTRINGIDA RES ON AGR.AGR_ID = RES.AGR_ID
		    LEFT JOIN '|| V_ESQUEMA ||'.ACT_LCO_LOTE_COMERCIAL LCO ON AGR.AGR_ID = LCO.AGR_ID
		    LEFT JOIN '|| V_ESQUEMA ||'.ACT_ASI_ASISTIDA ASI ON AGR.AGR_ID = ASI.AGR_ID
		    LEFT JOIN '|| V_ESQUEMA ||'.DD_TAL_TIPO_ALQUILER ALQ ON (AGR.DD_TAL_ID = ALQ.DD_TAL_ID)
			LEFT JOIN '|| V_ESQUEMA ||'.ACT_PRY_PROYECTO PRY ON (AGR.AGR_ID = PRY.AGR_ID)
		    WHERE AGR.BORRADO = 0';

	SELECT COUNT(*) INTO table_count FROM ALL_OBJECTS WHERE OBJECT_NAME = 'ACT_AGA_IDX1' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='INDEX';  
	IF table_count > 0 THEN
		EXECUTE IMMEDIATE 'DROP INDEX ' || V_ESQUEMA || '.ACT_AGA_IDX1';  
	END IF;

	EXECUTE IMMEDIATE 'CREATE UNIQUE INDEX ' || V_ESQUEMA || '.ACT_AGA_IDX1 ON ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO (AGA_ID, AGR_ID, ACT_ID, BORRADO) LOGGING NOPARALLEL';

	SELECT COUNT(*) INTO table_count FROM ALL_OBJECTS WHERE OBJECT_NAME = 'ACT_ACTIVO_IDX3' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='INDEX';  
	IF table_count > 0 THEN
		EXECUTE IMMEDIATE 'DROP INDEX ' || V_ESQUEMA || '.ACT_ACTIVO_IDX3';  
	END IF;

	EXECUTE IMMEDIATE 'CREATE UNIQUE INDEX ' || V_ESQUEMA || '.ACT_ACTIVO_IDX3 ON ' || V_ESQUEMA || '.ACT_ACTIVO (ACT_ID, DD_CRA_ID, DD_EPU_ID, BORRADO) LOGGING NOPARALLEL';

	DBMS_OUTPUT.PUT_LINE('OK');

END;
/
EXIT;
