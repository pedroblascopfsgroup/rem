 
--/*
--##########################################
--## AUTOR=DANIEL GUTIÉRREZ
--## FECHA_CREACION=20170104
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=0
--## PRODUCTO=NO
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.    
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- N?mero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas
    V_MSQL VARCHAR2(4000 CHAR); 

    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_ACTIVOS_PRECIOS' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS_PRECIOS...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_ACTIVOS_PRECIOS';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS_PRECIOS... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_ACTIVOS_PRECIOS' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS_PRECIOS...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_ACTIVOS_PRECIOS';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS_PRECIOS... borrada OK');
  END IF;

  
  
  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS_PRECIOS...');
  EXECUTE IMMEDIATE 'CREATE VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_ACTIVOS_PRECIOS 
	AS
  SELECT
    ACT.ACT_ID,
    ACT.ACT_NUM_ACTIVO,
    TPA.DD_TPA_CODIGO AS TIPO_ACTIVO_CODIGO,
    TPA.DD_TPA_DESCRIPCION AS TIPO_ACTIVO_DESCRIPCION,
    SAC.DD_SAC_CODIGO AS SUBTIPO_ACTIVO_CODIGO,
    SAC.DD_SAC_DESCRIPCION AS SUBTIPO_ACTIVO_DESCRIPCION,
    CRA.DD_CRA_CODIGO AS ENTIDAD_CODIGO,
    CRA.DD_CRA_DESCRIPCION AS ENTIDAD_DESCRIPCION,
	SCR.DD_SCR_CODIGO AS SUBCARTERA_CODIGO,
	SCR.DD_SCR_DESCRIPCION AS SUBCARTERA_DESCRIPCION,
    TTA.DD_TTA_CODIGO AS TIPO_TITULO_CODIGO,
    TTA.DD_TTA_DESCRIPCION AS TIPO_TITULO_DESCRIPCION,
    STA.DD_STA_CODIGO AS SUBTIPO_TITULO_CODIGO,
    STA.DD_STA_DESCRIPCION AS SUBTIPO_TITULO_DESCRIPCION,
    NVL2(TIT.TIT_FECHA_INSC_REG, ''1'',''0'') AS INSCRITO,
    NVL2(ACT_SIT.SPS_FECHA_TOMA_POSESION, ''1'',''0'') AS CON_POSESION,
    NVL2(ACT.ACT_FECHA_REV_CARGAS, ''1'',''0'') AS CON_FECHA_REVISION_CARGAS,
    NVL2(ICO.ICO_MEDIADOR_ID,''1'',''0'')  AS TIENE_MEDIADOR,
    NVL2(ICO.ICO_FECHA_EMISION_INFORME, '''', NVL2(ICO.ICO_FECHA_ACEPTACION, ''01'', ''02'')) AS ESTADO_INF_COMERCIAL,
    NVL2((SELECT TAS1.TAS_ID ACTIVO_TAS FROM ' || V_ESQUEMA || '.ACT_TAS_TASACION TAS1 WHERE TAS1.ACT_ID = ACT.ACT_ID AND ROWNUM = 1),''0'',''1'') AS CON_TASACION,
    (SELECT PRV1.DD_PRV_CODIGO FROM ' || V_ESQUEMA_MASTER || '.DD_PRV_PROVINCIA PRV1 WHERE PRV1.DD_PRV_ID = BIE_LOC.DD_PRV_ID AND ROWNUM = 1) AS PROVINCIA_CODIGO,
    (SELECT PRV1.DD_PRV_CODIGO FROM ' || V_ESQUEMA_MASTER || '.DD_PRV_PROVINCIA PRV1 WHERE PRV1.DD_PRV_ID = BIE_LOC.DD_PRV_ID AND ROWNUM = 1) AS PROVINCIA_DESCRIPCION,
    (SELECT LOC1.DD_LOC_CODIGO FROM ' || V_ESQUEMA_MASTER || '.DD_LOC_LOCALIDAD LOC1 WHERE LOC1.DD_LOC_ID = BIE_LOC.DD_LOC_ID AND ROWNUM = 1) AS LOCALIDAD_CODIGO,
    (SELECT LOC1.DD_LOC_DESCRIPCION FROM ' || V_ESQUEMA_MASTER || '.DD_LOC_LOCALIDAD LOC1 WHERE LOC1.DD_LOC_ID = BIE_LOC.DD_LOC_ID AND ROWNUM = 1) AS LOCALIDAD_DESCRIPCION,
    BIE_LOC.BIE_LOC_COD_POST AS CODIGO_POSTAL,
    (SELECT TPVIA1.DD_TVI_DESCRIPCION FROM ' || V_ESQUEMA_MASTER || '.DD_TVI_TIPO_VIA TPVIA1 WHERE TPVIA1.DD_TVI_ID = BIE_LOC.DD_TVI_ID AND ROWNUM = 1) || '' '' ||
    BIE_LOC.BIE_LOC_NOMBRE_VIA || '' ''|| BIE_LOC.BIE_LOC_NUMERO_DOMICILIO || '' ''||  BIE_LOC.BIE_LOC_PUERTA AS DIRECCION,
    (SELECT VAL1.VAL_IMPORTE
      FROM ' || V_ESQUEMA || '.ACT_VAL_VALORACIONES VAL1
      INNER JOIN ' || V_ESQUEMA || '.DD_TPC_TIPO_PRECIO TPC1 ON VAL1.DD_TPC_ID = TPC1.DD_TPC_ID AND TPC1.DD_TPC_CODIGO = ''02''
      WHERE VAL1.BORRADO=0
        AND VAL1.ACT_ID = ACT.ACT_ID
        AND ROWNUM = 1) AS PRECIO_APROBADO_VENTA,
    (SELECT VAL1.VAL_IMPORTE
      FROM ' || V_ESQUEMA || '.ACT_VAL_VALORACIONES VAL1
      INNER JOIN ' || V_ESQUEMA || '.DD_TPC_TIPO_PRECIO TPC1 ON VAL1.DD_TPC_ID = TPC1.DD_TPC_ID AND TPC1.DD_TPC_CODIGO = ''03''
      WHERE VAL1.BORRADO=0
        AND VAL1.ACT_ID = ACT.ACT_ID
        AND ROWNUM = 1) AS PRECIO_APROBADO_RENTA,
    (SELECT VAL1.VAL_IMPORTE
      FROM ' || V_ESQUEMA || '.ACT_VAL_VALORACIONES VAL1
      INNER JOIN ' || V_ESQUEMA || '.DD_TPC_TIPO_PRECIO TPC1 ON VAL1.DD_TPC_ID = TPC1.DD_TPC_ID AND TPC1.DD_TPC_CODIGO = ''04''
      WHERE VAL1.BORRADO=0
        AND VAL1.ACT_ID = ACT.ACT_ID
        AND ROWNUM = 1) AS PRECIO_MINIMO_AUTORIZADO,
    (SELECT VAL1.VAL_IMPORTE
      FROM ' || V_ESQUEMA || '.ACT_VAL_VALORACIONES VAL1
      INNER JOIN ' || V_ESQUEMA || '.DD_TPC_TIPO_PRECIO TPC1 ON VAL1.DD_TPC_ID = TPC1.DD_TPC_ID AND TPC1.DD_TPC_CODIGO = ''19''
      WHERE VAL1.BORRADO=0
        AND VAL1.ACT_ID = ACT.ACT_ID
        AND ROWNUM = 1) AS FSV_VENTA,
    (SELECT VAL1.VAL_IMPORTE
      FROM ' || V_ESQUEMA || '.ACT_VAL_VALORACIONES VAL1
      INNER JOIN ' || V_ESQUEMA || '.DD_TPC_TIPO_PRECIO TPC1 ON VAL1.DD_TPC_ID = TPC1.DD_TPC_ID AND TPC1.DD_TPC_CODIGO = ''20''
      WHERE VAL1.BORRADO=0
        AND VAL1.ACT_ID = ACT.ACT_ID
        AND ROWNUM = 1) AS FSV_RENTA,
    (SELECT HVA1.HVA_IMPORTE
      FROM REM01.ACT_HVA_HIST_VALORACIONES HVA1
      INNER JOIN REM01.DD_TPC_TIPO_PRECIO TPC1 ON HVA1.DD_TPC_ID = TPC1.DD_TPC_ID AND TPC1.DD_TPC_CODIGO = ''02''
      WHERE HVA1.BORRADO=0
        AND HVA1.ACT_ID = ACT.ACT_ID
        AND ROWNUM = 1) AS HISTORICO_APROBADO_VENTA,
    (SELECT HVA1.HVA_IMPORTE
      FROM REM01.ACT_HVA_HIST_VALORACIONES HVA1
      INNER JOIN REM01.DD_TPC_TIPO_PRECIO TPC1 ON HVA1.DD_TPC_ID = TPC1.DD_TPC_ID AND TPC1.DD_TPC_CODIGO = ''04''
      WHERE HVA1.BORRADO=0
        AND HVA1.ACT_ID = ACT.ACT_ID
        AND ROWNUM = 1) AS HISTORICO_MINIMO_AUTORIZADO,
    NVL2(ACT.ACT_BLOQUEO_PRECIO_FECHA_INI, ''1'',''0'') AS CON_BLOQUEO,
    ACT.ACT_FECHA_IND_PRECIAR AS FECHA_PRECIAR,
    ACT.ACT_FECHA_IND_REPRECIAR AS FECHA_REPRECIAR,
    ACT.ACT_FECHA_IND_DESCUENTO AS FECHA_DESCUENTO,
	PRO_ID AS PRO_ID,
	EAC.DD_EAC_CODIGO AS ESTADO_FISICO_CODIGO,
	EAC.DD_EAC_DESCRIPCION AS ESTADO_FISICO_DESCRIPCION,
	TCO.DD_TCO_CODIGO AS DESTINO_COMERCIAL_CODIGO,
	TCO.DD_TCO_DESCRIPCION AS DESTINO_COMERCIAL_DESCRIPCION,
	(SELECT COUNT(AFR.OFR_ID) FROM ' || V_ESQUEMA || '.ACT_OFR AFR 
		LEFT JOIN ' || V_ESQUEMA || '.OFR_OFERTAS OFR ON AFR.OFR_ID=OFR.OFR_ID 
		LEFT JOIN ' || V_ESQUEMA || '.DD_EOF_ESTADOS_OFERTA EOF ON OFR.DD_EOF_ID = EOF.DD_EOF_ID 
    	WHERE EOF.DD_EOF_CODIGO = ''01'' 
			AND AFR.ACT_ID = ACT.ACT_ID 
			AND OFR.BORRADO=0 
			AND ROWNUM=1) AS CON_OFERTA_APROBADA,
  	(SELECT COUNT(RES.RES_ID) FROM ' || V_ESQUEMA || '.ACT_OFR AFR 
		LEFT JOIN ' || V_ESQUEMA || '.OFR_OFERTAS OFR ON AFR.OFR_ID=OFR.OFR_ID 
		LEFT JOIN ' || V_ESQUEMA || '.ECO_EXPEDIENTE_COMERCIAL ECO ON OFR.OFR_ID=ECO.OFR_ID
    	LEFT JOIN ' || V_ESQUEMA || '.RES_RESERVAS RES ON ECO.ECO_ID=RES.ECO_ID 
		LEFT JOIN ' || V_ESQUEMA || '.DD_ERE_ESTADOS_RESERVA ERE ON RES.DD_ERE_ID = ERE.DD_ERE_ID
    	WHERE DD_ERE_CODIGO IN (''01'',''02'',''03'',''05'') 
			AND AFR.ACT_ID = ACT.ACT_ID 
			AND RES.BORRADO=0 
			AND ROWNUM=1) AS CON_RESERVA,
	(SELECT CASE WHEN (COUNT(1) > 0) THEN 1 ELSE 0 END
		FROM ' || V_ESQUEMA || '.PRP_PROPUESTAS_PRECIOS prp
		INNER JOIN ' || V_ESQUEMA || '.ACT_PRP ACP ON prp.PRP_ID = ACP.PRP_ID
		INNER JOIN ' || V_ESQUEMA || '.DD_EPP_ESTADO_PROP_PRECIO epp ON prp.DD_EPP_ID = epp.DD_EPP_ID
		WHERE epp.DD_EPP_CODIGO != ''04''
			AND acp.ACT_ID = act.ACT_ID ) AS IN_PRP_TRAMITACION

  FROM ' || V_ESQUEMA || '.ACT_ACTIVO ACT
  INNER JOIN ' || V_ESQUEMA || '.DD_TPA_TIPO_ACTIVO TPA ON TPA.DD_TPA_ID = ACT.DD_TPA_ID
  INNER JOIN ' || V_ESQUEMA || '.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
  INNER JOIN ' || V_ESQUEMA || '.ACT_PAC_PROPIETARIO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID
  LEFT JOIN ' || V_ESQUEMA || '.DD_SAC_SUBTIPO_ACTIVO SAC ON SAC.DD_SAC_ID = ACT.DD_SAC_ID
  LEFT JOIN ' || V_ESQUEMA || '.DD_TTA_TIPO_TITULO_ACTIVO TTA ON TTA.DD_TTA_ID =  ACT.DD_TTA_ID
  LEFT JOIN ' || V_ESQUEMA || '.DD_STA_SUBTIPO_TITULO_ACTIVO STA ON STA.DD_STA_ID =  ACT.DD_STA_ID
  LEFT JOIN ' || V_ESQUEMA || '.ACT_SPS_SIT_POSESORIA ACT_SIT ON ACT.ACT_ID = ACT_SIT.ACT_ID
  LEFT JOIN ' || V_ESQUEMA || '.ACT_ICO_INFO_COMERCIAL ICO ON ICO.ACT_ID = ACT.ACT_ID
  LEFT JOIN ' || V_ESQUEMA || '.ACT_TIT_TITULO TIT ON TIT.ACT_ID = ACT.ACT_ID
  LEFT JOIN ' || V_ESQUEMA || '.BIE_LOCALIZACION BIE_LOC ON ACT.BIE_ID = BIE_LOC.BIE_ID
  LEFT JOIN ' || V_ESQUEMA || '.DD_SCR_SUBCARTERA SCR ON SCR.DD_SCR_ID = ACT.DD_SCR_ID
  LEFT JOIN ' || V_ESQUEMA || '.DD_EAC_ESTADO_ACTIVO EAC ON EAC.DD_EAC_ID = ACT.DD_EAC_ID
  LEFT JOIN ' || V_ESQUEMA || '.DD_TCO_TIPO_COMERCIALIZACION TCO ON TCO.DD_TCO_ID = ACT.DD_TCO_ID
';

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS_PRECIOS...Creada OK');
  
END;
/

EXIT;
