  --/*
--##########################################
--## AUTOR=JOSEVI JIMENEZ
--## FECHA_CREACION=20170201
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-1463
--## PRODUCTO=NO
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.    
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- N?mero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas
    V_MSQL VARCHAR2(4000 CHAR); 

    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_ACTIVOS_TRABAJO' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS_TRABAJO...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_ACTIVOS_TRABAJO';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS_TRABAJO... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_ACTIVOS_TRABAJO' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS_TRABAJO...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_ACTIVOS_TRABAJO';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS_TRABAJO... borrada OK');
  END IF;

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS_TRABAJO...');
  EXECUTE IMMEDIATE 'CREATE VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_ACTIVOS_TRABAJO 
		
	AS	
  SELECT
      ROWNUM as VAT_ID,
      TBJ.TBJ_ID,
      TBJ.TBJ_FECHA_SOLICITUD,
      EST.DD_EST_CODIGO,
      EST.DD_EST_DESCRIPCION,
      EST.DD_EST_ESTADO_CONTABLE,
      ACT.ACT_ID,
      ACT.ACT_NUM_ACTIVO,
      ACT.ACT_NUM_ACTIVO_REM,
      BIE_LOC.BIE_LOC_NOMBRE_VIA,
      STA.DD_SAC_DESCRIPCION AS SUBTIPO_ACTIVO_DESCRIPCION,
      CRA.DD_CRA_DESCRIPCION AS ENTIDAD_PROPIETARIA_DESC,
      LOC.DD_LOC_DESCRIPCION AS LOCALIDAD_DESCRIPCION,
      PRV.DD_PRV_DESCRIPCION AS PROVINCIA_DESCRIPCION,
      TPA.DD_TPA_DESCRIPCION AS TIPO_ACTIVO_DESCRIPCION,
      SPS.SPS_OCUPADO,
      SPS.SPS_CON_TITULO,
      DD_SCM_DESCRIPCION AS SITUACION_COMERCIAL

      FROM REM01.ACT_TBJ ACTTBJ
        INNER JOIN REM01.ACT_TBJ_TRABAJO TBJ ON ACTTBJ.TBJ_ID = TBJ.TBJ_ID AND TBJ.BORRADO = 0
        INNER JOIN REM01.ACT_ACTIVO ACT ON ACTTBJ.ACT_ID = ACT.ACT_ID AND ACT.BORRADO=0
        LEFT JOIN REM01.ACT_SPS_SIT_POSESORIA SPS ON SPS.ACT_ID = ACT.ACT_ID
        INNER JOIN REM01.BIE_BIEN BIE ON ACT.BIE_ID = BIE.BIE_ID
        LEFT JOIN REM01.BIE_LOCALIZACION BIE_LOC ON ACT.BIE_ID = BIE_LOC.BIE_ID
        LEFT JOIN REMMASTER.DD_LOC_LOCALIDAD LOC ON LOC.DD_LOC_ID = BIE_LOC.DD_LOC_ID
        LEFT JOIN REM01.DD_SAC_SUBTIPO_ACTIVO STA ON STA.DD_SAC_ID = ACT.DD_SAC_ID
        LEFT JOIN REM01.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
        LEFT JOIN REMMASTER.DD_PRV_PROVINCIA PRV ON PRV.DD_PRV_ID = LOC.DD_PRV_ID
        LEFT JOIN REM01.DD_TPA_TIPO_ACTIVO TPA ON TPA.DD_TPA_ID = STA.DD_TPA_ID
        LEFT JOIN REM01.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_ID = ACT.DD_SCM_ID
        LEFT JOIN REM01.DD_EST_ESTADO_TRABAJO EST ON EST.DD_EST_ID = TBJ.DD_EST_ID';
      	
  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS_TRABAJO...Creada OK');
  
END;
/

EXIT;