--/*
--##########################################
--## AUTOR=DANIEL GUTIÉRREZ
--## FECHA_CREACION=20161130
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=0
--## PRODUCTO=NO
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.    
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- N?mero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas
    V_MSQL VARCHAR2(4000 CHAR); 

    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_NUM_ACT_TIPO_PRECIO' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_NUM_ACT_TIPO_PRECIO...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_NUM_ACT_TIPO_PRECIO';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_NUM_ACT_TIPO_PRECIO... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_NUM_ACT_TIPO_PRECIO' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_NUM_ACT_TIPO_PRECIO...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_NUM_ACT_TIPO_PRECIO';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_NUM_ACT_TIPO_PRECIO... borrada OK');
  END IF;

  DBMS_OUTPUT.PUT_LINE('CREATING VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_NUM_ACT_TIPO_PRECIO...');
  EXECUTE IMMEDIATE 'CREATE VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_NUM_ACT_TIPO_PRECIO ("FILA", "NIVEL", "ENTIDAD_CODIGO", "ENTIDAD_DESCRIPCION", "SUBCARTERA_CODIGO", "SUBCARTERA_DESCRIPCION", "ESTADO_FISICO_CODIGO", "ESTADO_FISICO_DESCRIPCION", "NUM_ACTIVOS_PRECIAR", "NUM_ACTIVOS_REPRECIAR", "NUM_ACTIVOS_DESCUENTO") 
	AS
  SELECT ROWNUM AS FILA, AUX."NIVEL",AUX."ENTIDAD_CODIGO",AUX."ENTIDAD_DESCRIPCION",AUX."SUBCARTERA_CODIGO",AUX."SUBCARTERA_DESCRIPCION",AUX."ESTADO_FISICO_CODIGO",AUX."ESTADO_FISICO_DESCRIPCION",AUX."NUM_ACTIVOS_PRECIAR",AUX."NUM_ACTIVOS_REPRECIAR",AUX."NUM_ACTIVOS_DESCUENTO" FROM
    (SELECT /* RESTO CARTERAS */
      1 AS NIVEL,
		  CRA.DD_CRA_CODIGO AS ENTIDAD_CODIGO,
		  CRA.DD_CRA_DESCRIPCION AS ENTIDAD_DESCRIPCION,
      null AS SUBCARTERA_CODIGO,
      null AS SUBCARTERA_DESCRIPCION,
      null AS ESTADO_FISICO_CODIGO,
      null AS ESTADO_FISICO_DESCRIPCION,
		  COUNT(CASE WHEN ACT.ACT_FECHA_IND_PRECIAR IS NOT NULL AND ACT.ACT_FECHA_IND_REPRECIAR IS NULL AND ACT.ACT_BLOQUEO_PRECIO_FECHA_INI IS NULL THEN 1 END) AS NUM_ACTIVOS_PRECIAR,
		  COUNT(CASE WHEN ACT.ACT_FECHA_IND_REPRECIAR IS NOT NULL AND ACT.ACT_BLOQUEO_PRECIO_FECHA_INI IS NULL THEN 1 END) AS NUM_ACTIVOS_REPRECIAR,
		  COUNT(CASE WHEN ACT.ACT_FECHA_IND_DESCUENTO IS NOT NULL AND ACT.ACT_BLOQUEO_PRECIO_FECHA_INI IS NULL THEN 1 END) AS NUM_ACTIVOS_DESCUENTO
		FROM '|| V_ESQUEMA ||'.ACT_ACTIVO ACT
			JOIN REM01.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND ACT.DD_CRA_ID != (SELECT DD_CRA_ID FROM DD_CRA_CARTERA WHERE DD_CRA_CODIGO = ''03'')
      --LEFT JOIN REM01.DD_SCR_SUBCARTERA SCR ON SCR.DD_SCR_ID = ACT.DD_SCR_ID AND ACT.DD_SCR_ID NOT IN (SELECT DD_SCR_ID FROM DD_SCR_SUBCARTERA WHERE DD_SCR_CODIGO IN (''01'',''03''))
      --LEFT JOIN REM01.DD_EAC_ESTADO_ACTIVO EAC ON EAC.DD_EAC_ID = ACT.DD_EAC_ID AND EAC.DD_EAC_ID = 999
		GROUP BY CRA.DD_CRA_DESCRIPCION,  CRA.DD_CRA_CODIGO--, SCR.DD_SCR_DESCRIPCION, SCR.DD_SCR_CODIGO
    --ORDER BY 1; 
    UNION
      SELECT /* BANKIA TITULIZADOS */
      1 AS NIVEL,
		  CRA.DD_CRA_CODIGO AS ENTIDAD_CODIGO,
		  CRA.DD_CRA_DESCRIPCION AS ENTIDAD_DESCRIPCION,
      SCR.DD_SCR_CODIGO AS SUBCARTERA_CODIGO,
      SCR.DD_SCR_DESCRIPCION AS SUBCARTERA_DESCRIPCION,
      null AS ESTADO_FISICO_CODIGO,
      null AS ESTADO_FISICO_DESCRIPCION,
		  COUNT(CASE WHEN ACT.ACT_FECHA_IND_PRECIAR IS NOT NULL AND ACT.ACT_FECHA_IND_REPRECIAR IS NULL AND ACT.ACT_BLOQUEO_PRECIO_FECHA_INI IS NULL THEN 1 END) AS NUM_ACTIVOS_PRECIAR,
		  COUNT(CASE WHEN ACT.ACT_FECHA_IND_REPRECIAR IS NOT NULL AND ACT.ACT_BLOQUEO_PRECIO_FECHA_INI IS NULL THEN 1 END) AS NUM_ACTIVOS_REPRECIAR,
		  COUNT(CASE WHEN ACT.ACT_FECHA_IND_DESCUENTO IS NOT NULL AND ACT.ACT_BLOQUEO_PRECIO_FECHA_INI IS NULL THEN 1 END) AS NUM_ACTIVOS_DESCUENTO
		FROM '|| V_ESQUEMA ||'.ACT_ACTIVO ACT
			JOIN '|| V_ESQUEMA ||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND ACT.DD_CRA_ID = (SELECT DD_CRA_ID FROM DD_CRA_CARTERA WHERE DD_CRA_CODIGO = ''03'')
      JOIN '|| V_ESQUEMA ||'.DD_SCR_SUBCARTERA SCR ON SCR.DD_SCR_ID = ACT.DD_SCR_ID  AND ACT.DD_SCR_ID = (SELECT DD_SCR_ID FROM DD_SCR_SUBCARTERA WHERE DD_SCR_CODIGO = ''09'')
      LEFT JOIN '|| V_ESQUEMA ||'.DD_EAC_ESTADO_ACTIVO EAC ON EAC.DD_EAC_ID = ACT.DD_EAC_ID AND ACT.DD_CRA_ID = (SELECT DD_CRA_ID FROM DD_CRA_CARTERA WHERE DD_CRA_CODIGO = ''02'')
      GROUP BY CRA.DD_CRA_DESCRIPCION, CRA.DD_CRA_CODIGO, SCR.DD_SCR_DESCRIPCION, SCR.DD_SCR_CODIGO
 --     ORDER BY 1
    UNION
    SELECT /* BANKIA NO TITULIZADOS */
      1 AS NIVEL,
		  CRA.DD_CRA_CODIGO AS ENTIDAD_CODIGO,
		  CRA.DD_CRA_DESCRIPCION AS ENTIDAD_DESCRIPCION,
      SCR.DD_SCR_CODIGO AS SUBCARTERA_CODIGO,
      SCR.DD_SCR_DESCRIPCION AS SUBCARTERA_DESCRIPCION,
      EAC.DD_EAC_CODIGO AS ESTADO_FISICO_CODIGO,
      EAC.DD_EAC_DESCRIPCION AS ESTADO_FISICO_DESCRIPCION,
		  COUNT(CASE WHEN ACT.ACT_FECHA_IND_PRECIAR IS NOT NULL AND ACT.ACT_FECHA_IND_REPRECIAR IS NULL AND ACT.ACT_BLOQUEO_PRECIO_FECHA_INI IS NULL THEN 1 END) AS NUM_ACTIVOS_PRECIAR,
		  COUNT(CASE WHEN ACT.ACT_FECHA_IND_REPRECIAR IS NOT NULL AND ACT.ACT_BLOQUEO_PRECIO_FECHA_INI IS NULL THEN 1 END) AS NUM_ACTIVOS_REPRECIAR,
		  COUNT(CASE WHEN ACT.ACT_FECHA_IND_DESCUENTO IS NOT NULL AND ACT.ACT_BLOQUEO_PRECIO_FECHA_INI IS NULL THEN 1 END) AS NUM_ACTIVOS_DESCUENTO
		FROM '|| V_ESQUEMA ||'.ACT_ACTIVO ACT
			JOIN '|| V_ESQUEMA ||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND ACT.DD_CRA_ID = (SELECT DD_CRA_ID FROM DD_CRA_CARTERA WHERE DD_CRA_CODIGO = ''03'')
      JOIN '|| V_ESQUEMA ||'.DD_SCR_SUBCARTERA SCR ON SCR.DD_SCR_ID = ACT.DD_SCR_ID  AND ACT.DD_SCR_ID NOT IN (SELECT DD_SCR_ID FROM DD_SCR_SUBCARTERA WHERE DD_SCR_CODIGO IN (''09'',''05''))
      LEFT JOIN '|| V_ESQUEMA ||'.DD_EAC_ESTADO_ACTIVO EAC ON EAC.DD_EAC_ID = ACT.DD_EAC_ID AND ACT.DD_CRA_ID = (SELECT DD_CRA_ID FROM DD_CRA_CARTERA WHERE DD_CRA_CODIGO = ''02'')
		GROUP BY CRA.DD_CRA_DESCRIPCION,  CRA.DD_CRA_CODIGO, SCR.DD_SCR_DESCRIPCION, SCR.DD_SCR_CODIGO, EAC.DD_EAC_CODIGO, EAC.DD_EAC_DESCRIPCION
 --   ORDER BY 1;
    UNION
    SELECT /* SAREB POR ESTADO FÍSICO */
      2 AS NIVEL,
		  CRA.DD_CRA_CODIGO AS ENTIDAD_CODIGO,
		  CRA.DD_CRA_DESCRIPCION AS ENTIDAD_DESCRIPCION,
      SCR.DD_SCR_CODIGO AS SUBCARTERA_CODIGO,
      SCR.DD_SCR_DESCRIPCION AS SUBCARTERA_DESCRIPCION,
      EAC.DD_EAC_CODIGO AS ESTADO_FISICO_CODIGO,
      EAC.DD_EAC_DESCRIPCION AS ESTADO_FISICO_DESCRIPCION,
		  COUNT(CASE WHEN ACT.ACT_FECHA_IND_PRECIAR IS NOT NULL AND ACT.ACT_FECHA_IND_REPRECIAR IS NULL AND ACT.ACT_BLOQUEO_PRECIO_FECHA_INI IS NULL THEN 1 END) AS NUM_ACTIVOS_PRECIAR,
		  COUNT(CASE WHEN ACT.ACT_FECHA_IND_REPRECIAR IS NOT NULL AND ACT.ACT_BLOQUEO_PRECIO_FECHA_INI IS NULL THEN 1 END) AS NUM_ACTIVOS_REPRECIAR,
		  COUNT(CASE WHEN ACT.ACT_FECHA_IND_DESCUENTO IS NOT NULL AND ACT.ACT_BLOQUEO_PRECIO_FECHA_INI IS NULL THEN 1 END) AS NUM_ACTIVOS_DESCUENTO
		FROM '|| V_ESQUEMA ||'.ACT_ACTIVO ACT
			JOIN '|| V_ESQUEMA ||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND ACT.DD_CRA_ID = (SELECT DD_CRA_ID FROM DD_CRA_CARTERA WHERE DD_CRA_CODIGO = ''02'')
      LEFT JOIN '|| V_ESQUEMA ||'.DD_SCR_SUBCARTERA SCR ON SCR.DD_SCR_ID = ACT.DD_SCR_ID AND ACT.DD_SCR_ID != (SELECT DD_SCR_ID FROM DD_SCR_SUBCARTERA WHERE DD_SCR_CODIGO = ''03'')
      JOIN '|| V_ESQUEMA ||'.DD_EAC_ESTADO_ACTIVO EAC ON EAC.DD_EAC_ID = ACT.DD_EAC_ID
		GROUP BY CRA.DD_CRA_DESCRIPCION,  CRA.DD_CRA_CODIGO, SCR.DD_SCR_DESCRIPCION, SCR.DD_SCR_CODIGO, EAC.DD_EAC_CODIGO, EAC.DD_EAC_DESCRIPCION
    ORDER BY 1) AUX';

		
  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_NUM_ACT_TIPO_PRECIO...Creada OK');
  
END;
/

EXIT;