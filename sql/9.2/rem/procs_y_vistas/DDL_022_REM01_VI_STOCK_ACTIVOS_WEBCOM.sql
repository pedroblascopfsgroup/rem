--/*
--##########################################
--## AUTOR=ANAHUAC DE VICENTE
--## FECHA_CREACION=20160906
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=0
--## PRODUCTO=NO
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.    
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- N?mero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas
    V_MSQL VARCHAR2(4000 CHAR); 

    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'VI_STOCK_ACTIVOS_WEBCOM' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '||V_ESQUEMA||'.VI_STOCK_ACTIVOS_WEBCOM...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW '||V_ESQUEMA||'.VI_STOCK_ACTIVOS_WEBCOM';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '||V_ESQUEMA||'.VI_STOCK_ACTIVOS_WEBCOM... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'VI_STOCK_ACTIVOS_WEBCOM' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '||V_ESQUEMA||'.VI_STOCK_ACTIVOS_WEBCOM...');
    EXECUTE IMMEDIATE 'DROP VIEW '||V_ESQUEMA||'.VI_STOCK_ACTIVOS_WEBCOM';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '||V_ESQUEMA||'.VI_STOCK_ACTIVOS_WEBCOM... borrada OK');
  END IF;

  DBMS_OUTPUT.PUT_LINE('CREATING VIEW '||V_ESQUEMA||'.VI_STOCK_ACTIVOS_WEBCOM...');
  EXECUTE IMMEDIATE 'CREATE VIEW '||V_ESQUEMA||'.VI_STOCK_ACTIVOS_WEBCOM 
	AS
		SELECT 
		ACT.ACT_NUM_ACTIVO AS ACTIVO_HAYA,
		DDTVI.DD_TVI_CODIGO AS COD_TIPO_VIA,
		BLOC.BIE_LOC_NOMBRE_VIA AS NOMBRE_CALLE,
		BLOC.BIE_LOC_NUMERO_DOMICILIO AS NUMERO_CALLE,
		BLOC.BIE_LOC_ESCALERA AS ESCALERA,
		BLOC.BIE_LOC_PISO AS PLANTA,
		BLOC.BIE_LOC_PUERTA AS PUERTA,
		DDUPO.DD_UPO_CODIGO AS COD_MUNICIPIO, 
		DDDIS.DD_DIS_CODIGO AS COD_PEDANIA,
		DDPRV.DD_PRV_CODIGO AS COD_PROVINCIA,
		BLOC.BIE_LOC_COD_POST AS CODIGO_POSTAL,
		(SELECT MAX(VAL.VAL_IMPORTE) FROM '||V_ESQUEMA||'.ACT_VAL_VALORACIONES VAL, '||V_ESQUEMA||'.DD_TPC_TIPO_PRECIO TPC 
		WHERE VAL.ACT_ID = ACT.ACT_ID AND TPC.DD_TPC_ID = VAL.DD_TPC_ID AND TPC.DD_TPC_CODIGO = ''02'' AND VAL.VAL_FECHA_FIN IS NULL) ACTUAL_IMPORTE,
		(SELECT MAX(VAL.VAL_IMPORTE) FROM '||V_ESQUEMA||'.ACT_VAL_VALORACIONES VAL, '||V_ESQUEMA||'.DD_TPC_TIPO_PRECIO TPC 
		WHERE VAL.ACT_ID = ACT.ACT_ID AND TPC.DD_TPC_ID = VAL.DD_TPC_ID AND TPC.DD_TPC_CODIGO = ''02'' 
		AND VAL.VAL_FECHA_FIN IS NOT NULL AND VAL.VAL_FECHA_FIN = (SELECT MAX(VAL2.VAL_FECHA_FIN) FROM '||V_ESQUEMA||'.ACT_VAL_VALORACIONES VAL2)) ANTERIOR_IMPORTE,
		(SELECT CASE WHEN (VAL_FECHA_INICIO IS NOT NULL) 
					THEN TO_CHAR(VAL_FECHA_INICIO,''YYYY-MM-DD'') || ''T'' ||TO_CHAR(VAL_FECHA_INICIO,''HH24:MI:SS'')
					ELSE NULL 
				END DESDE_IMPORTE
		    FROM '||V_ESQUEMA||'.ACT_VAL_VALORACIONES VAL, '||V_ESQUEMA||'.DD_TPC_TIPO_PRECIO TPC 
		WHERE VAL.ACT_ID = ACT.ACT_ID AND TPC.DD_TPC_ID = VAL.DD_TPC_ID AND TPC.DD_TPC_CODIGO = ''02'' AND VAL.VAL_FECHA_FIN IS NULL) DESDE_IMPORTE,
		(SELECT CASE WHEN (VAL_FECHA_FIN IS NOT NULL) 
					THEN TO_CHAR(VAL_FECHA_FIN,''YYYY-MM-DD'') || ''T'' ||TO_CHAR(VAL_FECHA_FIN,''HH24:MI:SS'')
					ELSE NULL 
				END HASTA_IMPORTE
		    FROM '||V_ESQUEMA||'.ACT_VAL_VALORACIONES VAL, '||V_ESQUEMA||'.DD_TPC_TIPO_PRECIO TPC 
		WHERE VAL.ACT_ID = ACT.ACT_ID AND TPC.DD_TPC_ID = VAL.DD_TPC_ID AND TPC.DD_TPC_CODIGO = ''02'' AND VAL.VAL_FECHA_FIN IS NULL) HASTA_IMPORTE,
		TO_CHAR(TO_NUMBER(DDTPA.DD_TPA_CODIGO)) AS COD_TIPO_INMUEBLE,
		TO_CHAR(TO_NUMBER(DDSAC.DD_SAC_CODIGO)) AS COD_SUBTIPO_INMUEBLE,
		BREG.BIE_DREG_NUM_FINCA AS FINCA_REGISTRAL,
		DDBRLOC.DD_LOC_CODIGO AS COD_MUNICIPIO_REGISTRO,
		BREG.BIE_DREG_NUM_REGISTRO AS REGISTRO,
		(SELECT MAX(CAT.CAT_REF_CATASTRAL) FROM '||V_ESQUEMA||'.ACT_CAT_CATASTRO CAT WHERE CAT.ACT_ID = ACT.ACT_ID) AS REFERENCIA_CATASTRAL,
		REG.REG_SUPERFICIE_UTIL AS SUPERFICIE,
		BREG.BIE_DREG_SUPERFICIE AS SUPERFICIE_REGISTRAL,
		EDI.EDI_ASCENSOR AS ASCENSOR,
		(SELECT SUM(DIS.DIS_CANTIDAD) FROM '||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION DIS, '||V_ESQUEMA||'.DD_TPH_TIPO_HABITACULO TPH 
		WHERE  DIS.DD_TPH_ID = TPH.DD_TPH_ID AND ICO.ICO_ID = DIS.ICO_ID AND TPH.DD_TPH_CODIGO = ''01'') DORMITORIOS,
		(SELECT SUM(DIS.DIS_CANTIDAD) FROM '||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION DIS, '||V_ESQUEMA||'.DD_TPH_TIPO_HABITACULO TPH
		WHERE  DIS.DD_TPH_ID = TPH.DD_TPH_ID AND ICO.ICO_ID = DIS.ICO_ID AND TPH.DD_TPH_CODIGO = ''02'') BANYOS,
		(SELECT SUM(DIS.DIS_CANTIDAD) FROM '||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION DIS, '||V_ESQUEMA||'.DD_TPH_TIPO_HABITACULO TPH
		WHERE  DIS.DD_TPH_ID = TPH.DD_TPH_ID AND ICO.ICO_ID = DIS.ICO_ID AND TPH.DD_TPH_CODIGO = ''04'') ASEOS,
		(SELECT SUM(DIS.DIS_CANTIDAD) FROM '||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION DIS, '||V_ESQUEMA||'.DD_TPH_TIPO_HABITACULO TPH
		WHERE  DIS.DD_TPH_ID = TPH.DD_TPH_ID AND ICO.ICO_ID = DIS.ICO_ID AND TPH.DD_TPH_CODIGO = ''12'') GARAJES,
		(SELECT CASE DDEAC.DD_EAC_CODIGO WHEN ''03'' THEN ''1'' WHEN ''04'' THEN ''1'' ELSE ''0'' END NUEVO 
		FROM '||V_ESQUEMA||'.DD_EAC_ESTADO_ACTIVO DDEAC WHERE DDEAC.DD_EAC_ID = ACT.DD_EAC_ID) NUEVO,
		TO_CHAR(TO_NUMBER(DDSCM.DD_SCM_CODIGO)) AS COD_ESTADO_COMERCIAL,
		TO_CHAR(TO_NUMBER(DDTCO.DD_TCO_CODIGO)) AS COD_TIPO_VENTA,
		LOC.LOC_LATITUD AS LAT,
		LOC.LOC_LONGITUD AS LNG,
		TO_CHAR(TO_NUMBER(DDECT.DD_ECT_CODIGO)) AS COD_ESTADO_CONSTRUCCION,
		(SELECT SUM(DIS.DIS_CANTIDAD) FROM '||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION DIS, '||V_ESQUEMA||'.DD_TPH_TIPO_HABITACULO TPH
		WHERE  DIS.DD_TPH_ID = TPH.DD_TPH_ID AND ICO.ICO_ID = DIS.ICO_ID AND (TPH.DD_TPH_CODIGO = ''15'' OR TPH.DD_TPH_CODIGO = ''16'')) TERRAZAS,
		TO_CHAR(TO_NUMBER(DDEPU.DD_EPU_CODIGO)) AS COD_ESTADO_PUBLICACION,
		(SELECT MAX(HEP.HEP_FECHA_DESDE) FROM '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION HEP WHERE HEP.ACT_ID = ACT.ACT_ID AND HEP.HEP_FECHA_HASTA IS NULL) PUBLICADO_DESDE,
		CASE WHEN (VIV.VIV_REFORMA_CARP_INT =1 OR VIV.VIV_REFORMA_CARP_EXT = 1 OR VIV.VIV_REFORMA_COCINA =1 OR VIV.VIV_REFORMA_BANYO =1 OR 
		           VIV.VIV_REFORMA_SUELO=1 OR VIV.VIV_REFORMA_PINTURA=1 OR VIV.VIV_REFORMA_INTEGRAL=1 OR VIV.VIV_REFORMA_OTRO=1) THEN 1
		     ELSE 0 END REFORMAS,
		TO_CHAR(TO_NUMBER(VPO.DD_TVP_CODIGO)) AS COD_REGIMEN_PROTECCION,
		ICO.ICO_INFO_DESCRIPCION AS DESCRIPCION,
		ICO.ICO_INFO_DISTRIBUCION_INTERIOR AS DISTRIBUCION,
		ICO.ICO_CONDICIONES_LEGALES AS CONDICIONES_ESPECIFICAS,
		NULL AS COD_DETALLE_PUBLICACION, 
		(SELECT MIN(AGR_NUM_AGRUP_REM) FROM '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR , '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO AGA , '||V_ESQUEMA||'.DD_TAG_TIPO_AGRUPACION DDTAG
		WHERE AGR.AGR_ID = AGA.AGR_ID AND AGR.DD_TAG_ID = DDTAG.DD_TAG_ID AND AGA.ACT_ID = ACT.ACT_ID AND DDTAG.DD_TAG_CODIGO = ''01'') CODIGO_AGRUPACION_OBRA_NUEVA,
		(SELECT MAX(SDV.SDV_ID) FROM '||V_ESQUEMA||'.ACT_SDV_SUBDIVISION_ACTIVO SDV, '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR , '||V_ESQUEMA||'.DD_TAG_TIPO_AGRUPACION DDTAG
		WHERE SDV.SDV_ID = ACT.SDV_ID AND AGR.AGR_ID = SDV.AGR_ID AND AGR.DD_TAG_ID = DDTAG.DD_TAG_ID AND DDTAG.DD_TAG_CODIGO = ''01'') CODIGO_CABECERA_OBRA_NUEVA,
		(SELECT MAX(ICO_MEDIADOR_ID) FROM '||V_ESQUEMA||'.ACT_ICM_INF_COMER_HIST_MEDI ICM
		WHERE ICM.ACT_ID = ACT.ACT_ID AND ICM.ICM_FECHA_HASTA IS NOT NULL AND ICM.ICM_FECHA_HASTA = (SELECT MAX(ICM2.ICM_FECHA_HASTA) FROM '||V_ESQUEMA||'.ACT_ICM_INF_COMER_HIST_MEDI ICM2)) ID_PROVEEDOR_REM_ANTERIOR,
		ICO.ICO_MEDIADOR_ID AS ID_PROVEEDOR_REM,
		USU.USU_NOMBRE || '' '' || USU.USU_APELLIDO1 || '' '' || USU.USU_APELLIDO2 AS NOMBRE_GESTOR_COMERCIAL, 
		USU.USU_TELEFONO AS TELEFONO_GESTOR_COMERCIAL, 
		USU.USU_MAIL AS EMAIL_GESTOR_COMERCIAL,
		TO_CHAR(TO_NUMBER(DDTCE.DD_TCE_CODIGO)) AS COD_CEE,
		ICO.ICO_ANO_CONSTRUCCION AS ANTIGUEDAD,
		TO_CHAR(TO_NUMBER(DDCRA.DD_CRA_CODIGO)) AS COD_CARTERA,
		TO_CHAR(TO_NUMBER(DDRTG.DD_RTG_CODIGO)) AS COD_RATIO,
		CASE WHEN (ACT.FECHAMODIFICAR IS NOT NULL) 
			THEN TO_CHAR(ACT.FECHAMODIFICAR,''YYYY-MM-DD'') || ''T'' ||TO_CHAR(ACT.FECHACREAR,''HH24:MI:SS'')
			ELSE TO_CHAR(ACT.FECHACREAR,''YYYY-MM-DD'') || ''T'' ||TO_CHAR(ACT.FECHACREAR,''HH24:MI:SS'')
		END FECHA_ACCION,
		CASE WHEN (ACT.USUARIOMODIFICAR IS NOT NULL) 
			THEN (SELECT USU2.USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS USU2 WHERE USU2.USU_USERNAME = ACT.USUARIOMODIFICAR) 
			ELSE (SELECT USU3.USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS USU3 WHERE USU3.USU_USERNAME = ACT.USUARIOCREAR) 
		END ID_USUARIO_REM_ACCION
		FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
		LEFT JOIN '||V_ESQUEMA||'.ACT_LOC_LOCALIZACION LOC ON LOC.ACT_ID = ACT.ACT_ID
		LEFT JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BLOC ON BLOC.BIE_LOC_ID = LOC.BIE_LOC_ID
		LEFT JOIN '||V_ESQUEMA||'.ACT_REG_INFO_REGISTRAL REG ON REG.ACT_ID = ACT.ACT_ID
		LEFT JOIN '||V_ESQUEMA||'.BIE_DATOS_REGISTRALES BREG ON BREG.BIE_DREG_ID = REG.BIE_DREG_ID
		LEFT JOIN '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL ICO ON ICO.ACT_ID = ACT.ACT_ID
		LEFT JOIN '||V_ESQUEMA||'.ACT_VIV_VIVIENDA VIV ON VIV.ICO_ID = ICO.ICO_ID
		LEFT JOIN '||V_ESQUEMA||'.ACT_EDI_EDIFICIO EDI ON EDI.ICO_ID = ICO.ICO_ID
		LEFT JOIN '||V_ESQUEMA||'.ACT_ADM_INF_ADMINISTRATIVA ADM ON ADM.ACT_ID = ACT.ACT_ID
		LEFT JOIN '||V_ESQUEMA||'.ACT_ADO_ADMISION_DOCUMENTO ADO ON (ADO.ACT_ID = ACT.ACT_ID AND ADO.DD_TCE_ID IS NOT NULL)
		LEFT JOIN '||V_ESQUEMA_M||'.DD_TVI_TIPO_VIA DDTVI ON DDTVI.DD_TVI_ID = BLOC.DD_TVI_ID
		LEFT JOIN '||V_ESQUEMA_M||'.DD_UPO_UNID_POBLACIONAL DDUPO ON DDUPO.DD_UPO_ID = BLOC.DD_UPO_ID
		LEFT JOIN '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA DDPRV ON DDPRV.DD_PRV_ID = BLOC.DD_PRV_ID
		LEFT JOIN '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD DDBRLOC ON DDBRLOC.DD_LOC_ID = BREG.DD_LOC_ID
		LEFT JOIN '||V_ESQUEMA||'.DD_TPA_TIPO_ACTIVO DDTPA ON DDTPA.DD_TPA_ID = ACT.DD_TPA_ID
		LEFT JOIN '||V_ESQUEMA||'.DD_SAC_SUBTIPO_ACTIVO DDSAC ON DDSAC.DD_SAC_ID = ACT.DD_SAC_ID
		LEFT JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL DDSCM ON DDSCM.DD_SCM_ID = ACT.DD_SCM_ID
		LEFT JOIN '||V_ESQUEMA||'.DD_TCO_TIPO_COMERCIALIZACION DDTCO ON DDTCO.DD_TCO_ID = ACT.DD_TCO_ID
		LEFT JOIN '||V_ESQUEMA||'.DD_ECT_ESTADO_CONSTRUCCION DDECT ON DDECT.DD_ECT_ID = ICO.DD_ECT_ID
		LEFT JOIN '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION DDEPU ON DDEPU.DD_EPU_ID = ACT.DD_EPU_ID
		LEFT JOIN '||V_ESQUEMA||'.DD_TVP_TIPO_VPO VPO ON VPO.DD_TVP_ID = ADM.DD_TVP_ID
		LEFT JOIN '||V_ESQUEMA||'.DD_TCE_TIPO_CALIF_ENERGETICA DDTCE ON DDTCE.DD_TCE_ID = ADO.DD_TCE_ID
		LEFT JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA DDCRA ON DDCRA.DD_CRA_ID = ACT.DD_CRA_ID
		LEFT JOIN '||V_ESQUEMA||'.DD_RTG_RATING_ACTIVO DDRTG ON DDRTG.DD_RTG_ID = ACT.DD_RTG_ID
		LEFT JOIN '||V_ESQUEMA||'.DD_DIS_DISTRITO DDDIS ON DDDIS.DD_DIS_ID = LOC.DD_DIS_ID
		LEFT JOIN (SELECT GEE.USU_ID, GAC.ACT_ID FROM '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC 
		JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID 
		JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON (GEE.DD_TGE_ID = TGE.DD_TGE_ID AND DD_TGE_CODIGO = ''GCOM'')) GESTOR_COM ON GESTOR_COM.ACT_ID = ACT.ACT_ID
		LEFT JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON USU.USU_ID = GESTOR_COM.USU_ID';


  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '||V_ESQUEMA||'.VI_STOCK_ACTIVOS_WEBCOM...Creada OK');
  
END;
/

EXIT;