--/*
--##########################################
--## AUTOR=JORGE ROS
--## FECHA_CREACION=20161005
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-897
--## PRODUCTO=NO
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.    
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- N?mero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas
    V_MSQL VARCHAR2(4000 CHAR); 

    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_DATOS_PROPUESTA_UNIFICADA' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_DATOS_PROPUESTA_UNIFICADA...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.V_DATOS_PROPUESTA_UNIFICADA';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_DATOS_PROPUESTA_UNIFICADA... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_DATOS_PROPUESTA_UNIFICADA' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_DATOS_PROPUESTA_UNIFICADA...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.V_DATOS_PROPUESTA_UNIFICADA';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_DATOS_PROPUESTA_UNIFICADA... borrada OK');
  END IF;

  DBMS_OUTPUT.PUT_LINE('CREATING VIEW '|| V_ESQUEMA ||'.V_DATOS_PROPUESTA_UNIFICADA...');
  EXECUTE IMMEDIATE 'CREATE VIEW ' || V_ESQUEMA || '.V_DATOS_PROPUESTA_UNIFICADA 
	AS
		SELECT
	  		ACT.ACT_ID,
			ACP.PRP_ID,
			(SELECT DD_CRA_CODIGO FROM '||V_ESQUEMA||'.DD_CRA_CARTERA WHERE DD_CRA_ID = ACT.DD_CRA_ID) AS CARTERA_CODIGO,
			(SELECT DD_SCR_CODIGO FROM '||V_ESQUEMA||'.DD_SCR_SUBCARTERA WHERE DD_SCR_ID = ACT.DD_SCR_ID) AS SUBCARTERA_CODIGO,
	-- PROPIETARIO
			PRO.PRO_NOMBRE  || '' '' || PRO.PRO_APELLIDO1 || '' '' || PRO.PRO_APELLIDO2 	AS SOCIEDAD_PROPIETARIA,
	-- ACTIVO
			STA.DD_STA_DESCRIPCION 	AS ORIGEN,
			NVL2(AJD.AJD_ID,AJD.AJD_FECHA_ADJUDICACION,ADN.ADN_FECHA_TITULO) AS FECHA_ENTRADA,
			ACT.ACT_NUM_ACTIVO 	AS ID_CARTERA,
			ACT.ACT_NUM_ACTIVO_REM AS ID_HAYA,
			CATASTRO.CAT_REF_CATASTRAL 	AS REF_CATASTRAL,
			BIE_DAT.BIE_DREG_NUM_FINCA 	AS FINCA_REGISTRAL,
			AGR_NUEVA.AGR_NUM_AGRUP_REM AS AGR_NUEVA_NUM,
			AGR_RES.AGR_NUM_AGRUP_REM AS AGR_RESTRINGIDA_NUM,
			TPA.DD_TPA_CODIGO AS TIPO_CODIGO,
			TPA.DD_TPA_DESCRIPCION AS TIPO_DESCRIPCION,
			SAC.DD_SAC_DESCRIPCION AS SUBTIPO_DESCRIPCION,
			TPVIA.DD_TVI_DESCRIPCION || '' '' || BIE_LOC.BIE_LOC_NOMBRE_VIA || '' ''|| BIE_LOC.BIE_LOC_NUMERO_DOMICILIO AS DIRECCION,
			LOC.DD_LOC_DESCRIPCION AS MUNICIPIO,
	        PRV.DD_PRV_DESCRIPCION AS PROVINCIA,
			BIE_LOC.BIE_LOC_COD_POST AS COD_POSTAL,
			-- AS PROPUESTA_FORZADA,
	-- ESTADO POR DPTOS.
			EDI.EDI_ASCENSOR AS ASCENSOR,
			(SELECT SUM(DIS.DIS_CANTIDAD) FROM '||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION DIS, '||V_ESQUEMA||'.DD_TPH_TIPO_HABITACULO TPH 
				WHERE  DIS.DD_TPH_ID = TPH.DD_TPH_ID AND ICO.ICO_ID = DIS.ICO_ID AND TPH.DD_TPH_CODIGO = ''01'') AS NUM_DORMITORIOS,
			BIE_DAT.BIE_DREG_SUPERFICIE AS SUPERFICIE_TOTAL,
			-- AS SUPERFICIE_DEPURADA,
			ICO.ICO_ANO_CONSTRUCCION AS ANO_CONSTRUCCION,
			ECT.DD_ECT_DESCRIPCION AS ESTADO_CONSTRUCCION,
			-- AS ESTADO_COMERCIAL
			(SELECT COUNT(VIS_ID) FROM '||V_ESQUEMA||'.VIS_VISITAS VIS WHERE VIS.ACT_ID = ACT.ACT_ID) AS NUM_VISITAS,
			(SELECT COUNT(OFR_ID) FROM '||V_ESQUEMA||'.ACT_OFR AFR WHERE AFR.ACT_ID = ACT.ACT_ID) AS NUM_OFERTAS,
			-- AS INSCRIPCION,
			ACT.ACT_FECHA_REV_CARGAS AS FECHA_REV_CARGAS,
			SPS.SPS_FECHA_TOMA_POSESION AS FECHA_TOMA_POSESION,
			(CASE SPS.SPS_OCUPADO WHEN 0 THEN ''NO'' WHEN 1 THEN (CASE WHEN SPS.SPS_CON_TITULO = 1 THEN ''Ocupado con título'' ELSE ''Ocupado sin título'' END) END) AS OCUPADO,
			ICO.ICO_FECHA_ACEPTACION 	AS FECHA_PUBLICACION,
	-- VALORES
			V.VALOR_ESTIMADO_VENTA,
			V.VALOR_ESTIMADO_VENTA_F_INI AS FECHA_ESTIMADO_VENTA,
			BIE_VAL.BIE_IMPORTE_VALOR_TASACION AS VALOR_TASACION,
			BIE_VAL.BIE_FECHA_VALOR_TASACION AS FECHA_TASACION,
			V.FSV_VENTA,
			V.FSV_VENTA_F_INI,
			GREATEST(NVL2(BIE_VAL.BIE_IMPORTE_VALOR_TASACION,BIE_VAL.BIE_IMPORTE_VALOR_TASACION,0),NVL2(V.VALOR_ESTIMADO_VENTA,V.VALOR_ESTIMADO_VENTA,0),NVL2(V.FSV_VENTA,V.FSV_VENTA,0)) AS MAYOR_VALORACION,
	-- PRECIOS ACTUALES		
			V.APROBADO_VENTA_WEB,
			V.APROBADO_VENTA_WEB_F_INI,
			V.APROBADO_RENTA_WEB,
			V.APROBADO_RENTA_WEB_F_INI, 
			V.VNC,
			V.COSTE_ADIQUISICION,
			V.VALOR_ASESORADO_LIQ

		FROM '|| V_ESQUEMA ||'.ACT_ACTIVO ACT
			LEFT JOIN '|| V_ESQUEMA ||'.ACT_PAC_PROPIETARIO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID
			LEFT JOIN '|| V_ESQUEMA ||'.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = PAC.PRO_ID
			LEFT JOIN '|| V_ESQUEMA ||'.DD_STA_SUBTIPO_TITULO_ACTIVO STA ON STA.DD_STA_ID = ACT.DD_STA_ID
			LEFT JOIN '|| V_ESQUEMA ||'.ACT_AJD_ADJJUDICIAL AJD ON AJD.ACT_ID=ACT.ACT_ID
			LEFT JOIN '|| V_ESQUEMA ||'.ACT_ADN_ADJNOJUDICIAL ADN ON ADN.ACT_ID=ACT.ACT_ID
			LEFT JOIN (SELECT CAT.ACT_ID, LISTAGG(CAT.CAT_REF_CATASTRAL,'','') WITHIN GROUP (ORDER BY ACT_ID) AS CAT_REF_CATASTRAL FROM ' || V_ESQUEMA || '.ACT_CAT_CATASTRO CAT
				GROUP BY CAT.ACT_ID) CATASTRO ON CATASTRO.ACT_ID = ACT.ACT_ID
			LEFT JOIN ' || V_ESQUEMA || '.BIE_DATOS_REGISTRALES BIE_DAT ON ACT.BIE_ID = BIE_DAT.BIE_ID
			LEFT JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGA.ACT_ID = ACT.ACT_ID
			LEFT JOIN (SELECT AGR.AGR_ID, AGR.AGR_NUM_AGRUP_REM FROM ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR WHERE
				AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO=''01'')) AGR_NUEVA ON AGR_NUEVA.AGR_ID = AGA.AGR_ID
			LEFT JOIN (SELECT AGR.AGR_ID, AGR.AGR_NUM_AGRUP_REM FROM ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR WHERE
				AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO=''02'')) AGR_RES ON AGR_RES.AGR_ID = AGA.AGR_ID
			LEFT JOIN ' || V_ESQUEMA || '.DD_TPA_TIPO_ACTIVO TPA ON TPA.DD_TPA_ID = ACT.DD_TPA_ID
			LEFT JOIN ' || V_ESQUEMA || '.DD_SAC_SUBTIPO_ACTIVO SAC ON SAC.DD_SAC_ID = ACT.DD_SAC_ID
			LEFT JOIN ' || V_ESQUEMA || '.BIE_LOCALIZACION BIE_LOC ON ACT.BIE_ID = BIE_LOC.BIE_ID
			LEFT JOIN ' || V_ESQUEMA_MASTER || '.DD_TVI_TIPO_VIA TPVIA ON TPVIA.DD_TVI_ID = BIE_LOC.DD_TVI_ID
			LEFT JOIN ' || V_ESQUEMA_MASTER || '.DD_PRV_PROVINCIA PRV ON PRV.DD_PRV_ID = BIE_LOC.DD_PRV_ID
	    	LEFT JOIN ' || V_ESQUEMA_MASTER || '.DD_LOC_LOCALIDAD LOC ON LOC.DD_LOC_ID = BIE_DAT.DD_LOC_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL ICO ON ICO.ACT_ID = ACT.ACT_ID		
			LEFT JOIN '||V_ESQUEMA||'.ACT_EDI_EDIFICIO EDI ON EDI.ICO_ID = ICO.ICO_ID
			LEFT JOIN '||V_ESQUEMA||'.DD_ECT_ESTADO_CONSTRUCCION ECT ON ECT.DD_ECT_ID = ICO.DD_ECT_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_SPS_SIT_POSESORIA SPS ON SPS.ACT_ID = ACT.ACT_ID
			LEFT JOIN '||V_ESQUEMA||'.V_PIVOT_PRECIOS_ACTIVOS V ON V.ACT_ID = ACT.ACT_ID
			--LEFT JOIN (SELECT NVL2(TAS.TAS_FECHA_INI_TASACION,TAS.TAS_FECHA_INI_TASACION,TAS_FECHA_RECEPCION_TASACION) AS FECHA_TASACION, TAS.TAS_IMPORTE_TAS_FIN, TAS.ACT_ID FROM ACT_TAS_TASACION TAS ORDER BY TAS.TAS_FECHA_INI_TASACION DESC) TASA ON TASA.ACT_ID=ACT.ACT_ID AND ROWNUM=1
			LEFT JOIN '||V_ESQUEMA||'.ACT_TAS_TASACION TAS ON TAS.ACT_ID = ACT.ACT_ID
			LEFT JOIN '||V_ESQUEMA||'.BIE_VALORACIONES BIE_VAL ON BIE_VAL.BIE_VAL_ID = TAS.BIE_VAL_ID
		    RIGHT JOIN '|| V_ESQUEMA ||'.ACT_PRP ACP ON ACP.ACT_ID=ACT.ACT_ID';

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_DATOS_PROPUESTA_UNIFICADA...Creada OK');
  
END;
/

EXIT;