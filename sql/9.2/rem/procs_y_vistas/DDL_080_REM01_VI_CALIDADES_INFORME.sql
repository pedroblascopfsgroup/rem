--/*
--##########################################
--## AUTOR=ANAHUAC DE VICENTE
--## FECHA_CREACION=20170222
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-1787
--## PRODUCTO=NO
--## Finalidad: Vista Materializada exclusiva para el informeMediador que contiene las calidades enviadas a webcom.
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.    
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla. 
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    err_num NUMBER; -- N?mero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas
    V_TABLESPACE_IDX VARCHAR2(25 CHAR):= '#TABLESPACE_INDEX#'; -- Configuracion Tablespace de Indices
    V_TEXT_VISTA VARCHAR2(2400 CHAR) := 'VI_CALIDADES_INFORME'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_MSQL VARCHAR2(4000 CHAR); 
	V_COMMENT_TABLE VARCHAR2(500 CHAR):= 'Vista Materializada exclusiva para el informeMediador que contiene las calidades enviadas a webcom.'; -- Vble. para los comentarios de las tablas
    
    CUENTA NUMBER;
    
BEGIN
	

	DBMS_OUTPUT.PUT_LINE('********' ||V_TEXT_VISTA|| '********'); 
	DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TEXT_VISTA||'... Comprobaciones previas');
		
	DBMS_OUTPUT.PUT_LINE('[INFO] Verificamos si existe vista '||V_ESQUEMA||'.'||V_TEXT_VISTA||'..');	
	SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = V_TEXT_VISTA AND OWNER = V_ESQUEMA AND OBJECT_TYPE = 'MATERIALIZED VIEW';
	IF CUENTA>0 THEN
		DBMS_OUTPUT.PUT_LINE('Vista materializada: '|| V_ESQUEMA ||'.'|| V_TEXT_VISTA ||' existe, se procede a eliminarla..');
		EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.'|| V_TEXT_VISTA ||'';  
		DBMS_OUTPUT.PUT_LINE('Vista materializada borrada OK');
	END IF;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Verificamos si existe vista materializada '||V_ESQUEMA||'.'||V_TEXT_VISTA||'..');
	SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = V_TEXT_VISTA AND OWNER = V_ESQUEMA AND OBJECT_TYPE = 'VIEW';  
	IF CUENTA>0 THEN
		DBMS_OUTPUT.PUT_LINE('Vista: '|| V_ESQUEMA ||'.'|| V_TEXT_VISTA ||' existe, se procede a eliminarla..');
		EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.'|| V_TEXT_VISTA ||'';  
		DBMS_OUTPUT.PUT_LINE('Vista borrada OK');
	END IF;
  
  
 
   -- Creamos vista
	DBMS_OUTPUT.PUT_LINE('[INFO] Crear nueva vista materializada : '|| V_ESQUEMA ||'.'|| V_TEXT_VISTA ||'..');
  	EXECUTE IMMEDIATE 'CREATE VIEW ' || V_ESQUEMA || '.'|| V_TEXT_VISTA ||' 
	AS
		SELECT 
			ICO.ICO_ID,
			EDI.EDI_DIVISIBLE AS DIVISIBLE,
			EDI.EDI_ASCENSOR AS ASCENSOR,
			EDI.EDI_NUM_ASCENSORES AS NUMERO_ASCENSORES,
			EDI.EDI_DESC_PLANTAS AS DESCRIPCION_PLANTAS,
			EDI.EDI_OTRAS_CARACTERISTICAS AS OTRAS_CARACTERISTICAS,
			EDI.EDI_REFORMA_FACHADA AS FACHADA_REFORMAS_NECESARIAS,
			EDI.EDI_REFORMA_ESCALERA AS ESCALERA_REFORMAS_NECESARIAS,
			EDI.EDI_REFORMA_PORTAL AS PORTAL_REFORMAS_NECESARIAS,
			EDI.EDI_REFORMA_ASCENSOR AS ASCENSOR_REFORMAS_NECESARIAS,
			EDI.EDI_REFORMA_CUBIERTA AS CUBIERTA,
			EDI.EDI_REFORMA_OTRA_ZONA AS OTRAS_ZNC_REFORMAS_NECESARIAS,
			EDI.EDI_REFORMA_OTRO_DESC AS OTRAS_REFORMAS_NECESARIAS,
			EDI.EDI_DESCRIPCION AS DESCRIPCION_EDIFICIO,
			EDI.EDI_ENTORNO_INFRAESTRUCTURA AS INFRAESTRUCTURAS_ENTORNO,
			EDI.EDI_ENTORNO_COMUNICACION AS COMUNICACIONES_ENTORNO,	
			DDECV.DD_ECV_CODIGO AS ESTADO_CONSERVACION_EDI,
			(SELECT DIS.DIS_DESCRIPCION
				FROM '||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION DIS
				INNER JOIN '||V_ESQUEMA||'.DD_TPH_TIPO_HABITACULO TPH ON TPH.DD_TPH_ID = DIS.DD_TPH_ID
				WHERE DIS.ICO_ID = ICO.ICO_ID AND DIS.DIS_NUM_PLANTA = 0 AND TPH.DD_TPH_CODIGO = ''11'') AS ANEJO_TRASTERO,
			(SELECT DIS.DIS_DESCRIPCION
				FROM '||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION DIS
				INNER JOIN '||V_ESQUEMA||'.DD_TPH_TIPO_HABITACULO TPH ON TPH.DD_TPH_ID = DIS.DD_TPH_ID
				WHERE DIS.ICO_ID = ICO.ICO_ID AND DIS.DIS_NUM_PLANTA = 0 AND TPH.DD_TPH_CODIGO = ''12'') AS ANEJO_GARAGE,
			(SELECT SUP.MTS_GARAJES
				FROM '||V_ESQUEMA||'.VI_PIVOT_SUP_DISTRIBUCION SUP
				WHERE SUP.ICO_ID = ICO.ICO_ID) AS SUPERFICIE_PLAZAS_GARAJE,
			NULL AS COD_SUBTIPO_PLAZAS_GARAJE,
			INS.INS_ELECTR_BUEN_ESTADO	AS BUEN_EST_INST_ELECT_INST,
			INS.INS_ELECTR_CON_CONTADOR AS BUEN_EST_CONT_ELECT_INST,
			INS.INS_AGUA_BUEN_ESTADO AS BUEN_EST_INST_AGUA_INST,
			INS.INS_AGUA_CON_CONTADOR AS BUEN_EST_CONT_AGUA_INST,
			INS.INS_GAS_INST_BUEN_ESTADO AS BUEN_EST_INST_GAS_INST,
			INS.INS_GAS_CON_CONTADOR AS BUEN_EST_CONT_GAS_INST,
			DDECV.DD_ECV_CODIGO AS COD_ESTADO_CONSERVACION,
			ICO.ICO_ANO_REHABILITACION AS ANYO_REHABILITACION_EDIFICIO,
			EDI.EDI_NUM_PLANTAS AS NUMERO_PLANTAS_EDIFICIO,
			EDI.EDI_ASCENSOR AS ASCENSOR_EDIFICIO,
			EDI.EDI_NUM_ASCENSORES AS NUMERO_ASCENSORES_EDIFICIO,
			ICO.ICO_CUOTACP_ORIENTATIVA AS CUOTA_COMUNIDAD_EDIFICIO,
			ICO.ICO_DERRAMACP_ORIENTATIVA AS DESC_DERRAMA_COM_EDIFICIO,
			EDI.EDI_REFORMA_FACHADA AS FACHADA_REFORMAS_NEC_EDI,
			EDI.EDI_REFORMA_ESCALERA AS ESCALERA_REFORMAS_NEC_EDI,
			EDI.EDI_REFORMA_PORTAL AS PORTAL_REFORMAS_NEC_EDI,
			EDI.EDI_REFORMA_ASCENSOR AS ASCENSOR_REFORMAS_NEC_EDI,
			EDI.EDI_REFORMA_CUBIERTA AS CUBIERTA_REFORMAS_NEC_EDI,
			EDI.EDI_REFORMA_OTRA_ZONA AS OTRAS_ZCO_REFORMAS_NEC_EDI,
			EDI.EDI_REFORMA_OTRO_DESC AS OTRAS_REFORMAS_NEC_EDI,
			EDI.EDI_ENTORNO_INFRAESTRUCTURA AS INFRAESTRUCTURAS_ENTORNO_EDI,
			EDI.EDI_ENTORNO_COMUNICACION  AS COMUNICACIONES_ENTORNO_EDI,
			INF.INF_OCIO AS EXISTE_OCIO,
			INF.INF_HOTELES AS EXISTEN_HOTELES,
			INF.INF_HOTELES_DESC AS HOTELES,
			INF.INF_TEATROS AS EXISTEN_TEATROS,
			INF.INF_TEATROS_DESC AS TEATROS,
			INF.INF_SALAS_CINE AS EXISTEN_SALAS_DE_CINE,
			INF.INF_SALAS_CINE_DESC AS SALAS_DE_CINE,
			INF.INF_INST_DEPORT AS EXISTEN_INST_DEPORTIVAS,
			INF.INF_INST_DEPORT_DESC AS INST_DEPORTIVAS,
			INF.INF_CENTROS_COMERC AS EXISTEN_CENTROS_COMERCIALES,
			INF.INF_CENTROS_COMERC_DESC AS CENTROS_COMERCIALES,
			INF.INF_OCIO_OTROS AS OTROS_OCIO,
			INF.INF_CENTROS_EDU AS EXISTEN_CENTROS_EDUCATIVOS,
			INF.INF_ESCUELAS_INF AS EXISTEN_ESCUELAS_INFANTILES,
			INF.INF_ESCUELAS_INF_DESC AS ESCUELAS_INFANTILES,
			INF.INF_COLEGIOS AS EXISTEN_COLEGIOS,
			INF.INF_COLEGIOS_DESC AS COLEGIOS,
			INF.INF_INSTITUTOS  AS EXISTEN_INSTITUTOS,
			INF.INF_INSTITUTOS_DESC AS INSTITUTOS,
			INF.INF_UNIVERSIDADES  AS EXISTEN_UNIVERSIDADES,
			INF.INF_UNIVERSIDADES_DESC AS UNIVERSIDADES,
			INF.INF_CENTROS_EDU_OTROS  AS OTROS_CENTROS_EDUCATIVOS,
			INF.INF_CENTROS_SANIT AS EXISTEN_CENTROS_SANITARIOS,
			INF.INF_CENTROS_SALUD  AS EXISTEN_CENTROS_DE_SALUD,
			INF.INF_CENTROS_SALUD_DESC  AS CENTROS_DE_SALUD,
			INF.INF_CLINICAS AS EXISTEN_CLINICAS,
			INF.INF_CLINICAS_DESC AS CLINICAS,
			INF.INF_HOSPITALES AS EXISTEN_HOSPITALES,
			INF.INF_HOSPITALES_DESC AS HOSPITALES,
			CASE WHEN (INF.INF_CENTROS_SANIT_OTROS IS NOT NULL) 
				THEN ''1''
				ELSE ''0''
			END EXISTEN_OTROS_CENTROS_SANIT,
			INF.INF_CENTROS_SANIT_OTROS AS OTROS_CENTROS_SANITARIOS,
			INF.INF_PARKING_SUP_SUF AS SUFI_APARCAMIENTO_SUPERFICIE,
			INF.INF_COMUNICACIONES AS EXISTEN_COMUNICACIONES,
			INF.INF_FACIL_ACCESO AS EXISTE_FACIL_ACCESO_CARRETERA,
			INF.INF_FACIL_ACCESO_DESC AS FACIL_ACCESO_POR_CARRETERA,
			INF.INF_LINEAS_BUS  AS EXISTE_LINEAS_DE_AUTOBUS,
			INF.INF_LINEAS_BUS_DESC AS LINEAS_DE_AUTOBUS,
			INF.INF_METRO AS EXISTE_METRO,
			INF.INF_METRO_DESC AS METRO,
			INF.INF_EST_TREN AS EXISTE_ESTACIONES_DE_TREN,
			INF.INF_EST_TREN_DESC AS ESTACIONES_DE_TREN,
			INF.INF_COMUNICACIONES_OTRO AS OTROS_COMUNICACIONES,
			CRI.CRI_PTA_ENT_NORMAL AS BUEN_ESTADO_PTA_ENT_NORMAL,
			CRI.CRI_PTA_ENT_BLINDADA AS BUEN_ESTADO_PTA_ENT_BLINDADA,
			CRI.CRI_PTA_ENT_ACORAZADA AS BUEN_ESTADO_PTA_ENT_ACORAZADA,
			CRI.CRI_PTA_PASO_MACIZAS AS BUEN_ESTADO_PTA_PASO_MACIZA,
			CRI.CRI_PTA_PASO_HUECAS AS BUEN_ESTADO_PTA_PASO_HUECA,
			CRI.CRI_PTA_PASO_LACADAS AS BUEN_ESTADO_PTA_PASO_LACADA,
			CRI.CRI_ARMARIOS_EMPOTRADOS AS EXISTEN_ARMARIOS_EMPOTRADOS,
			CRI.DD_ACR_ID AS COD_ACABADO_CARPINTERIA,
			CRI.CRI_CRP_INT_OTROS  AS OTROS_CARPINTERIA_INTERIOR,
			CRE.CRE_VTNAS_HIERRO AS BUEN_ESTADO_VENTANA_HIERRO,
			CRE.CRE_VTNAS_ALU_ANODIZADO AS BUEN_ESTADO_VENTANA_ANODIZADO,
			CRE.CRE_VTNAS_ALU_LACADO AS BUEN_ESTADO_VENTANA_LACADO,
			CRE.CRE_VTNAS_PVC AS BUEN_ESTADO_VENTANA_PVC,
			CRE.CRE_VTNAS_MADERA AS BUEN_ESTADO_VENTANA_MADERA,
			CRE.CRE_PERS_PLASTICO  AS BUEN_ESTADO_PERSIANA_PLASTICO,
			CRE.CRE_PERS_ALU AS BUEN_ESTADO_PERSIANA_ALUMINIO,
			CRE.CRE_VTNAS_CORREDERAS AS BUEN_ESTADO_VTNAS_CORREDERAS,
			CRE.CRE_VTNAS_ABATIBLES AS BUEN_ESTADO_VTNAS_ABATIBLES,
			CRE.CRE_VTNAS_OSCILOBAT AS BUEN_ESTADO_VTNAS_OSCILOBAT,
			CRE.CRE_EST_DOBLE_CRISTAL AS BUEN_ESTADO_DOBLE_CRISTAL,
			CRE.CRE_CRP_EXT_OTROS AS OTROS_CARPINTERIA_EXTERIOR,
			PRV.PRV_HUMEDAD_PARED AS HUMEDADES_PARED,
			PRV.PRV_HUMEDAD_TECHO AS HUMEDADES_TECHO,
			PRV.PRV_GRIETA_PARED AS GRIETAS_PARED,
			PRV.PRV_GRIETA_TECHO AS GRIETAS_TECHO,
			PRV.PRV_GOTELE AS ESTADO_PINTURA_PAREDES_GOTELE,
			PRV.PRV_PLASTICA_LISA AS ESTADO_PINTURA_PAREDES_LISA,
			PRV.PRV_PAPEL_PINTADO AS ESTADO_PINTURA_PAREDES_PINTADO,
			PRV.PRV_PINTURA_GOTELE_TECHO_EST AS ESTADO_PINTURA_TECHO_GOTELE,
			PRV.PRV_PINTURA_LISA_TECHO_EST AS ESTADO_PINTURA_TECHO_LISA,
			PRV.PRV_PINTURA_PAPEL_TECHO_EST AS ESTADO_PINTURA_TECHO_PINTADO,
			PRV.PRV_MOLDURA_ESCAYOLA_EST AS ESTADO_MOLDURA_ESCAYOLA,
			PRV.PRV_PARAMENTOS_OTROS AS OTROS_PARAMENTOS_VERTICALES,
			SOL.SOL_TARIMA_FLOTANTE AS ESTADO_TARIMA_FLOTANTE_SOLADOS,
			SOL.SOL_PARQUE AS ESTADO_PARQUE_SOLADOS,
			SOL.SOL_MARMOL AS ESTADO_MARMOL_SOLADOS,
			SOL.SOL_PLAQUETA AS ESTADO_PLAQUETA_SOLADOS,
			SOL.SOL_SOLADO_OTROS AS OTROS_SOLADOS,
			COC.COC_AMUEBLADA_EST AS ESTADO_COCINA_AMUEBLADA_COCINA,
			COC.COC_ENCI_GRANITO AS ESTADO_ENCIMERA_GRANITO_COCINA,
			COC.COC_ENCI_MARMOL AS ESTADO_ENCIMERA_MARMOL_COCINA,
			COC.COC_ENCI_OTRO_MATERIAL AS ESTADO_ENCIMERA_MATERIAL_COC,
			COC.COC_VITRO AS ESTADO_VITROCERAMICA_COCINA,
			COC.COC_LAVADORA AS ESTADO_LABADORA_COCINA,
			COC.COC_FRIGORIFICO AS ESTADO_FRIGORIFICO_COCINA,
			COC.COC_LAVAVAJILLAS AS ESTADO_LAVAVAJILLAS_COCINA,
			COC.COC_MICROONDAS AS ESTADO_MICROONDAS_COCINA,
			COC.COC_HORNO AS ESTADO_HORNO_COCINA,
			COC.COC_SUELOS AS ESTADO_SUELO_COCINA,
			COC.COC_AZULEJOS_EST AS ESTADO_AZULEJOS_COCINA,
			COC.COC_GRIFOS_MONOMANDO_EST AS ESTADO_GRIFERIA_MONOMANDO_COC,
			COC.COC_COCINA_OTROS AS OTROS_COCINA,    
			BNY.BNY_DUCHA AS ESTADO_DUCHA_BNY,
			BNY.BNY_BANYERA AS ESTADO_BANYERA_NORMAL_BNY,
			BNY.BNY_BANYERA_HIDROMASAJE AS ESTADO_BANYERA_HIDROMASAJE_BNY,
			BNY.BNY_COLUMNA_HIDROMASAJE AS ESTADO_COLUMNA_HIDROMASAJE_BNY,
			BNY.BNY_ALICATADO_MARMOL AS ESTADO_ALICATADO_MARMOL_BNY,
			BNY.BNY_ALICATADO_GRANITO AS ESTADO_ALICATADO_GRANITO_BNY,
			BNY.BNY_ALICATADO_AZULEJO AS ESTADO_ALICATADO_AZULEJO_BNY,
			BNY.BNY_MARMOL AS ESTADO_ENCIMERA_MARMOL_BNY,
			BNY.BNY_GRANITO AS ESTADO_ENCIMERA_GRANITO_BNY,
			BNY.BNY_OTRO_MATERIAL AS ESTADO_ENCIMERA_MATERIAL_BNY,
			BNY.BNY_SANITARIOS_EST AS ESTADO_SANITARIOS_BNY,
			BNY.BNY_SUELOS AS ESTADO_SUELO_BNY,
			BNY.BNY_GRIFO_MONOMANDO_EST AS ESTADO_GRIFERIA_MONOMANDO_BNY,
			BNY.BNY_BANYO_OTROS AS OTROS_BANYO,
			INS.INS_ELECTR_BUEN_ESTADO AS ESTADO_INS_ELECTR,
			INS.INS_ELECTR_DEFECTUOSA_ANTIGUA	AS INS_ELECTR_ANTIGUA_DEFECTUOSA,
			INS.INS_CALEF_GAS_NATURAL AS EXISTE_CALEFACCION_GAS_NATURAL,
			INS.INS_CALEF_RADIADORES_ALU AS EXISTEN_RADIADORES_DE_ALUMINIO,
			INS.INS_AGUA_CALIENTE_CENTRAL AS EXISTE_AGUA_CALIENTE_CENTRAL,
			INS.INS_AGUA_CALIENTE_GAS_NATURAL AS EXISTE_AGUA_CALIENTE_GAS_NAT,
			INS.INS_AIRE_PREINSTALACION AS EXISTE_AIRE_PREINSTALACION,
			INS.INS_AIRE_INSTALACION AS EXISTE_AIRE_INSTALACION,
			INS.INS_AIRE_FRIO_CALOR AS EXISTE_AIRE_CALOR,
			INS.INS_INST_OTROS AS OTROS_INSTALACIONES,
			ZCO.ZCO_JARDINES AS EXISTEN_JARDINES_ZONAS_VERDES,
			ZCO.ZCO_PISCINA AS EXISTE_PISCINA,
			ZCO.ZCO_PADEL AS EXISTE_PISTA_PADEL,
			ZCO.ZCO_TENIS AS EXISTE_PISTA_TENIS,
			ZCO.ZCO_PISTA_POLIDEP AS EXISTE_PISTA_POLIDEPORTIVA,
			ZCO.ZCO_GIMNASIO AS EXISTE_GIMNASIO,
			ZCO.ZCO_OTROS AS OTROS_INSTALACIONES_DEPORTIVAS,
			ZCO.ZCO_ZONA_INFANTIL AS EXISTE_ZONA_INFANTIL,
			ZCO.ZCO_CONSERJE_VIGILANCIA AS EXISTE_CONSERJE_VIGILANCIA,
			ZCO.ZCO_ZONA_COMUN_OTROS AS OTROS_ZONAS_COMUNES
			FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL ICO
			LEFT JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = ICO.ACT_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_EDI_EDIFICIO EDI ON EDI.ICO_ID = ICO.ICO_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_INS_INSTALACION INS ON INS.ICO_ID = ICO.ICO_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_INF_INFRAESTRUCTURA INF ON INF.ICO_ID = ICO.ICO_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_CRI_CARPINTERIA_INT CRI ON CRI.ICO_ID = ICO.ICO_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_CRE_CARPINTERIA_EXT CRE ON CRE.ICO_ID = ICO.ICO_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_PRV_PARAMENTO_VERTICAL PRV ON PRV.ICO_ID = ICO.ICO_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_SOL_SOLADO SOL ON SOL.ICO_ID = ICO.ICO_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_COC_COCINA COC ON COC.ICO_ID = ICO.ICO_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_BNY_BANYO BNY ON BNY.ICO_ID = ICO.ICO_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_ZCO_ZONA_COMUN ZCO ON ZCO.ICO_ID = ICO.ICO_ID
			LEFT JOIN '||V_ESQUEMA||'.DD_ECV_ESTADO_CONSERVACION DDECV ON DDECV.DD_ECV_ID = EDI.DD_ECV_ID
			where act.borrado = 0';

 	DBMS_OUTPUT.PUT_LINE('[INFO] Vista materializada : '|| V_ESQUEMA ||'.'|| V_TEXT_VISTA ||'... creada');
 		
 		
 	--Creamos indice
    --V_MSQL := 'CREATE UNIQUE INDEX '||V_ESQUEMA||'.'||V_TEXT_VISTA||'_IDX ON '||V_ESQUEMA|| '.'||V_TEXT_VISTA||'(ICO_ID) TABLESPACE '||V_TABLESPACE_IDX;		
	--EXECUTE IMMEDIATE V_MSQL;
	--DBMS_OUTPUT.PUT_LINE('[INFO] ' ||V_ESQUEMA||'.'||V_TEXT_VISTA||'_IDX... Indice creado.');
	
	
    -- Creamos comentario	
	--V_MSQL := 'COMMENT ON MATERIALIZED VIEW '||V_ESQUEMA||'.'||V_TEXT_VISTA||' IS '''||V_COMMENT_TABLE||'''';		
	--EXECUTE IMMEDIATE V_MSQL;
	--DBMS_OUTPUT.PUT_LINE('[INFO] ' ||V_ESQUEMA||'.'||V_TEXT_VISTA||'... Comentario creado.');

	COMMIT;


EXCEPTION
     WHEN OTHERS THEN 
         DBMS_OUTPUT.PUT_LINE('KO!');
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;
/

EXIT;