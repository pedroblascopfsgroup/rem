--/*
--##########################################
--## AUTOR=Carles Molins
--## FECHA_CREACION=20190702
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-4668
--## PRODUCTO=NO
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

-- Vista para recoger los valroes a tener en cuenta en el RATING de los activos

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.    
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- Número de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas
    V_MSQL VARCHAR2(4000 CHAR); 

    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_DATOS_RATING_ACTIVOS' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_DATOS_RATING_ACTIVOS...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.V_DATOS_RATING_ACTIVOS';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_DATOS_RATING_ACTIVOS... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_DATOS_RATING_ACTIVOS' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_DATOS_RATING_ACTIVOS...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.V_DATOS_RATING_ACTIVOS';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_DATOS_RATING_ACTIVOS... borrada OK');
  END IF;

  DBMS_OUTPUT.PUT_LINE('CREATING VIEW '|| V_ESQUEMA ||'.V_DATOS_RATING_ACTIVOS...');
  EXECUTE IMMEDIATE 'CREATE VIEW ' || V_ESQUEMA || '.V_DATOS_RATING_ACTIVOS 
	AS
	SELECT
		ACT.ACT_ID,
  -- ENTORNO
		NVL(DDTPR.DD_TPR_CODIGO,''02'') AS DD_TPR_CODIGO, -- nivel de renta (Si no viene informado, por defecto es nivel MEDIO)
		NVL(INF.INF_HOTELES,0) AS INF_HOTELES,
		NVL(INF.INF_TEATROS,0) AS INF_TEATROS,
		NVL(INF.INF_SALAS_CINE,0) AS INF_SALAS_CINE,
		NVL(INF.INF_INST_DEPORT,0) AS INF_INST_DEPORT,
		NVL(INF.INF_CENTROS_COMERC,0) AS INF_CENTROS_COMERC,
      	(CASE INF.INF_ESCUELAS_INF WHEN 1 THEN 1 ELSE
        	(CASE INF.INF_COLEGIOS WHEN 1 THEN 1 ELSE 
          	(CASE INF.INF_INSTITUTOS WHEN 1 THEN 1 ELSE 
            (CASE INF.INF_UNIVERSIDADES WHEN 1 THEN 1 ELSE NVL2(INF_CENTROS_EDU_OTROS,1,0) END)END)END)END) AS INF_CENTROS_EDU,
      	(CASE INF.INF_CENTROS_SALUD WHEN 1 THEN 1 ELSE 
        	(CASE INF.INF_CLINICAS WHEN 1 THEN 1 ELSE 
          	(CASE INF.INF_HOSPITALES WHEN 1 THEN 1 ELSE NVL2(INF_CENTROS_SANIT_OTROS,1,0) END)END)END) AS INF_CENTROS_SANIT,
      	CASE INF.INF_PARKING_SUP_SUF WHEN 1 THEN 1 ELSE 0 END AS INF_PARKING_SUP_SUF,
    	--AS INF_PARKING_SUP_SUF, PARKING INSUFICIENTE, NO EXISTE ESTE CAMPO
      	NVL(INF.INF_FACIL_ACCESO,0) AS INF_FACIL_ACCESO,
      	NVL(INF.INF_LINEAS_BUS,0) AS INF_LINEAS_BUS,
      	NVL(INF.INF_METRO,0) AS INF_METRO,
      	NVL(INF.INF_EST_TREN,0) AS INF_EST_TREN,
  -- EDIFICIO
      	(CASE EDI.EDI_REFORMA_FACHADA WHEN 1 THEN 1 ELSE 
        	(CASE EDI.EDI_REFORMA_ESCALERA WHEN 1 THEN 1 ELSE 
          	(CASE EDI.EDI_REFORMA_PORTAL WHEN 1 THEN 1 ELSE 
            (CASE EDI.EDI_REFORMA_ASCENSOR WHEN 1 THEN 1 ELSE 
            (CASE EDI.EDI_REFORMA_CUBIERTA WHEN 1 THEN 1 ELSE 
            (CASE EDI.EDI_REFORMA_OTRA_ZONA WHEN 1 THEN 1 ELSE NVL(EDI_REFORMA_OTRO,0) END)END)END)END)END)END) AS EDI_PREVISIBLE_REHAB,
      	(CASE WHEN DDECV.DD_ECV_CODIGO IN (''01'',''02'') THEN 1 ELSE 0 END) AS EDI_BUEN_ESTADO, 
      	(CASE WHEN INSTR(ICO.ICO_PLANTA,''PB'') > 0 THEN 1 ELSE 0 END) AS EDI_BAJO,
      	NVL(EDI.EDI_ASCENSOR,0) AS EDI_ASCENSOR,
      	(CASE WHEN DDSAC.DD_SAC_CODIGO IN (''05'',''06'',''07'',''08'') THEN 1 ELSE 0 END) AS EDI_VIVIENDA_UNIFAMILIAR, 
      	NVL(ZCO.ZCO_JARDINES,0) AS ZCO_JARDINES,
      	NVL(ZCO.ZCO_PISCINA,0) AS ZCO_PISCINA,
      	NVL(ZCO.ZCO_INST_DEP,0) AS ZCO_INST_DEP,
      	NVL(ZCO.ZCO_ZONA_INFANTIL,0) AS ZCO_ZONA_INFANTIL,
      	NVL(ZCO.ZCO_CONSERJE_VIGILANCIA,0) AS ZCO_CONSERJE_VIGILANCIA,
      	NVL(ZCO.ZCO_GIMNASIO,0) AS ZCO_GIMNASIO,
  -- CARPINTERIA INTERIOR Y EXTERIOR
      	NVL(CRI.CRI_PTA_ENT_BLINDADA,0) AS CRI_PTA_ENT_BLINDADA,
      	NVL(CRI.CRI_PTA_ENT_ACORAZADA,0) AS CRI_PTA_ENT_ACORAZADA,
      	NVL(CRI.CRI_PTA_PASO_MACIZAS,0) AS CRI_PTA_PASO_MACIZAS,
      	NVL(CRI.CRI_PTA_PASO_HUECAS,0) AS CRI_PTA_PASO_HUECAS,
      	(CASE WHEN CRI.CRI_ARMARIOS_EMPOTRADOS = 1 AND DDACR.DD_ACR_CODIGO = ''01'' THEN 1 ELSE 0 END) AS CRI_ARMARIOS_ACABADO_ALTO,
      	(CASE WHEN CRI.CRI_ARMARIOS_EMPOTRADOS = 1 AND DDACR.DD_ACR_CODIGO != ''01'' THEN 1 ELSE 0 END) AS CRI_ARMARIOS_ACABADO_BAJO,
      	NVL(CRE.CRE_VTNAS_ALU_ANODIZADO,0) AS CRE_VTNAS_ALU_ANODIZADO,
      	NVL(CRE.CRE_VTNAS_ALU_LACADO,0) AS CRE_VTNAS_ALU_LACADO,
      	NVL(CRE.CRE_PERS_ALU,0) AS CRE_PERS_ALU,
      	NVL(CRE.CRE_VTNAS_CORREDERAS,0) AS CRE_VTNAS_CORREDERAS,
      	NVL(CRE.CRE_VTNAS_ABATIBLES,0) AS CRE_VTNAS_ABATIBLES,
      	NVL(CRE.CRE_VTNAS_OSCILOBAT,0) AS CRE_VTNAS_OSCILOBAT,
      	NVL(CRE.CRE_DOBLE_CRISTAL,0) AS CRE_DOBLE_CRISTAL,
  -- PARAMENTOS VERTICALES Y SOLADOS
      	NVL(PRV.PRV_HUMEDAD_PARED,0) AS PRV_HUMEDAD_PARED,
      	NVL(PRV.PRV_HUMEDAD_TECHO,0) AS PRV_HUMEDAD_TECHO,
      	NVL(PRV.PRV_GOTELE,0) AS PRV_GOTELE,
      	NVL(PRV.PRV_PLASTICA_LISA,0) AS PRV_PLASTICA_LISA,
      	NVL(PRV.PRV_PAPEL_PINTADO,0) AS PRV_PAPEL_PINTADO,
      	NVL(PRV.PRV_PINTURA_LISA_TECHO,0) AS PRV_PINTURA_LISA_TECHO,
      	NVL(PRV.PRV_MOLDURA_ESCAYOLA,0) AS PRV_MOLDURA_ESCAYOLA,
      	NVL(SOL.SOL_TARIMA_FLOTANTE,0) AS SOL_TARIMA_FLOTANTE,
      	NVL(SOL.SOL_PARQUE,0) AS SOL_PARQUE,
      	NVL(SOL.SOL_MARMOL,0) AS SOL_MARMOL,
      	NVL(SOL.SOL_PLAQUETA,0) AS SOL_PLAQUETA,
  -- COCINA
      	NVL(COC.COC_AMUEBLADA,0) AS COC_AMUEBLADA,
      	NVL(COC.COC_ENCI_GRANITO,0) AS COC_ENCI_GRANITO,
      	NVL(COC.COC_ENCI_MARMOL,0) AS COC_ENCI_MARMOL,
      	NVL(COC.COC_ENCI_OTRO_MATERIAL,0) AS COC_ENCI_OTRO_MATERIAL,
      	NVL(COC.COC_VITRO,0) AS COC_VITRO,
      	NVL(COC.COC_LAVADORA,0) AS COC_LAVADORA,
      	NVL(COC.COC_FRIGORIFICO,0) AS COC_FRIGORIFICO,
      	NVL(COC.COC_LAVAVAJILLAS,0) AS COC_LAVAVAJILLAS,
      	NVL(COC.COC_MICROONDAS,0) AS COC_MICROONDAS,
      	NVL(COC.COC_HORNO,0) AS COC_HORNO,
      	NVL(COC.COC_AZULEJOS_EST,0) AS COC_AZULEJOS_EST,
      	NVL(COC.COC_SUELOS,0) AS COC_SUELOS,
      	NVL(COC.COC_GRIFOS_MONOMANDO,0) AS COC_GRIFOS_MONOMANDO,
  -- BANYO
      	NVL(BNY.BNY_BANYERA_HIDROMASAJE,0) AS BNY_BANYERA_HIDROMASAJE,
      	NVL(BNY.BNY_COLUMNA_HIDROMASAJE,0) AS BNY_COLUMNA_HIDROMASAJE,
      	NVL(BNY.BNY_ALICATADO_MARMOL,0) AS BNY_ALICATADO_MARMOL,
      	NVL(BNY.BNY_ALICATADO_GRANITO,0) AS BNY_ALICATADO_GRANITO,
      	NVL(BNY.BNY_ALICATADO_AZULEJO,0) AS BNY_ALICATADO_AZULEJO,
      	NVL(BNY.BNY_GRANITO,0) AS BNY_GRANITO,
      	NVL(BNY.BNY_MARMOL,0) AS BNY_MARMOL,
      	NVL(BNY.BNY_OTRO_MATERIAL,0) AS BNY_OTRO_MATERIAL,
      	NVL(BNY.BNY_SANITARIOS_EST,0) AS BNY_SANITARIOS_EST,
      	NVL(BNY.BNY_SUELOS,0) AS BNY_SUELOS,
      	NVL(BNY.BNY_GRIFO_MONOMANDO,0) AS BNY_GRIFO_MONOMANDO,
  -- INSTALACIONES
      	NVL(INS.INS_ELECTR_BUEN_ESTADO,0) AS INS_ELECTR_BUEN_ESTADO,
      	NVL(INS.INS_ELECTR_DEFECTUOSA_ANTIGUA,0) AS INS_ELECTR_DEFECTUOSA_ANTIGUA,
      	NVL(INS.INS_CALEF_CENTRAL,0) AS INS_CALEF_CENTRAL,
      	NVL(INS.INS_CALEF_GAS_NATURAL,0) AS INS_CALEF_GAS_NATURAL,
      	NVL(INS.INS_CALEF_RADIADORES_ALU,0) AS INS_CALEF_RADIADORES_ALU,
      	NVL(INS.INS_AGUA_CALIENTE_CENTRAL,0) AS INS_AGUA_CALIENTE_CENTRAL,
      	NVL(INS.INS_AIRE_PREINSTALACION,0) AS INS_AIRE_PREINSTALACION,
      	NVL(INS.INS_AIRE_INSTALACION,0) AS INS_AIRE_INSTALACION
      
	FROM ' || V_ESQUEMA || '.ACT_ACTIVO ACT
		LEFT JOIN ' || V_ESQUEMA || '.ACT_ICO_INFO_COMERCIAL ICO ON ACT.ACT_ID = ICO.ACT_ID
		LEFT JOIN ' || V_ESQUEMA || '.ACT_VIV_VIVIENDA VIV ON ICO.ICO_ID = VIV.ICO_ID
		LEFT JOIN ' || V_ESQUEMA || '.ACT_INF_INFRAESTRUCTURA INF ON ICO.ICO_ID = INF.ICO_ID
    	LEFT JOIN ' || V_ESQUEMA || '.ACT_EDI_EDIFICIO EDI ON ICO.ICO_ID = EDI.ICO_ID
      	LEFT JOIN ' || V_ESQUEMA || '.ACT_ZCO_ZONA_COMUN ZCO ON ICO.ICO_ID = ZCO.ICO_ID
      	LEFT JOIN ' || V_ESQUEMA || '.ACT_CRI_CARPINTERIA_INT CRI ON ICO.ICO_ID = CRI.ICO_ID
      	LEFT JOIN ' || V_ESQUEMA || '.ACT_CRE_CARPINTERIA_EXT CRE ON ICO.ICO_ID = CRE.ICO_ID
      	LEFT JOIN ' || V_ESQUEMA || '.ACT_PRV_PARAMENTO_VERTICAL PRV ON ICO.ICO_ID = PRV.ICO_ID
      	LEFT JOIN ' || V_ESQUEMA || '.ACT_SOL_SOLADO SOL ON ICO.ICO_ID = SOL.ICO_ID
      	LEFT JOIN ' || V_ESQUEMA || '.ACT_COC_COCINA COC ON ICO.ICO_ID = COC.ICO_ID
      	LEFT JOIN ' || V_ESQUEMA || '.ACT_BNY_BANYO BNY ON ICO.ICO_ID = BNY.ICO_ID
      	LEFT JOIN ' || V_ESQUEMA || '.ACT_INS_INSTALACION INS ON ICO.ICO_ID = INS.ICO_ID

		LEFT JOIN ' || V_ESQUEMA || '.DD_TPR_TIPO_RENTA DDTPR ON VIV.DD_TPR_ID = DDTPR.DD_TPR_ID
      	LEFT JOIN ' || V_ESQUEMA || '.DD_SAC_SUBTIPO_ACTIVO DDSAC ON ACT.DD_SAC_ID = DDSAC.DD_SAC_ID
      	LEFT JOIN ' || V_ESQUEMA || '.DD_ECV_ESTADO_CONSERVACION DDECV ON EDI.DD_ECV_ID = DDECV.DD_ECV_ID
      	LEFT JOIN ' || V_ESQUEMA || '.DD_ACR_ACABADO_CARPINTERIA DDACR ON CRI.DD_ACR_ID = DDACR.DD_ACR_ID
    where act.borrado = 0
	';
		    

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_DATOS_RATING_ACTIVOS...Creada OK');
  
END;
/

EXIT;