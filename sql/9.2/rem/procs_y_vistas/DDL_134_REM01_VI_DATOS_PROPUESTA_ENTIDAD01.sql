--/*
--##########################################
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20200826
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.19
--## INCIDENCIA_LINK=REMVIP-7935
--## PRODUCTO=NO
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##		0.2 Juan Bautista Alfonso - - REMVIP-7935 - Modificado fecha posesion para que cargue de la vista V_FECHA_POSESION_ACTIVO
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.    
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- Número de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas
    V_MSQL VARCHAR2(4000 CHAR); 

    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_DATOS_PROPUESTA_ENTIDAD01' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_DATOS_PROPUESTA_ENTIDAD01...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.V_DATOS_PROPUESTA_ENTIDAD01';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_DATOS_PROPUESTA_ENTIDAD01... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_DATOS_PROPUESTA_ENTIDAD01' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_DATOS_PROPUESTA_ENTIDAD01...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.V_DATOS_PROPUESTA_ENTIDAD01';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_DATOS_PROPUESTA_ENTIDAD01... borrada OK');
  END IF;

  DBMS_OUTPUT.PUT_LINE('CREATING VIEW '|| V_ESQUEMA ||'.V_DATOS_PROPUESTA_ENTIDAD01...');
  EXECUTE IMMEDIATE 'CREATE VIEW ' || V_ESQUEMA || '.V_DATOS_PROPUESTA_ENTIDAD01 
	AS
		WITH OBRA_NUEVA AS (
		  SELECT AGA_ON.ACT_ID, AGR_ON.AGR_ID, AGR_ON.AGR_NUM_AGRUP_REM, AGR_ON.AGR_NOMBRE 
		                FROM '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR_ON 
		                JOIN '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO AGA_ON 
		                  ON AGA_ON.AGR_ID = AGR_ON.AGR_ID
		                WHERE AGR_ON.DD_TAG_ID = (SELECT DD_TAG_ID FROM '||V_ESQUEMA||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO=''01'')
		)
		SELECT
			ACT.ACT_ID,
			ACP.PRP_ID,
			CRA.DD_CRA_CODIGO AS CARTERA_CODIGO,
			
			PRO.PRO_NOMBRE  || '' '' || PRO.PRO_APELLIDO1 || '' '' || PRO.PRO_APELLIDO2 	AS SOCIEDAD_PROPIETARIA,
			OBRA_NUEVA.AGR_NUM_AGRUP_REM AS CODIGO_PROMOCION,
			OBRA_NUEVA.AGR_NOMBRE AS NOMBRE_PROMOCION,
			(SELECT AGR.AGR_NUM_AGRUP_REM FROM '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR WHERE AGR.AGR_ID IN (SELECT AGA.AGR_ID FROM '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO AGA WHERE AGA.ACT_ID = ACT.ACT_ID) AND
				AGR.AGR_FECHA_BAJA IS NULL AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM '||V_ESQUEMA||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO=''02'')) AS AGR_RESTRINGIDA_NUM,
			decode(CRA.DD_CRA_CODIGO, ''01'', ''''||ACT.ACT_NUM_ACTIVO_PRINEX,
				''02'', ''''||ACT.ACT_NUM_ACTIVO_SAREB,
				''03'', ''''||ACT.ACT_NUM_ACTIVO_UVEM
				) ID_CARTERA,
			ACT.ACT_NUM_ACTIVO_UVEM,
			ACT.ACT_NUM_ACTIVO AS ID_HAYA,
			TPVIA.DD_TVI_DESCRIPCION || '' '' || BIE_LOC.BIE_LOC_NOMBRE_VIA || '' ''|| BIE_LOC.BIE_LOC_NUMERO_DOMICILIO AS DIRECCION,
			LOC.DD_LOC_DESCRIPCION AS MUNICIPIO,
			PRV.DD_PRV_DESCRIPCION AS PROVINCIA,
			BIE_LOC.BIE_LOC_COD_POST AS COD_POSTAL,
			TPA.DD_TPA_CODIGO AS TIPO_CODIGO,
			TPA.DD_TPA_DESCRIPCION AS TIPO_DESCRIPCION,
			(SELECT DD_SCM_DESCRIPCION FROM '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL WHERE DD_SCM_ID = ACT.DD_SCM_ID) AS ESTADO_COMERCIAL,
			STA.DD_STA_DESCRIPCION 	AS ORIGEN,
			(SELECT TIT_FECHA_INSC_REG FROM '||V_ESQUEMA||'.ACT_TIT_TITULO WHERE ACT_ID = ACT.ACT_ID) AS FECHA_INSCRIPCION,
			ACT.ACT_FECHA_REV_CARGAS AS FECHA_REV_CARGAS,
			FPA.FECHA_POSESION AS FECHA_TOMA_POSESION,
			(SELECT APU.APU_FECHA_INI_VENTA
			  FROM '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION APU
			 WHERE APU.ACT_ID = ACT.ACT_ID 
			   AND APU.DD_EPV_ID = (SELECT DD_EPV_ID 
								   FROM '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA 
								  WHERE DD_EPV_CODIGO = ''03'' )
								    AND BORRADO = 0)	AS FECHA_PUBLICACION,
			(CASE SPS.SPS_OCUPADO WHEN 0 THEN ''No'' WHEN 1 THEN (CASE WHEN SPS.SPS_CON_TITULO = 1 THEN ''Ocupado con título'' ELSE ''Ocupado sin título'' END) END) AS OCUPADO,
			(SELECT COUNT(VIS_ID) FROM '||V_ESQUEMA||'.VIS_VISITAS VIS WHERE VIS.ACT_ID = ACT.ACT_ID) AS NUM_VISITAS,
			(SELECT COUNT(OFR_ID) FROM '||V_ESQUEMA||'.ACT_OFR AFR WHERE AFR.ACT_ID = ACT.ACT_ID) AS NUM_OFERTAS,
			V.FSV_VENTA,
			V.FSV_VENTA_F_INI,
			V.VALOR_ESTIMADO_VENTA,
			V.VALOR_ESTIMADO_VENTA_F_INI AS FECHA_ESTIMADO_VENTA,
			V.VNC,
			V.COSTE_ADIQUISICION,
			tasacion.TAS_IMPORTE_TAS_FIN AS VALOR_TASACION,
			tasacion.BIE_FECHA_VALOR_TASACION AS FECHA_TASACION,
			V.MINIMO_AUTORIZADO AS PRECIO_AUTORIZADO,
			V.MINIMO_AUTORIZADO_F_INI AS FECHA_AUTORIZADO,
			V.APROBADO_VENTA_WEB,
			V.APROBADO_VENTA_WEB_F_INI,
			V.DESCUENTO_APROBADO AS PRECIO_EVENTO_AUTORIZADO,
			V.DESCUENTO_APROBADO_F_INI AS FECHA_INI_EVEN_AUTORIZADO,
			V.DESCUENTO_APROBADO_F_FIN AS FECHA_FIN_EVEN_AUTORIZADO,
			V.DESCUENTO_PUBLICADO AS PRECIO_DESCUENTO_WEB,
			V.DESCUENTO_PUBLICADO_F_INI AS FECHA_INI_DESC_WEB,
			V.DESCUENTO_PUBLICADO_F_FIN AS FECHA_FIN_DESC_WEB,
			V.APROBADO_RENTA_WEB
			                    
		FROM '||V_ESQUEMA||'.ACT_PRP ACP
			JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACP.ACT_ID=ACT.ACT_ID
			JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_PAC_PROPIETARIO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = PAC.PRO_ID
			LEFT JOIN OBRA_NUEVA ON OBRA_NUEVA.ACT_ID = ACT.ACT_ID
			LEFT JOIN '||V_ESQUEMA||'.BIE_DATOS_REGISTRALES BIE_DAT ON ACT.BIE_ID = BIE_DAT.BIE_ID
			LEFT JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE_LOC ON ACT.BIE_ID = BIE_LOC.BIE_ID
			LEFT JOIN '||V_ESQUEMA_M||'.DD_TVI_TIPO_VIA TPVIA ON TPVIA.DD_TVI_ID = BIE_LOC.DD_TVI_ID
			LEFT JOIN '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA PRV ON PRV.DD_PRV_ID = BIE_LOC.DD_PRV_ID
			LEFT JOIN '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD LOC ON LOC.DD_LOC_ID = BIE_DAT.DD_LOC_ID
			LEFT JOIN '||V_ESQUEMA||'.DD_TPA_TIPO_ACTIVO TPA ON TPA.DD_TPA_ID = ACT.DD_TPA_ID
			LEFT JOIN '||V_ESQUEMA||'.DD_STA_SUBTIPO_TITULO_ACTIVO STA ON STA.DD_STA_ID = ACT.DD_STA_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_SPS_SIT_POSESORIA SPS ON SPS.ACT_ID = ACT.ACT_ID
			LEFT JOIN '||V_ESQUEMA||'.V_FECHA_POSESION_ACTIVO FPA ON FPA.ACT_ID = ACT.ACT_ID
			LEFT JOIN '||V_ESQUEMA||'.V_PIVOT_PRECIOS_ACTIVOS V ON V.ACT_ID = ACT.ACT_ID
			LEFT JOIN (select act_id, BIE_FECHA_VALOR_TASACION, TAS_IMPORTE_TAS_FIN FROM (
				select tasacion.act_id,
			       tasacion.BIE_FECHA_VALOR_TASACION,
			       tasacion.TAS_IMPORTE_TAS_FIN,
			       max(tasacion.BIE_FECHA_VALOR_TASACION) over (partition by tasacion.act_id) max_date
				from (select tas.act_id, bie_val.BIE_FECHA_VALOR_TASACION, TAS.TAS_IMPORTE_TAS_FIN from '||V_ESQUEMA||'.ACT_TAS_TASACION TAS JOIN '||V_ESQUEMA||'.BIE_VALORACIONES BIE_VAL ON BIE_VAL.BIE_VAL_ID = TAS.BIE_VAL_ID ) tasacion)
				where BIE_FECHA_VALOR_TASACION = max_date) tasacion on tasacion.act_id = act.act_id
			where act.borrado = 0
		';
		    

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_DATOS_PROPUESTA_ENTIDAD01...Creada OK');
  
EXCEPTION
     WHEN OTHERS THEN 
         DBMS_OUTPUT.PUT_LINE('KO!');
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;   

END;
/

EXIT;
