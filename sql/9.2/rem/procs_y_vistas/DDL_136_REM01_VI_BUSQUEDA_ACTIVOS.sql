--/*
--##########################################
--## AUTOR=Sergio Salt
--## FECHA_CREACION=20181226
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-4887
--## PRODUCTO=NO
--## Finalidad: DDL Añadir el tipoTituloPosesorio a la vista para el filtro nuevo de busqueda
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.    
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- N?mero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas
    V_MSQL VARCHAR2(4000 CHAR); 

    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_ACTIVOS' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_ACTIVOS';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_ACTIVOS' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_ACTIVOS';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS... borrada OK');
  END IF;

  
  
  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS...');
  EXECUTE IMMEDIATE 'CREATE VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_ACTIVOS 
	AS
		SELECT
		  	ACT.ACT_ID,
			ACT.BIE_ID,
			ACT.ACT_NUM_ACTIVO,
		  	ACT.ACT_NUM_ACTIVO_REM,
	        BIE_DAT.BIE_DREG_NUM_FINCA,
			DD_UPO_ID,
            BIE_CIC.DD_CIC_DESCRIPCION AS PAISDESCRIPCION,
        	BIE_CIC.DD_CIC_CODIGO AS PAISCODIGO,
          	BIE_LOC_COD_POST,
          	BIE_LOC.BIE_LOC_NOMBRE_VIA,
		  	TPVIA.DD_TVI_DESCRIPCION || '' '' || BIE_LOC.BIE_LOC_NOMBRE_VIA || '' ''|| BIE_LOC.BIE_LOC_NUMERO_DOMICILIO || '' '' || LOC.DD_LOC_DESCRIPCION || '' '' || PRV.DD_PRV_DESCRIPCION AS TOKEN_GMAPS,
			ACT_LOC.LOC_LONGITUD,
			ACT_LOC.LOC_LATITUD,
			ACT.ACT_ADMISION,
			ACT.ACT_GESTION,
			ACT.ACT_SELLO_CALIDAD,
			ACT.ACT_NUM_ACTIVO_UVEM,
			ACT.ACT_RECOVERY_ID,
			ACT.ACT_NUM_ACTIVO_SAREB,
			ACT.ACT_NUM_ACTIVO_PRINEX,
			ACT_REG.REG_IDUFIR,
          	BIE_DAT.BIE_DREG_NUM_REGISTRO,
			ACT_SIT.SPS_OCUPADO,
          	TIT.DD_TPA_CODIGO,
          	ACT_SIT.SPS_FECHA_TOMA_POSESION,
          	ACT_SIT.SPS_ACC_TAPIADO,
			ACT_SIT.SPS_ACC_ANTIOCUPA,
        	RTG.DD_RTG_CODIGO AS FLAG_RATING,
	        STA.DD_SAC_CODIGO AS SUBTIPOACTIVOCODIGO,
	        STA.DD_SAC_DESCRIPCION AS SUBTIPOACTIVODESCRIPCION,
	        EAC.DD_EAC_CODIGO AS ESTADOACTIVOCODIGO,
	        TTA.DD_TTA_CODIGO AS TIPOTITULOACTIVOCODIGO,
	        TTA.DD_TTA_DESCRIPCION AS TIPOTITULOACTIVODESCRIPCION,
	        CRA.DD_CRA_CODIGO AS ENTIDADPROPIETARIACODIGO,
	        CRA.DD_CRA_DESCRIPCION AS ENTIDADPROPIETARIADESCRIPCION,
	        LOC.DD_LOC_CODIGO AS LOCALIDADCODIGO,
	        LOC.DD_LOC_DESCRIPCION AS LOCALIDADDESCRIPCION,
	        PRV.DD_PRV_CODIGO AS PROVINCIACODIGO,
	        PRV.DD_PRV_DESCRIPCION AS PROVINCIADESCRIPCION,
	        TPVIA.DD_TVI_CODIGO AS TIPOVIACODIGO,
	        LOCREG.DD_LOC_DESCRIPCION AS LOCALIDADREGISTRODESCRIPCION,
	        TPA.DD_TPA_CODIGO AS TIPOACTIVOCODIGO,
	        TPA.DD_TPA_DESCRIPCION AS TIPOACTIVODESCRIPCION,
			CATASTRO.CAT_REF_CATASTRAL AS REFERENCIA_CATASTRAL,
			SCM.DD_SCM_DESCRIPCION,
			SCM.DD_SCM_CODIGO,
			DD_SCR_ID,
			DD_TUD_ID,
			DD_STA_ID,
			ACT_DIVISION_HORIZONTAL,
			DD_TCO_ID,
			ACT_CON_CARGAS,
			ACT.ACT_COD_PROMOCION_PRINEX,
			TPO.DD_TPO_CODIGO,
			ECG.DD_ECG_CODIGO
  
		FROM ' || V_ESQUEMA || '.ACT_ACTIVO ACT 
		LEFT JOIN ' || V_ESQUEMA || '.ACT_LOC_LOCALIZACION ACT_LOC ON ACT_LOC.ACT_ID = ACT.ACT_ID
		LEFT JOIN ' || V_ESQUEMA || '.BIE_LOCALIZACION BIE_LOC ON ACT.BIE_ID = BIE_LOC.BIE_ID
		LEFT JOIN ' || V_ESQUEMA || '.BIE_DATOS_REGISTRALES BIE_DAT ON ACT.BIE_ID = BIE_DAT.BIE_ID
		LEFT JOIN ' || V_ESQUEMA || '.ACT_REG_INFO_REGISTRAL ACT_REG ON ACT.ACT_ID = ACT_REG.ACT_ID
		LEFT JOIN ' || V_ESQUEMA || '.ACT_SPS_SIT_POSESORIA ACT_SIT ON ACT.ACT_ID = ACT_SIT.ACT_ID
		LEFT JOIN ' || V_ESQUEMA || '.DD_TPA_TIPO_TITULO_ACT TIT ON TIT.DD_TPA_ID = ACT_SIT.DD_TPA_ID
		LEFT JOIN ' || V_ESQUEMA_MASTER || '.DD_TVI_TIPO_VIA TPVIA ON TPVIA.DD_TVI_ID = BIE_LOC.DD_TVI_ID
		LEFT JOIN ' || V_ESQUEMA_MASTER || '.DD_LOC_LOCALIDAD LOC ON LOC.DD_LOC_ID = BIE_LOC.DD_LOC_ID
		LEFT JOIN ' || V_ESQUEMA_MASTER || '.DD_CIC_CODIGO_ISO_CIRBE_BKP BIE_CIC ON BIE_LOC.DD_CIC_ID = BIE_CIC.DD_CIC_ID
		LEFT JOIN ' || V_ESQUEMA || '.DD_SAC_SUBTIPO_ACTIVO STA ON STA.DD_SAC_ID = ACT.DD_SAC_ID
	    LEFT JOIN ' || V_ESQUEMA || '.DD_TPA_TIPO_ACTIVO TPA ON TPA.DD_TPA_ID = ACT.DD_TPA_ID
	    LEFT JOIN ' || V_ESQUEMA || '.DD_EAC_ESTADO_ACTIVO EAC ON EAC.DD_EAC_ID = ACT.DD_EAC_ID
	    LEFT JOIN ' || V_ESQUEMA || '.DD_TTA_TIPO_TITULO_ACTIVO TTA ON TTA.DD_TTA_ID =  ACT.DD_TTA_ID
	    LEFT JOIN ' || V_ESQUEMA || '.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
	    LEFT JOIN ' || V_ESQUEMA_MASTER || '.DD_PRV_PROVINCIA PRV ON PRV.DD_PRV_ID = BIE_LOC.DD_PRV_ID
	    LEFT JOIN ' || V_ESQUEMA_MASTER || '.DD_LOC_LOCALIDAD LOCREG ON LOCREG.DD_LOC_ID = BIE_DAT.DD_LOC_ID
		LEFT JOIN ' || V_ESQUEMA || '.DD_RTG_RATING_ACTIVO RTG ON RTG.DD_RTG_ID = ACT.DD_RTG_ID
		LEFT JOIN ' || V_ESQUEMA || '.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_ID = ACT.DD_SCM_ID
		LEFT JOIN ' || V_ESQUEMA || '.DD_TPO_TIPO_TITULO_POSESORIO TPO ON TPO.DD_TPO_ID = ACT_SIT.DD_TPO_ID
		LEFT JOIN ' || V_ESQUEMA || '.ACT_CMG_COMUNICACION_GENCAT CMG ON CMG.ACT_ID = ACT.ACT_ID AND CMG.BORRADO=0
		LEFT JOIN ' || V_ESQUEMA || '.DD_ECG_ESTADO_COM_GENCAT ECG ON CMG.DD_ECG_ID = ECG.DD_ECG_ID 
		LEFT JOIN (SELECT CAT.ACT_ID, LISTAGG(CAT.CAT_REF_CATASTRAL,'','') WITHIN GROUP (ORDER BY ACT_ID) AS CAT_REF_CATASTRAL FROM ' || V_ESQUEMA || '.ACT_CAT_CATASTRO CAT
		GROUP BY CAT.ACT_ID) CATASTRO ON CATASTRO.ACT_ID = ACT.ACT_ID
		WHERE ACT.BORRADO = 0';
		

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_ACTIVOS...Creada OK');
  
END;
/

EXIT;