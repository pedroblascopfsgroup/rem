--/*
--##########################################
--## AUTOR=DANIEL ALGABA
--## FECHA_CREACION=20180313
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-3890
--## PRODUCTO=NO
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.    
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- N?mero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas
    V_MSQL VARCHAR2(4000 CHAR); 

    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_AGRUPACIONES' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_AGRUPACIONES';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_BUSQUEDA_AGRUPACIONES' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_AGRUPACIONES';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES... borrada OK');
  END IF;

  DBMS_OUTPUT.PUT_LINE('CREATING VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES...');
  EXECUTE IMMEDIATE 'CREATE VIEW ' || V_ESQUEMA || '.V_BUSQUEDA_AGRUPACIONES 
	AS
		  SELECT
      AGR.AGR_ID,
      AGR.DD_TAG_ID,
      AGR.AGR_NUM_AGRUP_REM,
      AGR.AGR_NUM_AGRUP_UVEM,
      AGR.AGR_NOMBRE,
      AGR.AGR_DESCRIPCION,
      AGR.AGR_FECHA_ALTA,
      AGR.AGR_FECHA_BAJA,
      AGR.AGR_INI_VIGENCIA,
      AGR.AGR_FIN_VIGENCIA,
      AGR.AGR_PUBLICADO,
      NVL(AGR_P.ACTIVOS,0) AS ACTIVOS,
      NVL(AGR_P.PUBLICADOS_A,0) AS PUBLICADOS_A,
            NVL(AGR_P.PUBLICADOS_V,0) AS PUBLICADOS_V,
      COALESCE (OBR.DD_PRV_ID, RES.DD_PRV_ID, LCO.DD_PRV_ID, ASI.DD_PRV_ID) AS PROVINCIA,
      COALESCE (OBR.DD_LOC_ID, RES.DD_LOC_ID, LCO.DD_LOC_ID, ASI.DD_LOC_ID) AS LOCALIDAD,
      COALESCE (OBR.ONV_DIRECCION, RES.RES_DIRECCION, LCO.LCO_DIRECCION, ASI.ASI_DIRECCION) AS DIRECCION,
      AGR_P.DD_CRA_CODIGO CARTERA,
      AGR.AGR_IS_FORMALIZACION
    FROM ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR
    JOIN ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION TAG ON TAG.DD_TAG_ID = AGR.DD_TAG_ID AND TAG.BORRADO = 0
    LEFT JOIN
      (SELECT SUM (1) ACTIVOS, 
            SUM (CASE
      WHEN EPA.DD_EPA_CODIGO = ''03''
      THEN 1
      ELSE 0
      END) PUBLICADOS_A,
            SUM (CASE
      WHEN EPV.DD_EPV_CODIGO = ''03''
      THEN 1
      ELSE 0
      END) PUBLICADOS_V,
      AGA.AGR_ID,
      CRA.DD_CRA_CODIGO
      FROM ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO AGA
      LEFT JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = AGA.ACT_ID AND ACT.BORRADO = 0
            LEFT JOIN ' || V_ESQUEMA || '.ACT_APU_ACTIVO_PUBLICACION ACT_APU ON ACT_APU.ACT_ID = AGA.ACT_ID AND ACT_APU.BORRADO = 0
            LEFT JOIN ' || V_ESQUEMA || '.DD_EPA_ESTADO_PUB_ALQUILER EPA ON ACT_APU.DD_EPA_ID = EPA.DD_EPA_ID AND EPA.BORRADO = 0
            LEFT JOIN ' || V_ESQUEMA || '.DD_EPV_ESTADO_PUB_VENTA EPV ON ACT_APU.DD_EPV_ID = EPV.DD_EPV_ID AND EPV.BORRADO = 0
      LEFT JOIN ' || V_ESQUEMA || '.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
      WHERE AGA.BORRADO = 0
      GROUP BY AGA.AGR_ID, CRA.DD_CRA_CODIGO) AGR_P ON AGR_P.AGR_ID = AGR.AGR_ID
    LEFT JOIN ' || V_ESQUEMA || '.ACT_ONV_OBRA_NUEVA OBR ON AGR.AGR_ID = OBR.AGR_ID
    LEFT JOIN ' || V_ESQUEMA || '.ACT_RES_RESTRINGIDA RES ON AGR.AGR_ID = RES.AGR_ID
    LEFT JOIN ' || V_ESQUEMA || '.ACT_LCO_LOTE_COMERCIAL LCO ON AGR.AGR_ID = LCO.AGR_ID
    LEFT JOIN ' || V_ESQUEMA || '.ACT_ASI_ASISTIDA ASI ON AGR.AGR_ID = ASI.AGR_ID
    WHERE AGR.BORRADO = 0';  

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_BUSQUEDA_AGRUPACIONES...Creada OK');
  
END;
/

EXIT;

