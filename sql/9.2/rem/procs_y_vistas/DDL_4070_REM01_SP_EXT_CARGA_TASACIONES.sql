--/*
--######################################### 
--## AUTOR=CARLOS MUÑOZ
--## FECHA_CREACION=20180809
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-4402
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##                    
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


CREATE OR REPLACE PROCEDURE #ESQUEMA#.SP_EXT_CARGA_TASACIONES 
    (TAS_ID IN #ESQUEMA#.ACT_TAS_TASACION.TAS_ID%TYPE
    , ACT_ID IN #ESQUEMA#.ACT_TAS_TASACION.ACT_ID%TYPE
	, DD_TTS_ID IN #ESQUEMA#.ACT_TAS_TASACION.DD_TTS_ID%TYPE
	, TAS_FECHA_INI_TASACION IN #ESQUEMA#.ACT_TAS_TASACION.TAS_FECHA_INI_TASACION%TYPE
	, TAS_FECHA_RECEPCION_TASACION IN #ESQUEMA#.ACT_TAS_TASACION.TAS_FECHA_RECEPCION_TASACION%TYPE
	, TAS_CODIGO_FIRMA IN #ESQUEMA#.ACT_TAS_TASACION.TAS_CODIGO_FIRMA%TYPE
	, TAS_NOMBRE_TASADOR IN #ESQUEMA#.ACT_TAS_TASACION.TAS_NOMBRE_TASADOR%TYPE
	, TAS_IMPORTE_TAS_FIN IN #ESQUEMA#.ACT_TAS_TASACION.TAS_IMPORTE_TAS_FIN%TYPE
	, TAS_COSTE_REPO_NETO_ACTUAL IN #ESQUEMA#.ACT_TAS_TASACION.TAS_COSTE_REPO_NETO_ACTUAL%TYPE
	, TAS_COSTE_REPO_NETO_FINALIZADO IN #ESQUEMA#.ACT_TAS_TASACION.TAS_COSTE_REPO_NETO_FINALIZADO%TYPE
	, TAS_COEF_MERCADO_ESTADO IN #ESQUEMA#.ACT_TAS_TASACION.TAS_COEF_MERCADO_ESTADO%TYPE
	, TAS_COEF_POND_VALOR_ANYADIDO IN #ESQUEMA#.ACT_TAS_TASACION.TAS_COEF_POND_VALOR_ANYADIDO%TYPE
	, TAS_VALOR_REPER_SUELO_CONST IN #ESQUEMA#.ACT_TAS_TASACION.TAS_VALOR_REPER_SUELO_CONST%TYPE
	, TAS_COSTE_CONST_CONST IN #ESQUEMA#.ACT_TAS_TASACION.TAS_COSTE_CONST_CONST%TYPE
	, TAS_INDICE_DEPRE_FISICA IN #ESQUEMA#.ACT_TAS_TASACION.TAS_INDICE_DEPRE_FISICA%TYPE
	, TAS_INDICE_DEPRE_FUNCIONAL IN #ESQUEMA#.ACT_TAS_TASACION.TAS_INDICE_DEPRE_FUNCIONAL%TYPE
	, TAS_INDICE_TOTAL_DEPRE IN #ESQUEMA#.ACT_TAS_TASACION.TAS_INDICE_TOTAL_DEPRE%TYPE
	, TAS_COSTE_CONST_DEPRE IN #ESQUEMA#.ACT_TAS_TASACION.TAS_COSTE_CONST_DEPRE%TYPE
	, TAS_COSTE_UNI_REPO_NETO IN #ESQUEMA#.ACT_TAS_TASACION.TAS_COSTE_UNI_REPO_NETO%TYPE
	, TAS_COSTE_REPOSICION IN #ESQUEMA#.ACT_TAS_TASACION.TAS_COSTE_REPOSICION%TYPE
	, TAS_PORCENTAJE_OBRA IN #ESQUEMA#.ACT_TAS_TASACION.TAS_PORCENTAJE_OBRA%TYPE
	, TAS_IMPORTE_VALOR_TER IN #ESQUEMA#.ACT_TAS_TASACION.TAS_IMPORTE_VALOR_TER%TYPE
	, TAS_ID_TEXTO_ASOCIADO IN #ESQUEMA#.ACT_TAS_TASACION.TAS_ID_TEXTO_ASOCIADO%TYPE
	, TAS_IMPORTE_VAL_LEGAL_FINCA IN #ESQUEMA#.ACT_TAS_TASACION.TAS_IMPORTE_VAL_LEGAL_FINCA%TYPE
	, TAS_IMPORTE_VAL_SOLAR IN #ESQUEMA#.ACT_TAS_TASACION.TAS_IMPORTE_VAL_SOLAR%TYPE
	, TAS_OBSERVACIONES IN #ESQUEMA#.ACT_TAS_TASACION.TAS_OBSERVACIONES%TYPE
    , PL_OUTPUT OUT VARCHAR2)
    
    AUTHID CURRENT_USER IS

	--Configuracion
	V_ESQUEMA                   VARCHAR2(15 CHAR) := '#ESQUEMA#';
	V_ESQUEMA_MASTER            VARCHAR2(15 CHAR) := '#ESQUEMA_MASTER#';

	--Sentencia a ejecutar
	V_SQL 						VARCHAR2(32000 CHAR);         
	
	ERR_NUM NUMBER(25); -- Vble. auxiliar para registrar errores en el script.
	ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	
	RESULTADO     				NUMBER;
	RESULTADO_2					NUMBER;


BEGIN
	
    #ESQUEMA#.CARGA_TASACIONES(
		TAS_ID,
		ACT_ID,
		DD_TTS_ID,
		TAS_FECHA_INI_TASACION,
		TAS_FECHA_RECEPCION_TASACION,
		TAS_CODIGO_FIRMA,
		TAS_NOMBRE_TASADOR,
		TAS_IMPORTE_TAS_FIN,
		TAS_COSTE_REPO_NETO_ACTUAL,
		TAS_COSTE_REPO_NETO_FINALIZADO,
		TAS_COEF_MERCADO_ESTADO,
		TAS_COEF_POND_VALOR_ANYADIDO,
		TAS_VALOR_REPER_SUELO_CONST,
		TAS_COSTE_CONST_CONST,
		TAS_INDICE_DEPRE_FISICA,
		TAS_INDICE_DEPRE_FUNCIONAL,
		TAS_INDICE_TOTAL_DEPRE,
		TAS_COSTE_CONST_DEPRE,
		TAS_COSTE_UNI_REPO_NETO,
		TAS_COSTE_REPOSICION,
		TAS_PORCENTAJE_OBRA,
		TAS_IMPORTE_VALOR_TER,
		TAS_ID_TEXTO_ASOCIADO,
		TAS_IMPORTE_VAL_LEGAL_FINCA,
		TAS_IMPORTE_VAL_SOLAR,
		TAS_OBSERVACIONES,
		PL_OUTPUT
    );
    
    RESULTADO := INSTR(PL_OUTPUT, '[ERROR]');
    --Se ha creado RESULTADO_2 por que el SP CARGA_TASACIONES contiene un mensaje de ERROR que esta indicado como INFO y no se permite cambiar ese SP.
    RESULTADO_2 := INSTR(PL_OUTPUT, '[INFO] No existe la tasación');
	
	DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
     
     IF (RESULTADO) > 0 OR (RESULTADO_2 > 0) THEN 
		V_SQL := 'INSERT INTO '|| V_ESQUEMA || '.HLP_HISTORICO_LANZA_PERIODICO (
			HLP_SP_CARGA, 
			HLP_FECHA_EJEC, 
			HLP_RESULTADO_EJEC,
			HLP_CODIGO_REG,
			HLP_REGISTRO_EJEC
		) VALUES (
			''SP_EXT_CARGA_TASACIONES'',
			SYSDATE,
			1,
			'''||ACT_ID|| ' - ' ||TAS_NOMBRE_TASADOR||''',
			'''||PL_OUTPUT||'''
		)' ;
		
		EXECUTE IMMEDIATE V_SQL;
	
	ELSE
		
		V_SQL := 'INSERT INTO '|| V_ESQUEMA || '.HLP_HISTORICO_LANZA_PERIODICO (
			HLP_SP_CARGA, 
			HLP_FECHA_EJEC, 
			HLP_RESULTADO_EJEC,
			HLP_CODIGO_REG,
			HLP_REGISTRO_EJEC
		) VALUES (
			''SP_EXT_CARGA_TASACIONES'',
			SYSDATE,
			0,
			'''||ACT_ID|| ' - ' ||TAS_NOMBRE_TASADOR||''',
			'' ''
		)' ;
		
		EXECUTE IMMEDIATE V_SQL;
		
	END IF;
     
     DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
     COMMIT;
    
EXCEPTION
   WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    [ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM);
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    '||ERR_MSG;
      ROLLBACK;
      RAISE;
END SP_EXT_CARGA_TASACIONES;
/
EXIT;
