--/*
--##########################################
--## AUTOR=Guillermo Llidó
--## FECHA_CREACION=20180710
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-1218
--## PRODUCTO=NO
--##
--## Finalidad: 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

CREATE OR REPLACE PROCEDURE #ESQUEMA#.SP_REACTIVAR_AGRUPACION
        (     
		  V_USUARIO_MODIFICAR IN VARCHAR2
        , PL_OUTPUT OUT VARCHAR2
    )

   AS

   V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar
   V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
   V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
   ERR_NUM NUMBER(25); -- Vble. auxiliar para registrar errores en el script.
   ERR_MSG VARCHAR2(10024 CHAR); -- Vble. auxiliar para registrar errores en el script.
   V_NUM_TABLAS NUMBER(16); -- Variable auxiliar
   USUARIO_CONSULTA_REM VARCHAR2(50 CHAR):= 'REM_QUERY';

BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');
    
        --Comprobamos el dato a insertar
					
		V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_AGR_AGRUPACION ACT
					INNER JOIN '||V_ESQUEMA||'.AUX_REA_AGR AUX ON AUX.AGR_NUM_AGRUP_REM = ACT.AGR_NUM_AGRUP_REM';	
					
        EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
        
        --Si existe realizamos realizamos el update
        IF V_NUM_TABLAS > 0 THEN		
				
        	--FECHA BAJA, AGR_ELIMINADO, FECHA INICIO VIGENCIA, FECHA FIN VIGENIA
			 
			 PL_OUTPUT := PL_OUTPUT ||'[INFO]: SE PROCEDE A REACTIVAR '''|| V_NUM_TABLAS ||' AGRUPACIONES '|| CHR(10);
			 
			  V_SQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR USING '||V_ESQUEMA||'.AUX_REA_AGR AUX
						ON (AGR.AGR_NUM_AGRUP_REM = AUX.AGR_NUM_AGRUP_REM)
						WHEN MATCHED THEN UPDATE SET 
						AGR.AGR_INI_VIGENCIA = AUX.AGR_INI_VIGENCIA,
						AGR.AGR_FIN_VIGENCIA = AUX.AGR_FIN_VIGENCIA,
						AGR.AGR_FECHA_BAJA = NULL,
						AGR.AGR_ELIMINADO = 0,
						AGR.USUARIOMODIFICAR = '''||V_USUARIO_MODIFICAR||''',
						AGR.FECHAMODIFICAR = SYSDATE' ;
						 
			  EXECUTE IMMEDIATE V_SQL;
			  
			  PL_OUTPUT := PL_OUTPUT ||'[INFO]: LAS ' ||V_NUM_TABLAS|| ' AGRUPACIONES HAN SIDO MODIFICADAS CORRECTAMENTE '|| CHR(10);
			  
			  
			 --PACK INCLUIDO Y CHECK COMERCIALZABLE
			   V_SQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO PAC USING(
						  SELECT DISTINCT AGR.AGR_NUM_AGRUP_REM, ACT.ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT 
							JOIN '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGA.ACT_ID=ACT.ACT_ID
							JOIN '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR ON AGA.AGR_ID=AGR.AGR_ID AND 
                            INNER JOIN '||V_ESQUEMA||'.AUX_REA_AGR AUX ON AUX.AGR_NUM_AGRUP_REM = AGR.AGR_NUM_AGRUP_REM AND AUX.BORRADO = 0
						  )PDV
						ON(PDV.ACT_ID=PAC.ACT_ID)
						WHEN MATCHED THEN UPDATE
						  SET PAC.PAC_INCLUIDO = 1,
						  PAC.PAC_CHECK_COMERCIALIZAR = 1,
						  PAC.USUARIOMODIFICAR = '''||V_USUARIO_MODIFICAR||''',
						  PAC.FECHAMODIFICAR = SYSDATE';

			  EXECUTE IMMEDIATE V_SQL;
				  
			--ACTIVO COMERCIALIZABLE (DISPONIBLE PARA LA VENTA)	  
				V_SQL := 'MERGE INTO ACT_ACTIVO T1 USING(
							  SELECT DISTINCT ACT.ACT_NUM_ACTIVO FROM '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO AGA 
							  JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID=AGA.ACT_ID
							  JOIN '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_ID=AGA.AGR_ID
							  INNER JOIN '||V_ESQUEMA||'.AUX_REA_AGR AUX ON AUX.AGR_NUM_AGRUP_REM = AGR.AGR_NUM_AGRUP_REM AND AUX.BORRADO = 0
							  JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_ID=ACT.DD_SCM_ID
							  WHERE 
							  SCM.DD_SCM_ID != (SELECT DD_SCM_ID FROM '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL WHERE DD_SCM_CODIGO = ''05'')         
							  )T2
							ON (T1.ACT_NUM_ACTIVO=T2.ACT_NUM_ACTIVO)
							WHEN MATCHED THEN UPDATE
							  SET T1.DD_SCM_ID= (SELECT DD_SCM_ID FROM '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL WHERE DD_SCM_CODIGO =''02''), 
							  T1.USUARIOMODIFICAR = '''||V_USUARIO_MODIFICAR||''',
							  T1.FECHAMODIFICAR = SYSDATE ';
					
				EXECUTE IMMEDIATE V_SQL;
			
       ELSE
       
           PL_OUTPUT := PL_OUTPUT ||'[ERROR]: UNA AGRUPACIONES NO EXISTE'|| CHR(10);
        
       END IF;
           
    COMMIT;
    
    PL_OUTPUT := PL_OUTPUT ||'[FIN]: TABLA ACT_AGR_AGRUPACION ACTUALIZADA CORRECTAMENTE CON ' ||V_NUM_TABLAS|| ' REGISTROS '|| CHR(10);

EXCEPTION
   WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    [ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM);
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    '||ERR_MSG;
      ROLLBACK;
      RAISE;
END SP_REACTIVAR_AGRUPACION;
/
EXIT
