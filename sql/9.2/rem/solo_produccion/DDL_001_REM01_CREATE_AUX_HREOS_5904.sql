--/*
--#########################################
--## AUTOR=Pablo Meseguer
--## FECHA_CREACION=20190329
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.17
--## INCIDENCIA_LINK=HREOS-5904
--## PRODUCTO=NO
--## 
--## Finalidad: Creación tabla 'AUX_HREOS_5904'
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


BEGIN

EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''AUX_HREOS_5904'' and owner = ''PFSREM''' INTO V_NUM_TABLAS;	
IF V_NUM_TABLAS = 1 THEN

	EXECUTE IMMEDIATE '
	DROP TABLE PFSREM.AUX_HREOS_5904';
END IF;


EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''AUX_HREOS_5904_CALCULO'' and owner = ''PFSREM''' INTO V_NUM_TABLAS;	
IF V_NUM_TABLAS = 1 THEN
	EXECUTE IMMEDIATE '
	DROP TABLE PFSREM.AUX_HREOS_5904_CALCULO';
END IF;


EXECUTE IMMEDIATE 'CREATE TABLE PFSREM.AUX_HREOS_5904 (
ACT_ID NUMBER(16),
TAR_ID NUMBER(16),
OFR_ID NUMBER(16),
USU_ID_TAC NUMBER(16),
USU_ID_DIST NUMBER(16),
USU_ID_BASE_ANT NUMBER(16))';

EXECUTE IMMEDIATE 'CREATE TABLE PFSREM.AUX_HREOS_5904_CALCULO (
COD_PROV NUMBER(16),
USERNAME VARCHAR2(50 CHAR))';

--Rellenamos los datos de la tabla AUX_HREOS_5904_CALCULO para usar de base
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(4,''gl03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(11,''gl03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(14,''gl03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(18,''gl03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(21,''gl03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(23,''gl03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(29,''gl03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(41,''gl03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(7,''garsa03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(35,''garsa03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(38,''garsa03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(5,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(9,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(24,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(34,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(37,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(40,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(42,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(47,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(49,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(8,''pinos03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(17,''pinos03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(25,''pinos03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(43,''pinos03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(51,''gl03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(6,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(10,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(15,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(27,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(32,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(36,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(28,''gl03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(30,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(31,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(1,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(48,''montalvo03'')';
EXECUTE IMMEDIATE 'INSERT INTO PFSREM.AUX_HREOS_5904_CALCULO(COD_PROV, USERNAME) VALUES(20,''montalvo03'')';


EXECUTE IMMEDIATE '
INSERT INTO PFSREM.AUX_HREOS_5904(ACT_ID, TAR_ID, OFR_ID, USU_ID_TAC) 
SELECT ACT.ACT_ID, TAR.TAR_ID, OFR.OFR_ID, TAC.USU_ID
FROM REM01.OFR_OFERTAS OFR
INNER JOIN REM01.ACT_OFR ACT_OFR ON ACT_OFR.OFR_ID = OFR.OFR_ID
INNER JOIN REM01.ACT_ACTIVO ACT ON ACT.ACT_ID = ACT_OFR.ACT_ID
INNER JOIN REM01.DD_CRA_CARTERA CRA ON ACT.DD_CRA_ID = CRA.DD_CRA_ID
INNER JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
INNER JOIN REM01.ACT_TRA_TRAMITE TRA ON ECO.TBJ_ID = TRA.TBJ_ID
INNER JOIN REM01.TAC_TAREAS_ACTIVOS TAC ON TAC.TRA_ID = TRA.TRA_ID
INNER JOIN REM01.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID --13307
INNER JOIN REM01.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID
INNER JOIN REM01.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
INNER JOIN REM01.DD_TPO_TIPO_PROCEDIMIENTO TPO ON TPO.DD_TPO_ID = TAP.DD_TPO_ID
INNER JOIN REMMASTER.USU_USUARIOS USU ON USU.USU_ID = TAC.USU_ID
WHERE CRA.DD_CRA_CODIGO = ''03''
AND TAR.TAR_FECHA_FIN IS NULL
AND TAR.TAR_TAREA_FINALIZADA = 0
AND TAR.BORRADO = 0
AND TPO.DD_TPO_CODIGO = ''T013''';

DBMS_OUTPUT.PUT_LINE('[INFO] AUX CON  '|| SQL%ROWCOUNT ||' FILAS ');

EXECUTE IMMEDIATE '
MERGE INTO PFSREM.AUX_HREOS_5904 AUX
USING(
        SELECT ACT_ID, USU_ID
        FROM REM01.V_GESTORES_ACTIVO VGES
        INNER JOIN REMMASTER.USU_USUARIOS USU
        ON VGES.USERNAME = USU.USU_USERNAME
        WHERE VGES.DD_CRA_CODIGO = 3
        AND VGES.TIPO_GESTOR = ''GIAFORM'' 
        AND VGES.DD_PRV_CODIGO IS NOT NULL
    ) TMP
ON (TMP.ACT_ID = AUX.ACT_ID)
WHEN MATCHED THEN UPDATE
SET AUX.USU_ID_DIST = TMP.USU_ID';

DBMS_OUTPUT.PUT_LINE('[INFO] USU_ID_DIST CON  '|| SQL%ROWCOUNT ||' FILAS ');


EXECUTE IMMEDIATE '
MERGE INTO PFSREM.AUX_HREOS_5904 AUX
USING(
        SELECT VGES.ACT_ID, USU.USU_ID
        FROM REM01.V_GESTORES_ACTIVO VGES
        INNER JOIN PFSREM.AUX_HREOS_5904_CALCULO TMP2 ON TMP2.COD_PROV = VGES.DD_PRV_CODIGO
        INNER JOIN REMMASTER.USU_USUARIOS USU ON TMP2.USERNAME = USU.USU_USERNAME
        WHERE VGES.DD_CRA_CODIGO = 3
        AND VGES.TIPO_GESTOR = ''GIAFORM'' 
        AND VGES.DD_PRV_CODIGO IS NOT NULL
    ) TMP
ON (TMP.ACT_ID = AUX.ACT_ID)
WHEN MATCHED THEN UPDATE
SET AUX.USU_ID_BASE_ANT = TMP.USU_ID';

DBMS_OUTPUT.PUT_LINE('[INFO] USU_ID_BASE_ANT CON  '|| SQL%ROWCOUNT ||' FILAS ');

commit;

EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/

EXIT;
