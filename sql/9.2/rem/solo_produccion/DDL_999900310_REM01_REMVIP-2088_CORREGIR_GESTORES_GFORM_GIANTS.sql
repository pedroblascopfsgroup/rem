--/*
--##########################################
--## AUTOR=Marco Munoz
--## FECHA_CREACION=20181002
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-2088
--## PRODUCTO=SI
--## Finalidad: Creacion de 2 tablas auxiliares para reparar gestores GFORM de Giants.
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;
--set serveroutput on size 1000000;


DECLARE
    V_ESQUEMA VARCHAR2(25 CHAR) := 'REM01';				-- '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR) := 'REMMASTER';		-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-2088';
    V_SQL VARCHAR2(4000 CHAR); 
    ERR_NUM NUMBER;										-- Numero de errores
    ERR_MSG VARCHAR2(2048);							    -- Mensaje de error
    PL_OUTPUT VARCHAR2(32000 CHAR);


BEGIN

	EXECUTE IMMEDIATE 
   'CREATE TABLE REM01.AUX_MMC_GIANTS_GFORM_USU AS
	SELECT T1.ECO_ID, T2.GEE_ID, T1.USU_ID
	FROM 
	(
		SELECT GCH.ECO_ID, GEH.USU_ID
		FROM REM01.GCH_GESTOR_ECO_HISTORICO GCH
		JOIN REM01.GEH_GESTOR_ENTIDAD_HIST  GEH
		  ON GCH.GEH_ID = GEH.GEH_ID
		JOIN REMMASTER.DD_TGE_TIPO_GESTOR   TGE
		  ON TGE.DD_TGE_ID = GEH.DD_TGE_ID
		WHERE TGE.DD_TGE_CODIGO IN (''GFORM'') 
		AND GEH.GEH_FECHA_HASTA IS NULL
		AND GCH.ECO_ID IN (
			SELECT ECO_ID FROM (
			SELECT DISTINCT ECO.ECO_ID, GEE.GEE_ID, GEE.USU_ID
			FROM REM01.ACT_ACTIVO ACT
			JOIN REM01.DD_CRA_CARTERA CRA
			  ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
			JOIN REM01.ACT_OFR    AOF
			  ON AOF.ACT_ID = ACT.ACT_ID
			JOIN REM01.OFR_OFERTAS OFR
			  ON OFR.OFR_ID = AOF.OFR_ID
			JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO
			  ON ECO.OFR_ID = OFR.OFR_ID
			JOIN REM01.GCO_GESTOR_ADD_ECO GCO
			  ON GCO.ECO_ID = ECO.ECO_ID
			JOIN REM01.GEE_GESTOR_ENTIDAD GEE
			  ON GEE.GEE_ID = GCO.GEE_ID
			JOIN REMMASTER.DD_TGE_TIPO_GESTOR TGE
			  ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
			LEFT JOIN REMMASTER.USU_USUARIOS USU
			  ON USU.USU_ID = GEE.USU_ID
			JOIN REM01.GCH_GESTOR_ECO_HISTORICO GCH
			  ON GCH.ECO_ID = ECO.ECO_ID
			JOIN REM01.GEH_GESTOR_ENTIDAD_HIST GEH
			  ON GEH.GEH_ID = GCH.GEH_ID
			 AND GEH.DD_TGE_ID = TGE.DD_TGE_ID
			WHERE TGE.DD_TGE_CODIGO IN (''GFORM'')
			  AND CRA.DD_CRA_CODIGO = ''12''
			  AND ACT.BORRADO = 0
			  AND OFR.BORRADO = 0
			  AND ECO.BORRADO = 0
			  AND GEE.BORRADO = 0  AND GEE.USU_ID IS NULL
			  ORDER BY 1, 2
		))
		ORDER BY 1, 2
	) T1
	JOIN 
	(
		SELECT GCO.GEE_ID, GCO.ECO_ID 
	FROM REM01.GCO_GESTOR_ADD_ECO     GCO 
	JOIN REM01.GEE_GESTOR_ENTIDAD     GEE
	  ON GEE.GEE_ID = GCO.GEE_ID
	JOIN REMMASTER.DD_TGE_TIPO_GESTOR TGE
	  ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
	WHERE TGE.DD_TGE_CODIGO IN (''GFORM'') 
	AND GCO.ECO_ID IN 
	(
		SELECT ECO_ID FROM (
		SELECT DISTINCT ECO.ECO_ID, GEE.GEE_ID, GEE.USU_ID
		FROM REM01.ACT_ACTIVO ACT
		JOIN REM01.DD_CRA_CARTERA CRA
		  ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
		JOIN REM01.ACT_OFR    AOF
		  ON AOF.ACT_ID = ACT.ACT_ID
		JOIN REM01.OFR_OFERTAS OFR
		  ON OFR.OFR_ID = AOF.OFR_ID
		JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO
		  ON ECO.OFR_ID = OFR.OFR_ID
		JOIN REM01.GCO_GESTOR_ADD_ECO GCO
		  ON GCO.ECO_ID = ECO.ECO_ID
		JOIN REM01.GEE_GESTOR_ENTIDAD GEE
		  ON GEE.GEE_ID = GCO.GEE_ID
		JOIN REMMASTER.DD_TGE_TIPO_GESTOR TGE
		  ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
		LEFT JOIN REMMASTER.USU_USUARIOS USU
		  ON USU.USU_ID = GEE.USU_ID
		JOIN REM01.GCH_GESTOR_ECO_HISTORICO GCH
		  ON GCH.ECO_ID = ECO.ECO_ID
		JOIN REM01.GEH_GESTOR_ENTIDAD_HIST GEH
		  ON GEH.GEH_ID = GCH.GEH_ID
		 AND GEH.DD_TGE_ID = TGE.DD_TGE_ID
		WHERE TGE.DD_TGE_CODIGO IN (''GFORM'')
		  AND CRA.DD_CRA_CODIGO = ''12''
		  AND ACT.BORRADO = 0
		  AND OFR.BORRADO = 0
		  AND ECO.BORRADO = 0
		  AND GEE.BORRADO = 0  AND GEE.USU_ID IS NULL
		  ORDER BY 1, 2
	))
	AND USU_ID IS NULL
	ORDER BY 2,1
	) T2
	ON T1.ECO_ID = T2.ECO_ID';
	DBMS_OUTPUT.PUT_LINE('[INFO] Tabla REM01.AUX_MMC_GIANTS_GFORM_USU creada correctamente.');
	
	
	EXECUTE IMMEDIATE 
   'CREATE TABLE REM01.AUX_MMC_GIANTS_GFORM_GCO AS
	SELECT GCO.GEE_ID, GCO.ECO_ID 
	FROM REM01.GCO_GESTOR_ADD_ECO     GCO 
	JOIN REM01.GEE_GESTOR_ENTIDAD     GEE
	  ON GEE.GEE_ID = GCO.GEE_ID
	JOIN REMMASTER.DD_TGE_TIPO_GESTOR TGE
	  ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
	WHERE TGE.DD_TGE_CODIGO IN (''GFORM'') 
	AND USU_ID IS NOT NULL
	AND GCO.ECO_ID IN 
	(
		SELECT ECO_ID FROM (
		SELECT DISTINCT ECO.ECO_ID, GEE.GEE_ID, GEE.USU_ID
		FROM REM01.ACT_ACTIVO ACT
		JOIN REM01.DD_CRA_CARTERA CRA
		  ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
		JOIN REM01.ACT_OFR    AOF
		  ON AOF.ACT_ID = ACT.ACT_ID
		JOIN REM01.OFR_OFERTAS OFR
		  ON OFR.OFR_ID = AOF.OFR_ID
		JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO
		  ON ECO.OFR_ID = OFR.OFR_ID
		JOIN REM01.GCO_GESTOR_ADD_ECO GCO
		  ON GCO.ECO_ID = ECO.ECO_ID
		JOIN REM01.GEE_GESTOR_ENTIDAD GEE
		  ON GEE.GEE_ID = GCO.GEE_ID
		JOIN REMMASTER.DD_TGE_TIPO_GESTOR TGE
		  ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
		LEFT JOIN REMMASTER.USU_USUARIOS USU
		  ON USU.USU_ID = GEE.USU_ID
		JOIN REM01.GCH_GESTOR_ECO_HISTORICO GCH
		  ON GCH.ECO_ID = ECO.ECO_ID
		JOIN REM01.GEH_GESTOR_ENTIDAD_HIST GEH
		  ON GEH.GEH_ID = GCH.GEH_ID
		 AND GEH.DD_TGE_ID = TGE.DD_TGE_ID
		WHERE TGE.DD_TGE_CODIGO IN (''GFORM'')
		  AND CRA.DD_CRA_CODIGO = ''12''
		  AND ACT.BORRADO = 0
		  AND OFR.BORRADO = 0
		  AND ECO.BORRADO = 0
		  AND GEE.BORRADO = 0  AND GEE.USU_ID IS NULL
		  ORDER BY 1, 2
	))
	ORDER BY 2,1
	';
	DBMS_OUTPUT.PUT_LINE('[INFO] Tabla REM01.AUX_MMC_GIANTS_GFORM_GCO creada correctamente.');
	
    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
		DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
		DBMS_OUTPUT.PUT_LINE(SQLERRM);
		ROLLBACK;
		RAISE;

END;
/
EXIT;
