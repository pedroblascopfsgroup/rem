--/*
--##########################################
--## AUTOR=Guillermo Llidó
--## FECHA_CREACION=20190404
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-ROLLBACK
--## PRODUCTO=NO
--##
--## Finalidad: ROLLBACK HREOS-5932
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	
    V_COUNT NUMBER(16):= 0;
    V_COUNT2 NUMBER(16):= 0;
    
BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO]: ROLLBACK ');
	
	V_MSQL := 'UPDATE REM01.ACT_ACTIVO set 
					DD_TCO_ID = (SELECT TCO.DD_TCO_ID FROM REM01.DD_TCO_TIPO_COMERCIALIZACION TCO WHERE TCO.DD_TCO_CODIGO = ''03'')
				WHERE  USUARIOMODIFICAR = ''HREOS-5932-PUNTO1''';	
	
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('	[INFO] Se han actualizado '||SQL%ROWCOUNT||' registros. ACT_ACTIVO');
	
	V_MSQL := 'UPDATE REM01.ACT_PTA_PATRIMONIO_ACTIVO SET CHECK_HPM = 1 WHERE USUARIOMODIFICAR = ''HREOS-5932-PUNTO1''';
	
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('	[INFO] Se han actualizado '||SQL%ROWCOUNT||' registros. ACT_PTA_PATRIMONIO_ACTIVO');
	
	V_MSQL := 'UPDATE REM01.ACT_SPS_SIT_POSESORIA SET 
						SPS_OCUPADO = 1 
					,   DD_TPA_ID = (SELECT TPA.DD_TPA_ID FROM REM01.DD_TPA_TIPO_TITULO_ACT TPA WHERE DD_TPA_CODIGO = ''01'')
				WHERE USUARIOMODIFICAR = ''HREOS-5932-PUNTO1''';
	
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('	[INFO] Se han actualizado '||SQL%ROWCOUNT||' registros. ACT_SPS_SIT_POSESORIA');
	
	V_MSQL := 'UPDATE REM01.GEE_GESTOR_ENTIDAD SET 
						BORRADO = 0 
				WHERE USUARIOBORRAR = ''HREOS-5932-PUNTO1''';
	
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('	[INFO] Se han actualizado '||SQL%ROWCOUNT||' registros. GEE_GESTOR_ENTIDAD');
	
	V_MSQL := 'UPDATE REM01.GEH_GESTOR_ENTIDAD_HIST SET 
					BORRADO = 0 
				, 	GEH_FECHA_HASTA = NULL
				WHERE USUARIOBORRAR = ''HREOS-5932-PUNTO1''';
	
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('	[INFO] Se han actualizado '||SQL%ROWCOUNT||' registros. GEH_GESTOR_ENTIDAD_HIST');
	
	V_MSQL := 'MERGE INTO REM01.ACT_APU_ACTIVO_PUBLICACION APU 
				USING (SELECT AHP_ID, ACT_ID, DD_TPU_ID, DD_EPV_ID, DD_EPA_ID, DD_TCO_ID, DD_MTO_V_ID, AHP_MOT_OCULTACION_MANUAL_V, AHP_CHECK_PUBLICAR_V, AHP_CHECK_OCULTAR_V, AHP_CHECK_OCULTAR_PRECIO_V, AHP_CHECK_PUB_SIN_PRECIO_V, DD_MTO_A_ID, AHP_MOT_OCULTACION_MANUAL_A, AHP_CHECK_PUBLICAR_A, AHP_CHECK_OCULTAR_A, AHP_CHECK_OCULTAR_PRECIO_A, AHP_CHECK_PUB_SIN_PRECIO_A, AHP_FECHA_INI_VENTA, AHP_FECHA_FIN_VENTA, AHP_FECHA_INI_ALQUILER, AHP_FECHA_FIN_ALQUILER, VERSION, USUARIOCREAR, FECHACREAR, USUARIOMODIFICAR, FECHAMODIFICAR, USUARIOBORRAR, FECHABORRAR, BORRADO, ES_CONDICONADO_ANTERIOR, DD_TPU_V_ID, DD_TPU_A_ID 
						FROM REM01.ACT_AHP_HIST_PUBLICACION where USUARIOCREAR = ''HREOS-5932-PUNTO1''
						) T2
				ON (apu.act_id = t2.act_id)
				WHEN MATCHED THEN UPDATE SET 
					APU.DD_TPU_ID	= T2.DD_TPU_ID
				,	APU.DD_EPV_ID	= T2.DD_EPV_ID
				,	APU.DD_EPA_ID	= T2.DD_EPA_ID
				,	APU.DD_TCO_ID	= (SELECT TCO.DD_TCO_ID FROM REM01.DD_TCO_TIPO_COMERCIALIZACION TCO WHERE TCO.DD_TCO_CODIGO = ''03'')
				,	APU.DD_MTO_V_ID	= T2.DD_MTO_V_ID
				,	APU.APU_MOT_OCULTACION_MANUAL_V	= T2.AHP_MOT_OCULTACION_MANUAL_V
				,	APU.APU_CHECK_PUBLICAR_V	= T2.AHP_CHECK_PUBLICAR_V
				,	APU.APU_CHECK_OCULTAR_V	= T2.AHP_CHECK_OCULTAR_V
				,	APU.APU_CHECK_OCULTAR_PRECIO_V	= T2.AHP_CHECK_OCULTAR_PRECIO_V
				,	APU.APU_CHECK_PUB_SIN_PRECIO_V	= T2.AHP_CHECK_PUB_SIN_PRECIO_V
				,	APU.DD_MTO_A_ID	= T2.DD_MTO_A_ID
				,	APU.APU_MOT_OCULTACION_MANUAL_A	= T2.AHP_MOT_OCULTACION_MANUAL_A
				,	APU.APU_CHECK_PUBLICAR_A	= T2.AHP_CHECK_PUBLICAR_A
				,	APU.APU_CHECK_OCULTAR_A	= T2.AHP_CHECK_OCULTAR_A
				,	APU.APU_CHECK_OCULTAR_PRECIO_A	= T2.AHP_CHECK_OCULTAR_PRECIO_A
				,	APU.APU_CHECK_PUB_SIN_PRECIO_A	= T2.AHP_CHECK_PUB_SIN_PRECIO_A
				,	APU.APU_FECHA_INI_VENTA	= T2.AHP_FECHA_INI_VENTA
				,	APU.APU_FECHA_INI_ALQUILER	= T2.AHP_FECHA_INI_ALQUILER
				,	APU.VERSION	= T2.VERSION
				,	APU.USUARIOCREAR	= T2.USUARIOCREAR
				,	APU.FECHACREAR	= T2.FECHACREAR
				,	APU.USUARIOMODIFICAR	= T2.USUARIOMODIFICAR
				,	APU.FECHAMODIFICAR	= T2.FECHAMODIFICAR
				,	APU.USUARIOBORRAR	= T2.USUARIOBORRAR
				,	APU.FECHABORRAR	= T2.FECHABORRAR
				,	APU.BORRADO	= T2.BORRADO
				,	APU.ES_CONDICONADO_ANTERIOR	= T2.ES_CONDICONADO_ANTERIOR
				,	APU.DD_TPU_V_ID	= T2.DD_TPU_V_ID
				,	APU.DD_TPU_A_ID	= T2.DD_TPU_A_ID
				';
	
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('	[INFO] Se han actualizado '||SQL%ROWCOUNT||' registros.ACT_APU_ACTIVO_PUBLICACION ');
	
	V_MSQL := 'DELETE FROM REM01.ACT_AHP_HIST_PUBLICACION where USUARIOCREAR = ''HREOS-5932-PUNTO1''';
	
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('	[INFO] Se han borrado '||SQL%ROWCOUNT||' registros. ACT_AHP_HIST_PUBLICACION');
	
	V_MSQL := 'UPDATE REM01.ACT_AHP_HIST_PUBLICACION SET AHP_FECHA_FIN_ALQUILER = NULL , FECHAMODIFICAR  = NULL where USUARIOMODIFICAR = ''HREOS-5932-PUNTO1''';
	
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('	[INFO] Se han actualizado '||SQL%ROWCOUNT||' registros. ACT_AHP_HIST_PUBLICACION' );
	
    V_MSQL := 'UPDATE REM01.ACT_APU_ACTIVO_PUBLICACION SET DD_TCO_ID  =  (SELECT TCO.DD_TCO_ID FROM REM01.DD_TCO_TIPO_COMERCIALIZACION TCO WHERE TCO.DD_TCO_CODIGO = ''03'') 
                    WHERE APU_ID IN(
                    SELECT  APU.APU_ID FROM REM01.ACT_ACTIVO act
                    inner join REM01.ACT_APU_ACTIVO_PUBLICACION apu on act.act_id = apu.act_id
                    where act.USUARIOMODIFICAR = ''HREOS-5932-PUNTO1'' and ACT.DD_SCM_ID <> 5)';
                        
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('	[INFO] Se han actualizado '||SQL%ROWCOUNT||' registros. ACT_APU_ACTIVO_PUBLICACION' );
    	
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN]: ROLLBACK FINALIZADO ');
   

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;

/

EXIT


