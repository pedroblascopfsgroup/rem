--/*
--#########################################
--## AUTOR=Pablo Meseguer
--## FECHA_CREACION=20190329
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.17
--## INCIDENCIA_LINK=HREOS-5904
--## PRODUCTO=NO
--## 
--## Finalidad: Creación tabla 'AUX_HREOS_5904'
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;
DECLARE 

V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.  

BEGIN


EXECUTE IMMEDIATE '
MERGE INTO REM01.TAC_TAREAS_ACTIVOS TAC
USING (
        SELECT DISTINCT AUX1.TAR_ID, AUX1.USU_ID_DIST
        FROM REM01.AUX_HREOS_5904 AUX1
        WHERE NVL(USU_ID_TAC, 0) = NVL(USU_ID_BASE_ANT,0)
        AND AUX1.TAR_ID NOT IN (3915327, 3586682)
      ) AUX
ON (TAC.TAR_ID = AUX.TAR_ID)
WHEN MATCHED THEN UPDATE SET
TAC.USU_ID = AUX.USU_ID_DIST,
TAC.USUARIOMODIFICAR = ''HREOS-5904'',
TAC.FECHAMODIFICAR = SYSDATE';

DBMS_OUTPUT.PUT_LINE('[INFO] TAC_TAREAS_ACTIVOS CON  '|| SQL%ROWCOUNT ||' FILAS ');


EXECUTE IMMEDIATE '
UPDATE REM01.TAC_TAREAS_ACTIVOS TAC
SET TAC.USU_ID = (SELECT USU_ID FROM REMMASTER.USU_USUARIOS WHERE USU_USERNAME = ''qipert03''),
TAC.USUARIOMODIFICAR = ''HREOS-5904'',
TAC.FECHAMODIFICAR = SYSDATE
WHERE TAR_ID = 3586682';

DBMS_OUTPUT.PUT_LINE('[INFO] USU_ID_BASE_ANT CON  '|| SQL%ROWCOUNT ||' FILAS ');

EXECUTE IMMEDIATE '
UPDATE REM01.TAC_TAREAS_ACTIVOS TAC
SET TAC.USU_ID = (SELECT USU_ID FROM REMMASTER.USU_USUARIOS WHERE USU_USERNAME = ''montalvo03''),
TAC.USUARIOMODIFICAR = ''HREOS-5904'',
TAC.FECHAMODIFICAR = SYSDATE
WHERE TAR_ID = 3915327';

DBMS_OUTPUT.PUT_LINE('[INFO] USU_ID_BASE_ANT CON  '|| SQL%ROWCOUNT ||' FILAS ');


commit;

EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/

EXIT;
