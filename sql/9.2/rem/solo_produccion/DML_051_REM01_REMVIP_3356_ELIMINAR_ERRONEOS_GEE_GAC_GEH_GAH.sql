--/*
--#########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20190218
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-3356
--## PRODUCTO=NO
--## 
--## Finalidad: BORRADO DE DUPLICADOS DE LAS TABLAS GEE, GAC, GEH Y GAH
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
V_SQL VARCHAR2(10000 CHAR);
V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

BEGIN			
			
	DBMS_OUTPUT.PUT_LINE('[INICIO]');

	--TABLAS GEE Y GAC

	DBMS_OUTPUT.PUT_LINE('[*LIMPIEZA ACTIVOS CON MAS DE UN GESTOR BACKOFFICE, DIREFENTES*]');

	DBMS_OUTPUT.PUT_LINE('[BORRADO LOGICO DE REGISTRO DE LA TABLA GEE_GESTOR_ENTIDAD]');

	DBMS_OUTPUT.PUT_LINE('[*LIMPIEZA TABLAS GEE Y GAC*]');
	
		V_SQL := '
		UPDATE '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD 
			SET BORRADO = 1,
		   	USUARIOBORRAR = ''REMVIP_3356_2'',
		   	FECHABORRAR = SYSDATE
			WHERE GEE_ID IN (
		           SELECT GEE.GEE_ID 
			   FROM  '||V_ESQUEMA||'.ACT_ACTIVO ACT
			   JOIN  '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GAC.ACT_ID = ACT.ACT_ID 
			   JOIN  '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID  
			   JOIN  '||V_ESQUEMA||'.V_GESTORES_ACTIVO VG ON VG.ACT_ID = ACT.ACT_ID AND VG.TIPO_GESTOR = ''HAYAGBOINM'' 
			   JOIN  '||V_ESQUEMA_M||'.USU_USUARIOS USU ON USU.USU_ID = GEE.USU_ID 
			   WHERE GEE.DD_TGE_ID = 441 AND ACT.DD_CRA_ID = 1 
			   AND USU.USU_USERNAME <> VG.USERNAME 
			   AND ACT.ACT_ID IN (SELECT ACT_ID  FROM (
							    SELECT ACT.ACT_ID,  
							    ROW_NUMBER() OVER (PARTITION BY ACT.ACT_ID,GEE.DD_TGE_ID, TRUNC(GEE.FECHACREAR)  ORDER BY 1 ASC) AS RN
							    FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
							    JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GAC.ACT_ID = ACT.ACT_ID 
							    JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID 
							    WHERE GEE.DD_TGE_ID = 441 
							    AND ACT.DD_CRA_ID = 1 
							    ORDER BY 1 ASC
						       	 )
						WHERE RN > 1))';

	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han BORRADO (LOGICO) '||SQL%ROWCOUNT||' registros de la tabla GEE_GESTOR_ENTIDAD');

	DBMS_OUTPUT.PUT_LINE('[BORRADO REGISTROS DE LA TABLA GAC_GESTOR_ADD_ACTIVO]');
	
		V_SQL := 'DELETE FROM '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO WHERE GEE_ID IN (                        
				    SELECT GAC.GEE_ID 
				    FROM '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO  GAC
				    JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID 
				    WHERE GEE.BORRADO = 1 
				    AND GEE.USUARIOBORRAR = ''REMVIP_3356_2'')';

	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han BORRADO '||SQL%ROWCOUNT||' registros de la tabla GAC_GESTOR_ADD_ACTIVO');

	DBMS_OUTPUT.PUT_LINE('[BORRADO REGISTROS DE LA TABLA GEE_GESTOR_ENTIDAD]');
	
		V_SQL := 'DELETE FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE 
				    WHERE GEE.BORRADO = 1 
				    AND GEE.USUARIOBORRAR = ''REMVIP_3356_2''';

	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han BORRADO '||SQL%ROWCOUNT||' registros de la tabla GEE_GESTOR_ENTIDAD');

	--TABLAS GEH Y GAH

	DBMS_OUTPUT.PUT_LINE('[*LIMPIEZA TABLAS GEH Y GAH*]');

	DBMS_OUTPUT.PUT_LINE('[BORRADO LOGICO DE REGISTRO DE LA TABLA GEH_GESTOR_ENTIDAD_HIST]');
	
		V_SQL := '
		UPDATE '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST 
			SET BORRADO = 1,
		   	USUARIOBORRAR = ''REMVIP_3356_2'',
		   	FECHABORRAR = SYSDATE
			WHERE GEH_ID IN (
 				SELECT GEH.GEH_ID 
				FROM  '||V_ESQUEMA||'.ACT_ACTIVO ACT
				JOIN  '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH ON GAH.ACT_ID = ACT.ACT_ID 
				JOIN  '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH ON GEH.GEH_ID = GAH.GEH_ID  
				JOIN '||V_ESQUEMA||'.V_GESTORES_ACTIVO VG ON VG.ACT_ID = ACT.ACT_ID AND VG.TIPO_GESTOR = ''HAYAGBOINM'' 
				JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON USU.USU_ID = GEH.USU_ID 
				WHERE GEH.DD_TGE_ID = 441 AND ACT.DD_CRA_ID = 1 
				AND USU.USU_USERNAME <> VG.USERNAME 
				AND ACT.ACT_ID IN (SELECT ACT_ID  FROM (
				    SELECT ACT.ACT_ID,  
				    ROW_NUMBER() OVER (PARTITION BY ACT.ACT_ID,GEH.DD_TGE_ID, TRUNC(GEH.FECHACREAR)  ORDER BY 1 ASC) AS RN
				    FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
				    JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH ON GAH.ACT_ID = ACT.ACT_ID 
				    JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH ON GEH.GEH_ID = GAH.GEH_ID 
				    WHERE GEH.DD_TGE_ID = 441 
				    AND ACT.DD_CRA_ID = 1 
				    ORDER BY 1 ASC
		               	 )
                        WHERE RN > 1))';

	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han BORRADO (LOGICO) '||SQL%ROWCOUNT||' registros de la tabla GEH_GESTOR_ENTIDAD_HIST');

	DBMS_OUTPUT.PUT_LINE('[BORRADO REGISTROS DE LA TABLA GAH_GESTOR_ACTIVO_HISTORICO]');
	
		V_SQL := 'DELETE FROM '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO WHERE GEH_ID IN (                        
				    SELECT GAH.GEH_ID 
				    FROM '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO  GAH
				    JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH ON GEH.GEH_ID = GAH.GEH_ID
				    WHERE GEH.BORRADO = 1 
				    AND GEH.USUARIOBORRAR = ''REMVIP_3356_2'')';

	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han BORRADO '||SQL%ROWCOUNT||' registros de la tabla GAH_GESTOR_ACTIVO_HISTORICO');

	DBMS_OUTPUT.PUT_LINE('[BORRADO REGISTROS DE LA TABLA GEH_GESTOR_ENTIDAD_HIST]');
	
		V_SQL := 'DELETE FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH 
				    WHERE GEH.BORRADO = 1 
				    AND GEH.USUARIOBORRAR = ''REMVIP_3356_2''';

	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han BORRADO '||SQL%ROWCOUNT||' registros de la tabla GEH_GESTOR_ENTIDAD_HIST');

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      ROLLBACK;
      RAISE;
END;

/

EXIT
