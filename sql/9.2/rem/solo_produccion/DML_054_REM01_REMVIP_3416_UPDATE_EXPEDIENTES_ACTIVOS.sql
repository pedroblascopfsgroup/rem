--/*
--#########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20190221
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-3416
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
V_SQL VARCHAR2(10000 CHAR);
V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
PL_OUTPUT VARCHAR2(32000 CHAR);

BEGIN			
			
	DBMS_OUTPUT.PUT_LINE('[INICIO]');

	--TABLAS GEE Y GAC
	
       V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_ACTIVO SET ACT_VENTA_EXTERNA_FECHA = NULL,
		ACT_VENTA_EXTERNA_IMPORTE = NULL,
		USUARIOMODIFICAR = ''REMVIP-3416'',
		FECHAMODIFICAR = SYSDATE,
		DD_SCM_ID = 2 
		WHERE ACT_ID IN 
		(SELECT ACT.ACT_ID FROM '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR 
		INNER JOIN '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGR.AGR_ID = AGA.AGR_ID
		INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON AGA.ACT_ID = ACT.ACT_ID
		INNER JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.AGR_ID = AGR.AGR_ID
		INNER JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID AND ECO.ECO_FECHA_ANULACION IS NULL AND ECO.ECO_BLOQUEADO = 1
		WHERE AGR.AGR_NUM_AGRUP_REM IN (1000002963,1000006511,1000006502,9282263))';

	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado '||SQL%ROWCOUNT||' registros');

 	V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO SET PAC_CHECK_COMERCIALIZAR = 1, 
		PAC_CHECK_FORMALIZAR = 1, 
		USUARIOMODIFICAR = ''REMVIP-3416'',
		FECHAMODIFICAR = SYSDATE
		WHERE ACT_ID IN  
		(SELECT ACT.ACT_ID FROM '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR 
		INNER JOIN '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGR.AGR_ID = AGA.AGR_ID
		INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON AGA.ACT_ID = ACT.ACT_ID
		INNER JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.AGR_ID = AGR.AGR_ID
		INNER JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID AND ECO.ECO_FECHA_ANULACION IS NULL AND ECO.ECO_BLOQUEADO = 1
		WHERE AGR.AGR_NUM_AGRUP_REM IN (1000002963,1000006511,1000006502,9282263))';

	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado '||SQL%ROWCOUNT||' registros');

	V_SQL := 'UPDATE '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL SET ECO_FECHA_CONT_PROPIETARIO = NULL, 
		ECO_FECHA_VENTA = NULL,
		USUARIOMODIFICAR = ''REMVIP-3416'',
		FECHAMODIFICAR = SYSDATE
		WHERE ECO_ID IN  
		(SELECT ECO.ECO_ID FROM '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR 
		INNER JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.AGR_ID = AGR.AGR_ID
		INNER JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID AND ECO.ECO_FECHA_ANULACION IS NULL AND ECO.ECO_BLOQUEADO = 1
		WHERE AGR.AGR_NUM_AGRUP_REM IN (1000002963,1000006511,1000006502,9282263))';

	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado '||SQL%ROWCOUNT||' registros');

	REM01.AVANCE_TRAMITE('REMVIP-3416','136426,133400,139817,139773','T013_PosicionamientoYFirma',null,null,PL_OUTPUT);

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      ROLLBACK;
      RAISE;
END;

/

EXIT
