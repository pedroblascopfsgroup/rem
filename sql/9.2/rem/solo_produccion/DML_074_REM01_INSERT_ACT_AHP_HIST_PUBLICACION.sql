--/*
--#########################################
--## AUTOR=Adrián Molina
--## FECHA_CREACION=20190905
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-5095
--## PRODUCTO=NO
--## 
--## Finalidad: Cambio 
--##
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE



	V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
	V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
	V_SENTENCIA VARCHAR2(32000 CHAR);
	


BEGIN

      DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO ');
      
 
      V_SENTENCIA := '

    
MERGE INTO '|| V_ESQUEMA ||'.ACT_AHP_HIST_PUBLICACION T1
USING (
   SELECT ACT_NUM_ACTIVO, APU.* FROM '|| V_ESQUEMA ||'.ACT_APU_ACTIVO_PUBLICACION APU
   JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON ACT.ACT_ID = APU.ACT_ID
   WHERE ACT_NUM_ACTIVO > 0
   AND ACT.ACT_NUM_ACTIVO IN (
       133629,
       133629,
       138783,
       138785,
       138786,
       139297,
       145536
   )
) T2
ON (T1.ACT_ID = T2.ACT_ID AND T1.BORRADO = 0)
WHEN NOT MATCHED THEN INSERT (
   T1.AHP_ID
   ,T1.ACT_ID
   ,T1.DD_TPU_ID
   ,T1.DD_EPV_ID
   ,T1.DD_EPA_ID
   ,T1.DD_TCO_ID
   ,T1.DD_MTO_V_ID
   ,T1.AHP_MOT_OCULTACION_MANUAL_V
   ,T1.AHP_CHECK_PUBLICAR_V
   ,T1.AHP_CHECK_OCULTAR_V
   ,T1.AHP_CHECK_OCULTAR_PRECIO_V
   ,T1.AHP_CHECK_PUB_SIN_PRECIO_V
   ,T1.DD_MTO_A_ID
   ,T1.AHP_MOT_OCULTACION_MANUAL_A
   ,T1.AHP_CHECK_PUBLICAR_A
   ,T1.AHP_CHECK_OCULTAR_A
   ,T1.AHP_CHECK_OCULTAR_PRECIO_A
   ,T1.AHP_CHECK_PUB_SIN_PRECIO_A
   ,T1.AHP_FECHA_INI_VENTA
   ,T1.AHP_FECHA_FIN_VENTA
   ,T1.AHP_FECHA_INI_ALQUILER
   ,T1.AHP_FECHA_FIN_ALQUILER
   ,T1.VERSION
   ,T1.USUARIOCREAR
   ,T1.FECHACREAR
   ,T1.BORRADO
   ,T1.ES_CONDICONADO_ANTERIOR
   ,T1.DD_TPU_V_ID
   ,T1.DD_TPU_A_ID
   ) VALUES (
   '|| V_ESQUEMA ||'.S_ACT_AHP_HIST_PUBLICACION.NEXTVAL
   ,T2.ACT_ID
   ,T2.DD_TPU_ID
   ,T2.DD_EPV_ID
   ,T2.DD_EPA_ID
   ,T2.DD_TCO_ID
   ,T2.DD_MTO_V_ID
   ,T2.APU_MOT_OCULTACION_MANUAL_V
   ,T2.APU_CHECK_PUBLICAR_V
   ,T2.APU_CHECK_OCULTAR_V
   ,T2.APU_CHECK_OCULTAR_PRECIO_V
   ,T2.APU_CHECK_PUB_SIN_PRECIO_V
   ,T2.DD_MTO_A_ID
   ,T2.APU_MOT_OCULTACION_MANUAL_A
   ,T2.APU_CHECK_PUBLICAR_A
   ,T2.APU_CHECK_OCULTAR_A
   ,T2.APU_CHECK_OCULTAR_PRECIO_A
   ,T2.APU_CHECK_PUB_SIN_PRECIO_A
   ,APU_FECHA_INI_VENTA
   ,NULL
   ,APU_FECHA_INI_ALQUILER
   ,NULL
   ,0
   ,''SUPER''
   ,SYSDATE
   ,0
   ,T2.ES_CONDICONADO_ANTERIOR
   ,T2.DD_TPU_V_ID
   ,T2.DD_TPU_A_ID
)';


      EXECUTE IMMEDIATE V_SENTENCIA;
      
      DBMS_OUTPUT.PUT_LINE('[INFO] CAMBIADAS  '||SQL%ROWCOUNT||' Filas.');
    
   
   COMMIT;
      
   
      
EXCEPTION
      WHEN OTHERS THEN
            DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
            DBMS_OUTPUT.put_line('-----------------------------------------------------------');
            DBMS_OUTPUT.put_line(SQLERRM);
            ROLLBACK;
            RAISE;
END;

/

EXIT;
