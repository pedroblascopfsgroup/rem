--/*
--#########################################
--## AUTOR=Oscar Diestre
--## FECHA_CREACION=20190408
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=REMVIP-3941
--## PRODUCTO=NO
--## 
--## Finalidad: Cambiar estado gastos para que queden 'anulados'
--##                    
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
V_TABLA VARCHAR2(40 CHAR) := '';
V_SQL VARCHAR2(32767 CHAR);
V_SENTENCIA VARCHAR2(32000 CHAR);
PL_OUTPUT VARCHAR2(32000 CHAR);
V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-3948';

BEGIN
	
	PL_OUTPUT := '[INICIO]'||CHR(10)



	V_SQL := '
	MERGE INTO ' || V_ESQUEMA || '.GPV_GASTOS_PROVEEDOR T1 USING
(
    SELECT GPV.GPV_ID
    FROM ' || V_ESQUEMA || '.GPV_GASTOS_PROVEEDOR GPV
    JOIN ' || V_ESQUEMA || '.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
    WHERE GPV.GPV_NUM_GASTO_HAYA IN  ( 

                                        	10359596	,
                                        	10381093	,
                                        	10420104	,
                                        	10423373	,
                                        	10423374	,
                                        	10423375	,
                                        	10423376	,
                                        	10423377	,
                                        	10423378	,
                                        	10423379	,
                                        	10423380	,
                                        	10423381	,
                                        	10423382	,
                                        	10423383	,
                                        	10423384	,
                                        	10423385	,
                                        	10423386	,
                                        	10423387	,
                                        	10423388	,
                                        	10423389	,
                                        	10423390	,
                                        	10423391	,
                                        	10423392	,
                                        	10423393	,
                                        	10423394	,
                                        	10423395	,
                                        	10423396	,
                                        	10423397	,
                                        	10423398	,
                                        	10423399	,
                                        	10423400	,
                                        	10423401	,
                                        	10423402	,
                                        	10423403	,
                                        	10423404	,
                                        	10423405	,
                                        	10423406	,
                                        	10423407	,
                                        	10423408	,
                                        	10423409	,
                                        	10423410	,
                                        	10423411	,
                                        	10423412	,
                                        	10423413	,
                                        	10423414	,
                                        	10423415	,
                                        	10423416	,
                                        	10423417	,
                                        	10423418	,
                                        	10423419	,
                                        	10423420	,
                                        	10423421	,
                                        	10423422	,
                                        	10423423	,
                                        	10423424	,
                                        	10423425	,
                                        	10423426	,
                                        	10423427	,
                                        	10423428	,
                                        	10423429	,
                                        	10423430	,
                                        	10423431	,
                                        	10423432	,
                                        	10423433	,
                                        	10423434	,
                                        	10423435	,
                                        	10423436	,
                                        	10423437	,
                                        	10423438	,
                                        	10423439	,
                                        	10423440	,
                                        	10423441	,
                                        	10423442	,
                                        	10423443	,
                                        	10423444	,
                                        	10423445	,
                                        	10423446	,
                                        	10423447	,
                                        	10423448	,
                                        	10423449	,
                                        	10423450	,
                                        	10423451	,
                                        	10423452	,
                                        	10423453	,
                                        	10423454	,
                                        	10423455	,
                                        	10423456	,
                                        	10423457	,
                                        	10423458	,
                                        	10423459	,
                                        	10423460	,
                                        	10423461	,
                                        	10423462	,
                                        	10423463	,
                                        	10423464	,
                                        	10423465	,
                                        	10423466	,
                                        	10423467	,
                                        	10423468	,
                                        	10423469	,
                                        	10423470	,
                                        	10423471	,
                                        	10423472	,
                                        	10423473	,
                                        	10423474	,
                                        	10423475	,
                                        	10423476	,
                                        	10423477	,
                                        	10423478	,
                                        	10423479	,
                                        	10423480	,
                                        	10423481	,
                                        	10423482	,
                                        	10423483	,
                                        	10423484	,
                                        	10423485	,
                                        	10423486	,
                                        	10423487	,
                                        	10423488	,
                                        	10423489	,
                                        	10423490	,
                                        	10423491	,
                                        	10423492	,
                                        	10423493	,
                                        	10423494	,
                                        	10423495	,
                                        	10423496	,
                                        	10423497	,
                                        	10423498	,
                                        	10423499	,
                                        	10423500	,
                                        	10423501	,
                                        	10423502	,
                                        	10423503	,
                                        	10423504	,
                                        	10423505	,
                                        	10423506	,
                                        	10423507	,
                                        	10423508	,
                                        	10423509	,
                                        	10423510	,
                                        	10423511	,
                                        	10424848	,
                                        	10424849	,
                                        	10424850	,
                                        	10424851	,
                                        	10424852	,
                                        	10424853	,
                                        	10424854	,
                                        	10424855	,
                                        	10424856	,
                                        	10424857	,
                                        	10424858	,
                                        	10424859	,
                                        	10424860	,
                                        	10424861	,
                                        	10424862	,
                                        	10424863	,
                                        	10424864	,
                                        	10424865	,
                                        	10424866	,
                                        	10424867	,
                                        	10424868	,
                                        	10424869	,
                                        	10424870	,
                                        	10424871	,
                                        	10424872	,
                                        	10424873	,
                                        	10424874	,
                                        	10433829	,
                                        	10433830	,
                                        	10433831	,
                                        	10433832	,
                                        	10433833	,
                                        	10433834	,
                                        	10433835	,
                                        	10435530	,
                                        	10435531	,
                                        	10435532	,
                                        	10435533	,
                                        	10435534	,
                                        	10435535	,
                                        	10435536	,
                                        	10435537	,
                                        	10435538	,
                                        	10435539	,
                                        	10435540	,
                                        	10435541	,
                                        	10435542	,
                                        	10435543	,
                                        	10435544	,
                                        	10435545	,
                                        	10435546	,
                                        	10435547	,
                                        	10435548	,
                                        	10435549	,
                                        	10435550	,
                                        	10435551	,
                                        	10435552	,
                                        	10435553	,
                                        	10435554	,
                                        	10435555	,
                                        	10435556	,
                                        	10435557	,
                                        	10439041	,
                                        	10439042	,
                                        	10439043	,
                                        	10439044	,
                                        	10439045	,
                                        	10439046	,
                                        	10439047	,
                                        	10439048	,
                                        	10446803	,
                                        	10446804	,
                                        	10446805	,
                                        	10446806	,
                                        	10446807	,
                                        	10446808	,
                                        	10446809	,
                                        	10446810	,
                                        	10446811	,
                                        	10446812	,
                                        	10446813	,
                                        	10446814	,
                                        	10446815	,
                                        	10446816	,
                                        	10446817	,
                                        	10446818	,
                                        	10446819	,
                                        	10446820	,
                                        	10446821	,
                                        	10447849	,
                                        	10447850	,
                                        	10447851	,
                                        	10447852	,
                                        	10447853	,
                                        	10447854	,
                                        	10447855	,
                                        	10447856	,
                                        	10447857	,
                                        	10447858	,
                                        	10447859	,
                                        	10447860	,
                                        	10447861	,
                                        	10447862	,
                                        	10447863	,
                                        	10447864	,
                                        	10447865	,
                                        	10447866	,
                                        	10447867	,
                                        	10447868	,
                                        	10447869	,
                                        	10447870	,
                                        	10447871	,
                                        	10447872	,
                                        	10447873	,
                                        	10447874	,
                                        	10447875	,
                                        	10447876	,
                                        	10447877	,
                                        	10447878	,
                                        	10447879	,
                                        	10447880	,
                                        	10447881	,
                                        	10450333	,
                                        	10450334	,
                                        	10450335	,
                                        	10450336	,
                                        	10450337	,
                                        	10450338	,
                                        	10450339	,
                                        	10450340	,
                                        	10450341	,
                                        	10450342	,
                                        	10450343	,
                                        	10450344	,
                                        	10450345	,
                                        	10450346	,
                                        	10450347	,
                                        	10450348	,
                                        	10450349	,
                                        	10450350	,
                                        	10450351	,
                                        	10450352	,
                                        	10450353	,
                                        	10450354	,
                                        	10450355	,
                                        	10450356	,
                                        	10450357	,
                                        	10450358	,
                                        	10450359	,
                                        	10450360	,
                                        	10450361	,
                                        	10450362	,
                                        	10450363	,
                                        	10450364	,
                                        	10450365	,
                                        	10450366	,
                                        	10450367	,
                                        	10450368	,
                                        	10450369	,
                                        	10450370	,
                                        	10450371	,
                                        	10450372	,
                                        	10450373	,
                                        	10450374	,
                                        	10450375	,
                                        	10450376	,
                                        	10450377	,
                                        	10450378	,
                                        	10450379	,
                                        	10450380	,
                                        	10450381	,
                                        	10455353	,
                                        	10455354	,
                                        	10455355	,
                                        	10455356	


				)     
)T2 ON (T1.GPV_ID = T2.GPV_ID) 
WHEN MATCHED THEN
        UPDATE
        SET T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM  ' || V_ESQUEMA || '.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''06''),
    	    T1.USUARIOMODIFICAR = ''' || V_USUARIO || ''',
            T1.FECHAMODIFICAR = SYSDATE';
            
    EXECUTE IMMEDIATE V_SQL;
    DBMS_OUTPUT.PUT_LINE('  [INFO] '||SQL%ROWCOUNT||' GASTOS CAMBIADOS A ESTADO <ANULADO> ');

    
    COMMIT;

	PL_OUTPUT := PL_OUTPUT || '[FIN]'||CHR(10);
	DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);

EXCEPTION
      WHEN OTHERS THEN
            DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
            DBMS_OUTPUT.put_line('-----------------------------------------------------------');
            DBMS_OUTPUT.put_line(SQLERRM);
            ROLLBACK;
            RAISE;
END;
/
EXIT;
