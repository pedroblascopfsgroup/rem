--/*
--#########################################
--## AUTOR=Oscar Diestre
--## FECHA_CREACION=20190410
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-3958
--## PRODUCTO=NO
--## 
--## Finalidad: Actualizar la cuenta contable de gastos.
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-3958';

	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_SQL VARCHAR2(4000 CHAR);

	V_GPV_ID VARCHAR(50 CHAR); -- Vble. que almacena el id del gasto.
	
	V_EXISTE_GASTO NUMBER(16); -- Vble. para almacenar el resultado de la busqueda.



    TYPE T_GASTO IS TABLE OF VARCHAR2(1000);

    TYPE T_ARRAY_GASTOS IS TABLE OF T_GASTO;
    V_GASTOS T_ARRAY_GASTOS := T_ARRAY_GASTOS(
		 
                --NUMERO GASTO
T_GASTO('10263197'),
T_GASTO('10263198'),
T_GASTO('10263199'),
T_GASTO('10263200'),
T_GASTO('10263201'),
T_GASTO('10263202'),
T_GASTO('10263203'),
T_GASTO('10263204'),
T_GASTO('10263205'),
T_GASTO('10263206'),
T_GASTO('10263211'),
T_GASTO('10263212'),
T_GASTO('10263213'),
T_GASTO('10263214'),
T_GASTO('10263215'),
T_GASTO('10263216'),
T_GASTO('10263217'),
T_GASTO('10263218'),
T_GASTO('10263219'),
T_GASTO('10263220'),
T_GASTO('10263221'),
T_GASTO('10263223'),
T_GASTO('10263224'),
T_GASTO('10263225'),
T_GASTO('10263226'),
T_GASTO('10263227'),
T_GASTO('10263228'),
T_GASTO('10263229'),
T_GASTO('10263230'),
T_GASTO('10263231'),
T_GASTO('10263232'),
T_GASTO('10263233'),
T_GASTO('10263234'),
T_GASTO('10263235'),
T_GASTO('10263236'),
T_GASTO('10263237'),
T_GASTO('10263238'),
T_GASTO('10263239'),
T_GASTO('10263240'),
T_GASTO('10263242'),
T_GASTO('10263243'),
T_GASTO('10263244'),
T_GASTO('10263245'),
T_GASTO('10263246'),
T_GASTO('10263247'),
T_GASTO('10263248'),
T_GASTO('10263249'),
T_GASTO('10263250'),
T_GASTO('10263251'),
T_GASTO('10263252'),
T_GASTO('10263254'),
T_GASTO('10263255'),
T_GASTO('10263256'),
T_GASTO('10263257'),
T_GASTO('10263258'),
T_GASTO('10263259'),
T_GASTO('10263260'),
T_GASTO('10263261'),
T_GASTO('10263262'),
T_GASTO('10263263'),
T_GASTO('10263264'),
T_GASTO('10263265'),
T_GASTO('10263266'),
T_GASTO('10263267'),
T_GASTO('10263268'),
T_GASTO('10263269'),
T_GASTO('10263270'),
T_GASTO('10263271'),
T_GASTO('10263272'),
T_GASTO('10263273'),
T_GASTO('10263274'),
T_GASTO('10263275'),
T_GASTO('10263276'),
T_GASTO('10263277'),
T_GASTO('10263278'),
T_GASTO('10263279'),
T_GASTO('10263280'),
T_GASTO('10263281'),
T_GASTO('10263282'),
T_GASTO('10263283'),
T_GASTO('10263284'),
T_GASTO('10263285'),
T_GASTO('10263286'),
T_GASTO('10263287'),
T_GASTO('10263288'),
T_GASTO('10263289'),
T_GASTO('10263290'),
T_GASTO('10263291'),
T_GASTO('10263292'),
T_GASTO('10263293'),
T_GASTO('10263294'),
T_GASTO('10263295'),
T_GASTO('10263296'),
T_GASTO('10263297'),
T_GASTO('10263298'),
T_GASTO('10263299'),
T_GASTO('10263300'),
T_GASTO('10263301'),
T_GASTO('10263302'),
T_GASTO('10263303'),
T_GASTO('10263304'),
T_GASTO('10263305'),
T_GASTO('10263306'),
T_GASTO('10263307'),
T_GASTO('10263308'),
T_GASTO('10263311'),
T_GASTO('10263312'),
T_GASTO('10263313'),
T_GASTO('10263314'),
T_GASTO('10263315'),
T_GASTO('10263316'),
T_GASTO('10263317'),
T_GASTO('10263318'),
T_GASTO('10263319'),
T_GASTO('10263320'),
T_GASTO('10263321'),
T_GASTO('10263322'),
T_GASTO('10263323'),
T_GASTO('10263324'),
T_GASTO('10263325'),
T_GASTO('10263326'),
T_GASTO('10263327'),
T_GASTO('10263328'),
T_GASTO('10263427')
	
   ); 
    V_TMP_GASTO T_GASTO;



BEGIN

	DBMS_OUTPUT.PUT_LINE('[INICIO] Haciendo comprobaciones previas... ');


		FOR I IN V_GASTOS.FIRST .. V_GASTOS.LAST
		LOOP
			V_TMP_GASTO := V_GASTOS(I);

			DBMS_OUTPUT.PUT_LINE('[INFO] Comprobando que existe el gasto '||TRIM(V_TMP_GASTO(1))||'.');

			V_SQL := 'SELECT COUNT(1)
					  FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR 
					  WHERE GPV_NUM_GASTO_HAYA = '||TRIM(V_TMP_GASTO(1));

			EXECUTE IMMEDIATE V_SQL INTO V_EXISTE_GASTO;

			IF V_EXISTE_GASTO > 0 THEN

				DBMS_OUTPUT.PUT_LINE('[INFO] Recogiendo el id del gasto '||TRIM(V_TMP_GASTO(1))||'.');

				V_SQL := 'SELECT GPV_ID
					  FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR 
					  WHERE GPV_NUM_GASTO_HAYA = '||TRIM(V_TMP_GASTO(1));

				EXECUTE IMMEDIATE V_SQL INTO V_GPV_ID;

				DBMS_OUTPUT.PUT_LINE('[INFO] Actualizando el gasto '||TRIM(V_TMP_GASTO(1)) );

				V_SQL := 'UPDATE '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD
					  SET GIC_CUENTA_CONTABLE = ''6220000000'',
					      GIC_PTDA_PRESUPUESTARIA = ''G011309'',
					      USUARIOMODIFICAR = ''REMVIP-3958'',
					      FECHAMODIFICAR = SYSDATE
					  WHERE GPV_ID = '||V_GPV_ID||'';

				EXECUTE IMMEDIATE V_SQL;

				V_SQL := 'UPDATE '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR
					  SET DD_EGA_ID = (SELECT DD_EGA_ID FROM  ' || V_ESQUEMA || '.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''01''),
					      USUARIOMODIFICAR = ''REMVIP-3958'',
					      FECHAMODIFICAR = SYSDATE
					  WHERE GPV_ID = '||V_GPV_ID||'';

				EXECUTE IMMEDIATE V_SQL;

				DBMS_OUTPUT.PUT_LINE('[INFO] El gasto '||TRIM(V_TMP_GASTO(1))||' ha sido actualizado.');

			ELSE 
				DBMS_OUTPUT.PUT_LINE('[INFO] No se ha encontrado el gasto '||TRIM(V_TMP_GASTO(1))  );
			END IF;

		END LOOP;



	COMMIT;

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      DBMS_OUTPUT.PUT_LINE(V_SQL);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
