--/*
--#########################################
--## AUTOR=JINLI HU
--## FECHA_CREACION=20190108
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-2982
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; --'#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; --'#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA_1 VARCHAR2(25 CHAR):= 'BIE_VALORACIONES';
    V_TABLA_2 VARCHAR2(25 CHAR):= 'ACT_TAS_TASACION';
    V_COUNT NUMBER(16); -- Vble. para contar.
    V_KOUNT NUMBER(16); -- Vble. para kontar.
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USUARIO VARCHAR2(32 CHAR):= 'REMVIP-2982';

	ACT_NUM_ACTIVO NUMBER(16);
	ACT_ID NUMBER(16);
	NUM_SECUENCIA_VAL NUMBER(16);
	NUM_SECUENCIA_TAS NUMBER(16);
	BIE_ID NUMBER(16);

    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
	T_JBV('6044007','74700.42','02/11/2018'),
	T_JBV('6044008','100810.87','19/12/2018'),
	T_JBV('6044010','109689.34','28/11/2018'),
	T_JBV('6044019','129602.08','03/12/2018'),
	T_JBV('6044023','138272.12','19/12/2018'),
	T_JBV('6044025','90295.26','26/11/2018'),
	T_JBV('6044031','8524.75','11/12/2018'),
	T_JBV('6044037','37521.7','27/12/2018'),
	T_JBV('6044040','44843.43','28/12/2018'),
	T_JBV('6044041','9988','19/12/2018'),
	T_JBV('6044043','127025.6','12/12/2018'),
	T_JBV('6044045','85000','31/12/2018'),
	T_JBV('6044051','14671.28','15/11/2018'),
	T_JBV('6044055','49517.78','25/10/2018'),
	T_JBV('6044058','38602.39','21/12/2018'),
	T_JBV('6044059','89367.42','14/11/2018'),
	T_JBV('6044076','9786.66','22/11/2018'),
	T_JBV('6044077','50098.57','31/07/2018'),
	T_JBV('6044084','100792.42','26/11/2018'),
	T_JBV('6044093','101484.3','28/12/2018'),
	T_JBV('6044099','43884.91','21/11/2018'),
	T_JBV('6044117','8064.15','04/12/2018'),
	T_JBV('6044118','8064.15','04/12/2018'),
	T_JBV('6044119','233385.32','17/10/2018'),
	T_JBV('6044122','207748.4','27/12/2018'),
	T_JBV('6044125','60860.98','10/12/2018'),
	T_JBV('6044127','3729.97','19/10/2018'),
	T_JBV('6044128','83289.5','21/11/2018'),
	T_JBV('6044133','200054.66','03/12/2018'),
	T_JBV('6044134','136274.69','27/12/2018'),
	T_JBV('6044135','8500','31/12/2018'),
	T_JBV('6044168','97768.21','18/12/2018'),
	T_JBV('6044178','7679.14','27/08/2018'),
	T_JBV('6044181','75303.04','03/12/2018'),
	T_JBV('6044182','15782.7','03/12/2018'),
	T_JBV('6044198','147943.73','11/12/2018'),
	T_JBV('6044202','35618.68','26/12/2018'),
	T_JBV('6044207','11970.4','05/11/2018'),
	T_JBV('6044213','90479.99','13/12/2018'),
	T_JBV('6044214','116788.96','21/11/2018'),
	T_JBV('6044215','266672.14','20/11/2018'),
	T_JBV('6044216','14006.72','07/12/2018'),
	T_JBV('6044222','122003.86','04/12/2018'),
	T_JBV('6044223','172581','28/11/2018'),
	T_JBV('6044225','128635.99','26/12/2018'),
	T_JBV('6044228','120932.57','26/11/2018'),
	T_JBV('6044229','104247.13','09/08/2018'),
	T_JBV('6044231','38113.03','10/08/2018'),
	T_JBV('6044232','90712.02','12/11/2018'),
	T_JBV('6044233','32276.77','02/11/2018'),
	T_JBV('6044261','71345.95','15/11/2018'),
	T_JBV('6044262','66524.37','20/11/2018'),
	T_JBV('6044265','154708.65','23/11/2018'),
	T_JBV('6044270','31745.26','31/07/2018'),
	T_JBV('6044272','55583.58','05/12/2018'),
	T_JBV('6044273','9154.01','19/12/2018'),
	T_JBV('6044274','47120.37','21/11/2018'),
	T_JBV('6044276','118982.36','21/11/2018'),
	T_JBV('6044280','41503.14','15/11/2018'),
	T_JBV('6044287','66305.35','18/12/2018'),
	T_JBV('6044290','219179.56','19/10/2018'),
	T_JBV('6044303','63421.03','04/12/2018'),
	T_JBV('6044308','179102.23','21/11/2018'),
	T_JBV('6044309','105811.15','21/12/2018'),
	T_JBV('6044315','145666.16','26/11/2018'),
	T_JBV('6044325','42886.45','15/11/2018'),
	T_JBV('6084921','103265.41','19/10/2018'),
	T_JBV('6084928','7573.57','19/11/2018'),
	T_JBV('6084940','116217.28','26/12/2018'),
	T_JBV('6084943','100500.75','21/11/2018'),
	T_JBV('6084944','196504.95','27/11/2018'),
	T_JBV('6084990','35138.64','16/11/2018'),
	T_JBV('6084997','98703.99','19/11/2018'),
	T_JBV('6084999','155663.59','30/11/2018'),
	T_JBV('6085004','38178','22/11/2018'),
	T_JBV('6085006','41194.85','26/11/2018'),
	T_JBV('6129203','124530.98','13/12/2018'),
	T_JBV('6762164','51136.11','13/12/2018'),
	T_JBV('6762172','43053.72','15/11/2018'),
	T_JBV('6762176','134450.91','05/12/2018'),
	T_JBV('6762178','36583.31','15/11/2018'),
	T_JBV('6762180','47361.44','18/12/2018'),
	T_JBV('6762183','42601.69','13/12/2018'),
	T_JBV('6762186','31797.58','13/12/2018'),
	T_JBV('6762192','41963.47','15/11/2018'),
	T_JBV('6762195','282512.07','30/10/2018'),
	T_JBV('6762197','47258.47','23/10/2018'),
	T_JBV('6762200','52839.34','12/11/2018'),
	T_JBV('6762204','78775.34','27/12/2018'),
	T_JBV('6762205','71727.77','08/11/2018'),
	T_JBV('6762206','43970.89','08/11/2018'),
	T_JBV('6762216','54977.4','23/11/2018'),
	T_JBV('6762218','19958.4','18/10/2018'),
	T_JBV('6762219','54977.4','23/11/2018'),
	T_JBV('6762221','84366.82','31/12/2018'),
	T_JBV('6762226','66382.97','26/11/2018'),
	T_JBV('6762229','73320.42','31/12/2018'),
	T_JBV('6762231','60953.58','12/11/2018'),
	T_JBV('6762233','6128.88','04/12/2018'),
	T_JBV('6762236','48939.78','31/10/2018'),
	T_JBV('6762237','109874.47','03/12/2018'),
	T_JBV('6762240','66721.05','28/12/2018'),
	T_JBV('6762241','325583.78','13/11/2018'),
	T_JBV('6762252','38068.7','24/12/2018'),
	T_JBV('6762253','4818.49','26/12/2018'),
	T_JBV('6762255','56775.76','26/12/2018'),
	T_JBV('6762258','150186.75','12/11/2018'),
	T_JBV('6762266','32675.35','28/11/2018'),
	T_JBV('6762269','5442.95','27/11/2018'),
	T_JBV('6762283','167985.81','26/12/2018'),
	T_JBV('6762284','176827.17','26/12/2018'),
	T_JBV('6762286','153205.88','24/09/2018'),
	T_JBV('6762288','203539.32','27/12/2018'),
	T_JBV('6762289','81945.88','28/11/2018'),
	T_JBV('6762294','36602.26','13/12/2018'),
	T_JBV('6762297','720396.09','19/11/2018'),
	T_JBV('6762298','108998.32','28/12/2018'),
	T_JBV('6762299','205321.77','20/11/2018'),
	T_JBV('6762300','8542.61','11/12/2018'),
	T_JBV('6762301','74758.74','05/12/2018'),
	T_JBV('6762305','58885.36','26/11/2018'),
	T_JBV('6762316','47557.04','07/12/2018'),
	T_JBV('6762321','176321.36','10/12/2018'),
	T_JBV('6762324','125157.31','30/11/2018'),
	T_JBV('6762327','13863.1','05/12/2018'),
	T_JBV('6762329','45838.04','30/11/2018'),
	T_JBV('6762333','134830.59','05/12/2018'),
	T_JBV('6762334','101999','27/12/2018'),
	T_JBV('6762338','94786.18','13/11/2018'),
	T_JBV('6762344','97956.46','17/12/2018'),
	T_JBV('6762347','39922.06','11/12/2018'),
	T_JBV('6762349','65398.1','23/11/2018'),
	T_JBV('6762351','10175.08','31/10/2018'),
	T_JBV('6762352','10175.08','31/10/2018'),
	T_JBV('6762354','166721.85','11/12/2018'),
	T_JBV('6762356','36859.44','26/11/2018'),
	T_JBV('6762358','42284.14','26/11/2018'),
	T_JBV('6762359','40306.66','13/12/2018'),
	T_JBV('6762360','97699.95','13/12/2018'),
	T_JBV('6762370','54364.34','02/11/2018'),
	T_JBV('6762371','26540.26','02/11/2018'),
	T_JBV('6762374','46382.63','26/12/2018'),
	T_JBV('6762379','35481.99','04/12/2018'),
	T_JBV('6762380','47869.17','14/11/2018'),
	T_JBV('6762382','61585.79','12/12/2018'),
	T_JBV('6762383','5991.43','27/11/2018'),
	T_JBV('6762386','118964.73','22/10/2018'),
	T_JBV('6762395','113650.6','26/11/2018'),
	T_JBV('6762402','192887.21','11/12/2018'),
	T_JBV('6762403','98352.05','05/12/2018'),
	T_JBV('6762405','89046.89','14/11/2018'),
	T_JBV('6762406','167847.88','13/12/2018'),
	T_JBV('6775896','52405.41','13/12/2018'),
	T_JBV('6776330','95100.23','30/11/2018'),
	T_JBV('6779872','8086.56','04/12/2018'),
	T_JBV('6782713','65746.15','26/11/2018'),
	T_JBV('6800124','6042.10','27/11/2018'),
	T_JBV('6800129','77843.08','26/11/2018'),
	T_JBV('6801267','49688.34','04/12/2018'),
	T_JBV('6803449','42284.14','26/11/2018'),
	T_JBV('6803464','5680.85','30/11/2018'),
	T_JBV('6809878','27543.53','17/10/2018'),
	T_JBV('6813894','59490.89','21/11/2018'),
	T_JBV('6817105','102741.29','27/12/2018'),
	T_JBV('6817107','11674.07','18/10/2018'),
	T_JBV('6824968','150622.62','10/12/2018'),
	T_JBV('6826882','161682.18','05/12/2018'),
	T_JBV('6826980','48459.95','07/12/2018'),
	T_JBV('6831681','4970.83','06/11/2018'),
	T_JBV('6831688','90423.89','05/12/2018'),
	T_JBV('6831689','75948.35','31/10/2018'),
	T_JBV('6840017','98366.14','23/11/2018'),
	T_JBV('6841482','205460.1','20/11/2018'),
	T_JBV('6950335','7966.62','22/11/2018'),
	T_JBV('6950336','7966.62','22/11/2018'),
	T_JBV('6950337','7966.62','22/11/2018'),
	T_JBV('6950343','65487.15','15/11/2018'),
	T_JBV('6950349','60692.88','04/12/2018'),
	T_JBV('6959841','139778.78','10/12/2018'),
	T_JBV('7007129','112516.22','18/10/2018'),
	T_JBV('7011995','79917.86','07/02/2018'),
	T_JBV('7011997','43487.39','13/12/2018'),
	T_JBV('7011998','7352.04','12/12/2018'),
	T_JBV('7015170','184526','04/12/2018'),
	T_JBV('7017063','100390.53','25/10/2018'),
	T_JBV('7020236','142313.85','17/12/2018'),
	T_JBV('7029113','172791.98','02/11/2018'),
	T_JBV('7030296','90778.89','23/10/2018'),
	T_JBV('7031952','162977.14','17/12/2018'),
	T_JBV('7073193','47413.75','28/12/2018'),
	T_JBV('7074194','10997.31','28/12/2018'),
	T_JBV('7074195','68476.03','26/12/2018'),
	T_JBV('6127802','90009.14','26/12/2018'));
	V_TMP_JBV T_JBV;
	
BEGIN

	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
	V_TMP_JBV := V_JBV(I);
	
  	ACT_NUM_ACTIVO := TRIM(V_TMP_JBV(1));
  			  
  	EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO INTO V_KOUNT;
  			  
	IF V_KOUNT > 0 THEN 
  			  
		EXECUTE IMMEDIATE 'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO INTO ACT_ID;
		
		EXECUTE IMMEDIATE 'SELECT BIE_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO INTO BIE_ID;
		
		EXECUTE IMMEDIATE 'SELECT '||V_ESQUEMA||'.S_BIE_VALORACIONES.NEXTVAL FROM DUAL' INTO NUM_SECUENCIA_VAL;
		
		EXECUTE IMMEDIATE 'SELECT '||V_ESQUEMA||'.S_ACT_TAS_TASACION.NEXTVAL FROM DUAL' INTO NUM_SECUENCIA_TAS;

		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_1||' (BIE_ID, BIE_VAL_ID, BIE_FECHA_VALOR_TASACION, FECHACREAR, 
		USUARIOCREAR, VERSION, BORRADO)
				  SELECT '''||BIE_ID||''', 
						 '''||NUM_SECUENCIA_VAL||''',
						 TO_DATE('''||TRIM(V_TMP_JBV(3))||''', ''DD/MM/RR''),
						 SYSDATE,
						 '''||V_USUARIO||''',
						 0,
						 0
				  FROM DUAL';
		EXECUTE IMMEDIATE V_SQL;
		
		DBMS_OUTPUT.PUT_LINE('INSERTADO EL ACTIVO '||ACT_NUM_ACTIVO||' EN '||V_TABLA_1);
		
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_2||' (ACT_ID, BIE_VAL_ID, TAS_ID, DD_TTS_ID, TAS_NOMBRE_TASADOR, FECHACREAR, 
		USUARIOCREAR, VERSION, BORRADO, TAS_FECHA_INI_TASACION, TAS_IMPORTE_TAS_FIN)
				  SELECT '''||ACT_ID||''',
						 '''||NUM_SECUENCIA_VAL||''',
						 '''||NUM_SECUENCIA_TAS||''',
						 (SELECT DD_TTS_ID FROM '||V_ESQUEMA||'.DD_TTS_TIPO_TASACION WHERE DD_TTS_CODIGO = ''03''),
						 ''GESTION DE VALORACIONES Y TASACIONES SA'',
						 SYSDATE,
						 '''||V_USUARIO||''',
						 0,
						 0,
						 TO_DATE('''||TRIM(V_TMP_JBV(3))||''', ''DD/MM/RR''),
						 '''||TRIM(V_TMP_JBV(2))||'''
				  FROM DUAL';
		EXECUTE IMMEDIATE V_SQL;
		
		DBMS_OUTPUT.PUT_LINE('INSERTADO EL ACTIVO '||ACT_NUM_ACTIVO||' EN '||V_TABLA_2);
		
		V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
	
	ELSE
		
		DBMS_OUTPUT.PUT_LINE('[INFO] El activo '||ACT_NUM_ACTIVO||' no existe!');
		
	END IF;
	
	END LOOP;			    
    
	COMMIT;

    DBMS_OUTPUT.PUT_LINE('[INFO] Se han insertado en total '||V_COUNT_UPDATE||' registros en la tabla '||V_TABLA_1);
    DBMS_OUTPUT.PUT_LINE('[INFO] Se han insertado en total '||V_COUNT_UPDATE||' registros en la tabla '||V_TABLA_2);

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
