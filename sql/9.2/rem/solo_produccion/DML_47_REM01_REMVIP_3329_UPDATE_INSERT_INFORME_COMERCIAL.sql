--/*
--######################################### 
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20190212
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=REMVIP-3329
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##                    
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

V_SQL VARCHAR2(4000 CHAR);
TABLE_COUNT NUMBER(1,0) := 0;
V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; -- Configuracion Esquema
V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
V_TABLESPACE_IDX VARCHAR2(30 CHAR) := '#TABLESPACE_INDEX#';
V_TABLA_TMP VARCHAR2(40 CHAR) := 'TMP_UPD_SUBTIPOS_LBK';
V_TABLA_ACT VARCHAR2(40 CHAR) := 'ACT_ACTIVO';
V_TABLA_SAC VARCHAR2(40 CHAR) := 'DD_SAC_SUBTIPO_ACTIVO';

BEGIN

/*UPDATE FECHAS ICO*/
	V_SQL := 'MERGE INTO REM01.ACT_ICO_INFO_COMERCIAL T1
			USING (
			    SELECT ACT.ACT_ID
			    FROM REM01.ACT_ACTIVO ACT 
			    INNER JOIN REM01.AUX_REMVIP_3329 AUX ON ACT.ACT_NUM_ACTIVO = AUX.NUM_ACT) T2
			ON (T1.ACT_ID = T2.ACT_ID)
			WHEN MATCHED THEN UPDATE SET
			T1.ICO_FECHA_EMISION_INFORME = SYSDATE,
			T1.ICO_FECHA_ACEPTACION = SYSDATE,
			T1.FECHAMODIFICAR = SYSDATE,
			T1.USUARIOMODIFICAR = ''REMVIP-3329''';
			
	EXECUTE IMMEDIATE V_SQL;
	DBMS_OUTPUT.PUT_LINE('MERGEADOS '||SQL%ROWCOUNT||' REGISTROS EN LA TABLA ACT_ICO_INFO_COMERCIAL');

/*UPDATE FECHAS ICO*/
	V_SQL := 'MERGE INTO REM01.ACT_SPS_SIT_POSESORIA T1
			USING (
			    SELECT ACT.ACT_ID
			    FROM REM01.ACT_ACTIVO ACT 
			    INNER JOIN REM01.AUX_REMVIP_3329 AUX ON ACT.ACT_NUM_ACTIVO = AUX.NUM_ACT) T2
			ON (T1.ACT_ID = T2.ACT_ID)
			WHEN MATCHED THEN UPDATE SET
			T1.SPS_OTRO = ''PRECOMERCIALIZACIÓN El Inmueble se encuentra en fase de evaluación y análisis, y por tanto sujeto a su previa clasificación y saneamiento jurídico.Puede ampliar información y consultar su situación actual, en HAYA: 901.11.77.88'',
			T1.FECHAMODIFICAR = SYSDATE,
			T1.USUARIOMODIFICAR = ''REMVIP-3329''';
			
	EXECUTE IMMEDIATE V_SQL;
	DBMS_OUTPUT.PUT_LINE('MERGEADOS '||SQL%ROWCOUNT||' REGISTROS EN LA TABLA ACT_SPS_SIT_POSESORIA');

/*insert historica a los que no tienen*/
	V_SQL := 'INSERT INTO REM01.ACT_HIC_EST_INF_COMER_HIST
			    (
			      HIC_ID
			      ,ACT_ID
			      ,DD_AIC_ID
			      ,HIC_FECHA
			      ,HIC_MOTIVO
			      ,VERSION
			      ,USUARIOCREAR
			      ,FECHACREAR
			      ,BORRADO
			    )
			SELECT 
			REM01.S_ACT_HIC_EST_INF_COMER_HIST.NEXTVAL AS HIC_ID,
			ACT_ID,
			2 AS DD_AIC_ID,
			SYSDATE AS HIC_FECHA,
			NULL AS HIC_MOTIVO,
			0 AS VERSION,
			''REMVIP-3329'' AS USUARIOCREAR,
			SYSDATE AS FECHACREAR,
			0 AS BORRADO
			FROM REM01.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID IN (SELECT ACT_ID FROM REM01.ACT_ACTIVO WHERE ACT_NUM_ACTIVO IN(SELECT NUM_ACT FROM REM01.AUX_REMVIP_3329))
			AND ACT_ID NOT IN (SELECT ACT_ID FROM REM01.ACT_HIC_EST_INF_COMER_HIST)';
			
	EXECUTE IMMEDIATE V_SQL;
	DBMS_OUTPUT.PUT_LINE('INSERTADOS '||SQL%ROWCOUNT||' REGISTROS EN LA TABLA ACT_HIC_EST_INF_COMER_HIST');

/*UPDATE FECHAS HISTORICA*/
	V_SQL := 'UPDATE REM01.ACT_HIC_EST_INF_COMER_HIST HIC 
			SET HIC_FECHA = SYSDATE, 
			USUARIOMODIFICAR = ''REMVIP-3329'' 
			WHERE USUARIOCREAR <> ''REMVIP-3329'' AND HIC_ID IN
			(SELECT HIC_ID 
			 FROM (
			    SELECT HIC_ID,
				   HIC.ACT_ID,
				   HIC.dd_aic_id,
				   ROW_NUMBER() OVER (PARTITION BY HIC.ACT_ID ORDER BY HIC.HIC_FECHA DESC) REF
			    FROM REM01.ACT_HIC_EST_INF_COMER_HIST HIC WHERE ACT_ID IN
				(SELECT ACT_ID FROM REM01.ACT_ACTIVO WHERE  ACT_NUM_ACTIVO IN(SELECT NUM_ACT FROM REM01.AUX_REMVIP_3329))
					) AUX2
			 WHERE AUX2.REF = 1 and dd_aic_id = 2)';
			
	EXECUTE IMMEDIATE V_SQL;
	DBMS_OUTPUT.PUT_LINE('UPDATEADOS '||SQL%ROWCOUNT||' REGISTROS EN LA TABLA ACT_HIC_EST_INF_COMER_HIST');

/*insert historica a los que tienen y la ultima no es aceptacion*/
	V_SQL := 'INSERT INTO REM01.ACT_HIC_EST_INF_COMER_HIST
			    (
			      HIC_ID
			      ,ACT_ID
			      ,DD_AIC_ID
			      ,HIC_FECHA
			      ,HIC_MOTIVO
			      ,VERSION
			      ,USUARIOCREAR
			      ,FECHACREAR
			      ,BORRADO
			    )
			SELECT 
			REM01.S_ACT_HIC_EST_INF_COMER_HIST.NEXTVAL AS HIC_ID,
			ACT_ID,
			2 AS DD_AIC_ID,
			SYSDATE AS HIC_FECHA,
			NULL AS HIC_MOTIVO,
			0 AS VERSION,
			''REMVIP-3329'' AS USUARIOCREAR,
			SYSDATE AS FECHACREAR,
			0 AS BORRADO
			FROM REM01.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID IN ((SELECT act_id 
										 FROM (
										    SELECT HIC_ID,
          										 HIC.ACT_ID,
											 HIC.dd_aic_id,
											   ROW_NUMBER() OVER (PARTITION BY HIC.ACT_ID ORDER BY HIC.HIC_FECHA DESC) REF
										    FROM REM01.ACT_HIC_EST_INF_COMER_HIST HIC WHERE ACT_ID IN
											(SELECT ACT_ID FROM REM01.ACT_ACTIVO WHERE  ACT_NUM_ACTIVO IN(SELECT NUM_ACT FROM REM01.AUX_REMVIP_3329))
												) AUX3
										 WHERE AUX3.REF = 1 and (dd_aic_id = 3 OR DD_AIC_ID = 1)))';
			
	EXECUTE IMMEDIATE V_SQL;
	DBMS_OUTPUT.PUT_LINE('INSERTADOS '||SQL%ROWCOUNT||' REGISTROS EN LA TABLA ACT_HIC_EST_INF_COMER_HIST');

	COMMIT;	  
 
EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/

EXIT;
