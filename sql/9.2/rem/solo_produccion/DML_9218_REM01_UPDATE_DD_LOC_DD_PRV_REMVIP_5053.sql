--/*
--###########################################
--## AUTOR=Viorel Remus Ovidiu
--## FECHA_CREACION=20190830
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-5053
--## PRODUCTO=NO
--## 
--## Finalidad: UPDATE provincia y poblacion
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE
  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  V_USUARIO VARCHAR2(100 CHAR) := 'REMVIP-5053';
  
  TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(1500);
  TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    ------ 	 activo , dd_loc_codigo,dd_prv_codigo
    	T_TIPO_DATA('7226180','04013','4'),
	T_TIPO_DATA('7226181','04013','4'),
	T_TIPO_DATA('7226182','21044','21'),
	T_TIPO_DATA('7226183','04053','4'),
	T_TIPO_DATA('7226184','04079','4'),
	T_TIPO_DATA('7226185','29067','29'),
	T_TIPO_DATA('7226186','11020','11'),
	T_TIPO_DATA('7226187','04079','4'),
	T_TIPO_DATA('7226188','21050','21'),
	T_TIPO_DATA('7226189','30003','30'),
	T_TIPO_DATA('7226190','47186','47'),
	T_TIPO_DATA('7226191','28079','28'),
	T_TIPO_DATA('7226192','24089','24'),
	T_TIPO_DATA('7226193','41091','41'),
	T_TIPO_DATA('7226194','04013','4'),
	T_TIPO_DATA('7226195','04013','4'),
	T_TIPO_DATA('7226196','11006','11'),
	T_TIPO_DATA('7226197','29067','29'),
	T_TIPO_DATA('7226198','04902','4'),
	T_TIPO_DATA('7226199','04030','4'),
	T_TIPO_DATA('7226200','29051','29'),
	T_TIPO_DATA('7226201','04079','4'),
	T_TIPO_DATA('7226202','04079','4'),
	T_TIPO_DATA('7226203','29070','29'),
	T_TIPO_DATA('7226204','04902','4'),
	T_TIPO_DATA('7226205','11020','11'),
	T_TIPO_DATA('7226206','23024','23'),
	T_TIPO_DATA('7226207','04079','4'),
	T_TIPO_DATA('7226208','21010','21'),
	T_TIPO_DATA('7226209','21010','21'),
	T_TIPO_DATA('7226210','18175','18'),
	T_TIPO_DATA('7226211','23024','23'),
	T_TIPO_DATA('7226212','04100','4'),
	T_TIPO_DATA('7226213','04079','4'),
	T_TIPO_DATA('7226214','04079','4'),
	T_TIPO_DATA('7226215','29094','29'),
	T_TIPO_DATA('7226216','18087','18'),
	T_TIPO_DATA('7226217','11006','11'),
	T_TIPO_DATA('7226218','04013','4'),
	T_TIPO_DATA('7226219','23024','23'),
	T_TIPO_DATA('7226220','23024','23'),
	T_TIPO_DATA('7226221','04013','4'),
	T_TIPO_DATA('7226222','11006','11'),
	T_TIPO_DATA('7226223','23060','23'),
	T_TIPO_DATA('7226224','29068','29'),
	T_TIPO_DATA('7226225','04100','4'),
	T_TIPO_DATA('7226226','04100','4'),
	T_TIPO_DATA('7226227','04053','4'),
	T_TIPO_DATA('7226228','04076','4'),
	T_TIPO_DATA('7226229','04013','4'),
	T_TIPO_DATA('7226230','41091','41'),
	T_TIPO_DATA('7226231','18087','18'),
	T_TIPO_DATA('7226232','29084','29'),
	T_TIPO_DATA('7226233','04064','4'),
	T_TIPO_DATA('7226234','29032','29'),
	T_TIPO_DATA('7226235','04013','4'),
	T_TIPO_DATA('7226236','41091','41'),
	T_TIPO_DATA('7226237','23005','23'),
	T_TIPO_DATA('7226238','29042','29'),
	T_TIPO_DATA('7226239','04064','4'),
	T_TIPO_DATA('7226240','04064','4'),
	T_TIPO_DATA('7226241','23050','23'),
	T_TIPO_DATA('7226243','13034','13'),
	T_TIPO_DATA('7226244','13082','13'),
	T_TIPO_DATA('7226245','23024','23'),
	T_TIPO_DATA('7226246','23050','23'),
	T_TIPO_DATA('7226247','29067','29'),
	T_TIPO_DATA('7226249','23095','23'),
	T_TIPO_DATA('7226250','11004','11'),
	T_TIPO_DATA('7226251','17027','17'),
	T_TIPO_DATA('7226252','11015','11'),
	T_TIPO_DATA('7226254','29094','29'),
	T_TIPO_DATA('7226255','18175','18'),
	T_TIPO_DATA('7226256','23092','23'),
	T_TIPO_DATA('7226257','04902','4'),
	T_TIPO_DATA('7226258','29015','29'),
	T_TIPO_DATA('7226259','47186','47'),
	T_TIPO_DATA('7226260','34120','34'),
	T_TIPO_DATA('7226261','47186','47'),
	T_TIPO_DATA('7226262','34157','34'),
	T_TIPO_DATA('7226263','47186','47'),
	T_TIPO_DATA('7226264','28113','28'),
	T_TIPO_DATA('7226265','28052','28'),
	T_TIPO_DATA('7226266','45121','45'),
	T_TIPO_DATA('7226267','50297','50'),
	T_TIPO_DATA('7226268','37274','37'),
	T_TIPO_DATA('7226269','47104','47'),
	T_TIPO_DATA('7226270','09219','9'),
	T_TIPO_DATA('7226271','31019','31'),
	T_TIPO_DATA('7226272','28096','28'),
	T_TIPO_DATA('7226273','47186','47'),
	T_TIPO_DATA('7226274','10148','10'),
	T_TIPO_DATA('7226275','47186','47'),
	T_TIPO_DATA('7226276','47104','47'),
	T_TIPO_DATA('7226277','26089','26'),
	T_TIPO_DATA('7226278','50297','50'),
	T_TIPO_DATA('7226279','29067','29'),
	T_TIPO_DATA('7226280','50297','50'),
	T_TIPO_DATA('7226281','28096','28'),
	T_TIPO_DATA('7226282','16112','16'),
	T_TIPO_DATA('7226283','37274','37'),
	T_TIPO_DATA('7226284','41004','41'),
	T_TIPO_DATA('7226285','41004','41'),
	T_TIPO_DATA('7226286','41095','41'),
	T_TIPO_DATA('7226287','41065','41'),
	T_TIPO_DATA('7226288','10037','10'),
	T_TIPO_DATA('7226289','10148','10'),
	T_TIPO_DATA('7226290','22125','22'),
	T_TIPO_DATA('7226291','46250','46'),
	T_TIPO_DATA('7226292','46250','46'),
	T_TIPO_DATA('7226293','29067','29'),
	T_TIPO_DATA('7226294','18175','18'),
	T_TIPO_DATA('7226295','18087','18'),
	T_TIPO_DATA('7226296','10148','10'),
	T_TIPO_DATA('7226298','28113','28'),
	T_TIPO_DATA('7226299','47104','47'),
	T_TIPO_DATA('7226300','47104','47'),
	T_TIPO_DATA('7226301','46110','46'),
	T_TIPO_DATA('7226302','04013','4'),
	T_TIPO_DATA('7226303','04902','4'),
	T_TIPO_DATA('7226304','23024','23'),
	T_TIPO_DATA('7226305','11033','11'),
	T_TIPO_DATA('7226306','04013','4'),
	T_TIPO_DATA('7226307','04013','4'),
	T_TIPO_DATA('7226308','04013','4'),
	T_TIPO_DATA('7226309','04013','4'),
	T_TIPO_DATA('7226310','04013','4'),
	T_TIPO_DATA('7226311','23095','23'),
	T_TIPO_DATA('7226312','04079','4'),
	T_TIPO_DATA('7226313','04079','4'),
	T_TIPO_DATA('7226314','04030','4'),
	T_TIPO_DATA('7226315','23092','23'),
	T_TIPO_DATA('7226316','04050','4'),
	T_TIPO_DATA('7226317','04013','4'),
	T_TIPO_DATA('7226318','21041','21'),
	T_TIPO_DATA('7226319','23092','23'),
	T_TIPO_DATA('7226320','21005','21'),
	T_TIPO_DATA('7226321','21005','21'),
	T_TIPO_DATA('7226322','04013','4'),
	T_TIPO_DATA('7226323','04013','4'),
	T_TIPO_DATA('7226324','04013','4'),
	T_TIPO_DATA('7226325','23060','23'),
	T_TIPO_DATA('7226329','23005','23'),
	T_TIPO_DATA('7226330','23005','23'),
	T_TIPO_DATA('7226331','29084','29'),
	T_TIPO_DATA('7226332','04013','4'),
	T_TIPO_DATA('7226333','04013','4'),
	T_TIPO_DATA('7226334','04902','4'),
	T_TIPO_DATA('7226335','30003','30'),
	T_TIPO_DATA('7226336','04902','4'),
	T_TIPO_DATA('7226337','23060','23'),
	T_TIPO_DATA('7226338','04013','4'),
	T_TIPO_DATA('7226339','04013','4'),
	T_TIPO_DATA('7226340','04013','4'),
	T_TIPO_DATA('7226341','04013','4'),
	T_TIPO_DATA('7226342','21041','21'),
	T_TIPO_DATA('7226343','04013','4'),
	T_TIPO_DATA('7226344','21010','21'),
	T_TIPO_DATA('7226345','04050','4'),
	T_TIPO_DATA('7226346','23050','23'),
	T_TIPO_DATA('7226347','04013','4'),
	T_TIPO_DATA('7226348','23050','23'),
	T_TIPO_DATA('7226349','23050','23'),
	T_TIPO_DATA('7226350','04902','4'),
	T_TIPO_DATA('7226351','13005','13'),
	T_TIPO_DATA('7226352','29015','29'),
	T_TIPO_DATA('7226353','09059','9'),
	T_TIPO_DATA('7226354','23092','23'),
	T_TIPO_DATA('7226355','22112','22'),
	T_TIPO_DATA('7226356','37046','37'),
	T_TIPO_DATA('7226357','06015','6'),
	T_TIPO_DATA('7226358','50297','50'),
	T_TIPO_DATA('7226359','31201','31'),
	T_TIPO_DATA('7226360','29067','29'),
	T_TIPO_DATA('7226361','29067','29'),
	T_TIPO_DATA('7226362','18087','18'),
	T_TIPO_DATA('7226363','18087','18'),
	T_TIPO_DATA('7226364','23005','23'),
	T_TIPO_DATA('7226365','18087','18'),
	T_TIPO_DATA('7226367','13005','13'),
	T_TIPO_DATA('7226368','18122','18'),
	T_TIPO_DATA('7226370','29067','29'),
	T_TIPO_DATA('7226371','18087','18'),
	T_TIPO_DATA('7226372','13093','13'),
	T_TIPO_DATA('7226373','18140','18'),
	T_TIPO_DATA('7226374','24089','24'),
	T_TIPO_DATA('7226375','24209','24'),
	T_TIPO_DATA('7226376','24209','24'),
	T_TIPO_DATA('7226377','15078','15'),
	T_TIPO_DATA('7226378','47186','47'),
	T_TIPO_DATA('7226379','15005','15'),
	T_TIPO_DATA('7226380','47104','47'),
	T_TIPO_DATA('7226381','33024','33'),
	T_TIPO_DATA('7226382','22066','22'),
	T_TIPO_DATA('7226383','22066','22'),
	T_TIPO_DATA('7226384','22066','22'),
	T_TIPO_DATA('7226385','22066','22'),
	T_TIPO_DATA('7226386','22066','22'),
	T_TIPO_DATA('7226387','22066','22'),
	T_TIPO_DATA('7226390','41095','41'),
	T_TIPO_DATA('7226391','41055','41'),
	T_TIPO_DATA('7226392','41091','41'),
	T_TIPO_DATA('7226393','14054','14'),
	T_TIPO_DATA('7226394','41038','41'),
	T_TIPO_DATA('7226395','14021','14'),
	T_TIPO_DATA('7226396','28079','28'),
	T_TIPO_DATA('7226397','29054','29'),
	T_TIPO_DATA('7226398','41038','41'),
	T_TIPO_DATA('7226399','11020','11'),
	T_TIPO_DATA('7226400','14021','14'),
	T_TIPO_DATA('7226401','14021','14'),
	T_TIPO_DATA('7226402','11032','11'),
	T_TIPO_DATA('7226403','11038','11'),
	T_TIPO_DATA('7226404','11020','11'),
	T_TIPO_DATA('7226405','41091','41'),
	T_TIPO_DATA('7226406','41091','41'),
	T_TIPO_DATA('7226407','11023','11'),
	T_TIPO_DATA('7226408','45081','45'),
	T_TIPO_DATA('7226409','11023','11'),
	T_TIPO_DATA('7226410','11004','11'),
	T_TIPO_DATA('7226411','14038','14'),
	T_TIPO_DATA('7226412','14058','14'),
	T_TIPO_DATA('7226413','11031','11'),
	T_TIPO_DATA('7226414','11031','11'),
	T_TIPO_DATA('7226415','14038','14'),
	T_TIPO_DATA('7226416','11004','11'),
	T_TIPO_DATA('7226417','11015','11'),
	T_TIPO_DATA('7226418','11020','11'),
	T_TIPO_DATA('7226419','11004','11'),
	T_TIPO_DATA('7226420','11004','11'),
	T_TIPO_DATA('7226421','11004','11'),
	T_TIPO_DATA('7226422','11024','11'),
	T_TIPO_DATA('7226423','11015','11'),
	T_TIPO_DATA('7226424','11023','11'),
	T_TIPO_DATA('7226425','14038','14'),
	T_TIPO_DATA('7226426','41091','41'),
	T_TIPO_DATA('7226427','41091','41'),
	T_TIPO_DATA('7226428','45168','45'),
	T_TIPO_DATA('7226429','45168','45'),
	T_TIPO_DATA('7226430','45168','45'),
	T_TIPO_DATA('7226431','45168','45'),
	T_TIPO_DATA('7226432','45168','45'),
	T_TIPO_DATA('7226433','45168','45'),
	T_TIPO_DATA('7226434','45168','45'),
	T_TIPO_DATA('7226435','45165','45'),
	T_TIPO_DATA('7226436','11030','11'),
	T_TIPO_DATA('7226437','41091','41'),
	T_TIPO_DATA('7226438','41004','41'),
	T_TIPO_DATA('7226439','41091','41'),
	T_TIPO_DATA('7226440','28079','28'),
	T_TIPO_DATA('7226441','28134','28'),
	T_TIPO_DATA('7226442','28079','28'),
	T_TIPO_DATA('7226443','28079','28'),
	T_TIPO_DATA('7226444','19092','19'),
	T_TIPO_DATA('7226445','19092','19'),
	T_TIPO_DATA('7226446','11004','11'),
	T_TIPO_DATA('7226447','11004','11'),
	T_TIPO_DATA('7226448','16078','16'),
	T_TIPO_DATA('7226449','19130','19'),
	T_TIPO_DATA('7226450','46250','46'),
	T_TIPO_DATA('7226451','11012','11'),
	T_TIPO_DATA('7226452','29051','29'),
	T_TIPO_DATA('7226453','28079','28'),
	T_TIPO_DATA('7226454','13034','13'),
	T_TIPO_DATA('7226455','04053','4'),
	T_TIPO_DATA('7226456','04013','4'),
	T_TIPO_DATA('7226851','11023','11'),
	T_TIPO_DATA('7226248','23005','23'),
	T_TIPO_DATA('7228150','29070','29')
	); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');

	 
    -- LOOP para actualizar los valores -----------------------------------------------------------------
    DBMS_OUTPUT.PUT_LINE('[INFO]: UPDATE PROVINCIA Y POBLACION DE REGISTRO');
    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
      LOOP
      
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
    
        --Comprobamos el dato a insertar
        V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
					INNER JOIN '||V_ESQUEMA||'.BIE_BIEN BIE ON ACT.BIE_ID = BIE.BIE_ID
					INNER JOIN '||V_ESQUEMA||'.BIE_DATOS_REGISTRALES DAT ON BIE.BIE_ID=DAT.BIE_ID 
					WHERE ACT.ACT_NUM_ACTIVO = '||TRIM(V_TMP_TIPO_DATA(1))||'';
		
       -- DBMS_OUTPUT.PUT_LINE(V_SQL);		
        EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
       -- DBMS_OUTPUT.PUT_LINE(V_NUM_TABLAS);
			--Si existe realizamos otra comprobacion
			IF V_NUM_TABLAS > 0 THEN	
			
					V_MSQL := 'UPDATE '||V_ESQUEMA||'.BIE_DATOS_REGISTRALES
									SET
										DD_LOC_ID = (SELECT DD_LOC_ID FROM '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD WHERE DD_LOC_CODIGO = '||TRIM(V_TMP_TIPO_DATA(2))||'),
										DD_PRV_ID = (SELECT DD_PRV_ID FROM '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA WHERE DD_PRV_CODIGO = '||TRIM(V_TMP_TIPO_DATA(3))||'),
										USUARIOMODIFICAR = '''||V_USUARIO||''',
										FECHAMODIFICAR = SYSDATE
									WHERE
									BIE_ID = (
										SELECT BIE_ID
										FROM '||V_ESQUEMA||'.ACT_ACTIVO
										WHERE ACT_NUM_ACTIVO = '||TRIM(V_TMP_TIPO_DATA(1))||'
									)';
					
					EXECUTE IMMEDIATE V_MSQL;	
				
			--El activo no existe
			ELSE
				  DBMS_OUTPUT.PUT_LINE('[ERROR]:  NO EXISTE EL ACTIVO '||TRIM(V_TMP_TIPO_DATA(1))||' ');
			END IF;
		
    END LOOP;
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN]:  LOS ACTIVOS HAN SIDO ACTUALIZADOS ');

EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
