--/*
--#########################################
--## AUTOR=Oscar Diestre Pérez
--## FECHA_CREACION=20191022
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-5511
--## PRODUCTO=NO
--## 
--## Finalidad: Carga masiva de aprobación del informe comercial
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 
DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    V_NUM_FILAS NUMBER(16); -- Vble. para validar la existencia de un registro.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-5511'; -- USUARIOCREAR/USUARIOMODIFICAR.

    
BEGIN		

        ---------------------------------------------------------------------------------

	DBMS_OUTPUT.PUT_LINE('[INICIO] Cerrando Tareas ');	

	V_MSQL := ' MERGE INTO '|| V_ESQUEMA ||'.TAR_TAREAS_NOTIFICACIONES TAR
		    USING( 

			 	SELECT DISTINCT TAR.TAR_ID
				FROM '||V_ESQUEMA||'.ACT_TRA_TRAMITE TRA, '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC, '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR
				WHERE 1 = 1
				AND DD_TPO_ID = ( SELECT DD_TPO_ID FROM '||V_ESQUEMA||'.DD_TPO_TIPO_PROCEDIMIENTO WHERE DD_TPO_CODIGO = ''T001'' )
				AND DD_EPR_ID = ( SELECT DD_EPR_ID FROM '||V_ESQUEMA_M||'.DD_EPR_ESTADO_PROCEDIMIENTO EPR WHERE DD_EPR_CODIGO = ''10'' )
				AND TAC.TAR_ID = TAR.TAR_ID
				AND TRA.TRA_ID = TAC.TRA_ID
				AND TAR.BORRADO = 0
				AND TAC.BORRADO = 0
				AND TRA.BORRADO = 0
				AND TRA.TRA_ID IN (
130141,
131125,
134294,
132773,
132873,
133173,
134957,
135557,
135657,
311656,
1216,
1259,
3103,
6565,
6565,
6566,
6566,
8403,
8795,
8800,
10762,
10905,
11283,
11284,
11286,
11404,
11559,
12294,
12294,
14523,
18037,
18047,
19524,
19549,
30622,
30660,
30691,
30707,
30724,
31101,
32610,
32636,
32639,
32934,
32938,
32944,
124216,
124216,
127172,
127180,
127221,
127240,
127251,
127254,
127279,
127346,
127347,
127353,
130773,
128844,
129381,
129627,
129929,
130229,
130281,
130353,
130363,
131214,
131594,
131653,
131764,
131917,
131997,
134021,
134045,
134046,
134058,
134070,
134089,
134098,
134106,
134110,
134112,
134123,
134133,
134143,
134175,
134200,
134203,
134205,
134210,
134212,
134242,
134324,
134383,
134414,
134417,
134433,
134434,
132072,
132083,
132090,
132101,
132129,
132130,
132161,
132167,
132169,
132182,
132192,
132217,
132222,
132248,
132259,
132276,
132299,
132303,
132313,
132320,
132323,
132325,
132346,
132347,
132348,
132360,
132366,
132404,
132420,
132455,
132495,
132544,
132548,
132553,
132555,
132572,
132576,
132578,
132596,
132610,
132633,
132638,
132650,
132657,
132696,
132701,
132743,
132745,
132750,
132752,
132764,
132790,
132801,
132828,
132867,
132871,
132879,
132895,
132905,
132906,
132907,
132914,
132916,
132943,
132947,
132951,
132965,
132985,
132995,
133007,
133014,
133029,
133048,
133050,
133051,
133052,
133079,
133082,
133099,
133127,
133153,
133154,
133165,
133181,
133183,
133184,
133188,
133202,
133219,
133223,
133251,
133256,
133287,
133295,
133326,
133329,
133336,
133374,
133390,
133397,
133399,
133411,
133425,
133435,
133455,
133458,
133462,
133475,
133495,
133507,
133544,
133551,
133595,
133605,
133655,
133664,
133665,
133666,
133679,
133695,
133713,
133728,
133739,
133748,
133769,
133785,
133794,
133797,
133801,
133804,
133844,
133853,
133865,
133883,
133887,
133922,
133944,
133949,
134463,
134465,
134468,
134469,
134488,
134492,
134541,
134563,
134577,
134578,
134611,
134622,
134655,
134690,
134697,
134705,
134714,
134715,
134736,
134748,
134759,
134770,
134775,
134796,
134805,
134813,
134814,
134843,
134888,
134890,
134898,
134933,
134944,
134953,
134991,
134999,
135004,
135019,
135035,
135064,
135088,
135100,
135109,
135110,
135121,
135128,
135142,
135166,
135206,
135246,
135261,
135311,
135317,
135328,
135343,
135355,
135393,
135395,
135411,
135422,
135432,
135443,
135447,
135460,
135496,
135562,
135608,
135620,
135674,
135712,
135724,
135728,
135737,
135749,
135759,
135778,
135779,
135783,
137547,
137966,
138633,
138646,
138658,
139733,
139743,
139744,
139782,
139798,
139813,
139840,
141097,
141120,
143870,
143877,
146009,
149026,
151988,
151989,
152005,
152034,
152104,
152116,
152117,
152134,
152142,
152151,
152157,
156511,
159311,
175901,
175947,
176363,
176369,
176373,
176390,
176392,
176397,
176407,
176971,
177472,
177519,
178572,
178575,
178577,
178958,
178963,
178975,
178977,
178987,
178988,
178989,
178992,
178994,
178997,
179001,
179008,
179010,
179012,
179013,
179016,
179741,
181083,
182967,
186240,
189933,
189941,
189949,
189958,
189969,
189971,
190073,
190098,
190101,
190115,
190130,
221352,
226237,
226259,
227348,
227352,
227354,
227356,
227417,
227419,
227429,
227478,
237304,
237312,
237313,
237327,
237360,
237362,
237365,
237366,
238019,
238028,
238032,
238033,
238071,
242493,
242500,
242503,
242512,
242544,
242564,
242568,
242592,
242612,
248267,
248269,
248277,
248301,
248342,
248376,
250656,
252027,
252797,
252810,
253395,
253400,
253412,
256742,
258089,
258094,
258097,
258121,
259361,
259385,
259937,
259938,
259945,
260482,
260905,
260908,
260913,
262669,
262778,
265945,
267470,
267473,
268015,
274518,
275142,
282546,
282547,
282548,
282551,
285568,
285733,
285741,
285750,
285754,
289699,
289877,
289903,
293614,
293660,
293670,
293696,
293716,
293719,
296480,
299201,
299210,
299988,
302871,
302877,
302903,
311646,
311657,
311662,
311665,
311667,
314410,
314412,
314415,
315100,
315103,
315105,
315106,
315110,
316170,
317477,
317482,
317489,
317493,
317500,
317503,
317511,
317520,
323887,
325710,
326432,
327870,
334278,
334291,
335835						)

			) AUX
		    ON ( AUX.TAR_ID = TAR.TAR_ID )
		    WHEN MATCHED THEN UPDATE SET
		    TAR_FECHA_FIN = SYSDATE,
		    TAR_TAREA_FINALIZADA = 1,
		    BORRADO = 1,	
		    FECHABORRAR = SYSDATE,
		    USUARIOBORRAR = ''' || V_USR || ''',
		    FECHAMODIFICAR = SYSDATE,
		    USUARIOMODIFICAR = ''' || V_USR || '''' ;	
	
	EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('[INFO] Se actualizan '||SQL%ROWCOUNT||' registros de TAR_TAREAS_NOTIFICACIONES '); 	

        ---------------------------------------------------------------------------------

	DBMS_OUTPUT.PUT_LINE('[INICIO] Cerrando Trámite ');	

	V_MSQL := ' MERGE INTO '|| V_ESQUEMA ||'.ACT_TRA_TRAMITE TRA
		    USING( 

			 	SELECT DISTINCT TRA.TRA_ID
				FROM '||V_ESQUEMA||'.ACT_TRA_TRAMITE TRA, '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC, '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR
				WHERE 1 = 1
				AND DD_TPO_ID = ( SELECT DD_TPO_ID FROM '||V_ESQUEMA||'.DD_TPO_TIPO_PROCEDIMIENTO WHERE DD_TPO_CODIGO = ''T001'' )
				AND DD_EPR_ID = ( SELECT DD_EPR_ID FROM '||V_ESQUEMA_M||'.DD_EPR_ESTADO_PROCEDIMIENTO EPR WHERE DD_EPR_CODIGO = ''10'' )
				AND TAC.TAR_ID = TAR.TAR_ID
				AND TRA.TRA_ID = TAC.TRA_ID
				AND TAC.BORRADO = 0
				AND TRA.BORRADO = 0
				AND TRA.TRA_ID IN (
130141,
131125,
134294,
132773,
132873,
133173,
134957,
135557,
135657,
311656,
1216,
1259,
3103,
6565,
6565,
6566,
6566,
8403,
8795,
8800,
10762,
10905,
11283,
11284,
11286,
11404,
11559,
12294,
12294,
14523,
18037,
18047,
19524,
19549,
30622,
30660,
30691,
30707,
30724,
31101,
32610,
32636,
32639,
32934,
32938,
32944,
124216,
124216,
127172,
127180,
127221,
127240,
127251,
127254,
127279,
127346,
127347,
127353,
130773,
128844,
129381,
129627,
129929,
130229,
130281,
130353,
130363,
131214,
131594,
131653,
131764,
131917,
131997,
134021,
134045,
134046,
134058,
134070,
134089,
134098,
134106,
134110,
134112,
134123,
134133,
134143,
134175,
134200,
134203,
134205,
134210,
134212,
134242,
134324,
134383,
134414,
134417,
134433,
134434,
132072,
132083,
132090,
132101,
132129,
132130,
132161,
132167,
132169,
132182,
132192,
132217,
132222,
132248,
132259,
132276,
132299,
132303,
132313,
132320,
132323,
132325,
132346,
132347,
132348,
132360,
132366,
132404,
132420,
132455,
132495,
132544,
132548,
132553,
132555,
132572,
132576,
132578,
132596,
132610,
132633,
132638,
132650,
132657,
132696,
132701,
132743,
132745,
132750,
132752,
132764,
132790,
132801,
132828,
132867,
132871,
132879,
132895,
132905,
132906,
132907,
132914,
132916,
132943,
132947,
132951,
132965,
132985,
132995,
133007,
133014,
133029,
133048,
133050,
133051,
133052,
133079,
133082,
133099,
133127,
133153,
133154,
133165,
133181,
133183,
133184,
133188,
133202,
133219,
133223,
133251,
133256,
133287,
133295,
133326,
133329,
133336,
133374,
133390,
133397,
133399,
133411,
133425,
133435,
133455,
133458,
133462,
133475,
133495,
133507,
133544,
133551,
133595,
133605,
133655,
133664,
133665,
133666,
133679,
133695,
133713,
133728,
133739,
133748,
133769,
133785,
133794,
133797,
133801,
133804,
133844,
133853,
133865,
133883,
133887,
133922,
133944,
133949,
134463,
134465,
134468,
134469,
134488,
134492,
134541,
134563,
134577,
134578,
134611,
134622,
134655,
134690,
134697,
134705,
134714,
134715,
134736,
134748,
134759,
134770,
134775,
134796,
134805,
134813,
134814,
134843,
134888,
134890,
134898,
134933,
134944,
134953,
134991,
134999,
135004,
135019,
135035,
135064,
135088,
135100,
135109,
135110,
135121,
135128,
135142,
135166,
135206,
135246,
135261,
135311,
135317,
135328,
135343,
135355,
135393,
135395,
135411,
135422,
135432,
135443,
135447,
135460,
135496,
135562,
135608,
135620,
135674,
135712,
135724,
135728,
135737,
135749,
135759,
135778,
135779,
135783,
137547,
137966,
138633,
138646,
138658,
139733,
139743,
139744,
139782,
139798,
139813,
139840,
141097,
141120,
143870,
143877,
146009,
149026,
151988,
151989,
152005,
152034,
152104,
152116,
152117,
152134,
152142,
152151,
152157,
156511,
159311,
175901,
175947,
176363,
176369,
176373,
176390,
176392,
176397,
176407,
176971,
177472,
177519,
178572,
178575,
178577,
178958,
178963,
178975,
178977,
178987,
178988,
178989,
178992,
178994,
178997,
179001,
179008,
179010,
179012,
179013,
179016,
179741,
181083,
182967,
186240,
189933,
189941,
189949,
189958,
189969,
189971,
190073,
190098,
190101,
190115,
190130,
221352,
226237,
226259,
227348,
227352,
227354,
227356,
227417,
227419,
227429,
227478,
237304,
237312,
237313,
237327,
237360,
237362,
237365,
237366,
238019,
238028,
238032,
238033,
238071,
242493,
242500,
242503,
242512,
242544,
242564,
242568,
242592,
242612,
248267,
248269,
248277,
248301,
248342,
248376,
250656,
252027,
252797,
252810,
253395,
253400,
253412,
256742,
258089,
258094,
258097,
258121,
259361,
259385,
259937,
259938,
259945,
260482,
260905,
260908,
260913,
262669,
262778,
265945,
267470,
267473,
268015,
274518,
275142,
282546,
282547,
282548,
282551,
285568,
285733,
285741,
285750,
285754,
289699,
289877,
289903,
293614,
293660,
293670,
293696,
293716,
293719,
296480,
299201,
299210,
299988,
302871,
302877,
302903,
311646,
311657,
311662,
311665,
311667,
314410,
314412,
314415,
315100,
315103,
315105,
315106,
315110,
316170,
317477,
317482,
317489,
317493,
317500,
317503,
317511,
317520,
323887,
325710,
326432,
327870,
334278,
334291,
335835						)

			) AUX
		    ON ( AUX.TRA_ID = TRA.TRA_ID )
		    WHEN MATCHED THEN UPDATE SET
		    DD_EPR_ID = ( SELECT DD_EPR_ID FROM '||V_ESQUEMA_M||'.DD_EPR_ESTADO_PROCEDIMIENTO EPR WHERE DD_EPR_CODIGO = ''11'' ),
		    TRA_FECHA_FIN = SYSDATE,	
		    FECHAMODIFICAR = SYSDATE,
		    USUARIOMODIFICAR = ''' || V_USR || '''' ;	
	
	EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('[INFO] Se actualizan '||SQL%ROWCOUNT||' registros de ACT_TRA_TRAMITE '); 	

	COMMIT;
	
	DBMS_OUTPUT.PUT_LINE('[FIN]');
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
