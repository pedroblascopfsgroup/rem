--/*
--#########################################
--## AUTOR=Oscar Diestre Pérez
--## FECHA_CREACION=20191105
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-5680
--## PRODUCTO=NO
--## 
--## Finalidad: Carga masiva de aprobación del informe comercial
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 
DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    V_NUM_FILAS NUMBER(16); -- Vble. para validar la existencia de un registro.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-5680'; -- USUARIOCREAR/USUARIOMODIFICAR.

    
BEGIN		

        ---------------------------------------------------------------------------------

	DBMS_OUTPUT.PUT_LINE('[INICIO] Cerrando Tareas ');	

	V_MSQL := ' MERGE INTO '|| V_ESQUEMA ||'.TAR_TAREAS_NOTIFICACIONES TAR
		    USING( 

			 	SELECT DISTINCT TAR.TAR_ID
				FROM '||V_ESQUEMA||'.ACT_TRA_TRAMITE TRA, '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC, '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR
				WHERE 1 = 1
				AND TAC.TAR_ID = TAR.TAR_ID
				AND TRA.TRA_ID = TAC.TRA_ID
				AND TAR.BORRADO = 0
				AND TAC.BORRADO = 0
				AND TRA.BORRADO = 0

		    		AND TAR_FECHA_FIN IS NULL
		    		AND TAR_TAREA_FINALIZADA = 0
				AND TAR.BORRADO = 0
				AND TAR_TAREA = ''Documentos post-venta'' 

				AND TRA.TRA_ID IN (

352156,
344349,
319981,
315981,
96251,
240009,
175066,
141518,
339076,
283797,
282241,
268270,
142101,
381378,
385076,
360932,
311055,
271194,
361387,
357159,
376104,
179358,
365198,
369609,
284276,
227707,
192239,
177484,
349512,
346422,
310888,
135839,
222804,
354064,
306670,
258973,
326447,
242249,
368131,
235907,
216999,
219680,
291707,
143493,
101860,
281487,
208249,
267637,
359887,
311024,
326823,
311036,
318459,
364874,
236815,
141570,
141574,
394463,
375297,
361549,
374224,
321202,
326825,
311042,
301249,
275956,
262568,
97881,
344052,
311314,
282894,
261865,
310838,
310906,
179118,
154389,
386282,
381270,
391090,
331167,
332681,
305954,
284179,
143550,
377551,
366156,
365687,
345037,
331180,
277391,
245153,
154402,
337658,
311124,
311217,
178661,
310883,
311722,
102116,
119471,
291421,
178060,
181178,
311046,
311259,
264848,
290895,
242230,
275503,
311296,
341682,
183190,
358975,
154405,
379988,
387032,
362166,
315269,
116891,
266776,
260803,
120001,
154397,
98136,
311167,
111205,
141530,
382733,
393302,
381790,
367790,
262436,
311303,
311044,
298986,
278393,
328212,
331910,
307209,
263113,
257499,
111159,
386829,
354066,
362677,
271001,
305319,
143393,
311127,
215271,
311039,
251556,
297198,
326837,
311049,
340371,
241930,
145366,
311130,
177265,
337435,
352419,
311139,
262974,
225719,
360643,
372375,
344242,
360391,
311290,
278945,
154403,
119462,
390013,
346923,
337754,
310822,
351688,
358178,
360379,
375431,
122063,
143382,
352997,
320382,
337162,
311284,
238727,
257584,
263661,
256224,
311062,
311056,
275565,
311180,
256883,
232199,
143953,
354067,
327027,
363948,
119464,
311122,
311420,
141549,
303230,
288751,
356505,
329645,
295861,
326034,
247471,
232901,
310953,
305578,
311418,
311255,
311248,
311060,
331493,
359544,
370272,
349125,
154475,
114336,
349140,
288348,
311054,
246456,
240007,
231079,
222750,
294215,
281169,
310903,
310909,
294779,
284715,
238928,
311048,
373041,
119483,
362676,
284782,
310911,
207962,
320853,
322118,
311626,
215595,
311043,
311035,
311053,
371051,
354063,
364478,
219349,
375085,
323297,
176643,
370236,
335200,
312637,
282231,
310893,
270754,
311972,
284629,
365765,
362994,
119470,
256285,
128096,
331713,
359386,
344023,
327735,
310705,
215627,
275367,
331984,
311268,
281713,
248845,
253499,
112103,
128381,
375100,
331904,
192493,
271357,
348037,
347358,
276935,
311057,
295723,
347327,
306418,
310872,
327454,
328726,
289976,
378245,
307638,
326822,
311119,
311285,
310843,
251143,
119455,
300059,
304109,
311058,
311051,
382737,
268068,
190986

		)

			) AUX
		    ON ( AUX.TAR_ID = TAR.TAR_ID )
		    WHEN MATCHED THEN UPDATE SET
		    TAR_FECHA_FIN = SYSDATE,
		    TAR_TAREA_FINALIZADA = 1,
		    BORRADO = 1,	
		    FECHABORRAR = SYSDATE,
		    USUARIOBORRAR = ''' || V_USR || ''',
		    FECHAMODIFICAR = SYSDATE,
		    USUARIOMODIFICAR = ''' || V_USR || '''' ;	
	
	EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('[INFO] Se cierran '||SQL%ROWCOUNT||' tareas <Documentos post-venta>  '); 	

        ---------------------------------------------------------------------------------

	DBMS_OUTPUT.PUT_LINE('[INICIO] Cerrando Tareas ');	

	V_MSQL := ' MERGE INTO '|| V_ESQUEMA ||'.TAR_TAREAS_NOTIFICACIONES TAR
		    USING( 

			 	SELECT DISTINCT TAR.TAR_ID
				FROM '||V_ESQUEMA||'.ACT_TRA_TRAMITE TRA, '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC, '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR
				WHERE 1 = 1
				AND TAC.TAR_ID = TAR.TAR_ID
				AND TRA.TRA_ID = TAC.TRA_ID
				AND TAR.BORRADO = 0
				AND TAC.BORRADO = 0
				AND TRA.BORRADO = 0

		    		AND TAR_FECHA_FIN IS NULL
		    		AND TAR_TAREA_FINALIZADA = 0
				AND TAR.BORRADO = 0
				AND TAR_TAREA = ''Resultado PBC'' 

				AND TRA.TRA_ID IN (

245651,
253712,
265444,
265454,
265459,
400166,
368637,
400170,
182356,
346182,
368544,
345564,
400181,
241408,
368687,
314173,
368616,
244293,
368552,
368678,
368656,
368546,
254367

		)

			) AUX
		    ON ( AUX.TAR_ID = TAR.TAR_ID )
		    WHEN MATCHED THEN UPDATE SET
		    TAR_FECHA_FIN = SYSDATE,
		    TAR_TAREA_FINALIZADA = 1,
		    BORRADO = 1,	
		    FECHABORRAR = SYSDATE,
		    USUARIOBORRAR = ''' || V_USR || ''',
		    FECHAMODIFICAR = SYSDATE,
		    USUARIOMODIFICAR = ''' || V_USR || '''' ;	
	
	EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('[INFO] Se cierran '||SQL%ROWCOUNT||' tareas <Resultado PBC>  '); 	

        ---------------------------------------------------------------------------------


	COMMIT;
	
	DBMS_OUTPUT.PUT_LINE('[FIN]');
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
