--/*
--#########################################
--## AUTOR=SIMEON SHOPOV
--## FECHA_CREACION=20171024
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.1
--## INCIDENCIA_LINK=HREOS-3008
--## PRODUCTO=NO
--## 
--## Finalidad: Cambio de estado de publicaci贸n migrado "Publicado oculto" a despublicado. 
--##			   
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versi贸n inicial
--#########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMAMASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.      
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  V_USUARIO VARCHAR2(50 CHAR):= 'HREOS-3008';
  V_CODIGO_POCULTO VARCHAR2(20 CHAR) := '03';
  V_CODIGO_DESPUBLICADO VARCHAR2(20 CHAR) := '05';
  V_CODIGO_PUBLICADO VARCHAR2(20 CHAR) := '01';
  V_MOTIVO VARCHAR2 (100 CHAR) := 'Actualizaci贸n masiva PFS';
  V_FECHA VARCHAR2(15 CHAR);


BEGIN
 
 V_MSQL := 'SELECT TO_CHAR(SYSDATE,''YYMMDD_HH24mmSS'') FROM DUAL';
 EXECUTE IMMEDIATE V_MSQL INTO V_FECHA;
 
 V_USUARIO := V_USUARIO ||'_'|| V_FECHA;

 
 V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_ACTIVO ACT
  USING '||V_ESQUEMA||'.V_BUSQUEDA_PUBLICACION_ACTIVO VISTA
  ON (ACT.ACT_ID = VISTA.ACT_ID AND VISTA.ESTADO_PUBLICACION_CODIGO = '''||V_CODIGO_POCULTO||''' AND (VISTA.ADMISION != 1 OR VISTA.GESTION != 1 OR VISTA.PRECIO != 1 OR VISTA.PUBLICACION != 1 OR VISTA.INFORME_COMERCIAL != 1))
WHEN MATCHED THEN
  UPDATE SET ACT.DD_EPU_ID = (SELECT DD_EPU_ID FROM '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION EPU WHERE EPU.DD_EPU_CODIGO = '''||V_CODIGO_DESPUBLICADO||''')
           , usuariomodificar = '''||V_USUARIO||'''
           , fechamodificar=sysdate';
           
           EXECUTE IMMEDIATE V_MSQL;
           
           V_MSQL := '
INSERT INTO '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION (
ACT_ID
, HEP_ID
, DD_EPU_ID
, HEP_MOTIVO
, HEP_FECHA_DESDE
, HEP_FECHA_HASTA
, USUARIOCREAR
, FECHACREAR
) WITH ULTIMO_ESTADO AS (SELECT ACT_ID, DD_EPU_ID, ROW_NUMBER() OVER(PARTITION BY ACT_ID ORDER BY HEP_FECHA_DESDE DESC, HEP_FECHA_HASTA DESC NULLS FIRST) RN FROM ACT_HEP_HIST_EST_PUBLICACION)
SELECT ACT.ACT_ID as ACT_ID
     , S_ACT_HEP_HIST_EST_PUBLICACION.NEXTVAL as HEP_ID
     , EPU.DD_EPU_ID
     , '''||V_MOTIVO||''' as HEP_MOTIVO
     , SYSDATE as HEP_FECHA_DESDE
     , SYSDATE as HEP_FECHA_HASTA
     , '''||V_USUARIO||''' as usuariocrear
     , sysdate as fechacrear
FROM  '||V_ESQUEMA||'.ACT_ACTIVO ACT
JOIN '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION EPU ON DD_EPU_CODIGO = '''||V_CODIGO_PUBLICADO||'''
LEFT JOIN ULTIMO_ESTADO ULT ON (ULT.DD_EPU_ID = EPU.DD_EPU_ID AND ACT.ACT_ID = ULT.ACT_ID AND ULT.RN = 1)
where ACT.usuariomodificar = '''||V_USUARIO||''' AND ULT.ACT_ID IS NULL';
EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[INFO] '||SQL%ROWCOUNT||' FILAS PUBLICADAS');
           
           V_MSQL := '
INSERT INTO '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION (
ACT_ID
, HEP_ID
, DD_EPU_ID
, HEP_MOTIVO
, HEP_FECHA_DESDE
, USUARIOCREAR
, FECHACREAR
) WITH ULTIMO_ESTADO AS (SELECT ACT_ID, DD_EPU_ID, ROW_NUMBER() OVER(PARTITION BY ACT_ID ORDER BY HEP_FECHA_DESDE DESC, HEP_FECHA_HASTA DESC NULLS FIRST) RN FROM ACT_HEP_HIST_EST_PUBLICACION)
SELECT ACT.ACT_ID as ACT_ID
     , S_ACT_HEP_HIST_EST_PUBLICACION.NEXTVAL as HEP_ID
     , EPU.DD_EPU_ID
     , '''||V_MOTIVO||''' as HEP_MOTIVO
     , SYSDATE as HEP_FECHA_DESDE
     , '''||V_USUARIO||''' as usuariocrear
     , sysdate as fechacrear
FROM  '||V_ESQUEMA||'.ACT_ACTIVO ACT
JOIN '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION EPU ON DD_EPU_CODIGO = '''||V_CODIGO_DESPUBLICADO||'''
LEFT JOIN ULTIMO_ESTADO ULT ON (ULT.DD_EPU_ID = EPU.DD_EPU_ID AND ACT.ACT_ID = ULT.ACT_ID AND ULT.RN = 1)
where ACT.usuariomodificar = '''||V_USUARIO||''' AND ULT.ACT_ID IS NULL';
        EXECUTE IMMEDIATE V_MSQL;
        DBMS_OUTPUT.PUT_LINE('[INFO] '||SQL%ROWCOUNT||' FILAS DESPUBLICADAS');

COMMIT;


EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecuci贸n:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);
          ROLLBACK;
          RAISE;   

END;
/
EXIT