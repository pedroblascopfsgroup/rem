--/*
--##########################################
--## AUTOR=Pablo Meseguer
--## FECHA_CREACION=20171205
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-3410
--## PRODUCTO=NO
--## Finalidad: Insertar las cargas de REM correspondientes a activos de cartera SAREB.
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; -- Configuracion Esquema Master
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.  
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

    V_TABLA_1 VARCHAR2(50 CHAR):= 'ACT_CRG_CARGAS';
    V_TABLA_2 VARCHAR2(50 CHAR):= 'BIE_CAR_CARGAS';
    V_TEXT1 VARCHAR2(2400 CHAR); -- Vble. auxiliar
  
    
BEGIN
	 
    DBMS_OUTPUT.PUT_LINE('[INICIO] Comienza el proceso de insercion de las cargas de REM correspondientes a la cartera de SAREB');
    
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_2||'... PROCEDEMOS A INSERTAR');
		
	V_SQL := 'INSERT
				INTO
				  '||V_ESQUEMA||'.'||V_TABLA_2||'
				  (					
					BIE_CAR_ID_RECOVERY,
					BIE_CAR_ID,
					BIE_ID,
					BIE_CAR_LETRA,
					BIE_CAR_TITULAR,
					BIE_CAR_IMPORTE_REGISTRAL,
					BIE_CAR_IMPORTE_ECONOMICO,
					BIE_CAR_REGISTRAL,
					BIE_CAR_FECHA_PRESENTACION,
					BIE_CAR_FECHA_INSCRIPCION,
					BIE_CAR_FECHA_CANCELACION,
					BIE_CAR_ECONOMICA,
					DD_TPC_ID,
					DD_SIC_ID,
					DD_SIC_ID2,
					USUARIOCREAR,
					FECHACREAR
				  )
				SELECT
				'||V_ESQUEMA||'.S_BIE_CAR_CARGAS.NEXTVAL AS BIE_CAR_ID,
				APR_CRG.BIE_CAR_ID AS BIE_CAR_ID_RECOVERY,
				ACT.BIE_ID AS BIE_ID,
				APR_CRG.BIE_CAR_LETRA,
				APR_CRG.BIE_CAR_TITULAR,
				APR_CRG.BIE_CAR_IMPORTE_REGISTRAL,
				APR_CRG.BIE_CAR_IMPORTE_ECONOMICO,
				APR_CRG.BIE_CAR_REGISTRAL,
				APR_CRG.BIE_CAR_FECHA_PRESENTACION,
				APR_CRG.BIE_CAR_FECHA_INSCRIPCION,
				APR_CRG.BIE_CAR_FECHA_CANCELACION,
				APR_CRG.BIE_CAR_ECONOMICA,
				(SELECT DD_TPC.DD_TPC_ID FROM '||V_ESQUEMA||'.DD_TPC_TIPO_CARGA DD_TPC WHERE DD_TPC.DD_TPC_CODIGO = APR_DD_TPC.DD_TPC_CODIGO AND DD_TPC.BORRADO = 0) AS DD_TPC_ID,
				(SELECT DD_SIC.DD_SIC_ID FROM '||V_ESQUEMA||'.DD_SIC_SITUACION_CARGA DD_SIC WHERE DD_SIC.DD_SIC_CODIGO = APR_DD_SIC.DD_SIC_CODIGO AND DD_SIC.BORRADO = 0) AS DD_SIC_ID,
				(SELECT DD_SIC.DD_SIC_ID FROM '||V_ESQUEMA||'.DD_SIC_SITUACION_CARGA DD_SIC WHERE DD_SIC.DD_SIC_CODIGO = APR_DD_SIC2.DD_SIC_CODIGO AND DD_SIC.BORRADO = 0) AS DD_SIC_ID2,
				''HREOS-3410'' AS USUARIOCREAR,
				SYSDATE AS FECHACREAR
				FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
				INNER JOIN PFSREM.aux_cargas_canyon APR_CRG				      ON APR_CRG.BIE_ENTIDAD_ID = ACT.ACT_NUM_ACTIVO
				LEFT JOIN '||V_ESQUEMA||'.APR_AUX_DD_TPC_TIPO_CARGA APR_DD_TPC		ON APR_DD_TPC.DD_TPC_ID = APR_CRG.DD_TPC_ID
				LEFT JOIN '||V_ESQUEMA||'.APR_AUX_DD_SIC_SIT_CARGA APR_DD_SIC			ON APR_DD_SIC.DD_SIC_ID = APR_CRG.DD_SIC_ID
				LEFT JOIN '||V_ESQUEMA||'.APR_AUX_DD_SIC_SIT_CARGA APR_DD_SIC2		ON APR_DD_SIC2.DD_SIC_ID = APR_CRG.DD_SIC_ID2
				WHERE APR_CRG.BIE_CAR_ID not in (SELECT NVL(BIE_CAR_ID_RECOVERY,0) FROM '||V_ESQUEMA||'.BIE_CAR_CARGAS CARG)';
    EXECUTE IMMEDIATE V_SQL; 
        
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_2||'... SE HAN INSERTADO CORRECTAMENTE '||SQL%ROWCOUNT||' REGISTROS');


	DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_1||'... PROCEDEMOS A INSERTAR');
		
	V_SQL := 'INSERT
				INTO
				  '||V_ESQUEMA||'.'||V_TABLA_1||'
				  (
					CRG_ID,
					ACT_ID,
					BIE_CAR_ID,
					DD_TCA_ID,
					DD_STC_ID,
					CRG_DESCRIPCION,
					CRG_ORDEN,
					CRG_FECHA_CANCEL_REGISTRAL,
					USUARIOCREAR,
					FECHACREAR,
					DD_ODT_ID
				  )
				 SELECT
				'||V_ESQUEMA||'.S_ACT_CRG_CARGAS.NEXTVAL AS CRG_ID,ACT_ID,BIE_CAR_ID,DD_TCA_ID,DD_STC_ID,CRG_DESCRIPCION,CRG_ORDEN,CRG_FECHA_CANCEL_REGISTRAL,USUARIOCREAR,FECHACREAR,DD_ODT_ID FROM( SELECT
				DISTINCT 
				ACT.ACT_ID AS ACT_ID,
				CAR.BIE_CAR_ID,
				CASE WHEN (CAR.BIE_CAR_REGISTRAL = 1 AND CAR.BIE_CAR_ECONOMICA = 1)
						THEN (SELECT DD_TCA_ID FROM '||V_ESQUEMA||'.DD_TCA_TIPO_CARGA WHERE DD_TCA_CODIGO = ''REGECO'')
					WHEN (CAR.BIE_CAR_REGISTRAL = 1 AND CAR.BIE_CAR_ECONOMICA = 0)
						THEN (SELECT DD_TCA_ID FROM '||V_ESQUEMA||'.DD_TCA_TIPO_CARGA WHERE DD_TCA_CODIGO = ''REG'')
					WHEN (CAR.BIE_CAR_REGISTRAL = 0 AND CAR.BIE_CAR_ECONOMICA = 1)
						THEN (SELECT DD_TCA_ID FROM '||V_ESQUEMA||'.DD_TCA_TIPO_CARGA WHERE DD_TCA_CODIGO = ''ECO'')
					ELSE NULL 
				END DD_TCA_ID,
				NULL AS DD_STC_ID,
				NULL AS CRG_DESCRIPCION,
				NULL AS CRG_ORDEN,
				NULL AS CRG_FECHA_CANCEL_REGISTRAL,
				''HREOS-3410'' AS USUARIOCREAR,
				SYSDATE AS FECHACREAR,
				(SELECT DD_ODT_ID FROM '||V_ESQUEMA||'.DD_ODT_ORIGEN_DATO ODT WHERE DD_ODT_CODIGO = ''02'') AS DD_ODT_ID
				FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
				INNER JOIN PFSREM.AUX_CARGAS_CANYON aux		ON AUX.BIE_ENTIDAD_ID = ACT.ACT_NUM_ACTIVO
				INNER JOIN '||V_ESQUEMA||'.BIE_CAR_CARGAS CAR					ON CAR.BIE_ID = ACT.BIE_ID
				WHERE NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.ACT_CRG_CARGAS CR WHERE CR.BIE_CAR_ID=CAR.BIE_CAR_ID))';
    EXECUTE IMMEDIATE V_SQL; 
        
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_1||'... SE HAN BORRADO CORRECTAMENTE '||SQL%ROWCOUNT||' REGISTROS');
    
	DBMS_OUTPUT.PUT_LINE('[FIN] El proceso de insercion de las cargas de REM correspondientes a la cartera de SAREB a finalizado correctamente');
	
	COMMIT;    
    
EXCEPTION
  WHEN OTHERS THEN
    ERR_NUM := SQLCODE;
    ERR_MSG := SQLERRM;
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(ERR_MSG);
    ROLLBACK;
    RAISE;   
END;
/
EXIT;
