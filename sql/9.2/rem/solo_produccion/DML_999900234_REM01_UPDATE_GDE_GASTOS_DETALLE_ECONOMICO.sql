--/*
--##########################################
--## AUTOR=Pablo Meseguer
--## FECHA_CREACION=20180201
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.13
--## INCIDENCIA_LINK=HREOS-3782
--## PRODUCTO=NO
--## Finalidad: Script de actualización de importes migrados incorrectamente.
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_M#'; -- Configuracion Esquema Master
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.  
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

    V_TEXT1 VARCHAR2(2400 CHAR); -- Vble. auxiliar  
    
BEGIN
	 
    DBMS_OUTPUT.PUT_LINE('[INICIO] Comienza el proceso de actualizacion de registros de GDE_GASTOS_DETALLE_ECONOMICO...');
    
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.GDE_GASTOS_DETALLE_ECONOMICO... Procedemos a actualizar');
    
    V_SQL := 'UPDATE '||V_ESQUEMA||'.gde_gastos_detalle_economico gde
			  SET gde.gde_imp_ind_cuota = gde.gde_imp_ind_cuota / 100,
				  gde.gde_irpf_cuota = 0,
				  gde.gde_importe_total = gde.gde_principal_sujeto + gde.gde_imp_ind_cuota / 100,
				  gde.usuariomodificar = ''HREOS-3782'',
				  gde.fechamodificar = sysdate
			  WHERE gde.gpv_id IN (
					  SELECT gpv.gpv_id
					  FROM '||V_ESQUEMA||'.gpv_gastos_proveedor gpv
					  WHERE gpv.gpv_num_gasto_haya IN
								(9173756, 9174431, 9174723, 9154974, 9155085, 9155780, 9156710, 9156928, 9157659, 9157703, 9157742, 9157812, 9158229, 9158256, 9158304, 9158821, 9159365, 9160328, 9160336, 9161205,
								 9161380, 9161718, 9162610, 9163019, 9163479, 9163998, 9164241, 9164332, 9164430, 9164567, 9164580, 9164723, 9164776, 9165114, 9165137, 9165380, 9165582, 9165637, 9165646, 9165791,
								 9166123, 9166164, 9166226, 9166493, 9166560, 9166569, 9166705, 9166789, 9166951, 9167045, 9167145, 9167307, 9167389, 9167408, 9167434, 9167449, 9167620, 9167796, 9168010, 9168030,
								 9168386, 9168652, 9168998, 9169115, 9169290, 9169303, 9169381, 9169484, 9169742, 9169764, 9169945, 9170005, 9170275, 9170305, 9170500, 9170644, 9171098, 9171118, 9171139, 9171204,
								 9171205, 9171295, 9171320, 9171717, 9171856, 9172795, 9172806, 9175081, 9175082, 9175088, 9175481, 9175658, 9175742, 9176081, 9176205, 9179503, 9179711, 9179788, 9179995, 9180157,
								 9180315, 9180357, 9180412, 9180516, 9180562, 9180572, 9180942, 9180988, 9176344, 9176942, 9176972, 9177355, 9177362, 9177363, 9177416, 9177500, 9177980, 9177981, 9177982, 9178041,
								 9178188, 9178216, 9178300, 9181659, 9181669, 9181775, 9184237, 9184607, 9184885, 9185023, 9185129, 9185173, 9185281, 9185284, 9185304, 9185344, 9185379, 9185397, 9185414, 9185428,
								 9185448, 9185527, 9185536, 9185616, 9185723, 9186157, 9186416, 9186517, 9186678, 9186824, 9186900, 9187321, 9188962, 9189047, 9189085, 9189086, 9189198, 9189294, 9189467, 9189735,
								 9189900, 9189905, 9190012, 9190661, 9190666, 9190686, 9190871, 9191240, 9192144, 9192175, 9192315, 9192382, 9192759, 9193110, 9194253, 9194445, 9194530, 9181899, 9181912, 9182303,
								 9182670, 9182805, 9194580, 9194629, 9195077, 9195222, 9195433, 9195604, 9196256, 9196945, 9197002, 9197211, 9197212, 9198139, 9198427, 9198444, 9198873, 9199025, 9199753, 9200218,
								 9200250, 9200344, 9200864, 9201302, 9201412, 9201693, 9201713, 9202091, 9202133, 9202134, 9202177, 9202298, 9202360, 9202776, 9202779, 9202793, 9203112, 9203139, 9203476, 9203499,
								 9203694, 9203703, 9203833, 9204022, 9204276, 9204559, 9204693, 9204754, 9204755, 9204791, 9205175, 9205560, 9205810, 9205814, 9205881, 9205911, 9206161, 9206167, 9206194, 9206203,
								 9206277, 9206303, 9206468, 9206640, 9206647, 9207025, 9207028, 9207032, 9207165, 9212761, 9212788, 9212797, 9212865, 9212925, 9212926, 9213092, 9213137, 9213151, 9213174, 9213320,
								 9213327, 9213330, 9213341, 9213365, 9213401, 9213536, 9213628, 9213671, 9213708, 9213775, 9213811, 9213835, 9214104, 9214150, 9214194, 9214387, 9214530, 9214559, 9214671, 9214791,
								 9214869, 9215141, 9215780, 9215854, 9215954, 9216242, 9216245, 9216401, 9216557, 9217284, 9218930, 9219386, 9219696, 9219893, 9219930, 9220028, 9220256, 9220285, 9220464, 9220515,
								 9220577, 9220578, 9220645, 9220725, 9220926, 9220951, 9220963, 9221046, 9221089, 9221103, 9221152, 9221259, 9221268, 9221324, 9221331, 9221341, 9221524, 9221578, 9221582, 9221746,
								 9221757, 9221898, 9221919, 9221929, 9222066, 9222187, 9222195, 9222232, 9222969, 9222981, 9223093, 9223350, 9223380, 9223406, 9223407, 9223472, 9223653, 9223728, 9223859, 9223911,
								 9224131, 9224251, 9224315, 9224330, 9224567, 9224574, 9224698, 9224765, 9224778, 9224854, 9225139, 9225168, 9225225, 9225247, 9225249, 9225328, 9225407, 9225472, 9225602, 9225766,
								 9225837, 9225868, 9225905, 9225909, 9225990, 9226201, 9226319, 9226474, 9226628, 9226728, 9226842, 9226960, 9227868, 9228052, 9228109, 9228132, 9228263, 9228367, 9228517, 9228558,
								 9228561, 9228985, 9229027, 9229092, 9229102, 9229104, 9229258, 9229533, 9229906, 9230039, 9230076, 9230751, 9230788, 9231337, 9231489, 9231981, 9232598, 9233055, 9208087, 9208097,
								 9208107, 9208266, 9208286, 9208417, 9208652, 9208763, 9208915, 9209036, 9209054, 9209144, 9209442, 9209708, 9209722, 9210034, 9210074, 9210174, 9210204, 9210596, 9210615, 9210697,
								 9210839, 9210848, 9210929, 9211081, 9211278, 9211345, 9211409, 9211571, 9211685, 9211727, 9211741, 9211766, 9211897, 9211967, 9211968, 9212043, 9212139, 9212323, 9212364, 9212556,
								 9212617, 9212673))';
    EXECUTE IMMEDIATE V_SQL;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.GDE_GASTOS_DETALLE_ECONOMICO... Se han actualizado correctamente '||SQL%ROWCOUNT||' registros');     
    
	DBMS_OUTPUT.PUT_LINE('[FIN] El proceso de actualización de registros de GDE_GASTOS_DETALLE_ECONOMICO');
	
	COMMIT;    
    
EXCEPTION
  WHEN OTHERS THEN
    ERR_NUM := SQLCODE;
    ERR_MSG := SQLERRM;
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(ERR_MSG);
    ROLLBACK;
    RAISE;   
END;
/
EXIT;
