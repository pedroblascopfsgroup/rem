--/*
--##########################################
--## AUTOR=SIMEON SHOPOV 
--## FECHA_CREACION=20180227
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-132
--## PRODUCTO=NO
--##
--## Finalidad: Actualizar el ACT_NUM_ACTIVO_SAREB erróneos
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(25 CHAR):= 'ACT_ACTIVO';
    V_COUNT NUMBER(16); -- Vble. para contar.
    V_COUNT_INSERT NUMBER(16):= 0; -- Vble. para contar inserts
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	V_USUARIO VARCHAR2(32 CHAR):= 'REMVIP-132';
    
    ACT_NUM_ACTIVO NUMBER(16);
    ACT_NUM_ACTIVO_SAREB_MALO NUMBER(16);
    ACT_NUM_ACTIVO_SAREB_WENO NUMBER(16);
    
    TYPE T_JBV IS TABLE OF VARCHAR2(4000);
 	TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 

 	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
		  T_JBV(177339,516993,733202)
		, T_JBV(177340,531139,673089)
		, T_JBV(177341,565408,646513)
		, T_JBV(177342,524100,673090)
		, T_JBV(177343,520114,718274)
		, T_JBV(177344,551162,646517)
		, T_JBV(177345,558811,673094)
		, T_JBV(177346,565409,643380)
		, T_JBV(177396,569803,664610)
		, T_JBV(177397,561807,712313)
		, T_JBV(177508,558810,654628)
		, T_JBV(177509,524096,709297)
		, T_JBV(177510,561800,733204)
		, T_JBV(177511,544953,727324)
		, T_JBV(177515,520115,680628)
		, T_JBV(177517,516997,727328)
		, T_JBV(177518,569804,664613)
		, T_JBV(177654,572354,680624)
		, T_JBV(177655,565406,698010)
		, T_JBV(177656,527620,689233)
		, T_JBV(177657,549801,703679)
		, T_JBV(177658,531140,695467)
		, T_JBV(177659,531141,654630)
		, T_JBV(177660,572357,689235)
		, T_JBV(177661,544954,703751)
		, T_JBV(177662,536052,660179)
		, T_JBV(177664,561803,712308)
		, T_JBV(177665,524108,660187)
		, T_JBV(177841,539871,660182)
		, T_JBV(177842,536054,660183)
		, T_JBV(177892,558812,689241)
		, T_JBV(177893,524110,709304)
		, T_JBV(178044,539872,727330)
		, T_JBV(178045,551164,712312)
		, T_JBV(178046,520118,643384)
		, T_JBV(187386,558808,733200)
		, T_JBV(187387,544950,680625)
		, T_JBV(187389,524097,680627)
		, T_JBV(187390,549802,673088)
		, T_JBV(187412,520097,733203)
		, T_JBV(187413,572356,712304)
		, T_JBV(187414,565407,660177)
		, T_JBV(187636,531143,660180)
		, T_JBV(187727,524099,646514)
		, T_JBV(187728,572446,712306)
		, T_JBV(187730,561802,727327)
		, T_JBV(187732,549804,712310)
		, T_JBV(187878,527619,733201)
		, T_JBV(187879,558809,673087)
		, T_JBV(187880,569802,695465)
		, T_JBV(187883,539869,646515)
		, T_JBV(187886,572447,733207)
		, T_JBV(187935,544951,727323)
		, T_JBV(187937,561804,643382)
		, T_JBV(187938,524103,703755)
		, T_JBV(187963,524095,664605)
		, T_JBV(187964,516994,654629)
		, T_JBV(188017,544955,712307)
		, T_JBV(188018,539870,646519)
		, T_JBV(188019,527622,664609)
		, T_JBV(188020,536053,646520)
		, T_JBV(188070,524104,680630)
		, T_JBV(188073,561806,680632)
		, T_JBV(188095,554555,718273)
		, T_JBV(188120,572355,689232)
		, T_JBV(188121,569801,646512)
		, T_JBV(188122,554553,680626)
		, T_JBV(188123,572445,654631)
		, T_JBV(188185,551161,689237)
		, T_JBV(188186,551163,673093)
		, T_JBV(188187,554556,664611)
		, T_JBV(188188,527623,654635)
		, T_JBV(188189,524102,689242)
		, T_JBV(188192,520117,689244)
		, T_JBV(188193,549805,712311)
		, T_JBV(188741,536057,709303)
		, T_JBV(188987,524101,698012)
		, T_JBV(188988,536055,646521)
		, T_JBV(189110,572448,689240)
		, T_JBV(189111,558813,695471)
		, T_JBV(189112,527624,703754)
		, T_JBV(189114,516999,643383)
		, T_JBV(189115,554557,654638)
		, T_JBV(189116,524106,723263)
		, T_JBV(189117,531177,680633)
		, T_JBV(189151,531145,727429)
		, T_JBV(189153,524107,660186)
		, T_JBV(189449,NULL,727329)
		, T_JBV(189450,NULL,733208)
		, T_JBV(189451,527625,712309)
		, T_JBV(189563,531175,646523)
		, T_JBV(189564,531176,727430)
		, T_JBV(189565,569805,698013)
		, T_JBV(189566,531178,664615)
		, T_JBV(192789,544952,689234)
		, T_JBV(192790,516995,727326)
		, T_JBV(192792,516996,695470)
		, T_JBV(192793,516998,709301)
		, T_JBV(192794,565410,733209)
		, T_JBV(192795,NULL,664614)
		, T_JBV(192796,524109,646525)
		, T_JBV(192884,531138,718272)
		, T_JBV(192885,709363,654633)
		, T_JBV(192886,520116,660181)
		, T_JBV(192888,524105,680631)
		, T_JBV(192889,549806,727431)
		, T_JBV(193025,554554,695466)
		, T_JBV(193026,524098,709298)
		, T_JBV(193027,539868,703680)
		, T_JBV(193030,558814,660184)
		, T_JBV(193092,561805,695473)
		, T_JBV(193093,551165,703757)
		, T_JBV(193094,544957,733211)
		, T_JBV(193095,536056,698014)
		, T_JBV(193388,539867,712305)
		, T_JBV(193389,561801,660178)
		, T_JBV(193390,551159,654632)
		, T_JBV(193391,531142,664607)
		, T_JBV(193392,551160,703752)
		, T_JBV(193394,NULL,643381)
		, T_JBV(193395,544956,654636)
		, T_JBV(193396,569806,703758)
		, T_JBV(6841241,NULL,11055801)
		, T_JBV(6841242,NULL,11055802)
	 	);   
    V_TMP_JBV T_JBV;
    
    
 BEGIN
 
 FOR I IN V_JBV.FIRST .. V_JBV.LAST
 LOOP
    V_TMP_JBV := V_JBV(I);
    
    ACT_NUM_ACTIVO 			  := V_TMP_JBV(1);
    ACT_NUM_ACTIVO_SAREB_MALO := V_TMP_JBV(2);
    ACT_NUM_ACTIVO_SAREB_WENO := V_TMP_JBV(3);
    
    IF ACT_NUM_ACTIVO_SAREB_MALO IS NOT NULL THEN
		V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET
		 			  ACT_NUM_ACTIVO_SAREB   = '||ACT_NUM_ACTIVO_SAREB_WENO||'
		 			, USUARIOMODIFICAR 	     = '''||V_USUARIO||'''
		 			, FECHAMODIFICAR         = SYSDATE
					WHERE ACT_NUM_ACTIVO 	 = '||ACT_NUM_ACTIVO||' 
					AND ACT_NUM_ACTIVO_SAREB = '||ACT_NUM_ACTIVO_SAREB_MALO||'
				  ';
	ELSE
		V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET
		 			  ACT_NUM_ACTIVO_SAREB   = '||ACT_NUM_ACTIVO_SAREB_WENO||'
		 			, USUARIOMODIFICAR 	     = '''||V_USUARIO||'''
		 			, FECHAMODIFICAR         = SYSDATE
					WHERE ACT_NUM_ACTIVO 	 = '||ACT_NUM_ACTIVO||' 
				  ';
	END IF;	  
	
  EXECUTE IMMEDIATE V_SQL;
  
  DBMS_OUTPUT.PUT_LINE('[INFO] Se ha cambiado el activo '||ACT_NUM_ACTIVO||' su ACT_NUM_ACTIVO_SAREB por '||ACT_NUM_ACTIVO_SAREB_WENO);
  
  V_COUNT_INSERT := V_COUNT_INSERT + 1;
  
  END LOOP;
  DBMS_OUTPUT.PUT_LINE('[INFO] Se han cambiado en total '||V_COUNT_INSERT||' registros en la tabla '||V_TABLA);
  
 COMMIT;
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------'); 
          DBMS_OUTPUT.PUT_LINE(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
