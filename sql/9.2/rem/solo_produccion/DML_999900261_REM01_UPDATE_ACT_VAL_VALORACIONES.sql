--/*
--##########################################
--## AUTOR=SIMEON SHOPOV 
--## FECHA_CREACION=20180305
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-202
--## PRODUCTO=NO
--##
--## Finalidad: Poner a 0 el precio minimo de venta y el precio aprobado de venta de los activos de la lista
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(25 CHAR):= 'ACT_VAL_VALORACIONES';
    --V_COUNT NUMBER(16); -- Vble. para contar.
    --V_COUNT_INSERT NUMBER(16):= 0; -- Vble. para contar inserts
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	V_USUARIO VARCHAR2(32 CHAR):= 'REMVIP-201';
    DD_TPC_ID_VENTA NUMBER(16);
    DD_TPC_ID_AUTORIZADO NUMBER(16);
    
    ACT_NUM_ACTIVO NUMBER(16);
    ACT_ID NUMBER(16);
        
    TYPE T_JBV IS TABLE OF VARCHAR2(4000);
 	TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
 	
    V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
	  T_JBV(6042659)
	, T_JBV(6079172)
	, T_JBV(6028914)
	, T_JBV(6042657)
	, T_JBV(6042664)
	, T_JBV(6034665)
	, T_JBV(6042656)
	, T_JBV(6034666)
	, T_JBV(6028917)
	, T_JBV(6034669)
	, T_JBV(6042662)
	, T_JBV(6036327)
	, T_JBV(6042660)
	, T_JBV(6036326)
	, T_JBV(6042661)
	, T_JBV(6034667)
	, T_JBV(6034668)
	, T_JBV(6028916)
	, T_JBV(6034670)
	, T_JBV(6036331)
	, T_JBV(6034671)
	, T_JBV(6042658)
	, T_JBV(6036330)
	, T_JBV(6028915)
	, T_JBV(6036328)
	, T_JBV(6036329)
	, T_JBV(6034672)
	, T_JBV(6042663)
	, T_JBV(6035883)
	, T_JBV(6134956)
	, T_JBV(6031785)
	, T_JBV(6134533)
	, T_JBV(6077984)
	, T_JBV(6035918)
	, T_JBV(6082139)
	, T_JBV(6082140)
	, T_JBV(6082141)
	, T_JBV(6077985)
	, T_JBV(6035484)
	, T_JBV(6077992)
	, T_JBV(6135390)
	, T_JBV(6133649)
	, T_JBV(6135038)
	, T_JBV(6031484)
	, T_JBV(6035194)
	, T_JBV(6038479)
	, T_JBV(6077977)
	, T_JBV(6033259)
	, T_JBV(6084313)
	, T_JBV(6035481)
	, T_JBV(6043339)
	, T_JBV(6135212)
	, T_JBV(6135881)
	, T_JBV(6080625)
	, T_JBV(6042933)
	, T_JBV(6135510)
	, T_JBV(6029825)
	, T_JBV(6035453)
	, T_JBV(6034938)
	, T_JBV(6082172)
	, T_JBV(6080294)
	, T_JBV(6082171)
	, T_JBV(6043165)
	, T_JBV(6042932)
	, T_JBV(6034050)
	, T_JBV(6040944)
	, T_JBV(6036810)
	, T_JBV(6134933)
	, T_JBV(6043166)
	, T_JBV(6040947)
	, T_JBV(6040954)
	, T_JBV(6028521)
	, T_JBV(6080293)
	, T_JBV(6043618)
	, T_JBV(6039337)
	, T_JBV(6040945)
	, T_JBV(6077876)
	, T_JBV(6039335)
	, T_JBV(6037427)
	, T_JBV(6034958)
	, T_JBV(6033205)
	, T_JBV(6040953)
	, T_JBV(6040955)
	, T_JBV(6030655)
	, T_JBV(6034051)
	, T_JBV(6039336)
	, T_JBV(6039338)
	, T_JBV(6040946)
	, T_JBV(6039339)
	, T_JBV(6039341)
	, T_JBV(6040951)
	, T_JBV(6042253)
	, T_JBV(6040949)
	, T_JBV(6040950)
	, T_JBV(6040952)
	, T_JBV(6030656)
	, T_JBV(6040948)
	, T_JBV(6029041)
	, T_JBV(6039340)
	, T_JBV(6030654)
	, T_JBV(6029794)
	, T_JBV(6036596)
	, T_JBV(6036600)
	, T_JBV(6135964)
	, T_JBV(6136816)
	, T_JBV(6079124)
	, T_JBV(6136980)
	, T_JBV(6040433)
	, T_JBV(6032707)
	, T_JBV(6043375)
	, T_JBV(6035968)
	, T_JBV(6136164)
	, T_JBV(6043718)
	, T_JBV(6037691)
	, T_JBV(6037697)
	, T_JBV(6081915)
	, T_JBV(6035996)
	, T_JBV(6029311)
	, T_JBV(6035997)
	, T_JBV(6038016)
	, T_JBV(6035495)
	, T_JBV(6077529)
	, T_JBV(6035488)
	, T_JBV(6037649)
	, T_JBV(6081905)
	, T_JBV(6030238)
	, T_JBV(6037689)
	, T_JBV(6043190)
	, T_JBV(6037690)
	, T_JBV(6035995)
	, T_JBV(6079122)
	, T_JBV(6081901)
	, T_JBV(6034970)
	, T_JBV(6037335)
	, T_JBV(6039349)
	, T_JBV(6043719)
	, T_JBV(6136713)
	, T_JBV(6035123)
	, T_JBV(6035998)
	, T_JBV(6136530)
	, T_JBV(6031886)
	, T_JBV(6038526)
	, T_JBV(6031505)
	, T_JBV(6042085)
	, T_JBV(6035216)
	, T_JBV(6042342)
	, T_JBV(6038524)
	, T_JBV(6035999)
	, T_JBV(6042086)
	, T_JBV(6134437)
	, T_JBV(6033016)
	, T_JBV(6084249)
	, T_JBV(6082033)
	, T_JBV(6082034)
	, T_JBV(6079070)
	, T_JBV(6077363)
	, T_JBV(6082036)
	, T_JBV(6082037)
	, T_JBV(6082038)
	, T_JBV(6035224)
	, T_JBV(6082035)
	, T_JBV(6035225)
	, T_JBV(6082040)
	, T_JBV(6134690)
	, T_JBV(6135039)
	, T_JBV(6082039)
	, T_JBV(6033648)
	, T_JBV(6036039)
	, T_JBV(6043801)
	, T_JBV(6036090)
	, T_JBV(6036042)
	, T_JBV(6031922)
	, T_JBV(6082030)
	, T_JBV(6082031)
	, T_JBV(6082032)
	, T_JBV(6084154)
	, T_JBV(6134897)
	, T_JBV(6035236)
	, T_JBV(6043394)
	, T_JBV(6135276)
	, T_JBV(6135625)
	, T_JBV(6136927)
	, T_JBV(6032352)
	, T_JBV(6082079)
	, T_JBV(6036116)
	, T_JBV(6136287)
	, T_JBV(6029390)
	, T_JBV(6134582)
	, T_JBV(6136119)
	, T_JBV(6136003)
	, T_JBV(6078055)
	, T_JBV(6032842)
	, T_JBV(6136159)
	, T_JBV(6079034)
	, T_JBV(6136060)
	, T_JBV(6136691)
	, T_JBV(6136243)
	, T_JBV(6136909)
	, T_JBV(6080316)
	, T_JBV(6080317)
	, T_JBV(6041901)
	, T_JBV(6043262)
	, T_JBV(6084001)
	, T_JBV(6081628)
	, T_JBV(6136643)
	, T_JBV(6036899)
	, T_JBV(6040517)
	, T_JBV(6038180)
	, T_JBV(6033748)
	, T_JBV(6036162)
	, T_JBV(6136901)
	, T_JBV(6032876)
	, T_JBV(6136039)
	, T_JBV(6031606)
	, T_JBV(6036919)
	, T_JBV(6035307)
	, T_JBV(6033757)
	, T_JBV(6033758)
	, T_JBV(6033655)
	, T_JBV(6036191)
	, T_JBV(6032088)
	, T_JBV(6078859)
	, T_JBV(6036215)
	, T_JBV(6078877)
	, T_JBV(6036192)
	, T_JBV(6039046)
	, T_JBV(6076926)
	, T_JBV(6137000)
	, T_JBV(6077765)
	, T_JBV(6136995)
	, T_JBV(6078828)
	, T_JBV(6078830)
	, T_JBV(6036279)
	, T_JBV(6078523)
	, T_JBV(6076635)
	, T_JBV(6032185)
	, T_JBV(6083558)
	, T_JBV(6135386)
	, T_JBV(6083538)
	, T_JBV(6078682)
	, T_JBV(6082779)
	, T_JBV(6075974)
	, T_JBV(6075896)
	, T_JBV(6075901)
	, T_JBV(6080190)
	, T_JBV(6078361)
	, T_JBV(6082411)
	, T_JBV(6079855)
   );
 V_TMP_JBV T_JBV;
 
 BEGIN
 
 
 EXECUTE IMMEDIATE 'SELECT DD_TPC_ID FROM '||V_ESQUEMA||'.DD_TPC_TIPO_PRECIO WHERE DD_TPC_CODIGO = ''02''' INTO DD_TPC_ID_VENTA;
 EXECUTE IMMEDIATE 'SELECT DD_TPC_ID FROM '||V_ESQUEMA||'.DD_TPC_TIPO_PRECIO WHERE DD_TPC_CODIGO = ''04''' INTO DD_TPC_ID_AUTORIZADO;
 
 FOR I IN V_JBV.FIRST .. V_JBV.LAST
 LOOP
    V_TMP_JBV := V_JBV(I);
    
    ACT_NUM_ACTIVO := V_TMP_JBV(1);
	EXECUTE IMMEDIATE 'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||'' INTO ACT_ID;
    
    V_SQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_HVA_HIST_VALORACIONES (
    			  ACT_ID
				, DD_TPC_ID
				, HVA_FECHA_APROBACION
				, HVA_FECHA_CARGA
				, HVA_FECHA_FIN
				, HVA_FECHA_INICIO
				, HVA_ID
				, HVA_IMPORTE
				, HVA_OBSERVACIONES
				, USUARIOCREAR
				, FECHACREAR
    			) VALUES (
    			  '||ACT_ID||'
    			, '||DD_TPC_ID_VENTA||'
    			, (SELECT VAL_FECHA_APROBACION FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||DD_TPC_ID_VENTA||')
    			, (SELECT VAL_FECHA_CARGA FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||DD_TPC_ID_VENTA||')
    			, (SELECT VAL_FECHA_FIN FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||DD_TPC_ID_VENTA||')
    			, (SELECT VAL_FECHA_INICIO FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||DD_TPC_ID_VENTA||')
    			, S_ACT_HVA_HIST_VALORACIONES.NEXTVAL
    			, (SELECT VAL_IMPORTE FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||DD_TPC_ID_VENTA||')
    			, (SELECT VAL_OBSERVACIONES FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||DD_TPC_ID_VENTA||')
    			, '''||V_USUARIO||'''
    			, SYSDATE
    			)
 				';
    
 	EXECUTE IMMEDIATE V_SQL;
 	
 	
 	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_HVA_HIST_VALORACIONES (
    			  ACT_ID
				, DD_TPC_ID
				, HVA_FECHA_APROBACION
				, HVA_FECHA_CARGA
				, HVA_FECHA_FIN
				, HVA_FECHA_INICIO
				, HVA_ID
				, HVA_IMPORTE
				, HVA_OBSERVACIONES
				, USUARIOCREAR
				, FECHACREAR
    			) VALUES (
    			  '||ACT_ID||'
    			, '||DD_TPC_ID_AUTORIZADO||'
    			, (SELECT VAL_FECHA_APROBACION FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||DD_TPC_ID_AUTORIZADO||')
    			, (SELECT VAL_FECHA_CARGA FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||DD_TPC_ID_AUTORIZADO||')
    			, (SELECT VAL_FECHA_FIN FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||DD_TPC_ID_AUTORIZADO||')
    			, (SELECT VAL_FECHA_INICIO FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||DD_TPC_ID_AUTORIZADO||')
    			, S_ACT_HVA_HIST_VALORACIONES.NEXTVAL
    			, (SELECT VAL_IMPORTE FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||DD_TPC_ID_AUTORIZADO||')
    			, (SELECT VAL_OBSERVACIONES FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||DD_TPC_ID_AUTORIZADO||')
    			, '''||V_USUARIO||'''
    			, SYSDATE
    			)
 				';
 				
	 	EXECUTE IMMEDIATE V_SQL;
	 	
	 	
	 	V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET
	 			    FECHAMODIFICAR	 = SYSDATE
				  , USUARIOMODIFICAR = '''||V_USUARIO||'''
				  , VAL_FECHA_FIN	 = NULL
				  , VAL_FECHA_INICIO = SYSDATE
				  , VAL_IMPORTE		 = 0
				  WHERE ACT_ID 		 = '||ACT_ID||'
				  AND DD_TPC_ID IN ('||DD_TPC_ID_AUTORIZADO||', '||DD_TPC_ID_VENTA||')
	 			  ';
		EXECUTE IMMEDIATE V_SQL;
		
        DBMS_OUTPUT.PUT_LINE('Actualizados los precios minimos de venta y precios de venta del activo '||ACT_NUM_ACTIVO);
      
	END LOOP;
	
 COMMIT;
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------'); 
          DBMS_OUTPUT.PUT_LINE(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
