--/*
--/*
--###########################################
--## AUTOR=JESSICA SAMPERE
--## FECHA_CREACION=20180718
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=2.0.15
--## INCIDENCIA_LINK=HREOS-4216
--## PRODUCTO=NO
--## 
--## Finalidad: Carga gestores
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--##        0.2 Añadidos gestores y supervisores no tenidos en cuenta y creados por REMVIP.
--###########################################
----*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
	ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
 
	V_TICKET VARCHAR2(25 CHAR) := 'HREOS-4216';
	V_AUX NUMBER(25);
	V_USU_ID NUMBER(16);
	V_TGE_ID NUMBER(16);
	V_GEE_ID NUMBER(16);
	V_GEE_FECHA DATE;
	V_GEH_ID NUMBER(16);
	V_ACT NUMBER(16);
	 

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(200);
	TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
	V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(

		T_TIPO_DATA('GACT','adelaroja'),
		T_TIPO_DATA('GACT','agonzaleza'),
		T_TIPO_DATA('GACT','amonge'),
		T_TIPO_DATA('GACT','aruiz'),
		T_TIPO_DATA('GACT','ckuhnel'),
		T_TIPO_DATA('GACT','gmurcia'),
		T_TIPO_DATA('GACT','jberenguerx'),
		T_TIPO_DATA('GACT','maranda'),
		T_TIPO_DATA('GACT','mgarciade'),
		T_TIPO_DATA('GACT','mperez'),
		T_TIPO_DATA('GACT','nhorcajo'),
		T_TIPO_DATA('GACT','rdl'),
		T_TIPO_DATA('GACT','rguirado'),
		T_TIPO_DATA('GACT','selena'),
		T_TIPO_DATA('GACT','acabello'),
		T_TIPO_DATA('GACT','jlpelaz'),
		T_TIPO_DATA('GACT','ibenedito'),
		T_TIPO_DATA('GACT','rdura'),
		T_TIPO_DATA('GACT','jbadia'),
		T_TIPO_DATA('GSUE','aalvear'),
		T_TIPO_DATA('GSUE','mgomezp'),
		T_TIPO_DATA('GSUE','prodriguezdelema'),
		T_TIPO_DATA('GSUE','sflores'),
		T_TIPO_DATA('SUPACT','amartinezb'),
		T_TIPO_DATA('SUPACT','bbaviera'),
		T_TIPO_DATA('SUPACT','lfabe'),
		T_TIPO_DATA('SUPACT','rbarroso'),
		T_TIPO_DATA('SUPACT','jcordoba'),
		T_TIPO_DATA('SUPSUE','jcordoba')

	); 
	V_TMP_TIPO_DATA T_TIPO_DATA;
  	

	COUNT_SEL_USU VARCHAR2 (32000) := q'[SELECT COUNT(1) FROM #ESQUEMA_MASTER#.USU_USUARIOS WHERE USU_USERNAME = :1 AND BORRADO = 0]';
	COUNT_SEL_TGE VARCHAR2 (32000) := q'[SELECT COUNT(1) FROM #ESQUEMA_MASTER#.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = :1 AND BORRADO = 0]';
	COUNT_SEL_GEE VARCHAR2(32000) := q'[SELECT COUNT(1) FROM #ESQUEMA#.GEE_GESTOR_ENTIDAD WHERE USU_ID = :1 AND DD_TGE_ID = :2 AND BORRADO = 0]';

	SEL_TGE VARCHAR2 (32000) := q'[SELECT DD_TGE_ID FROM #ESQUEMA_MASTER#.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = :1 AND BORRADO = 0]';
	SEL_USU VARCHAR2 (32000) := q'[SELECT USU_ID FROM #ESQUEMA_MASTER#.USU_USUARIOS WHERE USU_USERNAME = :1 AND BORRADO = 0]';


	UPD_GEE VARCHAR2 (32000) := q'[UPDATE #ESQUEMA#.GEE_GESTOR_ENTIDAD SET USUARIOMODIFICAR = :1 WHERE USU_ID = :2 AND DD_TGE_ID = :3]';
	UPD_GEH VARCHAR2 (32000) := q'[UPDATE #ESQUEMA#.GEH_GESTOR_ENTIDAD_HIST SET USUARIOMODIFICAR = :1, FECHAMODIFICAR = sysdate, GEH_FECHA_HASTA = sysdate WHERE USU_ID = :2 AND DD_TGE_ID = :3]';

	DEL_GAC VARCHAR2 (32000) := q'[DELETE FROM #ESQUEMA#.GAC_GESTOR_ADD_ACTIVO WHERE GEE_ID IN (SELECT GEE_ID FROM #ESQUEMA#.GEE_GESTOR_ENTIDAD WHERE USUARIOMODIFICAR = :1)]';
	DEL_GEE VARCHAR2 (32000) := q'[DELETE FROM #ESQUEMA#.GEE_GESTOR_ENTIDAD WHERE USUARIOMODIFICAR = :1]';


BEGIN	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');
	
	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
    	LOOP
		V_TMP_TIPO_DATA := V_TIPO_DATA(I);

		EXECUTE IMMEDIATE COUNT_SEL_USU INTO V_AUX USING V_TMP_TIPO_DATA(2);
		IF V_AUX = 1 THEN 
			EXECUTE IMMEDIATE SEL_USU INTO V_USU_ID USING V_TMP_TIPO_DATA(2);
			DBMS_OUTPUT.PUT_LINE('[SEL_USU] '||V_USU_ID);

			EXECUTE IMMEDIATE COUNT_SEL_TGE INTO V_AUX USING V_TMP_TIPO_DATA(1);
			IF V_AUX = 1 THEN 
				EXECUTE IMMEDIATE SEL_TGE INTO V_TGE_ID USING V_TMP_TIPO_DATA(1);
				DBMS_OUTPUT.PUT_LINE('[SEL_TGE] '||V_TGE_ID);

				EXECUTE IMMEDIATE COUNT_SEL_GEE INTO V_AUX USING V_USU_ID, V_TGE_ID;
				IF V_AUX > 0 THEN 
	
					EXECUTE IMMEDIATE UPD_GEE USING V_TICKET, V_USU_ID, V_TGE_ID;
					DBMS_OUTPUT.PUT_LINE('[UPD_GEE]');
				
					EXECUTE IMMEDIATE UPD_GEH USING V_TICKET, V_USU_ID, V_TGE_ID;
					DBMS_OUTPUT.PUT_LINE('[UPD_GEH]');


					EXECUTE IMMEDIATE DEL_GAC USING V_TICKET;
					DBMS_OUTPUT.PUT_LINE('[DEL_GAC]');

					EXECUTE IMMEDIATE DEL_GEE USING V_TICKET;
					DBMS_OUTPUT.PUT_LINE('[DEL_GEE]');

				ELSE DBMS_OUTPUT.PUT_LINE('[KO] GEE '|| V_AUX);
				END IF;
			ELSE DBMS_OUTPUT.PUT_LINE('[KO] TGE '|| V_AUX);
			END IF;
		ELSE DBMS_OUTPUT.PUT_LINE('[KO] USU'|| V_AUX);
		END IF;
	
        
	END LOOP;
    
	COMMIT;
	DBMS_OUTPUT.PUT_LINE('[FIN]: PROCESO ACTUALIZADO CORRECTAMENTE ');
 

EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
