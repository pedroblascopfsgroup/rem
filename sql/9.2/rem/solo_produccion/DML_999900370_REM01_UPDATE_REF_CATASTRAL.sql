--/*
--###########################################
--## AUTOR=Guillermo Llidó Parra
--## FECHA_CREACION=20181020
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-1730
--## PRODUCTO=NO
--## 
--## Finalidad: UPDATEAR REFERENCIA CATASTRAL Y NUM FINCA
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  V_USUARIO VARCHAR2(100 CHAR) := 'REMVIP-1730';
  
  TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
  TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    -- 	 AGRUPACION DE GASTOS, ESTADO GASTOS 
    T_TIPO_DATA('202770','34840','5329701WN4052N0165DK'),
	T_TIPO_DATA('202771','34840','5329701WN4052N0166FL'),
	T_TIPO_DATA('202772','34840','5329701WN4052N0169JX'),
	T_TIPO_DATA('202773','34840','5329701WN4052N0178MT'),
	T_TIPO_DATA('202774','34840','5329701WN4052N0181MT'),
	T_TIPO_DATA('202775','34840','5329701WN4052N0117EI'),
	T_TIPO_DATA('202776','34840','5329701WN4052N0194PG'),
	T_TIPO_DATA('202777','34840','5329701WN4052N0198FL'),
	T_TIPO_DATA('202778','34840','5329701WN4052N0199GB'),
	T_TIPO_DATA('202779','34840','5329701WN4052N0195AH'),
	T_TIPO_DATA('202780','34840','5329701WN4052N0200GB'),
	T_TIPO_DATA('202781','34840','5329701WN4052N0126OF'),
	T_TIPO_DATA('202782','34840','5329701WN4052N0136HZ'),
	T_TIPO_DATA('202783','34840','5329701WN4052N0131AH'),
	T_TIPO_DATA('202784','34840','5329701WN4052N0129SJ'),
	T_TIPO_DATA('202785','34840','5329701WN4052N0133DK'),
	T_TIPO_DATA('202786','34840','5329701WN4052N0204LQ'),
	T_TIPO_DATA('202787','34840','5329701WN4052N0207XR'),
	T_TIPO_DATA('202788','34840','5329701WN4052N0205BW'),
	T_TIPO_DATA('202790','34840','5329701WN4052N0222ID'),
	T_TIPO_DATA('202791','34840','5329701WN4052N0218US'),
	T_TIPO_DATA('202792','34840','5329701WN4052N0223OF'),
	T_TIPO_DATA('202793','34840','5329701WN4052N0219ID'),
	T_TIPO_DATA('202794','34840','5329701WN4052N0217YA'),
	T_TIPO_DATA('203171','34840','5329701WN4052N0167GB'),
	T_TIPO_DATA('203172','34840','5329701WN4052N0161OF'),
	T_TIPO_DATA('203173','34840','5329701WN4052N0171HZ'),
	T_TIPO_DATA('203174','34840','5329701WN4052N0185RO'),
	T_TIPO_DATA('203331','34840','5329701WN4052N0238ZE'),
	T_TIPO_DATA('203332','34840','5329701WN4052N0243MT'),
	T_TIPO_DATA('203333','34840','5329701WN4052N0240BW'),
	T_TIPO_DATA('203334','34840','5329701WN4052N0148WU'),
	T_TIPO_DATA('203336','34840','5329701WN4052N0248TP'),
	T_TIPO_DATA('203337','34840','5329701WN4052N0246EI'),
	T_TIPO_DATA('203338','34840','5329701WN4052N0249YA'),
	T_TIPO_DATA('203339','34840','5329701WN4052N0263FL'),
	T_TIPO_DATA('203340','34840','5329701WN4052N0258SJ'),
	T_TIPO_DATA('203341','34840','5329701WN4052N0264GB'),
	T_TIPO_DATA('203342','34840','5329701WN4052N0259DK'),
	T_TIPO_DATA('203343','34840','5329701WN4052N0257AH'),
	T_TIPO_DATA('203344','34840','5329701WN4052N0262DK'),
	T_TIPO_DATA('203345','34840','5329701WN4052N0143BW'),
	T_TIPO_DATA('203346','34840','5329701WN4052N0224PG'),
	T_TIPO_DATA('203347','34840','5329701WN4052N0225AH'),
	T_TIPO_DATA('203481','34840','5329701WN4052N0268LQ'),
	T_TIPO_DATA('203482','34840','5329701WN4052N0242XR'),
	T_TIPO_DATA('203483','34840','5329701WN4052N0236LQ'),
	T_TIPO_DATA('203484','34840','5329701WN4052N0239XR'),
	T_TIPO_DATA('203485','34840','5329701WN4052N0235KM'),
	T_TIPO_DATA('203486','34840','5329701WN4052N0237BW'),
	T_TIPO_DATA('203487','34840','5329701WN4052N0154TP'),
	T_TIPO_DATA('203488','34840','5329701WN4052N0156US'),
	T_TIPO_DATA('203489','34840','5329701WN4052N0245WU'),
	T_TIPO_DATA('203490','34840','5329701WN4052N0250RO'),
	T_TIPO_DATA('203491','34840','5329701WN4052N0247RO'),
	T_TIPO_DATA('203492','34840','5329701WN4052N0267KM'),
	T_TIPO_DATA('203493','34840','5329701WN4052N0141KM'),
	T_TIPO_DATA('203494','34840','5329701WN4052N0147QY'),
	T_TIPO_DATA('203495','34840','5329701WN4052N0139LQ'),
	T_TIPO_DATA('203853','34840','5329701WN4052N0232GB'),
	T_TIPO_DATA('203854','34840','5329701WN4052N0228FL'),
	T_TIPO_DATA('203918','34840','5329701WN4052N0269BW'),
	T_TIPO_DATA('203919','34840','5329701WN4052N0270KM'),
	T_TIPO_DATA('203920','34840','5329701WN4052N0234JX'),
	T_TIPO_DATA('203921','34840','5329701WN4052N0241ZE'),
	T_TIPO_DATA('203922','34840','5329701WN4052N0153RO'),
	T_TIPO_DATA('203923','34840','5329701WN4052N0149EI'),
	T_TIPO_DATA('203924','34840','5329701WN4052N0252YA'),
	T_TIPO_DATA('203925','34840','5329701WN4052N0253US'),
	T_TIPO_DATA('204049','34840','5329701WN4052N0230DK'),
	T_TIPO_DATA('204224','34840','5329701WN4052N0158OF'),
	T_TIPO_DATA('204225','34840','5329701WN4052N0155YA'),
	T_TIPO_DATA('204226','34840','5329701WN4052N0152EI'),
	T_TIPO_DATA('204227','34840','5329701WN4052N0244QY'),
	T_TIPO_DATA('204228','34840','5329701WN4052N0146MT'),
	T_TIPO_DATA('204229','34840','5329701WN4052N0144ZE'),
	T_TIPO_DATA('204230','34840','5329701WN4052N0145XR'),
	T_TIPO_DATA('204232','34840','5329701WN4052N0227DK'),
	T_TIPO_DATA('204308','34840','5329701WN4052N0163AH'),
	T_TIPO_DATA('204309','34840','5329701WN4052N0160ID'),
	T_TIPO_DATA('204310','34840','5329701WN4052N0177XR'),
	T_TIPO_DATA('204311','34840','5329701WN4052N0174LQ'),
	T_TIPO_DATA('204312','34840','5329701WN4052N0188US'),
	T_TIPO_DATA('204313','34840','5329701WN4052N0193OF'),
	T_TIPO_DATA('204314','34840','5329701WN4052N0180XR'),
	T_TIPO_DATA('204315','34840','5329701WN4052N0116WU'),
	T_TIPO_DATA('204316','34840','5329701WN4052N0124US'),
	T_TIPO_DATA('204317','34840','5329701WN4052N0120EI'),
	T_TIPO_DATA('204319','34840','5329701WN4052N0119TP'),
	T_TIPO_DATA('204320','34840','5329701WN4052N0201HZ'),
	T_TIPO_DATA('204321','34840','5329701WN4052N0135GB'),
	T_TIPO_DATA('204322','34840','5329701WN4052N0130PG'),
	T_TIPO_DATA('204323','34840','5329701WN4052N0212QY'),
	T_TIPO_DATA('204324','34840','5329701WN4052N0137JX'),
	T_TIPO_DATA('204409','34840','5329701WN4052N0182QY'),
	T_TIPO_DATA('204410','34840','5329701WN4052N0175BW'),
	T_TIPO_DATA('204411','34840','5329701WN4052N0172JX'),
	T_TIPO_DATA('204412','34840','5329701WN4052N0176ZE'),
	T_TIPO_DATA('204413','34840','5329701WN4052N0179QY'),
	T_TIPO_DATA('204414','34840','5329701WN4052N0184EI'),
	T_TIPO_DATA('204415','34840','5329701WN4052N0251TP'),
	T_TIPO_DATA('204416','34840','5329701WN4052N0254ID'),
	T_TIPO_DATA('204417','34840','5329701WN4052N0256PG'),
	T_TIPO_DATA('204418','34840','5329701WN4052N0255OF'),
	T_TIPO_DATA('204419','34840','5329701WN4052N0261SJ'),
	T_TIPO_DATA('204420','34840','5329701WN4052N0159PG'),
	T_TIPO_DATA('204421','34840','5329701WN4052N0138KM'),
	T_TIPO_DATA('204422','34840','5329701WN4052N0233HZ'),
	T_TIPO_DATA('204423','34840','5329701WN4052N0226SJ'),
	T_TIPO_DATA('204424','34840','5329701WN4052N0231FL'),
	T_TIPO_DATA('204516','34840','5329701WN4052N0168HZ'),
	T_TIPO_DATA('204517','34840','5329701WN4052N0164SJ'),
	T_TIPO_DATA('204518','34840','5329701WN4052N0162PG'),
	T_TIPO_DATA('204519','34840','5329701WN4052N0173KM'),
	T_TIPO_DATA('204520','34840','5329701WN4052N0170GB'),
	T_TIPO_DATA('204521','34840','5329701WN4052N0183WU'),
	T_TIPO_DATA('204522','34840','5329701WN4052N0186TP'),
	T_TIPO_DATA('204523','34840','5329701WN4052N0118RO'),
	T_TIPO_DATA('204524','34840','5329701WN4052N0123YA'),
	T_TIPO_DATA('204525','34840','5329701WN4052N0202JX'),
	T_TIPO_DATA('204526','34840','5329701WN4052N0196SJ'),
	T_TIPO_DATA('204527','34840','5329701WN4052N0197DK'),
	T_TIPO_DATA('204528','34840','5329701WN4052N0128AH'),
	T_TIPO_DATA('204529','34840','5329701WN4052N0127PG'),
	T_TIPO_DATA('204530','34840','5329701WN4052N0209QY'),
	T_TIPO_DATA('204531','34840','5329701WN4052N0210XR'),
	T_TIPO_DATA('204532','34840','5329701WN4052N0207XR'),
	T_TIPO_DATA('204533','34840','5329701WN4052N0215RO'),
	T_TIPO_DATA('204534','34840','5329701WN4052N0220YA'),
	T_TIPO_DATA('204535','34840','5329701WN4052N0221US'),
	T_TIPO_DATA('204541','34840','5329701WN4052N0122TP'),
	T_TIPO_DATA('204542','34840','5329701WN4052N0125ID'),
	T_TIPO_DATA('204543','34840','5329701WN4052N0203KM'),
	T_TIPO_DATA('204544','34840','5329701WN4052N0132SJ'),
	T_TIPO_DATA('204545','34840','5329701WN4052N0213WU'),
	T_TIPO_DATA('204546','34840','5329701WN4052N0206ZE'),
	T_TIPO_DATA('204547','34840','5329701WN4052N0216TP'),
	T_TIPO_DATA('204548','34840','5329701WN4052N0211MT'),
	T_TIPO_DATA('933862','34840','5329701WN4052N0142LQ'),
	T_TIPO_DATA('934014','34840','5329701WN4052N0150QY'),
	T_TIPO_DATA('935845','34840','5329701WN4052N0151WU'),
	T_TIPO_DATA('202754','35018','5329701WN4052N0090EI'),
	T_TIPO_DATA('202757','34932','5329701WN4052N0047ZE'),
	T_TIPO_DATA('202758','34934','5329701WN4052N0048XR'),
	T_TIPO_DATA('202759','35030','5329701WN4052N0096OF'),
	T_TIPO_DATA('202760','35028','5329701WN4052N0095ID'),
	T_TIPO_DATA('202761','34876','5329701WN4052N0019WU'),
	T_TIPO_DATA('202762','34892','5329701WN4052N0027US'),
	T_TIPO_DATA('202763','34886','5329701WN4052N0024RO'),
	T_TIPO_DATA('202764','35062','5329701WN4052N0112ZE'),
	T_TIPO_DATA('202765','35068','5329701WN4052N0115QY'),
	T_TIPO_DATA('202766','34940','5329701WN4052N0051XR'),
	T_TIPO_DATA('202767','34960','5329701WN4052N0061YA'),
	T_TIPO_DATA('202768','34954','5329701WN4052N0058YA'),
	T_TIPO_DATA('202769','34962','5329701WN4052N0062US'),
	T_TIPO_DATA('203088','35012','5329701WN4052N0087EI'),
	T_TIPO_DATA('203089','34930','5329701WN4052N0046BW'),
	T_TIPO_DATA('203090','34926','5329701WN4052N0044KM'),
	T_TIPO_DATA('203091','35026','5329701WN4052N0094US'),
	T_TIPO_DATA('203092','35024','5329701WN4052N0093YA'),
	T_TIPO_DATA('203093','34884','5329701WN4052N0023EI'),
	T_TIPO_DATA('203094','35042','5329701WN4052N0102FL'),
	T_TIPO_DATA('203095','35054','5329701WN4052N0108BW'),
	T_TIPO_DATA('203096','35056','5329701WN4052N0109ZE'),
	T_TIPO_DATA('203098','34952','5329701WN4052N0057TP'),
	T_TIPO_DATA('203153','35020','5329701WN4052N0091RO'),
	T_TIPO_DATA('203154','35006','5329701WN4052N0084MT'),
	T_TIPO_DATA('203156','35008','5329701WN4052N0085QY'),
	T_TIPO_DATA('203157','34920','5329701WN4052N0041GB'),
	T_TIPO_DATA('203158','34936','5329701WN4052N0049MT'),
	T_TIPO_DATA('203159','34938','5329701WN4052N0050ZE'),
	T_TIPO_DATA('203161','35040','5329701WN4052N0101DK'),
	T_TIPO_DATA('203162','34878','5329701WN4052N0020MT'),
	T_TIPO_DATA('203167','34942','5329701WN4052N0052MT'),
	T_TIPO_DATA('203168','34956','5329701WN4052N0059US'),
	T_TIPO_DATA('203169','34864','5329701WN4052N0013LQ'),
	T_TIPO_DATA('203170','34978','5329701WN4052N0070SJ'),
	T_TIPO_DATA('203327','34902','5329701WN4052N0032OF'),
	T_TIPO_DATA('203328','34868','5329701WN4052N0015ZE'),
	T_TIPO_DATA('203330','34996','5329701WN4052N0079ZE'),
	T_TIPO_DATA('203470','34966','5329701WN4052N0064OF'),
	T_TIPO_DATA('203472','34912','5329701WN4052N0037FL'),
	T_TIPO_DATA('203473','34914','5329701WN4052N0038GB'),
	T_TIPO_DATA('203474','34982','5329701WN4052N0072FL'),
	T_TIPO_DATA('203475','34990','5329701WN4052N0076KM'),
	T_TIPO_DATA('203476','34986','5329701WN4052N0074HZ'),
	T_TIPO_DATA('203477','34992','5329701WN4052N0077LQ'),
	T_TIPO_DATA('203478','34984','5329701WN4052N0073GB'),
	T_TIPO_DATA('203479','34994','5329701WN4052N0078BW'),
	T_TIPO_DATA('203480','34870','5329701WN4052N0016XR'),
	T_TIPO_DATA('203910','34974','5329701WN4052N0068DK'),
	T_TIPO_DATA('203911','34968','5329701WN4052N0065PG'),
	T_TIPO_DATA('203912','34976','5329701WN4052N0069FL'),
	T_TIPO_DATA('203913','34916','5329701WN4052N0039HZ'),
	T_TIPO_DATA('203914','34858','5329701WN4052N0010HZ'),
	T_TIPO_DATA('203915','34998','5329701WN4052N0080LQ'),
	T_TIPO_DATA('203916','34988','5329701WN4052N0075JX'),
	T_TIPO_DATA('203917','34862','5329701WN4052N0012KM'),
	T_TIPO_DATA('203928','35010','5329701WN4052N0086WU'),
	T_TIPO_DATA('203929','35016','5329701WN4052N0089TP'),
	T_TIPO_DATA('203930','34924','5329701WN4052N0043JX'),
	T_TIPO_DATA('203931','34922','5329701WN4052N0042HZ'),
	T_TIPO_DATA('204214','34972','5329701WN4052N0067SJ'),
	T_TIPO_DATA('204215','34964','5329701WN4052N0063ID'),
	T_TIPO_DATA('204216','34866','5329701WN4052N0014BW'),
	T_TIPO_DATA('204217','34898','5329701WN4052N0030US'),
	T_TIPO_DATA('204218','34908','5329701WN4052N0035SJ'),
	T_TIPO_DATA('204220','34910','5329701WN4052N0036DK'),
	T_TIPO_DATA('204221','34906','5329701WN4052N0034AH'),
	T_TIPO_DATA('204295','35038','5329701WN4052N0100SJ'),
	T_TIPO_DATA('204296','35032','5329701WN4052N0097PG'),
	T_TIPO_DATA('204297','35034','5329701WN4052N0098AH'),
	T_TIPO_DATA('204298','35036','5329701WN4052N0099SJ'),
	T_TIPO_DATA('204300','34880','5329701WN4052N0021QY'),
	T_TIPO_DATA('204302','35058','5329701WN4052N0110LQ'),
	T_TIPO_DATA('204304','35046','5329701WN4052N0104HZ'),
	T_TIPO_DATA('204306','35066','5329701WN4052N0114MT'),
	T_TIPO_DATA('204307','34872','5329701WN4052N0017MT'),
	T_TIPO_DATA('204508','34890','5329701WN4052N0026YA'),
	T_TIPO_DATA('204510','35052','5329701WN4052N0107LQ'),
	T_TIPO_DATA('204512','34948','5329701WN4052N0055EI'),
	T_TIPO_DATA('204513','34944','5329701WN4052N0053QY'),
	T_TIPO_DATA('204514','34946','5329701WN4052N0054WU'),
	T_TIPO_DATA('204515','34874','5329701WN4052N0018QY'),
	T_TIPO_DATA('937921','34894','5329701WN4052N0028ID')
	); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');

	 
    -- LOOP para actualizar los valores en ECO_EXPEDIENTE_COMERCIAL -----------------------------------------------------------------
    DBMS_OUTPUT.PUT_LINE('[INFO]: UPDATE REFERENCIA CATASTRAL ACTIVOS');
    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
      LOOP
      
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
    
        --Comprobamos el dato a insertar
        V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||TRIM(V_TMP_TIPO_DATA(1))||'';
				
        EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
        
        --Si existe realizamos otra comprobacion
        IF V_NUM_TABLAS > 0 THEN		

			DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICAMOS EL ESTADO DE LOS GASTOS POR AGRUPACION DE GASTOS '||TRIM(V_TMP_TIPO_DATA(1))||'');
			V_MSQL := 'UPDATE '||V_ESQUEMA||'.BIE_BIEN SET BIE_REFERENCIA_CATASTRAL = '''||TRIM(V_TMP_TIPO_DATA(3))||'''
															, USUARIOMODIFICAR = '''||V_USUARIO||'''
															, FECHAMODIFICAR = SYSDATE
						WHERE BIE_ID = (SELECT BIE.BIE_ID FROM REM01.ACT_ACTIVO ACT
										INNER JOIN REM01.BIE_BIEN BIE on ACT.BIE_ID = BIE.BIE_ID 
										WHERE ACT.ACT_NUM_ACTIVO = '||TRIM(V_TMP_TIPO_DATA(1))||')';
										
			EXECUTE IMMEDIATE V_MSQL;
			
			V_MSQL := 'UPDATE '||V_ESQUEMA||'.BIE_BIEN_ENTIDAD SET BIE_DREG_NUM_FINCA = '||TRIM(V_TMP_TIPO_DATA(2))||' 
																	, USUARIOMODIFICAR = '''||V_USUARIO||'''
																	,FECHAMODIFICAR = SYSDATE
						where bie_id = (SELECT BIE.BIE_ID FROM REM01.ACT_ACTIVO ACT
										INNER JOIN REM01.BIE_BIEN BIE on ACT.BIE_ID = BIE.BIE_ID 
										WHERE ACT.ACT_NUM_ACTIVO = '||TRIM(V_TMP_TIPO_DATA(1))||')';
										
			EXECUTE IMMEDIATE V_MSQL;
			
			V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_CAT_CATASTRO SET CAT_REF_CATASTRAL = '''||TRIM(V_TMP_TIPO_DATA(3))||'''
																	, USUARIOMODIFICAR = '''||V_USUARIO||'''
																	, FECHAMODIFICAR = SYSDATE
						WHERE ACT_ID = (SELECT ACT_ID FROM REM01.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||TRIM(V_TMP_TIPO_DATA(1))||')';
						
			EXECUTE IMMEDIATE V_MSQL;
			

			DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZADO CORRECTAMENTE LA REFERENCIA CATASTRAL DEL ACTIVO '||TRIM(V_TMP_TIPO_DATA(1))||'');
			
		--El activo no existe
		ELSE
			  DBMS_OUTPUT.PUT_LINE('[INFO]: LA REFERENCIA CATASTRAL DEL ACTIVO '''||TRIM(V_TMP_TIPO_DATA(1))||' NO HA SIDO ACTUALIZADA');
		END IF;
		
    END LOOP;
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN]: REFERENCIAS CATASTRALES CORRECTAMENTE ');

EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
