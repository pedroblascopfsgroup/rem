--/*
--##########################################
--## AUTOR=PIER GOTTA 
--## FECHA_CREACION=20181122
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-2623
--## PRODUCTO=NO
--##
--## Finalidad: Update de APU
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 
DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    V_NUM_FILAS NUMBER(16); -- Vble. para validar la existencia de un registro.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-2623'; -- USUARIOCREAR/USUARIOMODIFICAR.
    V_ECO_ID NUMBER(16); 
    
    ACT_NUM_ACTIVO NUMBER(16);
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
		T_JBV(203246)
		,T_JBV(203247)
		,T_JBV(203369)
		,T_JBV(203439)
		,T_JBV(203440)
		,T_JBV(203442)
		,T_JBV(203611)
		,T_JBV(203786)
		,T_JBV(203798)
		,T_JBV(203799)
		,T_JBV(203800)
		,T_JBV(203801)
		,T_JBV(203802)
		,T_JBV(203803)
		,T_JBV(203804)
		,T_JBV(203805)
		,T_JBV(203806)
		,T_JBV(203807)
		,T_JBV(203808)
		,T_JBV(203811)
		,T_JBV(203812)
		,T_JBV(203813)
		,T_JBV(203814)
		,T_JBV(203818)
		,T_JBV(203819)
		,T_JBV(203821)
		,T_JBV(203823)
		,T_JBV(203824)
		,T_JBV(203825)
		,T_JBV(203829)
		,T_JBV(203830)
		,T_JBV(203831)
		,T_JBV(203833)
		,T_JBV(203834)
		,T_JBV(203835)
		,T_JBV(203836)
		,T_JBV(203839)
		,T_JBV(203840)
		,T_JBV(203841)
		,T_JBV(203842)
		,T_JBV(203856)
		,T_JBV(203859)
		,T_JBV(203860)
		,T_JBV(203861)
		,T_JBV(203862)
		,T_JBV(203863)
		,T_JBV(203868)
		,T_JBV(203870)
		,T_JBV(203871)
		,T_JBV(203873)
		,T_JBV(203874)
		,T_JBV(203876)
		,T_JBV(203877)
		,T_JBV(203878)
		,T_JBV(203879)
		,T_JBV(204004)
		,T_JBV(204005)
		,T_JBV(204007)
		,T_JBV(204009)
		,T_JBV(204010)
		,T_JBV(204012)
		,T_JBV(204014)
		,T_JBV(204016)
		,T_JBV(204017)
		,T_JBV(204018)
		,T_JBV(204019)
		,T_JBV(204020)
		,T_JBV(204023)
		,T_JBV(204024)
		,T_JBV(204030)
		,T_JBV(204031)
		,T_JBV(204033)
		,T_JBV(204035)
		,T_JBV(204175)
		,T_JBV(204245)
		,T_JBV(204256)
		,T_JBV(204258)
		,T_JBV(204260)
		,T_JBV(204262)
		,T_JBV(204263)
		,T_JBV(204264)
		,T_JBV(204265)
		,T_JBV(204266)
		,T_JBV(204267)
		,T_JBV(204270)
		,T_JBV(204271)
		,T_JBV(204272)
		,T_JBV(204274)
		,T_JBV(204277)
		,T_JBV(204278)
		,T_JBV(204279)
		,T_JBV(204281)
		,T_JBV(204282)
		,T_JBV(204283)
		,T_JBV(204284)
		,T_JBV(204286)
		,T_JBV(204287)
		,T_JBV(204289)
		,T_JBV(204290)
		,T_JBV(204387)
		,T_JBV(204388)
		,T_JBV(204390)
		,T_JBV(204391)
		,T_JBV(204392)
		,T_JBV(204393)
		,T_JBV(204394)
		,T_JBV(204395)
		,T_JBV(204396)
		,T_JBV(204397)
		,T_JBV(204398)
		,T_JBV(204399)
		,T_JBV(204404)
		,T_JBV(204405)
		,T_JBV(204408)
		,T_JBV(204453)
		,T_JBV(204456)
		,T_JBV(204458)
		,T_JBV(204462)
		,T_JBV(204465)
		,T_JBV(204489)
		,T_JBV(204492)
		,T_JBV(204493)
		,T_JBV(204494)
		,T_JBV(204495)
		,T_JBV(204496)
		,T_JBV(204497)
		,T_JBV(204501)
		,T_JBV(204502)
		,T_JBV(204503)
		,T_JBV(204505)
		,T_JBV(204605)
		,T_JBV(204606)
		,T_JBV(204607)
		,T_JBV(204609)
		,T_JBV(204611)
		,T_JBV(204613)
		,T_JBV(204614)
		,T_JBV(204615)
		,T_JBV(204616)
		,T_JBV(204617)
		,T_JBV(204619)
		,T_JBV(204620)
		,T_JBV(6028981)
		,T_JBV(6028982)
		,T_JBV(6029017)
		,T_JBV(6029412)
		,T_JBV(6031010)
		,T_JBV(6031198)
		,T_JBV(6031702)
		,T_JBV(6033727)
		,T_JBV(6033758)
		,T_JBV(6034767)
		,T_JBV(6034824)
		,T_JBV(6034921)
		,T_JBV(6035561)
		,T_JBV(6035742)
		,T_JBV(6035743)
		,T_JBV(6035997)
		,T_JBV(6036134)
		,T_JBV(6036406)
		,T_JBV(6036407)
		,T_JBV(6036408)
		,T_JBV(6037153)
		,T_JBV(6038931)
		,T_JBV(6041242)
		,T_JBV(6041847)
		,T_JBV(6041895)
		,T_JBV(6042153)
		,T_JBV(6042154)
		,T_JBV(6042740)
		,T_JBV(6042741)
		,T_JBV(6043428)
		,T_JBV(6079167)
		,T_JBV(6083393)
		,T_JBV(6084663)
		,T_JBV(6814994)
		
	); 
	V_TMP_JBV T_JBV;
    
BEGIN	

	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
	V_TMP_JBV := V_JBV(I);
	
  	ACT_NUM_ACTIVO := TRIM(V_TMP_JBV(1));
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ACTUALIZACION COLUMNA ACT_NUM_ACTIVO');
	
	V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO;
	
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS;
	
	IF V_NUM_FILAS = 1 THEN
	
		V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION 
				   SET DD_TPU_ID = 1,
				   DD_EPV_ID = 3, 
				   DD_EPA_ID = 4,
				   DD_MTO_A_ID = 3,
				   DD_MTO_V_ID = null,
				   APU_CHECK_OCULTAR_V = 0,
				   USUARIOMODIFICAR = '''||V_USR||''',
				   FECHAMODIFICAR = SYSDATE
				   WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||')';
	
		EXECUTE IMMEDIATE V_MSQL;
    
		DBMS_OUTPUT.PUT_LINE('[FIN] REGISTRO CON ACT_NUM_ACTIVO: '||ACT_NUM_ACTIVO||' ACTUALIZADO');
		
		V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
		
	ELSE
		
		DBMS_OUTPUT.PUT_LINE('[FIN] REGISTRO NO EXISTE');
		
	END IF;
	
	END LOOP;
		
	COMMIT;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han borrado en total '||V_COUNT_UPDATE||' registros');
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
