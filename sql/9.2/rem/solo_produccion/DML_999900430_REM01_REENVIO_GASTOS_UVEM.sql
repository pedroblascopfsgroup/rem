--/*
--##########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20181203
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-2728
--## PRODUCTO=NO
--##
--## Finalidad: preparar gastos para envío a UVEM y revisar su retorno
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    --V_COUNT NUMBER(16); -- Vble. para contar.
    --V_COUNT_INSERT NUMBER(16):= 0; -- Vble. para contar inserts
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	V_USUARIO VARCHAR2(32 CHAR):= 'REMVIP-2728';
 
 BEGIN

 --Ponemos el estado del o de los gastos en Autorizado Administración

   EXECUTE IMMEDIATE   'MERGE INTO REM01.GGE_GASTOS_GESTION T1
                        USING (
                            SELECT GPV_ID
                            FROM REM01.GPV_GASTOS_PROVEEDOR GPV
                            WHERE GPV_NUM_GASTO_HAYA IN (10169620, 
				10160236, 
				10159460, 
				10159773, 
				10159833,
				10159832, 
				10159776, 
				10159762, 
				10159791, 
				10159763, 
				10159764, 
				10159789, 
				10159806, 
				10159807, 
				10159804, 
				10159754, 
				10159766, 
				10159743, 
				10159794, 
				10159760, 
				10159803, 
				10159744, 
				10159755, 
				10159779, 
				10159741, 
				10159751, 
				10159749, 
				10159765, 
				10159813, 
				10159786, 
				10159769, 
				10159784, 
				10159748, 
				10159767, 
				10159793, 
				10159742, 
				10159745, 
				10159752, 
				10159761, 
				10159759, 
				10159816, 
				10159746, 
				10159814, 
				10159775, 
				10159831, 
				10159824, 
				10159798, 
				10159823, 
				10159774, 
				10159797, 
				10159796, 
				10159847, 
				10159848, 
				10159808, 
				10159810, 
				10159811, 
				10159756, 
				10159800, 
				10159801, 
				10159802, 
				10159815, 
				10159771, 
				10159772, 
				10159788, 
				10159787, 
				10159778, 
				10159777, 
				10159805, 
				10159757, 
				10159758, 
				10159768, 
				10158453, 
				10158461, 
				10158514, 
				10158249, 
				10047409, 
				10047410, 
				10047411, 
				10047412, 
				10046652, 
				10046664, 
				10046678, 
				10046530, 
				10046630,
				10046493, 
				10046671, 
				10046672, 
				10046706, 
				10046574, 
				10046617, 
				10046465, 
				10046710, 
				10046654, 
				10046470, 
				10046645,
				10046531, 
				10046638, 
				10046489, 
				10046486, 
				10046483, 
				10046482, 
				10046479, 
				10046478, 
				10046457,
				10046563, 
				10046656, 
				10046550, 
				10046631, 
				10046564, 
				10046596, 
				10046687, 
				10046657, 
				10046605, 
				10046461, 
				10046462, 
				10046460, 
				10046582, 
				10046679, 
				10046553, 
				10046600, 
				10046700, 
				10046634, 
				10046556, 
				10046636, 
				10046611, 
				10046554, 
				10046539, 
				10046490, 
				10046484, 
				10046601, 
				10046501, 
				10046635, 
				10046557, 
				10046637, 
				10046667, 
				10046709, 
				10046612, 
				10046555, 
				10046625, 
				10046533, 
				10046540, 
				10046640, 
				10159819, 
				10159818, 
				10159817, 
				10159820, 
				10159821, 
				10159822, 
				9560966, 
				9560976, 
				9560975, 
				9490565, 
				9492530, 
				10149906, 
				10150244, 
				10149639, 
				10112293, 
				10159187, 
				10159191, 
				10159223, 
				10159228, 
				10159229, 
				10159230, 
				10159231, 
				10159232, 
				10159233, 
				10159235, 
				10159236, 
				10159237, 
				10159238, 
				10159239, 
				10159240, 
				10159241, 
				10159245, 
				10159167, 
				10159242, 
				10159243, 
				10159244, 
				10159247, 
				10159246, 
				10159248, 
				10159249, 
				10159250, 
				10159251, 
				10159252, 
				10159253, 
				10159254, 
				10159255, 
				10159256, 
				10159257, 
				10159258, 
				10159259, 
				10159260, 
				10159261, 
				10159262, 
				10159264, 
				10159263, 
				10159265, 
				10159266, 
				10159267, 
				10159268, 
				10159269, 
				10159270, 
				10159189, 
				10159164, 
				10159165, 
				10159166, 
				10159168, 
				10159169, 
				10159170, 
				10159172, 
				10159171, 
				10159190, 
				10168913, 
				10168971, 
				10168964, 
				10168967, 
				10168970, 
				10168709, 
				10168909, 
				10168908, 
				10168904, 
				10168910, 
				10168680, 
				10168933)
                        
                            ) T2
                        ON (T1.GPV_ID = T2.GPV_ID)
                        WHEN MATCHED THEN UPDATE SET
                            T1.DD_EAH_ID = 3
                          , T1.GGE_FECHA_EAH = SYSDATE
                          , T1.DD_EAP_ID = 1
                          , T1.GGE_FECHA_EAP = NULL
                          , T1.GGE_MOTIVO_RECHAZO_PROP = NULL
                          , T1.GGE_FECHA_ENVIO_PRPTRIO = NULL
                          , T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
                          , T1.FECHAMODIFICAR = SYSDATE';
                       

 DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado '||SQL%ROWCOUNT||' gastos en la GGE_GASTOS_GESTION');    

--Ponemos el estado de autorización por parte de Haya en Autorizado y eliminamos el estado de autorización del propietario, así como actualizar la fecha del estado de autorización de Haya y eliminamos las fechas de estado de autorización del propietario y de envío al propietario

         EXECUTE IMMEDIATE   ' MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
                               USING (
                                   SELECT GPV_ID
                                   FROM REM01.GPV_GASTOS_PROVEEDOR GPV
                                   WHERE GPV_NUM_GASTO_HAYA IN (10169620, 
				10160236, 
				10159460, 
				10159773, 
				10159833,
				10159832, 
				10159776, 
				10159762, 
				10159791, 
				10159763, 
				10159764, 
				10159789, 
				10159806, 
				10159807, 
				10159804, 
				10159754, 
				10159766, 
				10159743, 
				10159794, 
				10159760, 
				10159803, 
				10159744, 
				10159755, 
				10159779, 
				10159741, 
				10159751, 
				10159749, 
				10159765, 
				10159813, 
				10159786, 
				10159769, 
				10159784, 
				10159748, 
				10159767, 
				10159793, 
				10159742, 
				10159745, 
				10159752, 
				10159761, 
				10159759, 
				10159816, 
				10159746, 
				10159814, 
				10159775, 
				10159831, 
				10159824, 
				10159798, 
				10159823, 
				10159774, 
				10159797, 
				10159796, 
				10159847, 
				10159848, 
				10159808, 
				10159810, 
				10159811, 
				10159756, 
				10159800, 
				10159801, 
				10159802, 
				10159815, 
				10159771, 
				10159772, 
				10159788, 
				10159787, 
				10159778, 
				10159777, 
				10159805, 
				10159757, 
				10159758, 
				10159768, 
				10158453, 
				10158461, 
				10158514, 
				10158249, 
				10047409, 
				10047410, 
				10047411, 
				10047412, 
				10046652, 
				10046664, 
				10046678, 
				10046530, 
				10046630,
				10046493, 
				10046671, 
				10046672, 
				10046706, 
				10046574, 
				10046617, 
				10046465, 
				10046710, 
				10046654, 
				10046470, 
				10046645,
				10046531, 
				10046638, 
				10046489, 
				10046486, 
				10046483, 
				10046482, 
				10046479, 
				10046478, 
				10046457,
				10046563, 
				10046656, 
				10046550, 
				10046631, 
				10046564, 
				10046596, 
				10046687, 
				10046657, 
				10046605, 
				10046461, 
				10046462, 
				10046460, 
				10046582, 
				10046679, 
				10046553, 
				10046600, 
				10046700, 
				10046634, 
				10046556, 
				10046636, 
				10046611, 
				10046554, 
				10046539, 
				10046490, 
				10046484, 
				10046601, 
				10046501, 
				10046635, 
				10046557, 
				10046637, 
				10046667, 
				10046709, 
				10046612, 
				10046555, 
				10046625, 
				10046533, 
				10046540, 
				10046640, 
				10159819, 
				10159818, 
				10159817, 
				10159820, 
				10159821, 
				10159822, 
				9560966, 
				9560976, 
				9560975, 
				9490565, 
				9492530, 
				10149906, 
				10150244, 
				10149639, 
				10112293, 
				10159187, 
				10159191, 
				10159223, 
				10159228, 
				10159229, 
				10159230, 
				10159231, 
				10159232, 
				10159233, 
				10159235, 
				10159236, 
				10159237, 
				10159238, 
				10159239, 
				10159240, 
				10159241, 
				10159245, 
				10159167, 
				10159242, 
				10159243, 
				10159244, 
				10159247, 
				10159246, 
				10159248, 
				10159249, 
				10159250, 
				10159251, 
				10159252, 
				10159253, 
				10159254, 
				10159255, 
				10159256, 
				10159257, 
				10159258, 
				10159259, 
				10159260, 
				10159261, 
				10159262, 
				10159264, 
				10159263, 
				10159265, 
				10159266, 
				10159267, 
				10159268, 
				10159269, 
				10159270, 
				10159189, 
				10159164, 
				10159165, 
				10159166, 
				10159168, 
				10159169, 
				10159170, 
				10159172, 
				10159171, 
				10159190, 
				10168913, 
				10168971, 
				10168964, 
				10168967, 
				10168970, 
				10168709, 
				10168909, 
				10168908, 
				10168904, 
				10168910, 
				10168680, 
				10168933)
                               
                                   ) T2
                               ON (T1.GPV_ID = T2.GPV_ID)
                               WHEN MATCHED THEN UPDATE SET
                                   T1.DD_EGA_ID = 3, T1.USUARIOMODIFICAR = '''||V_USUARIO||''', T1.FECHAMODIFICAR = SYSDATE';
                               
        
 DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado '||SQL%ROWCOUNT||' gastos en la GPV_GASTOS_PROVEEDOR');
 
 COMMIT;
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------'); 
          DBMS_OUTPUT.PUT_LINE(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
