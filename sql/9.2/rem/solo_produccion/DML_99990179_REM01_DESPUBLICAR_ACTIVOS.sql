--/*
--#########################################
--## AUTOR=Vicente Martinez
--## FECHA_CREACION=20180327
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-MONZA
--## PRODUCTO=NO
--## 
--## Finalidad: Cambio de estado de publicación a despublicado. 
--##			   
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMAMASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.      
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  V_USUARIO VARCHAR2(50 CHAR):= 'REMVIP-MONZA';
  V_CODIGO_DESPUBLICADO VARCHAR2(20 CHAR) := '05';
  V_CODIGO_PUBLICADO VARCHAR2(20 CHAR) := '02';
  V_MOTIVO VARCHAR2 (100 CHAR) := 'Peticion_Luis';
  V_FECHA VARCHAR2(15 CHAR);

  TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(16);
  TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
  V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    T_TIPO_DATA(5961566),
    T_TIPO_DATA(5940343),
    T_TIPO_DATA(5966288),
    T_TIPO_DATA(5938214),
    T_TIPO_DATA(5951680),
    T_TIPO_DATA(5944525),
    T_TIPO_DATA(5953660),
    T_TIPO_DATA(5951021),
    T_TIPO_DATA(5940900),
    T_TIPO_DATA(5969992),
    T_TIPO_DATA(5932712),
    T_TIPO_DATA(5933410),
    T_TIPO_DATA(5937943),
    T_TIPO_DATA(5964949),
    T_TIPO_DATA(5931509),
    T_TIPO_DATA(5961028),
    T_TIPO_DATA(5930764),
    T_TIPO_DATA(5930549),
    T_TIPO_DATA(5945901),
    T_TIPO_DATA(5952634),
    T_TIPO_DATA(5966834),
    T_TIPO_DATA(5962072),
    T_TIPO_DATA(5964201),
    T_TIPO_DATA(5962325),
    T_TIPO_DATA(5957184),
    T_TIPO_DATA(5967294),
    T_TIPO_DATA(5961165),
    T_TIPO_DATA(5936178),
    T_TIPO_DATA(5966783),
    T_TIPO_DATA(5942645),
    T_TIPO_DATA(6060559),
    T_TIPO_DATA(5971536),
    T_TIPO_DATA(6063691)
  ); 

V_TMP_TIPO_DATA T_TIPO_DATA;

BEGIN
 
V_MSQL := 'SELECT TO_CHAR(SYSDATE,''YYMMDD_HH24mmSS'') FROM DUAL';
EXECUTE IMMEDIATE V_MSQL INTO V_FECHA;
 
V_USUARIO := V_USUARIO ||'_'|| V_FECHA;

FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
LOOP

  V_TMP_TIPO_DATA := V_TIPO_DATA(I);

   V_MSQL := '
    UPDATE '||V_ESQUEMA||'.ACT_ACTIVO
    SET DD_EPU_ID = (SELECT DD_EPU_ID 
          FROM '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION EPU WHERE EPU.DD_EPU_CODIGO = '''||V_CODIGO_DESPUBLICADO||''')
          , usuariomodificar = '''||V_USUARIO||'''
          , fechamodificar=sysdate
    WHERE ACT_NUM_ACTIVO = '||TRIM(V_TMP_TIPO_DATA(1))||'';
             
             EXECUTE IMMEDIATE V_MSQL;
             
             V_MSQL := '
  INSERT INTO '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION (
  ACT_ID
  , HEP_ID
  , DD_EPU_ID
  , HEP_MOTIVO
  , HEP_FECHA_DESDE
  , HEP_FECHA_HASTA
  , USUARIOCREAR
  , FECHACREAR
  ) WITH ULTIMO_ESTADO AS (SELECT ACT_ID, DD_EPU_ID, ROW_NUMBER() OVER(PARTITION BY ACT_ID ORDER BY HEP_FECHA_DESDE DESC, HEP_FECHA_HASTA DESC NULLS FIRST) RN FROM ACT_HEP_HIST_EST_PUBLICACION)
  SELECT ACT.ACT_ID as ACT_ID
       , S_ACT_HEP_HIST_EST_PUBLICACION.NEXTVAL as HEP_ID
       , EPU.DD_EPU_ID
       , '''||V_MOTIVO||''' as HEP_MOTIVO
       , SYSDATE as HEP_FECHA_DESDE
       , SYSDATE as HEP_FECHA_HASTA
       , '''||V_USUARIO||''' as usuariocrear
       , sysdate as fechacrear
  FROM  '||V_ESQUEMA||'.ACT_ACTIVO ACT
  JOIN '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION EPU ON DD_EPU_CODIGO = '''||V_CODIGO_PUBLICADO||'''
  LEFT JOIN ULTIMO_ESTADO ULT ON (ULT.DD_EPU_ID = EPU.DD_EPU_ID AND ACT.ACT_ID = ULT.ACT_ID AND ULT.RN = 1)
  where ACT.ACT_NUM_ACTIVO = '||TRIM(V_TMP_TIPO_DATA(1))||'';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('[INFO] '||SQL%ROWCOUNT||' FILAS PUBLICADAS FORZADAS');
             
             V_MSQL := '
  INSERT INTO '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION (
  ACT_ID
  , HEP_ID
  , DD_EPU_ID
  , HEP_MOTIVO
  , HEP_FECHA_DESDE
  , USUARIOCREAR
  , FECHACREAR
  ) WITH ULTIMO_ESTADO AS (SELECT ACT_ID, DD_EPU_ID, ROW_NUMBER() OVER(PARTITION BY ACT_ID ORDER BY HEP_FECHA_DESDE DESC, HEP_FECHA_HASTA DESC NULLS FIRST) RN FROM ACT_HEP_HIST_EST_PUBLICACION)
  SELECT ACT.ACT_ID as ACT_ID
       , S_ACT_HEP_HIST_EST_PUBLICACION.NEXTVAL as HEP_ID
       , EPU.DD_EPU_ID
       , '''||V_MOTIVO||''' as HEP_MOTIVO
       , SYSDATE as HEP_FECHA_DESDE
       , '''||V_USUARIO||''' as usuariocrear
       , sysdate as fechacrear
  FROM  '||V_ESQUEMA||'.ACT_ACTIVO ACT
  JOIN '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION EPU ON DD_EPU_CODIGO = '''||V_CODIGO_DESPUBLICADO||'''
  LEFT JOIN ULTIMO_ESTADO ULT ON (ULT.DD_EPU_ID = EPU.DD_EPU_ID AND ACT.ACT_ID = ULT.ACT_ID AND ULT.RN = 1)
  where ACT.ACT_NUM_ACTIVO = '||TRIM(V_TMP_TIPO_DATA(1))||'';
          EXECUTE IMMEDIATE V_MSQL;
          DBMS_OUTPUT.PUT_LINE('[INFO] '||SQL%ROWCOUNT||' FILAS DESPUBLICADAS');

END LOOP;

COMMIT;


EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);
          ROLLBACK;
          RAISE;   

END;
/
EXIT