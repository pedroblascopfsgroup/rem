--/*
--#########################################
--## AUTOR=SIMEON SHOPOV
--## FECHA_CREACION=20171207
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.10
--## INCIDENCIA_LINK=HREOS-3391
--## PRODUCTO=NO
--## 
--## Finalidad: Proceso de borrado físico de ciertas tablas
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
    
    V_MSQL VARCHAR2 (32000 CHAR);
    V_ESQUEMA VARCHAR2 (30 CHAR) := '#ESQUEMA#';
    V_ESQUEMA_M VARCHAR2 (30 CHAR) := '#ESQUEMA_MASTER#';
    V_TRABAJO VARCHAR2 (50 CHAR) := 'HREOS-3482_backneg';
    V_USUARIO VARCHAR2 (50 CHAR) := 'usugrfbo';
    V_GESTOR VARCHAR2 (50 CHAR) := 'FVDNEG';

BEGIN

    DBMS_OUTPUT.PUT_LINE('[INICIO]');
    
    V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD T1
        USING (SELECT DISTINCT GEE.GEE_ID, AO.ACT_ID, TGE.DD_TGE_ID, USU.USU_ID
            FROM '||V_ESQUEMA||'.OFR_OFERTAS OFR
            JOIN '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR PVE ON OFR.PVE_ID_PRESCRIPTOR = PVE.PVE_ID
            JOIN '||V_ESQUEMA||'.DD_TPR_TIPO_PROVEEDOR TPR ON TPR.DD_TPR_ID = PVE.DD_TPR_ID
            JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
            JOIN '||V_ESQUEMA||'.ACT_OFR AO ON AO.OFR_ID = OFR.OFR_ID
            JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GAC.ACT_ID = AO.ACT_ID
            JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID
            JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON USU.USU_ID = GEE.USU_ID
            JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_ID = GEE.DD_TGE_ID AND TGE.DD_TGE_CODIGO = '''||V_GESTOR||'''
            WHERE TPR.DD_TPR_CODIGO IN (''30'',''31'',''35'',''23'',''33'')) T2
        ON (T1.GEE_ID = T2.GEE_ID AND T1.DD_TGE_ID = T2.DD_TGE_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.USU_ID = (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = '''||V_USUARIO||'''), T1.USUARIOMODIFICAR = '''||V_TRABAJO||''', T1.FECHAMODIFICAR = SYSDATE, T1.USUARIOBORRAR = T2.ACT_ID
        WHERE T1.USU_ID <> (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = '''||V_USUARIO||''') AND T1.BORRADO = 0';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('  [INFO] '||SQL%ROWCOUNT||' Gestores actualizados en GEE.');

    V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD (GEE_ID, USU_ID, DD_TGE_ID, USUARIOCREAR, FECHACREAR, USUARIOBORRAR)
        WITH ACTIVOS_SIN_'||V_GESTOR||' AS (SELECT DISTINCT ACT.ACT_ID
            FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
            JOIN '||V_ESQUEMA||'.ACT_OFR AO ON ACT.ACT_ID = AO.ACT_ID
            JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = AO.OFR_ID AND OFR.BORRADO = 0
            JOIN '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR PVE ON OFR.PVE_ID_PRESCRIPTOR = PVE.PVE_ID
            JOIN '||V_ESQUEMA||'.DD_TPR_TIPO_PROVEEDOR TPR ON TPR.DD_TPR_ID = PVE.DD_TPR_ID
                AND TPR.DD_TPR_CODIGO IN (''30'',''31'',''35'',''23'',''33'')
            WHERE ACT.BORRADO = 0 AND NOT EXISTS (
                SELECT 1
                FROM '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
                JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GAC.GEE_ID = GEE.GEE_ID
                JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_ID = GEE.DD_TGE_ID 
                    AND TGE.DD_TGE_CODIGO = '''||V_GESTOR||'''
                WHERE GAC.ACT_ID = ACT.ACT_ID))
        SELECT '||V_ESQUEMA||'.S_GEE_GESTOR_ENTIDAD.NEXTVAL GEE_ID, (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = '''||V_USUARIO||''')
            , (SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = '''||V_GESTOR||'''), '''||V_TRABAJO||''', SYSDATE, AUX.ACT_ID
        FROM ACTIVOS_SIN_'||V_GESTOR||' AUX';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('  [INFO] '||SQL%ROWCOUNT||' Gestores insertados en GEE.');

    V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO (GEE_ID, ACT_ID)
        SELECT GEE.GEE_ID, TO_NUMBER(GEE.USUARIOBORRAR) 
        FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
        LEFT JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GEE.GEE_ID = GAC.GEE_ID
        WHERE GEE.USUARIOCREAR = '''||V_TRABAJO||''' AND GAC.GEE_ID IS NULL
        UNION 
        SELECT GEE.GEE_ID, TO_NUMBER(GEE.USUARIOBORRAR) 
        FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
        LEFT JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GEE.GEE_ID = GAC.GEE_ID
        WHERE GEE.USUARIOMODIFICAR = '''||V_TRABAJO||''' AND GAC.GEE_ID IS NULL';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('  [INFO] '||SQL%ROWCOUNT||' Gestores insertados en GAC.');

    V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST (GEH_ID,USU_ID,DD_TGE_ID,GEH_FECHA_DESDE
            ,USUARIOCREAR,FECHACREAR,USUARIOBORRAR)
        SELECT '||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL, GEE.USU_ID, GEE.DD_TGE_ID, SYSDATE, '''||V_TRABAJO||''', SYSDATE
            , GEE.USUARIOBORRAR
        FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
        JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GEE.GEE_ID = GAC.GEE_ID
        WHERE GEE.USUARIOMODIFICAR = '''||V_TRABAJO||''' OR GEE.USUARIOCREAR = '''||V_TRABAJO||'''';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('  [INFO] '||SQL%ROWCOUNT||' Gestores insertados en GEH.');

    V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST T1
        USING (
            WITH NEW_RECORDS AS (
                SELECT GEH_ID, USUARIOBORRAR ACT_ID 
                FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST 
                WHERE USUARIOCREAR = '''||V_TRABAJO||''')
            SELECT T1.GEH_ID, T2.ACT_ID, T3.DD_TGE_CODIGO
            FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST T1
            JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO T2 ON T1.GEH_ID = T2.GEH_ID
            JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR T3 ON T3.DD_TGE_ID = T1.DD_TGE_ID AND T3.DD_TGE_CODIGO = '''||V_GESTOR||'''
            JOIN NEW_RECORDS T4 ON T4.ACT_ID = T2.ACT_ID AND T4.GEH_ID <> T1.GEH_ID
            WHERE T1.GEH_FECHA_HASTA IS NULL) T2
        ON (T1.GEH_ID = T2.GEH_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.GEH_FECHA_HASTA = SYSDATE, T1.FECHAMODIFICAR = SYSDATE, T1.USUARIOMODIFICAR = '''||V_TRABAJO||'''';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('  [INFO] '||SQL%ROWCOUNT||' Gestores actualizados en GEH.');
    
    V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO (GEH_ID, ACT_ID)
        SELECT GEH.GEH_ID, GEH.USUARIOBORRAR ACT_ID
        FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
        WHERE GEH.USUARIOCREAR = '''||V_TRABAJO||'''
            AND NOT EXISTS (SELECT 1 
                FROM '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO AUX 
                WHERE AUX.GEH_ID = GEH.GEH_ID)';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('  [INFO] '||SQL%ROWCOUNT||' Gestores insertados en GAH.');
        
    V_MSQL := 'UPDATE '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD SET USUARIOBORRAR = NULL WHERE USUARIOCREAR = '''||V_TRABAJO||''' OR USUARIOMODIFICAR = '''||V_TRABAJO||'''';
    V_MSQL := 'UPDATE '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST SET USUARIOBORRAR = NULL WHERE USUARIOCREAR = '''||V_TRABAJO||'''';

    V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS T1
        USING (SELECT TAC.TAR_ID, TAC.TRA_ID, TAC.ACT_ID
            FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
            JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
            JOIN '||V_ESQUEMA||'.DD_SCR_SUBCARTERA SCR ON SCR.DD_CRA_ID = CRA.DD_CRA_ID AND SCR.DD_SCR_ID = ACT.DD_SCR_ID
                AND SCR.DD_SCR_CODIGO IN (''01'',''03'',''05'',''20'',''21'')
            JOIN '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC ON TAC.ACT_ID = ACT.ACT_ID
            JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID AND TAR.BORRADO = 0
            JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID AND TEX.BORRADO = 0
            JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID AND TAP.BORRADO = 0
            WHERE ACT.BORRADO = 0 AND TAP.TAP_CODIGO IN (''T013_DefinicionOferta'',''T013_ResolucionComite'',''T013_RespuestaOfertante'',''T013_RatificacionComite'',''T013_CierreEconomico'')) T2
        ON (T1.TAR_ID = T2.TAR_ID AND T1.TRA_ID = T2.TRA_ID AND T1.ACT_ID = T2.ACT_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.USU_ID = (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = '''||V_USUARIO||'''), T1.USUARIOMODIFICAR = '''||V_TRABAJO||''', T1.FECHAMODIFICAR = SYSDATE
        WHERE T1.USU_ID <> (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = '''||V_USUARIO||''')';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('  [INFO] '||SQL%ROWCOUNT||' Usuarios actualizados en TAC.');
    
    DBMS_OUTPUT.PUT_LINE('[FIN]');
    
    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
        DBMS_OUTPUT.PUT_LINE(SQLERRM);
        DBMS_OUTPUT.PUT_LINE(V_MSQL);
        ROLLBACK;
        RAISE;
END;
/
EXIT