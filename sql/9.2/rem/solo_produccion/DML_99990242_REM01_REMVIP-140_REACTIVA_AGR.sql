--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20180226
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.14
--## INCIDENCIA_LINK=REMVIP-140
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_ESQUEMA VARCHAR2(25 CHAR) := '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR) := '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-140';
    ERR_NUM NUMBER;-- Numero de errores
    ERR_MSG VARCHAR2(2048);-- Mensaje de error
    PL_OUTPUT VARCHAR2(32000 CHAR);

BEGIN
  
    DBMS_OUTPUT.PUT_LINE('[INICIO]');

    EXECUTE IMMEDIATE 'MERGE INTO '||V_ESQUEMA||'.ACT_AGR_AGRUPACION T1
        USING (SELECT DISTINCT AGR.AGR_ID
            FROM '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR
            JOIN '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGA.AGR_ID = AGR.AGR_ID AND AGA.BORRADO = 0
            JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AGA.ACT_ID AND ACT.BORRADO = 0
            JOIN '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION HEP ON HEP.ACT_ID = ACT.ACT_ID AND HEP.HEP_FECHA_HASTA IS NULL
            LEFT JOIN '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID AND PAC.BORRADO = 0
            WHERE AGR.AGR_NUM_AGRUP_UVEM = ''8313646'') T2
        ON (T1.AGR_ID = T2.AGR_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.AGR_ELIMINADO = 0, T1.FECHAMODIFICAR = SYSDATE
            , T1.USUARIOMODIFICAR = ''REMVIP-140''
        WHERE T1.AGR_ELIMINADO = 1';
    DBMS_OUTPUT.PUT_LINE('  [INFO] '||SQL%ROWCOUNT||' filas actualizadas en tabla ACT_AGR_AGRUPACION.');

    EXECUTE IMMEDIATE 'MERGE INTO '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO PAC
        USING (SELECT PAC.PAC_ID
            FROM '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR
            JOIN '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGA.AGR_ID = AGR.AGR_ID AND AGA.BORRADO = 0
            JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AGA.ACT_ID AND ACT.BORRADO = 0
            LEFT JOIN '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID AND PAC.BORRADO = 0
            WHERE AGR.AGR_NUM_AGRUP_UVEM = ''8313646'') T2
        ON (PAC.PAC_ID = T2.PAC_ID)
        WHEN MATCHED THEN UPDATE SET
            PAC.PAC_CHECK_COMERCIALIZAR = 1, PAC.PAC_FECHA_COMERCIALIZAR = SYSDATE, PAC.PAC_MOT_EXCL_COMERCIALIZAR = NULL
            , PAC.DD_MCO_ID = (SELECT DD_MCO_ID FROM '||V_ESQUEMA||'.DD_MCO_MOTIVO_COMERCIALIZACION WHERE DD_MCO_CODIGO = ''02'')
            , PAC.PAC_INCLUIDO = 1, PAC.FECHAMODIFICAR = SYSDATE, PAC.USUARIOMODIFICAR = ''REMVIP-140''';
    DBMS_OUTPUT.PUT_LINE('  [INFO] '||SQL%ROWCOUNT||' filas actualizadas en tabla ACT_PAC_PERIMETRO_ACTIVO.');

    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
    WHEN OTHERS THEN
		DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
		DBMS_OUTPUT.PUT_LINE(SQLERRM);
		ROLLBACK;
		RAISE;

END;
/
EXIT;