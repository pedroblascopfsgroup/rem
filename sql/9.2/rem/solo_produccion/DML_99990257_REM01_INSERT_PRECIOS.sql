--/*
--##########################################
--## AUTOR=SIMEON SHOPOV 
--## FECHA_CREACION=20180307
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-223
--## PRODUCTO=NO
--##
--## Finalidad: Insertar precios
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_SQL 					   VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA 				   VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M 			   VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA 				   VARCHAR2(25 CHAR):= 'ACT_VAL_VALORACIONES';
    V_TABLA_HIST 			   VARCHAR2(25 CHAR):= 'ACT_HVA_HIST_VALORACIONES';
    V_DD 					   VARCHAR2(25 CHAR):= 'DD_TPC_TIPO_PRECIO';
    V_COUNT 				   NUMBER(16); -- Vble. para contar.
    --V_KOUNT 				   NUMBER(16); -- Vble. para kontar.
    V_COUNT_INSERT 		   	   NUMBER(16):= 0; -- Vble. para contar inserts
    ERR_NUM 				   NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG 				   VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	V_USUARIO 				   VARCHAR2(32 CHAR):= 'REMVIP-223';
    
    ACT_NUM_ACTIVO 			   NUMBER(16);
    ACT_ID					   NUMBER(16);
    APROBADO_VENTA 			   NUMBER(16);
    MINIMO_AUTORIZADO 		   NUMBER(16);
    
    DESCUENTO_APROBADO 		   NUMBER(16);
    F_INI_DESCUENTO_APROBADO   DATE;
    F_FIN_DESCUENTO_APROBADO   DATE;
    
    DESCUENTO_PUBLICADO		   NUMBER(16);
    F_INI_DESCUENTO_PUBLICADO  DATE;
    F_FIN_DESCUENTO_PUBLICADO  DATE;
    
    ID_APROBADO_VENTA      	   NUMBER(16);
    ID_MINIMO_AUTORIZADO       NUMBER(16);
    ID_DESCUENTO_APROBADO      NUMBER(16);
    ID_DESCUENTO_PUBLICADO     NUMBER(16);
    
    TYPE T_JBV IS TABLE OF VARCHAR2(4000);
 	TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 

 	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
 		  T_JBV(6035067,154000,154000)
		, T_JBV(6031360,115000,115000)
		, T_JBV(6036711,112000,112000)
		, T_JBV(6031369,109000,109000)
		, T_JBV(6031368,108000,108000)
		, T_JBV(6035074,108000,108000)
		, T_JBV(6043057,106000,106000)
		, T_JBV(6031365,104000,104000)
		, T_JBV(6031366,104000,104000)
		, T_JBV(6043055,88000,88000)
		, T_JBV(6031370,88000,88000)
		, T_JBV(6035076,88000,88000)
		, T_JBV(6035063,6900,6900)
		, T_JBV(6031358,6900,6900)
		, T_JBV(6043044,6900,6900)
		, T_JBV(6035061,6900,6900)
		, T_JBV(6043047,6900,6900)
		, T_JBV(6031359,6900,6900)
		, T_JBV(6043048,6900,6900)
		, T_JBV(6031357,6900,6900)
		, T_JBV(6036706,6900,6900)
		, T_JBV(6043046,6900,6900)
		, T_JBV(6043051,6900,6900)
		, T_JBV(6036701,6900,6900)
		, T_JBV(6035082,142000,142000)
		, T_JBV(6031362,137000,137000)
		, T_JBV(6035078,137000,137000)
		, T_JBV(6031374,128000,128000)
		, T_JBV(6035068,127000,127000)
		, T_JBV(6031373,124000,124000)
		, T_JBV(6043058,124000,124000)
		, T_JBV(6035069,124000,124000)
		, T_JBV(6031376,121000,121000)
		, T_JBV(6036708,116000,116000)
		, T_JBV(6031367,115000,115000)
		, T_JBV(6036710,114000,114000)
		, T_JBV(6036709,114000,114000)
		, T_JBV(6043054,114000,114000)
		, T_JBV(6043053,112000,112000)
		, T_JBV(6035075,112000,112000)
		, T_JBV(6043059,112000,112000)
		, T_JBV(6031363,112000,112000)
		, T_JBV(6035077,109000,109000)
		, T_JBV(6035079,108000,108000)
		, T_JBV(6036713,107000,107000)
		, T_JBV(6031375,107000,107000)
		, T_JBV(6035081,107000,107000)
		, T_JBV(6035071,106000,106000)
		, T_JBV(6035073,103000,103000)
		, T_JBV(6035072,102000,102000)
		, T_JBV(6036712,102000,102000)
		, T_JBV(6031361,102000,102000)
		, T_JBV(6031372,101000,101000)
		, T_JBV(6043056,88000,88000)
		, T_JBV(6036707,88000,88000)
		, T_JBV(6035066,88000,88000)
		, T_JBV(6031371,88000,88000)
		, T_JBV(6035070,87400,87400)
		, T_JBV(6035080,78500,78500)
		, T_JBV(6031364,71500,71500)
		, T_JBV(6043034,14400,14400)
		, T_JBV(6035051,14000,14000)
		, T_JBV(6036696,12200,12200)
		, T_JBV(6035050,11900,11900)
		, T_JBV(6036695,11800,11800)
		, T_JBV(6036697,11800,11800)
		, T_JBV(6031348,11100,11100)
		, T_JBV(6035054,10800,10800)
		, T_JBV(6031349,10600,10600)
		, T_JBV(6036700,10400,10400)
		, T_JBV(6043035,10300,10300)
		, T_JBV(6035053,9700,9700)
		, T_JBV(6043037,9700,9700)
		, T_JBV(6035059,8200,8200)
		, T_JBV(6043042,7200,7200)
		, T_JBV(6043040,7200,7200)
		, T_JBV(6035058,7200,7200)
		, T_JBV(6031354,7200,7200)
		, T_JBV(6043043,7200,7200)
		, T_JBV(6035056,7200,7200)
		, T_JBV(6043039,7200,7200)
		, T_JBV(6043038,7200,7200)
		, T_JBV(6036703,7200,7200)
		, T_JBV(6031355,7200,7200)
		, T_JBV(6043041,7200,7200)
		, T_JBV(6035057,7200,7200)
		, T_JBV(6031356,7200,7200)
		, T_JBV(6036702,7100,7100)
		, T_JBV(6036698,7100,7100)
		, T_JBV(6036699,7100,7100)
		, T_JBV(6035052,7100,7100)
		, T_JBV(6031350,7100,7100)
		, T_JBV(6043036,7100,7100)
		, T_JBV(6035064,6900,6900)
		, T_JBV(6043045,6900,6900)
		, T_JBV(6036704,6900,6900)
		, T_JBV(6035060,6900,6900)
		, T_JBV(6043050,6900,6900)
		, T_JBV(6036705,6900,6900)
		, T_JBV(6035062,6900,6900)
		, T_JBV(6035055,6900,6900)
		, T_JBV(6043052,6900,6900)
		, T_JBV(6031351,6900,6900)
		, T_JBV(6043049,6900,6900)
		, T_JBV(6035065,6900,6900)
		, T_JBV(6031353,6900,6900)
		, T_JBV(6031352,6900,6900)
	 	);   
    V_TMP_JBV T_JBV;
    
    
    TYPE T_JBV2 IS TABLE OF VARCHAR2(4000);
 	TYPE T_ARRAY_JBV2 IS TABLE OF T_JBV2; 

 	V_JBV2 T_ARRAY_JBV2 := T_ARRAY_JBV2(
 		  T_JBV2(6035067,90200,'03/03/2018','31/05/2018',90200,'03/03/2018','31/05/2018')
		, T_JBV2(6031360,90200,'03/03/2018','31/05/2018',90200,'03/03/2018','31/05/2018')
		, T_JBV2(6036711,90200,'03/03/2018','31/05/2018',90200,'03/03/2018','31/05/2018')
		, T_JBV2(6031369,90200,'03/03/2018','31/05/2018',90200,'03/03/2018','31/05/2018')
		, T_JBV2(6031368,90200,'03/03/2018','31/05/2018',90200,'03/03/2018','31/05/2018')
		, T_JBV2(6035074,90200,'03/03/2018','31/05/2018',90200,'03/03/2018','31/05/2018')
		, T_JBV2(6043055,71500,'03/03/2018','31/05/2018',71500,'03/03/2018','31/05/2018')
		, T_JBV2(6031370,71500,'03/03/2018','31/05/2018',71500,'03/03/2018','31/05/2018')
		, T_JBV2(6035076,71500,'03/03/2018','31/05/2018',71500,'03/03/2018','31/05/2018')
		, T_JBV2(6043057,90200,'03/03/2018','31/05/2018',90200,'03/03/2018','31/05/2018')
		, T_JBV2(6031365,90200,'03/03/2018','31/05/2018',90200,'03/03/2018','31/05/2018')
		, T_JBV2(6031366,90200,'03/03/2018','31/05/2018',90200,'03/03/2018','31/05/2018')
		, T_JBV2(6035061,5500,'03/03/2018','31/05/2018',5500,'03/03/2018','31/05/2018')
		, T_JBV2(6043044,5500,'03/03/2018','31/05/2018',5500,'03/03/2018','31/05/2018')
		, T_JBV2(6031357,5500,'03/03/2018','31/05/2018',5500,'03/03/2018','31/05/2018')
		, T_JBV2(6043048,5500,'03/03/2018','31/05/2018',5500,'03/03/2018','31/05/2018')
		, T_JBV2(6043047,5500,'03/03/2018','31/05/2018',5500,'03/03/2018','31/05/2018')
		, T_JBV2(6036706,5500,'03/03/2018','31/05/2018',5500,'03/03/2018','31/05/2018')
		, T_JBV2(6031358,5500,'03/03/2018','31/05/2018',5500,'03/03/2018','31/05/2018')
		, T_JBV2(6035063,5500,'03/03/2018','31/05/2018',5500,'03/03/2018','31/05/2018')
		, T_JBV2(6031359,5500,'03/03/2018','31/05/2018',5500,'03/03/2018','31/05/2018')
		, T_JBV2(6043046,5500,'03/03/2018','31/05/2018',5500,'03/03/2018','31/05/2018')
		, T_JBV2(6036701,5500,'03/03/2018','31/05/2018',5500,'03/03/2018','31/05/2018')
		, T_JBV2(6043051,5500,'03/03/2018','31/05/2018',5500,'03/03/2018','31/05/2018')
	 	);   
    V_TMP_JBV2 T_JBV2;
    
    
 BEGIN
 
  	EXECUTE IMMEDIATE 'SELECT DD_TPC_ID FROM '||V_ESQUEMA||'.'||V_DD||' WHERE DD_TPC_CODIGO = ''02''' INTO ID_APROBADO_VENTA;
    EXECUTE IMMEDIATE 'SELECT DD_TPC_ID FROM '||V_ESQUEMA||'.'||V_DD||' WHERE DD_TPC_CODIGO = ''04''' INTO ID_MINIMO_AUTORIZADO;
    EXECUTE IMMEDIATE 'SELECT DD_TPC_ID FROM '||V_ESQUEMA||'.'||V_DD||' WHERE DD_TPC_CODIGO = ''07''' INTO ID_DESCUENTO_APROBADO;
    EXECUTE IMMEDIATE 'SELECT DD_TPC_ID FROM '||V_ESQUEMA||'.'||V_DD||' WHERE DD_TPC_CODIGO = ''13''' INTO ID_DESCUENTO_PUBLICADO;
 

 FOR I IN V_JBV.FIRST .. V_JBV.LAST
 LOOP
    V_TMP_JBV 		  := V_JBV(I);
    
    ACT_NUM_ACTIVO 	  := V_TMP_JBV(1);
    APROBADO_VENTA 	  := V_TMP_JBV(2);
    MINIMO_AUTORIZADO := V_TMP_JBV(3);
    
	EXECUTE IMMEDIATE 'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||'' INTO ACT_ID;
    
    EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA||'
					   WHERE ACT_ID = '||ACT_ID||'
					   AND DD_TPC_ID = '||ID_APROBADO_VENTA||''
					   INTO V_COUNT;
					   
	IF V_COUNT > 0 THEN
	
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_HIST||' (
				  ACT_ID
				, DD_TPC_ID
				, HVA_FECHA_APROBACION
				, HVA_FECHA_CARGA
				, HVA_FECHA_FIN
				, HVA_FECHA_INICIO
				, HVA_ID
				, HVA_IMPORTE
				, HVA_OBSERVACIONES
				, USUARIOCREAR
				, FECHACREAR
    			) VALUES (
    			  '||ACT_ID||'
    			, '||ID_APROBADO_VENTA||'
    			, (SELECT VAL_FECHA_APROBACION FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_APROBADO_VENTA||')
    			, (SELECT VAL_FECHA_CARGA FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_APROBADO_VENTA||')
    			, (SELECT VAL_FECHA_FIN FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_APROBADO_VENTA||')
    			, (SELECT VAL_FECHA_INICIO FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_APROBADO_VENTA||')
    			, S_ACT_HVA_HIST_VALORACIONES.NEXTVAL
    			, (SELECT VAL_IMPORTE FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_APROBADO_VENTA||')
    			, (SELECT VAL_OBSERVACIONES FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_APROBADO_VENTA||')
    			, '''||V_USUARIO||'''
    			, SYSDATE
    			)
 				';
 				
 		EXECUTE IMMEDIATE V_SQL;
 		
		DBMS_OUTPUT.PUT_LINE('[HISTÓRICO] Insertado en'||V_TABLA_HIST||' el precio aprobado venta del activo '||ACT_NUM_ACTIVO);
		

		V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET
	 			    FECHAMODIFICAR	 = SYSDATE
				  , USUARIOMODIFICAR = '''||V_USUARIO||'''
				  , VAL_FECHA_FIN	 = NULL
				  , VAL_FECHA_INICIO = SYSDATE
				  , VAL_FECHA_CARGA  = SYSDATE
				  , VAL_IMPORTE		 = '||APROBADO_VENTA||'
				  WHERE ACT_ID 		 = '||ACT_ID||'
				  AND DD_TPC_ID		 = '||ID_APROBADO_VENTA||'
	 			  ';
		EXECUTE IMMEDIATE V_SQL;
		
		DBMS_OUTPUT.PUT_LINE('[UPDATE] Actualizado en '||V_TABLA||' el precio aprobado de venta del activo '||ACT_NUM_ACTIVO);
		
		V_COUNT_INSERT := V_COUNT_INSERT + 1;
	ELSE
	
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (
					  VAL_ID
					, FECHACREAR
					, USUARIOCREAR
					, VAL_FECHA_FIN
					, VAL_FECHA_INICIO
					, VAL_FECHA_CARGA
					, VAL_IMPORTE
					, ACT_ID
					, DD_TPC_ID
					) VALUES (
					 S_'||V_TABLA||'.NEXTVAL
	 			    , SYSDATE
				    , '''||V_USUARIO||'''
				    , NULL
				    , SYSDATE
				    , SYSDATE
				    , '||APROBADO_VENTA||'
				    , '||ACT_ID||'
				    , '||ID_APROBADO_VENTA||'
				    )
	 			  ';
		EXECUTE IMMEDIATE V_SQL;
		
		DBMS_OUTPUT.PUT_LINE('[INSERT] Insertado en '||V_TABLA||' el precio aprobado de venta del activo '||ACT_NUM_ACTIVO);
	
	END IF;
	
	
	
	EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA||'
					   WHERE ACT_ID = '||ACT_ID||'
					   AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||''
					   INTO V_COUNT;
					   
	IF V_COUNT > 0 THEN
	
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_HIST||' (
				  ACT_ID
				, DD_TPC_ID
				, HVA_FECHA_APROBACION
				, HVA_FECHA_CARGA
				, HVA_FECHA_FIN
				, HVA_FECHA_INICIO
				, HVA_ID
				, HVA_IMPORTE
				, HVA_OBSERVACIONES
				, USUARIOCREAR
				, FECHACREAR
    			) VALUES (
    			  '||ACT_ID||'
    			, '||ID_MINIMO_AUTORIZADO||'
    			, (SELECT VAL_FECHA_APROBACION FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||')
    			, (SELECT VAL_FECHA_CARGA FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||')
    			, (SELECT VAL_FECHA_FIN FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||')
    			, (SELECT VAL_FECHA_INICIO FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||')
    			, S_ACT_HVA_HIST_VALORACIONES.NEXTVAL
    			, (SELECT VAL_IMPORTE FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||')
    			, (SELECT VAL_OBSERVACIONES FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||')
    			, '''||V_USUARIO||'''
    			, SYSDATE
    			)
 				';
 				
 		EXECUTE IMMEDIATE V_SQL;
 		
 		
		DBMS_OUTPUT.PUT_LINE('[HISTÓRICO] Insertado en'||V_TABLA_HIST||' el precio mínimo autorizado del activo '||ACT_NUM_ACTIVO);
		

		V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET
	 			    FECHAMODIFICAR	 = SYSDATE
				  , USUARIOMODIFICAR = '''||V_USUARIO||'''
				  , VAL_FECHA_FIN	 = NULL
				  , VAL_FECHA_INICIO = SYSDATE
				  , VAL_FECHA_CARGA  = SYSDATE
				  , VAL_IMPORTE		 = '||MINIMO_AUTORIZADO||'
				  WHERE ACT_ID 		 = '||ACT_ID||'
				  AND DD_TPC_ID		 = '||ID_MINIMO_AUTORIZADO||'
	 			  ';
	 			  
		EXECUTE IMMEDIATE V_SQL;
		
		V_COUNT_INSERT := V_COUNT_INSERT + 1;
		
		DBMS_OUTPUT.PUT_LINE('[UPDATE] Actualizado en '||V_TABLA||' el precio mínimo autorizado del activo '||ACT_NUM_ACTIVO);
		
	ELSE
	
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (
					  VAL_ID
					, FECHACREAR
					, USUARIOCREAR
					, VAL_FECHA_FIN
					, VAL_FECHA_INICIO
					, VAL_FECHA_CARGA¡
					, VAL_IMPORTE
					, ACT_ID
					, DD_TPC_ID
					) VALUES (
					 S_'||V_TABLA||'.NEXTVAL
	 			    , SYSDATE
				    , '''||V_USUARIO||'''
				    , NULL
				    , SYSDATE
				    , SYSDATE
				    , '||MINIMO_AUTORIZADO||'
				    , '||ACT_ID||'
				    , '||ID_MINIMO_AUTORIZADO||'
				    )
	 			  ';
		EXECUTE IMMEDIATE V_SQL;
		
		DBMS_OUTPUT.PUT_LINE('[INSERT] Insertado en '||V_TABLA||' el precio mínimo autorizado del activo '||ACT_NUM_ACTIVO);
	
	END IF;

  END LOOP;  
  
  
  FOR I IN V_JBV2.FIRST .. V_JBV2.LAST
	  LOOP
		V_TMP_JBV2 		  		   := V_JBV2(I);
	
		ACT_NUM_ACTIVO 	  		   := V_TMP_JBV2(1);
	
		DESCUENTO_APROBADO 		   := V_TMP_JBV2(2);
		EXECUTE IMMEDIATE 'SELECT TO_DATE('''||V_TMP_JBV2(3)||''', ''DD/MM/YYYY'') FROM DUAL' INTO F_INI_DESCUENTO_APROBADO;
		EXECUTE IMMEDIATE 'SELECT TO_DATE('''||V_TMP_JBV2(4)||''', ''DD/MM/YYYY'') FROM DUAL' INTO F_FIN_DESCUENTO_APROBADO;
	
		DESCUENTO_PUBLICADO		   := V_TMP_JBV2(5);
		EXECUTE IMMEDIATE 'SELECT TO_DATE('''||V_TMP_JBV2(6)||''', ''DD/MM/YYYY'') FROM DUAL' INTO F_INI_DESCUENTO_PUBLICADO;
		EXECUTE IMMEDIATE 'SELECT TO_DATE('''||V_TMP_JBV2(7)||''', ''DD/MM/YYYY'') FROM DUAL' INTO F_FIN_DESCUENTO_PUBLICADO;
	   
	    EXECUTE IMMEDIATE 'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||'' INTO ACT_ID;
    
    	EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA||'
					   WHERE ACT_ID = '||ACT_ID||'
					   AND DD_TPC_ID = '||ID_DESCUENTO_APROBADO||''
					   INTO V_COUNT;
					   
	IF V_COUNT > 0 THEN
	
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_HIST||' (
				  ACT_ID
				, DD_TPC_ID
				, HVA_FECHA_APROBACION
				, HVA_FECHA_CARGA
				, HVA_FECHA_FIN
				, HVA_FECHA_INICIO
				, HVA_ID
				, HVA_IMPORTE
				, HVA_OBSERVACIONES
				, USUARIOCREAR
				, FECHACREAR
    			) VALUES (
    			  '||ACT_ID||'
    			, '||ID_DESCUENTO_APROBADO||'
    			, (SELECT VAL_FECHA_APROBACION FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_DESCUENTO_APROBADO||')
    			, (SELECT VAL_FECHA_CARGA FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_DESCUENTO_APROBADO||')
    			, (SELECT VAL_FECHA_FIN FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_DESCUENTO_APROBADO||')
    			, (SELECT VAL_FECHA_INICIO FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_DESCUENTO_APROBADO||')
    			, S_ACT_HVA_HIST_VALORACIONES.NEXTVAL
    			, (SELECT VAL_IMPORTE FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_DESCUENTO_APROBADO||')
    			, (SELECT VAL_OBSERVACIONES FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_DESCUENTO_APROBADO||')
    			, '''||V_USUARIO||'''
    			, SYSDATE
    			)
 				';
 				
 		EXECUTE IMMEDIATE V_SQL;
 		
		DBMS_OUTPUT.PUT_LINE('[HISTÓRICO] Insertado en '||V_TABLA_HIST||' el precio de descuento aprobado del activo '||ACT_NUM_ACTIVO);
		

		V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET
	 			    FECHAMODIFICAR	 = SYSDATE
				  , USUARIOMODIFICAR = '''||V_USUARIO||'''
				  , VAL_FECHA_FIN	 = '''||F_FIN_DESCUENTO_APROBADO||'''
				  , VAL_FECHA_INICIO = '''||F_INI_DESCUENTO_APROBADO||'''
				  , VAL_FECHA_CARGA  = SYSDATE
				  , VAL_IMPORTE		 = '||DESCUENTO_APROBADO||'
				  WHERE ACT_ID 		 = '||ACT_ID||'
				  AND DD_TPC_ID		 = '||ID_DESCUENTO_APROBADO||'
	 			  ';

		EXECUTE IMMEDIATE V_SQL;
		
 		V_COUNT_INSERT := V_COUNT_INSERT + 1;
		
		DBMS_OUTPUT.PUT_LINE('[UPDATE] Actualizado en '||V_TABLA||' el precio aprobado de venta del activo '||ACT_NUM_ACTIVO);
	
	ELSE
	
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (
					  VAL_ID
					, FECHACREAR
					, USUARIOCREAR
					, VAL_FECHA_FIN
					, VAL_FECHA_INICIO
					, VAL_FECHA_CARGA
					, VAL_IMPORTE
					, ACT_ID
					, DD_TPC_ID
					) VALUES (
					 S_'||V_TABLA||'.NEXTVAL
	 			    , SYSDATE
				    , '''||V_USUARIO||'''
				    , '''||F_FIN_DESCUENTO_APROBADO||'''
				    , '''||F_INI_DESCUENTO_APROBADO||'''
				    , SYSDATE
				    , '||DESCUENTO_APROBADO||'
				    , '||ACT_ID||'
				    , '||ID_DESCUENTO_APROBADO||'
				    )
	 			  ';

		EXECUTE IMMEDIATE V_SQL;
		
		DBMS_OUTPUT.PUT_LINE('[INSERT] Insertado en '||V_TABLA||' el precio aprobado de venta del activo '||ACT_NUM_ACTIVO);
	
	END IF;
	
	
	
	EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA||'
					   WHERE ACT_ID = '||ACT_ID||'
					   AND DD_TPC_ID = '||ID_DESCUENTO_PUBLICADO||''
					   INTO V_COUNT;
					   
	IF V_COUNT > 0 THEN
	
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_HIST||' (
				  ACT_ID
				, DD_TPC_ID
				, HVA_FECHA_APROBACION
				, HVA_FECHA_CARGA
				, HVA_FECHA_FIN
				, HVA_FECHA_INICIO
				, HVA_ID
				, HVA_IMPORTE
				, HVA_OBSERVACIONES
				, USUARIOCREAR
				, FECHACREAR
    			) VALUES (
    			  '||ACT_ID||'
    			, '||ID_DESCUENTO_PUBLICADO||'
    			, (SELECT VAL_FECHA_APROBACION FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_DESCUENTO_PUBLICADO||')
    			, (SELECT VAL_FECHA_CARGA FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_DESCUENTO_PUBLICADO||')
    			, (SELECT VAL_FECHA_FIN FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_DESCUENTO_PUBLICADO||')
    			, (SELECT VAL_FECHA_INICIO FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_DESCUENTO_PUBLICADO||')
    			, S_ACT_HVA_HIST_VALORACIONES.NEXTVAL
    			, (SELECT VAL_IMPORTE FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_DESCUENTO_PUBLICADO||')
    			, (SELECT VAL_OBSERVACIONES FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_DESCUENTO_PUBLICADO||')
    			, '''||V_USUARIO||'''
    			, SYSDATE
    			)
 				';
 				
 		EXECUTE IMMEDIATE V_SQL;
 		
		DBMS_OUTPUT.PUT_LINE('[HISTÓRICO] Insertado en'||V_TABLA_HIST||' el precio de descuento aprobado del activo '||ACT_NUM_ACTIVO);
		

		V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET
	 			    FECHAMODIFICAR	 = SYSDATE
				  , USUARIOMODIFICAR = '''||V_USUARIO||'''
				  , VAL_FECHA_FIN	 = '''||F_FIN_DESCUENTO_PUBLICADO||'''
				  , VAL_FECHA_INICIO = '''||F_INI_DESCUENTO_PUBLICADO||'''
				  , VAL_FECHA_CARGA  = SYSDATE
				  , VAL_IMPORTE		 = '||DESCUENTO_PUBLICADO||'
				  WHERE ACT_ID 		 = '||ACT_ID||'
				  AND DD_TPC_ID		 = '||ID_DESCUENTO_PUBLICADO||'
	 			  ';
	 			  
		EXECUTE IMMEDIATE V_SQL;
		
		V_COUNT_INSERT := V_COUNT_INSERT + 1;
		
		DBMS_OUTPUT.PUT_LINE('[UPDATE] Actualizado en '||V_TABLA||' el precio aprobado de venta del activo '||ACT_NUM_ACTIVO);
	
	ELSE
	
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (
					  VAL_ID
					, FECHACREAR
					, USUARIOCREAR
					, VAL_FECHA_FIN
					, VAL_FECHA_INICIO
					, VAL_FECHA_CARGA
					, VAL_IMPORTE
					, ACT_ID
					, DD_TPC_ID
					) VALUES (
					 S_'||V_TABLA||'.NEXTVAL
	 			    , SYSDATE
				    , '''||V_USUARIO||'''
				    , '''||F_FIN_DESCUENTO_PUBLICADO||'''
				    , '''||F_INI_DESCUENTO_PUBLICADO||'''
				    , SYSDATE
				    , '||DESCUENTO_PUBLICADO||'
				    , '||ACT_ID||'
				    , '||ID_DESCUENTO_PUBLICADO||'
				    )
	 			  ';
		EXECUTE IMMEDIATE V_SQL;
		
		DBMS_OUTPUT.PUT_LINE('[INSERT] Insertado en '||V_TABLA||' el precio aprobado de venta del activo '||ACT_NUM_ACTIVO);
	
	END IF;
	
    END LOOP;
  
  DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado '||V_COUNT_INSERT||' precios'); 
  
 COMMIT;
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------'); 
          DBMS_OUTPUT.PUT_LINE(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
