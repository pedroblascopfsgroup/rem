--/*
--##########################################
--## AUTOR=Vicente Martinez 
--## FECHA_CREACION=20180307
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-224
--## PRODUCTO=NO
--##
--## Finalidad: Insertar precios
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versi√≥n inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_SQL 					   VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA 				   VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M 			   VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA 				   VARCHAR2(25 CHAR):= 'ACT_VAL_VALORACIONES';
    V_TABLA_HIST 			   VARCHAR2(25 CHAR):= 'ACT_HVA_HIST_VALORACIONES';
    V_DD 					   VARCHAR2(25 CHAR):= 'DD_TPC_TIPO_PRECIO';
    V_COUNT 				   NUMBER(16); -- Vble. para contar.
    V_COUNT_INSERT 		   	   NUMBER(16):= 0; -- Vble. para contar inserts
    ERR_NUM 				   NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG 				   VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	V_USUARIO 				   VARCHAR2(32 CHAR):= 'REMVIP-224';
    
    ACT_NUM_ACTIVO 			   NUMBER(16);
    ACT_ID					   NUMBER(16);
    APROBADO_VENTA 			   NUMBER(16);
    MINIMO_AUTORIZADO 		   NUMBER(16);
    
    DESCUENTO_APROBADO 		   NUMBER(16);
    F_INI_DESCUENTO_APROBADO   DATE;
    F_FIN_DESCUENTO_APROBADO   DATE;
    
    DESCUENTO_PUBLICADO		   NUMBER(16);
    F_INI_DESCUENTO_PUBLICADO  DATE;
    F_FIN_DESCUENTO_PUBLICADO  DATE;
    
    ID_APROBADO_VENTA      	   NUMBER(16);
    ID_MINIMO_AUTORIZADO       NUMBER(16);
    ID_DESCUENTO_APROBADO      NUMBER(16);
    ID_DESCUENTO_PUBLICADO     NUMBER(16);
    
    TYPE T_JBV IS TABLE OF VARCHAR2(4000);
 	TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 

 	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
 		T_JBV(202855,6000,6000),
		T_JBV(202912,6000,6000),
		T_JBV(202913,3900,3900),
		T_JBV(202856,3900,3900),
		T_JBV(202857,56300,56300),
		T_JBV(203667,6000,6000),
		T_JBV(203668,6000,6000),
		T_JBV(202859,6000,6000),
		T_JBV(203669,3900,3900),
		T_JBV(202860,3900,3900),
		T_JBV(202861,64700,64700),
		T_JBV(203670,55000,55000),
		T_JBV(203671,64700,64700),
		T_JBV(202862,56300,56300),
		T_JBV(202519,56300,56300),
		T_JBV(115402,101400,101400),
		T_JBV(118287,110300,110300),
		T_JBV(105936,75300,75240),
		T_JBV(105731,49400,49305),
		T_JBV(115527,103200,103200),
		T_JBV(115401,103000,103000),
		T_JBV(115828,94400,94400),
		T_JBV(105837,103000,103000),
		T_JBV(118070,66200,66120),
		T_JBV(115526,103400,103400),
		T_JBV(118286,102600,102600),
		T_JBV(118071,106000,106000),
		T_JBV(105732,105000,105000),
		T_JBV(118545,39600,39520),
		T_JBV(115400,64900,64885),
		T_JBV(115528,103000,103000),
		T_JBV(115613,106000,106000),
		T_JBV(115829,56800,56715),
		T_JBV(118285,41400,41325),
		T_JBV(6130464,64300,64300),
		T_JBV(6130460,78400,78400),
		T_JBV(6130462,73200,73150),
		T_JBV(6130447,64900,64885),
		T_JBV(6130443,87800,87800),
		T_JBV(6130470,89700,89700),
		T_JBV(6130457,78700,78700),
		T_JBV(6130442,67900,67830),
		T_JBV(6130448,83700,83700),
		T_JBV(6130466,78700,78700),
		T_JBV(6343936,8300,8300),
		T_JBV(6343937,9900,9900),
		T_JBV(6343930,6800,6800),
		T_JBV(6343914,3200,3200),
		T_JBV(6343915,7700,7700),
		T_JBV(6343916,7900,7900),
		T_JBV(6343939,8500,8500),
		T_JBV(6343917,7700,7700),
		T_JBV(6343940,8100,8100),
		T_JBV(6343924,12000,12000),
		T_JBV(6343931,7200,7200),
		T_JBV(6343932,7400,7400),
		T_JBV(6343918,7500,7500),
		T_JBV(6343919,6600,6600),
		T_JBV(6343928,7000,7000),
		T_JBV(6343929,8400,8400),
		T_JBV(6343920,8400,8400),
		T_JBV(6343921,7000,7000),
		T_JBV(6343922,6500,6500),
		T_JBV(6343925,7400,7400),
		T_JBV(6343923,7400,7400),
		T_JBV(6343941,8000,8000),
		T_JBV(6343942,10000,10000),
		T_JBV(6343943,7600,7600),
		T_JBV(6343926,7200,7200),
		T_JBV(6343927,7600,7600),
		T_JBV(6343933,8700,8700),
		T_JBV(6343934,8500,8500),
		T_JBV(6343935,7300,7300),
		T_JBV(6343944,8500,8500),
		T_JBV(155459,4800,4800),
		T_JBV(143329,68800,68800),
		T_JBV(136428,5400,5400),
		T_JBV(176212,59100,59100),
		T_JBV(136603,6000,6000),
		T_JBV(136604,4200,4200),
		T_JBV(136427,5300,5300),
		T_JBV(155899,4200,4200),
		T_JBV(153068,57900,57900),
		T_JBV(143332,5100,5100),
		T_JBV(152909,65500,65500),
		T_JBV(200900,77000,77000),
		T_JBV(142642,3900,3900),
		T_JBV(155499,60300,60300),
		T_JBV(143331,65400,65400),
		T_JBV(153069,4500,4500),
		T_JBV(155500,5700,5700),
		T_JBV(153181,57300,57300),
		T_JBV(147610,58500,58500),
		T_JBV(71740,56400,56400),
		T_JBV(5877489,64800,64800),
		T_JBV(199965,51000,51000),
		T_JBV(183437,68700,68700),
		T_JBV(184050,72400,72400),
		T_JBV(71827,80100,80100),
		T_JBV(72454,90000,90000),
		T_JBV(162682,93900,93900),
		T_JBV(72455,81600,81600),
		T_JBV(72456,96200,96200),
		T_JBV(162502,99000,99000),
		T_JBV(183438,86800,86800),
		T_JBV(176289,92200,92200),
		T_JBV(133077,47000,47000),
		T_JBV(133669,49000,49000),
		T_JBV(183313,50000,50000),
		T_JBV(186604,46000,46000),
		T_JBV(186756,49000,49000),
		T_JBV(182544,45000,45000),
		T_JBV(186605,49000,49000),
		T_JBV(186477,49000,49000),
		T_JBV(183266,49000,49000),
		T_JBV(182695,55000,55000),
		T_JBV(186540,44000,44000),
		T_JBV(183267,54000,54000),
		T_JBV(186757,37000,37000),
		T_JBV(183240,44000,44000),
		T_JBV(6785720,1500,1500),
		T_JBV(6785721,69100,69100),
		T_JBV(204582,129400,129400),
		T_JBV(203974,12800,12800),
		T_JBV(202811,12700,12700),
		T_JBV(203615,12800,12800),
		T_JBV(943483,2900,2900),
		T_JBV(204575,3900,3900),
		T_JBV(204471,131600,131600),
		T_JBV(203276,13600,13600),
		T_JBV(934503,3900,3900),
		T_JBV(204470,187300,187300),
		T_JBV(203980,12800,12800),
		T_JBV(943112,2900,2900),
		T_JBV(204576,2900,2900),
		T_JBV(939740,175800,175800),
		T_JBV(938249,134200,134200),
		T_JBV(202802,5900,5900),
		T_JBV(933776,14700,14700),
		T_JBV(939565,129800,129800),
		T_JBV(203551,12800,12800),
		T_JBV(204554,2900,2900),
		T_JBV(204571,2900,2900),
		T_JBV(204572,3900,3900),
		T_JBV(204592,126400,126400),
		T_JBV(935235,13800,13800),
		T_JBV(204332,2700,2700),
		T_JBV(938523,2900,2900),
		T_JBV(937987,12800,12800),
		T_JBV(935817,2900,2900),
		T_JBV(934547,4900,4900),
		T_JBV(204569,138300,138300),
		T_JBV(940546,165700,165700),
		T_JBV(203978,12800,12800),
		T_JBV(938453,147500,147500),
		T_JBV(203976,12800,12800),
		T_JBV(202813,12700,12700),
		T_JBV(940592,2900,2900),
		T_JBV(204339,2900,2900),
		T_JBV(933941,167100,167100),
		T_JBV(935870,196000,196000),
		T_JBV(938476,12800,12800),
		T_JBV(945119,12800,12800),
		T_JBV(202812,13600,13600),
		T_JBV(203981,12700,12700),
		T_JBV(203277,13600,13600),
		T_JBV(204557,2900,2900),
		T_JBV(204340,3900,3900),
		T_JBV(938800,136200,136200),
		T_JBV(944448,135400,135400),
		T_JBV(203975,11700,11700),
		T_JBV(204574,2900,2900),
		T_JBV(942336,147400,147400),
		T_JBV(203275,13600,13600),
		T_JBV(203279,12700,12700),
		T_JBV(204555,2900,2900),
		T_JBV(937004,159500,159500),
		T_JBV(942075,147400,147400),
		T_JBV(202814,12800,12800),
		T_JBV(204556,2900,2900),
		T_JBV(935105,4400,4400),
		T_JBV(204560,3900,3900),
		T_JBV(944278,12800,12800),
		T_JBV(944444,12800,12800),
		T_JBV(939303,14700,14700),
		T_JBV(204333,3900,3900),
		T_JBV(204336,2900,2900),
		T_JBV(202801,2900,2900),
		T_JBV(938797,12700,12700),
		T_JBV(203553,13800,13800),
		T_JBV(940694,134700,134700),
		T_JBV(940211,126500,126500),
		T_JBV(91294,90000,89965),
		T_JBV(92484,3900,3895),
		T_JBV(91295,103200,103170),
		T_JBV(182661,64000,64000),
		T_JBV(181992,53600,53600),
		T_JBV(186319,66300,66300),
		T_JBV(183065,51800,51800),
		T_JBV(202897,65000,65000),
		T_JBV(202132,40000,40000),
		T_JBV(202131,65000,65000),
		T_JBV(202896,65000,65000),
		T_JBV(202505,65000,65000),
		T_JBV(202506,65000,65000),
		T_JBV(168810,110500,110500),
		T_JBV(166250,104000,104000),
		T_JBV(168419,112500,112500),
		T_JBV(168809,140500,140500),
		T_JBV(166189,140500,140500),
		T_JBV(166360,138000,138000),
		T_JBV(165154,118000,118000),
		T_JBV(165153,129700,129700),
		T_JBV(168420,143500,143500),
		T_JBV(177034,118800,118800),
		T_JBV(164670,116000,116000),
		T_JBV(168671,146500,146500),
		T_JBV(169064,127000,127000),
		T_JBV(168418,136000,136000),
		T_JBV(176683,114000,114000),
		T_JBV(6758679,1800,1800),
		T_JBV(6758678,1800,1800),
		T_JBV(6758682,1800,1800),
		T_JBV(6758681,1800,1800),
		T_JBV(6758680,1800,1800),
		T_JBV(6758684,1800,1800),
		T_JBV(6758685,1800,1800),
		T_JBV(150341,89400,89400),
		T_JBV(160490,101300,101300),
		T_JBV(138706,90000,90000),
		T_JBV(142796,91900,91900),
		T_JBV(150792,90000,90000),
		T_JBV(138705,93100,93100),
		T_JBV(143391,89400,89400),
		T_JBV(138841,90000,90000),
		T_JBV(142896,90000,90000),
		T_JBV(150791,89400,89400),
		T_JBV(157772,87100,87100),
		T_JBV(134671,107400,107400),
		T_JBV(134921,104700,104700),
		T_JBV(147384,79700,79700),
		T_JBV(147570,100100,100100),
		T_JBV(157628,103900,103900),
		T_JBV(134441,81300,81300),
		T_JBV(134669,94100,94100),
		T_JBV(147323,113700,113700),
		T_JBV(140101,106400,106400),
		T_JBV(140626,72600,72600),
		T_JBV(140627,96000,96000),
		T_JBV(135176,78500,78500),
		T_JBV(147322,69100,69100),
		T_JBV(117767,98700,98700),
		T_JBV(99019,8900,8900),
		T_JBV(117703,92400,92400),
		T_JBV(117524,34500,34500),
		T_JBV(99221,7500,7500),
		T_JBV(117525,85400,85400),
		T_JBV(114374,71300,71300),
		T_JBV(117766,7300,7300),
		T_JBV(114006,47300,47300),
		T_JBV(203629,99600,99600),
		T_JBV(204124,71600,71600),
		T_JBV(204342,119900,119900),
		T_JBV(203630,107800,107800),
		T_JBV(203371,121000,121000),
		T_JBV(203288,101500,101500),
		T_JBV(204344,72200,72200),
		T_JBV(204134,114700,114700),
		T_JBV(204063,124200,124200),
		T_JBV(203372,120100,120100),
		T_JBV(204129,14300,14300),
		T_JBV(203625,15500,15500),
		T_JBV(204128,15500,15500),
		T_JBV(202826,17100,17100),
		T_JBV(203624,18200,18200),
		T_JBV(202827,15500,15500),
		T_JBV(204130,18200,18200),
		T_JBV(202824,18200,18200),
		T_JBV(204125,18200,18200),
		T_JBV(204131,18200,18200),
		T_JBV(91291,6000,5985),
		T_JBV(84706,3900,3895),
		T_JBV(92485,83500,83410),
		T_JBV(92714,99500,99465),
		T_JBV(91293,80300,80275),
		T_JBV(92840,70200,70200),
		T_JBV(84156,78800,78755),
		T_JBV(84157,86100,86070),
		T_JBV(92838,3900,3895),
		T_JBV(90829,4400,4370),
		T_JBV(92693,4600,4560),
		T_JBV(91292,4000,3990),
		T_JBV(92863,6600,6555),
		T_JBV(92712,4900,4845),
		T_JBV(92713,6400,6365),
		T_JBV(90830,88900,88825),
		T_JBV(92839,5900,5890),
		T_JBV(92396,80100,80085),
		T_JBV(92483,6400,6365),
		T_JBV(84137,70500,70470),
		T_JBV(84707,87200,87115),
		T_JBV(6355296,8800,8800),
		T_JBV(6355298,8600,8600),
		T_JBV(6355301,8600,8600),
		T_JBV(6355304,8600,8600),
		T_JBV(6355305,8600,8600),
		T_JBV(6355308,8600,8600),
		T_JBV(6355309,8600,8600),
		T_JBV(6355315,8600,8600),
		T_JBV(6355317,8600,8600),
		T_JBV(6355318,8600,8600),
		T_JBV(6355321,8600,8600),
		T_JBV(6355322,8600,8600),
		T_JBV(6355323,8600,8600),
		T_JBV(6355325,8600,8600),
		T_JBV(6355326,8600,8600),
		T_JBV(6355327,8600,8600),
		T_JBV(6355332,8600,8600),
		T_JBV(6355335,8600,8600),
		T_JBV(6355336,8600,8600),
		T_JBV(6351794,151300,151300),
		T_JBV(6355338,8600,8600),
		T_JBV(6355340,8600,8600),
		T_JBV(6355299,141600,141600),
		T_JBV(6355300,223300,223300),
		T_JBV(6355344,8600,8600),
		T_JBV(6355302,160800,160800),
		T_JBV(6355303,195200,195200),
		T_JBV(6355345,8600,8600),
		T_JBV(6355348,8600,8600),
		T_JBV(6355306,199100,199100),
		T_JBV(6355307,243200,243200),
		T_JBV(6355350,8600,8600),
		T_JBV(6355352,8600,8600),
		T_JBV(6355310,153700,153700),
		T_JBV(6355313,164000,164000),
		T_JBV(6355354,8600,8600),
		T_JBV(6355316,260000,260000),
		T_JBV(6355356,8600,8600),
		T_JBV(6355358,8600,8600),
		T_JBV(6355319,237400,237400),
		T_JBV(6355320,161000,161000),
		T_JBV(6355360,8600,8600),
		T_JBV(6355363,8600,8600),
		T_JBV(6520532,8600,8600),
		T_JBV(6355328,166700,166700),
		T_JBV(6355329,175100,175100),
		T_JBV(6355330,157800,157800),
		T_JBV(6355331,178300,178300),
		T_JBV(6355334,178300,178300),
		T_JBV(6355337,173600,173600),
		T_JBV(6355339,171800,171800),
		T_JBV(6355341,158100,158100),
		T_JBV(6355342,179100,179100),
		T_JBV(6355343,180100,180100),
		T_JBV(6355346,175800,175800),
		T_JBV(6355347,154300,154300),
		T_JBV(6355349,161400,161400),
		T_JBV(6355351,167200,167200),
		T_JBV(144848,10400,10395),
		T_JBV(162340,10400,10395),
		T_JBV(144712,128800,128730),
		T_JBV(140319,10400,10395),
		T_JBV(162124,168000,168000),
		T_JBV(139978,10400,10395),
		T_JBV(140320,10400,10395),
		T_JBV(139979,179500,179500),
		T_JBV(152377,175500,175500),
		T_JBV(162341,168800,168800),
		T_JBV(152490,10000,10000),
		T_JBV(162339,10000,10000),
		T_JBV(65325,170900,170900),
		T_JBV(155747,4700,4700),
		T_JBV(143333,4800,4800),
		T_JBV(136820,56700,56700),
		T_JBV(201955,56000,56000),
		T_JBV(202044,61000,61000),
		T_JBV(201954,63000,63000),
		T_JBV(202045,99000,99000),
		T_JBV(202047,61000,61000),
		T_JBV(202046,61000,61000),
		T_JBV(147359,72000,72000),
		T_JBV(159804,89800,89800),
		T_JBV(135524,81100,81100),
		T_JBV(159685,80300,80300),
		T_JBV(135243,76800,76800),
		T_JBV(135523,75200,75200)
	 	);   
    V_TMP_JBV T_JBV;
    
    
 BEGIN
 
  	EXECUTE IMMEDIATE 'SELECT DD_TPC_ID FROM '||V_ESQUEMA||'.'||V_DD||' WHERE DD_TPC_CODIGO = ''02''' INTO ID_APROBADO_VENTA;
    EXECUTE IMMEDIATE 'SELECT DD_TPC_ID FROM '||V_ESQUEMA||'.'||V_DD||' WHERE DD_TPC_CODIGO = ''04''' INTO ID_MINIMO_AUTORIZADO;
 

 FOR I IN V_JBV.FIRST .. V_JBV.LAST
 LOOP
    V_TMP_JBV 		  := V_JBV(I);
    
    ACT_NUM_ACTIVO 	  := V_TMP_JBV(1);
    APROBADO_VENTA 	  := V_TMP_JBV(2);
    MINIMO_AUTORIZADO := V_TMP_JBV(3);
    
	EXECUTE IMMEDIATE 'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||'' INTO ACT_ID;
    
    EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA||'
					   WHERE ACT_ID = '||ACT_ID||'
					   AND DD_TPC_ID = '||ID_APROBADO_VENTA||''
					   INTO V_COUNT;
					   
	IF V_COUNT > 0 THEN
	
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_HIST||' (
				  ACT_ID
				, DD_TPC_ID
				, HVA_FECHA_APROBACION
				, HVA_FECHA_CARGA
				, HVA_FECHA_FIN
				, HVA_FECHA_INICIO
				, HVA_ID
				, HVA_IMPORTE
				, HVA_OBSERVACIONES
				, USUARIOCREAR
				, FECHACREAR
    			) VALUES (
    			  '||ACT_ID||'
    			, '||ID_APROBADO_VENTA||'
    			, (SELECT VAL_FECHA_APROBACION FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_APROBADO_VENTA||' AND BORRADO = 0)
    			, (SELECT VAL_FECHA_CARGA FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_APROBADO_VENTA||' AND BORRADO = 0)
    			, (SELECT VAL_FECHA_FIN FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_APROBADO_VENTA||' AND BORRADO = 0)
    			, (SELECT VAL_FECHA_INICIO FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_APROBADO_VENTA||' AND BORRADO = 0)
    			, S_ACT_HVA_HIST_VALORACIONES.NEXTVAL
    			, (SELECT VAL_IMPORTE FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_APROBADO_VENTA||' AND BORRADO = 0)
    			, (SELECT VAL_OBSERVACIONES FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_APROBADO_VENTA||' AND BORRADO = 0)
    			, '''||V_USUARIO||'''
    			, SYSDATE
    			)
 				';
 				DBMS_OUTPUT.PUT_LINE(V_SQL);
 		EXECUTE IMMEDIATE V_SQL;
 		
		DBMS_OUTPUT.PUT_LINE('[HIST√ìRICO] Insertado en '||V_TABLA_HIST||' el precio aprobado venta del activo '||ACT_NUM_ACTIVO);
		

		V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET
	 			    FECHAMODIFICAR	 = SYSDATE
				  , USUARIOMODIFICAR = '''||V_USUARIO||'''
				  , VAL_FECHA_FIN	 = NULL
				  , VAL_FECHA_INICIO = SYSDATE
				  , VAL_FECHA_CARGA  = SYSDATE
				  , VAL_IMPORTE		 = '||APROBADO_VENTA||'
				  WHERE ACT_ID 		 = '||ACT_ID||'
				  AND DD_TPC_ID		 = '||ID_APROBADO_VENTA||'
	 			  ';DBMS_OUTPUT.PUT_LINE(V_SQL);
		EXECUTE IMMEDIATE V_SQL;
		
		DBMS_OUTPUT.PUT_LINE('[UPDATE] Actualizado en '||V_TABLA||' el precio aprobado de venta del activo '||ACT_NUM_ACTIVO);
		
		V_COUNT_INSERT := V_COUNT_INSERT + 1;
	ELSE
	
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (
					  VAL_ID
					, FECHACREAR
					, USUARIOCREAR
					, VAL_FECHA_FIN
					, VAL_FECHA_INICIO
					, VAL_FECHA_CARGA
					, VAL_IMPORTE
					, ACT_ID
					, DD_TPC_ID
					) VALUES (
					 S_'||V_TABLA||'.NEXTVAL
	 			    , SYSDATE
				    , '''||V_USUARIO||'''
				    , NULL
				    , SYSDATE
				    , SYSDATE
				    , '||APROBADO_VENTA||'
				    , '||ACT_ID||'
				    , '||ID_APROBADO_VENTA||'
				    )
	 			  ';DBMS_OUTPUT.PUT_LINE(V_SQL);
		EXECUTE IMMEDIATE V_SQL;
		
		DBMS_OUTPUT.PUT_LINE('[INSERT] Insertado en '||V_TABLA||' el precio aprobado de venta del activo '||ACT_NUM_ACTIVO);
	
	END IF;
	
	
	
	EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA||'
					   WHERE ACT_ID = '||ACT_ID||'
					   AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||''
					   INTO V_COUNT;
					   
	IF V_COUNT > 0 THEN
	
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_HIST||' (
				  ACT_ID
				, DD_TPC_ID
				, HVA_FECHA_APROBACION
				, HVA_FECHA_CARGA
				, HVA_FECHA_FIN
				, HVA_FECHA_INICIO
				, HVA_ID
				, HVA_IMPORTE
				, HVA_OBSERVACIONES
				, USUARIOCREAR
				, FECHACREAR
    			) VALUES (
    			  '||ACT_ID||'
    			, '||ID_MINIMO_AUTORIZADO||'
    			, (SELECT VAL_FECHA_APROBACION FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||' AND BORRADO = 0)
    			, (SELECT VAL_FECHA_CARGA FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||' AND BORRADO = 0)
    			, (SELECT VAL_FECHA_FIN FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||' AND BORRADO = 0)
    			, (SELECT VAL_FECHA_INICIO FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||' AND BORRADO = 0)
    			, S_ACT_HVA_HIST_VALORACIONES.NEXTVAL
    			, (SELECT VAL_IMPORTE FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||' AND BORRADO = 0)
    			, (SELECT VAL_OBSERVACIONES FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = '||ACT_ID||' AND DD_TPC_ID = '||ID_MINIMO_AUTORIZADO||' AND BORRADO = 0)
    			, '''||V_USUARIO||'''
    			, SYSDATE
    			)
 				';DBMS_OUTPUT.PUT_LINE(V_SQL);
 				
 		EXECUTE IMMEDIATE V_SQL;
 		
 		
		DBMS_OUTPUT.PUT_LINE('[HIST√ìRICO] Insertado en'||V_TABLA_HIST||' el precio m√≠nimo autorizado del activo '||ACT_NUM_ACTIVO);
		

		V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET
	 			    FECHAMODIFICAR	 = SYSDATE
				  , USUARIOMODIFICAR = '''||V_USUARIO||'''
				  , VAL_FECHA_FIN	 = NULL
				  , VAL_FECHA_INICIO = SYSDATE
				  , VAL_FECHA_CARGA  = SYSDATE
				  , VAL_IMPORTE		 = '||MINIMO_AUTORIZADO||'
				  WHERE ACT_ID 		 = '||ACT_ID||'
				  AND DD_TPC_ID		 = '||ID_MINIMO_AUTORIZADO||'
	 			  ';
	 			  DBMS_OUTPUT.PUT_LINE(V_SQL);
		EXECUTE IMMEDIATE V_SQL;
		
		V_COUNT_INSERT := V_COUNT_INSERT + 1;
		
		DBMS_OUTPUT.PUT_LINE('[UPDATE] Actualizado en '||V_TABLA||' el precio m√≠nimo autorizado del activo '||ACT_NUM_ACTIVO);
		
	ELSE
	
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (
					  VAL_ID
					, FECHACREAR
					, USUARIOCREAR
					, VAL_FECHA_FIN
					, VAL_FECHA_INICIO
					, VAL_FECHA_CARGA¬°
					, VAL_IMPORTE
					, ACT_ID
					, DD_TPC_ID
					) VALUES (
					 S_'||V_TABLA||'.NEXTVAL
	 			    , SYSDATE
				    , '''||V_USUARIO||'''
				    , NULL
				    , SYSDATE
				    , SYSDATE
				    , '||MINIMO_AUTORIZADO||'
				    , '||ACT_ID||'
				    , '||ID_MINIMO_AUTORIZADO||'
				    )
	 			  ';DBMS_OUTPUT.PUT_LINE(V_SQL);
		EXECUTE IMMEDIATE V_SQL;
		
		DBMS_OUTPUT.PUT_LINE('[INSERT] Insertado en '||V_TABLA||' el precio m√≠nimo autorizado del activo '||ACT_NUM_ACTIVO);
	
	END IF;

  END LOOP;  
  
  DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado '||V_COUNT_INSERT||' precios'); 
  
 COMMIT;
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecuci√≥n:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------'); 
          DBMS_OUTPUT.PUT_LINE(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
