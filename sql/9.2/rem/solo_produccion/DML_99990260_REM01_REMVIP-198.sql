--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20180312
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.15
--## INCIDENCIA_LINK=REMVIP-198
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_MSQL VARCHAR2(4000 CHAR);
	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-198';

BEGIN

    DBMS_OUTPUT.PUT_LINE('[INICIO] Cañonazo gastos');
    
	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GGE_GASTOS_GESTION T1
		USING (
		    SELECT GPV.GPV_ID
		    FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV
		    JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
		    JOIN '||V_ESQUEMA||'.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
		    JOIN '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO EGA ON EGA.DD_EGA_ID = GPV.DD_EGA_ID
		    LEFT JOIN '||V_ESQUEMA||'.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH ON EAH.DD_EAH_ID = GGE.DD_EAH_ID
		    LEFT JOIN '||V_ESQUEMA||'.DD_EAP_ESTADOS_AUTORIZ_PROP EAP ON EAP.DD_EAP_ID = GGE.DD_EAP_ID
		    WHERE GDE.GDE_FECHA_PAGO IS NOT NULL AND EGA.DD_EGA_CODIGO = ''05'' AND (GDE.GDE_PAGADO_CONEXION_BANKIA = 1 
		        OR GDE.GDE_ANTICIPO = 1 OR GDE.GDE_INCLUIR_PAGO_PROVISION = 1) AND NVL(EAP.DD_EAP_CODIGO,''01'') = ''01''
		    ) T2
		ON (T1.GPV_ID = T2.GPV_ID)
		WHEN MATCHED THEN UPDATE SET
		    T1.DD_EAH_ID = (SELECT DD_EAH_ID FROM '||V_ESQUEMA||'.DD_EAH_ESTADOS_AUTORIZ_HAYA WHERE DD_EAH_CODIGO = ''01'')
		    , T1.GGE_FECHA_ENVIO_PRPTRIO = NULL, T1.GGE_FECHA_EAH = NULL
		    , T1.DD_EAP_ID = NULL, T1.GGE_FECHA_EAP = NULL
		    , T1.USUARIOMODIFICAR = '''||V_USUARIO||''', T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('	[INFO] '||SQL%ROWCOUNT||' gastos gestión actualizados');   

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR T1
		USING (
		    SELECT GPV.GPV_ID, CASE WHEN GPV.GPV_EXISTE_DOCUMENTO = 1 THEN ''01'' ELSE ''12'' END DD_EGA_CODIGO
		    FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV
		    JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
		    JOIN '||V_ESQUEMA||'.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
		    JOIN '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO EGA ON EGA.DD_EGA_ID = GPV.DD_EGA_ID
		    LEFT JOIN '||V_ESQUEMA||'.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH ON EAH.DD_EAH_ID = GGE.DD_EAH_ID
		    LEFT JOIN '||V_ESQUEMA||'.DD_EAP_ESTADOS_AUTORIZ_PROP EAP ON EAP.DD_EAP_ID = GGE.DD_EAP_ID
		    WHERE GDE.GDE_FECHA_PAGO IS NOT NULL AND EGA.DD_EGA_CODIGO = ''05'' AND (GDE.GDE_PAGADO_CONEXION_BANKIA = 1 
		        OR GDE.GDE_ANTICIPO = 1 OR GDE.GDE_INCLUIR_PAGO_PROVISION = 1) AND NVL(EAP.DD_EAP_CODIGO,''01'') = ''01''
		    ) T2
		ON (T1.GPV_ID = T2.GPV_ID)
		WHEN MATCHED THEN UPDATE SET
		    T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = T2.DD_EGA_CODIGO)
		    , T1.USUARIOMODIFICAR = '''||V_USUARIO||''', T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('	[INFO] '||SQL%ROWCOUNT||' gastos proveedor actualizados');  
        
	COMMIT;
    
    DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      DBMS_OUTPUT.PUT_LINE(V_MSQL);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
