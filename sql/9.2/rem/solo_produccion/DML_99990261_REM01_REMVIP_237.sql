--/*
--##########################################
--## AUTOR=VICENTE MARTINEZ 
--## FECHA_CREACION=20180312
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-237
--## PRODUCTO=NO
--##
--## Finalidad: Avanzar trámite
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    --V_TABLA VARCHAR2(25 CHAR):= 'ACT_SPS_SIT_POSESORIA';
    --V_COUNT NUMBER(16); -- Vble. para contar.
    --V_COUNT_INSERT NUMBER(16):= 0; -- Vble. para contar inserts
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    PL_OUTPUT VARCHAR2(32000 CHAR);
	--V_USUARIO VARCHAR2(32 CHAR):= 'REMVIP-172';
    
    --ACT_NUM_ACTIVO NUMBER(16);
    
 BEGIN


	#ESQUEMA#.REPOSICIONAMIENTO_TRAMITE('REMVIP-237','SELECT ECO.ECO_NUM_EXPEDIENTE FROM REM01.ACT_ACTIVO ACT JOIN REM01.ACT_OFR AOF ON ACT.ACT_ID = AOF.ACT_ID JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO ON AOF.OFR_ID = ECO.OFR_ID JOIN REM01.DD_EEC_EST_EXP_COMERCIAL EEC ON ECO.DD_EEC_ID = EEC.DD_EEC_ID JOIN REM01.RES_RESERVAS RES ON ECO.ECO_ID = RES.ECO_ID JOIN REM01.DD_ERE_ESTADOS_RESERVA ERE ON RES.DD_ERE_ID = ERE.DD_ERE_ID JOIN REM01.TAC_TAREAS_ACTIVOS TAC ON ACT.ACT_ID = TAC.ACT_ID  WHERE ACT.ACT_NUM_ACTIVO IN (6831362,6831325,6831400,6831324,6831392,6831369,6831402,6831393,6831327,6831349,6831408,6831416,6831339,6831356,6831359,6831391,6831338,6831330,6831387,6831382,6831357,6831313,6831401,6831378,6831334,6831367,6831368,6831395,6831315,6831354,6831410,6831352,6831385,6831420,6831413,6831419,6831377,6831353,6831363,6831361,6831328,6831373,6831407,6831347,6831405,6831388,6831414,6831415,6831346,6831417,6831398,6831390,6831345,6831411,6831394,6831404,6831351,6831340,6831358,6831343,6831409,6831348,6831365,6831372,6831344,6831360,6831376,6831380,6831383,6831399,6831355,6831337,6831326,6831412,6831332,6831406,6831403,6831366,6831381,6831336,6831341,6831350,6831386) AND EEC.DD_EEC_CODIGO <> ''02''' ,'T013_DefinicionOferta','SELECT ECO.ECO_NUM_EXPEDIENTE FROM REM01.ACT_ACTIVO ACT JOIN REM01.ACT_OFR AOF ON ACT.ACT_ID = AOF.ACT_ID JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO ON AOF.OFR_ID = ECO.OFR_ID JOIN REM01.DD_EEC_EST_EXP_COMERCIAL EEC ON ECO.DD_EEC_ID = EEC.DD_EEC_ID JOIN REM01.RES_RESERVAS RES ON ECO.ECO_ID = RES.ECO_ID JOIN REM01.DD_ERE_ESTADOS_RESERVA ERE ON RES.DD_ERE_ID = ERE.DD_ERE_ID JOIN REM01.TAC_TAREAS_ACTIVOS TAC ON ACT.ACT_ID = TAC.ACT_ID  WHERE ACT.ACT_NUM_ACTIVO IN (6831362,6831325,6831400,6831324,6831392,6831369,6831402,6831393,6831327,6831349,6831408,6831416,6831339,6831356,6831359,6831391,6831338,6831330,6831387,6831382,6831357,6831313,6831401,6831378,6831334,6831367,6831368,6831395,6831315,6831354,6831410,6831352,6831385,6831420,6831413,6831419,6831377,6831353,6831363,6831361,6831328,6831373,6831407,6831347,6831405,6831388,6831414,6831415,6831346,6831417,6831398,6831390,6831345,6831411,6831394,6831404,6831351,6831340,6831358,6831343,6831409,6831348,6831365,6831372,6831344,6831360,6831376,6831380,6831383,6831399,6831355,6831337,6831326,6831412,6831332,6831406,6831403,6831366,6831381,6831336,6831341,6831350,6831386) AND EEC.DD_EEC_CODIGO <> ''02''','01',PL_OUTPUT);
    DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);

  #ESQUEMA#.REPOSICIONAMIENTO_TRAMITE('REMVIP-237','SELECT ECO.ECO_NUM_EXPEDIENTE FROM REM01.ACT_ACTIVO ACT JOIN REM01.ACT_OFR AOF ON ACT.ACT_ID = AOF.ACT_ID JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO ON AOF.OFR_ID = ECO.OFR_ID JOIN REM01.DD_EEC_EST_EXP_COMERCIAL EEC ON ECO.DD_EEC_ID = EEC.DD_EEC_ID JOIN REM01.RES_RESERVAS RES ON ECO.ECO_ID = RES.ECO_ID JOIN REM01.DD_ERE_ESTADOS_RESERVA ERE ON RES.DD_ERE_ID = ERE.DD_ERE_ID JOIN REM01.TAC_TAREAS_ACTIVOS TAC ON ACT.ACT_ID = TAC.ACT_ID  WHERE ACT.ACT_NUM_ACTIVO IN (6831362,6831325,6831400,6831324,6831392,6831369,6831402,6831393,6831327,6831349,6831408,6831416,6831339,6831356,6831359,6831391,6831338,6831330,6831387,6831382,6831357,6831313,6831401,6831378,6831334,6831367,6831368,6831395,6831315,6831354,6831410,6831352,6831385,6831420,6831413,6831419,6831377,6831353,6831363,6831361,6831328,6831373,6831407,6831347,6831405,6831388,6831414,6831415,6831346,6831417,6831398,6831390,6831345,6831411,6831394,6831404,6831351,6831340,6831358,6831343,6831409,6831348,6831365,6831372,6831344,6831360,6831376,6831380,6831383,6831399,6831355,6831337,6831326,6831412,6831332,6831406,6831403,6831366,6831381,6831336,6831341,6831350,6831386) AND ERE.DD_ERE_CODIGO IN (''01'',''02'',''05'') AND EEC.DD_EEC_CODIGO = ''02''','T013_DefinicionOferta','SELECT ECO.ECO_NUM_EXPEDIENTE FROM REM01.ACT_ACTIVO ACT JOIN REM01.ACT_OFR AOF ON ACT.ACT_ID = AOF.ACT_ID JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO ON AOF.OFR_ID = ECO.OFR_ID JOIN REM01.DD_EEC_EST_EXP_COMERCIAL EEC ON ECO.DD_EEC_ID = EEC.DD_EEC_ID JOIN REM01.RES_RESERVAS RES ON ECO.ECO_ID = RES.ECO_ID JOIN REM01.DD_ERE_ESTADOS_RESERVA ERE ON RES.DD_ERE_ID = ERE.DD_ERE_ID JOIN REM01.TAC_TAREAS_ACTIVOS TAC ON ACT.ACT_ID = TAC.ACT_ID  WHERE ACT.ACT_NUM_ACTIVO IN (6831362,6831325,6831400,6831324,6831392,6831369,6831402,6831393,6831327,6831349,6831408,6831416,6831339,6831356,6831359,6831391,6831338,6831330,6831387,6831382,6831357,6831313,6831401,6831378,6831334,6831367,6831368,6831395,6831315,6831354,6831410,6831352,6831385,6831420,6831413,6831419,6831377,6831353,6831363,6831361,6831328,6831373,6831407,6831347,6831405,6831388,6831414,6831415,6831346,6831417,6831398,6831390,6831345,6831411,6831394,6831404,6831351,6831340,6831358,6831343,6831409,6831348,6831365,6831372,6831344,6831360,6831376,6831380,6831383,6831399,6831355,6831337,6831326,6831412,6831332,6831406,6831403,6831366,6831381,6831336,6831341,6831350,6831386) AND ERE.DD_ERE_CODIGO IN (''01'',''02'',''05'') AND EEC.DD_EEC_CODIGO = ''02''','01',PL_OUTPUT);
    DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);

    V_SQL := 'DELETE FROM '||V_ESQUEMA||'.RES_RESERVAS
        WHERE RES_ID IN (SELECT RES.RES_ID
        FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
        JOIN '||V_ESQUEMA||'.ACT_OFR AOF ON ACT.ACT_ID = AOF.ACT_ID
        JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON AOF.OFR_ID = ECO.OFR_ID
        JOIN '||V_ESQUEMA||'.DD_EEC_EST_EXP_COMERCIAL EEC ON ECO.DD_EEC_ID = EEC.DD_EEC_ID
        JOIN '||V_ESQUEMA||'.RES_RESERVAS RES ON ECO.ECO_ID = RES.ECO_ID
        JOIN '||V_ESQUEMA||'.DD_ERE_ESTADOS_RESERVA ERE ON RES.DD_ERE_ID = ERE.DD_ERE_ID
        JOIN '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC ON ACT.ACT_ID = TAC.ACT_ID AND TAC.USUARIOCREAR = ''REMVIP-237'')
    ';

    EXECUTE IMMEDIATE V_SQL;

    DBMS_OUTPUT.PUT_LINE(SQL%ROWCOUNT||' reservas borradas');
  
 COMMIT;
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------'); 
          DBMS_OUTPUT.PUT_LINE(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
