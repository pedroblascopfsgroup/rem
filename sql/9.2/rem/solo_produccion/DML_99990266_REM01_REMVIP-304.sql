--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20180315
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.16
--## INCIDENCIA_LINK=REMVIP-304
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_MSQL VARCHAR2(4000 CHAR);
	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-304';
	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
	TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
	V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
					--AGRUPACION,ACTIVO   ,PLANTA	,TIPO_HABITACULO,CANTIDAD 
		T_TIPO_DATA('1000001016','6528496','0'		,'01'			,'3'		),
		T_TIPO_DATA('1000001016','6528496','0'		,'02'			,'2'		),
		T_TIPO_DATA('1000001016','6528489','1'		,'01'			,'3'		),
		T_TIPO_DATA('1000001016','6528489','1'		,'02'			,'2'		));
	V_TMP_TIPO_DATA T_TIPO_DATA;
	V_HABITACULO VARCHAR2(50 CHAR);

BEGIN

    DBMS_OUTPUT.PUT_LINE('[INICIO]');

	DBMS_OUTPUT.PUT_LINE('	[INFO] Actualizamos o insertamos tipo y cantidad de habitáculos en tabla de distribución');
    
    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
    	LOOP
	    	V_TMP_TIPO_DATA := V_TIPO_DATA(I);
			        
			V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION T1
				USING (SELECT DIS.DIS_ID, TPH.DD_TPH_ID, DIS.DIS_CANTIDAD, ICO.ICO_ID, ROW_NUMBER() OVER(PARTITION BY ACT.ACT_ID ORDER BY TPH.DD_TPH_ID NULLS LAST, DIS.DIS_ID NULLS LAST) RN
					FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
					JOIN '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGA.ACT_ID = ACT.ACT_ID
					JOIN '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_ID = AGA.AGR_ID
					JOIN '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL ICO ON ICO.ACT_ID = ACT.ACT_ID
					LEFT JOIN '||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION DIS ON DIS.ICO_ID = ICO.ICO_ID AND DIS.DIS_NUM_PLANTA = '||V_TMP_TIPO_DATA(3)||'
					LEFT JOIN '||V_ESQUEMA||'.DD_TPH_TIPO_HABITACULO TPH ON TPH.DD_TPH_ID = DIS.DD_TPH_ID AND TPH.DD_TPH_CODIGO = '''||V_TMP_TIPO_DATA(4)||''' 
					WHERE AGR.AGR_NUM_AGRUP_REM = '||V_TMP_TIPO_DATA(1)||' AND ACT.ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(2)||') T2
				ON (T1.DIS_ID = T2.DIS_ID AND T1.DD_TPH_ID = T2.DD_TPH_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.DIS_CANTIDAD = '||V_TMP_TIPO_DATA(5)||', T1.USUARIOMODIFICAR = '''||V_USUARIO||''', T1.FECHAMODIFICAR = SYSDATE
				WHERE T1.DIS_CANTIDAD <> '||V_TMP_TIPO_DATA(5)||' AND T2.RN = 1
				WHEN NOT MATCHED THEN INSERT (DIS_ID, DIS_NUM_PLANTA, ICO_ID, DIS_CANTIDAD
					, DD_TPH_ID
					, USUARIOCREAR, FECHACREAR, DIS_SUPERFICIE)
				VALUES ('||V_ESQUEMA||'.S_ACT_DIS_DISTRIBUCION.NEXTVAL, '||V_TMP_TIPO_DATA(3)||', T2.ICO_ID, '||V_TMP_TIPO_DATA(5)||'
					, (SELECT DD_TPH_ID FROM '||V_ESQUEMA||'.DD_TPH_TIPO_HABITACULO WHERE DD_TPH_CODIGO = '''||V_TMP_TIPO_DATA(4)||''')
					, '''||V_USUARIO||''', SYSDATE, 0)
				WHERE T2.RN = 1';
			EXECUTE IMMEDIATE V_MSQL;
			IF SQL%ROWCOUNT = 1 THEN
				EXECUTE IMMEDIATE 'SELECT DD_TPH_DESCRIPCION FROM '||V_ESQUEMA||'.DD_TPH_TIPO_HABITACULO WHERE DD_TPH_CODIGO = '''||V_TMP_TIPO_DATA(4)||'''' INTO V_HABITACULO;
				DBMS_OUTPUT.PUT_LINE('	[INFO] El número de '||V_HABITACULO||' de la planta '||V_TMP_TIPO_DATA(3)||' del activo '||V_TMP_TIPO_DATA(2)||' ha sido actualizado a '||V_TMP_TIPO_DATA(5)||'.');
			END IF;
    
        END LOOP;
        
	COMMIT;
    
    DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      DBMS_OUTPUT.PUT_LINE(V_MSQL);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
