--/*
--##########################################
--## AUTOR=Pablo Meseguer
--## FECHA_CREACION=20180316
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.16
--## INCIDENCIA_LINK=REMVIP-300
--## PRODUCTO=NO
--## Finalidad: Cambio de gestor comercial
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_M#'; -- Configuracion Esquema Master
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.  
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

    V_TEXT1 VARCHAR2(2400 CHAR); -- Vble. auxiliar  
    
BEGIN
	 DBMS_OUTPUT.PUT_LINE('[INICIO] Comienza el proceso de actualizacion de gestores comerciales...');
	 
    DBMS_OUTPUT.PUT_LINE('[INFO] Actualizacion de registros de TAC_TAREAS_ACTIVOS...');
    
    V_SQL := 'MERGE INTO REM01.TAC_TAREAS_ACTIVOS T1
				USING (
					  SELECT TAC.TAR_ID, USU.USU_ID AS USU_DESTINO , ACT.ACT_NUM_ACTIVO
					  FROM REM01.ACT_ACTIVO ACT
					  INNER JOIN REM01.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
					  INNER JOIN REM01.ACT_OFR ACT_OFR ON ACT_OFR.ACT_ID = ACT.ACT_ID
					  INNER JOIN REM01.OFR_OFERTAS OFR ON OFR.OFR_ID = ACT_OFR.OFR_ID
					  INNER JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
					  INNER JOIN REM01.ACT_TRA_TRAMITE TRA ON TRA.TBJ_ID = ECO.TBJ_ID
					  INNER JOIN REM01.TAC_TAREAS_ACTIVOS TAC ON tac.tra_id = tra.tra_id
					  INNER JOIN REM01.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
					  INNER JOIN REMMASTER.USU_USUARIOS USU ON USU.USU_USERNAME = ''dtacero''
					  WHERE CRA.DD_CRA_CODIGO = ''10''
					  AND TAR.TAR_FECHA_FIN IS NULL 
					  AND ACT.ACT_NUM_ACTIVO IN (
					  6946761,6946762,6946763,6946764,6946765,6946766,6946767,6946768,6946769,6946770,6946771,6946772,6946773,6946774,
					  6946775,6946776,6946777,6946778,6946779,6946780,6946781,6946782,6946783,6946784,6946785,6946786,6946787,6946788,
					  6946789,6946790,6946791,6946792,6946793,6946794,6946795,6946796,6946797,6946798,6946799,6946800,6946801,6946802,
					  6946803,6946804,6946805,6946806,6946807,6946808,6946809,6946810,6946811,6946812,6946813,6946814,6946815,6946816,
					  6946817,6946818,6946819,6946820,6946821,6946822,6946823,6946824,6946825,6946826,6946827,6946828,6946829,6946830,
					  6946831,6946832,6946833,6946834,6946835,6946836,6946837,6946838,6946839,6946840,6946841,6946842,6946843,6946844,
					  6946845,6946846,6946847,6946848,6946849,6946850,6946851,6946852,6946853,6946854,6946855,6946856,6946857,6946858,
					  6946859,6946860,6946861,6946862,6946863,6946864,6946865,6946866,6946867,6946868,6946869,6946870,6946871,6946872,
					  6946873,6946874,6946875,6946876,6946877,6946878,6946879,6946880,6946881,6946882,6946883,6946884,6946885,6946886,
					  6946887,6946888,6946889,6946890,6946891,6946892,6946893,6946894,6946895,6946896,6946897,6946898,6946899,6946900,
					  6946901,6946902,6946903,6946904,6946905,6946906,6946907,6946908,6946909,6946910,6946911,6946912,6946913,6946914,
					  6946915,6946916,6946917,6946918,6946919,6946920,6946921,6946922,6946923,6946924,6946925,6946926,6946927,6946928,
					  6946929,6946930,6946931,6946932,6946933,6946934,6946935,6946936,6946937,6946938,6946939,6946940,6946941,6946942,
					  6946943,6946944,6946945,6946946,6946947,6946948,6946949,6946950,6946951,6946952,6946953,6946954,6946955,6946956,
					  6946957,6946958,6946959,6946960,6946961,6946962,6946963,6946964,6946965,6946966,6946967,6946968,6946969,6946970,
					  6946971,6946972,6946973,6946974,6946975,6946976,6946977,6946978,6946979,6946980,6946981,6946982,6946983,6946984,
					  6946985,6946986,6946987,6946988,6946989,6946990,6946991,6946992,6946993,6946994,6946995,6946996,6946997,6946998,
					  6946999,6947000,6947001,6947002,6947003,6947004,6947005,6947006)
					  ) T2
				ON (T1.TAR_ID = T2.TAR_ID)
				WHEN MATCHED THEN UPDATE SET
				T1.USUARIOMODIFICAR = ''REMVIP-300'',
				T1.FECHAMODIFICAR = SYSDATE,
				T1.USU_ID = T2.USU_DESTINO';
    EXECUTE IMMEDIATE V_SQL;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS... Se han actualizado correctamente '||SQL%ROWCOUNT||' registros');     
    
    
    
    DBMS_OUTPUT.PUT_LINE('[INFO] Actualizacion de registros de GEE_GESTOR_ENTIDAD...');
    
    V_SQL := 'MERGE INTO REM01.GEE_GESTOR_ENTIDAD T1
				USING (
					  SELECT DISTINCT GEE.GEE_ID, USU2.USU_ID AS USU_DESTINO
					  FROM REM01.ACT_ACTIVO ACT
					  INNER JOIN REM01.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID      
					  INNER JOIN REM01.GAC_GESTOR_ADD_ACTIVO GAC ON GAC.ACT_ID = ACT.ACT_ID      
					  INNER JOIN REM01.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID
					  INNER JOIN REMMASTER.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
					  INNER JOIN REMMASTER.USU_USUARIOS USU ON USU.USU_ID = GEE.USU_ID
					  INNER JOIN REMMASTER.USU_USUARIOS USU2 ON USU2.USU_USERNAME = ''dtacero''
					  WHERE USU.USU_USERNAME <> ''dtacero''
					  AND TGE.DD_TGE_CODIGO = ''GCOM''
					  AND CRA.DD_CRA_CODIGO = ''10''
					  AND ACT.ACT_NUM_ACTIVO IN (
					  6946761,6946762,6946763,6946764,6946765,6946766,6946767,6946768,6946769,6946770,6946771,6946772,6946773,6946774,
					  6946775,6946776,6946777,6946778,6946779,6946780,6946781,6946782,6946783,6946784,6946785,6946786,6946787,6946788,
					  6946789,6946790,6946791,6946792,6946793,6946794,6946795,6946796,6946797,6946798,6946799,6946800,6946801,6946802,
					  6946803,6946804,6946805,6946806,6946807,6946808,6946809,6946810,6946811,6946812,6946813,6946814,6946815,6946816,
					  6946817,6946818,6946819,6946820,6946821,6946822,6946823,6946824,6946825,6946826,6946827,6946828,6946829,6946830,
					  6946831,6946832,6946833,6946834,6946835,6946836,6946837,6946838,6946839,6946840,6946841,6946842,6946843,6946844,
					  6946845,6946846,6946847,6946848,6946849,6946850,6946851,6946852,6946853,6946854,6946855,6946856,6946857,6946858,
					  6946859,6946860,6946861,6946862,6946863,6946864,6946865,6946866,6946867,6946868,6946869,6946870,6946871,6946872,
					  6946873,6946874,6946875,6946876,6946877,6946878,6946879,6946880,6946881,6946882,6946883,6946884,6946885,6946886,
					  6946887,6946888,6946889,6946890,6946891,6946892,6946893,6946894,6946895,6946896,6946897,6946898,6946899,6946900,
					  6946901,6946902,6946903,6946904,6946905,6946906,6946907,6946908,6946909,6946910,6946911,6946912,6946913,6946914,
					  6946915,6946916,6946917,6946918,6946919,6946920,6946921,6946922,6946923,6946924,6946925,6946926,6946927,6946928,
					  6946929,6946930,6946931,6946932,6946933,6946934,6946935,6946936,6946937,6946938,6946939,6946940,6946941,6946942,
					  6946943,6946944,6946945,6946946,6946947,6946948,6946949,6946950,6946951,6946952,6946953,6946954,6946955,6946956,
					  6946957,6946958,6946959,6946960,6946961,6946962,6946963,6946964,6946965,6946966,6946967,6946968,6946969,6946970,
					  6946971,6946972,6946973,6946974,6946975,6946976,6946977,6946978,6946979,6946980,6946981,6946982,6946983,6946984,
					  6946985,6946986,6946987,6946988,6946989,6946990,6946991,6946992,6946993,6946994,6946995,6946996,6946997,6946998,
					  6946999,6947000,6947001,6947002,6947003,6947004,6947005,6947006)
					  ) T2
				ON (T1.GEE_ID = T2.GEE_ID)
				WHEN MATCHED THEN UPDATE SET
				T1.USUARIOMODIFICAR = ''REMVIP-300'',
				T1.FECHAMODIFICAR = SYSDATE,
				T1.USU_ID = T2.USU_DESTINO';
    EXECUTE IMMEDIATE V_SQL;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD... Se han actualizado correctamente '||SQL%ROWCOUNT||' registros');  
    
    
    DBMS_OUTPUT.PUT_LINE('[INFO] Actualizacion de registros de GEH_GESTOR_ENTIDAD_HIST...');
    
    V_SQL := 'MERGE INTO REM01.GEH_GESTOR_ENTIDAD_HIST T1
				USING (
					  SELECT DISTINCT GEH.GEH_ID, USU2.USU_ID AS USU_DESTINO
					  FROM REM01.ACT_ACTIVO ACT
					  INNER JOIN REM01.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID  
					  INNER JOIN REMMASTER.USU_USUARIOS USU2 ON USU2.USU_USERNAME = ''dtacero''
					  INNER JOIN REM01.GAH_GESTOR_ACTIVO_HISTORICO GAH ON GAH.ACT_ID = ACT.ACT_ID
					  INNER JOIN REM01.GEH_GESTOR_ENTIDAD_HIST GEH ON GEH.GEH_ID = GAH.GEH_ID
					  INNER JOIN REMMASTER.DD_TGE_TIPO_GESTOR TGE2 ON TGE2.DD_TGE_ID = GEH.DD_TGE_ID
					  INNER JOIN REMMASTER.USU_USUARIOS USU ON USU.USU_ID = GEH.USU_ID
					  WHERE USU.USU_USERNAME <> ''dtacero''
					  AND geh.geh_fecha_hasta IS NULL
					  AND tge2.dd_tge_codigo = ''GCOM''
					  AND CRA.DD_CRA_CODIGO = ''10''
					  AND ACT.ACT_NUM_ACTIVO IN (
					  6946761,6946762,6946763,6946764,6946765,6946766,6946767,6946768,6946769,6946770,6946771,6946772,6946773,6946774,
					  6946775,6946776,6946777,6946778,6946779,6946780,6946781,6946782,6946783,6946784,6946785,6946786,6946787,6946788,
					  6946789,6946790,6946791,6946792,6946793,6946794,6946795,6946796,6946797,6946798,6946799,6946800,6946801,6946802,
					  6946803,6946804,6946805,6946806,6946807,6946808,6946809,6946810,6946811,6946812,6946813,6946814,6946815,6946816,
					  6946817,6946818,6946819,6946820,6946821,6946822,6946823,6946824,6946825,6946826,6946827,6946828,6946829,6946830,
					  6946831,6946832,6946833,6946834,6946835,6946836,6946837,6946838,6946839,6946840,6946841,6946842,6946843,6946844,
					  6946845,6946846,6946847,6946848,6946849,6946850,6946851,6946852,6946853,6946854,6946855,6946856,6946857,6946858,
					  6946859,6946860,6946861,6946862,6946863,6946864,6946865,6946866,6946867,6946868,6946869,6946870,6946871,6946872,
					  6946873,6946874,6946875,6946876,6946877,6946878,6946879,6946880,6946881,6946882,6946883,6946884,6946885,6946886,
					  6946887,6946888,6946889,6946890,6946891,6946892,6946893,6946894,6946895,6946896,6946897,6946898,6946899,6946900,
					  6946901,6946902,6946903,6946904,6946905,6946906,6946907,6946908,6946909,6946910,6946911,6946912,6946913,6946914,
					  6946915,6946916,6946917,6946918,6946919,6946920,6946921,6946922,6946923,6946924,6946925,6946926,6946927,6946928,
					  6946929,6946930,6946931,6946932,6946933,6946934,6946935,6946936,6946937,6946938,6946939,6946940,6946941,6946942,
					  6946943,6946944,6946945,6946946,6946947,6946948,6946949,6946950,6946951,6946952,6946953,6946954,6946955,6946956,
					  6946957,6946958,6946959,6946960,6946961,6946962,6946963,6946964,6946965,6946966,6946967,6946968,6946969,6946970,
					  6946971,6946972,6946973,6946974,6946975,6946976,6946977,6946978,6946979,6946980,6946981,6946982,6946983,6946984,
					  6946985,6946986,6946987,6946988,6946989,6946990,6946991,6946992,6946993,6946994,6946995,6946996,6946997,6946998,
					  6946999,6947000,6947001,6947002,6947003,6947004,6947005,6947006)
					  ) T2
				ON (T1.GEH_ID = T2.GEH_ID)
				WHEN MATCHED THEN UPDATE SET
				T1.USUARIOMODIFICAR = ''REMVIP-300'',
				T1.FECHAMODIFICAR = SYSDATE,
				T1.geh_fecha_hasta = SYSDATE';
    EXECUTE IMMEDIATE V_SQL;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST... Se han actualizado correctamente '||SQL%ROWCOUNT||' registros'); 
    
    
    
    DBMS_OUTPUT.PUT_LINE('[INFO] Insercion de nuevos registros de GEH_GESTOR_ENTIDAD_HIST...');
    
    V_SQL := 'INSERT INTO REM01.GEH_GESTOR_ENTIDAD_HIST (GEH_ID, USU_ID, DD_TGE_ID, GEH_FECHA_DESDE, VERSION, USUARIOCREAR, FECHACREAR, USUARIOBORRAR, BORRADO)
				SELECT 
				REM01.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL,
				USU.USU_ID,
				TGE.DD_TGE_ID,
				SYSDATE,
				0,
				''REMVIP-300'',
				SYSDATE,
				T1.ACT_ID,
				0
				FROM REMMASTER.USU_USUARIOS USU
				INNER JOIN REMMASTER.dd_tge_tipo_gestor TGE ON tge.dd_tge_codigo = ''GCOM''
				INNER JOIN (SELECT DISTINCT ACT_ID FROM REM01.GAH_GESTOR_ACTIVO_HISTORICO GAH
							INNER JOIN REM01.GEH_GESTOR_ENTIDAD_HIST GEH ON GEH.GEH_ID = GAH.GEH_ID
							WHERE USUARIOMODIFICAR = ''REMVIP-300'') T1 ON 1=1
				WHERE USU.USU_USERNAME = ''dtacero''';
    EXECUTE IMMEDIATE V_SQL;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST... Se han insertado correctamente '||SQL%ROWCOUNT||' registros'); 
    
    
    
    DBMS_OUTPUT.PUT_LINE('[INFO] Insercion de nuevos registros de GAH_GESTOR_ACTIVO_HISTORICO...');
    
    V_SQL := 'INSERT INTO REM01.GAH_GESTOR_ACTIVO_HISTORICO GCH (GEH_ID, ACT_ID)
				SELECT GEH.GEH_ID, GEH.USUARIOBORRAR FROM REM01.GEH_GESTOR_ENTIDAD_HIST GEH
				WHERE GEH.USUARIOCREAR = ''REMVIP-300''';
    EXECUTE IMMEDIATE V_SQL;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO... Se han insertado correctamente '||SQL%ROWCOUNT||' registros');
    
    
    
    DBMS_OUTPUT.PUT_LINE('[INFO] Actualizacion de registros de GEH_GESTOR_ENTIDAD_HIST...');
    
    V_SQL := 'UPDATE REM01.GEH_GESTOR_ENTIDAD_HIST
				SET USUARIOBORRAR = NULL
				WHERE USUARIOCREAR = ''REMVIP-300''';
    EXECUTE IMMEDIATE V_SQL;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST... Se han actualizado correctamente '||SQL%ROWCOUNT||' registros');
    
	DBMS_OUTPUT.PUT_LINE('[FIN] El proceso de actualización de importes a finalizado correctamente');
	
	COMMIT;    
    
EXCEPTION
  WHEN OTHERS THEN
    ERR_NUM := SQLCODE;
    ERR_MSG := SQLERRM;
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(ERR_MSG);
    ROLLBACK;
    RAISE;   
END;
/
EXIT;
