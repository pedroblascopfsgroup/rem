--/*
--##########################################
--## AUTOR=Gustavo Mora
--## FECHA_CREACION=20180403
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-425
--## PRODUCTO=NO
--##
--## Finalidad: Borrar AGR_ID mal asignado en algunas ofertas
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    --V_COUNT NUMBER(16); -- Vble. para contar.
    --V_COUNT_INSERT NUMBER(16):= 0; -- Vble. para contar inserts
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	V_USUARIO VARCHAR2(32 CHAR):= 'REMVIP-425';
 
 BEGIN

 --Ponemos el estado del o de los gastos en Autorizado Administración

   EXECUTE IMMEDIATE   'MERGE INTO REM01.GPV_GASTOS_PROVEEDOR T1
         USING (SELECT GPV.GPV_ID
             FROM REM01.GPV_GASTOS_PROVEEDOR GPV
             JOIN REM01.DD_EGA_ESTADOS_GASTO EGA ON EGA.DD_EGA_ID = GPV.DD_EGA_ID
             JOIN REM01.GGE_GASTOS_GESTION GGE ON GPV.GPV_ID = GGE.GPV_ID
             left JOIN REM01.DD_EAP_ESTADOS_AUTORIZ_PROP EAP ON EAP.DD_EAP_ID = GGE.DD_EAP_ID
             left JOIN REM01.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH ON EAH.DD_EAH_ID = GGE.DD_EAH_ID
             WHERE GPV.GPV_ID IN (select gpv.gpv_id 
                                  from REM01.GPV_GASTOS_PROVEEDOR gpv 
                                  where gpv.GPV_NUM_GASTO_HAYA in (
                                         9237202
,9237336
,9242085
,9245678
,9251943
,9252257
,9252375
,9252744
,9252761
,9252845
,9252851
,9253190
,9253423
,9253475
,9253558
,9253744
,9253799
,9254044
,9254048
,9254345
,9254349
,9254426
,9254477
,9254644
,9254647
,9254710
,9254711
,9254727
,9254797
,9254872
,9254975
,9255025
,9255038
,9255072
,9255075
,9255124
,9255125
,9255203
,9255236
,9255285
,9255286
,9255338
,9255370
,9255520
,9255576
,9255664
,9255720
,9255809
,9255847
,9255849
,9255892
,9255894
,9255895
,9256189
,9256213
,9256292
,9256584
,9256590
,9256707
,9256735
,9256847
,9256866
,9256892
,9256910
,9256919
,9256935
,9256964
,9257006
,9257035
,9257359
,9257374
,9257434
,9257467
,9257523
,9257576
,9257577
,9257616
,9257632
,9257832
,9257962
,9257969
,9258110
,9258228
,9258278
,9258285
,9258291
,9258798
,9259230
,9259289
,9259368
,9259455
,9259587
,9259986
,9260036
,9260122
,9260385
,9260618
,9260657
,9260677
,9260845
,9260876
,9260877
,9260886
,9260888
,9260966
,9260968
,9261371
,9261413
,9261449
,9261635
,9261661
,9261810
,9261878
,9261981
,9262043
,9262140
,9262221
,9262232
,9262284
,9262332
,9262333
,9262464
,9262561
,9262707
,9262787
,9262803
,9262821
,9262822
,9262962
,9262968
,9263075
,9263105
,9263210
,9263211
,9263221
,9263306
,9263347
,9263418
,9263726
,9263746
,9263806
,9263956
,9264014
,9264077
,9264109
,9264150
,9264161
,9264195
,9264273
,9264278
,9264367
,9264732
,9264758
,9264788
,9265098
,9265142
,9265161
,9265325
,9265511
,9265601
,9265784
,9265791
,9265799
,9265873
,9265933
,9266035
,9266155
,9266203
,9266805
,9266817
,9266826
,9266932
,9266982
,9267081
,9267093
,9267094
,9267113
,9267424
,9279416
,9288480
,9288481
,9288911
,9289672
,9289748
,9291781
,9291850
,9291851
,9291977
,9292053
,9292126
,9292482
,9292527
,9293212
,9293578
,9294023
,9294026
,9294714
,9294884
,9294896
,9295007
,9295881
,9296576
,9296591
,9296603
,9296609
,9296719
,9299346
,9299514
,9299704
,9300357
,9300776
,9300802
,9302045
,9302487
,9302504
,9303245
,9303293
,9303443
,9303460
,9305253
,9306635
,9306682
,9307535
,9307985
,9309284
,9309291
,9309755
,9309860
,9310469
,9310536
,9311027
,9311797
,9313742
,9314099
,9314616
,9314625
,9315181
,9315673
,9315674
,9315892
,9316367
,9317118
,9317166
,9317316
,9319447
,9319505
,9320015
,9320375
,9320839
,9321549
,9321564
,9323339
,9323834
,9324559
,9325017
,9325792
,9325797
,9325810
,9325936
,9327376
,9327414
,9327756
,9327762
,9327983
,9328332
,9328348
,9328802
,9329142
,9329143
,9330136
,9330616
,9331003
,9332584
,9332585
,9333651
,9333701
,9334661
,9335100
,9335533
,9335895
,9335896
,9336724
,9336806
,9339077
,9339145
,9339380
,9341855
,9342375
,9343108
,9344804
,9344866
,9345276
,9345285
,9345871
,9346090
,9346146
,9346205
,9346867
,9346886
,9346927
,9346977
,9347524
,9356168
,9357137
,9357270
,9358025
,9358343
,9358521
,9358893
,9359167
,9359388
,9359479
,9361259
,9361267
,9361484
,9361654
,9362551
,9363133
,9363317
,9363386
,9363387
,9363719
,9363720
,9365540
,9365791
,9367552
,9367706
,9367968
,9368550
,9368742
,9369371
,9373466
,9374661
,9374862
,9377206
,9377207
,9427918
,9429222
,9429227
,9429235
,9429237
,9429240
,9429243
,9429245
,9429259
,9429262
,9433358
,9479697
,9479737
,9479742
,9480205
,9494117
,9502452
,9502453
,9509771
,9509772
,9552964
,9552968
,9556208
,9559213
,9562691
                                       ))
             ) T2
         ON (T1.GPV_ID = T2.GPV_ID)
         WHEN MATCHED THEN UPDATE SET
             T1.USUARIOMODIFICAR = ''REMVIP-309'', T1.FECHAMODIFICAR = SYSDATE
             , T1.DD_EGA_ID = (SELECT DD_EGA_ID FROM REM01.DD_EGA_ESTADOS_GASTO WHERE DD_EGA_CODIGO = ''03'')';

 DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado '||SQL%ROWCOUNT||' gastos en la GPV_GASTOS_PROVEEDOR');    

--Ponemos el estado de autorización por parte de Haya en Autorizado y eliminamos el estado de autorización del propietario, así como actualizar la fecha del estado de autorización de Haya y eliminamos las fechas de estado de autorización del propietario y de envío al propietario

         EXECUTE IMMEDIATE   ' MERGE INTO REM01.GGE_GASTOS_GESTION T1       
       USING (SELECT GPV.GPV_ID      
           FROM REM01.GPV_GASTOS_PROVEEDOR GPV       
           JOIN REM01.DD_EGA_ESTADOS_GASTO EGA ON EGA.DD_EGA_ID = GPV.DD_EGA_ID       
           JOIN REM01.GGE_GASTOS_GESTION GGE ON GPV.GPV_ID = GGE.GPV_ID       
           left JOIN REM01.DD_EAP_ESTADOS_AUTORIZ_PROP EAP ON EAP.DD_EAP_ID = GGE.DD_EAP_ID       
           left JOIN REM01.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH ON EAH.DD_EAH_ID = GGE.DD_EAH_ID       
           WHERE GPV.GPV_ID IN (select gpv.gpv_id 
                                  from REM01.GPV_GASTOS_PROVEEDOR gpv 
                                  where gpv.GPV_NUM_GASTO_HAYA in (
                                        9237202
,9237336
,9242085
,9245678
,9251943
,9252257
,9252375
,9252744
,9252761
,9252845
,9252851
,9253190
,9253423
,9253475
,9253558
,9253744
,9253799
,9254044
,9254048
,9254345
,9254349
,9254426
,9254477
,9254644
,9254647
,9254710
,9254711
,9254727
,9254797
,9254872
,9254975
,9255025
,9255038
,9255072
,9255075
,9255124
,9255125
,9255203
,9255236
,9255285
,9255286
,9255338
,9255370
,9255520
,9255576
,9255664
,9255720
,9255809
,9255847
,9255849
,9255892
,9255894
,9255895
,9256189
,9256213
,9256292
,9256584
,9256590
,9256707
,9256735
,9256847
,9256866
,9256892
,9256910
,9256919
,9256935
,9256964
,9257006
,9257035
,9257359
,9257374
,9257434
,9257467
,9257523
,9257576
,9257577
,9257616
,9257632
,9257832
,9257962
,9257969
,9258110
,9258228
,9258278
,9258285
,9258291
,9258798
,9259230
,9259289
,9259368
,9259455
,9259587
,9259986
,9260036
,9260122
,9260385
,9260618
,9260657
,9260677
,9260845
,9260876
,9260877
,9260886
,9260888
,9260966
,9260968
,9261371
,9261413
,9261449
,9261635
,9261661
,9261810
,9261878
,9261981
,9262043
,9262140
,9262221
,9262232
,9262284
,9262332
,9262333
,9262464
,9262561
,9262707
,9262787
,9262803
,9262821
,9262822
,9262962
,9262968
,9263075
,9263105
,9263210
,9263211
,9263221
,9263306
,9263347
,9263418
,9263726
,9263746
,9263806
,9263956
,9264014
,9264077
,9264109
,9264150
,9264161
,9264195
,9264273
,9264278
,9264367
,9264732
,9264758
,9264788
,9265098
,9265142
,9265161
,9265325
,9265511
,9265601
,9265784
,9265791
,9265799
,9265873
,9265933
,9266035
,9266155
,9266203
,9266805
,9266817
,9266826
,9266932
,9266982
,9267081
,9267093
,9267094
,9267113
,9267424
,9279416
,9288480
,9288481
,9288911
,9289672
,9289748
,9291781
,9291850
,9291851
,9291977
,9292053
,9292126
,9292482
,9292527
,9293212
,9293578
,9294023
,9294026
,9294714
,9294884
,9294896
,9295007
,9295881
,9296576
,9296591
,9296603
,9296609
,9296719
,9299346
,9299514
,9299704
,9300357
,9300776
,9300802
,9302045
,9302487
,9302504
,9303245
,9303293
,9303443
,9303460
,9305253
,9306635
,9306682
,9307535
,9307985
,9309284
,9309291
,9309755
,9309860
,9310469
,9310536
,9311027
,9311797
,9313742
,9314099
,9314616
,9314625
,9315181
,9315673
,9315674
,9315892
,9316367
,9317118
,9317166
,9317316
,9319447
,9319505
,9320015
,9320375
,9320839
,9321549
,9321564
,9323339
,9323834
,9324559
,9325017
,9325792
,9325797
,9325810
,9325936
,9327376
,9327414
,9327756
,9327762
,9327983
,9328332
,9328348
,9328802
,9329142
,9329143
,9330136
,9330616
,9331003
,9332584
,9332585
,9333651
,9333701
,9334661
,9335100
,9335533
,9335895
,9335896
,9336724
,9336806
,9339077
,9339145
,9339380
,9341855
,9342375
,9343108
,9344804
,9344866
,9345276
,9345285
,9345871
,9346090
,9346146
,9346205
,9346867
,9346886
,9346927
,9346977
,9347524
,9356168
,9357137
,9357270
,9358025
,9358343
,9358521
,9358893
,9359167
,9359388
,9359479
,9361259
,9361267
,9361484
,9361654
,9362551
,9363133
,9363317
,9363386
,9363387
,9363719
,9363720
,9365540
,9365791
,9367552
,9367706
,9367968
,9368550
,9368742
,9369371
,9373466
,9374661
,9374862
,9377206
,9377207
,9427918
,9429222
,9429227
,9429235
,9429237
,9429240
,9429243
,9429245
,9429259
,9429262
,9433358
,9479697
,9479737
,9479742
,9480205
,9494117
,9502452
,9502453
,9509771
,9509772
,9552964
,9552968
,9556208
,9559213
,9562691
                                       ))
              ) T2       
       ON (T1.GPV_ID = T2.GPV_ID)       
       WHEN MATCHED THEN UPDATE SET       
           T1.USUARIOMODIFICAR = ''REMVIP-309'', T1.FECHAMODIFICAR = SYSDATE       
           , T1.DD_EAH_ID = (SELECT DD_EAH_ID FROM REM01.DD_EAH_ESTADOS_AUTORIZ_HAYA WHERE DD_EAH_CODIGO = ''03'')       
           , T1.GGE_FECHA_EAH = sysdate
           , T1.DD_EAP_ID = null
           , T1.GGE_FECHA_EAP = NULL       
           , T1.GGE_FECHA_ENVIO_PRPTRIO = NULL
           , T1.GGE_MOTIVO_RECHAZO_PROP = NULL';

        
 DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado '||SQL%ROWCOUNT||' gastos en la GGE_GASTOS_GESTION');
 
 
 
 
EXECUTE IMMEDIATE   'update rem01.GPV_GASTOS_PROVEEDOR 
set dd_tog_id = (select dd_tog_id from rem01.DD_TOG_TIPO_OPERACION_GASTO where dd_tog_codigo = ''03'')
where gpv_id in (
        select gpv_id 
        from rem01.GPV_GASTOS_PROVEEDOR 
   where gpv_num_gasto_haya in ( 9237202
,9237336
,9242085
,9245678
,9251943
,9252257
,9252375
,9252744
,9252761
,9252845
,9252851
,9253190
,9253423
,9253475
,9253558
,9253744
,9253799
,9254044
,9254048
,9254345
,9254349
,9254426
,9254477
,9254644
,9254647
,9254710
,9254711
,9254727
,9254797
,9254872
,9254975
,9255025
,9255038
,9255072
,9255075
,9255124
,9255125
,9255203
,9255236
,9255285
,9255286
,9255338
,9255370
,9255520
,9255576
,9255664
,9255720
,9255809
,9255847
,9255849
,9255892
,9255894
,9255895
,9256189
,9256213
,9256292
,9256584
,9256590
,9256707
,9256735
,9256847
,9256866
,9256892
,9256910
,9256919
,9256935
,9256964
,9257006
,9257035
,9257359
,9257374
,9257434
,9257467
,9257523
,9257576
,9257577
,9257616
,9257632
,9257832
,9257962
,9257969
,9258110
,9258228
,9258278
,9258285
,9258291
,9258798
,9259230
,9259289
,9259368
,9259455
,9259587
,9259986
,9260036
,9260122
,9260385
,9260618
,9260657
,9260677
,9260845
,9260876
,9260877
,9260886
,9260888
,9260966
,9260968
,9261371
,9261413
,9261449
,9261635
,9261661
,9261810
,9261878
,9261981
,9262043
,9262140
,9262221
,9262232
,9262284
,9262332
,9262333
,9262464
,9262561
,9262707
,9262787
,9262803
,9262821
,9262822
,9262962
,9262968
,9263075
,9263105
,9263210
,9263211
,9263221
,9263306
,9263347
,9263418
,9263726
,9263746
,9263806
,9263956
,9264014
,9264077
,9264109
,9264150
,9264161
,9264195
,9264273
,9264278
,9264367
,9264732
,9264758
,9264788
,9265098
,9265142
,9265161
,9265325
,9265511
,9265601
,9265784
,9265791
,9265799
,9265873
,9265933
,9266035
,9266155
,9266203
,9266805
,9266817
,9266826
,9266932
,9266982
,9267081
,9267093
,9267094
,9267113
,9267424
,9279416
,9288480
,9288481
,9288911
,9289672
,9289748
,9291781
,9291850
,9291851
,9291977
,9292053
,9292126
,9292482
,9292527
,9293212
,9293578
,9294023
,9294026
,9294714
,9294884
,9294896
,9295007
,9295881
,9296576
,9296591
,9296603
,9296609
,9296719
,9299346
,9299514
,9299704
,9300357
,9300776
,9300802
,9302045
,9302487
,9302504
,9303245
,9303293
,9303443
,9303460
,9305253
,9306635
,9306682
,9307535
,9307985
,9309284
,9309291
,9309755
,9309860
,9310469
,9310536
,9311027
,9311797
,9313742
,9314099
,9314616
,9314625
,9315181
,9315673
,9315674
,9315892
,9316367
,9317118
,9317166
,9317316
,9319447
,9319505
,9320015
,9320375
,9320839
,9321549
,9321564
,9323339
,9323834
,9324559
,9325017
,9325792
,9325797
,9325810
,9325936
,9327376
,9327414
,9327756
,9327762
,9327983
,9328332
,9328348
,9328802
,9329142
,9329143
,9330136
,9330616
,9331003
,9332584
,9332585
,9333651
,9333701
,9334661
,9335100
,9335533
,9335895
,9335896
,9336724
,9336806
,9339077
,9339145
,9339380
,9341855
,9342375
,9343108
,9344804
,9344866
,9345276
,9345285
,9345871
,9346090
,9346146
,9346205
,9346867
,9346886
,9346927
,9346977
,9347524
,9356168
,9357137
,9357270
,9358025
,9358343
,9358521
,9358893
,9359167
,9359388
,9359479
,9361259
,9361267
,9361484
,9361654
,9362551
,9363133
,9363317
,9363386
,9363387
,9363719
,9363720
,9365540
,9365791
,9367552
,9367706
,9367968
,9368550
,9368742
,9369371
,9373466
,9374661
,9374862
,9377206
,9377207
,9427918
,9429222
,9429227
,9429235
,9429237
,9429240
,9429243
,9429245
,9429259
,9429262
,9433358
,9479697
,9479737
,9479742
,9480205
,9494117
,9502452
,9502453
,9509771
,9509772
,9552964
,9552968
,9556208
,9559213
,9562691
))';
 
 
 COMMIT;
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------'); 
          DBMS_OUTPUT.PUT_LINE(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
