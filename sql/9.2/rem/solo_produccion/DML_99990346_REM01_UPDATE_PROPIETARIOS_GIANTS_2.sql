--/*
--#########################################
--## AUTOR=SIMEON SHOPOV
--## FECHA_CREACION=20180612
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.17
--## INCIDENCIA_LINK=REMVIP-1049
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; --'#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; --'#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(25 CHAR):= 'ACT_ACTIVO';
    V_COUNT NUMBER(16); -- Vble. para contar.
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USUARIO VARCHAR2(32 CHAR):= 'REMVIP-1049_2';
	
	PROPIETARIO VARCHAR2(56 CHAR) := 'G-GIANTS REO II, S.L.';

	ACT_NUM_ACTIVO NUMBER(16);
	
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
			   T_JBV(6971061)
	, T_JBV(6971064)
	, T_JBV(6971069)
	, T_JBV(6971071)
	, T_JBV(6971003)
	, T_JBV(6970952)
	, T_JBV(6971163)
	, T_JBV(6971193)
	, T_JBV(6971313)
	, T_JBV(6971316)
	, T_JBV(6971325)
	, T_JBV(6971332)
	, T_JBV(6971133)
	, T_JBV(6971548)
	, T_JBV(6971549)
	, T_JBV(6971552)
	, T_JBV(6971509)
	, T_JBV(6971510)
	, T_JBV(6971352)
	, T_JBV(6970102)
	, T_JBV(6971023)
	, T_JBV(6971025)
	, T_JBV(6971030)
	, T_JBV(6971260)
	, T_JBV(6971048)
	, T_JBV(6970875)
	, T_JBV(6970039)
	, T_JBV(6971219)
	, T_JBV(6970911)
	, T_JBV(6970913)
	, T_JBV(6971224)
	, T_JBV(6971301)
	, T_JBV(6970916)
	, T_JBV(6970917)
	, T_JBV(6970918)
	, T_JBV(6970928)
	, T_JBV(6970937)
	, T_JBV(6970938)
	, T_JBV(6970939)
	, T_JBV(6970941)
	, T_JBV(6970174)
	, T_JBV(6970177)
	, T_JBV(6970178)
	, T_JBV(6971667)
	, T_JBV(6971668)
	, T_JBV(6971669)
	, T_JBV(6971671)
	, T_JBV(6971672)
	, T_JBV(6971673)
	, T_JBV(6971674)
	, T_JBV(6971676)
	, T_JBV(6971677)
	, T_JBV(6971678)
	, T_JBV(6971680)
	, T_JBV(6971681)
	, T_JBV(6971682)
	, T_JBV(6971683)
	, T_JBV(6971528)
	, T_JBV(6971388)
	, T_JBV(6970201)
	, T_JBV(6971580)
	, T_JBV(6971583)
	, T_JBV(6970741)
	, T_JBV(6970820)
	, T_JBV(6970826)
	, T_JBV(6970829)
	, T_JBV(6971399)
	, T_JBV(6970407)
	, T_JBV(6970758)
	, T_JBV(6970760)
	, T_JBV(6970064)
	, T_JBV(6971415)
	, T_JBV(6970087)
	, T_JBV(6970088)
	, T_JBV(6970212)
	, T_JBV(6969970)
	, T_JBV(6970028)
	, T_JBV(6969968)
	, T_JBV(6971441)
	, T_JBV(6971445)
	, T_JBV(6970773)
	, T_JBV(6971620)
	, T_JBV(6971622)
	, T_JBV(6970271)
	, T_JBV(6970273)
	, T_JBV(6971623)
	, T_JBV(6970307)
	, T_JBV(6971626)
	, T_JBV(6970687)
	, T_JBV(6970313)
	, T_JBV(6970336)
	, T_JBV(6969997)
	, T_JBV(6970605)
	, T_JBV(6970768)
	, T_JBV(6970051)
	, T_JBV(6970797)
	, T_JBV(6970625)
	, T_JBV(6971684)
	, T_JBV(6971685)
	, T_JBV(6971686)
	, T_JBV(6971687)
	, T_JBV(6970595)
	, T_JBV(6970597)
	, T_JBV(6970598)
	, T_JBV(6970601)
	, T_JBV(6970603)
	, T_JBV(6970241)
	, T_JBV(6970607)
	, T_JBV(6970609)
	, T_JBV(6970610)
	, T_JBV(6970612)
	, T_JBV(6970613)
	, T_JBV(6970614)
	, T_JBV(6970509)
	, T_JBV(6970510)
	, T_JBV(6970513)
	, T_JBV(6970062)
	, T_JBV(6970655)
	, T_JBV(6971599)
	, T_JBV(6970535)
	, T_JBV(6971612)
	, T_JBV(6971613)
	, T_JBV(6971614)
	, T_JBV(6971615)
	, T_JBV(6971616)
	, T_JBV(6970590)
	, T_JBV(6971331)
	, T_JBV(6971387)
	, T_JBV(6971478)
	, T_JBV(6971484)
	, T_JBV(6971618)
	, T_JBV(6971617)
	, T_JBV(6971679)
	, T_JBV(6971675)
	, T_JBV(6971670)
	, T_JBV(6971619)
	, T_JBV(6971621)
	, T_JBV(6971563)
	, T_JBV(6971256)
	, T_JBV(6970694)
	, T_JBV(6970751)
	, T_JBV(6970770)
	, T_JBV(6970983)
	); 
V_TMP_JBV T_JBV;
BEGIN

 
 FOR I IN V_JBV.FIRST .. V_JBV.LAST
 LOOP
 
 V_TMP_JBV := V_JBV(I);
 			  ACT_NUM_ACTIVO := TRIM(V_TMP_JBV(1));

			EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_PAC_PROPIETARIO_ACTIVO PAC
								JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = PAC.ACT_ID
								WHERE ACT.ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||'' INTO V_COUNT;
								
			IF V_COUNT = 0 THEN 								
				V_SQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_PAC_PROPIETARIO_ACTIVO (
				  PAC_ID
				, ACT_ID
				, PRO_ID
				, PAC_PORC_PROPIEDAD
				, USUARIOCREAR
				, FECHACREAR
				) VALUES (
				 '||V_ESQUEMA||'.S_ACT_PAC_PROPIETARIO_ACTIVO.NEXTVAL
				, (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||')
				, (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_NOMBRE = '''||PROPIETARIO||''')
				, 100
				, '''||V_USUARIO||'''
				, SYSDATE
				)
			';
			DBMS_OUTPUT.PUT_LINE(V_SQL);
				EXECUTE IMMEDIATE V_SQL;
		
			DBMS_OUTPUT.PUT_LINE('Asignado el activo '||ACT_NUM_ACTIVO||' al propietario '||PROPIETARIO||'');			
		
			ELSE
			
				V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_PAC_PROPIETARIO_ACTIVO
							SET 
							  PRO_ID = (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_NOMBRE = '''||PROPIETARIO||''')
							, USUARIOMODIFICAR = '''||V_USUARIO||'''
							, FECHAMODIFICAR = SYSDATE
							, PAC_PORC_PROPIEDAD = 100
							WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||')
			';
			DBMS_OUTPUT.PUT_LINE(V_SQL);
				EXECUTE IMMEDIATE V_SQL;
				DBMS_OUTPUT.PUT_LINE('Cambiado el activo '||ACT_NUM_ACTIVO||' al propietario '||PROPIETARIO||'');			
			END IF;
			
			IF SQL%ROWCOUNT > 0 THEN
					V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
				END IF;

 END LOOP;			    
    
        DBMS_OUTPUT.PUT_LINE('[INFO] Puestos en total '||V_COUNT_UPDATE||' propietarios');
    
	COMMIT;

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
