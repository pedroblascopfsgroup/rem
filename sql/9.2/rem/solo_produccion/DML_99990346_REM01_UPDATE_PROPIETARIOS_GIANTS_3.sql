--/*
--#########################################
--## AUTOR=SIMEON SHOPOV
--## FECHA_CREACION=20180612
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.17
--## INCIDENCIA_LINK=REMVIP-1049
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; --'#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; --'#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(25 CHAR):= 'ACT_ACTIVO';
    V_COUNT NUMBER(16); -- Vble. para contar.
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USUARIO VARCHAR2(32 CHAR):= 'REMVIP-1049_3';
	
	PROPIETARIO VARCHAR2(56 CHAR) := 'G-GIANTS REO III, S.L.';

	ACT_NUM_ACTIVO NUMBER(16);
	
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
		  T_JBV(6970973)
		, T_JBV(6970974)
		, T_JBV(6970975)
		, T_JBV(6970996)
		, T_JBV(6971001)
		, T_JBV(6971005)
		, T_JBV(6971006)
		, T_JBV(6970959)
		, T_JBV(6970960)
		, T_JBV(6970961)
		, T_JBV(6970970)
		, T_JBV(6970971)
		, T_JBV(6970972)
		, T_JBV(6971165)
		, T_JBV(6971118)
		, T_JBV(6971346)
		, T_JBV(6971347)
		, T_JBV(6971349)
		, T_JBV(6971350)
		, T_JBV(6971351)
		, T_JBV(6971037)
		, T_JBV(6971138)
		, T_JBV(6971041)
		, T_JBV(6970865)
		, T_JBV(6970866)
		, T_JBV(6970867)
		, T_JBV(6970069)
		, T_JBV(6970872)
		, T_JBV(6970873)
		, T_JBV(6971469)
		, T_JBV(6971470)
		, T_JBV(6971471)
		, T_JBV(6971472)
		, T_JBV(6971473)
		, T_JBV(6971474)
		, T_JBV(6969966)
		, T_JBV(6970892)
		, T_JBV(6969978)
		, T_JBV(6971309)
		, T_JBV(6971476)
		, T_JBV(6970172)
		, T_JBV(6970180)
		, T_JBV(6970187)
		, T_JBV(6970188)
		, T_JBV(6970189)
		, T_JBV(6970190)
		, T_JBV(6970197)
		, T_JBV(6970725)
		, T_JBV(6970726)
		, T_JBV(6970727)
		, T_JBV(6970728)
		, T_JBV(6970729)
		, T_JBV(6970730)
		, T_JBV(6970731)
		, T_JBV(6970732)
		, T_JBV(6970733)
		, T_JBV(6970734)
		, T_JBV(6970735)
		, T_JBV(6970736)
		, T_JBV(6970737)
		, T_JBV(6971380)
		, T_JBV(6970202)
		, T_JBV(6970738)
		, T_JBV(6970739)
		, T_JBV(6970822)
		, T_JBV(6971397)
		, T_JBV(6971407)
		, T_JBV(6970130)
		, T_JBV(6970186)
		, T_JBV(6970756)
		, T_JBV(6970223)
		, T_JBV(6970224)
		, T_JBV(6970229)
		, T_JBV(6970472)
		, T_JBV(6970475)
		, T_JBV(6970484)
		, T_JBV(6970485)
		, T_JBV(6970234)
		, T_JBV(6970235)
		, T_JBV(6969975)
		, T_JBV(6970247)
		, T_JBV(6970416)
		, T_JBV(6970771)
		, T_JBV(6970789)
		, T_JBV(6970790)
		, T_JBV(6970437)
		, T_JBV(6970442)
		, T_JBV(6970443)
		, T_JBV(6970444)
		, T_JBV(6970446)
		, T_JBV(6970447)
		, T_JBV(6970449)
		, T_JBV(6970452)
		, T_JBV(6970453)
		, T_JBV(6970454)
		, T_JBV(6970456)
		, T_JBV(6970457)
		, T_JBV(6970458)
		, T_JBV(6970459)
		, T_JBV(6970460)
		, T_JBV(6970461)
		, T_JBV(6970445)
		, T_JBV(6970451)
		, T_JBV(6970455)
		, T_JBV(6970448)
		, T_JBV(6970476)
		, T_JBV(6970516)
		, T_JBV(6970293)
		, T_JBV(6970250)
		, T_JBV(6971589)
		, T_JBV(6970326)
		, T_JBV(6970327)
		, T_JBV(6970328)
		, T_JBV(6970329)
		, T_JBV(6970330)
		, T_JBV(6970332)
		, T_JBV(6970333)
		, T_JBV(6970335)
		, T_JBV(6970337)
		, T_JBV(6970338)
		, T_JBV(6970339)
		, T_JBV(6970571)
		, T_JBV(6970628)
		, T_JBV(6970650)
		, T_JBV(6970370)
		, T_JBV(6970626)
		, T_JBV(6970627)
		, T_JBV(6970050)
		, T_JBV(6970331)
		, T_JBV(6970719)
		, T_JBV(6970722)
		, T_JBV(6970723)
		, T_JBV(6970724)
		, T_JBV(6970521)
		, T_JBV(6970651)
		, T_JBV(6970659)
		, T_JBV(6970660)
		, T_JBV(6970531)
		, T_JBV(6970549)
		, T_JBV(6970550)
		, T_JBV(6970556)
		, T_JBV(6970564)
		, T_JBV(6970033)
		, T_JBV(6970572)
		, T_JBV(6970573)
		, T_JBV(6970574)
		, T_JBV(6970577)
		, T_JBV(6970578)
		, T_JBV(6970580)
		, T_JBV(6970584)
		, T_JBV(6970587)
		, T_JBV(6969977)
		, T_JBV(6970591)
		, T_JBV(6971167)
		, T_JBV(6971348)
		, T_JBV(6970450)
		, T_JBV(6970871)
		, T_JBV(6970946)
	); 
V_TMP_JBV T_JBV;
BEGIN

 
 FOR I IN V_JBV.FIRST .. V_JBV.LAST
 LOOP
 
 V_TMP_JBV := V_JBV(I);
 			  ACT_NUM_ACTIVO := TRIM(V_TMP_JBV(1));

			EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_PAC_PROPIETARIO_ACTIVO PAC
								JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = PAC.ACT_ID
								WHERE ACT.ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||'' INTO V_COUNT;
								
			IF V_COUNT = 0 THEN 								
				V_SQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_PAC_PROPIETARIO_ACTIVO (
				  PAC_ID
				, ACT_ID
				, PRO_ID
				, PAC_PORC_PROPIEDAD
				, USUARIOCREAR
				, FECHACREAR
				) VALUES (
				 '||V_ESQUEMA||'.S_ACT_PAC_PROPIETARIO_ACTIVO.NEXTVAL
				, (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||')
				, (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_NOMBRE = '''||PROPIETARIO||''')
				, 100
				, '''||V_USUARIO||'''
				, SYSDATE
				)
			';
			DBMS_OUTPUT.PUT_LINE(V_SQL);
				EXECUTE IMMEDIATE V_SQL;
		
			DBMS_OUTPUT.PUT_LINE('Asignado el activo '||ACT_NUM_ACTIVO||' al propietario '||PROPIETARIO||'');			
		
			ELSE
			
				V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_PAC_PROPIETARIO_ACTIVO
							SET 
							  PRO_ID = (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_NOMBRE = '''||PROPIETARIO||''')
							, USUARIOMODIFICAR = '''||V_USUARIO||'''
							, FECHAMODIFICAR = SYSDATE
							, PAC_PORC_PROPIEDAD = 100
							WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||')
			';
			DBMS_OUTPUT.PUT_LINE(V_SQL);
				EXECUTE IMMEDIATE V_SQL;
				DBMS_OUTPUT.PUT_LINE('Cambiado el activo '||ACT_NUM_ACTIVO||' al propietario '||PROPIETARIO||'');			
			END IF;
			
			IF SQL%ROWCOUNT > 0 THEN
					V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
				END IF;

 END LOOP;			    
    
        DBMS_OUTPUT.PUT_LINE('[INFO] Puestos en total '||V_COUNT_UPDATE||' propietarios');
    
	COMMIT;

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
