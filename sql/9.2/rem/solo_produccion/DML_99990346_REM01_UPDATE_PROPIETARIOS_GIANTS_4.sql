--/*
--#########################################
--## AUTOR=SIMEON SHOPOV
--## FECHA_CREACION=20180612
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.17
--## INCIDENCIA_LINK=REMVIP-1049
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; --'#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; --'#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(25 CHAR):= 'ACT_ACTIVO';
    V_COUNT NUMBER(16); -- Vble. para contar.
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USUARIO VARCHAR2(32 CHAR):= 'REMVIP-1049_4';
	
	PROPIETARIO VARCHAR2(56 CHAR) := 'G-GIANTS REO IV, S.L.';

	ACT_NUM_ACTIVO NUMBER(16);
	
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
		  T_JBV(6970976)
		, T_JBV(6970977)
		, T_JBV(6971245)
		, T_JBV(6970077)
		, T_JBV(6971060)
		, T_JBV(6970951)
		, T_JBV(6970969)
		, T_JBV(6971184)
		, T_JBV(6971190)
		, T_JBV(6971191)
		, T_JBV(6971197)
		, T_JBV(6971199)
		, T_JBV(6971202)
		, T_JBV(6971203)
		, T_JBV(6969991)
		, T_JBV(6969992)
		, T_JBV(6969993)
		, T_JBV(6969994)
		, T_JBV(6971205)
		, T_JBV(6971206)
		, T_JBV(6971207)
		, T_JBV(6971208)
		, T_JBV(6971209)
		, T_JBV(6971210)
		, T_JBV(6971211)
		, T_JBV(6971213)
		, T_JBV(6971214)
		, T_JBV(6971096)
		, T_JBV(6971097)
		, T_JBV(6971098)
		, T_JBV(6971099)
		, T_JBV(6970079)
		, T_JBV(6971337)
		, T_JBV(6971546)
		, T_JBV(6971517)
		, T_JBV(6971518)
		, T_JBV(6971501)
		, T_JBV(6971038)
		, T_JBV(6971143)
		, T_JBV(6971144)
		, T_JBV(6971151)
		, T_JBV(6971152)
		, T_JBV(6971153)
		, T_JBV(6971154)
		, T_JBV(6971263)
		, T_JBV(6971040)
		, T_JBV(6971043)
		, T_JBV(6971044)
		, T_JBV(6971056)
		, T_JBV(6970869)
		, T_JBV(6970870)
		, T_JBV(6971215)
		, T_JBV(6971216)
		, T_JBV(6971233)
		, T_JBV(6970942)
		, T_JBV(6971531)
		, T_JBV(6970173)
		, T_JBV(6971524)
		, T_JBV(6971525)
		, T_JBV(6971526)
		, T_JBV(6971381)
		, T_JBV(6971389)
		, T_JBV(6971390)
		, T_JBV(6970742)
		, T_JBV(6970743)
		, T_JBV(6970745)
		, T_JBV(6970746)
		, T_JBV(6971402)
		, T_JBV(6971403)
		, T_JBV(6971405)
		, T_JBV(6971406)
		, T_JBV(6970133)
		, T_JBV(6971412)
		, T_JBV(6970181)
		, T_JBV(6970830)
		, T_JBV(6971413)
		, T_JBV(6971424)
		, T_JBV(6971435)
		, T_JBV(6970089)
		, T_JBV(6971442)
		, T_JBV(6971443)
		, T_JBV(6970417)
		, T_JBV(6970418)
		, T_JBV(6970780)
		, T_JBV(6970783)
		, T_JBV(6970144)
		, T_JBV(6971453)
		, T_JBV(6970274)
		, T_JBV(6970844)
		, T_JBV(6970846)
		, T_JBV(6970847)
		, T_JBV(6970848)
		, T_JBV(6970849)
		, T_JBV(6970850)
		, T_JBV(6970851)
		, T_JBV(6970852)
		, T_JBV(6970853)
		, T_JBV(6970854)
		, T_JBV(6970855)
		, T_JBV(6970856)
		, T_JBV(6970857)
		, T_JBV(6970858)
		, T_JBV(6970859)
		, T_JBV(6970281)
		, T_JBV(6970256)
		, T_JBV(6970669)
		, T_JBV(6970670)
		, T_JBV(6970671)
		, T_JBV(6970672)
		, T_JBV(6970673)
		, T_JBV(6970684)
		, T_JBV(6970698)
		, T_JBV(6970700)
		, T_JBV(6970701)
		, T_JBV(6970703)
		, T_JBV(6970704)
		, T_JBV(6970705)
		, T_JBV(6970706)
		, T_JBV(6970343)
		, T_JBV(6970638)
		, T_JBV(6970641)
		, T_JBV(6970702)
		, T_JBV(6970792)
		, T_JBV(6970357)
		, T_JBV(6970358)
		, T_JBV(6970364)
		, T_JBV(6970365)
		, T_JBV(6970632)
		, T_JBV(6970633)
		, T_JBV(6970634)
		, T_JBV(6970860)
		, T_JBV(6970861)
		, T_JBV(6970862)
		, T_JBV(6970863)
		, T_JBV(6970492)
		, T_JBV(6970493)
		, T_JBV(6970707)
		, T_JBV(6970708)
		, T_JBV(6970709)
		, T_JBV(6970710)
		, T_JBV(6970711)
		, T_JBV(6970712)
		, T_JBV(6970713)
		, T_JBV(6970714)
		, T_JBV(6970715)
		, T_JBV(6970716)
		, T_JBV(6970843)
		, T_JBV(6970068)
		, T_JBV(6970523)
		, T_JBV(6970635)
		, T_JBV(6970636)
		, T_JBV(6970637)
		, T_JBV(6970639)
		, T_JBV(6970640)
		, T_JBV(6970642)
		, T_JBV(6970643)
		, T_JBV(6970647)
		, T_JBV(6970648)
		, T_JBV(6970649)
		, T_JBV(6970667)
		, T_JBV(6970668)
		, T_JBV(6970538)
		, T_JBV(6970581)
		, T_JBV(6971607)
		, T_JBV(6971608)
		, T_JBV(6970943)
		, T_JBV(6971198)
		, T_JBV(6971200)
		, T_JBV(6971238)
		, T_JBV(6971212)
		, T_JBV(6971276)
		, T_JBV(6971404)
		, T_JBV(6971559)
		, T_JBV(6970874)
		, T_JBV(6971497)
		, T_JBV(6971204)
		, T_JBV(6971201)
		, T_JBV(6971057)
		, T_JBV(6970067)
		, T_JBV(6970494)
		, T_JBV(6970845)
		, T_JBV(6970915)
	); 
V_TMP_JBV T_JBV;
BEGIN

 
 FOR I IN V_JBV.FIRST .. V_JBV.LAST
 LOOP
 
 V_TMP_JBV := V_JBV(I);
 			  ACT_NUM_ACTIVO := TRIM(V_TMP_JBV(1));

			EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_PAC_PROPIETARIO_ACTIVO PAC
								JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = PAC.ACT_ID
								WHERE ACT.ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||'' INTO V_COUNT;
								
			IF V_COUNT = 0 THEN 								
				V_SQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_PAC_PROPIETARIO_ACTIVO (
				  PAC_ID
				, ACT_ID
				, PRO_ID
				, PAC_PORC_PROPIEDAD
				, USUARIOCREAR
				, FECHACREAR
				) VALUES (
				 '||V_ESQUEMA||'.S_ACT_PAC_PROPIETARIO_ACTIVO.NEXTVAL
				, (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||')
				, (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_NOMBRE = '''||PROPIETARIO||''')
				, 100
				, '''||V_USUARIO||'''
				, SYSDATE
				)
			';
			DBMS_OUTPUT.PUT_LINE(V_SQL);
				EXECUTE IMMEDIATE V_SQL;
		
			DBMS_OUTPUT.PUT_LINE('Asignado el activo '||ACT_NUM_ACTIVO||' al propietario '||PROPIETARIO||'');			
		
			ELSE
			
				V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_PAC_PROPIETARIO_ACTIVO
							SET 
							  PRO_ID = (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_NOMBRE = '''||PROPIETARIO||''')
							, USUARIOMODIFICAR = '''||V_USUARIO||'''
							, FECHAMODIFICAR = SYSDATE
							, PAC_PORC_PROPIEDAD = 100
							WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||')
			';
			DBMS_OUTPUT.PUT_LINE(V_SQL);
				EXECUTE IMMEDIATE V_SQL;
				DBMS_OUTPUT.PUT_LINE('Cambiado el activo '||ACT_NUM_ACTIVO||' al propietario '||PROPIETARIO||'');			
			END IF;
			
			IF SQL%ROWCOUNT > 0 THEN
					V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
				END IF;

 END LOOP;			    
    
        DBMS_OUTPUT.PUT_LINE('[INFO] Puestos en total '||V_COUNT_UPDATE||' propietarios');
    
	COMMIT;

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
