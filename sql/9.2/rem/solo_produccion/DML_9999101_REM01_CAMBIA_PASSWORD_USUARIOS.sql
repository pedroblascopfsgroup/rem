--/*
--#########################################
--## AUTOR=SIMEON SHOPOV
--## FECHA_CREACION=20180509
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.18
--## INCIDENCIA_LINK=REMVIP-686
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(25 CHAR):= 'USU_USUARIOS';
    --V_COUNT NUMBER(16); -- Vble. para contar.
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USUARIO VARCHAR2(32 CHAR):= 'REMVIP-686';

	USU_USERNAME VARCHAR2(55 CHAR);
	USU_PASSWORD VARCHAR2(55 CHAR);
	ORDEN NUMBER(1);
	
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
		   T_JBV('02709594X','ADBDFJMGGI',1)
		 , T_JBV('02912870N','LAHSGZXTDY',1)
		 , T_JBV('03867799G','UGGTJNAMRH',1)
		 , T_JBV('03876878K','SBWWXGWRXN',1)
		 , T_JBV('03877533D','RQLXXASCSR',1)
		 , T_JBV('08938379G','VKMLJJQCQX',1)
		 , T_JBV('09051371C','REICFIHDKE',1)
		 , T_JBV('11814546K','NOJOWRGYVB',1)
		 , T_JBV('13928917W','EVXDSBLMYN',1)
		 , T_JBV('29199627T','ENVFPWZSBH',1)
		 , T_JBV('33459310Z','EFQCFRCSKF',1)
		 , T_JBV('38115797J','LVXNBJGTOD',1)
		 , T_JBV('43452768H','WMQFKCLJHX',1)
		 , T_JBV('46927378H','YLEMEKMZWC',1)
		 , T_JBV('50468716T','GXHWAFWCZE',1)
		 , T_JBV('50760288R','AVFSMPHBLN',1)
		 , T_JBV('50868754E','PAEORQFKNX',1)
		 , T_JBV('51391272A','MNRWZXRNHK',1)
		 , T_JBV('52993706G','HLEMQLAMOP',1)
		 , T_JBV('53382018F','XBAARYNNGO',1)
		 , T_JBV('53472227X','DJPQBATWGU',1)
		 , T_JBV('7089139Q','ZPNQAFMEAF',1)
		 , T_JBV('70934859F','FDLNYDLEKF',1)
		 , T_JBV('03887362V','LUXWBILXJW',2)
		 , T_JBV('03893974M','FZBBGYGMFR',2)
		 , T_JBV('14270925T','DTQSCBMAVL',2)
		 , T_JBV('20253228A','FERDRAXYOJ',2)
		 , T_JBV('33517318Q','BSEBGMBSAD',2)
		 , T_JBV('44024784R','VPYAXNWKXW',2)
		 , T_JBV('51935765V','TRCAZXAYZU',2)
		 , T_JBV('52869104Q','HIEJTKFRKC',2)
		 , T_JBV('52872988J','FIPTLDSNNP',2)
		 , T_JBV('52958095C','WRPRJBPEAG',2)
		 , T_JBV('74717518V','GJBENPZDSI',2)
		 , T_JBV('78472108H','QBSMQFVVNN',2)
		 , T_JBV('A82046061','MWPPLRJUNU',2)
		 , T_JBV('A82451410','RMBMHTXPXE',2)
		 , T_JBV('B03830510','MJPFCMWKMX',2)
		 , T_JBV('B04485686','OCBQWSALZB',2)
		 , T_JBV('B23657521','JRQTVYVQCN',2)
		 , T_JBV('B45684677','KHEDSOJMAY',2)
		 , T_JBV('B84105899','PXWPKNFBXG',2)
		 , T_JBV('B85030641','UGGNYHHKVE',2)
		 , T_JBV('B85343721','AGSQBHQKDW',2)
		 , T_JBV('B85884336','QQJVQUEVVS',2)
		 , T_JBV('B86689494','EPWIBIPLOO',2)
		 , T_JBV('B86858073','SJTTPQENAN',2)
		 , T_JBV('B92418524','KVSGCLALJT',2)
		 , T_JBV('E98442098','ALASMBPICP',2)
		 , T_JBV('irodriguezl','VJUXPFHNIQ',2)
		 , T_JBV('mserranog','HPROYGBXTK',2)
		 , T_JBV('pbravol','CQXOHFLJBR',2)
		 , T_JBV('X4092272C','GAXVKABZUL',2)
	); 
V_TMP_JBV T_JBV;
BEGIN


 
 FOR I IN V_JBV.FIRST .. V_JBV.LAST
 LOOP
 
 V_TMP_JBV := V_JBV(I);
 			  USU_USERNAME := TRIM(V_TMP_JBV(1));
 			  USU_PASSWORD := TRIM(V_TMP_JBV(2));
			  ORDEN 	   := TRIM(V_TMP_JBV(3));
	

	IF ORDEN = 2 THEN
		V_SQL := 'UPDATE '||V_ESQUEMA_M||'.'||V_TABLA||' SET
					 USU_PASSWORD = '''||USU_PASSWORD||'''
				   , USUARIOMODIFICAR = '''||V_USUARIO||'''
				   , FECHAMODIFICAR = SYSDATE
				   WHERE USU_USERNAME = '''||USU_USERNAME||'''
					';
					
		EXECUTE IMMEDIATE V_SQL;
		
		IF SQL%ROWCOUNT > 0 THEN
			DBMS_OUTPUT.PUT_LINE('Actualizada la contraseña del usuario '||USU_USERNAME||' a '||USU_PASSWORD);
			V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
		END IF;
	END IF;           

				
 END LOOP;			    
    
	COMMIT;

    DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado en total '||V_COUNT_UPDATE||' contraseñas');

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
