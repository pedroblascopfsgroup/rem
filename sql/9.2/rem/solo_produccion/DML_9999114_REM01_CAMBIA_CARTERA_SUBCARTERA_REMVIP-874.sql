--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20180601
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.17
--## INCIDENCIA_LINK=REMVIP-874
--## PRODUCTO=NO
--## 
--## Finalidad: Recarterizar activos en el array
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_ESQUEMA VARCHAR2(50 CHAR) := '#ESQUEMA#';
    V_ESQUEMA_M VARCHAR2(50 CHAR) := '#ESQUEMA_MASTER#';
    V_MSQL VARCHAR2(4000 CHAR);
    V_CRA_DESC VARCHAR2(200 CHAR);
    V_CRA_DES2 VARCHAR2(200 CHAR);
    V_SCR_DESC VARCHAR2(200 CHAR);
    TYPE T_ACT IS TABLE OF VARCHAR2(240 CHAR);
    TYPE T_ARRAY IS TABLE OF T_ACT;
    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-874';
    V_ARRAY T_ARRAY := T_ARRAY (
        T_ACT(6762404, '03', '11', '25'),
        T_ACT(6762784, '03', '11', '25'),
        T_ACT(6762949, '03', '11', '25'),
        T_ACT(6764227, '03', '11', '25'),
        T_ACT(6764614, '03', '11', '25'),
        T_ACT(6765346, '03', '11', '25'),
        T_ACT(6767807, '03', '11', '25'),
        T_ACT(6767950, '03', '11', '25'),
        T_ACT(6767951, '03', '11', '25'),
        T_ACT(6767958, '03', '11', '25'),
        T_ACT(6768247, '03', '11', '25'),
        T_ACT(6768251, '03', '11', '25'),
        T_ACT(6768263, '03', '11', '25'),
        T_ACT(6768568, '03', '11', '25'),
        T_ACT(6768571, '03', '11', '25'),
        T_ACT(6770842, '03', '11', '25'),
        T_ACT(6773664, '03', '11', '25'),
        T_ACT(6773671, '03', '11', '25'),
        T_ACT(6774019, '03', '11', '25'),
        T_ACT(6774028, '03', '11', '25'),
        T_ACT(6774044, '03', '11', '25'),
        T_ACT(6775907, '03', '11', '25'),
        T_ACT(6776316, '03', '11', '25'),
        T_ACT(6776499, '03', '11', '25'),
        T_ACT(6776503, '03', '11', '25'),
        T_ACT(6779880, '03', '11', '25'),
        T_ACT(6781345, '03', '11', '25'),
        T_ACT(6782693, '03', '11', '25'),
        T_ACT(6782701, '03', '11', '25'),
        T_ACT(6782723, '03', '11', '25'),
        T_ACT(6782913, '03', '11', '25'),
        T_ACT(6782920, '03', '11', '25'),
        T_ACT(6782925, '03', '11', '25'),
        T_ACT(6782929, '03', '11', '25'),
        T_ACT(6782931, '03', '11', '25'),
        T_ACT(6785827, '03', '11', '25'),
        T_ACT(6785828, '03', '11', '25'),
        T_ACT(6786761, '03', '11', '25'),
        T_ACT(6786764, '03', '11', '25'),
        T_ACT(6786765, '03', '11', '25'),
        T_ACT(6786766, '03', '11', '25'),
        T_ACT(6786767, '03', '11', '25'),
        T_ACT(6786768, '03', '11', '25'),
        T_ACT(6786769, '03', '11', '25'),
        T_ACT(6787769, '03', '11', '25'),
        T_ACT(6787772, '03', '11', '25'),
        T_ACT(6788091, '03', '11', '25'),
        T_ACT(6788171, '03', '11', '25'),
        T_ACT(6788364, '03', '11', '25'),
        T_ACT(6788665, '03', '11', '25'),
        T_ACT(6788666, '03', '11', '25'),
        T_ACT(6788671, '03', '11', '25'),
        T_ACT(6788672, '03', '11', '25'),
        T_ACT(6788674, '03', '11', '25'),
        T_ACT(6788675, '03', '11', '25'),
        T_ACT(6788676, '03', '11', '25'),
        T_ACT(6788678, '03', '11', '25'),
        T_ACT(6788680, '03', '11', '25'),
        T_ACT(6788683, '03', '11', '25'),
        T_ACT(6788838, '03', '11', '25'),
        T_ACT(6788862, '03', '11', '25'),
        T_ACT(6788940, '03', '11', '25'),
        T_ACT(6788957, '03', '11', '25'),
        T_ACT(6789188, '03', '11', '25'),
        T_ACT(6789207, '03', '11', '25'),
        T_ACT(6789222, '03', '11', '25'),
        T_ACT(6789418, '03', '11', '25'),
        T_ACT(6789431, '03', '11', '25'),
        T_ACT(6789450, '03', '11', '25'),
        T_ACT(6789455, '03', '11', '25'),
        T_ACT(6791353, '03', '11', '25'),
        T_ACT(6791397, '03', '11', '25'),
        T_ACT(6791406, '03', '11', '25'),
        T_ACT(6791801, '03', '11', '25'),
        T_ACT(6791851, '03', '11', '25'),
        T_ACT(6791873, '03', '11', '25'),
        T_ACT(6793556, '03', '11', '25'),
        T_ACT(6793557, '03', '11', '25'),
        T_ACT(6793559, '03', '11', '25'),
        T_ACT(6793560, '03', '11', '25'),
        T_ACT(6795437, '03', '11', '25'),
        T_ACT(6795438, '03', '11', '25'),
        T_ACT(6795442, '03', '11', '25'),
        T_ACT(6795443, '03', '11', '25'),
        T_ACT(6795446, '03', '11', '25'),
        T_ACT(6795448, '03', '11', '25'),
        T_ACT(6795449, '03', '11', '25'),
        T_ACT(6796023, '03', '11', '25'),
        T_ACT(6796024, '03', '11', '25'),
        T_ACT(6796027, '03', '11', '25'),
        T_ACT(6796262, '03', '11', '25'),
        T_ACT(6796809, '03', '11', '25'),
        T_ACT(6796811, '03', '11', '25'),
        T_ACT(6796824, '03', '11', '25'),
        T_ACT(6796836, '03', '11', '25'),
        T_ACT(6796840, '03', '11', '25'),
        T_ACT(6797111, '03', '11', '25'),
        T_ACT(6797121, '03', '11', '25'),
        T_ACT(6797131, '03', '11', '25'),
        T_ACT(6797137, '03', '11', '25'),
        T_ACT(6797138, '03', '11', '25'),
        T_ACT(6797155, '03', '11', '25'),
        T_ACT(6798255, '03', '11', '25'),
        T_ACT(6798262, '03', '11', '25'),
        T_ACT(6798749, '03', '11', '25'),
        T_ACT(6798751, '03', '11', '25'),
        T_ACT(6798752, '03', '11', '25'),
        T_ACT(6798771, '03', '11', '25'),
        T_ACT(6798772, '03', '11', '25'),
        T_ACT(6798778, '03', '11', '25'),
        T_ACT(6798786, '03', '11', '25'),
        T_ACT(6800140, '03', '11', '25'),
        T_ACT(6800299, '03', '11', '25'),
        T_ACT(6801436, '03', '11', '25'),
        T_ACT(6801438, '03', '11', '25'),
        T_ACT(6801569, '03', '11', '25'),
        T_ACT(6801571, '03', '11', '25'),
        T_ACT(6803442, '03', '11', '25'),
        T_ACT(6803450, '03', '11', '25'),
        T_ACT(6803459, '03', '11', '25'),
        T_ACT(6803462, '03', '11', '25'),
        T_ACT(6803504, '03', '11', '25'),
        T_ACT(6803994, '03', '11', '25'),
        T_ACT(6804139, '03', '11', '25'),
        T_ACT(6804140, '03', '11', '25'),
        T_ACT(6804144, '03', '11', '25'),
        T_ACT(6804145, '03', '11', '25'),
        T_ACT(6804146, '03', '11', '25'),
        T_ACT(6804148, '03', '11', '25'),
        T_ACT(6809829, '03', '11', '25'),
        T_ACT(6809839, '03', '11', '25'),
        T_ACT(6809843, '03', '11', '25'),
        T_ACT(6809846, '03', '11', '25'),
        T_ACT(6809848, '03', '11', '25'),
        T_ACT(6809853, '03', '11', '25'),
        T_ACT(6809855, '03', '11', '25'),
        T_ACT(6809882, '03', '11', '25'),
        T_ACT(6809884, '03', '11', '25'),
        T_ACT(6809885, '03', '11', '25'),
        T_ACT(6809889, '03', '11', '25'),
        T_ACT(6809897, '03', '11', '25'),
        T_ACT(6809902, '03', '11', '25'),
        T_ACT(6809916, '03', '11', '25'),
        T_ACT(6809923, '03', '11', '25'),
        T_ACT(6809943, '03', '11', '25'),
        T_ACT(6809955, '03', '11', '25'),
        T_ACT(6809967, '03', '11', '25'),
        T_ACT(6809969, '03', '11', '25'),
        T_ACT(6810477, '03', '11', '25'),
        T_ACT(6810923, '03', '11', '25'),
        T_ACT(6811063, '03', '11', '25'),
        T_ACT(6811064, '03', '11', '25'),
        T_ACT(6811065, '03', '11', '25'),
        T_ACT(6811597, '03', '11', '25'),
        T_ACT(6811599, '03', '11', '25'),
        T_ACT(6811956, '03', '11', '25'),
        T_ACT(6811957, '03', '11', '25'),
        T_ACT(6812100, '03', '11', '25'),
        T_ACT(6813849, '03', '11', '25'),
        T_ACT(6813858, '03', '11', '25'),
        T_ACT(6814456, '03', '11', '25'),
        T_ACT(6814912, '03', '11', '25'),
        T_ACT(6815071, '03', '11', '25'),
        T_ACT(6818269, '03', '11', '25'),
        T_ACT(6819279, '03', '11', '25'),
        T_ACT(6825058, '03', '11', '25'),
        T_ACT(6825083, '03', '11', '25'),
        T_ACT(6826904, '03', '11', '25'),
        T_ACT(6826979, '03', '11', '25'),
        T_ACT(6827861, '03', '11', '25'),
        T_ACT(6830860, '03', '11', '25'),
        T_ACT(6830879, '03', '11', '25'),
        T_ACT(6830896, '03', '11', '25'),
        T_ACT(6844328, '03', '11', '25'),
        T_ACT(6844331, '03', '11', '25'),
        T_ACT(6844333, '03', '11', '25'),
        T_ACT(6886511, '03', '11', '25'),
        T_ACT(6891001, '03', '11', '25'),
        T_ACT(6891834, '03', '11', '25'),
        T_ACT(6934328, '03', '11', '25'),
        T_ACT(6950332, '03', '11', '25'),
        T_ACT(6950333, '03', '11', '25'),
        T_ACT(6950334, '03', '11', '25'),
        T_ACT(6957221, '03', '11', '25'),
        T_ACT(6962199, '03', '11', '25'),
        T_ACT(6962200, '03', '11', '25'),
        T_ACT(6811603, '01', '11', '032'),
        T_ACT(6811604, '01', '11', '032'),
        T_ACT(6811605, '01', '11', '032'),
        T_ACT(6811606, '01', '11', '032'),
        T_ACT(6811607, '01', '11', '032'),
        T_ACT(6811608, '01', '11', '032'),
        T_ACT(6811609, '01', '11', '032'),
        T_ACT(6811610, '01', '11', '032'),
        T_ACT(6811611, '01', '11', '032'),
        T_ACT(6811612, '01', '11', '032'),
        T_ACT(6811613, '01', '11', '032'),
        T_ACT(6811614, '01', '11', '032'),
        T_ACT(6811615, '01', '11', '032'),
        T_ACT(6811616, '01', '11', '032'),
        T_ACT(6811617, '01', '11', '032'),
        T_ACT(6811618, '01', '11', '032'),
        T_ACT(6811619, '01', '11', '032'),
        T_ACT(6811620, '01', '11', '032'),
        T_ACT(6811621, '01', '11', '032'),
        T_ACT(6811622, '01', '11', '032'),
        T_ACT(6811623, '01', '11', '032'),
        T_ACT(6889261, '01', '11', '032'),
        T_ACT(6889262, '01', '11', '032'),
        T_ACT(6889263, '01', '11', '032'),
        T_ACT(6889264, '01', '11', '032'),
        T_ACT(6889265, '01', '11', '032'),
        T_ACT(6889266, '01', '11', '032'),
        T_ACT(6889267, '01', '11', '032'),
        T_ACT(6889268, '01', '11', '032'),
        T_ACT(6889269, '01', '11', '032'),
        T_ACT(6889270, '01', '11', '032')
    );
    V_TMP_ACT T_ACT;

    PL_OUTPUT VARCHAR2(32000 CHAR);

BEGIN
    
    PL_OUTPUT := '[INICIO]' || CHR(10);

    FOR I IN V_ARRAY.FIRST .. V_ARRAY.LAST
    LOOP

        V_TMP_ACT := V_ARRAY(I);

        V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_ACTIVO ACT 
            SET ACT.DD_CRA_ID = (SELECT DD_CRA_ID FROM '||V_ESQUEMA||'.DD_CRA_CARTERA WHERE DD_CRA_CODIGO = '''||V_TMP_ACT(3)||''')
                , ACT.DD_SCR_ID = (SELECT DD_SCR_ID FROM '||V_ESQUEMA||'.DD_SCR_SUBCARTERA WHERE DD_SCR_CODIGO = '''||V_TMP_ACT(4)||''')
                , ACT.USUARIOMODIFICAR = '''||V_USUARIO||''', ACT.FECHAMODIFICAR = SYSDATE
            WHERE ACT.ACT_NUM_ACTIVO = '||V_TMP_ACT(1)||' AND 
                ACT.DD_CRA_ID = (SELECT DD_CRA_ID FROM '||V_ESQUEMA||'.DD_CRA_CARTERA WHERE DD_CRA_CODIGO = '''||V_TMP_ACT(2)||''')
                AND ACT.BORRADO = 0';
        EXECUTE IMMEDIATE V_MSQL;

        IF SQL%ROWCOUNT = 1 THEN
            EXECUTE IMMEDIATE 'SELECT CRA.DD_CRA_DESCRIPCION, CRA2.DD_CRA_DESCRIPCION, SCR.DD_SCR_DESCRIPCION
                FROM '||V_ESQUEMA||'.DD_CRA_CARTERA CRA
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA2 ON CRA2.DD_CRA_CODIGO = '''||V_TMP_ACT(3)||'''
                JOIN '||V_ESQUEMA||'.DD_SCR_SUBCARTERA SCR ON SCR.DD_SCR_CODIGO = '''||V_TMP_ACT(4)||'''
                WHERE CRA.DD_CRA_CODIGO = '''||V_TMP_ACT(2)||'''' INTO V_CRA_DESC, V_CRA_DES2, V_SCR_DESC;
            PL_OUTPUT := PL_OUTPUT || ' [INFO] Activo ' || V_TMP_ACT(1) || ' cambiado de la cartera ' || V_CRA_DESC 
                || ' a la cartera ' || V_CRA_DES2 || ' y subcartera ' || V_SCR_DESC || CHR(10);
        END IF;
        
    END LOOP;

    PL_OUTPUT := PL_OUTPUT || '[FIN]' || CHR(10);

    COMMIT;

    DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
    
EXCEPTION
    WHEN OTHERS THEN
        PL_OUTPUT := PL_OUTPUT || '[ERROR] Se ha producido un error en la ejecución: ' || TO_CHAR(SQLCODE) || CHR(10);
        PL_OUTPUT := PL_OUTPUT || '-----------------------------------------------------------' || CHR(10);
        PL_OUTPUT := PL_OUTPUT || SQLERRM || CHR(10);
        DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
        ROLLBACK;
        RAISE;
END;
/
EXIT;