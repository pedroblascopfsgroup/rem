--/*
--##########################################
--## AUTOR=DAP
--## FECHA_CREACION=20180625
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=2.0.18
--## INCIDENCIA_LINK=REMVIP-1130
--## PRODUCTO=NO
--## Finalidad: Stored Procedure que actualiza la situacion comercial de los activos en REM.
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##########################################
--*/
--Para permitir la visualizaci√≥n de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE

  V_MSQL VARCHAR2(4000 CHAR);
  V_ESQUEMA VARCHAR2(30 CHAR) := '#ESQUEMA#';
  V_ESQUEMA_M VARCHAR2(30 CHAR) := '#ESQUEMA_MASTER#';
  V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-1130';

BEGIN

  DBMS_OUTPUT.PUT_LINE('[INICIO]');

  V_MSQL := 'TRUNCATE TABLE '||V_ESQUEMA||'.TMP_ACT_SCM';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla auxiliar truncada.');

  V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.TMP_ACT_SCM (ACT_ID, DD_SCM_ID_OLD, DD_SCM_ID_NEW, FECHA_CALCULO)
    SELECT ACT.ACT_ID, ACT.DD_SCM_ID, SCM.DD_SCM_ID, SYSDATE 
    FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
    JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_CODIGO = ''02''
    WHERE ACT.BORRADO = 0 AND ACT.DD_SCM_ID = 3';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla auxiliar cargada ('||SQL%ROWCOUNT||').');

  V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.TMP_ACT_SCM ACT 
    USING (
        SELECT ACT.ACT_ID, ACT.DD_SCM_ID AS SIT_ACTUAL, SCM.DD_SCM_ID AS SIT_NUEVA
        FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
        JOIN '||V_ESQUEMA||'.DD_TCO_TIPO_COMERCIALIZACION TCO ON TCO.DD_TCO_CODIGO = ''03'' AND TCO.DD_TCO_ID = ACT.DD_TCO_ID
        JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_CODIGO = ''07''
        WHERE ACT.BORRADO = 0
        ) TMP
    ON (ACT.ACT_ID = TMP.ACT_ID)
    WHEN MATCHED THEN UPDATE SET
        ACT.DD_SCM_ID_NEW = TMP.SIT_NUEVA,
        ACT.FECHA_CALCULO = SYSDATE
    WHERE ACT.DD_SCM_ID_NEW != TMP.SIT_NUEVA';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla auxiliar actualizada ('||SQL%ROWCOUNT||'). Disponible alquiler.');

  V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.TMP_ACT_SCM ACT 
    USING (
        SELECT ACT.ACT_ID, ACT.DD_SCM_ID AS SIT_ACTUAL, SCM.DD_SCM_ID AS SIT_NUEVA
        FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
        JOIN '||V_ESQUEMA||'.DD_TCO_TIPO_COMERCIALIZACION TCO ON TCO.DD_TCO_CODIGO = ''01'' AND TCO.DD_TCO_ID = ACT.DD_TCO_ID
        JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_CODIGO = ''02''
        WHERE ACT.BORRADO = 0
        ) TMP
    ON (ACT.ACT_ID = TMP.ACT_ID)
    WHEN MATCHED THEN UPDATE SET
        ACT.DD_SCM_ID_NEW = TMP.SIT_NUEVA,
        ACT.FECHA_CALCULO = SYSDATE
    WHERE ACT.DD_SCM_ID_NEW != TMP.SIT_NUEVA';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla auxiliar actualizada ('||SQL%ROWCOUNT||'). Disponible venta.');

  V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.TMP_ACT_SCM ACT 
    USING (
        SELECT ACT.ACT_ID, ACT.DD_SCM_ID AS SIT_ACTUAL, SCM.DD_SCM_ID AS SIT_NUEVA
        FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
        JOIN '||V_ESQUEMA||'.DD_TCO_TIPO_COMERCIALIZACION TCO ON TCO.DD_TCO_CODIGO = ''02'' AND TCO.DD_TCO_ID = ACT.DD_TCO_ID
        JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_CODIGO = ''08''
        WHERE ACT.BORRADO = 0
        ) TMP
    ON (ACT.ACT_ID = TMP.ACT_ID)
    WHEN MATCHED THEN UPDATE SET
        ACT.DD_SCM_ID_NEW = TMP.SIT_NUEVA,
        ACT.FECHA_CALCULO = SYSDATE
    WHERE ACT.DD_SCM_ID_NEW != TMP.SIT_NUEVA';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla auxiliar actualizada ('||SQL%ROWCOUNT||'). Disponible venta-alquiler.');

  V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.TMP_ACT_SCM ACT 
    USING (
        SELECT DISTINCT ACT.ACT_ID, ACT.DD_SCM_ID AS SIT_ACTUAL, SCM.DD_SCM_ID AS SIT_NUEVA, VISTA.ES_CONDICIONADO
        FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
        JOIN '||V_ESQUEMA||'.TMP_ACT_SCM TMP ON TMP.ACT_ID = ACT.ACT_ID
        JOIN '||V_ESQUEMA||'.V_COND_DISPONIBILIDAD VISTA ON VISTA.ACT_ID = TMP.ACT_ID
        JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_CODIGO = ''09''
        WHERE VISTA.ES_CONDICIONADO = 1 AND ACT.BORRADO = 0
        ) TMP
    ON (ACT.ACT_ID = TMP.ACT_ID)
    WHEN MATCHED THEN UPDATE SET
        ACT.DD_SCM_ID_NEW = TMP.SIT_NUEVA,
        ACT.FECHA_CALCULO = SYSDATE
    WHERE ACT.DD_SCM_ID_NEW != TMP.SIT_NUEVA';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla auxiliar actualizada ('||SQL%ROWCOUNT||'). Condicionado.');

  V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.TMP_ACT_SCM ACT 
    USING (
        SELECT DISTINCT ACT.ACT_ID, ACT.DD_SCM_ID AS SIT_ACTUAL, SCM.DD_SCM_ID AS SIT_NUEVA, OFR.DD_EOF_ID
        FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
        JOIN '||V_ESQUEMA||'.ACT_OFR ACTOFR ON ACTOFR.ACT_ID = ACT.ACT_ID
        JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = ACTOFR.OFR_ID AND OFR.BORRADO = 0
        JOIN '||V_ESQUEMA||'.DD_EOF_ESTADOS_OFERTA EOF ON EOF.DD_EOF_CODIGO = ''01'' AND OFR.DD_EOF_ID = EOF.DD_EOF_ID
        JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_CODIGO = ''03''
        WHERE ACT.BORRADO = 0
        ) TMP
    ON (ACT.ACT_ID = TMP.ACT_ID)
    WHEN MATCHED THEN UPDATE SET
        ACT.DD_SCM_ID_NEW = TMP.SIT_NUEVA,
        ACT.FECHA_CALCULO = SYSDATE
    WHERE ACT.DD_SCM_ID_NEW != TMP.SIT_NUEVA';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla auxiliar actualizada ('||SQL%ROWCOUNT||'). Disponible venta con oferta.');

  V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.TMP_ACT_SCM ACT 
    USING (
        SELECT DISTINCT ACT.ACT_ID, ACT.DD_SCM_ID AS SIT_ACTUAL, SCM.DD_SCM_ID AS SIT_NUEVA, RES.DD_ERE_ID
        FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
        JOIN '||V_ESQUEMA||'.ACT_OFR ACTOFR ON ACTOFR.ACT_ID = ACT.ACT_ID
        JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = ACTOFR.OFR_ID AND OFR.BORRADO=0
        JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID AND ECO.BORRADO=0
        JOIN '||V_ESQUEMA||'.RES_RESERVAS RES ON RES.ECO_ID = ECO.ECO_ID AND RES.BORRADO=0
        JOIN '||V_ESQUEMA||'.DD_ERE_ESTADOS_RESERVA ERE ON ERE.DD_ERE_CODIGO = ''02'' AND ERE.DD_ERE_ID = RES.DD_ERE_ID
        JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_CODIGO = ''04''
        WHERE ECO.DD_EEC_ID <> (SELECT DD_EEC_ID FROM '||V_ESQUEMA||'.DD_EEC_EST_EXP_COMERCIAL WHERE DD_EEC_CODIGO = ''01'')
        AND ACT.BORRADO = 0
        ) TMP
    ON (ACT.ACT_ID = TMP.ACT_ID)
    WHEN MATCHED THEN UPDATE SET
        ACT.DD_SCM_ID_NEW = TMP.SIT_NUEVA,
        ACT.FECHA_CALCULO = SYSDATE
    WHERE ACT.DD_SCM_ID_NEW != TMP.SIT_NUEVA';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla auxiliar actualizada ('||SQL%ROWCOUNT||'). Disponible venta con reserva.');

  V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.TMP_ACT_SCM ACT 
    USING (
        SELECT DISTINCT ACT.ACT_ID, ACT.DD_SCM_ID AS SIT_ACTUAL, SCM.DD_SCM_ID AS SIT_NUEVA, PAC.PAC_CHECK_COMERCIALIZAR
        FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
        JOIN '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID AND PAC.BORRADO=0
        JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_CODIGO = ''01''
        WHERE PAC.PAC_CHECK_COMERCIALIZAR = 0 AND ACT.BORRADO = 0
        ) TMP
    ON (ACT.ACT_ID = TMP.ACT_ID)
    WHEN MATCHED THEN UPDATE SET
        ACT.DD_SCM_ID_NEW = TMP.SIT_NUEVA,
        ACT.FECHA_CALCULO = SYSDATE
    WHERE ACT.DD_SCM_ID_NEW != TMP.SIT_NUEVA';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla auxiliar actualizada ('||SQL%ROWCOUNT||'). No comercializable.');

  V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.TMP_ACT_SCM ACT 
    USING (
        SELECT DISTINCT ACT.ACT_ID, ACT.DD_SCM_ID AS SIT_ACTUAL, SCM.DD_SCM_ID AS SIT_NUEVA, ECO.ECO_FECHA_VENTA
        FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
        JOIN '||V_ESQUEMA||'.ACT_OFR ACTOFR ON ACTOFR.ACT_ID = ACT.ACT_ID
        JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = ACTOFR.OFR_ID AND OFR.BORRADO=0
        JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = ACTOFR.OFR_ID AND ECO.BORRADO=0
        JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_CODIGO = ''05''
        WHERE ECO.ECO_FECHA_VENTA IS NOT NULL AND ACT.BORRADO = 0
        ) TMP
    ON (ACT.ACT_ID = TMP.ACT_ID)
    WHEN MATCHED THEN UPDATE SET
        ACT.DD_SCM_ID_NEW = TMP.SIT_NUEVA,
        ACT.FECHA_CALCULO = SYSDATE
    WHERE ACT.DD_SCM_ID_NEW != TMP.SIT_NUEVA';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla auxiliar actualizada ('||SQL%ROWCOUNT||'). Vendido.');

  V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.TMP_ACT_SCM ACT 
    USING (
        SELECT DISTINCT ACT.ACT_ID, ACT.DD_SCM_ID AS SIT_ACTUAL, SCM.DD_SCM_ID AS SIT_NUEVA, ACT.ACT_VENTA_EXTERNA_FECHA
        FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
        JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_CODIGO = ''05''
        WHERE ACT.ACT_VENTA_EXTERNA_FECHA IS NOT NULL AND ACT.BORRADO = 0
        ) TMP
    ON (ACT.ACT_ID = TMP.ACT_ID)
    WHEN MATCHED THEN UPDATE SET
        ACT.DD_SCM_ID_NEW = TMP.SIT_NUEVA,
        ACT.FECHA_CALCULO = SYSDATE
    WHERE ACT.DD_SCM_ID_NEW != TMP.SIT_NUEVA';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla auxiliar actualizada ('||SQL%ROWCOUNT||'). Vendido 2.');

  V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_ACTIVO ACT 
    USING (
        SELECT DISTINCT TMP.ACT_ID, TMP.DD_SCM_ID_NEW AS SIT_NUEVA
        FROM '||V_ESQUEMA||'.TMP_ACT_SCM TMP
        JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON TMP.ACT_ID = ACT.ACT_ID
        WHERE (TMP.DD_SCM_ID_NEW != TMP.DD_SCM_ID_OLD
                OR TMP.DD_SCM_ID_OLD IS NULL)
            AND TMP.BORRADO = 0
            AND ACT.BORRADO = 0
        ) TMP
    ON (ACT.ACT_ID = TMP.ACT_ID)
    WHEN MATCHED THEN UPDATE SET
        ACT.DD_SCM_ID = TMP.SIT_NUEVA,
        ACT.USUARIOMODIFICAR = '''||V_USUARIO||''',
        ACT.FECHAMODIFICAR = SYSDATE
    WHERE ACT.DD_SCM_ID IS NULL OR ACT.DD_SCM_ID != TMP.SIT_NUEVA';
  EXECUTE IMMEDIATE V_MSQL;
  DBMS_OUTPUT.PUT_LINE('  [INFO] Tabla activos actualizada ('||SQL%ROWCOUNT||').');

  COMMIT;

  DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion: '||TO_CHAR(SQLCODE));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------');
    DBMS_OUTPUT.put_line(SQLERRM);
    ROLLBACK;
    RAISE;
END;
/
EXIT