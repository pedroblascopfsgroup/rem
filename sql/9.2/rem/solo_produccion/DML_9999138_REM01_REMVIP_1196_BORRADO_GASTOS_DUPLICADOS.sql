--/*
--##########################################
--## AUTOR=REMUS OVIDIU VIOREL
--## FECHA_CREACION=20180702
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-1196
--## PRODUCTO=NO
--##
--## Finalidad: BORRAR GASTOS DUPLICADOS DE LA TABLA GIC_GASTOS_INFO_CONTABILIDAD
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

  V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01';-- '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  ERR_NUM NUMBER;-- Numero de errores
  ERR_MSG VARCHAR2(2048);-- Mensaje de error
  V_MSQL VARCHAR2(4000 CHAR);
  V_STMT_VAL VARCHAR2(4000 CHAR);
  CANTIDAD_INSERCIONES NUMBER (16);
  V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-1196';

  BEGIN

	--BORRADO GASTOS DUPLICADOS EN GIC NO SAREB

	V_MSQL := 'UPDATE '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD TABLAGIC 
	SET BORRADO = ''1'',
	TABLAGIC.USUARIOMODIFICAR = '''||V_USUARIO||''',  
	TABLAGIC.FECHAMODIFICAR = SYSDATE 
	WHERE EXISTS (
	    SELECT GIC_ID, RN
	    FROM (
		WITH CARTERA AS (
		    SELECT DISTINCT GAC.GPV_ID, CRA.DD_CRA_ID
		    FROM '||V_ESQUEMA||'.GPV_ACT GAC
		    JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = GAC.ACT_ID
		    JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.DD_CRA_CODIGO NOT IN (''02'',''61'')
		    )
		, DUPLICADOS AS (
		    SELECT GIC.GPV_ID
		    FROM '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD GIC 
		    JOIN '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV ON GIC.GPV_ID = GPV.GPV_ID
		    JOIN CARTERA CRA ON CRA.GPV_ID = GPV.GPV_ID
		    WHERE GIC.BORRADO = 0 
		    GROUP BY GIC.GPV_ID
		    HAVING COUNT(1) > 1
		    )
		SELECT GIC.GIC_ID, GPV.GPV_ID, ROW_NUMBER() OVER(PARTITION BY GPV.GPV_ID ORDER BY GIC.GIC_ID) RN
		FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV
		JOIN '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
		JOIN CARTERA CRA ON CRA.GPV_ID = GPV.GPV_ID
		JOIN DUPLICADOS DUP ON DUP.GPV_ID = GIC.GPV_ID
		) GIC 
		WHERE GIC.GIC_ID = TABLAGIC.GIC_ID AND GIC.RN > 1
		    )';
 	
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han BORRADO '||sql%rowcount||' GASTOS no sareb en '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD');


	--CREATE TABLE

	V_MSQL := 'CREATE TABLE GASTOS_DUPLICADOS_GIC AS 
	WITH CARTERA AS (
	    SELECT DISTINCT GAC.GPV_ID, CRA.DD_CRA_ID
	    FROM '||V_ESQUEMA||'.GPV_ACT GAC
	    JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = GAC.ACT_ID
	    JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.DD_CRA_CODIGO IN (''02'',''61'')
	    )
	SELECT GIC.GPV_ID, GIC.GIC_FECHA_DEVENGO_ESPECIAL
	FROM '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD GIC 
	JOIN '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV ON GIC.GPV_ID = GPV.GPV_ID
	JOIN CARTERA CRA ON CRA.GPV_ID = GPV.GPV_ID
	WHERE GIC.BORRADO = 0 
	GROUP BY GIC.GPV_ID, GIC.GIC_FECHA_DEVENGO_ESPECIAL
	HAVING COUNT(1) > 1';

	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han creado la tabla GASTOS_DUPLICADOS_GIC');


	--BORRADO GASTOS DUPLICADOS EN GIC SAREB
	
	V_MSQL := 'UPDATE '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD TABLAGIC 
	SET BORRADO = ''1'',
	TABLAGIC.USUARIOMODIFICAR = '''||V_USUARIO||''',  
	TABLAGIC.FECHAMODIFICAR = SYSDATE  
	WHERE EXISTS (
		SELECT 1 
		FROM '||V_ESQUEMA||'.GASTOS_DUPLICADOS_GIC GDG 
		WHERE GDG.GPV_ID = TABLAGIC.GPV_ID 
	)';

	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han BORRADO '||sql%rowcount||' GASTOS sareb en '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD');

	--INSERTAR GASTOS EN GIC SAREB

	V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD 
	(GIC_ID,
	GPV_ID,
	EJE_ID,
	GIC_FECHA_DEVENGO_ESPECIAL,
	USUARIOCREAR,
	FECHACREAR,
	GIC_CUENTA_CONTABLE_ESP,
	GIC_PTDA_PRESUPUESTARIA_ESP)
	SELECT '||V_ESQUEMA||'.S_GIC_GASTOS_INFO_CONTABILIDAD.NEXTVAL
	  	, GPV.GPV_ID AS GPV_ID 
		, EJE.EJE_ID AS EJE_ID 
		, GDP.GIC_FECHA_DEVENGO_ESPECIAL
		, '''||V_USUARIO||''' AS USUARIOCREAR 
		, SYSDATE AS FECHACREAR
		, CCC.CCC_CUENTA_CONTABLE      
		, CPP.CPP_PARTIDA_PRESUPUESTARIA
	FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV 
	JOIN '||V_ESQUEMA||'.GPV_ACT ON GPV_ACT.GPV_ID = GPV.GPV_ID
	JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON GPV_ACT.ACT_ID = ACT.ACT_ID
	JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON ACT.DD_CRA_ID = CRA.DD_CRA_ID AND CRA.DD_CRA_CODIGO IN (''02'',''61'')
	JOIN '||V_ESQUEMA||'.GASTOS_DUPLICADOS_GIC GDP ON GDP.GPV_ID = GPV.GPV_ID
	LEFT JOIN '||V_ESQUEMA||'.ACT_EJE_EJERCICIO EJE ON EJE.EJE_ANYO = TO_CHAR(GPV.GPV_FECHA_EMISION,''YYYY'')
	LEFT JOIN '||V_ESQUEMA||'.CCC_CONFIG_CTAS_CONTABLES CCC on GPV.DD_STG_ID = CCC.DD_STG_ID AND CCC.EJE_ID  = EJE.EJE_ID AND NVL(CCC.CCC_ARRENDAMIENTO,0) = 0 AND CRA.DD_CRA_ID = CCC.DD_CRA_ID 
	LEFT JOIN '||V_ESQUEMA||'.CPP_CONFIG_PTDAS_PREP CPP on GPV.DD_STG_ID = CPP.DD_STG_ID AND CPP.EJE_ID  = EJE.EJE_ID AND NVL(CPP.CPP_ARRENDAMIENTO,0) = 0 AND CRA.DD_CRA_ID = CPP.DD_CRA_ID';

	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han INSERTADO '||sql%rowcount||' GASTOS en '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD');

	--DROP GASTOS_DUPLICADOS_GIC

	V_MSQL := 'DROP TABLE GASTOS_DUPLICADOS_GIC';

	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] Se ha borrado la tabla auxiliar GASTOS_DUPLICADOS_GIC');

	COMMIT;
	

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      DBMS_OUTPUT.PUT_LINE(V_MSQL);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
