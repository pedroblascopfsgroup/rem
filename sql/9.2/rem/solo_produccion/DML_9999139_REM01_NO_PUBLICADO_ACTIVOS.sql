--/*
--#########################################
--## AUTOR=SIMEON SHOPOV
--## FECHA_CREACION=20180703
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.17
--## INCIDENCIA_LINK=REMVIP-1235
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; --'#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; --'#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(25 CHAR):= 'ACT_ACTIVO';
    --V_COUNT NUMBER(16); -- Vble. para contar.
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USUARIO VARCHAR2(32 CHAR):= 'REMVIP-1235';

	ACT_NUM_ACTIVO VARCHAR2(55 CHAR);

    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
		  T_JBV(5950944)
		, T_JBV(5938896)
		, T_JBV(5946369)
		, T_JBV(5967493)
		, T_JBV(6788380)
		, T_JBV(5946466)
		, T_JBV(5929865)
		, T_JBV(5961990)
		, T_JBV(5933944)
		, T_JBV(6044840)
		, T_JBV(5951130)
		, T_JBV(5926772)
		, T_JBV(5959244)
		, T_JBV(5945641)
		, T_JBV(5970012)
		, T_JBV(5932690)
		, T_JBV(5928605)
		, T_JBV(5962222)
		, T_JBV(5938679)
		, T_JBV(5925037)
		, T_JBV(5931131)
		, T_JBV(5958061)
		, T_JBV(5934453)
		, T_JBV(5951317)
		, T_JBV(6059933)
		, T_JBV(5965590)
		, T_JBV(5950104)
		, T_JBV(5971650)
		, T_JBV(5936977)
		, T_JBV(6063331)
		, T_JBV(5949065)
		, T_JBV(5930828)
		, T_JBV(5966806)
		, T_JBV(5959211)
		, T_JBV(5944416)
		, T_JBV(5944015)
		, T_JBV(5949086)
		, T_JBV(5953134)
		, T_JBV(5928675)
		, T_JBV(6128419)
		, T_JBV(5959242)
		, T_JBV(5947500)
		, T_JBV(5924931)
		, T_JBV(5942833)
		, T_JBV(5969245)
		, T_JBV(5950543)
		, T_JBV(6058875)
		, T_JBV(5941869)
		, T_JBV(5936307)
		, T_JBV(5959599)
		, T_JBV(5962084)
		, T_JBV(5934706)
		, T_JBV(5927769)
		, T_JBV(5951029)
		, T_JBV(5939266)
		, T_JBV(5950132)
		, T_JBV(5932392)
		, T_JBV(5932265)
		, T_JBV(5965128)
		, T_JBV(5958366)
		, T_JBV(5928002)
		, T_JBV(6061333)
		, T_JBV(5932746)
		, T_JBV(5950199)
		, T_JBV(5968138)
		, T_JBV(5931388)
		, T_JBV(5960659)
		, T_JBV(5948370)
		, T_JBV(6062568)
		, T_JBV(6058442)
		, T_JBV(5948243)
		, T_JBV(5953060)
		, T_JBV(5949867)
		, T_JBV(5944577)
		, T_JBV(5945748)
		, T_JBV(5953481)
		, T_JBV(5956636)
		, T_JBV(5938125)
		, T_JBV(5934687)
		, T_JBV(5927125)
		, T_JBV(5957973)
		, T_JBV(5929003)
		, T_JBV(5928775)
		, T_JBV(6709709)
		, T_JBV(5965396)
		, T_JBV(5937878)
		, T_JBV(5939807)
		, T_JBV(5940232)
		, T_JBV(5940415)
		, T_JBV(6055227)
		, T_JBV(5964572)
		, T_JBV(5940373)
		, T_JBV(5941998)
		, T_JBV(5968343)
		, T_JBV(6045060)
		, T_JBV(5970450)
		, T_JBV(5935772)
		, T_JBV(5952084)
		, T_JBV(5969985)
		, T_JBV(5947677)
		, T_JBV(5934409)
		, T_JBV(5960945)
		, T_JBV(5929990)
		, T_JBV(5939024)
		, T_JBV(5965329)
		, T_JBV(5963002)
		, T_JBV(5959977)
		, T_JBV(6057755)
		, T_JBV(5953973)
		, T_JBV(5941570)
		, T_JBV(5953482)
		, T_JBV(5928032)
		, T_JBV(5963357)
		, T_JBV(6063483)
		, T_JBV(6060659)
		, T_JBV(5943848)
		, T_JBV(5969486)
		, T_JBV(6062476)
		, T_JBV(5950336)
		, T_JBV(5926406)
		, T_JBV(5929425)
		, T_JBV(6060763)
		, T_JBV(5945244)
		, T_JBV(5927767)
		, T_JBV(5945528)
		, T_JBV(5944177)
		, T_JBV(5942699)
		, T_JBV(5969938)
		, T_JBV(5947910)
		, T_JBV(5930452)
		, T_JBV(5942911)
		, T_JBV(5961004)
		, T_JBV(5950221)
		, T_JBV(6058267)
		, T_JBV(5949645)
		, T_JBV(5946638)
		, T_JBV(5943897)
		, T_JBV(5940165)
		, T_JBV(5965098)
		, T_JBV(5962669)
		, T_JBV(5947476)
		, T_JBV(5944473)
		, T_JBV(5968272)
		, T_JBV(6520451)
		, T_JBV(5963413)
		, T_JBV(5953442)
		, T_JBV(5936971)
		, T_JBV(5949138)
		, T_JBV(5947491)
		, T_JBV(5932613)
		, T_JBV(5928136)
		, T_JBV(5932419)
		, T_JBV(5925896)
		, T_JBV(5969563)
		, T_JBV(5953356)
		, T_JBV(5938110)
		, T_JBV(5969256)
		, T_JBV(5959638)
		, T_JBV(5945248)
		, T_JBV(5960573)
		, T_JBV(5925731)
		, T_JBV(5941798)
		, T_JBV(5950031)
		, T_JBV(5943593)
		, T_JBV(5966155)
		, T_JBV(5950133)
		, T_JBV(5969492)
		, T_JBV(5928071)
		, T_JBV(5943098)
		, T_JBV(6711593)
		, T_JBV(5947881)
		, T_JBV(5942300)
		, T_JBV(5941410)
		, T_JBV(5925399)
		, T_JBV(6054388)
		, T_JBV(5955477)
		, T_JBV(5940829)
		, T_JBV(5946613)
		, T_JBV(5958758)
		, T_JBV(5964536)
		, T_JBV(5951626)
		, T_JBV(5945259)
		, T_JBV(5936029)
		, T_JBV(5940255)
		, T_JBV(5946150)
		, T_JBV(5962998)
		, T_JBV(5948599)
		, T_JBV(5947645)
		, T_JBV(5932577)
		, T_JBV(5929317)
		, T_JBV(5941565)
		, T_JBV(5955317)
		, T_JBV(5949592)
		, T_JBV(5964426)
		, T_JBV(5966829)
		, T_JBV(6061498)
		, T_JBV(5953637)
		, T_JBV(5967034)
		, T_JBV(5924949)
		, T_JBV(5946568)
		, T_JBV(5959190)
		, T_JBV(5936195)
		, T_JBV(5945746)
		, T_JBV(5928133)
		, T_JBV(5940758)
		, T_JBV(5963484)
		, T_JBV(5938253)
		, T_JBV(5959432)
		, T_JBV(5927822)
		, T_JBV(5953948)
		, T_JBV(5945243)
		, T_JBV(5963815)
		, T_JBV(5930319)
		, T_JBV(5933105)
		, T_JBV(5943464)
		, T_JBV(5942381)
		, T_JBV(5936894)
		, T_JBV(5954348)
		, T_JBV(5965419)
		, T_JBV(5952446)
		, T_JBV(5951136)
		, T_JBV(5933447)
		, T_JBV(5940730)
		, T_JBV(5958857)
		, T_JBV(5962047)
		, T_JBV(5934312)
		, T_JBV(5956513)
		, T_JBV(5941880)
		, T_JBV(5967754)
		, T_JBV(5965835)
		, T_JBV(5952106)
		, T_JBV(5952511)
		, T_JBV(5927413)
		, T_JBV(5967610)
		, T_JBV(5927804)
		, T_JBV(5951708)
		, T_JBV(5938677)
		, T_JBV(6063412)
		, T_JBV(5951098)
		, T_JBV(5948235)
		, T_JBV(5925086)
		, T_JBV(5957683)
		, T_JBV(5951919)
		, T_JBV(5953830)
		, T_JBV(5925950)
		, T_JBV(5950368)
		, T_JBV(5931582)
		, T_JBV(5963592)
		, T_JBV(5958828)
		, T_JBV(5955892)
		, T_JBV(5934796)
		, T_JBV(5963897)
		, T_JBV(5944723)
		, T_JBV(5954347)
		, T_JBV(5947597)
		, T_JBV(5945604)
		, T_JBV(5942494)
		, T_JBV(5934188)
		, T_JBV(5942936)
		, T_JBV(5925696)
		, T_JBV(5932425)
		, T_JBV(5927381)
		, T_JBV(5970005)
		, T_JBV(5964943)
		, T_JBV(5930728)
		, T_JBV(5925910)
		, T_JBV(5953694)
		, T_JBV(5935079)
		, T_JBV(5967981)
		, T_JBV(5926567)
		, T_JBV(5953069)
		, T_JBV(5926373)
		, T_JBV(5925210)
		, T_JBV(5958989)
		, T_JBV(5951884)
		, T_JBV(5949537)
		, T_JBV(5929973)
		, T_JBV(5962725)
		, T_JBV(5967930)
		, T_JBV(5937787)
		, T_JBV(5964901)
		, T_JBV(5931276)
		, T_JBV(5931849)
		, T_JBV(5950956)
		, T_JBV(5957354)
		, T_JBV(5932197)
		, T_JBV(5935362)
		, T_JBV(5947448)
		, T_JBV(5929685)
		, T_JBV(5929457)
		, T_JBV(5927508)
		, T_JBV(5933694)
		, T_JBV(5949022)
		, T_JBV(5941856)
		, T_JBV(5927862)
		, T_JBV(5970121)
		, T_JBV(5947289)
		, T_JBV(5969218)
		, T_JBV(5945163)
		, T_JBV(5944634)
		, T_JBV(5935210)
		, T_JBV(5941228)
		, T_JBV(5966613)
		, T_JBV(5966597)
		, T_JBV(5964195)
		, T_JBV(5950692)
		, T_JBV(5970468)
		, T_JBV(5925033)
		, T_JBV(5959387)
		, T_JBV(6045078)
		, T_JBV(5952463)
		, T_JBV(5937051)
		, T_JBV(5962492)
		, T_JBV(5952150)
		, T_JBV(5962440)
		, T_JBV(5963127)
		, T_JBV(5944510)
		, T_JBV(5964939)
		, T_JBV(5957339)
		, T_JBV(5937564)
		, T_JBV(5940513)
		, T_JBV(6062549)
	); 
V_TMP_JBV T_JBV;
BEGIN


 
 FOR I IN V_JBV.FIRST .. V_JBV.LAST
 LOOP
 
 V_TMP_JBV := V_JBV(I);
 			  ACT_NUM_ACTIVO := TRIM(V_TMP_JBV(1));
			
		V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET
					 DD_EPU_ID = (SELECT DD_EPU_ID FROM '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION WHERE DD_EPU_CODIGO = ''06'')
				   , USUARIOMODIFICAR = '''||V_USUARIO||'''
				   , FECHAMODIFICAR = SYSDATE
				   WHERE ACT_NUM_ACTIVO = '''||ACT_NUM_ACTIVO||'''
					';
		EXECUTE IMMEDIATE V_SQL;
		
		IF SQL%ROWCOUNT > 0 THEN
					DBMS_OUTPUT.PUT_LINE('Puesto el estado de publicación a no publicado del activo con ID_HAYA = '||ACT_NUM_ACTIVO);
					V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
				END IF;
		
		V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION SET
				     USUARIOMODIFICAR = '''||V_USUARIO||'''
				   , FECHAMODIFICAR = SYSDATE
				   , HEP_FECHA_HASTA = SYSDATE
				   WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||')
				   AND HEP_FECHA_HASTA IS NULL
					';
		EXECUTE IMMEDIATE V_SQL;
		
		IF SQL%ROWCOUNT > 0 THEN
					DBMS_OUTPUT.PUT_LINE('Puesta la fecha hasta a SYSDATE del activo con ID_HAYA = '||ACT_NUM_ACTIVO);
					V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
				END IF;
		
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION (
					  HEP_ID
					, ACT_ID
					, HEP_FECHA_DESDE
					, DD_POR_ID
					, DD_TPU_ID
					, DD_EPU_ID
					, HEP_MOTIVO
					, USUARIOCREAR
					, FECHACREAR
					) VALUES (
					  '||V_ESQUEMA||'.S_ACT_HEP_HIST_EST_PUBLICACION.NEXTVAL
					, (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||')					
					, SYSDATE
					, (SELECT DD_POR_ID FROM '||V_ESQUEMA||'.DD_POR_PORTAL WHERE DD_POR_CODIGO = ''01'')
					, (SELECT DD_TPU_ID FROM '||V_ESQUEMA||'.DD_TPU_TIPO_PUBLICACION WHERE DD_TPU_CODIGO = ''02'')
					, (SELECT DD_EPU_ID FROM '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION WHERE DD_EPU_CODIGO = ''06'')
					, ''Peticion negocio''
					, '''||V_USUARIO||'''
					, SYSDATE
					)
					';
           
				EXECUTE IMMEDIATE V_SQL;
			
				
				IF SQL%ROWCOUNT > 0 THEN
					DBMS_OUTPUT.PUT_LINE('Insertado el nuevo estado de publicación del activo con ID_HAYA = '||ACT_NUM_ACTIVO);
					V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
				END IF;
 END LOOP;			    
    
	COMMIT;

    DBMS_OUTPUT.PUT_LINE('[INFO] Se hecho en total '||V_COUNT_UPDATE||' updates/inserts');

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE(V_SQL);
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
