--/*
--#########################################
--## AUTOR=DAP
--## FECHA_CREACION=20180718
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-1367
--## PRODUCTO=NO
--## 
--## Finalidad: AJUSTAR PORCENTAJES DE LOS GASTOS DE ACTIVOS           
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_ESQUEMA VARCHAR2(25 CHAR) := '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR) := '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-1367';
    V_NUM_GASTO VARCHAR2(32000 CHAR) := '9651799,9652614,9694742,9698194,9698178,9698201,9719696,9721601,9704937,9702771,9722414,9723267,9720405,9721590,9629208,9612927,9612931,9648804,9663386,9663387,9663403,9663413,9663415,9556236,9601901,9699892,9693203,9620646,9698215,9698212,9676937,9676938,9637206,9651350,9698239,9693262,9676928,9693273,9698848,9676936,9693255,9620642,9693259,9676954,9596162,9676922,9676916,9559330,9485771,9560898,9698243,9663440,9596159,9676949,9451510,9663411,9595955,9625717,9625725,9595991,9560938,9604529,9674255,9676967,9698853,9620644,9674221,9699891,9677022,9615897,9490471,9594619,9699881,9596171,9674220,9556212,9676942,9698220,9596173,9676913,9674244,9625713,9559325,9595949,9620651,9676921,9556178,9595964,9625692,9637209,9560930,9620652,9699890,9615896,9676926,9436019,9701816,9701829,9701791,9701843,9701848,9720398,9720399,9720395,9720394';
    ERR_NUM NUMBER;-- Numero de errores
    ERR_MSG VARCHAR2(2048);-- Mensaje de error
    PL_OUTPUT VARCHAR2(32000 CHAR);

BEGIN

    DBMS_OUTPUT.PUT_LINE('[INICIO] Inicio del proceso cuadre de porcentaje de participación del gasto.');
    
    EXECUTE IMMEDIATE 'MERGE INTO '||V_ESQUEMA||'.GPV_ACT T1
        USING (
            WITH MINIMO AS (
                SELECT GPV.GPV_NUM_GASTO_HAYA, GA.GPV_ID, GA.ACT_ID, ROW_NUMBER() OVER(PARTITION BY GA.GPV_ID ORDER BY NVL(GA.GPV_PARTICIPACION_GASTO,0)) RN
                FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV
                JOIN '||V_ESQUEMA||'.GPV_ACT GA ON GPV.GPV_ID = GA.GPV_ID
                )
            , DIFERENCIA AS (
                SELECT 100 - SUM(GA.GPV_PARTICIPACION_GASTO) GPV_DIFF_PART, GA.GPV_ID
                FROM '||V_ESQUEMA||'.GPV_ACT GA
                GROUP BY GA.GPV_ID
                )
            SELECT MIN.GPV_ID, MIN.ACT_ID, DIF.GPV_DIFF_PART
            FROM MINIMO MIN
            JOIN DIFERENCIA DIF ON DIF.GPV_ID = MIN.GPV_ID
            WHERE MIN.RN = 1 AND 
                MIN.GPV_NUM_GASTO_HAYA IN ('||V_NUM_GASTO||')
            ) T2 ON (T1.GPV_ID = T2.GPV_ID AND T1.ACT_ID = T2.ACT_ID)
        WHEN MATCHED THEN UPDATE SET T1.GPV_PARTICIPACION_GASTO = T1.GPV_PARTICIPACION_GASTO + T2.GPV_DIFF_PART
        WHERE T2.GPV_DIFF_PART <> 0'; 
    
    DBMS_OUTPUT.PUT_LINE('  [INFO] Se han actualizado '||SQL%ROWCOUNT||' gastos en la GPV_ACT');  

    EXECUTE IMMEDIATE 'MERGE INTO '||V_ESQUEMA||'.GGE_GASTOS_GESTION T1
        USING (
            SELECT GPV_ID
            FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV
            WHERE GPV_NUM_GASTO_HAYA IN ('||V_NUM_GASTO||')
            ) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EAH_ID = 3, T1.GGE_FECHA_EAH = SYSDATE, T1.DD_EAP_ID = 1, T1.GGE_FECHA_EAP = NULL, T1.GGE_MOTIVO_RECHAZO_PROP = NULL
            , T1.GGE_FECHA_ENVIO_PRPTRIO = NULL, T1.USUARIOMODIFICAR = '''||V_USUARIO||''', T1.FECHAMODIFICAR = SYSDATE';

    DBMS_OUTPUT.PUT_LINE('  [INFO] Se han actualizado '||SQL%ROWCOUNT||' gastos en la GGE_GASTOS_GESTION'); 

    EXECUTE IMMEDIATE 'MERGE INTO '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR T1
        USING (
            SELECT GPV_ID
            FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV
            WHERE GPV_NUM_GASTO_HAYA IN ('||V_NUM_GASTO||')
            ) T2
        ON (T1.GPV_ID = T2.GPV_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.DD_EGA_ID = 3, T1.USUARIOMODIFICAR = '''||V_USUARIO||''', T1.FECHAMODIFICAR = SYSDATE';    

    DBMS_OUTPUT.PUT_LINE('  [INFO] Se han actualizado '||SQL%ROWCOUNT||' gastos en la GPV_GASTOS_PROVEEDOR'); 
    
    DBMS_OUTPUT.PUT_LINE('[FIN] Fin del proceso de cuadre de porcentaje de participación del gasto.');

    COMMIT;
   
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
        DBMS_OUTPUT.PUT_LINE(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT;
