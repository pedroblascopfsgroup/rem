--/*
--#########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20180726
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-1424
--## PRODUCTO=NO
--## 
--## Finalidad: truncar y borrar datos de tablas para el detecvtor de cambios
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_ESQUEMA VARCHAR2(25 CHAR) := '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR) := '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-1424';
    V_SQL VARCHAR2(4000 CHAR); 
    ERR_NUM NUMBER;-- Numero de errores
    ERR_MSG VARCHAR2(2048);-- Mensaje de error
    PL_OUTPUT VARCHAR2(32000 CHAR);

BEGIN

V_SQL := 'TRUNCATE TABLE '||V_ESQUEMA||'.AWH_AGRUP_ONV_WEBCOM_HIST';

EXECUTE IMMEDIATE V_SQL;

V_SQL := 'TRUNCATE TABLE '||V_ESQUEMA||'.CWH_CABEC_ONV_WEBCOM_HIST';

EXECUTE IMMEDIATE V_SQL;

V_SQL := 'DELETE FROM '||V_ESQUEMA||'.CWH_COMISIONES_WEBCOM_HIST CWH WHERE CWH.ID_COMISION_REM IN (SELECT GEX.GEX_ID FROM '||V_ESQUEMA||'.GEX_GASTOS_EXPEDIENTE GEX WHERE GEX.FECHACREAR > TO_DATE(''23/07/18 15:00:00'',''DD/MM/YY HH24:MI:SS'') OR GEX.FECHAMODIFICAR > TO_DATE(''23/07/18 15:00:00'',''DD/MM/YY HH24:MI:SS''))';

EXECUTE IMMEDIATE V_SQL;

V_SQL := 'DELETE FROM '||V_ESQUEMA||'.OWH_OFERTAS_WEBCOM_HIST OWH WHERE OWH.ID_OFERTA_WEBCOM IN (SELECT OFR.OFR_WEBCOM_ID FROM '||V_ESQUEMA||'.OFR_OFERTAS OFR WHERE FECHACREAR > TO_DATE(''23/07/18 15:00:00'',''DD/MM/YY HH24:MI:SS'') OR FECHAMODIFICAR > TO_DATE(''23/07/18 15:00:00'',''DD/MM/YY HH24:MI:SS''))';

EXECUTE IMMEDIATE V_SQL;

V_SQL := 'DELETE FROM '||V_ESQUEMA||'.PWH_PROVEEDOR_WEBCOM_HIST PWH WHERE PWH.ID_PROVEEDOR_REM IN (SELECT PVE_ID FROM '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR PVE WHERE PVE.FECHACREAR > TO_DATE(''23/07/18 15:00:00'',''DD/MM/YY HH24:MI:SS'') OR PVE.FECHAMODIFICAR > TO_DATE(''23/07/18 15:00:00'',''DD/MM/YY HH24:MI:SS''))';

EXECUTE IMMEDIATE V_SQL;

V_SQL := 'DELETE FROM '||V_ESQUEMA||'.IWH_INFORME_WEBCOM_HIST IWH where ID_ACTIVO_HAYA IN  (SELECT ICO.ACT_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL ICO 
JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ICO.ACT_ID = ACT.ACT_ID 
WHERE ICO.FECHACREAR > TO_DATE(''23/07/18 15:00:00'',''DD/MM/YY HH24:MI:SS'') OR ICO.FECHAMODIFICAR > TO_DATE(''23/07/18 15:00:00'',''DD/MM/YY HH24:MI:SS'') 
OR ACT.FECHACREAR > TO_DATE(''23/07/18 15:00:00'',''DD/MM/YY HH24:MI:SS'') OR ACT.FECHAMODIFICAR > TO_DATE(''23/07/18 15:00:00'',''DD/MM/YY HH24:MI:SS''))';

EXECUTE IMMEDIATE V_SQL;

V_SQL := 'DELETE FROM '||V_ESQUEMA||'.SWH_STOCK_ACT_WEBCOM_HIST SWH WHERE SWH.ID_ACTIVO_HAYA IN (SELECT ACT.ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT WHERE ACT.FECHACREAR > TO_DATE(''23/07/18 15:00:00'',''DD/MM/YY HH24:MI:SS'') OR ACT.FECHAMODIFICAR > TO_DATE(''23/07/18 15:00:00'',''DD/MM/YY HH24:MI:SS''))';

EXECUTE IMMEDIATE V_SQL;


    --DBMS_OUTPUT.PUT_LINE('Se han actualizado '||SQL%ROWCOUNT||' estado reserva');

   COMMIT;

EXCEPTION
    WHEN OTHERS THEN
		DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
		DBMS_OUTPUT.PUT_LINE(SQLERRM);
		ROLLBACK;
		RAISE;

END;
/
EXIT;

