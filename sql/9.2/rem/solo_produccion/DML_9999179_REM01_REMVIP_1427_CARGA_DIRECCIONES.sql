--/*
--##########################################
--## AUTOR=DAP
--## FECHA_CREACION=20180804
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=2.0.18
--## INCIDENCIA_LINK=REMVIP-1427
--## PRODUCTO=no
--##
--## Finalidad: ACTIVOS SIN DIRECCIONES
--## VERSIONES:
--##        0.1 Version inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-1427';
    V_SQL VARCHAR2(32000 CHAR);
    V_ESQUEMA VARCHAR2(30 CHAR) := '#ESQUEMA#';
    V_ESQUEMA_M VARCHAR2(30 CHAR) := '#ESQUEMA_MASTER#';
    PL_OUTPUT VARCHAR2(32000 CHAR);
    ERR_NUM NUMBER(25);
    ERR_MSG VARCHAR2(1024 CHAR);
    V_ACTIVOS VARCHAR2(32000 CHAR) := '6999701,6999728,6999147,6989332,6988312,6998826,6998827,6982216
        ,6982100,6982949,6984008,6990105,6992965,6993059,6997849,6992967,6981948,6990553,6998332,6994718
        ,6979697,6990397,6981999,6982757,6988472,6979851,6994040,6989751,6990235,6999664,6999734,6999377
        ,6999379,6999381,6999702,7001599,6999853,6979670,6980041,6981109,6981741,6982158,6982668,6982766
        ,6982873,6996323,6998307,7002617,6997527,6982480,6980068,6982332,6985085,6989390,6981846,6983310
        ,7001322,6979696,6985626,6999768,6999769,6999767,6999770,6999771,6999772,6999773,6999774,6999742
        ,6979584,6990645,7000882,6992005,6982952,6982953,6999666,6999822,6999857,6983867,6985542,6999817
        ,6997925,6999175,6991435,6985218,6994058,6999847,6980044,6982645,6988804,6991821,6999805,6999758
        ,6981651,6994613,6998654,6980716,6995927,6991419,6990582,6995727,6996792,6980671,6995739,6998915
        ,6980670,6985744,6990238,6989794,6990263,6990265,6990266,6990267,6990268,6990269,6990270,6989792
        ,6989793,6989795,6989796,6989797,6989798,6990079,6985589,6982656,6979850,6980528,6980579,6980580
        ,6980621,6980622,6980623,6980624,6980626,6980625,6980627,6980628,6980581,6996762,6992741,6999850
        ,6987997,6999794,6986050,6995193,6999815,6999704,6987500,7001720,6995353,6990205,6999695,6999852
        ,6999762,6997495,6991361,6984107,6991925,6984929,6999692,6981633,6991295,6999754,6999720,6999176
        ,6997710,6985990,6996827,6992942,6988217,6989218,6992053,6999673,6996194,6990180,6982932,6992209
        ,6993636,6993728,6993702,6993701,6997417,6979654,6981310,6981311,6981578,6981579,6985582,6985645
        ,6985646,6985647,6987973,6988400,6995629,6999731,6988714,6979438,6979623,6979897,6979898,6980040
        ,6980080,6980190,6980195,6980327,6980462,6980463,6980464,6980465,6980540,6980610,6980682,6980687
        ,6980688,6980699,6981216,6981437,6981448,6981488,6981517,6981523,6981549,6981686,6981851,6982404
        ,6982416,6982456,6982759,6982840,6982866,6982888,6982890,6983131,6984570,6984742,6984744,6985103
        ,6985207,6985240,6985524,6985554,6985556,6985999,6986419,6986488,6986554,6987080,6987122,6987464
        ,6987562,6988485,6988539,6988587,6988749,6988823,6989166,6989225,6989717,6989912,6989974,6990044
        ,6990144,6990146,6990443,6990581,6990942,6991188,6991553,6991578,6991849,6992150,6992241,6992887
        ,6992959,6993725,6994273,6994655,6994830,6995334,6996428,6996652,6996677,6996678,6996748,6996771
        ,6997291,6997919,6998573,6998674,6999367,6999382,6999441,6999442,6999662,6999663,6999669,6999700
        ,6999729,7000885,7001357,7001808,7002092,7002378,7002669,6980497,6994931,6985681,6991984,6995411
        ,6994716,6994717,6984743,6985086,6991802,6994719,6996761,6988322,6988205,6992007,6980058,6982162
        ,6981580,6981605,6982622,6985997,6981576,6981577,6985380,6979343,6980017,6980018,6986319,6987774
        ,6991647,6993522,6993526,6993527,6997806,6989319,6980054,6983874,6988219,6997951,6997952,6996284
        ,6996283,6994831,6987539,6979997,6981287,6979544,6980694,6991172,6991171,6986870,6995112,6990476
        ,6999752,6985300,6994017,6980055,6980056,6980057,6980059,6981965,6985618,6985619,6985620,6985649
        ,6986041,6998137,6979650,6979653,6979680,6979743,6979999,6980000,6980048,6980299,6980681,6980683
        ,6980684,6980685,6980686,6980767,6981637,6982005,6982758,6982839,6982842,6982843,6982844,6983243
        ,6983677,6983875,6984600,6984738,6984739,6985042,6985381,6985565,6985583,6985617,6985684,6985697
        ,6985709,6987540,6987541,6988654,6991030,6991436,6991655,6993181,6993383,6993384,6993592,6993742
        ,6993743,6993768,6993769,6993770,6993771,6993772,6993773,6993774,6993775,6993800,6994016,6994033
        ,6994901,6995640,6997683,6997701,6997807,6997868,6998236,6998321,6998382,6999206,6999231,6987639
        ,6987640,6982307,6983873,6997865,6997867,6982308,6998169,6994589,6988323,6984163,6981626,6985325
        ,6993668,6999786,6999724,6987190,6992488,6994604,6982157,6982667,6982835,6995862,6991624,6979542
        ,6980278,6995991,6996416,6995405,6995404';
    
BEGIN

    PL_OUTPUT := '[INICIO]' || CHR(10);

    V_SQL := 'MERGE INTO '||V_ESQUEMA||'.BIE_LOCALIZACION T1
        USING (
            SELECT
                ACT.BIE_ID
                , APR.NOMBRE_VIA AS BIE_LOC_DIRECCION
                , APR.PORTAL_PUNTO_KM AS BIE_LOC_NUMERO_DOMICILIO
                , APR.ESCALERA AS BIE_LOC_ESCALERA
                , APR.PISO AS BIE_LOC_PISO
                , DD_TVI.DD_TVI_ID AS DD_TVI_ID
                , PRV.DD_PRV_ID AS DD_PRV_ID
                , UPO.DD_UPO_CODIGO AS BIE_LOC_MUNICIPIO
                , UPO.DD_UPO_ID AS DD_UPO_ID
                , APR.NUM_PUERTA AS BIE_LOC_PUERTA
                , APR.COD_POSTAL AS BIE_LOC_COD_POST
                , CIC.DD_CIC_ID AS DD_CIC_ID
                , PRV.DD_PRV_CODIGO AS BIE_LOC_PROVINCIA
            FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT 
            JOIN '||V_ESQUEMA||'.APR_AUX_STOCK_UVEM_TO_REM APR ON APR.ACT_NUMERO_UVEM = ACT.ACT_NUM_ACTIVO_UVEM
            JOIN '||V_ESQUEMA_M||'.DD_CIC_CODIGO_ISO_CIRBE_BKP CIC ON CIC.DD_CIC_CODIGO = ''011''
            LEFT JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE ON BIE.BIE_ID = ACT.BIE_ID AND BIE.BORRADO = 0
            LEFT JOIN '||V_ESQUEMA||'.ACT_LOC_LOCALIZACION LOC ON LOC.ACT_ID = ACT.ACT_ID AND LOC.BORRADO = 0
            LEFT JOIN '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA PRV ON PRV.DD_PRV_CODIGO = APR.COD_PROVINCIA
            LEFT JOIN '||V_ESQUEMA_M||'.DD_UPO_UNID_POBLACIONAL UPO ON UPO.DD_UPO_CODIGO = APR.COD_MUNICIPIO_REGISTRO       
            LEFT JOIN '||V_ESQUEMA||'.DD_EQV_BANKIA_REM EQV ON EQV.DD_CODIGO_BANKIA = LPAD(TO_CHAR(APR.TIPO_VIA),2,''0'') AND EQV.DD_NOMBRE_BANKIA = ''DD_TIPO_VIA''
            LEFT JOIN '||V_ESQUEMA_M||'.DD_TVI_TIPO_VIA DD_TVI ON EQV.DD_CODIGO_REM = DD_TVI.DD_TVI_CODIGO
            WHERE ACT.ACT_NUM_ACTIVO IN ('||V_ACTIVOS||')
            ) T2
        ON (T1.BIE_ID = T2.BIE_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.BIE_LOC_DIRECCION = T2.BIE_LOC_DIRECCION
            , T1.BIE_LOC_NUMERO_DOMICILIO = T2.BIE_LOC_NUMERO_DOMICILIO
            , T1.BIE_LOC_ESCALERA = T2.BIE_LOC_ESCALERA
            , T1.BIE_LOC_PISO = T2.BIE_LOC_PISO
            , T1.DD_TVI_ID = T2.DD_TVI_ID
            , T1.DD_PRV_ID = T2.DD_PRV_ID
            , T1.BIE_LOC_MUNICIPIO = T2.BIE_LOC_MUNICIPIO
            , T1.DD_UPO_ID = T2.DD_UPO_ID
            , T1.BIE_LOC_PUERTA = T2.BIE_LOC_PUERTA
            , T1.BIE_LOC_COD_POST = T2.BIE_LOC_COD_POST
            , T1.DD_CIC_ID = T2.DD_CIC_ID
            , T1.BIE_LOC_PROVINCIA = T2.BIE_LOC_PROVINCIA
            , T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
            , T1.FECHAMODIFICAR = SYSDATE
        WHEN NOT MATCHED THEN INSERT (T1.BIE_LOC_ID, T1.BIE_ID, T1.BIE_LOC_DIRECCION, T1.BIE_LOC_NUMERO_DOMICILIO, T1.BIE_LOC_ESCALERA
                , T1.BIE_LOC_PISO, T1.DD_TVI_ID, T1.DD_PRV_ID, T1.BIE_LOC_MUNICIPIO, T1.DD_UPO_ID, T1.BIE_LOC_PUERTA, T1.BIE_LOC_COD_POST
                , T1.DD_CIC_ID, T1.BIE_LOC_PROVINCIA)
        VALUES ('||V_ESQUEMA||'.S_BIE_LOCALIZACION.NEXTVAL, T2.BIE_ID, T2.BIE_LOC_DIRECCION, T2.BIE_LOC_NUMERO_DOMICILIO, T2.BIE_LOC_ESCALERA
                , T2.BIE_LOC_PISO, T2.DD_TVI_ID, T2.DD_PRV_ID, T2.BIE_LOC_MUNICIPIO, T2.DD_UPO_ID, T2.BIE_LOC_PUERTA, T2.BIE_LOC_COD_POST
                , T2.DD_CIC_ID, T2.BIE_LOC_PROVINCIA)';
    EXECUTE IMMEDIATE V_SQL;
    PL_OUTPUT := PL_OUTPUT || ' [INFO] ' || SQL%ROWCOUNT || ' registros fusionados en la tabla BIE_LOCALIZACION.' || CHR(10);
            
    V_SQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_LOC_LOCALIZACION T1
        USING (
            SELECT
                LOC.LOC_ID
                , ACT.ACT_ID
                , LOC.BIE_LOC_ID
                , CASE
                    WHEN APR.SIGNO_LATITUD = ''-'' THEN CAST(''-''||TO_NUMBER(APR.LATITUD)/1000000000000000 AS NUMBER(21,15))
                    WHEN APR.SIGNO_LATITUD = ''+'' THEN CAST(TO_NUMBER(APR.LATITUD)/1000000000000000 AS NUMBER(21,15))
                    END AS LOC_LATITUD
                , CASE
                    WHEN APR.SIGNO_LONGITUD = ''-'' THEN CAST(''-''||TO_NUMBER(APR.LONGITUD)/1000000000000000 AS NUMBER(21,15))
                    WHEN APR.SIGNO_LONGITUD = ''+'' THEN CAST(TO_NUMBER(APR.LONGITUD)/1000000000000000 AS NUMBER(21,15))
                    END AS LOC_LONGITUD
            FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT 
            JOIN '||V_ESQUEMA||'.APR_AUX_STOCK_UVEM_TO_REM APR ON APR.ACT_NUMERO_UVEM = ACT.ACT_NUM_ACTIVO_UVEM
            JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE ON BIE.BIE_ID = ACT.BIE_ID AND BIE.BORRADO = 0
            LEFT JOIN '||V_ESQUEMA||'.ACT_LOC_LOCALIZACION LOC ON LOC.ACT_ID = ACT.ACT_ID AND LOC.BIE_LOC_ID = BIE.BIE_LOC_ID AND LOC.BORRADO = 0
            WHERE ACT.BORRADO = 0 AND ACT.ACT_NUM_ACTIVO IN ('||V_ACTIVOS||')
            ) T2
        ON (T1.ACT_ID = T2.ACT_ID AND T1.BIE_LOC_ID = T2.BIE_LOC_ID)
        WHEN MATCHED THEN UPDATE SET
            T1.LOC_LONGITUD = T2.LOC_LONGITUD
            , T1.LOC_LATITUD = T2.LOC_LATITUD
            , T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
            , T1.FECHAMODIFICAR = SYSDATE
        WHEN NOT MATCHED THEN INSERT (T1.LOC_ID, T1.ACT_ID, T1.BIE_LOC_ID, T1.LOC_LONGITUD, T1.LOC_LATITUD, T1.USUARIOCREAR, T1.FECHACREAR)
        VALUES ('||V_ESQUEMA||'.S_ACT_LOC_LOCALIZACION.NEXTVAL, T2.ACT_ID, T2.BIE_LOC_ID, T2.LOC_LONGITUD, T2.LOC_LATITUD, '''||V_USUARIO||''', SYSDATE)';
    EXECUTE IMMEDIATE V_SQL;
    PL_OUTPUT := PL_OUTPUT || ' [INFO] ' || SQL%ROWCOUNT || ' registros fusionados en la tabla ACT_LOC_LOCALIZACION.' || CHR(10);
    
    PL_OUTPUT := PL_OUTPUT || '[FIN]';
    
    DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);

    COMMIT;

EXCEPTION
   WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    [ERROR] Se ha producido un error en la ejecuci√≥n:'||TO_CHAR(ERR_NUM);
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    '||ERR_MSG;
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    '||V_SQL;
      DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
      ROLLBACK;
      RAISE;
END;
/
EXIT;