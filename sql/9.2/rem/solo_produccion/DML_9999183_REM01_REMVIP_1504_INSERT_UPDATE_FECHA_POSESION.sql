--/*
--##########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20180814
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-1504
--## PRODUCTO=no
--##
--## Finalidad: ACTUALIZAR FECHA POSESION A LISTADO DE ACTIVOS
--## VERSIONES:
--##        0.1 Version inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

  
   PL_OUTPUT VARCHAR2(1024 CHAR);
   V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar        
   V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
   V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
   ACT_ID NUMBER(32);
   ERR_NUM NUMBER(25); -- Vble. auxiliar para registrar errores en el script.
   ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
   DESCRIPCION VARCHAR2(64 CHAR);
   V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
   V_NUM_TABLAS_2 NUMBER(16); -- Vble. para validar la existencia de una tabla.   
   V_USUARIO VARCHAR2(65 CHAR) := 'REMVIP-1504';

    V_TEXT1 VARCHAR2(2400 CHAR); -- Vble. auxiliar
    V_ENTIDAD_ID NUMBER(16);
    V_ID NUMBER(16);
    V_CONTADOR NUMBER(16):=0;
    V_CONTADOR_2 NUMBER(16):=0;
    V_CONTADOR_3 NUMBER(16):=0;
    
    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
	T_TIPO_DATA('19/07/2018','164009'),
	T_TIPO_DATA('19/07/2018','154108'),
	T_TIPO_DATA('19/07/2018','164391'),
	T_TIPO_DATA('19/07/2018','142053'),
	T_TIPO_DATA('19/07/2018','142054'),
	T_TIPO_DATA('19/07/2018','146019'),
	T_TIPO_DATA('19/07/2018','146064'),
	T_TIPO_DATA('19/07/2018','146527'),
	T_TIPO_DATA('19/07/2018','146528'),
	T_TIPO_DATA('19/07/2018','164392'),
	T_TIPO_DATA('19/07/2018','142115'),
	T_TIPO_DATA('19/07/2018','141895'),
	T_TIPO_DATA('19/07/2018','141896'),
	T_TIPO_DATA('19/07/2018','154683'),
	T_TIPO_DATA('19/07/2018','154500'),
	T_TIPO_DATA('19/07/2018','142116'),
	T_TIPO_DATA('19/07/2018','145799'),
	T_TIPO_DATA('19/07/2018','142117'),
	T_TIPO_DATA('19/07/2018','141897'),
	T_TIPO_DATA('19/07/2018','154501'),
	T_TIPO_DATA('19/07/2018','141945'),
	T_TIPO_DATA('19/07/2018','154684'),
	T_TIPO_DATA('19/07/2018','163937'),
	T_TIPO_DATA('19/07/2018','164393'),
	T_TIPO_DATA('19/07/2018','154243'),
	T_TIPO_DATA('19/07/2018','154685'),
	T_TIPO_DATA('19/07/2018','146065'),
	T_TIPO_DATA('19/07/2018','163838'),
	T_TIPO_DATA('19/07/2018','154502'),
	T_TIPO_DATA('19/07/2018','154109'),
	T_TIPO_DATA('19/07/2018','142327'),
	T_TIPO_DATA('19/07/2018','164010'),
	T_TIPO_DATA('19/07/2018','142436'),
	T_TIPO_DATA('19/07/2018','145800'),
	T_TIPO_DATA('19/07/2018','142437'),
	T_TIPO_DATA('19/07/2018','142438'),
	T_TIPO_DATA('19/07/2018','175995'),
	T_TIPO_DATA('19/07/2018','146066'),
	T_TIPO_DATA('19/07/2018','154110'),
	T_TIPO_DATA('19/07/2018','154111'),
	T_TIPO_DATA('19/07/2018','154686'),
	T_TIPO_DATA('19/07/2018','145801'),
	T_TIPO_DATA('19/07/2018','164394'),
	T_TIPO_DATA('19/07/2018','154244'),
	T_TIPO_DATA('19/07/2018','154687'),
	T_TIPO_DATA('19/07/2018','154112'),
	T_TIPO_DATA('19/07/2018','141898'),
	T_TIPO_DATA('19/07/2018','164011'),
	T_TIPO_DATA('19/07/2018','142439'),
	T_TIPO_DATA('19/07/2018','141946'),
	T_TIPO_DATA('19/07/2018','146020'),
	T_TIPO_DATA('19/07/2018','146067'),
	T_TIPO_DATA('19/07/2018','168486'),
	T_TIPO_DATA('19/07/2018','154245'),
	T_TIPO_DATA('19/07/2018','163938'),
	T_TIPO_DATA('19/07/2018','144389'),
	T_TIPO_DATA('19/07/2018','155283'),
	T_TIPO_DATA('19/07/2018','131992'),
	T_TIPO_DATA('19/07/2018','150531'),
	T_TIPO_DATA('19/07/2018','137965'),
	T_TIPO_DATA('19/07/2018','155145'),
	T_TIPO_DATA('19/07/2018','137966'),
	T_TIPO_DATA('19/07/2018','137967'),
	T_TIPO_DATA('19/07/2018','137968'),
	T_TIPO_DATA('19/07/2018','155373'),
	T_TIPO_DATA('19/07/2018','155604'),
	T_TIPO_DATA('19/07/2018','137907'),
	T_TIPO_DATA('19/07/2018','63674'),
	T_TIPO_DATA('19/07/2018','198874'),
	T_TIPO_DATA('19/07/2018','63675'),
	T_TIPO_DATA('19/07/2018','169625'),
	T_TIPO_DATA('19/07/2018','169275'),
	T_TIPO_DATA('19/07/2018','63105'),
	T_TIPO_DATA('19/07/2018','198575'),
	T_TIPO_DATA('19/07/2018','63267'),
	T_TIPO_DATA('19/07/2018','169507'),
	T_TIPO_DATA('19/07/2018','63268'),
	T_TIPO_DATA('19/07/2018','63269'),
	T_TIPO_DATA('19/07/2018','63676'),
	T_TIPO_DATA('19/07/2018','198576'),
	T_TIPO_DATA('19/07/2018','169626'),
	T_TIPO_DATA('19/07/2018','63159'),
	T_TIPO_DATA('19/07/2018','169508'),
	T_TIPO_DATA('19/07/2018','169276'),
	T_TIPO_DATA('19/07/2018','63238'),
	T_TIPO_DATA('19/07/2018','63677'),
	T_TIPO_DATA('19/07/2018','63239'),
	T_TIPO_DATA('19/07/2018','169213'),
	T_TIPO_DATA('19/07/2018','63106'),
	T_TIPO_DATA('19/07/2018','169277'),
	T_TIPO_DATA('19/07/2018','198875'),
	T_TIPO_DATA('19/07/2018','198676'),
	T_TIPO_DATA('19/07/2018','63418'),
	T_TIPO_DATA('19/07/2018','198624'),
	T_TIPO_DATA('19/07/2018','63240'),
	T_TIPO_DATA('19/07/2018','169627'),
	T_TIPO_DATA('19/07/2018','169278'),
	T_TIPO_DATA('19/07/2018','198876'),
	T_TIPO_DATA('19/07/2018','198577'),
	T_TIPO_DATA('19/07/2018','169509'),
	T_TIPO_DATA('19/07/2018','169312'),
	T_TIPO_DATA('19/07/2018','63241'),
	T_TIPO_DATA('19/07/2018','169313'),
	T_TIPO_DATA('19/07/2018','63678'),
	T_TIPO_DATA('19/07/2018','63419'),
	T_TIPO_DATA('19/07/2018','198578'),
	T_TIPO_DATA('19/07/2018','169510'),
	T_TIPO_DATA('19/07/2018','63679'),
	T_TIPO_DATA('19/07/2018','198625'),
	T_TIPO_DATA('19/07/2018','198877'),
	T_TIPO_DATA('19/07/2018','63160'),
	T_TIPO_DATA('19/07/2018','63680'),
	T_TIPO_DATA('19/07/2018','62812'),
	T_TIPO_DATA('19/07/2018','63107'),
	T_TIPO_DATA('19/07/2018','63315'),
	T_TIPO_DATA('19/07/2018','168886'),
	T_TIPO_DATA('19/07/2018','168868'),
	T_TIPO_DATA('19/07/2018','63668'),
	T_TIPO_DATA('06/07/2018','142553'),
	T_TIPO_DATA('06/07/2018','143372'),
	T_TIPO_DATA('06/07/2018','134104'),
	T_TIPO_DATA('06/07/2018','150098'),
	T_TIPO_DATA('06/07/2018','152879'),
	T_TIPO_DATA('06/07/2018','149896'),
	T_TIPO_DATA('06/07/2018','134491'),
	T_TIPO_DATA('06/07/2018','134491'),
	T_TIPO_DATA('06/07/2018','162492'),
	T_TIPO_DATA('06/07/2018','184039'),
	T_TIPO_DATA('06/07/2018','176277'),
	T_TIPO_DATA('06/07/2018','113032'),
	T_TIPO_DATA('06/07/2018','103850'),
	T_TIPO_DATA('06/07/2018','160986'),
	T_TIPO_DATA('06/07/2018','69088'),
	T_TIPO_DATA('31/05/2018','6946504'),
	T_TIPO_DATA('31/05/2018','6946565'),
	T_TIPO_DATA('31/05/2018','6946505'),
	T_TIPO_DATA('31/05/2018','6946506'),
	T_TIPO_DATA('31/05/2018','6946507'),
	T_TIPO_DATA('31/05/2018','6946508'),
	T_TIPO_DATA('31/05/2018','6946545'),
	T_TIPO_DATA('31/05/2018','6946546'),
	T_TIPO_DATA('31/05/2018','6946509'),
	T_TIPO_DATA('31/05/2018','6946547'),
	T_TIPO_DATA('31/05/2018','6946510'),
	T_TIPO_DATA('31/05/2018','6946548'),
	T_TIPO_DATA('31/05/2018','6946511'),
	T_TIPO_DATA('31/05/2018','6946549'),
	T_TIPO_DATA('31/05/2018','6946585'),
	T_TIPO_DATA('31/05/2018','6946512'),
	T_TIPO_DATA('31/05/2018','6946513'),
	T_TIPO_DATA('31/05/2018','6946550'),
	T_TIPO_DATA('31/05/2018','6946563'),
	T_TIPO_DATA('31/05/2018','6946514'),
	T_TIPO_DATA('31/05/2018','6946564'),
	T_TIPO_DATA('31/05/2018','6946551'),
	T_TIPO_DATA('31/05/2018','6946552'),
	T_TIPO_DATA('31/05/2018','6946553'),
	T_TIPO_DATA('31/05/2018','6946587'),
	T_TIPO_DATA('31/05/2018','6946554'),
	T_TIPO_DATA('31/05/2018','6946555'),
	T_TIPO_DATA('31/05/2018','6946515'),
	T_TIPO_DATA('31/05/2018','6946556'),
	T_TIPO_DATA('31/05/2018','6946516'),
	T_TIPO_DATA('31/05/2018','6946557'),
	T_TIPO_DATA('31/05/2018','6946558'),
	T_TIPO_DATA('31/05/2018','6946517'),
	T_TIPO_DATA('31/05/2018','6946559'),
	T_TIPO_DATA('31/05/2018','6946518'),
	T_TIPO_DATA('31/05/2018','6946519'),
	T_TIPO_DATA('31/05/2018','6946560'),
	T_TIPO_DATA('31/05/2018','6946520'),
	T_TIPO_DATA('31/05/2018','6946521'),
	T_TIPO_DATA('31/05/2018','6946522'),
	T_TIPO_DATA('31/05/2018','6946523'),
	T_TIPO_DATA('31/05/2018','6946524'),
	T_TIPO_DATA('31/05/2018','6946525'),
	T_TIPO_DATA('31/05/2018','6946526'),
	T_TIPO_DATA('31/05/2018','6946527'),
	T_TIPO_DATA('31/05/2018','6946528'),
	T_TIPO_DATA('31/05/2018','6946529'),
	T_TIPO_DATA('31/05/2018','6946530'),
	T_TIPO_DATA('31/05/2018','6946531'),
	T_TIPO_DATA('31/05/2018','6946532'),
	T_TIPO_DATA('31/05/2018','6946533'),
	T_TIPO_DATA('31/05/2018','6946534'),
	T_TIPO_DATA('31/05/2018','6946535'),
	T_TIPO_DATA('31/05/2018','6946536'),
	T_TIPO_DATA('31/05/2018','6946537'),
	T_TIPO_DATA('31/05/2018','6946538'),
	T_TIPO_DATA('31/05/2018','6946539'),
	T_TIPO_DATA('31/05/2018','6946540'),
	T_TIPO_DATA('31/05/2018','6946541'),
	T_TIPO_DATA('31/05/2018','6946542'),
	T_TIPO_DATA('31/05/2018','6946543'),
	T_TIPO_DATA('31/05/2018','6946544'),
	T_TIPO_DATA('31/05/2018','6946561'),
	T_TIPO_DATA('31/05/2018','6946562'),
	T_TIPO_DATA('31/05/2018','6946566')
		); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

BEGIN

	DBMS_OUTPUT.PUT_LINE('[INICIO] ');
	 
		
		DBMS_OUTPUT.PUT_LINE('[INFO]: COMIENZA EL PROCESO');
		FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
		LOOP
      
			V_TMP_TIPO_DATA := V_TIPO_DATA(I);

				--Comprobamos si el activo existe en la tabla ACT_ADN_ADJNOJUDICIAL 

				V_SQL := 'SELECT COUNT(1)  
						FROM '||V_ESQUEMA||'.ACT_ADN_ADJNOJUDICIAL ADN 
						WHERE ADN.ACT_ID = 
						(SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO 
						 WHERE ACT_NUM_ACTIVO = '''|| TRIM(V_TMP_TIPO_DATA(2)) ||''')'; 
				EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS_2;

				IF V_NUM_TABLAS_2 = 1 THEN

				--Actualizamos las fechas de loc activos de la tabla ACT_ADN_ADJNOJUDICIAL 

				V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_ADN_ADJNOJUDICIAL  SET 
					  ADN_FECHA_TITULO = TO_DATE('''|| TRIM(V_TMP_TIPO_DATA(1)) ||''',''DD/MM/YYYY'') 
					, USUARIOMODIFICAR = '''||V_USUARIO||'''  
					, FECHAMODIFICAR = SYSDATE  
					WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '''|| TRIM(V_TMP_TIPO_DATA(2)) ||''')';
				
				EXECUTE IMMEDIATE V_SQL;

				DBMS_OUTPUT.PUT_LINE('[INFO] Actualizada la fecha ADN_FECHA_TITULO del activo '''|| TRIM(V_TMP_TIPO_DATA(2)) ||''' a '''|| TRIM(V_TMP_TIPO_DATA(1)) ||'''');

				V_CONTADOR_3 := V_CONTADOR_3 + SQL%ROWCOUNT;

				END IF;	

				--Comprobamos si el activo existe en la tabla act_sps_sit_posesoria 

				V_SQL := 'SELECT COUNT(1)  
						FROM '||V_ESQUEMA||'.ACT_SPS_SIT_POSESORIA SPS 
						WHERE SPS.ACT_ID = 
						(SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO 
						 WHERE ACT_NUM_ACTIVO = '''|| TRIM(V_TMP_TIPO_DATA(2)) ||''')'; 
				EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
			
				--Si existe iniciamos la actualizacion de la fecha de posesion

				IF V_NUM_TABLAS = 1 THEN				

				 V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_SPS_SIT_POSESORIA SET 
					  SPS_FECHA_TOMA_POSESION = TO_DATE('''|| TRIM(V_TMP_TIPO_DATA(1)) ||''',''DD/MM/YYYY'') 
					, USUARIOMODIFICAR = '''||V_USUARIO||'''  
					, FECHAMODIFICAR = SYSDATE  
					WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '''|| TRIM(V_TMP_TIPO_DATA(2)) ||''')'; 
		 
				EXECUTE IMMEDIATE V_SQL;

				V_CONTADOR := V_CONTADOR + SQL%ROWCOUNT;

 				DBMS_OUTPUT.PUT_LINE('[INFO] Actualizada la fecha de posesion del activo '''|| TRIM(V_TMP_TIPO_DATA(2)) ||''' a '''|| TRIM(V_TMP_TIPO_DATA(1)) ||''' ok= '||SQL%ROWCOUNT||'');

				--Si no existe, lo insertamos en la tabla ACT_SPS_SIT_POSESORIA

				ELSE


		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_SPS_SIT_POSESORIA (SPS_ID, ACT_ID, SPS_FECHA_TOMA_POSESION, USUARIOCREAR, FECHACREAR) 
				SELECT '||V_ESQUEMA||'.S_ACT_SPS_SIT_POSESORIA.NEXTVAL,
				ACT_ID,
				TO_DATE('''|| TRIM(V_TMP_TIPO_DATA(1)) ||''',''DD/MM/YYYY''),	 
				'''||V_USUARIO||''', 
				SYSDATE 
				FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT 
				WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO 
						WHERE ACT_NUM_ACTIVO = '''|| TRIM(V_TMP_TIPO_DATA(2)) ||''')';

		EXECUTE IMMEDIATE V_SQL;

		V_CONTADOR_2 := V_CONTADOR_2 + SQL%ROWCOUNT;

		DBMS_OUTPUT.PUT_LINE('[INFO] Se han insertado '||SQL%ROWCOUNT||' registros en la ACT_SPS_SIT_POSESORIA');

		PL_OUTPUT := '[INFO] Insertada la fecha de posesion y el activo '''|| TRIM(V_TMP_TIPO_DATA(2)) ||''' a '''|| TRIM(V_TMP_TIPO_DATA(1)) ||''' ok= '||SQL%ROWCOUNT||''; 
				
		END IF;	

    	  END LOOP;

	  DBMS_OUTPUT.PUT_LINE('Se han ACTUALIZADO '||V_CONTADOR_3||' registros en ACT_ADN_ADJNOJUDICIAL'); 
	  DBMS_OUTPUT.PUT_LINE('Se han ACTUALIZADO '||V_CONTADOR||' registros en ACT_SPS_SIT_POSESORIA'); 
 	  DBMS_OUTPUT.PUT_LINE('Se han INSERTADO '||V_CONTADOR_2||' registros en ACT_SPS_SIT_POSESORIA'); 


    COMMIT;

    DBMS_OUTPUT.PUT_LINE('[FIN]: ACTUALIZADAS E INSERTADAS LAS FECHAS DE POSESION DE LOS ACTIVOS CORRECTAMENTE');   

EXCEPTION
   WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    [ERROR] Se ha producido un error en la ejecuci√≥n:'||TO_CHAR(ERR_NUM);
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    '||ERR_MSG;
      ROLLBACK;
      RAISE;
END UPDATE_PAC;
/
EXIT;
