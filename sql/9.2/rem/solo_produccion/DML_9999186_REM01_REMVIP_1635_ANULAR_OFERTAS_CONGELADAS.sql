--/*
--##########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20180828
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-1635
--## PRODUCTO=NO
--##
--## Finalidad: Anular ofertas congeladas por venta de activo
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
   
    V_ESQUEMA VARCHAR2(25 CHAR) := '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR) := '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-1635';
    V_SQL VARCHAR2(4000 CHAR); 
    ERR_NUM NUMBER;-- Numero de errores
    ERR_MSG VARCHAR2(2048);-- Mensaje de error;
    PL_OUTPUT VARCHAR2(20000 CHAR);

BEGIN


      V_SQL := 'UPDATE '||V_ESQUEMA||'.OFR_OFERTAS OFR 
		SET DD_EOF_ID = 2 
		, USUARIOMODIFICAR = '''||V_USUARIO||''' 
		, FECHAMODIFICAR = SYSDATE 
		WHERE OFR_ID IN ( 
		SELECT OFR_ID 
		FROM '||V_ESQUEMA||'.OFR_OFERTAS OFR 
		JOIN '||V_ESQUEMA||'.DD_EOF_ESTADOS_OFERTA EOF ON EOF.DD_EOF_ID = OFR.DD_EOF_ID 
		WHERE OFR_NUM_OFERTA IN ( 
		63540214,
		90016479,
		90019806,
		90006010,
		90022029,
		90015163,
		90015170,
		90064646,
		90068167,
		90067681,
		90002439,
		90003129,
		90004911,
		90040635,
		90025182,
		90045235,
		63540321,
		63540448,
		90007909,
		90010085,
		90011972,
		90015168,
		90015165,
		90015167,
		90018267,
		90027582,
		90017862,
		90061986,
		90043649,
		90043650,
		90010072,
		90039681,
		90048777,
		90015054,
		90029948,
		90004379,
		90028919,
		90022465,
		90023000,
		90029797,
		90015480,
		90050957,
		90062389,
		90017422,
		90017420,
		66022503,
		90031460,
		90031615,
		90033709,
		90034470,
		90035349,
		90005022,
		90009590,
		90009751,
		90010031,
		90010039,
		90010140,
		90012972,
		90002436,
		90003297,
		90003563,
		90024735,
		90015059,
		90043474,
		90015482,
		90016480,
		90011391,
		90011398,
		90018363,
		90018365,
		90010288,
		90003766,
		90005553,
		90008056,
		90015148,
		90001460,
		90019846,
		90008421,
		90019789,
		90072655,
		90043054,
		90043059,
		90043822,
		90010165,
		90025926,
		90067494,
		90035239,
		90043263,
		90049067,
		90001603,
		90002428,
		90015305,
		90015592,
		90008599,
		90035665,
		90018478,
		90018189,
		90018191,
		90003535,
		90006837,
		90052380,
		90003535,
		90045018,
		90019435,
		90052380,
		90031714,
		90052380,
		90009218,
		90018869,
		90007485,
		90008569,
		90009779,
		90016666,
		90003708,
		90032454,
		90017887,
		90025765,
		90010247,
		90019817,
		90017233,
		90013332,
		90017232,
		90026565,
		90007798,
		90018714,
		90024892,
		90013558,
		90019876,
		90019943,
		90019878,
		90019943,
		90014092,
		90043444,
		90002450,
		90007710,
		90038088,
		90038839,
		90016692,
		90011362
		)
		)';

      EXECUTE IMMEDIATE V_SQL;
		
      DBMS_OUTPUT.PUT_LINE('Se han anulado '||SQL%ROWCOUNT||' ofertas correctamente');

    COMMIT;


EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;

/

EXIT
