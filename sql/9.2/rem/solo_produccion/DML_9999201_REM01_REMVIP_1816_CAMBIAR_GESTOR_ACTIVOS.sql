--/*
--#########################################
--## AUTOR=Ivan Castelló
--## FECHA_CREACION=20180913
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-1816
--## PRODUCTO=NO
--## 
--## Finalidad: Cambiar valor de tasación del activo
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
    V_ESQUEMA VARCHAR2(25 CHAR) := '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR) := '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-1816';
    V_SQL VARCHAR2(4000 CHAR); 
    ERR_NUM NUMBER;-- Numero de errores
    ERR_MSG VARCHAR2(2048);-- Mensaje de error
    PL_OUTPUT VARCHAR2(32000 CHAR);
    ACT_NUM_ACTIVO NUMBER(16,0):= 5929497;

BEGIN



	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.AUX_SFORM_REMVIP_1816 (ACT,USU) 
				SELECT ACT.ACT_ID, 39802
				FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
				JOIN '||V_ESQUEMA||'.ACT_TBJ A_T                   ON A_T.ACT_ID = ACT.ACT_ID
				JOIN '||V_ESQUEMA||'.ACT_OFR A_O                   ON A_O.ACT_ID = ACT.ACT_ID
				JOIN '||V_ESQUEMA||'.ACT_TBJ_TRABAJO TBJ           ON TBJ.TBJ_ID = A_T.TBJ_ID AND TBJ.BORRADO = 0
				JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR               ON OFR.OFR_ID = A_O.OFR_ID AND OFR.BORRADO = 0
				JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO  ON ECO.OFR_ID = OFR.OFR_ID AND ECO.BORRADO = 0
				JOIN '||V_ESQUEMA||'.GCO_GESTOR_ADD_ECO GCO        ON GCO.ECO_ID = ECO.ECO_ID
				JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE        ON GCO.GEE_ID = GEE.GEE_ID AND GEE.BORRADO = 0
				JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE      ON TGE.DD_TGE_ID = GEE.DD_TGE_ID AND TGE.DD_TGE_ID = GEE.DD_TGE_ID AND TGE.DD_TGE_CODIGO = ''SFORM''
				JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU            ON USU.USU_ID = GEE.USU_ID
				JOIN '||V_ESQUEMA||'.ZON_PEF_USU Z                 ON Z.USU_ID = USU.USU_ID 
				JOIN '||V_ESQUEMA||'.PEF_PERFILES PEF              ON PEF.PEF_ID = Z.PEF_ID
				JOIN '||V_ESQUEMA||'.ACT_GES_DIST_GESTORES GES     ON USU.USU_USERNAME = GES.USERNAME
				WHERE USU.USU_USERNAME = ''dmartinb'' AND PEF.PEF_CODIGO LIKE ''HAYASUPFORM%''
				GROUP BY ACT.ACT_ID';

	EXECUTE IMMEDIATE V_SQL;

	DBMS_OUTPUT.PUT_LINE('  [INFO1] '||SQL%ROWCOUNT||' Insertamos en la AUX_SFORM_REMVIP_1816 ');




	V_SQL := 'MERGE INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD T1
				USING (WITH ECO AS (SELECT ECO.ACT as ECO_ID
				        FROM '||V_ESQUEMA||'.AUX_SFORM_REMVIP_1816 ECO
				        WHERE NOT EXISTS (SELECT 1 FROM GCO_GESTOR_ADD_ECO GCO
				            JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GCO.GEE_ID
				            JOIN '||V_ESQUEMA||'.GCH_GESTOR_ECO_HISTORICO GCH ON GCH.ECO_ID = GCO.ECO_ID
				            JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH ON GEH.GEH_ID = GCH.GEH_ID
				            JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_ID = GEH.DD_TGE_ID AND TGE.DD_TGE_ID = GEE.DD_TGE_ID AND TGE.DD_TGE_CODIGO = ''SFORM''
				            WHERE GCO.ECO_ID = ECO.ACT))
				    SELECT AUX.ACT ECO_ID, AUX.USU USU_ID, GEE.GEE_ID, TGE.DD_TGE_ID
				      , CASE
				          WHEN ECO.ECO_ID IS NULL THEN 1
				          ELSE 0
				          END EXISTE
				      , ROW_NUMBER() OVER(PARTITION BY AUX.ACT ORDER BY TGE.DD_TGE_ID NULLS LAST) RN
				    FROM '||V_ESQUEMA||'.AUX_SFORM_REMVIP_1816 AUX
				    LEFT JOIN ECO ON ECO.ECO_ID = AUX.ACT
				    LEFT JOIN '||V_ESQUEMA||'.GCO_GESTOR_ADD_ECO GCO ON GCO.ECO_ID = AUX.ACT
				    LEFT JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GCO.GEE_ID
				    LEFT JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_ID = GEE.DD_TGE_ID AND TGE.DD_TGE_CODIGO = ''SFORM'') T2
				ON (T1.GEE_ID = T2.GEE_ID AND T1.DD_TGE_ID = T2.DD_TGE_ID)
				WHEN MATCHED THEN UPDATE SET
				    T1.USU_ID = T2.USU_ID, T1.USUARIOMODIFICAR = ''REMVIP_1816_SFORM_UPD'', T1.FECHAMODIFICAR = SYSDATE, T1.USUARIOBORRAR = T2.ECO_ID
				WHERE T1.USU_ID <> T2.USU_ID AND T1.BORRADO = 0 AND T2.EXISTE = 1
				WHEN NOT MATCHED THEN INSERT
				    (T1.GEE_ID, T1.USU_ID, T1.DD_TGE_ID, T1.USUARIOCREAR, T1.FECHACREAR, T1.USUARIOBORRAR)
				    VALUES ('||V_ESQUEMA||'.S_GEE_GESTOR_ENTIDAD.NEXTVAL, T2.USU_ID, (SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = ''SFORM''), ''REMVIP_1816_SFORM_INS'', SYSDATE, T2.ECO_ID)
				WHERE T2.RN = 1 AND T2.EXISTE = 0';

	EXECUTE IMMEDIATE V_SQL;

	DBMS_OUTPUT.PUT_LINE('  [INFO2] '||SQL%ROWCOUNT||' Merge en la en GEE_GESTOR_ENTIDAD ');




	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.GCO_GESTOR_ADD_ECO (GEE_ID, ECO_ID)
				SELECT GEE_ID, USUARIOBORRAR ECO_ID
				FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
				WHERE (USUARIOCREAR = ''REMVIP_1816_SFORM_INS'' OR USUARIOMODIFICAR = ''REMVIP_1816_SFORM_UPD'')
				    AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.GCO_GESTOR_ADD_ECO AUX WHERE AUX.GEE_ID = GEE.GEE_ID)';

	EXECUTE IMMEDIATE V_SQL;

	DBMS_OUTPUT.PUT_LINE('  [INFO3] '||SQL%ROWCOUNT||' Insertamos en la GCO_GESTOR_ADD_ECO ');




	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST (GEH_ID,USU_ID,DD_TGE_ID,GEH_FECHA_DESDE
				    ,USUARIOCREAR,FECHACREAR,USUARIOMODIFICAR,USUARIOBORRAR)
				SELECT '||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL, GEE.USU_ID, GEE.DD_TGE_ID, SYSDATE, ''REMVIP_1816_SFORM_INS'', SYSDATE
				    , CASE WHEN GEE.USUARIOMODIFICAR = ''REMVIP_1816_SFORM_UPD'' THEN GEE.USUARIOMODIFICAR WHEN GEE.USUARIOCREAR = ''REMVIP_1816_SFORM_INS'' THEN GEE.USUARIOCREAR END
				    , GEE.USUARIOBORRAR
				FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
				JOIN '||V_ESQUEMA||'.GCO_GESTOR_ADD_ECO GCO ON GEE.GEE_ID = GCO.GEE_ID
				WHERE GEE.USUARIOMODIFICAR = ''REMVIP_1816_SFORM_UPD'' OR GEE.USUARIOCREAR = ''REMVIP_1816_SFORM_INS''';

	EXECUTE IMMEDIATE V_SQL;				    
	    
	DBMS_OUTPUT.PUT_LINE('  [INFO4] '||SQL%ROWCOUNT||' Insertamos en la GEH_GESTOR_ENTIDAD_HIST ');


	V_SQL := 'INSERT INTO GCH_GESTOR_ECO_HISTORICO (GEH_ID, ECO_ID)
				SELECT GEH.GEH_ID, GEH.USUARIOBORRAR ECO_ID
				FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
				WHERE GEH.USUARIOMODIFICAR IN (''REMVIP_1816_SFORM_UPD'',''REMVIP_1816_SFORM_INS'')
				    AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.GCH_GESTOR_ECO_HISTORICO AUX WHERE AUX.GEH_ID = GEH.GEH_ID)';
	
	EXECUTE IMMEDIATE V_SQL;				    
	    
	DBMS_OUTPUT.PUT_LINE('  [INFO5] '||SQL%ROWCOUNT||' Insertamos en la GCH_GESTOR_ECO_HISTORICO ');



	V_SQL := 'MERGE INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST T1
				USING (
				    WITH NEW_RECORDS AS (
				      SELECT GEH_ID, USUARIOBORRAR ECO_ID FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST WHERE USUARIOMODIFICAR IN (''REMVIP_1816_SFORM_UPD'',''REMVIP_1816_SFORM_INS''))
				    SELECT T1.GEH_ID, T2.ECO_ID, T3.DD_TGE_CODIGO
				    FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST T1
				    JOIN '||V_ESQUEMA||'.GCH_GESTOR_ECO_HISTORICO T2 ON T1.GEH_ID = T2.GEH_ID
				    JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR T3 ON T3.DD_TGE_ID = T1.DD_TGE_ID AND T3.DD_TGE_CODIGO = ''SFORM''
				    JOIN NEW_RECORDS T4 ON T4.ECO_ID = T2.ECO_ID AND T4.GEH_ID <> T1.GEH_ID
				    WHERE T1.GEH_FECHA_HASTA IS NULL) T2
				ON (T1.GEH_ID = T2.GEH_ID)
				WHEN MATCHED THEN UPDATE SET
				    T1.GEH_FECHA_HASTA = SYSDATE, T1.FECHAMODIFICAR = SYSDATE, T1.USUARIOMODIFICAR = ''REMVIP_1816_SFORM_UPD''';    

 	EXECUTE IMMEDIATE V_SQL;   
	    
	DBMS_OUTPUT.PUT_LINE('  [INFO6] '||SQL%ROWCOUNT||' Merge en la GEH_GESTOR_ENTIDAD_HIST ');
	


   COMMIT;

EXCEPTION
    WHEN OTHERS THEN
		DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
		DBMS_OUTPUT.PUT_LINE(SQLERRM);
		ROLLBACK;
		RAISE;

END;
/
EXIT;
