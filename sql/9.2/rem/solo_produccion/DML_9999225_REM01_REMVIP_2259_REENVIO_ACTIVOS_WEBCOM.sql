--/*
--###########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20181016
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-2259
--## PRODUCTO=NO
--## 
--## Finalidad: Marcar para reenviar ACTIVOS del detector de cambios
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  
  TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
  TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;



--------------------------------------------------------------
-- INICIO ZONA PARA EDITAR            ------------------------
--------------------------------------------------------------

  V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
  -- Cada ACTIVO en un T_TIPO_DATA
		T_TIPO_DATA('202768'),
		T_TIPO_DATA('202781'),
		T_TIPO_DATA('202783'),
		T_TIPO_DATA('202787'),
		T_TIPO_DATA('203170'),
		T_TIPO_DATA('203327'),
		T_TIPO_DATA('203337'),
		T_TIPO_DATA('203475'),
		T_TIPO_DATA('203489'),
		T_TIPO_DATA('203492'),
		T_TIPO_DATA('203495'),
		T_TIPO_DATA('203914'),
		T_TIPO_DATA('203916'),
		T_TIPO_DATA('203917'),
		T_TIPO_DATA('204216'),
		T_TIPO_DATA('204229'),
		T_TIPO_DATA('204303'),
		T_TIPO_DATA('204305'),
		T_TIPO_DATA('204323'),
		T_TIPO_DATA('204413'),
		T_TIPO_DATA('204419'),
		T_TIPO_DATA('204421'),
		T_TIPO_DATA('204510'),
		T_TIPO_DATA('204527'),
		T_TIPO_DATA('204529'),
		T_TIPO_DATA('204534'),
		T_TIPO_DATA('204299'),
		T_TIPO_DATA('202760'),
		T_TIPO_DATA('202770'),
		T_TIPO_DATA('202774'),
		T_TIPO_DATA('203159'),
		T_TIPO_DATA('203169'),
		T_TIPO_DATA('203326'),
		T_TIPO_DATA('203328'),
		T_TIPO_DATA('203331'),
		T_TIPO_DATA('203480'),
		T_TIPO_DATA('203490'),
		T_TIPO_DATA('203910'),
		T_TIPO_DATA('204230'),
		T_TIPO_DATA('204310'),
		T_TIPO_DATA('204315'),
		T_TIPO_DATA('204320'),
		T_TIPO_DATA('204321'),
		T_TIPO_DATA('204513'),
		T_TIPO_DATA('204516'),
		T_TIPO_DATA('204523'),
		T_TIPO_DATA('204532'),
		T_TIPO_DATA('204533'),
		T_TIPO_DATA('202758'),
		T_TIPO_DATA('202766'),
		T_TIPO_DATA('202773'),
		T_TIPO_DATA('202778'),
		T_TIPO_DATA('202788'),
		T_TIPO_DATA('203161'),
		T_TIPO_DATA('203342'),
		T_TIPO_DATA('203343'),
		T_TIPO_DATA('203479'),
		T_TIPO_DATA('203483'),
		T_TIPO_DATA('203488'),
		T_TIPO_DATA('203913'),
		T_TIPO_DATA('203915'),
		T_TIPO_DATA('203922'),
		T_TIPO_DATA('203925'),
		T_TIPO_DATA('204297'),
		T_TIPO_DATA('204312'),
		T_TIPO_DATA('204324'),
		T_TIPO_DATA('204411'),
		T_TIPO_DATA('204415'),
		T_TIPO_DATA('204422'),
		T_TIPO_DATA('204424'),
		T_TIPO_DATA('204509'),
		T_TIPO_DATA('204515'),
		T_TIPO_DATA('204525'),
		T_TIPO_DATA('934014'),
		T_TIPO_DATA('202754'),
		T_TIPO_DATA('202762'),
		T_TIPO_DATA('202772'),
		T_TIPO_DATA('202780'),
		T_TIPO_DATA('202782'),
		T_TIPO_DATA('202786'),
		T_TIPO_DATA('202790'),
		T_TIPO_DATA('203155'),
		T_TIPO_DATA('203158'),
		T_TIPO_DATA('203162'),
		T_TIPO_DATA('203334'),
		T_TIPO_DATA('203336'),
		T_TIPO_DATA('203469'),
		T_TIPO_DATA('203486'),
		T_TIPO_DATA('203911'),
		T_TIPO_DATA('203912'),
		T_TIPO_DATA('203919'),
		T_TIPO_DATA('203928'),
		T_TIPO_DATA('203930'),
		T_TIPO_DATA('203931'),
		T_TIPO_DATA('204049'),
		T_TIPO_DATA('204218'),
		T_TIPO_DATA('204219'),
		T_TIPO_DATA('204221'),
		T_TIPO_DATA('204226'),
		T_TIPO_DATA('204228'),
		T_TIPO_DATA('204302'),
		T_TIPO_DATA('204409'),
		T_TIPO_DATA('204512'),
		T_TIPO_DATA('204518'),
		T_TIPO_DATA('204531'),
		T_TIPO_DATA('204535'),
		T_TIPO_DATA('204547'),
		T_TIPO_DATA('202765'),
		T_TIPO_DATA('202767'),
		T_TIPO_DATA('202784'),
		T_TIPO_DATA('202785'),
		T_TIPO_DATA('202792'),
		T_TIPO_DATA('202794'),
		T_TIPO_DATA('203088'),
		T_TIPO_DATA('203092'),
		T_TIPO_DATA('203097'),
		T_TIPO_DATA('203153'),
		T_TIPO_DATA('203171'),
		T_TIPO_DATA('203174'),
		T_TIPO_DATA('203329'),
		T_TIPO_DATA('203473'),
		T_TIPO_DATA('203477'),
		T_TIPO_DATA('203485'),
		T_TIPO_DATA('203854'),
		T_TIPO_DATA('204214'),
		T_TIPO_DATA('204227'),
		T_TIPO_DATA('204231'),
		T_TIPO_DATA('204295'),
		T_TIPO_DATA('204300'),
		T_TIPO_DATA('204311'),
		T_TIPO_DATA('204316'),
		T_TIPO_DATA('204317'),
		T_TIPO_DATA('204410'),
		T_TIPO_DATA('204416'),
		T_TIPO_DATA('204418'),
		T_TIPO_DATA('204420'),
		T_TIPO_DATA('204514'),
		T_TIPO_DATA('204517'),
		T_TIPO_DATA('204519'),
		T_TIPO_DATA('204522'),
		T_TIPO_DATA('204526'),
		T_TIPO_DATA('204543'),
		T_TIPO_DATA('204546'),
		T_TIPO_DATA('202755'),
		T_TIPO_DATA('202756'),
		T_TIPO_DATA('202761'),
		T_TIPO_DATA('202763'),
		T_TIPO_DATA('202764'),
		T_TIPO_DATA('202769'),
		T_TIPO_DATA('202779'),
		T_TIPO_DATA('202793'),
		T_TIPO_DATA('203090'),
		T_TIPO_DATA('203094'),
		T_TIPO_DATA('203095'),
		T_TIPO_DATA('203157'),
		T_TIPO_DATA('203167'),
		T_TIPO_DATA('203168'),
		T_TIPO_DATA('203330'),
		T_TIPO_DATA('203333'),
		T_TIPO_DATA('203470'),
		T_TIPO_DATA('203471'),
		T_TIPO_DATA('203484'),
		T_TIPO_DATA('203491'),
		T_TIPO_DATA('203493'),
		T_TIPO_DATA('203920'),
		T_TIPO_DATA('203921'),
		T_TIPO_DATA('203924'),
		T_TIPO_DATA('204220'),
		T_TIPO_DATA('204224'),
		T_TIPO_DATA('204225'),
		T_TIPO_DATA('204232'),
		T_TIPO_DATA('204298'),
		T_TIPO_DATA('204306'),
		T_TIPO_DATA('204313'),
		T_TIPO_DATA('204318'),
		T_TIPO_DATA('204319'),
		T_TIPO_DATA('204322'),
		T_TIPO_DATA('204417'),
		T_TIPO_DATA('204520'),
		T_TIPO_DATA('204521'),
		T_TIPO_DATA('204541'),
		T_TIPO_DATA('204548'),
		T_TIPO_DATA('933862'),
		T_TIPO_DATA('935845'),
		T_TIPO_DATA('937921'),
		T_TIPO_DATA('204223'),
		T_TIPO_DATA('202759'),
		T_TIPO_DATA('202771'),
		T_TIPO_DATA('202777'),
		T_TIPO_DATA('202791'),
		T_TIPO_DATA('203093'),
		T_TIPO_DATA('203096'),
		T_TIPO_DATA('203098'),
		T_TIPO_DATA('203156'),
		T_TIPO_DATA('203172'),
		T_TIPO_DATA('203339'),
		T_TIPO_DATA('203344'),
		T_TIPO_DATA('203346'),
		T_TIPO_DATA('203472'),
		T_TIPO_DATA('203476'),
		T_TIPO_DATA('203482'),
		T_TIPO_DATA('203496'),
		T_TIPO_DATA('203853'),
		T_TIPO_DATA('203918'),
		T_TIPO_DATA('203923'),
		T_TIPO_DATA('204199'),
		T_TIPO_DATA('204217'),
		T_TIPO_DATA('204296'),
		T_TIPO_DATA('204301'),
		T_TIPO_DATA('204308'),
		T_TIPO_DATA('204309'),
		T_TIPO_DATA('204314'),
		T_TIPO_DATA('204414'),
		T_TIPO_DATA('204508'),
		T_TIPO_DATA('204511'),
		T_TIPO_DATA('204524'),
		T_TIPO_DATA('202757'),
		T_TIPO_DATA('202775'),
		T_TIPO_DATA('202776'),
		T_TIPO_DATA('202789'),
		T_TIPO_DATA('203089'),
		T_TIPO_DATA('203091'),
		T_TIPO_DATA('203154'),
		T_TIPO_DATA('203173'),
		T_TIPO_DATA('203332'),
		T_TIPO_DATA('203338'),
		T_TIPO_DATA('203340'),
		T_TIPO_DATA('203341'),
		T_TIPO_DATA('203347'),
		T_TIPO_DATA('203468'),
		T_TIPO_DATA('203478'),
		T_TIPO_DATA('203481'),
		T_TIPO_DATA('203487'),
		T_TIPO_DATA('203494'),
		T_TIPO_DATA('203929'),
		T_TIPO_DATA('204215'),
		T_TIPO_DATA('204304'),
		T_TIPO_DATA('204307'),
		T_TIPO_DATA('204412'),
		T_TIPO_DATA('204423'),
		T_TIPO_DATA('204528'),
		T_TIPO_DATA('204530'),
		T_TIPO_DATA('204542'),
		T_TIPO_DATA('204544'),
		T_TIPO_DATA('204545')

  ); 

--------------------------------------------------------------
-- FIN ZONA PARA EDITAR               ------------------------
--------------------------------------------------------------


  V_TMP_TIPO_DATA T_TIPO_DATA;
  
BEGIN	

 DBMS_OUTPUT.PUT_LINE('[INICIO] ');


 
   -- LOOP para marcar activos a reenviar por el detector de cambios
 -----------------------------------------------------------------
   FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
     LOOP
    
       V_TMP_TIPO_DATA := V_TIPO_DATA(I);
       
       -------------------------------------------------
       --Comprobamos que el activo existe--
       -------------------------------------------------
       
       DBMS_OUTPUT.PUT_LINE('[INFO]: MARCADO PARA REENVIAR ACTIVO: '''|| TRIM(V_TMP_TIPO_DATA(1)) ||'''');


       V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.SWH_STOCK_ACT_WEBCOM_HIST WHERE ID_ACTIVO_HAYA = '''||TRIM(V_TMP_TIPO_DATA(1))||'''';
       EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
       
       --Si existe, se borra
       IF V_NUM_TABLAS > 0 THEN				         
		
            DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAMOS EL REGISTRO '''|| TRIM(V_TMP_TIPO_DATA(1)) ||''' EN SWH_STOCK_ACT_WEBCOM_HIST');
            V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.SWH_STOCK_ACT_WEBCOM_HIST WHERE ID_ACTIVO_HAYA = '||V_TMP_TIPO_DATA(1);

          	EXECUTE IMMEDIATE V_MSQL;
        
          	DBMS_OUTPUT.PUT_LINE('[INFO]: ACTIVO '''|| TRIM(V_TMP_TIPO_DATA(1)) ||''' MARCADO PARA REENVIAR');
			
       --Si no existe, se informa
       ELSE
     
        DBMS_OUTPUT.PUT_LINE('[INFO]: EL ACTIVO '''|| TRIM(V_TMP_TIPO_DATA(1)) ||''' NO EXISTE, NO SE MARCARÁ PARA REENVIAR');   
        
       END IF;
      	
    END LOOP;
    
   COMMIT;
   
   DBMS_OUTPUT.PUT_LINE('[FIN]: PROCESO FINALIZADO CORRECTAMENTE ');
 

EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
