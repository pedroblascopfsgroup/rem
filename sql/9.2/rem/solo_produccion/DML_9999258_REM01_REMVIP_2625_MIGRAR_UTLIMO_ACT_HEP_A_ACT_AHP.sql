--/*
--##########################################
--## AUTOR=DAP
--## FECHA_CREACION=20181123
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-2625
--## PRODUCTO=NO
--##
--## Finalidad: Script de salvación o no.
--## VERSIONES:
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE

    V_ESQUEMA   VARCHAR2(50 CHAR) := 'REM01';
    V_MSQL      VARCHAR2(32000 CHAR);
    SOURCE_DATA VARCHAR2(3 CHAR) := 'ACT';
    DATA_SOURCE VARCHAR2(32000 CHAR);
    V_COMERCIAL VARCHAR2(32000 CHAR);
    V_RESERVA   VARCHAR2(32000 CHAR);
    V_ACT_NUM   VARCHAR2(16 CHAR) := '';
    V_ACT_ID    NUMBER(16);
    V_WHERE     VARCHAR2(32 CHAR);
    V_WHERE2    VARCHAR2(32 CHAR);

BEGIN   

    IF V_ACT_NUM IS NOT NULL THEN
        V_MSQL := 'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '''||V_ACT_NUM||''' AND BORRADO = 0';
        EXECUTE IMMEDIATE V_MSQL INTO V_ACT_ID;
        V_WHERE := 'WHERE T1.ACT_ID = '||V_ACT_ID;
        V_WHERE2 := REPLACE(V_WHERE, 'T1', 'ACT');
    END IF;

    V_COMERCIAL := 
        'COMERCIAL AS (
            SELECT ACT.ACT_ID, TCO.DD_TCO_ID, TCO.DD_TCO_CODIGO, TCO.DD_TCO_DESCRIPCION
                , SCM.DD_SCM_ID, SCM.DD_SCM_CODIGO, SCM.DD_SCM_DESCRIPCION
                , TPA.DD_TPA_ID, TPA.DD_TPA_CODIGO, TPA.DD_TPA_DESCRIPCION
                , CRA.DD_CRA_ID, CRA.DD_CRA_CODIGO, CRA.DD_CRA_DESCRIPCION
                , SPS.SPS_OCUPADO, SPS.SPS_CON_TITULO
                , CASE 
                    WHEN SPS.SPS_OCUPADO = 1 AND SPS.SPS_CON_TITULO = 1 THEN TAL.DD_TAL_ID
                    END DD_TAL_ID
                , CASE 
                    WHEN SPS.SPS_OCUPADO = 1 AND SPS.SPS_CON_TITULO = 1 THEN TAL.DD_TAL_CODIGO
                    END DD_TAL_CODIGO
                , CASE 
                    WHEN SPS.SPS_OCUPADO = 1 AND SPS.SPS_CON_TITULO = 1 THEN TAL.DD_TAL_DESCRIPCION
                    END DD_TAL_DESCRIPCION
            FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
            JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
            JOIN '||V_ESQUEMA||'.ACT_SPS_SIT_POSESORIA SPS ON SPS.ACT_ID = ACT.ACT_ID AND SPS.BORRADO = 0
            LEFT JOIN '||V_ESQUEMA||'.DD_TCO_TIPO_COMERCIALIZACION TCO ON TCO.DD_TCO_ID = ACT.DD_TCO_ID
            LEFT JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_ID = ACT.DD_SCM_ID
            LEFT JOIN '||V_ESQUEMA||'.DD_TAL_TIPO_ALQUILER TAL ON TAL.DD_TAL_ID = ACT.DD_TAL_ID
            LEFT JOIN '||V_ESQUEMA||'.DD_TPA_TIPO_ACTIVO TPA ON TPA.DD_TPA_ID = ACT.DD_TPA_ID
            WHERE ACT.BORRADO = 0)';
    
    V_RESERVA := 
        'RESERVA AS (
            SELECT ACT_ID
            FROM (
                SELECT ACT.ACT_ID, ROW_NUMBER() OVER(PARTITION BY ACT.ACT_ID ORDER BY RES.RES_ID) RN
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.ACT_OFR AO ON AO.ACT_ID = ACT.ACT_ID
                JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = AO.OFR_ID AND OFR.BORRADO = 0
                JOIN '||V_ESQUEMA||'.DD_EOF_ESTADOS_OFERTA EOF ON EOF.DD_EOF_ID = OFR.DD_EOF_ID AND EOF.DD_EOF_CODIGO = ''01''
                    AND EOF.BORRADO = 0
                JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = AO.OFR_ID AND ECO.BORRADO = 0
                JOIN '||V_ESQUEMA||'.RES_RESERVAS RES ON RES.ECO_ID = ECO.ECO_ID AND RES.BORRADO = 0
                JOIN '||V_ESQUEMA||'.DD_ERE_ESTADOS_RESERVA ERE ON ERE.DD_ERE_ID = RES.DD_ERE_ID AND ERE.DD_ERE_CODIGO = ''02'')
            WHERE RN = 1)';

    IF SOURCE_DATA = 'HEP' THEN
        DATA_SOURCE :=
            'WITH HEP AS (
                SELECT ACT_ID, DD_EPU_ID, DD_TPU_ID
                FROM (
                    SELECT ACT_ID, DD_TPU_ID, DD_EPU_ID
                        , ROW_NUMBER() OVER(PARTITION BY ACT_ID ORDER BY HEP_FECHA_HASTA DESC NULLS FIRST, HEP_ID DESC) RN
                    FROM '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION
                    WHERE BORRADO = 0)
                WHERE RN = 1)';
    ELSIF SOURCE_DATA = 'ACT' THEN
        DATA_SOURCE :=
            'WITH HEP AS (
                SELECT ACT_ID, DD_EPU_ID, DD_TPU_ID
                FROM '||V_ESQUEMA||'.ACT_ACTIVO
                WHERE BORRADO = 0)';
    END IF;
        
    DBMS_OUTPUT.PUT_LINE('[INICIO]');
    
    DBMS_OUTPUT.PUT_LINE('  INSERTAMOS ESTADOS ANTERIORES EN TABLA HISTÓRICA');
    DBMS_OUTPUT.PUT_LINE('  DESTINO COMERCIAL VENTA');
    V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_AHP_HIST_PUBLICACION (AHP_ID, ACT_ID, DD_TPU_V_ID
        , DD_EPV_ID, DD_EPA_ID, DD_TCO_ID, DD_MTO_V_ID, AHP_CHECK_PUBLICAR_V
        , AHP_CHECK_OCULTAR_V, AHP_CHECK_OCULTAR_PRECIO_V, AHP_CHECK_PUB_SIN_PRECIO_V
        , AHP_FECHA_INI_VENTA, AHP_FECHA_FIN_VENTA, USUARIOCREAR, FECHACREAR)
        WITH HEP AS (
            SELECT ACT_ID, DD_EPU_ID, DD_TPU_ID, HEP_FECHA_DESDE, HEP_FECHA_HASTA
            FROM (
                SELECT ACT_ID, DD_TPU_ID, DD_EPU_ID, HEP_FECHA_DESDE, HEP_FECHA_HASTA
                    , ROW_NUMBER() OVER(PARTITION BY ACT_ID ORDER BY HEP_FECHA_HASTA DESC NULLS FIRST, HEP_ID DESC) RN
                FROM '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION
                WHERE BORRADO = 0)
            WHERE RN = 1)
        , '||V_COMERCIAL||'
        , '||V_RESERVA||'
        SELECT '||V_ESQUEMA||'.S_ACT_AHP_HIST_PUBLICACION.NEXTVAL, HEP.ACT_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''04'') THEN (SELECT DD_TPU_ID FROM '||V_ESQUEMA||'.DD_TPU_TIPO_PUBLICACION WHERE DD_TPU_CODIGO = ''01'')
                WHEN EPU.DD_EPU_CODIGO IN (''02'',''07'') THEN (SELECT DD_TPU_ID FROM '||V_ESQUEMA||'.DD_TPU_TIPO_PUBLICACION WHERE DD_TPU_CODIGO = ''02'')
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN NULL
                ELSE HEP.DD_TPU_ID
                END DD_TPU_V_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_SCM_CODIGO = ''05'' THEN (SELECT DD_EPV_ID FROM '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA WHERE DD_EPV_CODIGO = ''04'')
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'',''03'',''05'') AND RES.ACT_ID IS NOT NULL THEN (SELECT DD_EPV_ID FROM '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA WHERE DD_EPV_CODIGO = ''04'') 
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND (CO.DD_TAL_CODIGO IS NULL OR CO.DD_TAL_CODIGO = ''01'') THEN (SELECT DD_EPV_ID FROM '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA WHERE DD_EPV_CODIGO = ''03'') 
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND CO.DD_TAL_CODIGO IN (''02'',''03'',''04'') THEN (SELECT DD_EPV_ID FROM '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA WHERE DD_EPV_CODIGO = ''04'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') THEN (SELECT DD_EPV_ID FROM '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA WHERE DD_EPV_CODIGO = ''04'')  
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN (SELECT DD_EPV_ID FROM '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA WHERE DD_EPV_CODIGO = ''01'')  
                END DD_EPV_ID
            , CASE
                WHEN CO.DD_TCO_CODIGO = ''01'' THEN EPA.DD_EPA_ID
                END DD_EPA_ID
            , CO.DD_TCO_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_SCM_CODIGO = ''05'' THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''13'')
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'',''03'',''05'') AND RES.ACT_ID IS NOT NULL THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''07'')
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND CO.DD_TAL_CODIGO IN (''02'',''03'',''04'') THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''03'')
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN NULL
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND NVL(PAC.PAC_INCLUIDO,0) = 0 THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''08'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_SCM_CODIGO = ''01'' THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''02'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_TAL_CODIGO IN (''02'',''03'',''04'') THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''03'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''12'')
                END DD_MTO_V_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN 0 
                ELSE 1 
                END APH_CHECK_PUBLICAR_V
            , CASE
                WHEN (EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND (CO.DD_TAL_CODIGO IS NULL OR CO.DD_TAL_CODIGO = ''01'')) OR EPU.DD_EPU_CODIGO = ''06'' THEN 0
                ELSE 1
                END APH_CHECK_OCULTAR_V
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''04'',''07'') THEN 1
                ELSE 0
                END APH_CHECK_OCULTAR_PRECIO_V
            , CASE
                WHEN CO.DD_CRA_CODIGO = ''02'' AND NVL(CO.DD_TPA_CODIGO,''00'') = ''01'' THEN 1
                ELSE 0
                END APH_CHECK_PUB_SIN_PRECIO_V
            , NVL(HEP.HEP_FECHA_DESDE,SYSDATE) AS AHP_FECHA_INI_VENTA
            , NVL(HEP.HEP_FECHA_HASTA,SYSDATE) AS AHP_FECHA_FIN_VENTA
            , ''REMVIP-2625'' USUARIO, SYSDATE FECHA
        FROM HEP
        JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = HEP.ACT_ID
        JOIN COMERCIAL CO ON CO.ACT_ID = HEP.ACT_ID AND CO.DD_TCO_CODIGO = ''01''
        JOIN '||V_ESQUEMA||'.DD_EPA_ESTADO_PUB_ALQUILER EPA ON EPA.DD_EPA_CODIGO = ''01''
        JOIN '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION EPU ON EPU.DD_EPU_ID = HEP.DD_EPU_ID
        LEFT JOIN '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = HEP.ACT_ID
        LEFT JOIN RESERVA RES ON RES.ACT_ID = HEP.ACT_ID
        '||V_WHERE2||' WHERE NOT EXISTS (SELECT 1  
					FROM REM01.ACT_AHP_HIST_PUBLICACION HISTO 
					JOIN REM01.ACT_ACTIVO ACTO ON ACTO.ACT_ID = HISTO.ACT_ID 
					WHERE HISTO.USUARIOCREAR != ''MIGRACION_PUBLICACIONES'' 
					AND  HISTO.USUARIOCREAR != ''MIGRACION_ESTADOS'' 
					AND  HISTO.ACT_ID = HEP.ACT_ID)';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('      REGISTROS INSERTADOS: '||SQL%ROWCOUNT);
    
    DBMS_OUTPUT.PUT_LINE('  INSERTAMOS ESTADOS ANTERIORES EN TABLA HISTÓRICA');
    DBMS_OUTPUT.PUT_LINE('  DESTINO COMERCIAL ALQUILER');
    V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_AHP_HIST_PUBLICACION (AHP_ID, ACT_ID, DD_TPU_A_ID
            , DD_EPV_ID, DD_EPA_ID, DD_TCO_ID, DD_MTO_A_ID, AHP_CHECK_PUBLICAR_A
            , AHP_CHECK_OCULTAR_A, AHP_CHECK_OCULTAR_PRECIO_A, AHP_CHECK_PUB_SIN_PRECIO_A
            , AHP_FECHA_INI_ALQUILER, AHP_FECHA_FIN_ALQUILER, USUARIOCREAR, FECHACREAR)
        WITH HEP AS (
            SELECT ACT_ID, DD_EPU_ID, DD_TPU_ID, HEP_FECHA_DESDE, HEP_FECHA_HASTA
            FROM (
                SELECT ACT_ID, DD_TPU_ID, DD_EPU_ID, HEP_FECHA_DESDE, HEP_FECHA_HASTA
                    , ROW_NUMBER() OVER(PARTITION BY ACT_ID ORDER BY HEP_FECHA_HASTA DESC NULLS FIRST, HEP_ID DESC) RN
                FROM '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION
                WHERE BORRADO = 0)
            WHERE RN = 1)
        , '||V_COMERCIAL||'
        , '||V_RESERVA||'
        SELECT '||V_ESQUEMA||'.S_ACT_AHP_HIST_PUBLICACION.NEXTVAL, HEP.ACT_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''04'') THEN (SELECT DD_TPU_ID FROM '||V_ESQUEMA||'.DD_TPU_TIPO_PUBLICACION WHERE DD_TPU_CODIGO = ''01'')
                WHEN EPU.DD_EPU_CODIGO IN (''02'',''07'') THEN (SELECT DD_TPU_ID FROM '||V_ESQUEMA||'.DD_TPU_TIPO_PUBLICACION WHERE DD_TPU_CODIGO = ''02'')
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN NULL
                ELSE HEP.DD_TPU_ID
                END DD_TPU_A_ID
            , EPV.DD_EPV_ID AS DD_EPV_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_SCM_CODIGO = ''05'' THEN (SELECT DD_EPA_ID FROM '||V_ESQUEMA||'.DD_EPA_ESTADO_PUB_ALQUILER WHERE DD_EPA_CODIGO = ''04'')  
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'',''03'',''05'') AND RES.ACT_ID IS NOT NULL THEN (SELECT DD_EPA_ID FROM '||V_ESQUEMA||'.DD_EPA_ESTADO_PUB_ALQUILER WHERE DD_EPA_CODIGO = ''04'') 
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND CO.DD_TAL_CODIGO IS NULL THEN (SELECT DD_EPA_ID FROM '||V_ESQUEMA||'.DD_EPA_ESTADO_PUB_ALQUILER WHERE DD_EPA_CODIGO = ''03'') 
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND CO.DD_TAL_CODIGO IS NOT NULL THEN (SELECT DD_EPA_ID FROM '||V_ESQUEMA||'.DD_EPA_ESTADO_PUB_ALQUILER WHERE DD_EPA_CODIGO = ''04'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') THEN (SELECT DD_EPA_ID FROM '||V_ESQUEMA||'.DD_EPA_ESTADO_PUB_ALQUILER WHERE DD_EPA_CODIGO = ''04'')  
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN (SELECT DD_EPA_ID FROM '||V_ESQUEMA||'.DD_EPA_ESTADO_PUB_ALQUILER WHERE DD_EPA_CODIGO = ''01'')  
                END DD_EPA_ID
            , CO.DD_TCO_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_SCM_CODIGO = ''05'' THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''13'')
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'',''03'',''05'') AND RES.ACT_ID IS NOT NULL THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''07'')
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND CO.DD_TAL_CODIGO IN (''01'',''02'',''03'',''04'') THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''03'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND NVL(PAC.PAC_INCLUIDO,0) = 0 THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''08'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_SCM_CODIGO = ''01'' THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''02'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_TAL_CODIGO IN (''02'',''03'',''04'') THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''03'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''12'')
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN NULL
                END DD_MTO_A_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN 0 
                ELSE 1 
                END AHP_CHECK_PUBLICAR_A
            , CASE
                WHEN (EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND (CO.DD_TAL_CODIGO IS NOT NULL)) OR EPU.DD_EPU_CODIGO IN (''03'',''05'') THEN 1
                ELSE 0
                END AHP_CHECK_OCULTAR_A
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''04'',''07'') THEN 1
                ELSE 0
                END AHP_CHECK_OCULTAR_PRECIO_A
            , 0 AHP_CHECK_PUB_SIN_PRECIO_A
            , NVL(HEP.HEP_FECHA_DESDE,SYSDATE) AS AHP_FECHA_INI_ALQUILER
            , NVL(HEP.HEP_FECHA_HASTA,SYSDATE) AS AHP_FECHA_FIN_ALQUILER
            , ''REMVIP-2625'' USUARIO, SYSDATE FECHA
        FROM HEP
        JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = HEP.ACT_ID AND ACT.BORRADO = 0
        JOIN COMERCIAL CO ON CO.ACT_ID = HEP.ACT_ID AND CO.DD_TCO_CODIGO IN (''03'',''04'')
        JOIN '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA EPV ON EPV.DD_EPV_CODIGO = ''01''
        JOIN '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION EPU ON EPU.DD_EPU_ID = HEP.DD_EPU_ID
        LEFT JOIN '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = HEP.ACT_ID
        LEFT JOIN '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION APU ON APU.ACT_ID = HEP.ACT_ID
        LEFT JOIN RESERVA RES ON RES.ACT_ID = HEP.ACT_ID
        '||V_WHERE2||' WHERE NOT EXISTS (SELECT 1  
					FROM REM01.ACT_AHP_HIST_PUBLICACION HISTO 
					JOIN REM01.ACT_ACTIVO ACTO ON ACTO.ACT_ID = HISTO.ACT_ID 
					WHERE HISTO.USUARIOCREAR != ''MIGRACION_PUBLICACIONES'' 
					AND  HISTO.USUARIOCREAR != ''MIGRACION_ESTADOS'' 
					AND  HISTO.ACT_ID = HEP.ACT_ID)';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('      REGISTROS INSERTADOS: '||SQL%ROWCOUNT);
    
    DBMS_OUTPUT.PUT_LINE('  INSERTAMOS ESTADOS ANTERIORES EN TABLA HISTÓRICA');
    DBMS_OUTPUT.PUT_LINE('  DESTINO COMERCIAL ALQUILER Y VENTA');
    V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_AHP_HIST_PUBLICACION (AHP_ID, ACT_ID, DD_TPU_V_ID, DD_TPU_A_ID
            , DD_TCO_ID, DD_EPV_ID, DD_MTO_V_ID, AHP_CHECK_PUBLICAR_V, AHP_CHECK_OCULTAR_V
            , AHP_CHECK_OCULTAR_PRECIO_V, AHP_CHECK_PUB_SIN_PRECIO_V
            , DD_EPA_ID, DD_MTO_A_ID, AHP_CHECK_PUBLICAR_A, AHP_CHECK_OCULTAR_A
            , AHP_CHECK_OCULTAR_PRECIO_A, AHP_CHECK_PUB_SIN_PRECIO_A
            , AHP_FECHA_INI_VENTA, AHP_FECHA_FIN_VENTA, AHP_FECHA_INI_ALQUILER
            , AHP_FECHA_FIN_ALQUILER, USUARIOCREAR, FECHACREAR)
        WITH HEP AS (
            SELECT ACT_ID, DD_EPU_ID, DD_TPU_ID, HEP_FECHA_DESDE, HEP_FECHA_HASTA
            FROM (
                SELECT ACT_ID, DD_TPU_ID, DD_EPU_ID, HEP_FECHA_DESDE, HEP_FECHA_HASTA
                    , ROW_NUMBER() OVER(PARTITION BY ACT_ID ORDER BY HEP_FECHA_HASTA DESC NULLS FIRST, HEP_ID DESC) RN
                FROM '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION
                WHERE BORRADO = 0)
            WHERE RN = 1)
        , '||V_COMERCIAL||'
        , '||V_RESERVA||'
        SELECT '||V_ESQUEMA||'.S_ACT_AHP_HIST_PUBLICACION.NEXTVAL, HEP.ACT_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''04'') THEN (SELECT DD_TPU_ID FROM '||V_ESQUEMA||'.DD_TPU_TIPO_PUBLICACION WHERE DD_TPU_CODIGO = ''01'')
                WHEN EPU.DD_EPU_CODIGO IN (''02'',''07'') THEN (SELECT DD_TPU_ID FROM '||V_ESQUEMA||'.DD_TPU_TIPO_PUBLICACION WHERE DD_TPU_CODIGO = ''02'')
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN NULL
                ELSE HEP.DD_TPU_ID
                END DD_TPU_V_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''04'') THEN (SELECT DD_TPU_ID FROM '||V_ESQUEMA||'.DD_TPU_TIPO_PUBLICACION WHERE DD_TPU_CODIGO = ''01'')
                WHEN EPU.DD_EPU_CODIGO IN (''02'',''07'') THEN (SELECT DD_TPU_ID FROM '||V_ESQUEMA||'.DD_TPU_TIPO_PUBLICACION WHERE DD_TPU_CODIGO = ''02'')
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN NULL
                ELSE HEP.DD_TPU_ID
                END DD_TPU_A_ID
            , CO.DD_TCO_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_SCM_CODIGO = ''05'' THEN (SELECT DD_EPV_ID FROM '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA WHERE DD_EPV_CODIGO = ''04'')  
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'',''03'',''05'') AND RES.ACT_ID IS NOT NULL THEN (SELECT DD_EPV_ID FROM '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA WHERE DD_EPV_CODIGO = ''04'') 
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND (CO.DD_TAL_CODIGO IS NULL OR CO.DD_TAL_CODIGO = ''01'') THEN (SELECT DD_EPV_ID FROM '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA WHERE DD_EPV_CODIGO = ''03'') 
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND CO.DD_TAL_CODIGO IN (''02'',''03'',''04'') THEN (SELECT DD_EPV_ID FROM '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA WHERE DD_EPV_CODIGO = ''04'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') THEN (SELECT DD_EPV_ID FROM '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA WHERE DD_EPV_CODIGO = ''04'')  
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN (SELECT DD_EPV_ID FROM '||V_ESQUEMA||'.DD_EPV_ESTADO_PUB_VENTA WHERE DD_EPV_CODIGO = ''01'')  
                END DD_EPV_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_SCM_CODIGO = ''05'' THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''13'')
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'',''03'',''05'') AND RES.ACT_ID IS NOT NULL THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''07'')
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND CO.DD_TAL_CODIGO IN (''02'',''03'',''04'') THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''03'')
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN NULL
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND NVL(PAC.PAC_INCLUIDO,0) = 0 THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''08'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_SCM_CODIGO = ''01'' THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''02'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_TAL_CODIGO IN (''02'',''03'',''04'') THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''03'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''12'')
                END DD_MTO_V_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN 0 
                ELSE 1 
                END APH_CHECK_PUBLICAR_V
            , CASE
                WHEN (EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND (CO.DD_TAL_CODIGO IS NULL OR CO.DD_TAL_CODIGO = ''01'')) OR EPU.DD_EPU_CODIGO = ''06'' THEN 0
                ELSE 1
                END APH_CHECK_OCULTAR_V
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''04'',''07'') THEN 1
                ELSE 0
                END APH_CHECK_OCULTAR_PRECIO_V
            , CASE
                WHEN CO.DD_CRA_CODIGO = ''02'' AND NVL(CO.DD_TPA_CODIGO,''00'') = ''01'' THEN 1
                ELSE 0
                END APH_CHECK_PUB_SIN_PRECIO_V
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_SCM_CODIGO = ''05'' THEN (SELECT DD_EPA_ID FROM '||V_ESQUEMA||'.DD_EPA_ESTADO_PUB_ALQUILER WHERE DD_EPA_CODIGO = ''04'')  
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'',''03'',''05'') AND RES.ACT_ID IS NOT NULL THEN (SELECT DD_EPA_ID FROM '||V_ESQUEMA||'.DD_EPA_ESTADO_PUB_ALQUILER WHERE DD_EPA_CODIGO = ''04'') 
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND CO.DD_TAL_CODIGO IS NULL THEN (SELECT DD_EPA_ID FROM '||V_ESQUEMA||'.DD_EPA_ESTADO_PUB_ALQUILER WHERE DD_EPA_CODIGO = ''03'') 
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND CO.DD_TAL_CODIGO IS NOT NULL THEN (SELECT DD_EPA_ID FROM '||V_ESQUEMA||'.DD_EPA_ESTADO_PUB_ALQUILER WHERE DD_EPA_CODIGO = ''04'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') THEN (SELECT DD_EPA_ID FROM '||V_ESQUEMA||'.DD_EPA_ESTADO_PUB_ALQUILER WHERE DD_EPA_CODIGO = ''04'')  
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN (SELECT DD_EPA_ID FROM '||V_ESQUEMA||'.DD_EPA_ESTADO_PUB_ALQUILER WHERE DD_EPA_CODIGO = ''01'')  
                END DD_EPA_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_SCM_CODIGO = ''05'' THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''13'')
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'',''03'',''05'') AND RES.ACT_ID IS NOT NULL THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''07'')
                WHEN EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND CO.DD_TAL_CODIGO IN (''01'',''02'',''03'',''04'') THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''03'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND NVL(PAC.PAC_INCLUIDO,0) = 0 THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''08'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_SCM_CODIGO = ''01'' THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''02'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') AND CO.DD_TAL_CODIGO IN (''02'',''03'',''04'') THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''03'')
                WHEN EPU.DD_EPU_CODIGO IN (''03'',''05'') THEN (SELECT DD_MTO_ID FROM '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION WHERE DD_MTO_CODIGO = ''12'')
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN NULL
                END DD_MTO_A_ID
            , CASE
                WHEN EPU.DD_EPU_CODIGO = ''06'' THEN 0 
                ELSE 1 
                END AHP_CHECK_PUBLICAR_A
            , CASE
                WHEN (EPU.DD_EPU_CODIGO IN (''01'',''02'',''04'',''07'') AND (CO.DD_TAL_CODIGO IS NOT NULL)) OR EPU.DD_EPU_CODIGO IN (''03'',''05'') THEN 1
                ELSE 0
                END AHP_CHECK_OCULTAR_A
            , CASE
                WHEN EPU.DD_EPU_CODIGO IN (''04'',''07'') THEN 1
                ELSE 0
                END AHP_CHECK_OCULTAR_PRECIO_A
            , 0 AHP_CHECK_PUB_SIN_PRECIO_A
            , NVL(HEP.HEP_FECHA_DESDE,SYSDATE) AS AHP_FECHA_INI_VENTA
            , NVL(HEP.HEP_FECHA_HASTA,SYSDATE) AS AHP_FECHA_FIN_VENTA
            , NVL(HEP.HEP_FECHA_DESDE,SYSDATE) AS AHP_FECHA_INI_ALQUILER
            , NVL(HEP.HEP_FECHA_HASTA,SYSDATE) AS AHP_FECHA_FIN_ALQUILER
            , ''REMVIP-2625'' USUARIO, SYSDATE FECHA
        FROM HEP
        JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = HEP.ACT_ID
        JOIN COMERCIAL CO ON CO.ACT_ID = HEP.ACT_ID AND CO.DD_TCO_CODIGO = ''02''
        JOIN '||V_ESQUEMA||'.DD_EPU_ESTADO_PUBLICACION EPU ON EPU.DD_EPU_ID = HEP.DD_EPU_ID
        LEFT JOIN '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = HEP.ACT_ID
        LEFT JOIN RESERVA RES ON RES.ACT_ID = HEP.ACT_ID 
        '||V_WHERE2||' WHERE NOT EXISTS (SELECT 1  
					FROM REM01.ACT_AHP_HIST_PUBLICACION HISTO 
					JOIN REM01.ACT_ACTIVO ACTO ON ACTO.ACT_ID = HISTO.ACT_ID 
					WHERE HISTO.USUARIOCREAR != ''MIGRACION_PUBLICACIONES'' 
					AND  HISTO.USUARIOCREAR != ''MIGRACION_ESTADOS'' 
					AND  HISTO.ACT_ID = HEP.ACT_ID)';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('      REGISTROS INSERTADOS: '||SQL%ROWCOUNT);
    
    DBMS_OUTPUT.PUT_LINE('[FIN]');
            
    COMMIT;

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(SQLERRM);
    DBMS_OUTPUT.put_line(V_MSQL);
    ROLLBACK;
    RAISE;          
END;
/
EXIT
