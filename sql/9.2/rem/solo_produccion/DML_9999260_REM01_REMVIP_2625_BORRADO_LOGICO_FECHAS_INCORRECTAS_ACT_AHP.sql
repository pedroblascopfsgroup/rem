--/*
--##########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20181125
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-2625
--## PRODUCTO=NO
--##
--## Finalidad: Script para borrar migradas desde ACT_HEP_HIST_EST_PUBLICACION, CON FECHAS INCORRECTAS
--## VERSIONES:
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE

    V_ESQUEMA   VARCHAR2(50 CHAR) := 'REM01';
    V_MSQL      VARCHAR2(32000 CHAR);
    SOURCE_DATA VARCHAR2(3 CHAR) := 'ACT';
    DATA_SOURCE VARCHAR2(32000 CHAR);

BEGIN   

    DBMS_OUTPUT.PUT_LINE('[INICIO]');

    DBMS_OUTPUT.PUT_LINE('  BORRADO LOGICO DE MIGRADAS PARA VENTA, CON FECHAS MAL');
    V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_AHP_HIST_PUBLICACION SET 
                    USUARIOBORRAR = ''REMVIP-2625_2'', 
                    FECHABORRAR = SYSDATE, 
                    BORRADO = 1 
                    WHERE AHP_ID IN   ( SELECT AHP_ID FROM REM01.ACT_AHP_HIST_PUBLICACION 
					WHERE USUARIOCREAR = ''REMVIP-2625'' 
					AND TRUNC(AHP_FECHA_INI_VENTA) > TRUNC(AHP_FECHA_FIN_VENTA) 
					AND BORRADO = 0)';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE(' REGISTROS BORRADOS: '||SQL%ROWCOUNT);

    DBMS_OUTPUT.PUT_LINE('  BORRADO LOGICO DE MIGRADAS PARA ALQUILER, CON FECHAS MAL');
    V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_AHP_HIST_PUBLICACION SET 
                    USUARIOBORRAR = ''REMVIP-2625_2'', 
                    FECHABORRAR = SYSDATE, 
                    BORRADO = 1 
                    WHERE AHP_ID IN   ( SELECT AHP_ID FROM REM01.ACT_AHP_HIST_PUBLICACION 
					WHERE USUARIOCREAR = ''REMVIP-2625'' 
					AND TRUNC(AHP_FECHA_INI_ALQUILER) > TRUNC(AHP_FECHA_FIN_ALQUILER) 
					AND BORRADO = 0)';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE(' REGISTROS BORRADOS: '||SQL%ROWCOUNT);
    
    DBMS_OUTPUT.PUT_LINE('[FIN]');
            
    COMMIT;

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecuci√≥n:'||TO_CHAR(SQLCODE));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(SQLERRM);
    DBMS_OUTPUT.put_line(V_MSQL);
    ROLLBACK;
    RAISE;          
END;
/
EXIT
