--/*
--#########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20181126
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.0.17
--## INCIDENCIA_LINK=REMVIP-2659
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; --'#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; --'#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(25 CHAR):= 'ACT_TIT_TITULO';
    V_COUNT NUMBER(16); -- Vble. para contar.
    V_KOUNT NUMBER(16); -- Vble. para kontar.
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USUARIO VARCHAR2(32 CHAR):= 'REMVIP-2659';

	ACT_NUM_ACTIVO NUMBER(16);
	ORIGEN_BMN NUMBER(1);
	--ACT_ID VARCHAR2(55 CHAR);

    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
		 T_JBV(6914207,0)
		,T_JBV(8571252,0)
		,T_JBV(7912870,0)
		,T_JBV(15677792,0)
		,T_JBV(8549895,0)
		,T_JBV(32131627,1)
		,T_JBV(32136070,1)
		,T_JBV(32042916,1)
		,T_JBV(32235316,1)
		,T_JBV(12682585,0)
		,T_JBV(33203031,1)
		,T_JBV(13623429,0)
		,T_JBV(13623780,0)
		,T_JBV(13623897,0)
		,T_JBV(13623915,0)
		,T_JBV(13624089,0)
		,T_JBV(13624107,0)
		,T_JBV(13624224,0)
		,T_JBV(13624341,0)
		,T_JBV(13624458,0)
		,T_JBV(13624575,0)
		,T_JBV(13624692,0)
		,T_JBV(13624710,0)
		,T_JBV(13624827,0)
		,T_JBV(13624944,0)
		,T_JBV(13625019,0)
		,T_JBV(13625136,0)
		,T_JBV(13625253,0)
		,T_JBV(13625370,0)
		,T_JBV(13625487,0)
		,T_JBV(13625505,0)
		,T_JBV(13625622,0)
		,T_JBV(13625739,0)
		,T_JBV(13625856,0)
		,T_JBV(13625973,0)
		,T_JBV(13626048,0)
		,T_JBV(13626282,0)
		,T_JBV(13626300,0)
		,T_JBV(13626417,0)
		,T_JBV(13626534,0)
		,T_JBV(13626651,0)
		,T_JBV(13626768,0)
		,T_JBV(13626885,0)
		,T_JBV(13626903,0)
		,T_JBV(13627077,0)
		,T_JBV(13627194,0)
		,T_JBV(32426846,1)
		,T_JBV(32426963,1)
		,T_JBV(32427038,1)
		,T_JBV(33670658,1)
		,T_JBV(22767740,0)
		,T_JBV(33623572,1)
		,T_JBV(33576359,1)
		,T_JBV(5357261,0)
		,T_JBV(33560721,1)
		,T_JBV(13587411,0)
		,T_JBV(33702504,1)
		,T_JBV(32440464,1)
		,T_JBV(32420519,0)
		,T_JBV(19326093,0)
		,T_JBV(33719288,1)
		,T_JBV(21219086,0)
		,T_JBV(25217842,0)
		,T_JBV(19450755,0)
		,T_JBV(20610951,0)
		,T_JBV(20611026,0)
		,T_JBV(32993659,1)
		,T_JBV(33279746,1)
		,T_JBV(5754401,0)
		,T_JBV(19765217,0)
		,T_JBV(12885871,0)
		,T_JBV(32305093,1)
		,T_JBV(32212482,1)
		,T_JBV(16027950,0)
		,T_JBV(33562176,1)
		,T_JBV(32818263,1)
		,T_JBV(9112823,0)
		,T_JBV(32437807,1)
		,T_JBV(32437924,1)
		,T_JBV(32438098,1)
		,T_JBV(32438116,1)
		,T_JBV(20743839,0)
		,T_JBV(32483477,1)
		,T_JBV(33641090,1)
		,T_JBV(33718259,1)
		,T_JBV(19295897,0)
		,T_JBV(33585964,1)
		,T_JBV(28094447,0)
		,T_JBV(33730053,1)
		,T_JBV(5174892,0)
		,T_JBV(31892939,1)
		,T_JBV(32631877,1)
		,T_JBV(32631760,1)
		,T_JBV(32632069,1)
		,T_JBV(32632186,1)
		,T_JBV(32632321,1)
		,T_JBV(32632438,1)
		,T_JBV(32621963,1)
		,T_JBV(32622038,1)
		,T_JBV(32622155,1)
		,T_JBV(32621846,1)
		,T_JBV(32447118,1)
		,T_JBV(32448750,1)
		,T_JBV(32449176,1)
		,T_JBV(20890948,0)
		,T_JBV(33575681,1)
		,T_JBV(19710331,0)
		,T_JBV(33351169,1)
		,T_JBV(14899138,0)
		,T_JBV(11849241,0)
		,T_JBV(32439379,1)
		,T_JBV(33410021,1)
		,T_JBV(31596518,1)
		,T_JBV(31641421,1)
		,T_JBV(31642702,1)
		,T_JBV(31630829,1)
		,T_JBV(31508126,1)
		,T_JBV(31663208,1)
		,T_JBV(31663325,1)
		,T_JBV(31663442,1)
		,T_JBV(31663559,1)
		,T_JBV(31629258,1)
		,T_JBV(31524423,1)
		,T_JBV(12092109,0)
		,T_JBV(31938464,1)
		,T_JBV(31800998,1)
		,T_JBV(33468480,1)
		,T_JBV(32089109,1)
		,T_JBV(32091691,1)
		,T_JBV(32765794,1)
		,T_JBV(5558003,0)
		,T_JBV(12703470,0)
		,T_JBV(22660109,0)
		,T_JBV(33585244,1)
		,T_JBV(33585361,1)
		,T_JBV(12075737,0)
		,T_JBV(33360891,1)
		,T_JBV(10590362,0)
		,T_JBV(33542231,1)
		,T_JBV(12419876,0)
		,T_JBV(33107025,1)
		,T_JBV(33042818,1)
		,T_JBV(32273751,1)
		,T_JBV(33295674,1)
		,T_JBV(32906296,1)
		,T_JBV(32906665,1)
		,T_JBV(32280794,1)
		,T_JBV(19305605,0)
		,T_JBV(32461222,1)
		,T_JBV(33573020,1)
		,T_JBV(16263536,0)
		,T_JBV(33702135,1)
		,T_JBV(33120685,1)
		,T_JBV(32475405,1)
		,T_JBV(32454278,1)
		,T_JBV(21233928,0)
		,T_JBV(16592570,0)
		,T_JBV(28140982,0)
		,T_JBV(28141057,0)
		,T_JBV(33687460,1)
		,T_JBV(33687694,1)
		,T_JBV(33687712,1)
		,T_JBV(33687829,1)
		,T_JBV(33687946,1)
		,T_JBV(33688021,1)
		,T_JBV(33688138,1)
		,T_JBV(33688255,1)
		,T_JBV(33688372,1)
		,T_JBV(33110420,1)
		,T_JBV(33108657,1)
		,T_JBV(32884148,1)
		,T_JBV(21630195,0)
		,T_JBV(33621262,1)
		,T_JBV(20048337,0)
		,T_JBV(28669556,0)
		,T_JBV(10527582,0)
		,T_JBV(12094284,0)
		,T_JBV(31935476,1)
		,T_JBV(32067556,1)
		,T_JBV(32147751,1)
		,T_JBV(32101633,1)
		,T_JBV(32201422,1)
		,T_JBV(9153274,0)
		,T_JBV(5148078,0)
		,T_JBV(5274195,0)
		,T_JBV(9160938,0)
		,T_JBV(9218570,0)
		,T_JBV(9160821,0)
		,T_JBV(28427157,0)
		,T_JBV(33658261,1)
		,T_JBV(28530710,0)
		,T_JBV(28685736,0)
		,T_JBV(15319073,0)
		,T_JBV(32361298,1)
		,T_JBV(32361550,1)
		,T_JBV(33061734,1)
		,T_JBV(31830038,1)
		,T_JBV(31830155,1)
		,T_JBV(31830272,1)
		,T_JBV(31830524,1)
		,T_JBV(31531601,1)
		,T_JBV(31433987,1)
		,T_JBV(33272138,1)
		,T_JBV(33272255,1)
		,T_JBV(32243757,1)
		,T_JBV(32941410,1)
		,T_JBV(16582773,0)
		,T_JBV(26615895,0)
		,T_JBV(31888866,1)
		,T_JBV(11928407,0)
		,T_JBV(11928524,0)
		,T_JBV(11930404,0)
		,T_JBV(11932462,0)
		,T_JBV(11932714,0)
		,T_JBV(11933257,0)
		,T_JBV(11933374,0)
		,T_JBV(10669724,0)
		,T_JBV(12544127,0)
		,T_JBV(5686178,0)
		,T_JBV(8933278,0)
	); 
	V_TMP_JBV T_JBV;
BEGIN


 
 FOR I IN V_JBV.FIRST .. V_JBV.LAST
 LOOP
 
 V_TMP_JBV := V_JBV(I);
  			  ACT_NUM_ACTIVO := TRIM(V_TMP_JBV(1));
			  ORIGEN_BMN := TRIM(V_TMP_JBV(2));
  			  
  			  IF ORIGEN_BMN > 0 THEN 
			  	  V_SQL := 'UPDATE '||V_ESQUEMA||'.GEX_GASTOS_EXPEDIENTE SET USUARIOMODIFICAR = ''REMVIP-2659''
									,FECHAMODIFICAR = SYSDATE
									,GEX_IMPORTE_CALCULO = 0 
						WHERE GEX_ID = (SELECT GEX.GEX_ID FROM '||V_ESQUEMA||'.GEX_GASTOS_EXPEDIENTE GEX
								JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.ECO_ID = GEX.ECO_ID 
								WHERE ECO.ECO_FECHA_ANULACION IS NULL 
								AND DD_ACC_ID = 5 
								AND ACT_ID = (SELECT ACT_ID 
									      FROM '||V_ESQUEMA||'.ACT_ACTIVO 
									      WHERE ACT_NUM_ACTIVO_UVEM = '||ACT_NUM_ACTIVO||'))';

			EXECUTE IMMEDIATE V_SQL;
			DBMS_OUTPUT.PUT_LINE('ACTUALIZADO (0%) ACTIVO ORIGEN BMN: '||ACT_NUM_ACTIVO);
			V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
			
			ELSE

				V_SQL := 'UPDATE '||V_ESQUEMA||'.GEX_GASTOS_EXPEDIENTE SET USUARIOMODIFICAR = ''REMVIP-2659''
									,FECHAMODIFICAR = SYSDATE
									,GEX_IMPORTE_CALCULO = 0.25 
						WHERE GEX_ID = (SELECT GEX.GEX_ID FROM '||V_ESQUEMA||'.GEX_GASTOS_EXPEDIENTE GEX
								JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.ECO_ID = GEX.ECO_ID 
								WHERE ECO.ECO_FECHA_ANULACION IS NULL 
								AND DD_ACC_ID = 5 
								AND ACT_ID = (SELECT ACT_ID 
									      FROM '||V_ESQUEMA||'.ACT_ACTIVO 
									      WHERE ACT_NUM_ACTIVO_UVEM = '||ACT_NUM_ACTIVO||'))';
				

			EXECUTE IMMEDIATE V_SQL;
			DBMS_OUTPUT.PUT_LINE('ACTUALIZADO (0,25%) ACTIVO: '||ACT_NUM_ACTIVO);
			V_COUNT_UPDATE := V_COUNT_UPDATE + 1;

			END IF;


		V_SQL := 'UPDATE '||V_ESQUEMA||'.GEX_GASTOS_EXPEDIENTE SET USUARIOMODIFICAR = ''REMVIP-2659''
									,FECHAMODIFICAR = SYSDATE
									,GEX_IMPORTE_CALCULO = 0  
						WHERE GEX_ID = (SELECT GEX.GEX_ID FROM '||V_ESQUEMA||'.GEX_GASTOS_EXPEDIENTE GEX
								JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.ECO_ID = GEX.ECO_ID 
								JOIN '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR PVE ON PVE.PVE_ID = GEX.GEX_PROVEEDOR 
								WHERE ECO.ECO_FECHA_ANULACION IS NULL 
								AND DD_ACC_ID = 4 
								AND PVE.PVE_COD_REM = ''10023'' 
								AND ACT_ID = (SELECT ACT_ID 
									      FROM '||V_ESQUEMA||'.ACT_ACTIVO 
									      WHERE ACT_NUM_ACTIVO_UVEM = '||ACT_NUM_ACTIVO||'))';
				

		EXECUTE IMMEDIATE V_SQL;
		DBMS_OUTPUT.PUT_LINE('ACTUALIZADO HONORARIO PRESCRIPCION (0%) ACTIVO: '||ACT_NUM_ACTIVO);
		V_COUNT_UPDATE := V_COUNT_UPDATE + 1;


	 END LOOP;			    
    
	COMMIT;

    DBMS_OUTPUT.PUT_LINE('[INFO] Se han updateado en total '||V_COUNT_UPDATE||' registros');

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
