PURGE RECYCLEBIN;

CREATE TABLE H_GPV_GASTOS_PROVEEDOR AS
SELECT * FROM GPV_GASTOS_PROVEEDOR;

CREATE TABLE H_GDE_GASTOS_DETALLE_ECONOMICO AS
SELECT * FROM GDE_GASTOS_DETALLE_ECONOMICO;

CREATE TABLE H_GGE_GASTOS_GESTION AS
SELECT * FROM GGE_GASTOS_GESTION;

CREATE TABLE H_GIC_GASTOS_INFO_CONTABILIDAD AS
SELECT * FROM GIC_GASTOS_INFO_CONTABILIDAD;

CREATE TABLE H_PRG_PROVISION_GASTOS AS
SELECT * FROM PRG_PROVISION_GASTOS;

CREATE TABLE H_GPV_ACT AS
SELECT * FROM GPV_ACT;

CREATE TABLE H_GPV_TBJ AS
SELECT * FROM GPV_TBJ;

--DESACTIVAMOS CLAVES
BEGIN
for i IN (select table_name, constraint_name --disable first the foreign key
from user_constraints
where constraint_type ='R'
and status = 'ENABLED')
loop
EXECUTE IMMEDIATE 'alter table ' ||i.table_name|| ' disable constraint ' ||i.constraint_name;
end loop i;


for i IN (select table_name, constraint_name -- then disable all constraints
from user_constraints
where status = 'ENABLED')
loop
EXECUTE IMMEDIATE 'alter table ' ||i.table_name|| ' disable constraint ' ||i.constraint_name;
end loop i;
END;

TRUNCATE TABLE GPV_GASTOS_PROVEEDOR;
TRUNCATE TABLE GDE_GASTOS_DETALLE_ECONOMICO;
TRUNCATE TABLE GGE_GASTOS_GESTION;
TRUNCATE TABLE GIC_GASTOS_INFO_CONTABILIDAD;
TRUNCATE TABLE PRG_PROVISION_GASTOS;
TRUNCATE TABLE GPV_ACT;
TRUNCATE TABLE GPV_TBJ;

INSERT INTO GPV_GASTOS_PROVEEDOR
SELECT GPV_ID
, GPV_NUM_GASTO_HAYA
, GPV_NUM_GASTO_GESTORIA
, GPV_REF_EMISOR
, DD_TGA_ID
, DD_STG_ID
, GPV_CONCEPTO
, DD_TPE_ID
, PVE_ID_EMISOR
, PRO_ID
, GPV_FECHA_EMISION
, GPV_FECHA_NOTIFICACION
, DD_DEG_ID
, GPV_CUBRE_SEGURO
, GPV_OBSERVACIONES
, VERSION
, USUARIOCREAR
, FECHACREAR
, USUARIOMODIFICAR
, FECHAMODIFICAR
, USUARIOBORRAR
, FECHABORRAR
, BORRADO
, PRG_ID
, DD_EGA_ID
, GPV_COD_GASTO_AGRUPADO
, GPV_COD_TIPO_OPERACION
, GPV_NUMERO_FACTURA_UVEM
, GPV_NUMERO_PROVISION_FONDOS
, GPV_NUMERO_PRESUPUESTO
, DD_TOG_ID
, NUM_GASTO_DESTINATARIO
, NUM_GASTO_ABONADO
, PVE_ID_GESTORIA
, GPV_GASTO_SIN_ACTIVOS
, GPV_NUM_GASTO_UVEM
, GPV_NUM_GASTO_SAREB
, DD_GRF_ID
, GPV_EXISTE_DOCUMENTO
, GPV_ALERTAS
FROM H_GPV_GASTOS_PROVEEDOR WHERE USUARIOCREAR <> 'MIG_BANKIA';

INSERT INTO GPV_GASTOS_PROVEEDOR
SELECT GPV_ID
, GPV_NUM_GASTO_HAYA
, GPV_NUM_GASTO_GESTORIA
, GPV_REF_EMISOR
, DD_TGA_ID
, DD_STG_ID
, GPV_CONCEPTO
, DD_TPE_ID
, PVE_ID_EMISOR
, PRO_ID
, GPV_FECHA_EMISION
, GPV_FECHA_NOTIFICACION
, DD_DEG_ID
, GPV_CUBRE_SEGURO
, GPV_OBSERVACIONES
, VERSION
, USUARIOCREAR
, FECHACREAR
, USUARIOMODIFICAR
, FECHAMODIFICAR
, USUARIOBORRAR
, FECHABORRAR
, BORRADO
, PRG_ID
, DD_EGA_ID
, GPV_COD_GASTO_AGRUPADO
, GPV_COD_TIPO_OPERACION
, GPV_NUMERO_FACTURA_UVEM
, GPV_NUMERO_PROVISION_FONDOS
, GPV_NUMERO_PRESUPUESTO
, DD_TOG_ID
, NUM_GASTO_DESTINATARIO
, NUM_GASTO_ABONADO
, PVE_ID_GESTORIA
, GPV_GASTO_SIN_ACTIVOS
, GPV_NUM_GASTO_UVEM
, GPV_NUM_GASTO_SAREB
, DD_GRF_ID
, GPV_EXISTE_DOCUMENTO
, GPV_ALERTAS
FROM H_GPV_GASTOS_PROVEEDOR WHERE USUARIOCREAR = 'MIG_BANKIA' AND TRUNC(GPV_FECHA_EMISION) >= '01/01/2017';

INSERT INTO GDE_GASTOS_DETALLE_ECONOMICO
SELECT GDE.GDE_ID
, GDE.GPV_ID
, GDE.GDE_PRINCIPAL_SUJETO
, GDE.GDE_PRINCIPAL_NO_SUJETO
, GDE.GDE_RECARGO
, GDE.GDE_INTERES_DEMORA
, GDE.GDE_COSTAS
, GDE.GDE_OTROS_INCREMENTOS
, GDE.GDE_PROV_SUPLIDOS
, GDE.DD_TIT_ID
, GDE.GDE_IMP_IND_EXENTO
, GDE.GDE_IMP_IND_RENUNCIA_EXENCION
, GDE.GDE_IMP_IND_TIPO_IMPOSITIVO
, GDE.GDE_IMP_IND_CUOTA
, GDE.GDE_IRPF_TIPO_IMPOSITIVO
, GDE.GDE_IRPF_CUOTA
, GDE.GDE_IMPORTE_TOTAL
, GDE.GDE_FECHA_TOPE_PAGO
, GDE.GDE_REPERCUTIBLE_INQUILINO
, GDE.GDE_IMPORTE_PAGADO
, GDE.GDE_FECHA_PAGO
, GDE.DD_TPA_ID
, GDE.DD_TPP_ID
, GDE.DD_DEP_ID
, GDE.VERSION
, GDE.USUARIOCREAR
, GDE.FECHACREAR
, GDE.USUARIOMODIFICAR
, GDE.FECHAMODIFICAR
, GDE.USUARIOBORRAR
, GDE.FECHABORRAR
, GDE.BORRADO
, GDE.GDE_REEMBOLSO_TERCERO
, GDE.GDE_INCLUIR_PAGO_PROVISION
, GDE.GDE_ABONO_CUENTA
, GDE.GDE_IBAN
, GDE.GDE_TITULAR_CUENTA
, GDE.GDE_NIF_TITULAR_CUENTA
, GDE.GDE_PAGADO_CONEXION_BANKIA
, GDE.GDE_NUMERO_CONEXION
, GDE.GDE_OFICINA_BANKIA
, GDE.GDE_FECHA_CONEXION
, GDE.GDE_ANTICIPO
, GDE.GDE_FECHA_ANTICIPO
FROM H_GDE_GASTOS_DETALLE_ECONOMICO GDE
JOIN GPV_GASTOS_PROVEEDOR GPV ON GPV.GPV_ID = GDE.GPV_ID;

INSERT INTO GGE_GASTOS_GESTION
SELECT GGE.GGE_ID
, GGE.GPV_ID
, GGE.GGE_AUTORIZACION_PROPIETARIO
, GGE.DD_MAP_ID
, GGE.GGE_OBSERVACIONES
, GGE.GGE_FECHA_ALTA
, GGE.USU_ID_ALTA
, GGE.DD_EAH_ID
, GGE.GGE_FECHA_EAH
, GGE.USU_ID_EAH
, GGE.DD_MRH_ID
, GGE.DD_EAP_ID
, GGE.GGE_FECHA_EAP
, GGE.GGE_MOTIVO_RECHAZO_PROP
, GGE.GGE_FECHA_ANULACION
, GGE.USU_ID_ANULACION
, GGE.DD_MAG_ID
, GGE.GGE_FECHA_RP
, GGE.USU_ID_RP
, GGE.DD_MRP_ID
, GGE.VERSION
, GGE.USUARIOCREAR
, GGE.FECHACREAR
, GGE.USUARIOMODIFICAR
, GGE.FECHAMODIFICAR
, GGE.USUARIOBORRAR
, GGE.FECHABORRAR
, GGE.BORRADO
, GGE.GGE_FECHA_ENVIO_GESTORIA
, GGE.GGE_FECHA_ENVIO_PRPTRIO
, GGE.GGE_FECHA_RECEPCION_GESTORIA
, GGE.GGE_FECHA_RECEPCION_PRPTRIO
FROM H_GGE_GASTOS_GESTION GGE
JOIN GPV_GASTOS_PROVEEDOR GPV ON GPV.GPV_ID = GGE.GPV_ID;

INSERT INTO GIC_GASTOS_INFO_CONTABILIDAD
SELECT GIC.GIC_ID
, GIC.GPV_ID
, GIC.EJE_ID
, GIC.GIC_FECHA_CONTABILIZACION
, GIC.DD_DEG_ID_CONTABILIZA
, GIC.GIC_FECHA_DEVENGO_ESPECIAL
, GIC.DD_TPE_ID_ESPECIAL
, GIC.VERSION
, GIC.USUARIOCREAR
, GIC.FECHACREAR
, GIC.USUARIOMODIFICAR
, GIC.FECHAMODIFICAR
, GIC.USUARIOBORRAR
, GIC.FECHABORRAR
, GIC.BORRADO
, GIC.GIC_CUENTA_CONTABLE
, GIC.GIC_PTDA_PRESUPUESTARIA
, GIC.GIC_CUENTA_CONTABLE_ESP
, GIC.GIC_PTDA_PRESUPUESTARIA_ESP
FROM H_GIC_GASTOS_INFO_CONTABILIDAD GIC
JOIN GPV_GASTOS_PROVEEDOR GPV ON GPV.GPV_ID = GIC.GPV_ID;

INSERT INTO PRG_PROVISION_GASTOS
SELECT DISTINCT PRG.PRG_ID
, PRG.PRG_NUM_PROVISION
, PRG.DD_EPR_ID
, PRG.PRG_FECHA_ALTA
, PRG.PVE_ID_GESTORIA
, PRG.PRG_FECHA_ENVIO
, PRG.PRG_FECHA_RESPUESTA
, PRG.PRG_FECHA_ANULACION
, PRG.VERSION
, PRG.USUARIOCREAR
, PRG.FECHACREAR
, PRG.USUARIOMODIFICAR
, PRG.FECHAMODIFICAR
, PRG.USUARIOBORRAR
, PRG.FECHABORRAR
, PRG.BORRADO
FROM H_PRG_PROVISION_GASTOS PRG
JOIN GPV_GASTOS_PROVEEDOR GPV ON GPV.PRG_ID = PRG.PRG_ID;

INSERT INTO GPV_ACT
SELECT GA.GPV_ACT_ID
, GA.GPV_ID
, GA.ACT_ID
, GA.VERSION
, GA.GPV_PARTICIPACION_GASTO
, GA.GPV_REFERENCIA_CATASTRAL
FROM H_GPV_ACT GA
JOIN GPV_GASTOS_PROVEEDOR GPV ON GPV.GPV_ID = GA.GPV_ID;

INSERT INTO GPV_TBJ
SELECT GT.GPV_TBJ_ID
, GT.GPV_ID
, GT.TBJ_ID
, GT.VERSION
, GT.USUARIOCREAR
, GT.FECHACREAR
, GT.USUARIOMODIFICAR
, GT.FECHAMODIFICAR
, GT.USUARIOBORRAR
, GT.FECHABORRAR
, GT.BORRADO
FROM H_GPV_TBJ GT
JOIN GPV_GASTOS_PROVEEDOR GPV ON GPV.GPV_ID = GT.GPV_ID;

COMMIT;

--ACTIVAMOS CLAVES
BEGIN
for i IN (select table_name, constraint_name --disable first the foreign key
from user_constraints
where constraint_type <> 'R'
and status = 'DISABLED')
loop
EXECUTE IMMEDIATE 'alter table ' ||i.table_name|| ' enable constraint ' ||i.constraint_name;
end loop i;


for i IN (select table_name, constraint_name -- then disable all constraints
from user_constraints
where status = 'DISABLED')
loop
EXECUTE IMMEDIATE 'alter table ' ||i.table_name|| ' enable constraint ' ||i.constraint_name;
end loop i;
END;

EXEC OPERACION_DDL.DDL_TABLE('ANALYZE','GPV_GASTOS_PROVEEDOR',1);
EXEC OPERACION_DDL.DDL_TABLE('ANALYZE','GDE_GASTOS_DETALLE_ECONOMICO',1);
EXEC OPERACION_DDL.DDL_TABLE('ANALYZE','GGE_GASTOS_GESTION',1);
EXEC OPERACION_DDL.DDL_TABLE('ANALYZE','GIC_GASTOS_INFO_CONTABILIDAD',1);
EXEC OPERACION_DDL.DDL_TABLE('ANALYZE','PRG_PROVISION_GASTOS',1);
EXEC OPERACION_DDL.DDL_TABLE('ANALYZE','GPV_ACT',1);
EXEC OPERACION_DDL.DDL_TABLE('ANALYZE','GPV_TBJ',1);

BEGIN

dbms_stats.gather_table_stats(
ownname => 'REM01',
tabname => 'GPV_GASTOS_PROVEEDOR',
estimate_percent => dbms_stats.auto_sample_size,
method_opt => 'for all indexed columns' ,
cascade => true,
degree => 1
);

END;