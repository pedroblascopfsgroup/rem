--/*
--##########################################
--## AUTOR=Maria Presencia 
--## FECHA_CREACION=20181028
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-4629
--## PRODUCTO=NO
--##
--## Finalidad: DML para rellenar la tabla AUX_ACT_TRASPASO_GALEON
--## INSTRUCCIONES: 
--## VERSIONES:
--##         0.1 - Maria Presencia  - Versión inicial (20181028)
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE
	V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas  
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas 
	V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.  
	V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.     
	ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
	ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_TABLA2 VARCHAR2(25 CHAR) := 'BIE_DATOS_REGISTRALES';


	V_TABLA VARCHAR2(25 CHAR):= 'AUX_ACT_TRASPASO_GALEON'; -- Configuracion Esquemas  

	--Array que contiene los registros que se van a actualizar
	TYPE T_INT is table of VARCHAR2(32000); 
	TYPE T_ARRAY_INT IS TABLE OF T_INT;
	V_INT T_ARRAY_INT := T_ARRAY_INT(  
		T_INT('8076007WF4787N0004OU',7019850),
		T_INT('1549037WF1714N0048OH',7010170),
		T_INT('1549037WF1714N0002ZT',7010171),
		T_INT('1549037WF1714N0008RA',7010172),
		T_INT('1549037WF1714N0009TS',7010173),
		T_INT('1549037WF1714N0013YD',7010174),
		T_INT('1549037WF1714N0016OH',7010175),
		T_INT('1549037WF1714N0020PJ',7010176),
		T_INT('1549037WF1714N0021AK',7010177),
		T_INT('1549037WF1714N0022SL',7010178),
		T_INT('1549037WF1714N0024FZ',7010179),
		T_INT('1549037WF1714N0027JQ',7010180),
		T_INT('1549037WF1714N0032LE',7010181),
		T_INT('1549037WF1714N0033BR',7010182),
		T_INT('1549037WF1714N0036MU',7010183),
		T_INT('1549037WF1714N0037QI',7010184),
		T_INT('1549037WF1714N0044TS',7010185),
		T_INT('1549037WF1714N0045YD',7010186),
		T_INT('0206501WF5800N0002XO',7010187),
		T_INT('8455504UF7985N0003OG',7010188),
		T_INT('7459704XG8675N0002MG',7010189),
		T_INT('7459704XG8675N0004WJ',7010190),
		T_INT('7459704XG8675N0005EK',7010191),
		T_INT('7459704XG8675N0006RL',7010192),
		T_INT('7459704XG8675N0008YZ',7010193),
		T_INT('7459704XG8675N0009UX',7010194),
		T_INT('7459704XG8675N0020SR',7010195),
		T_INT('7459704XG8675N0011YZ',7010196),
		T_INT('7459704XG8675N0012UX',7010197),
		T_INT('7459704XG8675N0013IM',7010198),
		T_INT('7459704XG8675N0014OQ',7010199),
		T_INT('7459704XG8675N0015PW',7010200),
		T_INT('7459704XG8675N0017SR',7010201),
		T_INT('7459704XG8675N0018DT',7010202),
		T_INT('9546621XH6094N0019IR',7010203),
		T_INT('9546621XH6094N0020YW',7010204),
		T_INT('5615235XG1751F0011TQ',7010205),
		T_INT('5615235XG1751F0013UE',7010206),
		T_INT('5615235XG1751F0014IR',7010207),
		T_INT('7205604XG6870N0001MU',7010208),
		T_INT('8480008XG0488A0003DO',7010209),
		T_INT('8480008XG0488A0005GA',7010210),
		T_INT('8480008XG0488A0006HS',7010211),
		T_INT('8480008XG0488A0007JD',7010212),
		T_INT('8480008XG0488A0008KF',7010213),
		T_INT('8480008XG0488A0010JD',7010214),
		T_INT('6297113TF9568F0005TW',7010215),
		T_INT('6297113TF9568F0010UR',7010216),
		T_INT('6297113TF9568F0012OY',7010217),
		T_INT('6297113TF9568F0013PU',7010218),
		T_INT('6729711XG9962N0007FG',7010219),
		T_INT('6773401WF4767S0068SU',7010220),
		T_INT('7985715XL9978N0001QY',7010221),
		T_INT('5283704XG0558B0001KO',7010222),
		T_INT('0371506VF4607A0001WZ',7010223),
		T_INT('2617110VG4121H0014AD',7010224),
		T_INT('2617110VG4121H0015SF',7010225),
		T_INT('2617110VG4121H0019HK',7010226),
		T_INT('1893940YK5219S0129KH',7010227),
		T_INT('2700522UM5120S0015IP',7010228),
		T_INT('8289603YJ1688N0001TB',7010229),
		T_INT('9284720XH6098S0001RL',7010230),
		T_INT('9284720XH6098S0001RL',7010231),
		T_INT('9284720XH6098S0001RL',7010232),
		T_INT('9284720XH6098S0001RL',7010233),
		T_INT('9284720XH6098S0001RL',7010234),
		T_INT('9284720XH6098S0001RL',7010235),
		T_INT('9284720XH6098S0001RL',7010236),
		T_INT('9284720XH6098S0001RL',7010237),
		T_INT('9284720XH6098S0001RL',7010238),
		T_INT('9284720XH6098S0001RL',7010239),
		T_INT('3099206YJ2539N0023KJ',7010240),
		T_INT('5474905YJ1257S0001SW',7010241),
		T_INT('1140805YJ2114A0004LR',7010242),
		T_INT('4710805YJ2741B0002KW',7010243),
		T_INT('7938401YJ3973H0022ZM',7010244),
		T_INT('8501901YJ1980S0004EW',7010245),
		T_INT('4963821YH0046S0056XG',7010246),
		T_INT('7586015YH1678N0023EW',7010247),
		T_INT('7586015YH1678N0006GF',7010248),
		T_INT('7586015YH1678N0007HG',7010249),
		T_INT('7586015YH1678N0047ZB',7010250),
		T_INT('2993801YK5229S0206GY',7010251),
		T_INT('6365608TF8066N0015YP',7010252),
		T_INT('6365608TF8066N0018OD',7010253),
		T_INT('6365608TF8066N0020IS',7010254),
		T_INT('7243601XH5074C0004FA',7010255),
		T_INT('1735101UF7613N0028UE',7010256),
		T_INT('4590604WF3649S0007EL',7010257),
		T_INT('4763106XG7846D0001RL',7010258),
		T_INT('8436508XH6083N0006YL',7010259),
		T_INT('0567406XG9806H0003WL',7010260),
		T_INT('0570601WF5707S0398LW',7010261),
		T_INT('3504010XH6130S0003HR',7010262),
		T_INT('0310507DD7801A0002RA',7010263),
		T_INT('5063104XH5156S0003AP',7010264),
		T_INT('8309110YJ1480N0004SG',7010271),
		T_INT('0453107DS4005S0001LX',7010272)
	);
	V_TMP_INT T_INT;

BEGIN

    EXECUTE IMMEDIATE 'TRUNCATE TABLE '||V_ESQUEMA||'.'||V_TABLA||'';
    
    DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE INSERCCION/ACTUALIZACION DE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.....');

	FOR I IN V_INT.FIRST .. V_INT.LAST LOOP
		V_TMP_INT := V_INT(I);
    
    DBMS_OUTPUT.PUT_LINE('[INFO] BUSCAMOS LA REFERENCIA CATASTRAL : ['||V_TMP_INT(1)||']');
    
    V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA2||' 
        WHERE BIE_DREG_REFERENCIA_CATASTRAL = '''||V_TMP_INT(1)||'''';
    EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] ['||V_NUM_TABLAS||'] (1 = SI EXISTE TAL CUAL/0 = NO EXISTE )');

		IF V_NUM_TABLAS = 0 THEN
        			DBMS_OUTPUT.PUT_LINE('[INFO] NO EXISTE EL BIEN CON REF_CATASTRAL ['||V_TMP_INT(1)||']');
		ELSE
    
			-- Comprobación de registro insertado y actualizado
			V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA||' 
					WHERE ACT_NUM_ACTIVO_NUV = '||V_TMP_INT(2)||'
					AND REF_CATASTRAL = '''||V_TMP_INT(1)||''' 
			';
			EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
			
			DBMS_OUTPUT.PUT_LINE('[INFO] ['||V_NUM_TABLAS||'] (1 = SI EXISTE TAL CUAL/0 = NO EXISTE CORRECTAMENTE)');
		
				IF V_NUM_TABLAS > 0 THEN
					DBMS_OUTPUT.PUT_LINE('[INFO] YA EXISTE EL REGISTRO CON REF_CATASTRAL ['||V_TMP_INT(1)||'], ACT_NUM_ACTIVO_NUV ['||V_TMP_INT(2)||']');
				ELSE
		
					-- Borramos cualquier registro que pueda haber con ese codigo, pero que no coincida por completo
					V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA||' 
					WHERE REF_CATASTRAL = '''||V_TMP_INT(1)||''' AND ACT_NUM_ACTIVO_NUV = '||V_TMP_INT(2)||'
					';
					EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
		
						IF V_NUM_TABLAS > 0 THEN
		
				
							V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE REF_CATASTRAL = '''||V_TMP_INT(1)||'''';
							
							EXECUTE IMMEDIATE V_MSQL;
		
							COMMIT;
		
						END IF;
					
					-- Insert del registro que no esta en el DD
					DBMS_OUTPUT.PUT_LINE('[INFO] INSERTANDO '||V_TABLA||': ['||V_TMP_INT(1)||' - '||V_TMP_INT(2) || ']');
					
					V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (
							ACT_NUM_ACTIVO_ANT,
							ACT_NUM_ACTIVO_NUV,
							REF_CATASTRAL,
							DD_CRA_ID
							) VALUES (
							(SELECT ACT_NUM_ACTIVO FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE BIE_ID IN (SELECT BIE_ID FROM '||V_ESQUEMA||'.BIE_DATOS_REGISTRALES WHERE BIE_DREG_REFERENCIA_CATASTRAL = '''||V_TMP_INT(1)||''') AND ROWNUM = 1 AND ACT_NUM_ACTIVO NOT IN (SELECT ACT_NUM_ACTIVO_ANT FROM '||V_ESQUEMA||'.AUX_ACT_TRASPASO_GALEON)), /*ACT_NUM_ACTIVO_ANT*/
							'||V_TMP_INT(2)||', /*ACT_NUM_ACTIVO_NUV*/
							'''||V_TMP_INT(1)||''', /*REF_CATASTRAL*/
							(SELECT DD_CRA_ID FROM '||V_ESQUEMA||'.DD_CRA_CARTERA WHERE DD_CRA_CODIGO = ''15'') /*DD_CRA_ID*/
							)';
					EXECUTE IMMEDIATE V_MSQL;
				END IF;
        
    END IF;
	
    END LOOP;

	DBMS_OUTPUT.PUT_LINE('[INFO] FINALIZACION EL PROCESO DE INSERCCION/ACTUALIZACION DE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.....');

	COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;

/

EXIT;
