MERGE INTO TAC_TAREAS_ACTIVOS T1
USING (
    --USUARIOS/SUPERVISORES DESTINATARIOS ANTIGUOS
    WITH ANTIGUOS AS (
        SELECT DISTINCT ECO.ECO_NUM_EXPEDIENTE, TAC.TRA_ID, TAC.TAR_ID, TAC.ACT_ID, TAC.USU_ID, TAC.SUP_ID
        FROM ECO_EXPEDIENTE_COMERCIAL ECO
        JOIN ACT_OFR AOF ON AOF.OFR_ID = ECO.OFR_ID
        JOIN ACT_ACTIVO ACT ON ACT.ACT_ID = AOF.ACT_ID
            AND ACT.BORRADO = 0
        JOIN DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
            AND CRA.DD_CRA_CODIGO = '08'
        JOIN ACT_TRA_TRAMITE TRA ON TRA.TBJ_ID = ECO.TBJ_ID
            AND TRA.BORRADO = 0
        JOIN TAC_TAREAS_ACTIVOS TAC ON TRA.TRA_ID = TAC.TRA_ID
        JOIN TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
            AND (TAR.BORRADO = 0 OR TAR.TAR_FECHA_FIN IS NULL OR NVL(TAR.TAR_TAREA_FINALIZADA,0) = 0)
        JOIN TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID
        JOIN TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
            AND TAP.TAP_CODIGO IN (
                    'T013_DefinicionOferta','T013_InstruccionesReserva','T013_RespuestaOfertante','T013_ResolucionComite'
                    ,'T014_DefinicionOferta','T013_DocumentosPostVenta','T013_PosicionamientoYFirma','T013_ObtencionContratoReserva'
                )
        )
    --USUARIOS DESTINATARIOS NUEVOS
    , GESTORES_NUEVOS AS (
        SELECT ECO_NUM_EXPEDIENTE, TRA_ID, TAR_ID, ACT_ID, USU_ID_OLD, USU_ID_NEW
        FROM (
            SELECT ACT.ECO_NUM_EXPEDIENTE, ACT.TRA_ID, ACT.TAR_ID, ACT.ACT_ID, ACT.USU_ID USU_ID_OLD, GEE.USU_ID USU_ID_NEW
                , ROW_NUMBER() OVER(PARTITION BY ACT.ACT_ID ORDER BY GEE.FECHACREAR DESC) RN
            FROM ANTIGUOS ACT
            JOIN GAC_GESTOR_ADD_ACTIVO GAC ON GAC.ACT_ID = ACT.ACT_ID
            JOIN GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID
            JOIN REMMASTER.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
                AND TGE.DD_TGE_CODIGO = 'HAYAGBOINM'
            WHERE GEE.USU_ID IS NOT NULL
            )
        WHERE RN = 1 AND NVL(USU_ID_OLD,0) <> USU_ID_NEW
        )
    SELECT *
    FROM GESTORES_NUEVOS USU
    ) T2
ON (T1.TRA_ID = T2.TRA_ID AND T1.TAR_ID = T2.TAR_ID AND T1.ACT_ID = T2.ACT_ID)
WHEN MATCHED THEN UPDATE SET
    T1.USU_ID = T2.USU_ID_NEW
    , T1.USUARIOMODIFICAR = SUBSTR(NVL2(T1.USUARIOMODIFICAR, T1.USUARIOMODIFICAR || ' - REMVIP-1599_USU', 'REMVIP-1599_USU'),-1,50)
    , T1.FECHAMODIFICAR = SYSDATE;
    
MERGE INTO TAC_TAREAS_ACTIVOS T1
USING (
    --USUARIOS/SUPERVISORES DESTINATARIOS ANTIGUOS
    WITH ANTIGUOS AS (
        SELECT DISTINCT ECO.ECO_NUM_EXPEDIENTE, TAC.TRA_ID, TAC.TAR_ID, TAC.ACT_ID, TAC.USU_ID, TAC.SUP_ID
        FROM ECO_EXPEDIENTE_COMERCIAL ECO
        JOIN ACT_OFR AOF ON AOF.OFR_ID = ECO.OFR_ID
        JOIN ACT_ACTIVO ACT ON ACT.ACT_ID = AOF.ACT_ID
            AND ACT.BORRADO = 0
        JOIN DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
            AND CRA.DD_CRA_CODIGO = '08'
        JOIN ACT_TRA_TRAMITE TRA ON TRA.TBJ_ID = ECO.TBJ_ID
            AND TRA.BORRADO = 0
        JOIN TAC_TAREAS_ACTIVOS TAC ON TRA.TRA_ID = TAC.TRA_ID
        JOIN TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
            AND (TAR.BORRADO = 0 OR TAR.TAR_FECHA_FIN IS NULL OR NVL(TAR.TAR_TAREA_FINALIZADA,0) = 0)
        JOIN TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAR.TAR_ID
        JOIN TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
            AND TAP.TAP_CODIGO IN (
                    'T013_DefinicionOferta','T013_InstruccionesReserva','T013_RespuestaOfertante','T013_ResolucionComite'
                    ,'T014_DefinicionOferta','T013_DocumentosPostVenta','T013_PosicionamientoYFirma','T013_ObtencionContratoReserva'
                )
        )
    --SUPERVISORES DESTINATARIOS NUEVOS
    , SUPERVISORES_NUEVOS AS (
        SELECT ECO_NUM_EXPEDIENTE, TRA_ID, TAR_ID, ACT_ID, SUP_ID_OLD, SUP_ID_NEW
        FROM (
            SELECT ACT.ECO_NUM_EXPEDIENTE, ACT.TRA_ID, ACT.TAR_ID, ACT.ACT_ID, ACT.SUP_ID SUP_ID_OLD, GEE.USU_ID SUP_ID_NEW
                , ROW_NUMBER() OVER(PARTITION BY ACT.ACT_ID, ACT.TRA_ID ORDER BY GEE.FECHACREAR DESC) RN
            FROM ANTIGUOS ACT
            JOIN GAC_GESTOR_ADD_ACTIVO GAC ON GAC.ACT_ID = ACT.ACT_ID
            JOIN GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID
            JOIN REMMASTER.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_ID = GEE.DD_TGE_ID
                AND TGE.DD_TGE_CODIGO = 'SBACKOFFICEINMLIBER'
            WHERE GEE.USU_ID IS NOT NULL
            )
        WHERE RN = 1 AND NVL(SUP_ID_OLD,0) <> SUP_ID_NEW
        )
    SELECT *
    FROM SUPERVISORES_NUEVOS USU
    ) T2
ON (T1.TRA_ID = T2.TRA_ID AND T1.TAR_ID = T2.TAR_ID AND T1.ACT_ID = T2.ACT_ID)
WHEN MATCHED THEN UPDATE SET
    T1.SUP_ID = T2.SUP_ID_NEW
    , T1.USUARIOMODIFICAR = SUBSTR(NVL2(T1.USUARIOMODIFICAR, T1.USUARIOMODIFICAR || ' - REMVIP-1599_SUP', 'REMVIP-1599_SUP'),-1,50)
    , T1.FECHAMODIFICAR = SYSDATE;