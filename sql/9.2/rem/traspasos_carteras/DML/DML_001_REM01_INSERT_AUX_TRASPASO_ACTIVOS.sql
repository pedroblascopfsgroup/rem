--/*
--##########################################
--## AUTOR=DAP
--## FECHA_CREACION=20180109
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=2.0.12
--## INCIDENCIA_LINK=HREOS-3577
--## PRODUCTO=NO
--##
--## Finalidad: Actualización e inserción de activos traspasados (TANGO).   
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE

    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_MSQL VARCHAR2(2048 CHAR);
    V_TABLA VARCHAR2(30 CHAR) := 'AUX_ACTIVOS_TRASPASADOS';
    V_COLUMN VARCHAR2(30 CHAR) := 'ACT_NUM_ACTIVO_VIEJO';
    V_COLUMN1 VARCHAR2(30 CHAR) := 'ACT_NUM_ACTIVO_NUEVO';
    V_COLUMN2 VARCHAR2(30 CHAR) := 'CODIGO_CARTERA';
    V_COLUMN3 VARCHAR2(30 CHAR) := 'CODIGO_SUBCARTERA';
    V_ESQUEMA VARCHAR2(15 CHAR) := 'REM01';
    V_EXISTS NUMBER(1);
    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
T_TIPO_DATA('2093','6946983','10','23'),
T_TIPO_DATA('6817','6946934','10','23'),
T_TIPO_DATA('7031','6946762','10','23'),
T_TIPO_DATA('7080','6946892','10','23'),
T_TIPO_DATA('9951','6946920','10','23'),
T_TIPO_DATA('10084','6946814','10','24'),
T_TIPO_DATA('10356','6946766','10','23'),
T_TIPO_DATA('12421','6946798','10','23'),
T_TIPO_DATA('13349','6946997','10','23'),
T_TIPO_DATA('13486','6946998','10','23'),
T_TIPO_DATA('13604','6946967','10','23'),
T_TIPO_DATA('13605','6946968','10','23'),
T_TIPO_DATA('13705','6946813','10','24'),
T_TIPO_DATA('13725','6946933','10','23'),
T_TIPO_DATA('13962','6946990','10','23'),
T_TIPO_DATA('13979','6946864','10','24'),
T_TIPO_DATA('14422','6946784','10','23'),
T_TIPO_DATA('15953','6946900','10','24'),
T_TIPO_DATA('20251','6946894','10','23'),
T_TIPO_DATA('20735','6946905','10','23'),
T_TIPO_DATA('21861','6946893','10','23'),
T_TIPO_DATA('22000','6946807','10','24'),
T_TIPO_DATA('22047','6946808','10','23'),
T_TIPO_DATA('22062','6946786','10','23'),
T_TIPO_DATA('22237','6946885','10','24'),
T_TIPO_DATA('22246','6946924','10','24'),
T_TIPO_DATA('22251','6946925','10','24'),
T_TIPO_DATA('22252','6946973','10','24'),
T_TIPO_DATA('25081','6946805','10','24'),
T_TIPO_DATA('25087','6946818','10','24'),
T_TIPO_DATA('25099','6946932','10','24'),
T_TIPO_DATA('29862','6946882','10','23'),
T_TIPO_DATA('30361','6946803','10','23'),
T_TIPO_DATA('30497','6946884','10','23'),
T_TIPO_DATA('30499','6946816','10','24'),
T_TIPO_DATA('30696','6946787','10','24'),
T_TIPO_DATA('31142','6946984','10','23'),
T_TIPO_DATA('31199','6946848','10','24'),
T_TIPO_DATA('31216','6946806','10','23'),
T_TIPO_DATA('31246','6946994','10','24'),
T_TIPO_DATA('31247','6946914','10','24'),
T_TIPO_DATA('32442','6946879','10','23'),
T_TIPO_DATA('32658','6946850','10','24'),
T_TIPO_DATA('32856','6946878','10','23'),
T_TIPO_DATA('32910','6946901','10','24'),
T_TIPO_DATA('32911','6946902','10','24'),
T_TIPO_DATA('33678','6946831','10','24'),
T_TIPO_DATA('34166','6946912','10','24'),
T_TIPO_DATA('35344','6946873','10','23'),
T_TIPO_DATA('35347','6946874','10','24'),
T_TIPO_DATA('35867','6946838','10','23'),
T_TIPO_DATA('35870','6946839','10','23'),
T_TIPO_DATA('35874','6946840','10','23'),
T_TIPO_DATA('35875','6946841','10','23'),
T_TIPO_DATA('35878','6946842','10','23'),
T_TIPO_DATA('35880','6946843','10','23'),
T_TIPO_DATA('35882','6946844','10','23'),
T_TIPO_DATA('35883','6946845','10','23'),
T_TIPO_DATA('35885','6946846','10','23'),
T_TIPO_DATA('37061','6946979','10','23'),
T_TIPO_DATA('37062','6946980','10','23'),
T_TIPO_DATA('37063','6946981','10','23'),
T_TIPO_DATA('37064','6946982','10','23'),
T_TIPO_DATA('37073','6946975','10','23'),
T_TIPO_DATA('37074','6946976','10','23'),
T_TIPO_DATA('37075','6946977','10','23'),
T_TIPO_DATA('37076','6946978','10','23'),
T_TIPO_DATA('37077','6946854','10','23'),
T_TIPO_DATA('37078','6946855','10','23'),
T_TIPO_DATA('37079','6946858','10','23'),
T_TIPO_DATA('37083','6946856','10','23'),
T_TIPO_DATA('37087','6946859','10','23'),
T_TIPO_DATA('37088','6946860','10','23'),
T_TIPO_DATA('37089','6946861','10','23'),
T_TIPO_DATA('37090','6946862','10','23'),
T_TIPO_DATA('37111','6946863','10','23'),
T_TIPO_DATA('37178','6946857','10','23'),
T_TIPO_DATA('38447','6946896','10','24'),
T_TIPO_DATA('38497','6946815','10','24'),
T_TIPO_DATA('38705','6946895','10','24'),
T_TIPO_DATA('38944','6946792','10','24'),
T_TIPO_DATA('38984','6946793','10','23'),
T_TIPO_DATA('38985','6946795','10','23'),
T_TIPO_DATA('38986','6946796','10','23'),
T_TIPO_DATA('38987','6946797','10','23'),
T_TIPO_DATA('38988','6946794','10','23'),
T_TIPO_DATA('39025','6946987','10','24'),
T_TIPO_DATA('39028','6946778','10','24'),
T_TIPO_DATA('39032','6946988','10','23'),
T_TIPO_DATA('39033','6946989','10','23'),
T_TIPO_DATA('39064','6946921','10','24'),
T_TIPO_DATA('39065','6946922','10','24'),
T_TIPO_DATA('39066','6946927','10','24'),
T_TIPO_DATA('39107','6946877','10','24'),
T_TIPO_DATA('39109','6946783','10','24'),
T_TIPO_DATA('40365','6946911','10','24'),
T_TIPO_DATA('40504','6947002','10','24'),
T_TIPO_DATA('40946','6946828','10','24'),
T_TIPO_DATA('40958','6946991','10','24'),
T_TIPO_DATA('40976','6946824','10','23'),
T_TIPO_DATA('41017','6947004','10','24'),
T_TIPO_DATA('41198','6946872','10','23'),
T_TIPO_DATA('41581','6946769','10','23'),
T_TIPO_DATA('41650','6947005','10','23'),
T_TIPO_DATA('41952','6946781','10','23'),
T_TIPO_DATA('41964','6946782','10','23'),
T_TIPO_DATA('41977','6946801','10','23'),
T_TIPO_DATA('42023','6946823','10','23'),
T_TIPO_DATA('42065','6946830','10','23'),
T_TIPO_DATA('42254','6946887','10','23'),
T_TIPO_DATA('42807','6946799','10','23'),
T_TIPO_DATA('42981','6946819','10','24'),
T_TIPO_DATA('43048','6946765','10','23'),
T_TIPO_DATA('43703','6946822','10','24'),
T_TIPO_DATA('43797','6946802','10','24'),
T_TIPO_DATA('44437','6946971','10','24'),
T_TIPO_DATA('45077','6946899','10','24'),
T_TIPO_DATA('45296','6946827','10','23'),
T_TIPO_DATA('45372','6946829','10','24'),
T_TIPO_DATA('45426','6946820','10','23'),
T_TIPO_DATA('46231','6946777','10','23'),
T_TIPO_DATA('46236','6946969','10','23'),
T_TIPO_DATA('46238','6946970','10','23'),
T_TIPO_DATA('46251','6946826','10','23'),
T_TIPO_DATA('47545','6946993','10','24'),
T_TIPO_DATA('47670','6946780','10','23'),
T_TIPO_DATA('48455','6946910','10','24'),
T_TIPO_DATA('49549','6946768','10','24'),
T_TIPO_DATA('49550','6946776','10','24'),
T_TIPO_DATA('50859','6946907','10','24'),
T_TIPO_DATA('50860','6946908','10','23'),
T_TIPO_DATA('50861','6946909','10','23'),
T_TIPO_DATA('51150','6946876','10','24'),
T_TIPO_DATA('51258','6946999','10','23'),
T_TIPO_DATA('51521','6946891','10','23'),
T_TIPO_DATA('51913','6946817','10','24'),
T_TIPO_DATA('51924','6946913','10','23'),
T_TIPO_DATA('52236','6946915','10','23'),
T_TIPO_DATA('52852','6946849','10','23'),
T_TIPO_DATA('52975','6946906','10','23'),
T_TIPO_DATA('53975','6946800','10','23'),
T_TIPO_DATA('54734','6946791','10','23'),
T_TIPO_DATA('54843','6946916','10','24'),
T_TIPO_DATA('55040','6946881','10','24'),
T_TIPO_DATA('55516','6946810','10','24'),
T_TIPO_DATA('55517','6946811','10','24'),
T_TIPO_DATA('55518','6946812','10','24'),
T_TIPO_DATA('55577','6947001','10','24'),
T_TIPO_DATA('55652','6947006','10','23'),
T_TIPO_DATA('55670','6946851','10','24'),
T_TIPO_DATA('55787','6946779','10','23'),
T_TIPO_DATA('56297','6946883','10','24'),
T_TIPO_DATA('56814','6946804','10','23'),
T_TIPO_DATA('56818','6946966','10','23'),
T_TIPO_DATA('57440','6946865','10','23'),
T_TIPO_DATA('57441','6946866','10','23'),
T_TIPO_DATA('57442','6946867','10','23'),
T_TIPO_DATA('57445','6946868','10','23'),
T_TIPO_DATA('57542','6946931','10','24'),
T_TIPO_DATA('57903','6946847','10','24'),
T_TIPO_DATA('58066','6946871','10','24'),
T_TIPO_DATA('58225','6946917','10','24'),
T_TIPO_DATA('58230','6946836','10','23'),
T_TIPO_DATA('58316','6946761','10','23'),
T_TIPO_DATA('58348','6946853','10','23'),
T_TIPO_DATA('58349','6946852','10','23'),
T_TIPO_DATA('58401','6946821','10','23'),
T_TIPO_DATA('58506','6946869','10','23'),
T_TIPO_DATA('59915','6946923','10','24'),
T_TIPO_DATA('59932','6946926','10','24'),
T_TIPO_DATA('61075','6946832','10','23'),
T_TIPO_DATA('61187','6946886','10','23'),
T_TIPO_DATA('61402','6946833','10','23'),
T_TIPO_DATA('61423','6946880','10','24'),
T_TIPO_DATA('61455','6946930','10','23'),
T_TIPO_DATA('61841','6946870','10','23'),
T_TIPO_DATA('61978','6947003','10','23'),
T_TIPO_DATA('62487','6946837','10','23'),
T_TIPO_DATA('62674','6946763','10','23'),
T_TIPO_DATA('62699','6946888','10','24'),
T_TIPO_DATA('62801','6946986','10','23'),
T_TIPO_DATA('62802','6946985','10','23'),
T_TIPO_DATA('62896','6946875','10','24'),
T_TIPO_DATA('63780','6946972','10','23'),
T_TIPO_DATA('64106','6946929','10','24'),
T_TIPO_DATA('65116','6946809','10','23'),
T_TIPO_DATA('65131','6946764','10','23'),
T_TIPO_DATA('65176','6946935','10','23'),
T_TIPO_DATA('65179','6946936','10','23'),
T_TIPO_DATA('65185','6946937','10','23'),
T_TIPO_DATA('65192','6946945','10','23'),
T_TIPO_DATA('65200','6946946','10','23'),
T_TIPO_DATA('65207','6946947','10','23'),
T_TIPO_DATA('65208','6946948','10','23'),
T_TIPO_DATA('65209','6946949','10','23'),
T_TIPO_DATA('65210','6946950','10','23'),
T_TIPO_DATA('65211','6946938','10','23'),
T_TIPO_DATA('65213','6946939','10','23'),
T_TIPO_DATA('65214','6946940','10','23'),
T_TIPO_DATA('65216','6946941','10','23'),
T_TIPO_DATA('65217','6946942','10','23'),
T_TIPO_DATA('65218','6946943','10','23'),
T_TIPO_DATA('65220','6946944','10','23'),
T_TIPO_DATA('65231','6946951','10','23'),
T_TIPO_DATA('65232','6946952','10','23'),
T_TIPO_DATA('65233','6946953','10','23'),
T_TIPO_DATA('65236','6946954','10','23'),
T_TIPO_DATA('65237','6946955','10','23'),
T_TIPO_DATA('65239','6946956','10','23'),
T_TIPO_DATA('65240','6946957','10','23'),
T_TIPO_DATA('65241','6946958','10','23'),
T_TIPO_DATA('65245','6946959','10','23'),
T_TIPO_DATA('65246','6946960','10','23'),
T_TIPO_DATA('65247','6946961','10','23'),
T_TIPO_DATA('65248','6946962','10','23'),
T_TIPO_DATA('65249','6946963','10','23'),
T_TIPO_DATA('65250','6946964','10','23'),
T_TIPO_DATA('66364','6946834','10','23'),
T_TIPO_DATA('66366','6946835','10','23'),
T_TIPO_DATA('67406','6946772','10','23'),
T_TIPO_DATA('67407','6946773','10','23'),
T_TIPO_DATA('67408','6946774','10','23'),
T_TIPO_DATA('67409','6946775','10','23'),
T_TIPO_DATA('67768','6946974','10','24'),
T_TIPO_DATA('68081','6946889','10','23'),
T_TIPO_DATA('68479','6946890','10','23'),
T_TIPO_DATA('68527','6946992','10','23'),
T_TIPO_DATA('68584','6946965','10','23'),
T_TIPO_DATA('68636','6946919','10','23'),
T_TIPO_DATA('70330','6946767','10','23'),
T_TIPO_DATA('70709','6946904','10','23'),
T_TIPO_DATA('70710','6947000','10','23'),
T_TIPO_DATA('70873','6946928','10','24'),
T_TIPO_DATA('70984','6946785','10','24'),
T_TIPO_DATA('71341','6946918','10','24'),
T_TIPO_DATA('71442','6946790','10','23'),
T_TIPO_DATA('71758','6946771','10','24'),
T_TIPO_DATA('71918','6946903','10','23'),
T_TIPO_DATA('72119','6946898','10','24'),
T_TIPO_DATA('72305','6946788','10','23'),
T_TIPO_DATA('72306','6946789','10','23'),
T_TIPO_DATA('72310','6946825','10','23'),
T_TIPO_DATA('72994','6946995','10','24'),
T_TIPO_DATA('72995','6946996','10','24'),
T_TIPO_DATA('73594','6946897','10','23'),
T_TIPO_DATA('73858','6946770','10','23')
    ); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

BEGIN

    DBMS_OUTPUT.PUT_LINE('[INICIO]');
    
    V_MSQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA||''' AND OWNER = '''||V_ESQUEMA||'''';
    EXECUTE IMMEDIATE V_MSQL INTO V_EXISTS;
    
    IF V_EXISTS = 0 THEN
        DBMS_OUTPUT.PUT_LINE('  [INFO] NO EXISTE LA TABLA');
    ELSE
        V_MSQL := 'SELECT COUNT(1) FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = '''||V_TABLA||''' AND COLUMN_NAME IN ('''||V_COLUMN||''','''||V_COLUMN1||''','''||V_COLUMN2||''','''||V_COLUMN3||''') 
            AND OWNER = '''||V_ESQUEMA||'''';
        EXECUTE IMMEDIATE V_MSQL INTO V_EXISTS;

        IF V_EXISTS = 4 THEN
            FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
                LOOP
                    V_TMP_TIPO_DATA := V_TIPO_DATA(I);
                    V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
                        USING (SELECT '''||V_TMP_TIPO_DATA(1)||''' '||V_COLUMN||'
                                , '''||V_TMP_TIPO_DATA(2)||''' '||V_COLUMN1||'
                                , '''||V_TMP_TIPO_DATA(3)||''' '||V_COLUMN2||'
                                , '''||V_TMP_TIPO_DATA(4)||''' '||V_COLUMN3||'
                            FROM DUAL) T2
                        ON (T1.'||V_COLUMN||' = T2.'||V_COLUMN||')
                        WHEN MATCHED THEN UPDATE SET
                            T1.'||V_COLUMN1||' = T2.'||V_COLUMN1||'
                            , T1.'||V_COLUMN2||' = T2.'||V_COLUMN2||'
                            , T1.'||V_COLUMN3||' = T2.'||V_COLUMN3||'
                        WHEN NOT MATCHED THEN INSERT (T1.'||V_COLUMN||', T1.'||V_COLUMN1||', T1.'||V_COLUMN2||', T1.'||V_COLUMN3||') 
                        VALUES (T2.'||V_COLUMN||', T2.'||V_COLUMN1||', T2.'||V_COLUMN2||', T2.'||V_COLUMN3||')';
                    EXECUTE IMMEDIATE V_MSQL;
                END LOOP;

            DBMS_OUTPUT.PUT_LINE('  [INFO] TABLA RELLENA');
        ELSE
            DBMS_OUTPUT.PUT_LINE('  [INFO] NO EXISTE ALGÚN CAMPO');
        END IF;
    END IF;
    
    COMMIT;
    
    DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
    WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);
        DBMS_OUTPUT.put_line(V_MSQL);
        ROLLBACK;
        RAISE;          
END;
/
EXIT;