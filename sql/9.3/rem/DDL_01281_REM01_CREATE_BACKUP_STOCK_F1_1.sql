--/*
--##########################################
--## AUTOR=Daniel Algaba
--## FECHA_CREACION=20220425
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-17716
--## PRODUCTO=NO
--##
--## Finalidad: UPDATE BACKUP_STOCK_F1_1
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Version inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_TEXT_TABLA VARCHAR2(2400 CHAR) := 'BACKUP_STOCK_F1_1'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_USUARIO VARCHAR2(250 CHAR) := 'HREOS-17716';
    
BEGIN
DBMS_OUTPUT.PUT_LINE('[INICIO]');
V_SQL := 'SELECT COUNT(1) FROM ALL_TAB_COLUMNS WHERE OWNER = '''||V_ESQUEMA||''' AND TABLE_NAME = '''||V_TEXT_TABLA||'''';
EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
	
IF V_NUM_TABLAS = 0 THEN
    V_MSQL := 'CREATE TABLE '||V_ESQUEMA||'.BACKUP_STOCK_F1_1 AS
		(SELECT
		ACT.ACT_ID
		, ACT_NUM_ACTIVO_CAIXA
		, ACT_NUM_ACTIVO
		, cast(NULL as VARCHAR2(20 CHAR)) CBX_NUMERO_INMUEBLE_ANTERIOR
		, ACT.DD_TPA_ID
		, ACT.DD_SAC_ID 
		, REG.REG_IDUFIR
		, PTA.CHECK_SUBROGADO
		, cast(NULL as NUMBER(1,0)) COMPRADOR_ACOJE_AYUDA
		, cast(NULL as NUMBER(16,2)) IMPORTE_AYUDA_FINANCIACION
		, cast(NULL as DATE) FECHA_VENCIMIENTO_AVAL_SEGURO
		, cast(NULL as DATE) FECHA_DEVOLUCION_AYUDA
		, cast(NULL as NUMBER(3,0)) ICO_IDEF_PLAZA_PARKING
		, cast(NULL as NUMBER(3,0)) ICO_IDEF_TRASTERO
		, cast(NULL as NUMBER(16,2)) REG_SUPERFICIE_CONSTRUIDA
		, REG.REG_SUPERFICIE_PARCELA
		, cast(NULL as NUMBER(16,0)) ICO_BALCON
		, ICO.ICO_CALEFACCION
		, ICO.ICO_COCINA_AMUEBLADA
		, ICO.DD_ESC_ID
		, ICO.ICO_JARDIN
		, ICO.ICO_PISCINA
		, ICO.ICO_SALIDA_HUMOS
		, ICO.ICO_TERRAZA
		, cast(NULL as NUMBER(16,0)) DD_TVC_ID
		, cast(NULL as NUMBER(16,0)) DD_TEC_ID
		, cast(NULL as NUMBER(16,0)) DD_CBC_ID
		, cast(NULL as VARCHAR2(4 CHAR)) PAC_ANYO_CONCES
		, cast(NULL as DATE) PAC_FEC_FIN_CONCES
		, ICO.ICO_ANO_CONSTRUCCION
		, ICO.ICO_ANO_REHABILITACION
		, REG.REG_SUPERFICIE_SOBRE_RASANTE
		, REG.REG_SUPERFICIE_BAJO_RASANTE
		, ICO.ICO_NUM_GARAJE
		, ICO.ICO_ASCENSOR
		, ICO.ICO_ANEJO_TRASTERO
		, ACT.DD_TUD_ID
		, ICO.ICO_ANEJO_GARAJE
		FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
		LEFT JOIN '||V_ESQUEMA||'.ACT_REG_INFO_REGISTRAL REG on ACT.ACT_ID = REG.ACT_ID and REG.BORRADO = 0
		LEFT JOIN '||V_ESQUEMA||'.ACT_PTA_PATRIMONIO_ACTIVO PTA on ACT.ACT_ID = PTA.ACT_ID and PTA.BORRADO = 0
		LEFT JOIN '||V_ESQUEMA||'.ACT_ADM_INF_ADMINISTRATIVA ADM on ACT.ACT_ID = ADM.ACT_ID and ADM.BORRADO = 0
		LEFT JOIN '||V_ESQUEMA||'.ACT_ACTIVO_CAIXA AAC on ACT.ACT_ID = AAC.ACT_ID and AAC.BORRADO = 0
		LEFT JOIN '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL ICO on ACT.ACT_ID = ICO.ACT_ID and ICO.BORRADO = 0
		JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID 
		LEFT JOIN '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID
		JOIN '||V_ESQUEMA||'.ACT_PAC_PROPIETARIO_ACTIVO ACT_PRO ON ACT_PRO.ACT_ID = ACT.ACT_ID AND ACT_PRO.BORRADO = 0
		JOIN '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = ACT_PRO.PRO_ID AND PRO.BORRADO = 0
		WHERE ACT.BORRADO = 0
		AND CRA.DD_CRA_CODIGO = ''03''
		AND ACT.ACT_NUM_ACTIVO_CAIXA IS NOT NULL
		AND PRO.PRO_DOCIDENTIF NOT IN (''V84966126'',''V85164648'',''V85587434'',''V84322205'',''V84593961'',''V84669332'',''V85082675'',''V85623668'',''V84856319''
		,''V85500866'',''V85143659'',''V85594927'',''V85981231'',''V84889229'',''V84916956'',''V85160935'',''V85295087'',''V84175744'',''V84925569'',''A80352750'', ''A80514466''))';
    EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('[FIN]: TABLA '||V_TEXT_TABLA||' CREADA ');
ELSE
    DBMS_OUTPUT.PUT_LINE('[FIN]: TABLA '||V_TEXT_TABLA||' YA CREADA ');
END IF;
COMMIT;

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
