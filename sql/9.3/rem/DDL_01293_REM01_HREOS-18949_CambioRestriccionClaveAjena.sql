--/*
--##########################################
--## AUTOR=pedro.blasco@pfsgroup.es
--## FECHA_CREACION=20221121
--## ARTEFACTO=incidencias_produccion
--## VERSION_ARTEFACTO=recovery_evolutivo
--## INCIDENCIA_LINK=HREOS-18949
--## PRODUCTO=NO
--## 
--## Finalidad: Cambio restricción clave ajena
--## VERSIONES:
--##        Generado automáticamente por asistenteDML
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE
SET SERVEROUTPUT ON
SET TIMING ON

DECLARE

	V_ESQUEMA VARCHAR2(25 CHAR):=   '#ESQUEMA#';
	V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';
	err_num NUMBER;
	err_msg VARCHAR2(2048); 

	V_SQL VARCHAR2(8500 CHAR);
	
 	V_ITEM VARCHAR2(50) := 'HREOS-18949';

 	V_NUM NUMBER := 0;

BEGIN 
	
V_SQL := q'[SELECT COUNT(*) FROM USER_CONSTRAINTS WHERE CONSTRAINT_NAME='FK_COI_ADJUNTO' AND R_CONSTRAINT_NAME='ACT_APR_ADJUNTO_PROVEEDOR_PK' ]';
EXECUTE IMMEDIATE V_SQL INTO V_NUM;

IF V_NUM = 1 THEN
	DBMS_OUTPUT.PUT_LINE(' ... EXISTE RESTRICCION OBSOLETA FK_COI_ADJUNTO. LA CORREGIMOS.');
	V_SQL := q'[  ALTER TABLE #ESQUEMA#.PVE_COI_CONDUCTAS_INAPROPIADAS DROP CONSTRAINT FK_COI_ADJUNTO ]';
	EXECUTE IMMEDIATE V_SQL;
	DBMS_OUTPUT.PUT_LINE(' ... ' || RPAD(substr(V_SQL, 1, 60), 60, ' '));
	V_SQL := q'[  ALTER TABLE #ESQUEMA#.PVE_COI_CONDUCTAS_INAPROPIADAS ADD CONSTRAINT FK_COI_ADJUNTO FOREIGN KEY (COI_ADJUNTO) REFERENCES #ESQUEMA#.ACI_ADJUNTO_CONDUCTAS_INAPROPIADAS (ACI_ID) ON DELETE SET NULL ENABLE ]';
	EXECUTE IMMEDIATE V_SQL;
	DBMS_OUTPUT.PUT_LINE(' ... ' || RPAD(substr(V_SQL, 1, 60), 60, ' '));
ELSE
	DBMS_OUTPUT.PUT_LINE(' ... YA EXISTE RESTRICCION CORREGIDA FK_COI_ADJUNTO. NO HACEMOS NADA.');
END IF;

EXCEPTION
WHEN OTHERS THEN  
  err_num := SQLCODE;
  err_msg := SQLERRM;

  DBMS_OUTPUT.put_line('Error:'||TO_CHAR(err_num));
  DBMS_OUTPUT.put_line(err_msg);
  
  ROLLBACK;
  RAISE;
END;
/

EXIT;   
