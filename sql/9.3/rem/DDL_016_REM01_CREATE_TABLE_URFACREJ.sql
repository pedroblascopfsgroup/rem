--/*
--######################################### 
--## AUTOR=DAP
--## FECHA_CREACION=20180510
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-783
--## PRODUCTO=NO
--## 
--## Finalidad: Creación de tablas de FACTURAS
--##
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

TABLE_COUNT NUMBER(1,0) := 0;
V_ESQUEMA VARCHAR2(20 CHAR) := '#ESQUEMA#';
V_TABLA VARCHAR2(40 CHAR) := '';
V_SEQUENCE VARCHAR2(40 CHAR) := '';

BEGIN
	
	/***** APR_AUX_I_UR_LIN_FACT_SIN_PROV *****/
	
	V_TABLA := 'APR_AUX_I_UR_LIN_FACT_SIN_PROV';

	SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE TABLE_NAME = ''||V_TABLA||'' AND OWNER= ''||V_ESQUEMA||'';

	IF TABLE_COUNT > 0 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] TABLA '||V_ESQUEMA||'.'||V_TABLA||' YA EXISTENTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
		EXECUTE IMMEDIATE 'DROP TABLE '||V_ESQUEMA||'.'||V_TABLA||'';
	END IF;

	EXECUTE IMMEDIATE 'CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||'
    (
          FACTURA_REM NUMBER(20)
          , TIPO_REGISTRO NUMBER(1)
          , ORDEN_FACTURAS VARCHAR2(3 CHAR)
          , ID_ACTIVO VARCHAR2(9 CHAR)
          , GRUPOGASTO VARCHAR2(2 CHAR)
          , TIPO_ACCION VARCHAR2(2 CHAR)
          , SUBTIPO_ACCION VARCHAR2(2 CHAR) 
          , USER_REFERENCIA VARCHAR2(8 CHAR)
          , ENTIDAD_SOLICITANTE_ACC VARCHAR2(4 CHAR)
          , OFICINA_CENTRO_SOLICITANTE VARCHAR2(4 CHAR)
          , IMPORTE_PREVISTO_ACCION VARCHAR2(15 CHAR)
          , SIGNO_IMPORTE_PREVISTO VARCHAR2(1 CHAR)
          , FECHA_INICIO_REAL_ACC VARCHAR2(8 CHAR)
          , FECHA_FIN_REAL_ACC VARCHAR2(8 CHAR)
          , COD_CONCEPTO_CONTABLE VARCHAR2(5 CHAR)
          , IND_EXCL_IMP_DIRECTO VARCHAR2(1 CHAR)
          , FILLER VARCHAR2(275 CHAR)
          , SUBTIPO_ERROR_GASTO VARCHAR2(3 CHAR)
          , OTROS VARCHAR2(20 CHAR)
          , NKNM28 VARCHAR2(8 CHAR)
		  , ID_UA NUMBER(16)
    )';
    EXECUTE IMMEDIATE  'comment on column '|| V_ESQUEMA ||'.APR_AUX_I_UR_LIN_FACT_SIN_PROV.ID_UA is ''Campo que sólo está relleno cuando el activo es una Unidad Alquilable y por lo tanto no tiene número UVEM. '' ' ;
	DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' CREADA'); 

    /***** H_AUX_I_UR_LIN_FACT_SIN_PROV *****/
  
  V_TABLA := 'H_AUX_I_UR_LIN_FACT_SIN_PROV';

  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE TABLE_NAME = ''||V_TABLA||'' AND OWNER= ''||V_ESQUEMA||'';

  IF TABLE_COUNT > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] TABLA '||V_ESQUEMA||'.'||V_TABLA||' YA EXISTENTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'DROP TABLE '||V_ESQUEMA||'.'||V_TABLA||'';
  END IF;

  EXECUTE IMMEDIATE 'CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||'
    (
          FACTURA_REM NUMBER(20)
          , TIPO_REGISTRO NUMBER(1)
          , ORDEN_FACTURAS VARCHAR2(3 CHAR)
          , ID_ACTIVO VARCHAR2(9 CHAR)
          , GRUPOGASTO VARCHAR2(2 CHAR)
          , TIPO_ACCION VARCHAR2(2 CHAR)
          , SUBTIPO_ACCION VARCHAR2(2 CHAR) 
          , USER_REFERENCIA VARCHAR2(8 CHAR)
          , ENTIDAD_SOLICITANTE_ACC VARCHAR2(4 CHAR)
          , OFICINA_CENTRO_SOLICITANTE VARCHAR2(4 CHAR)
          , IMPORTE_PREVISTO_ACCION VARCHAR2(15 CHAR)
          , SIGNO_IMPORTE_PREVISTO VARCHAR2(1 CHAR)
          , FECHA_INICIO_REAL_ACC VARCHAR2(8 CHAR)
          , FECHA_FIN_REAL_ACC VARCHAR2(8 CHAR)
          , COD_CONCEPTO_CONTABLE VARCHAR2(5 CHAR)
          , IND_EXCL_IMP_DIRECTO VARCHAR2(1 CHAR)
          , FILLER VARCHAR2(275 CHAR)
          , SUBTIPO_ERROR_GASTO VARCHAR2(3 CHAR)
          , OTROS VARCHAR2(20 CHAR)
          , NKNM28 VARCHAR2(8 CHAR)
          , FECHA_CARGA DATE
		  
    )';

  DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' CREADA');  
	
	/***** APR_AUX_I_UR_LIN_FACT_REJECTS *****/

	V_TABLA := 'APR_AUX_I_UR_LIN_FACT_REJECTS';
	
	SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE TABLE_NAME = ''||V_TABLA||'' AND OWNER= ''||V_ESQUEMA||'';

	IF TABLE_COUNT > 0 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] TABLA '||V_ESQUEMA||'.'||V_TABLA||' YA EXISTENTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
		EXECUTE IMMEDIATE 'DROP TABLE '||V_ESQUEMA||'.'||V_TABLA||'';
	END IF;

	EXECUTE IMMEDIATE 'CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||'
    ( 
      ERRORCODE	VARCHAR2(255 CHAR)
      ,ERRORMESSAGE	VARCHAR2(2048 CHAR)
      ,ROWREJECTED	VARCHAR2(2048 CHAR)
    )';

	DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' CREADA');

  /***** AUX_I_UR_FILE_LFACT_SIN_PROV *****/
  
  V_TABLA := 'AUX_I_UR_FILE_LFACT_SIN_PROV';

  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE TABLE_NAME = ''||V_TABLA||'' AND OWNER= ''||V_ESQUEMA||'';

  IF TABLE_COUNT > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] TABLA '||V_ESQUEMA||'.'||V_TABLA||' YA EXISTENTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'DROP TABLE '||V_ESQUEMA||'.'||V_TABLA||'';
  END IF;

  EXECUTE IMMEDIATE 'CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||'
    (
      FACTURA_REM NUMBER(20)
      , ID_ACTIVO NUMBER(9)
      , DESCRIPCION_GASTO VARCHAR2(250 CHAR)
      , FECHA_INICIO_REAL_ACC DATE
      , FECHA_FIN_REAL_ACC DATE
      , SUBTIPO_ERROR_GASTO VARCHAR2(250 CHAR)
      , SUB_ERR_GASTO_NKNM28 VARCHAR2(250 CHAR)
      , FECHA_GENERACION DATE
	  , ID_UA NUMBER(16)
    )';

  EXECUTE IMMEDIATE  'comment on column '|| V_ESQUEMA ||'.AUX_I_UR_FILE_LFACT_SIN_PROV.ID_UA is ''Campo que sólo está relleno cuando el activo es una Unidad Alquilable y por lo tanto no tiene número UVEM. '' ' ;
  DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' CREADA');

  /***** DD_MRF_MAIL_REJ_FACTURAS *****/
  
  V_TABLA := 'DD_MRF_MAIL_REJ_FACTURAS';

  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_TABLES WHERE TABLE_NAME = ''||V_TABLA||'' AND OWNER= ''||V_ESQUEMA||'';

  IF TABLE_COUNT > 0 THEN
    DBMS_OUTPUT.PUT_LINE('[INFO] TABLA '||V_ESQUEMA||'.'||V_TABLA||' YA EXISTENTE. SE PROCEDE A BORRAR Y CREAR DE NUEVO.');
    EXECUTE IMMEDIATE 'DROP TABLE '||V_ESQUEMA||'.'||V_TABLA||'';
  END IF;

  EXECUTE IMMEDIATE 'CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||'
    (
      DD_MRF_ID NUMBER(16) NOT NULL ENABLE
      , DD_MRF_CODIGO VARCHAR2(50 CHAR) NOT NULL ENABLE
	    , DD_MRF_DE VARCHAR2(250 CHAR) NOT NULL ENABLE
      , DD_MRF_PARA VARCHAR2(250 CHAR) NOT NULL ENABLE
      , DD_MRF_CC VARCHAR2(4000 CHAR) 
      , DD_MRF_ASUNTO VARCHAR2(250 CHAR)
      , DD_MRF_CUERPO VARCHAR2(250 CHAR)
      , DD_MRF_ADJUNTO VARCHAR2(4000 CHAR)
      , VERSION NUMBER(16) DEFAULT 0 NOT NULL ENABLE 
      , USUARIOCREAR VARCHAR2(50 CHAR) NOT NULL ENABLE
      , FECHACREAR TIMESTAMP DEFAULT SYSDATE NOT NULL ENABLE
      , USUARIOMODIFICAR VARCHAR2(50 CHAR)
      , FECHAMODIFICAR TIMESTAMP
      , USUARIOBORRAR VARCHAR2(50 CHAR)
      , FECHABORRAR TIMESTAMP
      , BORRADO NUMBER(1) DEFAULT 0 NOT NULL ENABLE
      , CONSTRAINT PK_MRF_ID PRIMARY KEY (DD_MRF_ID)
      , CONSTRAINT UK_MRF_CODIGO UNIQUE (DD_MRF_CODIGO)
    )
    ';

  DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' CREADA');

  SELECT COUNT(1) INTO TABLE_COUNT FROM ALL_SEQUENCES WHERE SEQUENCE_NAME = 'S_' || ''||V_TABLA||'' AND SEQUENCE_OWNER= ''||V_ESQUEMA||'';

  IF TABLE_COUNT = 0 THEN

    EXECUTE IMMEDIATE 'CREATE SEQUENCE '||V_ESQUEMA||'.S_'||V_TABLA||' MINVALUE 1 MAXVALUE 999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 5 NOORDER NOCYCLE';

    DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.S_'||V_TABLA||' CREADA'); 

  END IF;
		
EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/

EXIT;
