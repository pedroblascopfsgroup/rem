--/*
--#########################################
--## AUTOR=Santi Monzó
--## FECHA_CREACION=20211103
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-16257
--## PRODUCTO=NO
--## 
--## Finalidad: Creación de tabla auxiliar
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--##        0.2 HREOS-15091 Añadir campos DISPONIBLE y COD_MOTIVO_INDISPONIBILIDAD
--##        0.3 HREOS-15457 Añadir campo DISPONIBLE GESTION
--##        0.4 HREOS-16257 Añadir campos
--#########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

	V_MSQL VARCHAR2(32000 CHAR); 
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; 
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';
	V_SQL VARCHAR2(4000 CHAR);
	V_NUM NUMBER(16);
	ERR_NUM NUMBER(25);  
	ERR_MSG VARCHAR2(1024 CHAR); 
	V_TABLA VARCHAR2(50 CHAR):= 'APR_AUX_STOCK_ACTIVOS';


BEGIN	

	DBMS_OUTPUT.PUT_LINE('[INFO] INICIO DEL PROCESO.');
	
	V_MSQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = '''||V_TABLA||''' AND OWNER = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO V_NUM;
	
	IF V_NUM != 0 THEN
	
		DBMS_OUTPUT.PUT_LINE('[INFO] LA TABLA '''||V_TABLA||''' YA EXISTE.');
		V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.'||V_TABLA||'';
		EXECUTE IMMEDIATE V_MSQL;
		
	END IF;	

	EXECUTE IMMEDIATE '
	CREATE TABLE '||V_ESQUEMA||'.'||V_TABLA||' (
		ID_ACTIVO_HAYA 		VARCHAR2(100 CHAR)
		,CARTERA 	        VARCHAR2(100 CHAR)
		,SUBCARTERA	    VARCHAR2(100 CHAR)
		,PERIMETRO_MACC	VARCHAR2(100 CHAR)
    ,DIRECCION_COMERCIAL VARCHAR2(100 CHAR)
    ,SOCIEDAD_PROPIETARIO VARCHAR2(100 CHAR)
    ,TIPOLOGIA_ACTIVO VARCHAR2(100 CHAR)
    ,TIPO_ALQUILER	VARCHAR2(100 CHAR)
         , ESTADO_COMERCIAL	VARCHAR2(100 CHAR)      
        , DESTINO_COMERCIAL	VARCHAR2(100 CHAR)
        ,GESTOR_COMERCIAL_ALQ VARCHAR2(100 CHAR)
        , REFERENCIA_CATASTRAL	VARCHAR2(100 CHAR)
        , PUERTA_ANTI_OKUPA	VARCHAR2(100 CHAR)
        , SEGURIDAD	VARCHAR2(100 CHAR)
        , VIGILANCIA	VARCHAR2(100 CHAR)
        , PAIS	VARCHAR2(100 CHAR)
        , CCAA	VARCHAR2(100 CHAR)
        , PROVINCIA	VARCHAR2(100 CHAR)
        ,SIGLA VARCHAR2(100 CHAR)
        , VIAPUBLICA	VARCHAR2(100 CHAR)
        , NUMERO	VARCHAR2(100 CHAR)
        , BLOQUE	VARCHAR2(100 CHAR)
        , PORTAL	VARCHAR2(100 CHAR)
        , ESCALERA	VARCHAR2(100 CHAR)
        , PISO	VARCHAR2(100 CHAR)
        , PUERTA	VARCHAR2(100 CHAR)
        , CODPOSTAL	VARCHAR2(100 CHAR)
        , POBLACION	VARCHAR2(100 CHAR)
        , M2_CONST	VARCHAR2(100 CHAR)
        , M2_UTILES	VARCHAR2(100 CHAR)
        , NUM_DORMITORIOS	VARCHAR2(100 CHAR)
        , NUM_BANOS	VARCHAR2(100 CHAR)
        ,LUGARREG VARCHAR2(100 CHAR)
        ,NUMREGPROP VARCHAR2(100 CHAR)
        , FOLIO	VARCHAR2(100 CHAR)
        , LIBRO	VARCHAR2(100 CHAR)
        , TOMO	VARCHAR2(100 CHAR)
        ,FINCA VARCHAR2(100 CHAR)
        , IDUFIR	VARCHAR2(100 CHAR)
        ,LATITUD VARCHAR2(100 CHAR)
        ,LONGITUD VARCHAR2(100 CHAR)
        ,PRECIO_RENTA VARCHAR2(100 CHAR)
        ,MESES_CARENCIA VARCHAR2(100 CHAR)
        ,BONIFICACIONES_GASTOS_1 VARCHAR2(100 CHAR)  
        ,BONIFICACIONES_GASTOS_2 VARCHAR2(100 CHAR)  
        ,ID_ACTIVO_ORIGEN VARCHAR2(100 CHAR)
        , COD_API	VARCHAR2(100 CHAR)
        ,TERRAZA VARCHAR2(100 CHAR)
        ,ANTIGUEDAD VARCHAR2(100 CHAR)
        ,ORIENTACION VARCHAR2(100 CHAR)
        ,ESTADO VARCHAR2(100 CHAR)
        ,AMUEBLADO VARCHAR2(1000 CHAR)   
        ,ARMARIOS_EMPOTRADOS VARCHAR2(100 CHAR)
        ,VIDIROS_DOBLES VARCHAR2(100 CHAR)
        ,TIPO_SUELO VARCHAR2(1000 CHAR)
        ,CARPINTERIA_EXTERIOR VARCHAR2(1000 CHAR)
        ,CALEFACCION VARCHAR2(1000 CHAR)
        ,ASCENSOR VARCHAR2(100 CHAR)
        ,COCINA_EQUIPADA  VARCHAR2(1000 CHAR)    
        ,PTA_ENT_BLINDADA VARCHAR2(100 CHAR)
        ,PISCINA VARCHAR2(100 CHAR)
        ,GARAJE VARCHAR2(100 CHAR)
        ,TRASTERO VARCHAR2(100 CHAR)
        , API_PRIMARIO	VARCHAR2(100 CHAR)
        , API_ESPEJO	VARCHAR2(100 CHAR)       
        ,ORIGEN_ACTIVO VARCHAR2(100 CHAR)
        ,DISPONIBLE VARCHAR2(1 CHAR)
        ,COD_MOTIVO_INDISPONIBILIDAD VARCHAR2(5 CHAR)
        ,GESTION VARCHAR2(1 CHAR)
        ,CARENCIA VARCHAR2(100 CHAR)
        ,BONIFICACION_1 VARCHAR2(100 CHAR)
        ,BONIFICACION_2 VARCHAR2(100 CHAR)
        ,BONIFICACION_3 VARCHAR2(100 CHAR)
        ,BONIFICACION_4 VARCHAR2(100 CHAR)

	)';

	DBMS_OUTPUT.PUT_LINE('[INFO] LA TABLA '''||V_TABLA||''' HA SIDO CREADA CON EXITO.');
  COMMIT;
 
  
  DBMS_OUTPUT.PUT_LINE('[INFO] PROCESO FINALIZADO.');

         
EXCEPTION

   WHEN OTHERS THEN
   
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;
/
EXIT
