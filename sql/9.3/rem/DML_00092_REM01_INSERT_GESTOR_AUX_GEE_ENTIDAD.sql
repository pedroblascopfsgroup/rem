--/*
--#########################################
--## AUTOR=Joaquin Bahamonde
--## FECHA_CREACION=20200129
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-9179
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
    V_ESQUEMA_M VARCHAR2(10 CHAR) := 'REMMASTER';
    V_INCIDENCIA VARCHAR2(50 CHAR) := 'HREOS-9179';
    V_TABLA VARCHAR2(30 CHAR) := 'AUX_GESTOR';
    V_TABLA_USU_USUARIOS VARCHAR2(30 CHAR) := 'USU_USUARIOS';
    V_TABLA_DD_TGE VARCHAR2(30 CHAR) := 'DD_TGE_TIPO_GESTOR';
    V_USERNAME VARCHAR2(30 CHAR) := 'grupgact';
    V_TGE_CODIGO VARCHAR2(30 CHAR) := 'GACT';
    V_ID_USU VARCHAR2(2400 CHAR);
    V_ID_TGE VARCHAR2(2400 CHAR);
    V_MSQL VARCHAR2(2400 CHAR);
                   
BEGIN


        V_MSQL := 'SELECT USU_ID FROM '||V_ESQUEMA_M||'.'||V_TABLA_USU_USUARIOS||' WHERE USU_USERNAME = '''||V_USERNAME||'''';
		EXECUTE IMMEDIATE V_MSQL INTO V_ID_USU;
        DBMS_OUTPUT.PUT_LINE(V_MSQL);

        V_MSQL := 'SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.'||V_TABLA_DD_TGE||' WHERE DD_TGE_CODIGO = '''||V_TGE_CODIGO||'''';
		EXECUTE IMMEDIATE V_MSQL INTO V_ID_TGE;
        DBMS_OUTPUT.PUT_LINE(V_MSQL);


    DBMS_OUTPUT.PUT_LINE('[INICIO]');
    
    EXECUTE IMMEDIATE 'INSERT INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD (GEE_ID, USU_ID, DD_TGE_ID, USUARIOCREAR, FECHACREAR, USUARIOMODIFICAR)
		SELECT  '||V_ESQUEMA||'.S_GEE_GESTOR_ENTIDAD.NEXTVAL, '||V_ID_USU||', '||V_ID_TGE||', '''||V_INCIDENCIA||''', SYSDATE, AUX.ACT
        	FROM '||V_ESQUEMA||'.AUX_GESTOR AUX ';
		DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||SQL%ROWCOUNT||' gestores activos insertados.');


	EXECUTE IMMEDIATE 'INSERT INTO '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO (GEE_ID, ACT_ID)
		SELECT GEE.GEE_ID, TO_NUMBER(GEE.USUARIOMODIFICAR)
		FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
		WHERE USUARIOCREAR = '''||V_INCIDENCIA||'''
			AND NOT EXISTS (SELECT 1
				FROM '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO AUX
				WHERE AUX.GEE_ID = GEE.GEE_ID)';
	DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||SQL%ROWCOUNT||' gestores activos insertados.');

	
	EXECUTE IMMEDIATE 'UPDATE '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD SET USUARIOMODIFICAR = NULL 
    WHERE USUARIOCREAR = '''||V_INCIDENCIA||'''';

	
	EXECUTE IMMEDIATE 'MERGE INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST T1
		USING (
		    SELECT GAH.ACT_ID, USU.USU_ID, TGE.DD_TGE_ID, GEH.GEH_ID
		    FROM '||V_ESQUEMA||'.'||V_TABLA||' AUX
		    JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = AUX.ACT
		    JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON USU.USU_USERNAME = AUX.USU
		    JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_CODIGO = AUX.TGE
		    JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH ON GAH.ACT_ID = ACT.ACT_ID
		    JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH ON GEH.GEH_ID = GAH.GEH_ID AND GEH.DD_TGE_ID = TGE.DD_TGE_ID
		    JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE1 ON TGE1.DD_TGE_ID = GEH.DD_TGE_ID
		    WHERE GEH.GEH_FECHA_HASTA IS NULL AND USU.USU_ID <> GEH.USU_ID) T2
		ON (T1.GEH_ID = T2.GEH_ID)
		WHEN MATCHED THEN UPDATE SET
		    T1.GEH_FECHA_HASTA = SYSDATE, T1.USUARIOMODIFICAR = '''||V_INCIDENCIA||''', T1.FECHAMODIFICAR = SYSDATE';
	DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||SQL%ROWCOUNT||' gestores entidad históricos actualizados.');
	    
	EXECUTE IMMEDIATE 'INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST (GEH_ID, USU_ID, DD_TGE_ID
		    , GEH_FECHA_DESDE, USUARIOCREAR, FECHACREAR, USUARIOMODIFICAR)
		SELECT '||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL, USU.USU_ID, TGE.DD_TGE_ID
		    , SYSDATE, '''||V_INCIDENCIA||''', SYSDATE, ACT.ACT_ID
		FROM '||V_ESQUEMA||'.'||V_TABLA||' AUX
		JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = AUX.ACT
		JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON USU.USU_USERNAME = AUX.USU
		JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_CODIGO = AUX.TGE
		WHERE NOT EXISTS (SELECT 1
		    FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
		    JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH ON GAH.GEH_ID = GEH.GEH_ID
		    WHERE GEH.GEH_FECHA_HASTA IS NULL AND TGE.DD_TGE_ID = GEH.DD_TGE_ID
		        AND ACT.ACT_ID = GAH.ACT_ID)';
	DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||SQL%ROWCOUNT||' gestores entidad históricos insertados.');
	    

	EXECUTE IMMEDIATE 'INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO (GEH_ID, ACT_ID)
		SELECT GEH.GEH_ID, TO_NUMBER(GEH.USUARIOMODIFICAR)
		FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH
		WHERE USUARIOCREAR = '''||V_INCIDENCIA||''' AND TRUNC(FECHACREAR) = TRUNC(SYSDATE)
			AND NOT EXISTS (SELECT 1
				FROM '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO AUX
				WHERE AUX.GEH_ID = GEH.GEH_ID)';
    DBMS_OUTPUT.PUT_LINE('	[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||SQL%ROWCOUNT||' gestores activos históricos insertados.');


	EXECUTE IMMEDIATE 'UPDATE '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST SET USUARIOMODIFICAR = NULL 
    WHERE USUARIOCREAR = '''||V_INCIDENCIA||'''';

    DBMS_OUTPUT.PUT_LINE('[FIN]');

    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT;


