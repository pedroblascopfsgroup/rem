--/*
--##########################################
--## AUTOR=Carles Molins
--## FECHA_CREACION=20200508
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-7267
--## PRODUCTO=NO
--##
--## Finalidad:
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Version inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    V_NUM_FILAS NUMBER(16); -- Vble. para validar la existencia de un registro.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    
    TCT_TOTAL NUMBER(16,2);
    V_COUNT NUMBER(16):= 0; -- Vble. para contar updates
    
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV;
	
	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
		T_JBV(914226900001),
		T_JBV(914226900002),
		T_JBV(914286400001),
		T_JBV(914304900001),
		T_JBV(914315100002),
		T_JBV(914384100001),
		T_JBV(914481400002),
		T_JBV(914537000001),
		T_JBV(914537300001),
		T_JBV(914629600001),
		T_JBV(914766300001),
		T_JBV(914887600001),
		T_JBV(914903100001),
		T_JBV(914903100003),
		T_JBV(914903100004),
		T_JBV(915260700001),
		T_JBV(915357500002),
		T_JBV(915460600001),
		T_JBV(915464700002),
		T_JBV(915693800001),
		T_JBV(915802600002),
		T_JBV(915802600003),
		T_JBV(915935400002),
		T_JBV(916208400001),
		T_JBV(916244000002),
		T_JBV(916252400001),
		T_JBV(916252400002),
		T_JBV(916296600001),
		T_JBV(916316100001),
		T_JBV(916316100002),
		T_JBV(916316100003),
		T_JBV(916316500001),
		T_JBV(916316500002),
		T_JBV(916316500003),
		T_JBV(916317300001),
		T_JBV(916317300002),
		T_JBV(916317300003),
		T_JBV(916317600001),
		T_JBV(916317600002),
		T_JBV(916317600003),
		T_JBV(916317900001),
		T_JBV(916317900002),
		T_JBV(916317900003),
		T_JBV(916355100001),
		T_JBV(916355100002),
		T_JBV(916371400001),
		T_JBV(916371400002),
		T_JBV(916401100002),
		T_JBV(916401100003),
		T_JBV(916418100002),
		T_JBV(916422800001),
		T_JBV(916425000001),
		T_JBV(916425000002),
		T_JBV(916443000001),
		T_JBV(916458200001),
		T_JBV(916458500001),
		T_JBV(916478900001),
		T_JBV(916488000002),
		T_JBV(916501500001),
		T_JBV(916556800001),
		T_JBV(916567400001),
		T_JBV(916567500001),
		T_JBV(916568900001),
		T_JBV(916572200001),
		T_JBV(916572300001),
		T_JBV(916595100001),
		T_JBV(916604900001),
		T_JBV(916605000002),
		T_JBV(916616100001),
		T_JBV(916617000002),
		T_JBV(916617700001),
		T_JBV(916618600001),
		T_JBV(916619100001),
		T_JBV(916619400001),
		T_JBV(916619500001),
		T_JBV(916619600001),
		T_JBV(916619900002),
		T_JBV(916620100002),
		T_JBV(916620300001),
		T_JBV(916622300002),
		T_JBV(916625400001),
		T_JBV(916625800001),
		T_JBV(916625900001),
		T_JBV(916625900002),
		T_JBV(916628400002),
		T_JBV(916630400001),
		T_JBV(916630400002),
		T_JBV(916632800001),
		T_JBV(916632900001),
		T_JBV(916633300001),
		T_JBV(916636700001),
		T_JBV(916639800001),
		T_JBV(916649900002),
		T_JBV(916650900002),
		T_JBV(916650900003),
		T_JBV(916657400001),
		T_JBV(916657500001),
		T_JBV(916657600001),
		T_JBV(916657700001),
		T_JBV(916657700002),
		T_JBV(916664500001),
		T_JBV(916665000001),
		T_JBV(916666300001),
		T_JBV(916668600001),
		T_JBV(916668700001),
		T_JBV(916670600002),
		T_JBV(916672400002),
		T_JBV(916672700001),
		T_JBV(916673000002),
		T_JBV(916679000001),
		T_JBV(916680300002),
		T_JBV(916680400001),
		T_JBV(916680400003),
		T_JBV(916682500002),
		T_JBV(916683000001),
		T_JBV(916684500001),
		T_JBV(916684500003),
		T_JBV(916684900001),
		T_JBV(916686000001),
		T_JBV(916687300001),
		T_JBV(916687300002),
		T_JBV(916687500001),
		T_JBV(916688100001),
		T_JBV(916691800001),
		T_JBV(916695600001),
		T_JBV(916695600002),
		T_JBV(916696800003),
		T_JBV(916699600001),
		T_JBV(916700900001),
		T_JBV(916701300001),
		T_JBV(916705000002),
		T_JBV(916705000003),
		T_JBV(916705300002),
		T_JBV(916708200001),
		T_JBV(916708200002),
		T_JBV(916708400001),
		T_JBV(916708400002),
		T_JBV(916709700001),
		T_JBV(916709700002),
		T_JBV(916709800001),
		T_JBV(916709800002),
		T_JBV(916710200001),
		T_JBV(916710200003),
		T_JBV(916710300001),
		T_JBV(916710300002),
		T_JBV(916710400001),
		T_JBV(916712900001),
		T_JBV(916713800001),
		T_JBV(916716100002),
		T_JBV(916718100001),
		T_JBV(916719300002),
		T_JBV(916746600001),
		T_JBV(916753900001),
		T_JBV(916756800001),
		T_JBV(916773400002),
		T_JBV(916773600001),
		T_JBV(916773800001),
		T_JBV(916775900001),
		T_JBV(916776300001),
		T_JBV(916780900001),
		T_JBV(916784400001),
		T_JBV(916786600001),
		T_JBV(916792600001),
		T_JBV(916793500001),
		T_JBV(916796400001),
		T_JBV(916796500001),
		T_JBV(916805400002),
		T_JBV(916805400003),
		T_JBV(916805700002),
		T_JBV(916807600001),
		T_JBV(916808400001),
		T_JBV(916809300001),
		T_JBV(916810100001),
		T_JBV(916810200001),
		T_JBV(916810300001),
		T_JBV(916810400001),
		T_JBV(916812400001),
		T_JBV(916812600001),
		T_JBV(916812700001),
		T_JBV(916812800001),
		T_JBV(916813000001),
		T_JBV(916813000003),
		T_JBV(916816200001),
		T_JBV(916819100001),
		T_JBV(916819300001),
		T_JBV(916821700001),
		T_JBV(916821800001),
		T_JBV(916823900002),
		T_JBV(916823900003),
		T_JBV(916824000002),
		T_JBV(916837400001),
		T_JBV(916837700001),
		T_JBV(916838200001),
		T_JBV(916839300001),
		T_JBV(916847000002),
		T_JBV(916848300001),
		T_JBV(916850900001),
		T_JBV(916851100002),
		T_JBV(916851700001),
		T_JBV(916851900001),
		T_JBV(916854100002),
		T_JBV(916854100003),
		T_JBV(916854200001),
		T_JBV(916854400001),
		T_JBV(916854600001),
		T_JBV(916864300001),
		T_JBV(916864300002),
		T_JBV(916865600001),
		T_JBV(916866300001),
		T_JBV(916866800001),
		T_JBV(916867700001),
		T_JBV(916867900001),
		T_JBV(916871700001),
		T_JBV(916871900001),
		T_JBV(916871900002),
		T_JBV(916872800001),
		T_JBV(916873400001),
		T_JBV(916873600001),
		T_JBV(916873800001),
		T_JBV(916874000001),
		T_JBV(916885400002),
		T_JBV(916886100001),
		T_JBV(916886500001),
		T_JBV(916886700001),
		T_JBV(916886700002),
		T_JBV(916888900001),
		T_JBV(916890800001),
		T_JBV(916893400002),
		T_JBV(916893800001),
		T_JBV(916894200001),
		T_JBV(916894200002),
		T_JBV(916895200001),
		T_JBV(916895700001),
		T_JBV(916896100001),
		T_JBV(916898900001),
		T_JBV(916899600001),
		T_JBV(916900500001),
		T_JBV(916900600001),
		T_JBV(916900600003),
		T_JBV(916901400001),
		T_JBV(916901800001),
		T_JBV(916909700001),
		T_JBV(916909900001),
		T_JBV(916910300001),
		T_JBV(916910700001),
		T_JBV(916915300002),
		T_JBV(916940300001),
		T_JBV(916946800001),
		T_JBV(916946900001),
		T_JBV(916947100001),
		T_JBV(916947200001),
		T_JBV(916948800001),
		T_JBV(916948900001)
	);
	V_TMP_JBV T_JBV;
	
BEGIN
	
	DBMS_OUTPUT.PUT_LINE('[INICIO]');

	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
		V_TMP_JBV := V_JBV(I);
	  	
	  	V_SQL := 'SELECT SUM(TCT_TOTAL) FROM (
					    SELECT TCT_MEDICION*TCT_PRECIO_UNITARIO AS TCT_TOTAL 
						FROM '||V_ESQUEMA||'.ACT_TCT_TRABAJO_CFGTARIFA 
					    WHERE TBJ_ID = (SELECT TBJ_ID FROM '||V_ESQUEMA||'.ACT_TBJ_TRABAJO WHERE TBJ_NUM_TRABAJO = '||TRIM(V_TMP_JBV(1))||')
					)';
		EXECUTE IMMEDIATE V_SQL INTO TCT_TOTAL;
		
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_RPV_RECARGOS_PROVEEDOR 
					(RPV_ID, TBJ_ID, DD_TRP_ID, DD_TCC_ID, RPV_IMPORTE_CALCULO, RPV_IMPORTE_FINAL, USUARIOCREAR, FECHACREAR, BORRADO)
				    SELECT '||V_ESQUEMA||'.S_ACT_RPV_RECARGOS_PROVEEDOR.NEXTVAL,
				    (SELECT TBJ_ID FROM '||V_ESQUEMA||'.ACT_TBJ_TRABAJO WHERE TBJ_NUM_TRABAJO = '||TRIM(V_TMP_JBV(1))||'),
				    1, 2, 20, '''||TCT_TOTAL||''',
				    ''REMVIP-7267'', SYSDATE, 0 FROM DUAL';
		EXECUTE IMMEDIATE V_SQL;
		
		V_COUNT := V_COUNT +1; 
	
	END LOOP;
	DBMS_OUTPUT.PUT_LINE('	[INFO] SE HAN INSERTADO '||V_COUNT||' REGISTROS EN LA TABLA REM01.ACT_RPV_RECARGOS_PROVEEDOR');
		
	COMMIT;
	DBMS_OUTPUT.PUT_LINE('[FIN]');
	
EXCEPTION
	WHEN OTHERS THEN
		ERR_NUM := SQLCODE;
		ERR_MSG := SQLERRM;
  		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
  		DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
  		DBMS_OUTPUT.put_line(ERR_MSG);
  		ROLLBACK;
  		RAISE;   
END;
/
EXIT;