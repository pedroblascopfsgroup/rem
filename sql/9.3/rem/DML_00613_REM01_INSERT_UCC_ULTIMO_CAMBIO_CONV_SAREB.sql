--/*
--#########################################
--## AUTOR=Daniel Algaba
--## FECHA_CREACION=20210512
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-13988
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##            
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
  V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_TABLA VARCHAR2(50 CHAR):= 'UCC_ULTIMO_CAMBIO_CONV_SAREB';
  V_COUNT NUMBER(16); -- Vble. para contar.
  V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  V_USUARIO VARCHAR2(32 CHAR):= 'HREOS-13988';
  ACT_NUM_ACTIVO_UVEM NUMBER(32);
  DD_SCR_DESCRIPCION VARCHAR2(72 CHAR);
  ACT_NUM_ACTIVO_OLD NUMBER(32);
  ACT_NUM_ACTIVO_NEW NUMBER(32);


BEGIN
  
    V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||'
                SELECT ACT_ID
                , DD_COS_ID
                , VALOR
                FROM (
                --MOD_REM_TPA
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''002'') DD_COS_ID
                , TPA.DD_TPA_CODIGO VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                LEFT JOIN '||V_ESQUEMA||'.DD_TPA_TIPO_ACTIVO TPA ON ACT.DD_TPA_ID = TPA.DD_TPA_ID AND TPA.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''002'' AND UCC.ACT_ID = ACT.ACT_ID)
                --MOD_REM_SAC
                UNION ALL
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''004'') DD_COS_ID
                , SAC.DD_SAC_CODIGO VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                LEFT JOIN '||V_ESQUEMA||'.DD_SAC_SUBTIPO_ACTIVO SAC ON ACT.DD_SAC_ID = SAC.DD_SAC_ID AND SAC.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''004'' AND UCC.ACT_ID = ACT.ACT_ID)
                --MOD_REM_FEC_INSCRIP
                UNION ALL
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''018'') DD_COS_ID
                , TO_CHAR(TIT.TIT_FECHA_INSC_REG, ''YYYY/MM/DD'') VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                JOIN '||V_ESQUEMA||'.ACT_TIT_TITULO TIT ON TIT.ACT_ID = ACT.ACT_ID AND TIT.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''018'' AND UCC.ACT_ID = ACT.ACT_ID)
                --MOD_REM_DD_TVI
                UNION ALL
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''040'') DD_COS_ID
                , TVI.DD_TVI_CODIGO VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE_LOC ON BIE_LOC.BIE_ID = ACT.BIE_ID AND BIE_LOC.BORRADO = 0
                LEFT JOIN REMMASTER.DD_TVI_TIPO_VIA TVI ON TVI.DD_TVI_ID = BIE_LOC.DD_TVI_ID AND TVI.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''040'' AND UCC.ACT_ID = ACT.ACT_ID)
                --MOD_REM_NOMBRE_VIA
                UNION ALL
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''042'') DD_COS_ID
                , BIE_LOC.BIE_LOC_NOMBRE_VIA VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE_LOC ON BIE_LOC.BIE_ID = ACT.BIE_ID AND BIE_LOC.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''042'' AND UCC.ACT_ID = ACT.ACT_ID)
                --MOD_REM_NUM_DOMIC
                UNION ALL
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''044'') DD_COS_ID
                , BIE_LOC.BIE_LOC_NUMERO_DOMICILIO VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE_LOC ON BIE_LOC.BIE_ID = ACT.BIE_ID AND BIE_LOC.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''044'' AND UCC.ACT_ID = ACT.ACT_ID)
                --MOD_REM_ESCALERA
                UNION ALL
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''046'') DD_COS_ID
                , BIE_LOC.BIE_LOC_ESCALERA VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE_LOC ON BIE_LOC.BIE_ID = ACT.BIE_ID AND BIE_LOC.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''046'' AND UCC.ACT_ID = ACT.ACT_ID)
                --MOD_REM_PISO
                UNION ALL
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''048'') DD_COS_ID
                , BIE_LOC.BIE_LOC_PISO VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE_LOC ON BIE_LOC.BIE_ID = ACT.BIE_ID AND BIE_LOC.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''048'' AND UCC.ACT_ID = ACT.ACT_ID)
                --MOD_REM_PUERTA
                UNION ALL
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''050'') DD_COS_ID
                , BIE_LOC.BIE_LOC_PUERTA VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE_LOC ON BIE_LOC.BIE_ID = ACT.BIE_ID AND BIE_LOC.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''050'' AND UCC.ACT_ID = ACT.ACT_ID)
                --MOD_REM_PROVINCIA
                UNION ALL
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''052'') DD_COS_ID
                , PRV.DD_PRV_CODIGO VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE_LOC ON BIE_LOC.BIE_ID = ACT.BIE_ID AND BIE_LOC.BORRADO = 0
                LEFT JOIN REMMASTER.DD_PRV_PROVINCIA PRV ON PRV.DD_PRV_ID = BIE_LOC.DD_PRV_ID AND PRV.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''052'' AND UCC.ACT_ID = ACT.ACT_ID)
                --MOD_REM_MUNICIPIO
                UNION ALL
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''054'') DD_COS_ID
                , LOC.DD_LOC_CODIGO VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE_LOC ON BIE_LOC.BIE_ID = ACT.BIE_ID AND BIE_LOC.BORRADO = 0
                LEFT JOIN REMMASTER.DD_LOC_LOCALIDAD LOC ON LOC.DD_LOC_ID = BIE_LOC.DD_LOC_ID AND LOC.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''054'' AND UCC.ACT_ID = ACT.ACT_ID)
                --MOD_REM_COD_POSTAL
                UNION ALL
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''058'') DD_COS_ID
                , BIE_LOC.BIE_LOC_COD_POST VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                JOIN '||V_ESQUEMA||'.BIE_LOCALIZACION BIE_LOC ON BIE_LOC.BIE_ID = ACT.BIE_ID AND BIE_LOC.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''058'' AND UCC.ACT_ID = ACT.ACT_ID)
                --MOD_REM_LATITUD
                UNION ALL
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''060'') DD_COS_ID
                , CASE WHEN ACT_LOC.LOC_LATITUD < 0 THEN REPLACE(REPLACE(ACT_LOC.LOC_LATITUD,'','',''.''), ''-.'',''-0.'')
                  WHEN SUBSTR(ACT_LOC.LOC_LATITUD,0,1) = '','' THEN REPLACE(REPLACE(TO_CHAR(ACT_LOC.LOC_LATITUD),'','',''.''),''.'',''0.'')
                  ELSE REPLACE(ACT_LOC.LOC_LATITUD,'','',''.'') END VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                JOIN '||V_ESQUEMA||'.ACT_LOC_LOCALIZACION ACT_LOC ON ACT_LOC.ACT_ID = ACT.ACT_ID AND ACT_LOC.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''060'' AND UCC.ACT_ID = ACT.ACT_ID)
                --MOD_REM_LONGITUD
                UNION ALL
                SELECT ACT.ACT_ID 
                , (SELECT DD_COS_ID FROM '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB WHERE DD_COS_CODIGO = ''062'') DD_COS_ID
                , CASE WHEN ACT_LOC.LOC_LONGITUD < 0 THEN REPLACE(REPLACE(ACT_LOC.LOC_LONGITUD,'','',''.''), ''-.'',''-0.'')
                  WHEN SUBSTR(ACT_LOC.LOC_LONGITUD,0,1) = '','' THEN REPLACE(REPLACE(TO_CHAR(ACT_LOC.LOC_LONGITUD),'','',''.''),''.'',''0.'')
                  ELSE REPLACE(ACT_LOC.LOC_LONGITUD,'','',''.'') END VALOR
                FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
                JOIN '||V_ESQUEMA||'.ACT_LOC_LOCALIZACION ACT_LOC ON ACT_LOC.ACT_ID = ACT.ACT_ID AND ACT_LOC.BORRADO = 0
                WHERE ACT.BORRADO = 0 AND CRA.DD_CRA_CODIGO = ''02''
                AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' UCC
                JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON COS.DD_COS_ID = UCC.DD_COS_ID
                WHERE COS.DD_COS_CODIGO = ''062'' AND UCC.ACT_ID = ACT.ACT_ID))';
  EXECUTE IMMEDIATE V_SQL;
  DBMS_OUTPUT.PUT_LINE('Insertados ' ||SQL%ROWCOUNT|| ' registros');

  V_SQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' UCC
            USING(SELECT 
            UCC.ACT_ID
            , UCC.DD_COS_ID
            , CASE WHEN SUBSTR(UCC.VALOR,0,2) = ''-.'' THEN REPLACE(REPLACE(UCC.VALOR,'','',''.''), ''-.'',''-0.'')
            WHEN SUBSTR(UCC.VALOR,0,1) = ''.'' THEN REPLACE(UCC.VALOR,''.'',''0.'') END VALOR
            FROM '||V_ESQUEMA||'.UCC_ULTIMO_CAMBIO_CONV_SAREB UCC
            JOIN '||V_ESQUEMA||'.DD_COS_CAMPOS_ORIGEN_CONV_SAREB COS ON UCC.DD_COS_ID = COS.DD_COS_ID
            WHERE (SUBSTR(UCC.VALOR,0,1) = ''.'' OR SUBSTR(UCC.VALOR,0,2) = ''-.'')
            AND COS.DD_COS_CODIGO IN (''060'',''062'')) AUX
            ON (UCC.ACT_ID = AUX.ACT_ID AND UCC.DD_COS_ID = AUX.DD_COS_ID)
            WHEN MATCHED THEN
                UPDATE SET UCC.VALOR = AUX.VALOR';
  EXECUTE IMMEDIATE V_SQL;
  DBMS_OUTPUT.PUT_LINE('Actualizados ' ||SQL%ROWCOUNT|| ' registros');
  COMMIT;    

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
