--/*
--##########################################
--## AUTOR=Alejandra García
--## FECHA_CREACION=20211110
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-16383
--## PRODUCTO=NO
--##
--## Finalidad: Cuadrar propietarios gastos
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;
DECLARE

    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_MSQL VARCHAR2(4000 CHAR);
	V_NUM_FILAS NUMBER;

    ERR_NUM NUMBER; -- Numero de errores
    ERR_MSG VARCHAR2(2048); -- Mensaje de error

    -- EDITAR NÚMERO DE ITEM
    V_ITEM VARCHAR2(20) := 'HREOS-16383';
	V_NUM NUMBER;
BEGIN	
    
    DBMS_OUTPUT.PUT_LINE('[INICIO]');

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR T1
				USING (
					SELECT
						 GPV_ID
						,PROPIETARIO_ACTIVO
						,PROPIETARIO_GASTO
					FROM (
						SELECT
							 GPV.GPV_ID
							,GPV.PRO_ID PROPIETARIO_GASTO
							,ACT.ACT_ID
							,CASE
								WHEN PAC.PRO_ID IS NULL THEN (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_SOCIEDAD_PAGADORA=''0001'')
								ELSE PAC.PRO_ID
							END AS PROPIETARIO_ACTIVO
							,ROW_NUMBER() OVER(PARTITION BY GPV.GPV_ID ORDER BY DECODE(PRO2.PRO_SOCIEDAD_PAGADORA,''0001'',1,0) DESC NULLS LAST) RN
						FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV 
						JOIN '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR PVE ON PVE.PVE_ID=GPV.PVE_ID_EMISOR
							AND PVE.BORRADO=0    
						JOIN '||V_ESQUEMA||'.DD_TGA_TIPOS_GASTO TGA ON TGA.DD_TGA_ID=GPV.DD_TGA_ID AND TGA.DD_TGA_CODIGO IN (''05'',''07'')
							AND TGA.BORRADO=0 
						JOIN '||V_ESQUEMA||'.GLD_GASTOS_LINEA_DETALLE GLD ON GLD.GPV_ID=GPV.GPV_ID
							AND GLD.BORRADO=0
						JOIN '||V_ESQUEMA||'.DD_STG_SUBTIPOS_GASTO STG ON STG.DD_STG_ID=GLD.DD_STG_ID
							AND STG.BORRADO=0
						JOIN '||V_ESQUEMA||'.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID=GPV.GPV_ID
							AND GDE.BORRADO=0
						LEFT JOIN '||V_ESQUEMA||'.DD_TIT_TIPOS_IMPUESTO TIT ON TIT.DD_TIT_ID=GLD.DD_TIT_ID
							AND TIT.BORRADO=0
						JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID 
								AND GGE.BORRADO = 0
						JOIN '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO EGA ON EGA.DD_EGA_ID = GPV.DD_EGA_ID
							AND EGA.BORRADO = 0
						JOIN '||V_ESQUEMA||'.DD_EAH_ESTADOS_AUTORIZ_HAYA DD_EAH ON DD_EAH.DD_EAH_ID = GGE.DD_EAH_ID
							AND DD_EAH.BORRADO = 0  
						JOIN '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = GPV.PRO_ID
								AND PRO.BORRADO = 0
						JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = PRO.DD_CRA_ID
							AND CRA.BORRADO = 0
						LEFT JOIN '||V_ESQUEMA||'.GLD_ENT GLDENT ON GLDENT.GLD_ID=GLD.GLD_ID
							AND GLDENT.BORRADO=0
						LEFT JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID=GLDENT.ENT_ID
							AND ACT.BORRADO=0
						LEFT JOIN '||V_ESQUEMA||'.ACT_PAC_PROPIETARIO_ACTIVO PAC ON PAC.ACT_ID=ACT.ACT_ID
							AND PAC.BORRADO=0
						LEFT JOIN '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO PRO2 ON PRO2.PRO_ID=PAC.PRO_ID
							AND PRO2.BORRADO=0
						WHERE GPV.BORRADO=0
							AND DD_EAH.DD_EAH_CODIGO = ''03'' 
							AND CRA.DD_CRA_CODIGO = ''03'' 
							AND EGA.DD_EGA_CODIGO = ''03'' 
							AND (GDE.GDE_IMPORTE_TOTAL IS NOT NULL AND GDE.GDE_IMPORTE_TOTAL<> 0)
							AND GGE.GGE_FECHA_ENVIO_PRPTRIO IS NULL
							AND PRO.PRO_DOCIDENTIF not in (''P46644290'',''A80352750'',''A80514466'')
					) WHERE RN=1 AND PROPIETARIO_GASTO<>PROPIETARIO_ACTIVO
				) T2 ON(T1.GPV_ID = T2.GPV_ID)
				WHEN MATCHED THEN 
					UPDATE SET 
					 T1.PRO_ID=T2.PROPIETARIO_ACTIVO
					,T1.USUARIOMODIFICAR=''Antiguo PRO_ID es ''||PROPIETARIO_GASTO
					,T1.FECHAMODIFICAR=SYSDATE';
	    
	EXECUTE IMMEDIATE V_MSQL;
	V_NUM_FILAS := sql%rowcount;

	DBMS_OUTPUT.put_line('[INFO] SE HAN MODIFICADO ' || V_NUM_FILAS ||' REGISTROS EN GPV_GASTOS_PROVEEDOR  [INFO]');
	
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;