--/*
--#########################################
--## AUTOR=Alejandra García
--## FECHA_CREACION=20220531
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-11773
--## PRODUCTO=NO
--## 
--## Finalidad: Actualizacion registros 
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Versión inicial - [HREOS-17514] - Alejandra
--##        0.2 Corección subtipo - [REMVIP-11773] - Alejandra
--#########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	V_TABLA VARCHAR2(100 CHAR) := 'DD_ETG_EQV_TIPO_GASTO'; -- Tabla Destino
	V_TABLA_AUX VARCHAR2(100 CHAR) := 'DD_ETG_EQV_TIPO_GASTO'; -- Tabla origen
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_SQL VARCHAR2(4000 CHAR);
	PL_OUTPUT VARCHAR2(32000 CHAR);
	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-11773';
	V_NUM_REGISTROS NUMBER; -- Cuenta registros 
	V_NUM NUMBER;
	V_FLAG_VACIADO NUMBER := 0;
    TYPE T_TABLA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_TABLA IS TABLE OF T_TABLA;
	
    M_TABLA T_ARRAY_TABLA := T_ARRAY_TABLA(
      --DD_ETG_CODIGO  Elemento PEP	CLASE/GRUPO	  TIPO	SUBTIPO	DD_TGA_CODIGO	DD_STG_CODIGO  DESCRIPCIÓN  PRO_DOCIDENTIF	
	  T_TABLA('1004','XXXX-21-1-SEGURIDAD','3','42','5','16','150','Alquiler PAO','null'),
	  T_TABLA('1005','XXXX-21-1-VIGILANCIA','3','42','5','16','150','Alquiler PAO','B46644290')
    ); 
    V_TMP_TABLA T_TABLA;
	
BEGIN

    FOR I IN M_TABLA.FIRST .. M_TABLA.LAST
      LOOP
	  V_TMP_TABLA := M_TABLA(I);

--Comprobamos el dato a insertar
V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA_AUX||' WHERE DD_ETG_CODIGO = '''||V_TMP_TABLA(1)||'''';
EXECUTE IMMEDIATE V_SQL INTO V_NUM_REGISTROS;
  
  IF V_NUM_REGISTROS > 0 THEN

        
        DBMS_OUTPUT.PUT_LINE('[INFO] YA ESTÁ INSERTADO EL REGISTRO, SE PROCEDE A MODIFICARLO');

		V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET
					  DD_TGA_ID = (SELECT DD_TGA_ID FROM '||V_ESQUEMA||'.DD_TGA_TIPOS_GASTO WHERE DD_TGA_CODIGO = '''||V_TMP_TABLA(6)||''' AND BORRADO = 0 )
					, DD_STG_ID = (SELECT DD_STG_ID FROM '||V_ESQUEMA||'.DD_STG_SUBTIPOS_GASTO WHERE DD_STG_CODIGO = '''||V_TMP_TABLA(7)||''' AND BORRADO = 0 )
					, DD_ETG_DESCRIPCION_POS = '''||V_TMP_TABLA(8)||'''
					, DD_ETG_DESCRIPCION_LARGA_POS = '''||V_TMP_TABLA(8)||'''
					, COGRUG_POS = '''||V_TMP_TABLA(3)||'''
					, COTACA_POS = '''||V_TMP_TABLA(4)||'''
					, COSBAC_POS = '''||V_TMP_TABLA(5)||'''
					, DD_ETG_DESCRIPCION_NEG = '''||V_TMP_TABLA(8)||'''
					, DD_ETG_DESCRIPCION_LARGA_NEG = '''||V_TMP_TABLA(8)||'''
					, COGRUG_NEG = '''||V_TMP_TABLA(3)||'''
					, COTACA_NEG = '''||V_TMP_TABLA(4)||'''
					, COSBAC_NEG = '''||V_TMP_TABLA(5)||'''
					, USUARIOMODIFICAR = '''||V_USUARIO||'''
					, FECHAMODIFICAR = SYSDATE
					, PRO_ID = (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_DOCIDENTIF = '''||V_TMP_TABLA(9)||''' AND BORRADO = 0 ) 
					, EJE_ID = (SELECT EJE2.EJE_ID FROM '|| V_ESQUEMA ||'.ACT_EJE_EJERCICIO EJE2 WHERE EJE2.EJE_ANYO = ''2021'' AND EJE2.BORRADO = 0 )
					, ELEMENTO_PEP = '''||V_TMP_TABLA(2)||'''
				WHERE DD_ETG_CODIGO = '''||V_TMP_TABLA(1)||'''
			';
		EXECUTE IMMEDIATE V_SQL;

        
    ELSE
		
	DBMS_OUTPUT.PUT_LINE('[INFO]: INSERTANDO '|| V_TABLA);

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||'(
				  DD_ETG_ID
				, DD_TGA_ID
				, DD_STG_ID
				, DD_ETG_CODIGO
				, DD_ETG_DESCRIPCION_POS
				, DD_ETG_DESCRIPCION_LARGA_POS
				, COGRUG_POS
				, COTACA_POS
				, COSBAC_POS
				, DD_ETG_DESCRIPCION_NEG
				, DD_ETG_DESCRIPCION_LARGA_NEG
				, COGRUG_NEG
				, COTACA_NEG
				, COSBAC_NEG
				, VERSION
				, USUARIOCREAR
				, FECHACREAR
				, BORRADO
				, PRO_ID
				, EJE_ID
				, ELEMENTO_PEP
		  ) VALUES (
			  	'||V_ESQUEMA||'.S_DD_ETG_EQV_TIPO_GASTO_RU.NEXTVAL
				  , (SELECT DD_TGA_ID FROM '||V_ESQUEMA||'.DD_TGA_TIPOS_GASTO WHERE DD_TGA_CODIGO = '''||V_TMP_TABLA(6)||''' AND BORRADO = 0 )
				  , (SELECT DD_STG_ID FROM '||V_ESQUEMA||'.DD_STG_SUBTIPOS_GASTO WHERE DD_STG_CODIGO = '''||V_TMP_TABLA(7)||''' AND BORRADO = 0 )
				  , '''||V_TMP_TABLA(1)||'''
				  , '''||V_TMP_TABLA(8)||'''
				  , '''||V_TMP_TABLA(8)||'''
				  , '''||V_TMP_TABLA(3)||'''
				  , '''||V_TMP_TABLA(4)||'''
				  , '''||V_TMP_TABLA(5)||'''
				  , '''||V_TMP_TABLA(8)||'''
				  , '''||V_TMP_TABLA(8)||'''
				  , '''||V_TMP_TABLA(3)||''' 
				  , '''||V_TMP_TABLA(4)||'''
				  , '''||V_TMP_TABLA(5)||'''
				  , 0
				  ,  '''||V_USUARIO||'''
				  , SYSDATE
				  , 0
				  , (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_DOCIDENTIF = '''||V_TMP_TABLA(9)||''' AND BORRADO = 0 ) 
				  , (SELECT EJE2.EJE_ID FROM '|| V_ESQUEMA ||'.ACT_EJE_EJERCICIO EJE2 WHERE EJE2.EJE_ANYO = ''2021'' AND EJE2.BORRADO = 0 )
				  , '''||V_TMP_TABLA(2)||'''
		)';
		EXECUTE IMMEDIATE V_SQL;	
	
	COMMIT;
	END IF;
	END LOOP;
        DBMS_OUTPUT.PUT_LINE('[INFO] MERGE PARA PEPs DONDE NO COINCIDEN TIPO Y SUBTIPO DE GASTO');
		V_SQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA_AUX||' T1
					USING(
						SELECT
							ETG.DD_ETG_ID
						FROM '||V_ESQUEMA||'.DD_ETG_EQV_TIPO_GASTO ETG
						LEFT JOIN '||V_ESQUEMA||'.DD_STG_SUBTIPOS_GASTO STG ON STG.DD_STG_ID = ETG.DD_STG_ID
							AND STG.BORRADO = 0
						WHERE NVL(ETG.DD_TGA_ID, 0) <> NVL(STG.DD_TGA_ID, 0) 
						AND (ETG.DD_TGA_ID IS NOT NULL OR ETG.DD_STG_ID IS NOT NULL)
				  ) T2 ON (T1.DD_ETG_ID = T2.DD_ETG_ID)                                                
                  WHEN MATCHED THEN UPDATE
					SET
				  		 T1.BORRADO = 1
						,T1.USUARIOBORRAR = '''||V_USUARIO||'''
						,T1.FECHABORRAR = SYSDATE
			    ';
			EXECUTE IMMEDIATE V_SQL;	

        DBMS_OUTPUT.PUT_LINE('[INFO] FILAS BORRADAS '||SQL%ROWCOUNT||' REVISAR LA TABLA DD_ETG_EQV_TIPO_GASTO');

	PL_OUTPUT := PL_OUTPUT || '[FIN]'||CHR(10);
	DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
	commit;


EXCEPTION
    WHEN OTHERS THEN
      PL_OUTPUT := PL_OUTPUT ||'[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE)||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||'-----------------------------------------------------------'||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||SQLERRM||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||V_SQL||CHR(10);
      DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
