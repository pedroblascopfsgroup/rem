--/*
--##########################################
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20210921
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-15185
--## PRODUCTO=NO
--## 
--## Finalidad: INSERTAMOS valores de cartera maestro
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
	V_MSQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
 	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
 	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	V_USUARIO VARCHAR2(50 CHAR) := 'HREOS-15185'; -- USUARIO CREAR/MODIFICAR
	V_COUNT NUMBER(16); -- Vble. para comprobar
	V_EXISTE_CRA NUMBER(16) := 0; 
	V_EXISTE_SCR NUMBER(16) := 0;
	err_num NUMBER; -- Numero de errores
	err_msg VARCHAR2(2048); -- Mensaje de error

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(32000 CHAR);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
		--			CRA	  SCR	DE_CARTERA
     	T_TIPO_DATA('16','153','BBVA'),
		T_TIPO_DATA('16','154','BBVA'),
		T_TIPO_DATA('16','155','BBVA'),
		T_TIPO_DATA('16','156','BBVA'),
		T_TIPO_DATA('16','158','BBVA'),
		T_TIPO_DATA('16','157','BBVA'),
		T_TIPO_DATA('03','09','BANKIA'),
		T_TIPO_DATA('03','08','BANKIA'),
		T_TIPO_DATA('17','07','BANKIA'),
		T_TIPO_DATA('03','05','BANKIA'),
		T_TIPO_DATA('03','06','BANKIA'),
		T_TIPO_DATA('03','19','BANKIA'),
		T_TIPO_DATA('03','15','BANKIA'),
		T_TIPO_DATA('03','14','BANKIA'),
		T_TIPO_DATA('01','02','CAJAMAR'),
		T_TIPO_DATA('01','01','CAJAMAR'),
		T_TIPO_DATA('07','17','CERBERUS ORIGINAL'),
		T_TIPO_DATA('07','38','JAIPUR'),
		T_TIPO_DATA('07','152','DIVARIAN'),
		T_TIPO_DATA('07','151','DIVARIAN'),
		T_TIPO_DATA('07','137','AGORA'),
		T_TIPO_DATA('07','134','EGEO ZEUS'),
		T_TIPO_DATA('07','133','EGEO ZEUS'),
		T_TIPO_DATA('07','39','EGEO ZEUS'),
		T_TIPO_DATA('07','37','JAIPUR'),
		T_TIPO_DATA('07','138','APPLE'),
		T_TIPO_DATA('07','135','APPLE'),
		T_TIPO_DATA('13','41','EGEO ZEUS'),
		T_TIPO_DATA('15','40','GALLEON'),
		T_TIPO_DATA('12','32','GIANTS'),
		T_TIPO_DATA('12','33','GIANTS'),
		T_TIPO_DATA('12','34','GIANTS'),
		T_TIPO_DATA('12','35','GIANTS'),
		T_TIPO_DATA('12','36','GIANTS'),
		T_TIPO_DATA('06','16','HAYA TITULIZACION'),
		T_TIPO_DATA('02','03','SAREB'),
		T_TIPO_DATA('02','04','SAREB'),
		T_TIPO_DATA('10','23','TANGO'),
		T_TIPO_DATA('10','24','TANGO'),
		T_TIPO_DATA('11','25','BANKIA'),
		T_TIPO_DATA('11','28','ING'),
		T_TIPO_DATA('11','30','ING'),
		T_TIPO_DATA('11','032','CAJAMAR'),
		T_TIPO_DATA('11','139','YUBAI'),
		T_TIPO_DATA('11','140','CASER'),
		T_TIPO_DATA('11','66','MAPFRE'),
		T_TIPO_DATA('11','68','ONE TO ONE'),
		T_TIPO_DATA('11','65','OMEGA'),
		T_TIPO_DATA('11','67','BANKIA'),
		T_TIPO_DATA('08','18','UNICAJA'),
		T_TIPO_DATA('08','56','UNICAJA'),
		T_TIPO_DATA('08','57','UNICAJA'),
		T_TIPO_DATA('08','64','UNICAJA'),
		T_TIPO_DATA('08','59','UNICAJA'),
		T_TIPO_DATA('08','60','UNICAJA'),
		T_TIPO_DATA('08','136','UNICAJA'),
		T_TIPO_DATA('08','58','UNICAJA')
    ); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
	
BEGIN
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');

	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
    LOOP
    V_TMP_TIPO_DATA := V_TIPO_DATA(I);

		V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.DD_CRA_CARTERA WHERE DD_CRA_CODIGO = '''||TRIM(V_TMP_TIPO_DATA(1))||''' AND BORRADO = 0';
		EXECUTE IMMEDIATE V_MSQL INTO V_EXISTE_CRA;

		V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.DD_SCR_SUBCARTERA WHERE DD_SCR_CODIGO = '''||TRIM(V_TMP_TIPO_DATA(2))||''' AND BORRADO = 0';
		EXECUTE IMMEDIATE V_MSQL INTO V_EXISTE_SCR;
		
		IF V_EXISTE_CRA = 1 AND V_EXISTE_SCR = 1 THEN

			V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.CAM_CARTERA_MAESTRO WHERE 
						DD_CRA_ID = (SELECT DD_CRA_ID FROM '||V_ESQUEMA||'.DD_CRA_CARTERA WHERE DD_CRA_CODIGO = '''||TRIM(V_TMP_TIPO_DATA(1))||''' AND BORRADO = 0)
						AND DD_SCR_ID = (SELECT DD_SCR_ID FROM '||V_ESQUEMA||'.DD_SCR_SUBCARTERA WHERE DD_SCR_CODIGO = '''||TRIM(V_TMP_TIPO_DATA(2))||''' AND BORRADO = 0)
						AND BORRADO = 0';
			EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

			IF V_COUNT = 0 THEN

				DBMS_OUTPUT.PUT_LINE('[INFO] INSERTAMOS NUEVO REGISTRO');

				V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.CAM_CARTERA_MAESTRO (CAM_ID,DD_CRA_ID,DD_SCR_ID,DE_CARTERA,USUARIOCREAR,FECHACREAR) VALUES 
								( '||V_ESQUEMA||'.S_CAM_CARTERA_MAESTRO.NEXTVAL, 
								(SELECT DD_CRA_ID FROM '||V_ESQUEMA||'.DD_CRA_CARTERA WHERE DD_CRA_CODIGO = '''||TRIM(V_TMP_TIPO_DATA(1))||''' AND BORRADO = 0), 
								(SELECT DD_SCR_ID FROM '||V_ESQUEMA||'.DD_SCR_SUBCARTERA WHERE DD_SCR_CODIGO = '''||TRIM(V_TMP_TIPO_DATA(2))||''' AND BORRADO = 0),
								'''||TRIM(V_TMP_TIPO_DATA(3))||''','''||V_USUARIO||''',SYSDATE)';
				EXECUTE IMMEDIATE V_MSQL;

				DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADO REGISTRO EN CAM_CARTERA_MAESTRO');
				DBMS_OUTPUT.PUT_LINE('[INFO] CARTERA (CODIGO '''||TRIM(V_TMP_TIPO_DATA(1))||''') Y SUBCARTERA (CODIGO '''||TRIM(V_TMP_TIPO_DATA(2))||''') VALOR '''||TRIM(V_TMP_TIPO_DATA(3))||'''');

			ELSE

				DBMS_OUTPUT.PUT_LINE('[INFO] YA EXISTE REGISTRO DE CARTERA (CODIGO '''||TRIM(V_TMP_TIPO_DATA(1))||''') Y SUBCARTERA (CODIGO '''||TRIM(V_TMP_TIPO_DATA(2))||''')');

			END IF;

		ELSE

			DBMS_OUTPUT.PUT_LINE('[INFO] CARTERA CON CODIGO '''||TRIM(V_TMP_TIPO_DATA(1))||''' Y/O SUBCARTERA CON CODIGO '''||TRIM(V_TMP_TIPO_DATA(2))||''' NO EXISTE');

		END IF;

	END LOOP;

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN] ');
	
	EXCEPTION
	
	    WHEN OTHERS THEN
		DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
		DBMS_OUTPUT.PUT_LINE(SQLERRM);
		DBMS_OUTPUT.PUT_LINE(V_MSQL);
		ROLLBACK;
		RAISE;
END;
/
EXIT;