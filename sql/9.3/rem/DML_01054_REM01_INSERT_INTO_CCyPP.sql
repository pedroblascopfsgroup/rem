--/*
--##########################################
--## AUTOR= Lara Pablo Flores
--## FECHA_CREACION=20211206
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-16582
--## PRODUCTO=NO
--##
--## Finalidad: Se modifican datos a la tabla MGD_MAPEO_GESTOR_DOC
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	
    V_TEXT1 VARCHAR2(2400 CHAR); -- Vble. auxiliar
    V_ENTIDAD_ID NUMBER(16);
    V_ID NUMBER(16);
    V_TABLA_CC VARCHAR2(25 CHAR):='ACT_CONFIG_CTAS_CONTABLES';
    V_TABLA_PP VARCHAR2(25 CHAR):='ACT_CONFIG_PTDAS_PREP';
	V_TABLA_SCR VARCHAR2(25 CHAR):='DD_SCR_SUBCARTERA';
	V_TABLA_PRO VARCHAR2(25 CHAR):='ACT_PRO_PROPIETARIO';
    V_USUARIO VARCHAR2(25 CHAR):='HREOS-16582';
    

                
BEGIN	        
	            
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');
	            
    DBMS_OUTPUT.PUT_LINE('[INFO]: INSERCION EN '||V_TABLA_CC||'] ');
    V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_CC||'
				SELECT  
					('||V_ESQUEMA||'.S_'||V_TABLA_CC||'.NEXTVAL),
					CCC_CUENTA_CONTABLE, DD_TGA_ID, DD_STG_ID, DD_TIM_ID, DD_CRA_ID,
					(SELECT DD_SCR_ID FROM '||V_ESQUEMA||'.'||V_TABLA_SCR||' WHERE DD_SCR_CODIGO = ''70'') ,
					PRO_ID, EJE_ID, CCC_ARRENDAMIENTO, CCC_REFACTURABLE, VERSION,
					'''||V_USUARIO||''', SYSDATE, null, null, null, null,
					BORRADO, DD_TBE_ID, CCC_SUBCUENTA_CONTABLE, CCC_ACTIVABLE, CCC_PLAN_VISITAS, DD_TCH_ID, CCC_PRINCIPAL, DD_TRT_ID, CCC_VENDIDO
				FROM '||V_ESQUEMA||'.'||V_TABLA_CC||' 
				WHERE BORRADO = 0 
				AND DD_SCR_ID = (SELECT DD_SCR_ID FROM '||V_ESQUEMA||'.'||V_TABLA_SCR||' WHERE DD_SCR_CODIGO = ''138'')
				AND PRO_ID IN ((SELECT PRO_ID FROM '||V_ESQUEMA||'.'||V_TABLA_PRO||' WHERE PRO_DOCIDENTIF IN(''A88203542'', ''A88203534'')))';
	
	--DBMS_OUTPUT.PUT_LINE(V_SQL);
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[FIN]: '||V_TABLA_CC||' ACTUALIZADA CORRECTAMENTE ');
	
	 DBMS_OUTPUT.PUT_LINE('[INFO]: INSERCION EN '||V_TABLA_PP||'] ');
    V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_PP||'
				SELECT  
					( '||V_ESQUEMA||'.S_'||V_TABLA_PP||'.NEXTVAL),
					CPP_PARTIDA_PRESUPUESTARIA, DD_TGA_ID, DD_STG_ID, DD_TIM_ID, DD_CRA_ID,
					(SELECT DD_SCR_ID FROM '||V_ESQUEMA||'.'||V_TABLA_SCR||' WHERE DD_SCR_CODIGO = ''70''),
					PRO_ID, EJE_ID, CPP_ARRENDAMIENTO, CPP_REFACTURABLE, VERSION,
					'''||V_USUARIO||''', SYSDATE, null, null, null, null,
					BORRADO, CPP_PRINCIPAL, DD_TBE_ID, CPP_APARTADO, CPP_CAPITULO, CPP_ACTIVABLE,CPP_PLAN_VISITAS, DD_TCH_ID, DD_TRT_ID, CPP_VENDIDO
				FROM '||V_ESQUEMA||'.'||V_TABLA_PP||' 
				WHERE BORRADO = 0 
				AND DD_SCR_ID = (SELECT DD_SCR_ID FROM '||V_ESQUEMA||'.'||V_TABLA_SCR||' WHERE DD_SCR_CODIGO = ''138'')
				AND PRO_ID IN ((SELECT PRO_ID FROM '||V_ESQUEMA||'.'||V_TABLA_PRO||' WHERE PRO_DOCIDENTIF IN(''A88203542'', ''A88203534'')))';
	
	--DBMS_OUTPUT.PUT_LINE(V_SQL);
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[FIN]: '||V_TABLA_PP||' ACTUALIZADA CORRECTAMENTE ');
	
    COMMIT;

EXCEPTION
	WHEN OTHERS THEN
		err_num := SQLCODE;
		err_msg := SQLERRM;
		
		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
		DBMS_OUTPUT.put_line(err_msg);
		
		ROLLBACK;
		RAISE;          

END;
/
EXIT