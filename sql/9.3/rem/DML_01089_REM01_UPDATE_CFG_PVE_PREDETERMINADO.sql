--/*
--##########################################
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20221006
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-12383
--## PRODUCTO=NO
--##
--## Finalidad: Actualizar configuracion proveedores e insertar la existente de Caixabank (subcartera) para Living
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(124 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-12383'; -- USUARIOCREAR/USUARIOMODIFICAR.    
	V_COUNT NUMBER(16);
	V_CARTERAS VARCHAR2(30 CHAR) := '''03'',''17'',''18''';
    
    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;    
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
		T_TIPO_DATA('10004312','2'),
		T_TIPO_DATA('10007550','3'),
		T_TIPO_DATA('10007348','4'),
		T_TIPO_DATA('10004312','1'),
		T_TIPO_DATA('10004312','33'),
		T_TIPO_DATA('10004312','5'),
		T_TIPO_DATA('10007348','6'),
		T_TIPO_DATA('10007550','7'),
		T_TIPO_DATA('110161850','8'),
		T_TIPO_DATA('10004312','48'),
		T_TIPO_DATA('10004312','9'),
		T_TIPO_DATA('10007348','10'),
		T_TIPO_DATA('10007348','11'),
		T_TIPO_DATA('10004312','39'),
		T_TIPO_DATA('10007550','12'),
		T_TIPO_DATA('10007348','51'),
		T_TIPO_DATA('10004312','13'),
		T_TIPO_DATA('10007348','14'),
		T_TIPO_DATA('10004312','15'),
		T_TIPO_DATA('10004312','16'),
		T_TIPO_DATA('10004312','20'),
		T_TIPO_DATA('10007550','17'),
		T_TIPO_DATA('10007348','18'),
		T_TIPO_DATA('10004312','19'),
		T_TIPO_DATA('10007348','21'),
		T_TIPO_DATA('10004312','22'),
		T_TIPO_DATA('10007348','23'),
		T_TIPO_DATA('10004312','24'),
		T_TIPO_DATA('10007348','25'),
		T_TIPO_DATA('10004312','27'),
		T_TIPO_DATA('10004312','28'),
		T_TIPO_DATA('10007348','29'),
		T_TIPO_DATA('10007550','30'),
		T_TIPO_DATA('10004312','31'),
		T_TIPO_DATA('10004312','32'),
		T_TIPO_DATA('10004312','34'),
		T_TIPO_DATA('4491','35'),
		T_TIPO_DATA('10004312','36'),
		T_TIPO_DATA('10004312','26'),
		T_TIPO_DATA('10004312','37'),
		T_TIPO_DATA('4491','38'),
		T_TIPO_DATA('10004312','40'),
		T_TIPO_DATA('10007348','41'),
		T_TIPO_DATA('10004312','42'),
		T_TIPO_DATA('10007348','43'),
		T_TIPO_DATA('10004312','44'),
		T_TIPO_DATA('10004312','45'),
		T_TIPO_DATA('10007550','46'),
		T_TIPO_DATA('10004312','47'),
		T_TIPO_DATA('10004312','49'),
		T_TIPO_DATA('10004312','50')

    );
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');

	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
	LOOP
	V_TMP_TIPO_DATA := V_TIPO_DATA(I);

		EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '|| V_ESQUEMA ||'.ACT_PVE_PROVEEDOR WHERE PVE_COD_REM = :1 AND BORRADO = 0'
		INTO V_COUNT USING V_TMP_TIPO_DATA(1);

		IF V_COUNT = 1 THEN

			DBMS_OUTPUT.PUT_LINE('[INFO]: PROVEEDOR '''||TRIM(V_TMP_TIPO_DATA(1))||''' - PROVINCIA '''||TRIM(V_TMP_TIPO_DATA(2))||'''');

			EXECUTE IMMEDIATE 'MERGE INTO '|| V_ESQUEMA ||'.CFG_PVE_PREDETERMINADO T1 USING
							(
							SELECT CPP_ID FROM '|| V_ESQUEMA ||'.CFG_PVE_PREDETERMINADO CFG
							JOIN '|| V_ESQUEMA ||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = CFG.DD_CRA_ID AND DD_CRA_CODIGO IN (:1)
							JOIN '|| V_ESQUEMA ||'.DD_TTR_TIPO_TRABAJO TTR ON TTR.DD_TTR_ID = CFG.DD_TTR_ID AND DD_TTR_CODIGO = ''03''
							JOIN '|| V_ESQUEMA ||'.ACT_PVE_PROVEEDOR PVE ON PVE.PVE_ID = CFG.PVE_ID AND PVE_COD_REM != :2
							JOIN '|| V_ESQUEMA_M ||'.DD_PRV_PROVINCIA PRV ON PRV.DD_PRV_ID = CFG.DD_PRV_ID AND DD_PRV_CODIGO = :3
							WHERE CFG.BORRADO = 0
							) T2
						ON (T1.CPP_ID = T2.CPP_ID)
						WHEN MATCHED THEN UPDATE SET
						PVE_ID = (SELECT PVE_ID FROM '|| V_ESQUEMA ||'.ACT_PVE_PROVEEDOR WHERE PVE_COD_REM = :4 AND BORRADO = 0),
						USUARIOMODIFICAR = :5,
						FECHAMODIFICAR = SYSDATE'
			USING V_CARTERAS, V_TMP_TIPO_DATA(1),V_USR, V_TMP_TIPO_DATA(1), V_TMP_TIPO_DATA(2);

			DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICADOS '||SQL%ROWCOUNT||' CONFIGURACIONES');
			DBMS_OUTPUT.PUT_LINE('[INFO]: PROVEEDOR '''||TRIM(V_TMP_TIPO_DATA(1))||''' INSERTADO EN PROVINCIA '''||TRIM(V_TMP_TIPO_DATA(2))||'''');

		ELSE

			DBMS_OUTPUT.PUT_LINE('[INFO]: PROVEEDOR '''||TRIM(V_TMP_TIPO_DATA(1))||''' NO EXISTE');

		END IF;

	END LOOP;

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[INFO]: COPIAMOS CONFIGURACION DE CAIXABANK (SUBCARTERA) PARA LIVING');

	EXECUTE IMMEDIATE 'INSERT INTO '|| V_ESQUEMA ||'.CFG_PVE_PREDETERMINADO 
						(CPP_ID,DD_CRA_ID,DD_SCR_ID,DD_TTR_ID,PVE_ID,USUARIOCREAR,FECHACREAR,DD_PRV_ID)

						SELECT '|| V_ESQUEMA ||'.S_CFG_PVE_PREDETERMINADO.NEXTVAL, CFG.DD_CRA_ID, 
						(SELECT DD_SCR_ID FROM '|| V_ESQUEMA ||'.DD_SCR_SUBCARTERA WHERE DD_SCR_CODIGO = ''161'' AND BORRADO = 0),
						(SELECT DD_TTR_ID FROM '|| V_ESQUEMA ||'.DD_TTR_TIPO_TRABAJO WHERE DD_TTR_CODIGO = ''03'' AND BORRADO = 0),
						CFG.PVE_ID,:1,SYSDATE, CFG.DD_PRV_ID
						FROM '|| V_ESQUEMA ||'.CFG_PVE_PREDETERMINADO CFG
						JOIN '|| V_ESQUEMA ||'.DD_SCR_SUBCARTERA SCR ON SCR.DD_SCR_ID = CFG.DD_SCR_ID AND DD_SCR_CODIGO = ''160''
						JOIN '|| V_ESQUEMA ||'.DD_TTR_TIPO_TRABAJO TTR ON TTR.DD_TTR_ID = CFG.DD_TTR_ID AND DD_TTR_CODIGO = ''03''
						WHERE CFG.BORRADO = 0'
	USING V_USR;

	DBMS_OUTPUT.PUT_LINE('[INFO]: INSERTADOS '||SQL%ROWCOUNT||' CONFIGURACIONES PARA LIVING');

	COMMIT;

    DBMS_OUTPUT.PUT_LINE('[FIN]');   

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;
/
EXIT;
