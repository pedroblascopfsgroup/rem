--/*
--##########################################
--## AUTOR=Carles Molins
--## FECHA_CREACION=20190510
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.5
--## INCIDENCIA_LINK=REMVIP-3912
--## PRODUCTO=NO
--##
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE

    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; -- Configuracion Esquema Master
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_ITEM VARCHAR2(30 CHAR) := 'REMVIP-3912'; -- USUARIOCREAR/USUARIOMODIFICAR.
    V_MSQL VARCHAR2(1024);
    V_COUNT NUMBER(25);
    
    V_PEF_ID NUMBER(25);
    V_USU_ID NUMBER(25);

BEGIN	

	DBMS_OUTPUT.PUT_LINE('[INICIO] INSERCION ZON_PEF_USU');
    
    V_MSQL := 'SELECT PEF_ID FROM REM01.PEF_PERFILES WHERE PEF_CODIGO = ''GESTIAFORMLBK'' ';
    EXECUTE IMMEDIATE V_MSQL INTO V_PEF_ID;
    
    V_MSQL := 'SELECT USU_ID FROM REMMASTER.USU_USUARIOS WHERE USU_USERNAME = ''pinos03'' ';
    EXECUTE IMMEDIATE V_MSQL INTO V_USU_ID;
    
    V_MSQL := 'SELECT COUNT(*) FROM ZON_PEF_USU ZPU
	JOIN REMMASTER.USU_USUARIOS USU ON USU.USU_ID = ZPU.USU_ID
	JOIN REM01.PEF_PERFILES PEF ON PEF.PEF_ID = ZPU.PEF_ID
	WHERE PEF.PEF_CODIGO = ''GESTIAFORMLBK''
	AND USU_USERNAME = ''pinos03'' ';
    EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;
    
    IF V_PEF_ID IS NOT NULL AND V_USU_ID IS NOT NULL AND V_COUNT = 0 THEN
        V_MSQL := 'INSERT INTO ZON_PEF_USU (ZON_ID, PEF_ID, USU_ID, ZPU_ID, VERSION, USUARIOCREAR, FECHACREAR, BORRADO)
                    VALUES (19504, '||V_PEF_ID||', '||V_USU_ID||', REM01.S_ZON_PEF_USU.NEXTVAL, 0, '''||V_ITEM||''', SYSDATE, 0)';
        EXECUTE IMMEDIATE V_MSQL;
    END IF;
    
    V_MSQL := 'SELECT USU_ID FROM REMMASTER.USU_USUARIOS WHERE USU_USERNAME = ''garsa03'' ';
    EXECUTE IMMEDIATE V_MSQL INTO V_USU_ID;
    
    V_MSQL := 'SELECT COUNT(*) FROM ZON_PEF_USU ZPU
	JOIN REMMASTER.USU_USUARIOS USU ON USU.USU_ID = ZPU.USU_ID
	JOIN REM01.PEF_PERFILES PEF ON PEF.PEF_ID = ZPU.PEF_ID
	WHERE PEF.PEF_CODIGO = ''GESTIAFORMLBK''
	AND USU_USERNAME = ''garsa03'' ';
    EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;
    
    IF V_PEF_ID IS NOT NULL AND V_USU_ID IS NOT NULL AND V_COUNT = 0 THEN
        V_MSQL := 'INSERT INTO ZON_PEF_USU (ZON_ID, PEF_ID, USU_ID, ZPU_ID, VERSION, USUARIOCREAR, FECHACREAR, BORRADO)
                    VALUES (19504, '||V_PEF_ID||', '||V_USU_ID||', REM01.S_ZON_PEF_USU.NEXTVAL, 0, '''||V_ITEM||''', SYSDATE, 0)';
        EXECUTE IMMEDIATE V_MSQL;
    END IF;
	
	COMMIT;
	DBMS_OUTPUT.PUT_LINE('[FIN]');
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------');
          DBMS_OUTPUT.put_line(ERR_MSG);
          DBMS_OUTPUT.put_line(V_MSQL);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
