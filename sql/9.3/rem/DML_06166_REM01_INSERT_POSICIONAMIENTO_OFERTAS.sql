--/*
--#########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20220727
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.11
--## INCIDENCIA_LINK=HREOS-18797
--## PRODUCTO=NO
--## 
--## Finalidad:
--## 
--## INSTRUCCIONES:
--## VERSIONES:
--## 		0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	TABLE_COUNT NUMBER(10,0) := 0;
	TABLE_COUNT_2 NUMBER(10,0) := 0;
	MAX_NUM_OFR NUMBER(10,0) := 0;
	V_NUM_TABLAS NUMBER(10,0) := 0;
	V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01'; --REM01
	V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER'; --REMMASTER
	V_SENTENCIA VARCHAR2(32000 CHAR);
	V_NUM_TABLAS_2 NUMBER(16);
	V_MSQL VARCHAR2(32000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.

BEGIN

	--Inicio del proceso de volcado sobre OFR_OFERTAS


V_SENTENCIA := 'TRUNCATE TABLE '||V_ESQUEMA||'.APR_AUX_HREOS_18797';

	EXECUTE IMMEDIATE V_SENTENCIA;

	DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.APR_AUX_HREOS_18797');

	
	V_SENTENCIA := 'INSERT INTO '||V_ESQUEMA||'.APR_AUX_HREOS_18797(NUM_OFERTA, TBJ_ID, ECO_ID, TPO_ID, TAREA_ANTIGUA_TRAMITE, TAREA_NUEVA_TRAMITE, USU_ID, SUP_ID, TRA_ID, TAR_ID_ANTERIOR, TEX_ID_ANTERIOR)(SELECT OFR_NUM_OFERTA,TBJ_ID, ECO_ID, (SELECT DD_TPO_CODIGO FROM '||V_ESQUEMA||'.DD_TPO_TIPO_PROCEDIMIENTO WHERE DD_TPO_CODIGO = ''T015''),TAP_CODIGO , NUEVA_TAREA, USU_ID, SUP_ID, TRA_ID, TAR_ID, TEX_ID
   FROM (SELECT DISTINCT OFR.OFR_NUM_OFERTA, ATR.TBJ_ID, ECO.ECO_ID, TAP.TAP_CODIGO, TAC.USU_ID, TAC.SUP_ID, TAR.TAR_TAREA, CASE 
   			WHEN TAP.TAP_CODIGO = ''T015_EnvioContrato'' THEN ''T015_EnvioContrato''
			WHEN TAP.TAP_CODIGO = ''T015_SancionPatrimonio'' THEN ''T015_NegociacionClausulasAlquiler'' 
			WHEN TAP.TAP_CODIGO = ''T015_AgendarFechaFirma'' THEN ''T015_AgendarFechaFirma'' 
			WHEN TAP.TAP_CODIGO = ''T015_CierreContrato'' THEN NULL 
			END AS NUEVA_TAREA, ATR.TRA_ID, TAR.TAR_ID, TEX.TEX_ID FROM '||V_ESQUEMA||'.OFR_OFERTAS OFR
                    INNER JOIN '||V_ESQUEMA||'.ACT_OFR ACO ON ACO.OFR_ID = OFR.OFR_ID
                    INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = ACO.ACT_ID
                    INNER JOIN  '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO  ON ECO.OFR_ID = OFR.OFR_ID
                    INNER JOIN '||V_ESQUEMA||'.DD_EEC_EST_EXP_COMERCIAL EEC ON EEC.DD_EEC_ID = ECO.DD_EEC_ID
                    INNER JOIN '||V_ESQUEMA||'.DD_EOF_ESTADOS_OFERTA EOF ON EOF.DD_EOF_ID = OFR.DD_EOF_ID
		    INNER JOIN '||V_ESQUEMA||'.ACT_TRA_TRAMITE ATR ON  ATR.TBJ_ID=ECO.TBJ_ID
                   INNER JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
		    INNER JOIN '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC ON ATR.TRA_ID = TAC.TRA_ID AND ATR.TBJ_ID=ECO.TBJ_ID AND TAC.BORRADO = 0
		    INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID AND TAR.TAR_TAREA_FINALIZADA = 0 AND TAR.BORRADO = 0
		    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TAR.TAR_ID = TEX.TAR_ID AND TEX.BORRADO = 0
		    INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID AND TAP.TAP_CODIGO IN(''T015_SancionPatrimonio'', ''T015_AgendarFechaFirma'', ''T015_CierreContrato'',''T015_EnvioContrato'') WHERE CRA.DD_CRA_CODIGO = ''03'' AND EOF.DD_EOF_CODIGO NOT IN (''02'', ''06'')))';
                   
        	EXECUTE IMMEDIATE V_SENTENCIA;
        	
       		V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.APR_AUX_HREOS_18797 MIG2 USING(
				SELECT NUM_OFERTA, ACT_ID FROM (SELECT MIG.NUM_OFERTA, ROW_NUMBER() OVER ( PARTITION BY MIG.NUM_OFERTA ORDER BY ACT.ACT_ID) row_num, ACT.ACT_ID FROM '||V_ESQUEMA||'.OFR_OFERTAS OFR
                		INNER JOIN '||V_ESQUEMA||'.ACT_OFR ACO ON ACO.OFR_ID = OFR.OFR_ID
                   		INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = ACO.ACT_ID
                    		INNER JOIN '||V_ESQUEMA||'.APR_AUX_HREOS_18797 MIG ON MIG.NUM_OFERTA = OFR.OFR_NUM_OFERTA) WHERE ROW_NUM = 1
                    		)
                    		AUX ON (AUX.NUM_OFERTA = MIG2.NUM_OFERTA)
                    	WHEN MATCHED THEN UPDATE SET
                    	MIG2.ACT_ID = AUX.ACT_ID';
                   
        	EXECUTE IMMEDIATE V_SENTENCIA;
        	
        	
        	       V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.APR_AUX_HREOS_18797 MIG2 USING(
				SELECT MIG.NUM_OFERTA, TAP.TAP_ID FROM 
				'||V_ESQUEMA||'.APR_AUX_HREOS_18797 MIG 
				INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_CODIGO = MIG.TAREA_NUEVA_TRAMITE)
                    		AUX ON (AUX.NUM_OFERTA = MIG2.NUM_OFERTA)
                    	WHEN MATCHED THEN UPDATE SET
                    	MIG2.TAP_ID = AUX.TAP_ID';
                   
        	EXECUTE IMMEDIATE V_SENTENCIA;

	DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'..APR_AUX_HREOS_18797 cargada. '||SQL%ROWCOUNT||' Filas.');
	
	COMMIT;

EXCEPTION
	WHEN OTHERS THEN
		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------');
		DBMS_OUTPUT.put_line(V_SENTENCIA);
		ROLLBACK;
		RAISE;
END;
/
EXIT;
