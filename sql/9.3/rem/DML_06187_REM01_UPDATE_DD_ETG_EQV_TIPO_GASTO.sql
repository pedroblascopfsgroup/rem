--/*
--#########################################
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20221123
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-12366
--## PRODUCTO=NO
--## 
--## Finalidad: Actualizacion registros 
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Versión inicial - [REMVIP-12366]- Juan Bautista Alfonso
--#########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	V_TABLA VARCHAR2(100 CHAR) := 'DD_ETG_EQV_TIPO_GASTO'; -- Tabla 
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_SQL VARCHAR2(4000 CHAR);
	PL_OUTPUT VARCHAR2(32000 CHAR);
	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-12366';
	V_NUM_REGISTROS NUMBER; -- Cuenta registros 
	V_NUM NUMBER;
	V_FLAG_VACIADO NUMBER := 0;
    TYPE T_TABLA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_TABLA IS TABLE OF T_TABLA;
	
    M_TABLA T_ARRAY_TABLA := T_ARRAY_TABLA(															
      --QUE_HACER  DD_TGA_CODIGO  DD_STG_CODIGO  GRUPO(VIEJO)  TIPO(VIEJO)  SUBTIPO(VIEJO)  GRUPO(NUEVO)  TIPO(NUEVO)  SUBTIPO(NUEVO)  EJE_ANYO  PRO_DOCIDENTIF     ELEMENTO_PEP
T_TABLA('UPDATE','15','70','3','42','4','22','00','27','2021','B46644290','OX-3148-22-2-MNT_CERR'),
T_TABLA('UPDATE','15','82','3','42','4','22','00','48','2021','B46644290','OX-3148-22-1-PUE'),
T_TABLA('UPDATE','15','73','3','42','4','22','00','13','2021','B46644290','OX-3148-22-2-LIMP'),
T_TABLA('UPDATE','15','74','3','42','4','22','00','13','2021','B46644290','OX-3148-22-2-LIMP'),
T_TABLA('UPDATE','15','76','3','42','4','22','00','13','2021','B46644290','OX-3148-22-2-LIMP'),
T_TABLA('UPDATE','15','83','3','42','4','22','00','21','2021','B46644290','OX-3148-22-2-MNT_INC'),
T_TABLA('UPDATE','15','79','3','42','4','22','00','21','2021','B46644290','OX-3148-22-2-MNT_INC'),
T_TABLA('UPDATE','15','72','3','42','4','22','00','13','2021','B46644290','OX-3148-22-2-LIMP'),
T_TABLA('UPDATE','15','77','3','42','4','22','00','21','2021','B46644290','OX-3148-22-2-MNT_INC'),
T_TABLA('UPDATE','15','71','3','42','4','22','00','21','2021','B46644290','OX-3148-22-2-MNT_INC'),
T_TABLA('UPDATE','15','78','3','42','4','22','00','21','2021','B46644290','OX-3148-22-2-MNT_INC'),
T_TABLA('UPDATE','18','99','3','42','4','22','00','21','2021','B46644290','OX-3148-22-2-MNT_INC'),
T_TABLA('UPDATE','15','75','3','42','9','22','02','22','2021','B46644290','CX-3148-22-3-I_MNT_INC'),
T_TABLA('UPDATE','15','81','3','43','1','22','00','21','2021','B46644290','OX-3148-22-2-MNT_INC'),
T_TABLA('UPDATE','15','80','3','43','1','22','00','21','2021','B46644290','OX-3148-22-2-MNT_INC'),
T_TABLA('UPDATE','11','50','3','45','3','22','00','21','2021','B46644290','OX-3148-22-2-MNT_INC')

    ); 
    V_TMP_TABLA T_TABLA;
	
BEGIN
  V_SQL := 'SELECT COUNT(1) FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = '''||V_TABLA||'''';
  EXECUTE IMMEDIATE V_SQL INTO V_NUM_REGISTROS;

    
  
  	IF V_NUM_REGISTROS > 0 THEN

	FOR I IN M_TABLA.FIRST .. M_TABLA.LAST
    LOOP
	V_TMP_TABLA := M_TABLA(I);	

			IF V_TMP_TABLA(1) = 'UPDATE' THEN

				V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' ETG
							SET ETG.COGRUG_POS = '''||V_TMP_TABLA(7)||'''
							,ETG.COTACA_POS = '''||V_TMP_TABLA(8)||'''
							,ETG.COSBAC_POS = '''||V_TMP_TABLA(9)||'''
                            ,ETG.COGRUG_NEG = '''||V_TMP_TABLA(7)||'''
							,ETG.COTACA_NEG = '''||V_TMP_TABLA(8)||'''
							,ETG.COSBAC_NEG = '''||V_TMP_TABLA(9)||'''
                            ,ETG.DD_ETG_DESCRIPCION_POS = '''||V_TMP_TABLA(12)||'''
                            ,ETG.ELEMENTO_PEP = '''||V_TMP_TABLA(12)||'''
                            ,ETG.DD_ETG_DESCRIPCION_LARGA_POS = '''||V_TMP_TABLA(12)||'''
							,ETG.USUARIOMODIFICAR = '''||V_USUARIO||'''
							,ETG.FECHAMODIFICAR = SYSDATE
							WHERE ETG.DD_TGA_ID = (SELECT DD_TGA_ID FROM '||V_ESQUEMA||'.DD_TGA_TIPOS_GASTO WHERE DD_TGA_CODIGO = '''||V_TMP_TABLA(2)||''' AND BORRADO = 0)
							AND ETG.DD_STG_ID = (SELECT DD_STG_ID FROM '||V_ESQUEMA||'.DD_STG_SUBTIPOS_GASTO WHERE DD_STG_CODIGO = '''||V_TMP_TABLA(3)||''' AND BORRADO = 0)
							AND ETG.COGRUG_POS = '''||V_TMP_TABLA(4)||'''
							AND ETG.COTACA_POS = '''||V_TMP_TABLA(5)||'''
							AND ETG.COSBAC_POS = '''||V_TMP_TABLA(6)||'''
							AND ETG.EJE_ID = (SELECT EJE_ID FROM '||V_ESQUEMA||'.ACT_EJE_EJERCICIO WHERE EJE_ANYO='''||V_TMP_TABLA(10)||''' AND BORRADO = 0)
							AND ETG.PRO_ID = (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_DOCIDENTIF='''||V_TMP_TABLA(11)||''' AND BORRADO = 0)
						';
				EXECUTE IMMEDIATE V_SQL;	
				
				DBMS_OUTPUT.PUT_LINE('[INFO] Se han modificado en la tabla '||V_ESQUEMA||'.'||V_TABLA||' (' || sql%rowcount || ') registros');

			END IF;
  	
    END LOOP;	

	END IF;

	PL_OUTPUT := PL_OUTPUT || '[FIN]'||CHR(10);
	DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
	commit;


EXCEPTION
    WHEN OTHERS THEN
      PL_OUTPUT := PL_OUTPUT ||'[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE)||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||'-----------------------------------------------------------'||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||SQLERRM||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||V_SQL||CHR(10);
      DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
      ROLLBACK;
      RAISE;
END;
/
EXIT;