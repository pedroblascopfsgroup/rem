--/*
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20210727
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.3
--## INCIDENCIA_LINK=HREOS-14680
--## PRODUCTO=NO
--## 
--## Finalidad:
--## 
--## INSTRUCCIONES:
--## VERSIONES:
--## 		0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	TABLE_COUNT NUMBER(10,0) := 0;
	TABLE_COUNT_2 NUMBER(10,0) := 0;
	MAX_NUM_OFR NUMBER(10,0) := 0;
	V_NUM_TABLAS NUMBER(10,0) := 0;
	V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01'; --REM01
	V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER'; --REMMASTER
	V_USUARIO VARCHAR2(50 CHAR) := 'MIG_CAIXA';
	V_TABLA VARCHAR2(40 CHAR) := 'OFR_OFERTAS';
	V_TABLA_MIG VARCHAR2(40 CHAR) := 'MIG2_OFR_OFERTAS_CAIXA';
	V_SENTENCIA VARCHAR2(32000 CHAR);
	V_REG_MIG NUMBER(10,0) := 0;
	V_REG_INSERTADOS NUMBER(10,0) := 0;
	V_DUPLICADOS NUMBER(10,0) := 0;
	V_REJECTS NUMBER(10,0) := 0;
	V_COD NUMBER(10,0) := 0;
	V_OBSERVACIONES VARCHAR2(3000 CHAR) := '';
	V_OFR_ID NUMBER(16,0);    -- Varaible que almacenara las OFR_ID de aquellas ofertas aceptadas
	V_TABLE_ECO NUMBER(16,0); -- Variable que almacenara los Expedientes Comerciales creados
	V_TABLE_DD_EOF NUMBER(16,0); -- Variable que almacenara los ESTADOS_OFERTAS modificados
	V_TABLE_ECO_MER NUMBER(16,0); -- Variable que almacenara los Expedientes Comerciales mergeados
	V_NUM_TABLAS_2 NUMBER(16);
	V_MSQL VARCHAR2(32000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.

BEGIN

	--Inicio del proceso de volcado sobre OFR_OFERTAS

V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA_MIG||'';

EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS_2;

IF V_NUM_TABLAS_2 = 0 THEN
DBMS_OUTPUT.PUT_LINE('La tabla/s de migración implicada está vacía. No se realiza ninguna acción');

ELSE
	DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');

	V_SENTENCIA := 'INSERT INTO '||V_ESQUEMA||'.OFR_OFERTAS (OFR_ID	,
		OFR_NUM_OFERTA	,
		OFR_WEBCOM_ID	,
		AGR_ID	,
		OFR_IMPORTE	,
		CLC_ID	,
		DD_EOF_ID	,
		DD_TOF_ID	,
		VIS_ID	,
		DD_EVO_ID	,
		OFR_FECHA_ACCION	,
		OFR_FECHA_ALTA	,
		OFR_FECHA_NOTIFICACION	,
		OFR_IMPORTE_CONTRAOFERTA	,
		OFR_FECHA_CONTRAOFERTA	,
		USU_ID	,
		PVE_ID_PRESCRIPTOR	,
		PVE_ID_API_RESPONSABLE	,
		PVE_ID_CUSTODIO	,
		PVE_ID_FDV	,
		VERSION	,
		USUARIOCREAR	,
		FECHACREAR	,
		USUARIOMODIFICAR	,
		FECHAMODIFICAR	,
		USUARIOBORRAR	,
		FECHABORRAR	,
		BORRADO	,
		OFR_IND_LOTE_RESTRINGIDO	,
		OFR_IMPORTE_APROBADO	,
		OFR_DESDE_TANTEO	,
		OFR_INTENCION_FINANCIAR	,
		DD_CAP_ID	,
		OFR_CONDICIONES_TX	,
		OFR_FECHA_COMUNIC_REG	,
		OFR_FECHA_CONTESTACION	,
		OFR_FECHA_HASTA_TANTEO	,
		DD_DRT_ID	,
		OFR_FECHA_MAX_FORMALIZACION	,
		OFR_FECHA_SOLICITUD_VISITA	,
		OFR_FECHA_REALIZACION_VISITA	,
		OFR_FECHA_RECHAZO	,
		PVE_ID_SUCURSAL	,
		DD_MRO_ID	,
		OFR_USUARIO_BAJA	,
		OFR_ORIGEN	,
		OFR_OFERTA_EXPRESS	,
		OFR_NECESITA_FINANCIACION	,
		OFR_OBSERVACIONES	,
		OFR_UVEM_ID	,
		OFR_VENTA_DIRECTA	,
		DD_TAL_ID	,
		DD_TPI_ID	,
		OFR_CONTRATO_PRINEX	,
		OFR_REF_CIRCUITO_CLIENTE	,
		OFR_FECHA_RESPUESTA	,
		OFR_FECHA_APROBACION_PRO_MANZANA	,
		OFR_FECHA_RESPUESTA_OFERTANTE_CES	,
		OFR_FECHA_RESPUESTA_OFERTANTE_PM	,
		OFR_IMP_CONTRAOFERTA_PM	,
		OFR_FECHA_RESPUESTA_PM	,
		OFR_IMP_CONTRAOFERTA_CES	,
		OFR_FECHA_RESOLUCION_CES	,
		DD_ORC_ID	,
		DD_CLO_ID	,
		OFR_GES_COM_PRES	,
		OFR_CONTRAOFERTA_OFERTANTE_CES	,
		OFR_OFERTA_SINGULAR	,
		OFR_ID_PRES_ORI_LEAD	,
		OFR_FECHA_ORI_LEAD	,
		OFR_COD_TIPO_PROV_ORI_LEAD	,
		OFR_ID_REALIZA_ORI_LEAD	,
		OFR_COD_DIVARIAN	,
		ID_OFERTA_ORIGEN	,
		OFR_RECOMENDACION_RC	,
		OFR_FECHA_RECOMENDACION_RC	,
		OFR_RECOMENDACION_DC	,
		OFR_FECHA_RECOMENDACION_DC	,
		OFR_DOC_RESP_PRESCRIPTOR	,
		OFR_VENTA_CARTERA	,
		OFR_OFERTA_ESPECIAL	,
		OFR_VENTA_SOBRE_PLANO	,
		DD_ROP_ID	,
		FECHA_ENT_CRM_SF	,
		DD_RIO_ID	,
		OFR_SOSPECHOSA	,
		DD_RDC_ID	
		)
		SELECT MIG2.OFR_ID,
		OFR_NUM_OFERTA,
		OFR_WEBCOM_ID,
		AGR_ID,
		OFR_IMPORTE,
		CLC_ID,
		DD_EOF_ID,
		DD_TOF_ID,
		VIS_ID,
		DD_EVO_ID,
		OFR_FECHA_ACCION,
		OFR_FECHA_ALTA,
		OFR_FECHA_NOTIFICACION,
		OFR_IMPORTE_CONTRAOFERTA,
		OFR_FECHA_CONTRAOFERTA,
		USU_ID,
		PVE_ID_PRESCRIPTOR,
		PVE_ID_API_RESPONSABLE,
		PVE_ID_CUSTODIO,
		PVE_ID_FDV,
		VERSION,
		''MIG_CAIXA'',
		SYSDATE,
		NULL,
		NULL,
		USUARIOBORRAR,
		FECHABORRAR,
		BORRADO,
		OFR_IND_LOTE_RESTRINGIDO,
		OFR_IMPORTE_APROBADO,
		OFR_DESDE_TANTEO,
		OFR_INTENCION_FINANCIAR,
		DD_CAP_ID,
		OFR_CONDICIONES_TX,
		OFR_FECHA_COMUNIC_REG,
		OFR_FECHA_CONTESTACION,
		OFR_FECHA_HASTA_TANTEO,
		DD_DRT_ID,
		OFR_FECHA_MAX_FORMALIZACION,
		OFR_FECHA_SOLICITUD_VISITA,
		OFR_FECHA_REALIZACION_VISITA,
		OFR_FECHA_RECHAZO,
		PVE_ID_SUCURSAL,
		DD_MRO_ID,
		OFR_USUARIO_BAJA,
		OFR_ORIGEN,
		OFR_OFERTA_EXPRESS,
		OFR_NECESITA_FINANCIACION,
		OFR_OBSERVACIONES,
		OFR_UVEM_ID,
		OFR_VENTA_DIRECTA,
		DD_TAL_ID,
		DD_TPI_ID,
		OFR_CONTRATO_PRINEX,
		OFR_REF_CIRCUITO_CLIENTE,
		OFR_FECHA_RESPUESTA,
		OFR_FECHA_APROBACION_PRO_MANZANA,
		OFR_FECHA_RESPUESTA_OFERTANTE_CES,
		OFR_FECHA_RESPUESTA_OFERTANTE_PM,
		OFR_IMP_CONTRAOFERTA_PM,
		OFR_FECHA_RESPUESTA_PM,
		OFR_IMP_CONTRAOFERTA_CES,
		OFR_FECHA_RESOLUCION_CES,
		DD_ORC_ID,
		DD_CLO_ID,
		OFR_GES_COM_PRES,
		OFR_CONTRAOFERTA_OFERTANTE_CES,
		OFR_OFERTA_SINGULAR,
		OFR_ID_PRES_ORI_LEAD,
		OFR_FECHA_ORI_LEAD,
		OFR_COD_TIPO_PROV_ORI_LEAD,
		OFR_ID_REALIZA_ORI_LEAD,
		OFR_COD_DIVARIAN,
		ID_OFERTA_ORIGEN,
		OFR_RECOMENDACION_RC,
		OFR_FECHA_RECOMENDACION_RC,
		OFR_RECOMENDACION_DC,
		OFR_FECHA_RECOMENDACION_DC,
		OFR_DOC_RESP_PRESCRIPTOR,
		OFR_VENTA_CARTERA,
		OFR_OFERTA_ESPECIAL,
		OFR_VENTA_SOBRE_PLANO,
		DD_ROP_ID,
		FECHA_ENT_CRM_SF,
		DD_RIO_ID,
		OFR_SOSPECHOSA,
		DD_RDC_ID	
		FROM '||V_ESQUEMA||'.MIG2_OFR_OFERTAS_CAIXA MIG1
		JOIN '||V_ESQUEMA||'.MIG2_OFR_MAPEO_NUM_OFERTAS MIG2 ON MIG2.COD_OFERTA_CAIXA = MIG1.OFR_NUM_OFERTA
';
END IF;

	EXECUTE IMMEDIATE V_SENTENCIA;

	DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' cargada. '||SQL%ROWCOUNT||' Filas.');

	COMMIT; 

	V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''STATS'','''||V_TABLA||''',''1''); END;';
	EXECUTE IMMEDIATE V_SENTENCIA;


EXCEPTION
	WHEN OTHERS THEN
		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------');
		DBMS_OUTPUT.put_line(SQLERRM);
		ROLLBACK;
		RAISE;
END;
/
EXIT;
