--/*
--#########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20210727
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.11
--## INCIDENCIA_LINK=HREOS-14680
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##                    
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--##        0.2 HREOS-8293 IKER ADOT Rehabilitar/Añadir campos migracion divarian
--## 		0.3 HREOS-8669 Eliminación de alquileres
--## 		0.4 HREOS-10749 Se añade comprobación de registros en MIG
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
V_USUARIO VARCHAR2(50 CHAR) := 'MIG_CAIXA';
V_TABLA VARCHAR2(40 CHAR) := 'COE_CONDICIONANTES_EXPEDIENTE';
V_TABLA_MIG VARCHAR2(40 CHAR) := 'MIG2_COE_CONDICIONAN_OFR_ACEP_CAIXA';
V_SENTENCIA VARCHAR2(2000 CHAR);
V_NUM_TABLAS NUMBER(16);
V_MSQL VARCHAR2(32000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.

BEGIN 
 
	--Inicio del proceso de volcado sobre COE_CONDICIONANTES_EXPEDIENTE

V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA_MIG||'';

EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;

IF V_NUM_TABLAS = 0 THEN
DBMS_OUTPUT.PUT_LINE('La tabla/s de migración implicada está vacía. No se realiza ninguna acción');

ELSE

	DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');
 
	EXECUTE IMMEDIATE '
		INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (
			COE_ID,
			ECO_ID,
			COE_SOLICITA_FINANCIACION,
			COE_ENTIDAD_FINANCIACION_AJENA,
			DD_TCC_ID,
			COE_PORCENTAJE_RESERVA,
			COE_PLAZO_FIRMA_RESERVA,
			COE_IMPORTE_RESERVA,
			DD_TIT_ID,
			COE_TIPO_APLICABLE,
			COE_RENUNCIA_EXENCION,
			COE_RESERVA_CON_IMPUESTO,
			COE_GASTOS_PLUSVALIA,
			DD_TPC_ID_PLUSVALIA,
			COE_GASTOS_NOTARIA,
			DD_TPC_ID_NOTARIA,
			COE_GASTOS_OTROS,
			DD_TPC_ID_GASTOS_OTROS,
			COE_FECHA_ACTUALIZACION_CARGAS,
			COE_CARGAS_IMPUESTOS,
			DD_TPC_ID_IMPUESTOS,
			COE_CARGAS_COMUNIDAD,
			DD_TPC_ID_COMUNIDAD,
			COE_CARGAS_OTROS,
			DD_TPC_ID_CARGAS_OTROS,
			COE_SUJETO_TANTEO_RETRACTO,
			COE_RENUNCIA_SNMTO_EVICCION,
			COE_RENUNCIA_SNMTO_VICIOS,
			COE_VPO,
			COE_LICENCIA,
			DD_TPC_ID_LICENCIA,
			COE_PROCEDE_DESCALIFICACION,
			DD_SIP_ID,
			DD_ETI_ID,
			COE_POSESION_INICIAL,
			COE_INICIO_EXPEDIENTE,
			COE_INICIO_FINANCIACION,
			COE_FIN_FINANCIACION,
			DD_ESF_ID,
			DD_TPC_ID_DESCALIFICACION,
			COE_ESTADO_TRAMITE,
			COE_GASTOS_IBI,
			COE_GASTOS_COMUNIDAD,
			COE_GASTOS_SUMINISTROS,
			DD_TPC_ID_IBI,
			DD_TPC_ID_COMUNIDAD_ALQUILER,
			DD_TPC_ID_SUMINISTROS,
			COE_SOLICITA_RESERVA,
			COE_OPERACION_EXENTA,
			COE_INVERSION_SUJETO_PASIVO,
			--HREOS-8669 ALQ_FIANZA_MESES, 				-- No migramos alquileres
			--HREOS-8669 ALQ_FIANZA_IMPORTE, 
			--HREOS-8669 ALQ_FIANZA_ACTUALIZABLE,
			--HREOS-8669 ALQ_DEPOSITO_MESES,
			--HREOS-8669 ALQ_DEPOSITO_IMPORTE,
			--HREOS-8669 ALQ_DEPOSITO_ACTUALIZABLE,
			--HREOS-8669 ALQ_AVALISTA,
			--HREOS-8669 ALQ_FIADOR_DOCUMENTO,
			--HREOS-8669 ALQ_FIADOR_ENTIDAD_BANCARIA,
			--HREOS-8669 ALQ_IMPORTE_AVAL,
			--HREOS-8669 ALQ_RENUNCIA_TANTEO,
			--HREOS-8669 ALQ_CARENCIA,
			--HREOS-8669 ALQ_BONIFICACION,
			--HREOS-8669 ALQ_GASTOS_REPERCUTIBLES,
			--HREOS-8669 ALQ_NUMERO_AVAL,
			--HREOS-8669 ALQ_RENTA_FIJO,
			--HREOS-8669 ALQ_RENTA_PORCENTUAL,
			--HREOS-8669 ALQ_RENTA_IPC,
			--HREOS-8669 ALQ_RENTA_PORC_IMPUESTOS,
			--HREOS-8669 ALQ_RENTA_REVISION_MERCADO,
			--HREOS-8669 ALQ_RENTA_MERCADO_FECHA,
			--HREOS-8669 ALQ_RENTA_MERCADO_CADA,
			--HREOS-8669 ALQ_FECHA_FIJO,
			--HREOS-8669 ALQ_FECHA_INC_RENTA,
			--HREOS-8669 ALQ_CARENCIA_MESES,
			--HREOS-8669 ALQ_CARENCIA_IMPORTE,
			--HREOS-8669 ALQ_BONIFICACION_MESES,
			--HREOS-8669 ALQ_BONIFICACION_IMPORTE,
			--HREOS-8669 ALQ_BONIFICACION_DURACION,
			--HREOS-8669 ALQ_REPERCUTIBLES_COMMENTS,
			--HREOS-8669 ALQ_ENTIDAD_COMMENTS,
			--HREOS-8669 ALQ_FECHA_FIRMA,
			COE_DEPOSITO_RESERVA,
			DD_ETF_ID,
			VERSION,
			USUARIOCREAR,
			FECHACREAR,
			BORRADO
		)
		SELECT 
			'||V_ESQUEMA||'.S_COE_CONDICIONANTES_EXP.NEXTVAL	COE_ID,
			ECO.ECO_ID											ECO_ID,
			MIG.COE_SOLICITA_FINANCIACION						COE_SOLICITA_FINANCIACION,
			MIG.COE_ENTIDAD_FINANCIACION_AJENA					COE_ENTIDAD_FINANCIACION_AJENA,
			TCC.DD_TCC_ID										DD_TCC_ID,
			MIG.COE_PORCENTAJE_RESERVA							COE_PORCENTAJE_RESERVA,
			MIG.COE_PLAZO_FIRMA_RESERVA							COE_PLAZO_FIRMA_RESERVA,
			MIG.COE_IMPORTE_RESERVA								COE_IMPORTE_RESERVA,
			TIT.DD_TIT_ID										DD_TIT_ID,
			MIG.COE_TIPO_APLICABLE								COE_TIPO_APLICABLE,
			MIG.COE_IND_RENUNCIA_EXENCION						COE_RENUNCIA_EXENCION,
			MIG.COE_IND_RESERVA_CON_IMPUESTO					COE_RESERVA_CON_IMPUESTO,
			MIG.COE_GASTOS_PLUSVALIA							COE_GASTOS_PLUSVALIA,
			TPC_PLUSVALIA.DD_TPC_ID								DD_TPC_ID_PLUSVALIA,
			MIG.COE_GASTOS_NOTARIA								COE_GASTOS_NOTARIA,
			TPC_NOTARIA.DD_TPC_ID								DD_TPC_ID_NOTARIA,
			MIG.COE_GASTOS_OTROS								COE_GASTOS_OTROS,
			TPC_OTROS.DD_TPC_ID									DD_TPC_ID_GASTOS_OTROS,
			MIG.COE_FECHA_ACTUALIZACION_CARGAS					COE_FECHA_ACTUALIZACION_CARGAS,
			MIG.COE_CARGAS_IMPUESTOS							COE_CARGAS_IMPUESTOS,
			TPC_IMPUESTOS.DD_TPC_ID								DD_TPC_ID_IMPUESTOS,
			MIG.COE_CARGAS_COMUNIDAD							COE_CARGAS_COMUNIDAD,
			TPC_COMUNIDAD.DD_TPC_ID								DD_TPC_ID_COMUNIDAD,
			MIG.COE_COE_CARGAS_OTROS							COE_GASTOS_OTROS,
			TPC_GST_OTROS.DD_TPC_ID								DD_TPC_ID_CARGAS_OTROS,
			MIG.COE_IND_SUJETO_TANTEO_RETRACTO					COE_SUJETO_TANTEO_RETRACTO,
			MIG.COE_IND_RENUNCIA_SNMTO_EVICCI					COE_RENUNCIA_SNMTO_EVICCION,
			MIG.COE_IND_RENUNCIA_SNMTO_VICIO					COE_RENUNCIA_SNMTO_VICIOS,
			MIG.COE_IND_VPO										COE_VPO,
			MIG.COE_IND_LICENCIA								COE_LICENCIA,
			TPC_LICENCIA.DD_TPC_ID								DD_TPC_ID_LICENCIA,
			MIG.COE_IND_PROCEDE_DESCALIFICA						COE_PROCEDE_DESCALIFICACION,
			SIP.DD_SIP_ID										DD_SIP_ID,
			ETI.DD_ETI_ID										DD_ETI_ID,
			MIG.COE_IND_POSESION_INICIAL						COE_POSESION_INICIAL,
			MIG.COE_INICIO_EXPEDIENTE							COE_INICIO_EXPEDIENTE,
			MIG.COE_INICIO_FINANCIACION							COE_INICIO_FINANCIACION,
			MIG.COE_FIN_FINANCIACION							COE_FIN_FINANCIACION,
			MIG.DD_ESF_ID										DD_ESF_ID,
			MIG.DD_TPC_ID_DESCALIFICACION						DD_TPC_ID_DESCALIFICACION,
			MIG.COE_ESTADO_TRAMITE								COE_ESTADO_TRAMITE,
			MIG.COE_GASTOS_IBI									COE_GASTOS_IBI,
			MIG.COE_GASTOS_COMUNIDAD							COE_GASTOS_COMUNIDAD,
			MIG.COE_GASTOS_SUMINISTROS							COE_GASTOS_SUMINISTROS,
			MIG.DD_TPC_ID_IBI									DD_TPC_ID_IBI,
			MIG.DD_TPC_ID_COMUNIDAD_ALQUILER					DD_TPC_ID_COMUNIDAD_ALQUILER,
			MIG.DD_TPC_ID_SUMINISTROS							DD_TPC_ID_SUMINISTROS,
			MIG.COE_SOLICITA_RESERVA							COE_SOLICITA_RESERVA,
			MIG.COE_OPERACION_EXENTA							COE_OPERACION_EXENTA,
			MIG.COE_INVERSION_SUJETO_PASIVO						COE_INVERSION_SUJETO_PASIVO,
			--HREOS-8669 MIG.ALQ_FIANZA_MESES								ALQ_FIANZA_MESES, 					-- No migramos alquileres
			--HREOS-8669 MIG.ALQ_FIANZA_IMPORTE								ALQ_FIANZA_IMPORTE,
			--HREOS-8669 MIG.ALQ_FIANZA_ACTUALIZABLE							ALQ_FIANZA_ACTUALIZABLE,
			--HREOS-8669 MIG.ALQ_DEPOSITO_MESES								ALQ_DEPOSITO_MESES,
			--HREOS-8669 MIG.ALQ_DEPOSITO_IMPORTE							ALQ_DEPOSITO_IMPORTE,
			--HREOS-8669 MIG.ALQ_DEPOSITO_ACTUALIZABLE						ALQ_DEPOSITO_ACTUALIZABLE,
			--HREOS-8669 MIG.ALQ_AVALISTA									ALQ_AVALISTA,
			--HREOS-8669 MIG.ALQ_FIADOR_DOCUMENTO							ALQ_FIADOR_DOCUMENTO,
			--HREOS-8669 MIG.ALQ_FIADOR_ENTIDAD_BANCARIA						ALQ_FIADOR_ENTIDAD_BANCARIA,
			--HREOS-8669 MIG.ALQ_IMPORTE_AVAL								ALQ_IMPORTE_AVAL,
			--HREOS-8669 MIG.ALQ_RENUNCIA_TANTEO								ALQ_RENUNCIA_TANTEO,
			--HREOS-8669 MIG.ALQ_CARENCIA									ALQ_CARENCIA,
			--HREOS-8669 MIG.ALQ_BONIFICACION								ALQ_BONIFICACION,
			--HREOS-8669 MIG.ALQ_GASTOS_REPERCUTIBLES						ALQ_GASTOS_REPERCUTIBLES,
			--HREOS-8669 MIG.ALQ_NUMERO_AVAL									ALQ_NUMERO_AVAL,
			--HREOS-8669 MIG.ALQ_RENTA_FIJO									ALQ_RENTA_FIJO,
			--HREOS-8669 MIG.ALQ_RENTA_PORCENTUAL							ALQ_RENTA_PORCENTUAL,
			--HREOS-8669 MIG.ALQ_RENTA_IPC									ALQ_RENTA_IPC,
			--HREOS-8669 MIG.ALQ_RENTA_PORC_IMPUESTOS						ALQ_RENTA_PORC_IMPUESTOS,
			--HREOS-8669 MIG.ALQ_RENTA_REVISION_MERCADO						ALQ_RENTA_REVISION_MERCADO,
			--HREOS-8669 MIG.ALQ_RENTA_MERCADO_FECHA							ALQ_RENTA_MERCADO_FECHA,
			--HREOS-8669 MIG.ALQ_RENTA_MERCADO_CADA							ALQ_RENTA_MERCADO_CADA,
			--HREOS-8669 MIG.ALQ_FECHA_FIJO									ALQ_FECHA_FIJO,
			--HREOS-8669 MIG.ALQ_FECHA_INC_RENTA								ALQ_FECHA_INC_RENTA,
			--HREOS-8669 MIG.ALQ_CARENCIA_MESES								ALQ_CARENCIA_MESES,
			--HREOS-8669 MIG.ALQ_CARENCIA_IMPORTE							ALQ_CARENCIA_IMPORTE,
			--HREOS-8669 MIG.ALQ_BONIFICACION_MESES							ALQ_BONIFICACION_MESES,
			--HREOS-8669 MIG.ALQ_BONIFICACION_IMPORTE						ALQ_BONIFICACION_IMPORTE,
			--HREOS-8669 MIG.ALQ_BONIFICACION_DURACION						ALQ_BONIFICACION_DURACION,
			--HREOS-8669 MIG.ALQ_REPERCUTIBLES_COMMENTS						ALQ_REPERCUTIBLES_COMMENTS,
			--HREOS-8669 MIG.ALQ_ENTIDAD_COMMENTS							ALQ_ENTIDAD_COMMENTS,
			--HREOS-8669 MIG.ALQ_FECHA_FIRMA									ALQ_FECHA_FIRMA,
			MIG.COE_DEPOSITO_RESERVA							COE_DEPOSITO_RESERVA,
			ETF.DD_ETF_ID										DD_ETF_ID,
			''0''												VERSION,
			'''||V_USUARIO||'''									USUARIOCREAR,
			SYSDATE												FECHACREAR,
			0													BORRADO
		FROM '||V_ESQUEMA||'.'||V_TABLA_MIG||' MIG
		INNER JOIN '||V_ESQUEMA||'.OFR_OFERTAS 					OFR 		ON OFR.OFR_NUM_OFERTA = MIG.COE_COD_OFERTA
		INNER JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL 	ECO 		ON ECO.OFR_ID = OFR.OFR_ID 
		LEFT JOIN '||V_ESQUEMA||'.DD_TCC_TIPO_CALCULO 			TCC 		ON TCC.DD_TCC_CODIGO = MIG.COE_COD_TIPO_CALCULO
		LEFT JOIN '||V_ESQUEMA||'.DD_TIT_TIPOS_IMPUESTO 		TIT 		ON TIT.DD_TIT_CODIGO = MIG.COE_COD_TIPO_IMPUESTO
		LEFT JOIN '||V_ESQUEMA||'.DD_TPC_TIPOS_PORCUENTA 	TPC_PLUSVALIA 	ON TPC_PLUSVALIA.DD_TPC_CODIGO = MIG.COE_COD_TIPO_PORCTA_PLUSVALIA
		LEFT JOIN '||V_ESQUEMA||'.DD_TPC_TIPOS_PORCUENTA 	TPC_NOTARIA 	ON TPC_NOTARIA.DD_TPC_CODIGO = MIG.COE_COD_TIPO_PORCTA_NOTARIA
		LEFT JOIN '||V_ESQUEMA||'.DD_TPC_TIPOS_PORCUENTA 	TPC_OTROS 		ON TPC_OTROS.DD_TPC_CODIGO = MIG.COE_COD_TIPO_PORCTA_OTROS
		LEFT JOIN '||V_ESQUEMA||'.DD_TPC_TIPOS_PORCUENTA 	TPC_IMPUESTOS 	ON TPC_IMPUESTOS.DD_TPC_CODIGO = MIG.COE_COD_TIPO_CARGAS_IMPUESTOS
		LEFT JOIN '||V_ESQUEMA||'.DD_TPC_TIPOS_PORCUENTA 	TPC_COMUNIDAD 	ON TPC_COMUNIDAD.DD_TPC_CODIGO = MIG.COE_COD_TIPO_CARGAS_COMUNIDAD
		LEFT JOIN '||V_ESQUEMA||'.DD_TPC_TIPOS_PORCUENTA 	TPC_GST_OTROS 	ON TPC_GST_OTROS.DD_TPC_CODIGO = MIG.COE_COD_TIPO_CARGAS_OTROS
		LEFT JOIN '||V_ESQUEMA||'.DD_TPC_TIPOS_PORCUENTA 	TPC_LICENCIA 	ON TPC_LICENCIA.DD_TPC_CODIGO = MIG.COE_COD_TIPO_LICENCIA
		LEFT JOIN '||V_ESQUEMA||'.DD_SIP_SITUACION_POSESORIA 	SIP 		ON SIP.DD_SIP_CODIGO = MIG.COE_COD_SITUACION_POSESORIA
		LEFT JOIN '||V_ESQUEMA||'.DD_ETI_ESTADO_TITULO 			ETI 		ON ETI.DD_ETI_CODIGO = MIG.COE_COD_ESTADO_TITULO
		LEFT JOIN '||V_ESQUEMA||'.DD_ETF_ENTIDAD_FINANCIERA 	ETF 		ON ETF.DD_ETF_CODIGO = MIG.COE_ENTIDAD_FINANCIACION_AJENA
		WHERE MIG.VALIDACION = 0 
		AND NOT EXISTS (
			SELECT 1 FROM '||V_ESQUEMA||'.'||V_TABLA||' COE
			WHERE COE.ECO_ID = ECO.ECO_ID
		)
	';
  
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' '||V_ESQUEMA||'.'||V_TABLA||' cargada. '||SQL%ROWCOUNT||' Filas.');
  
  COMMIT;
  
  V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA||''',''10''); END;';
  EXECUTE IMMEDIATE (V_SENTENCIA);
  DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' ANALIZADA.');
END IF;                          
EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT;
