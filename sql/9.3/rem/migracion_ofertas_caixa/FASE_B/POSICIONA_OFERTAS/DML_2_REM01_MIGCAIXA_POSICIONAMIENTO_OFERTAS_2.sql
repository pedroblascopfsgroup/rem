--/*
--#########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20210727
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.11
--## INCIDENCIA_LINK=HREOS-14680
--## PRODUCTO=NO
--## 
--## Finalidad:
--## 
--## INSTRUCCIONES:
--## VERSIONES:
--## 		0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	TABLE_COUNT NUMBER(10,0) := 0;
	TABLE_COUNT_2 NUMBER(10,0) := 0;
	MAX_NUM_OFR NUMBER(10,0) := 0;
	V_NUM_TABLAS NUMBER(10,0) := 0;
	V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01'; --REM01
	V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER'; --REMMASTER
	V_USUARIO VARCHAR2(50 CHAR) := 'MIG_CAIXA';
	V_SENTENCIA VARCHAR2(32000 CHAR);
	V_NUM_TABLAS_2 NUMBER(16);
	V_MSQL VARCHAR2(32000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.

BEGIN

	--Inicio del proceso de volcado sobre OFR_OFERTAS
	DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.MIG2_OFR_MAPEO_NUM_OFERTAS');
	
	
	V_SENTENCIA := 'INSERT INTO '||V_ESQUEMA||'.MIG2_AUX_OFERTAS_DUPLICADAS MIG (NUM_OFERTA)
			SELECT NUM_OFERTA FROM (
           		SELECT NUM_OFERTA, COUNT(*) 
			FROM '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA
			 GROUP BY NUM_OFERTA HAVING COUNT(*) > 1)';
	
	        	EXECUTE IMMEDIATE V_SENTENCIA;
	        	
		V_SENTENCIA := 'DELETE FROM '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA WHERE NUM_OFERTA IN(
			SELECT NUM_OFERTA FROM '||V_ESQUEMA||'.MIG2_AUX_OFERTAS_DUPLICADAS)';
	
	        	EXECUTE IMMEDIATE V_SENTENCIA;
	
	V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA MIG USING(
			SELECT DISTINCT CASE 
			WHEN TAREA_ANTIGUA_TRAMITE = ''Definición oferta'' THEN ''T017_DefinicionOferta'' 
			WHEN TAREA_ANTIGUA_TRAMITE = ''Resolución comité'' THEN ''T017_ResolucionCES''
			/*WHEN TAREA_ANTIGUA_TRAMITE = ''Cierre económico'' THEN ''T017_CierreEconomico''*/
			WHEN TAREA_ANTIGUA_TRAMITE = ''Resultado PBC'' THEN ''T017_PBCVenta'' 
			WHEN TAREA_ANTIGUA_TRAMITE = ''Instrucciones reserva'' AND NUEVO_ESTADO_ECO = ''49'' THEN ''T017_PBCReserva'' 
			WHEN TAREA_ANTIGUA_TRAMITE = ''Obtención contrato reserva'' THEN ''T017_ObtencionContratoReserva'' 
			END AS TAREA_NUEVA_TRAMITE  , 
			NUM_OFERTA  
			FROM '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA
			) AUX ON (AUX.NUM_OFERTA = MIG.NUM_OFERTA) 
			WHEN MATCHED THEN UPDATE SET
			MIG.TAREA_NUEVA_TRAMITE = AUX.TAREA_NUEVA_TRAMITE';
                   
        	EXECUTE IMMEDIATE V_SENTENCIA;
        	

	V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA MIG USING(
		SELECT DISTINCT CASE WHEN
			POS.POS_FECHA_POSICIONAMIENTO IS NULL THEN ''T017_AgendarPosicionamiento''
            WHEN
            POS.POS_FECHA_POSICIONAMIENTO IS NOT NULL THEN ''T017_ConfirmarFechaEscritura''
			END AS TAREA_NUEVA_TRAMITE, 
			NUM_OFERTA  
			FROM '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA MIG
		    JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_NUM_OFERTA = MIG.NUM_OFERTA
		    JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
		    JOIN '||V_ESQUEMA||'.POS_POSICIONAMIENTO POS ON POS.ECO_ID = ECO.ECO_ID
		    WHERE MIG.TAREA_ANTIGUA_TRAMITE = ''Posicionamiento y firma''
            ) AUX ON (AUX.NUM_OFERTA = MIG.NUM_OFERTA) 
			WHEN MATCHED THEN UPDATE SET
			MIG.TAREA_NUEVA_TRAMITE = AUX.TAREA_NUEVA_TRAMITE';
                   
        	EXECUTE IMMEDIATE V_SENTENCIA;
        	
        	
	V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA MIG USING(
		SELECT DISTINCT CASE WHEN
			RES.RES_ID IS NULL THEN ''T017_PBCVenta''
           		WHEN
            		RES.RES_ID IS NOT NULL THEN ''T017_PBCReserva''
			END AS TAREA_NUEVA_TRAMITE, 
			NUM_OFERTA  
			FROM '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA MIG
		    JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_NUM_OFERTA = MIG.NUM_OFERTA
		    JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
		    JOIN '||V_ESQUEMA||'.OFR_OFERTAS_CAIXA CAI ON CAI.OFR_ID = OFR.OFR_ID
            LEFT JOIN '||V_ESQUEMA||'.RES_RESERVAS RES ON RES.ECO_ID = ECO.ECO_ID
            JOIN '||V_ESQUEMA||'.DD_EEC_EST_EXP_COMERCIAL EEC ON EEC.DD_EEC_ID = ECO.DD_EEC_ID
		    WHERE EEC.DD_EEC_CODIGO = ''11'' AND CAI.DD_MEP_ID IS NOT NULL AND CAI.DD_PAI_TRANSFERENCIA_ID IS NOT NULL AND CAI.DD_FOP_FINALIDAD_OPERACION IS NOT NULL AND CAI.OFR_MOTIVO_COMPRA IS NOT NULL
            ) AUX ON (AUX.NUM_OFERTA = MIG.NUM_OFERTA) 
			WHEN MATCHED THEN UPDATE SET
			MIG.TAREA_NUEVA_TRAMITE = AUX.TAREA_NUEVA_TRAMITE';
                   
        	EXECUTE IMMEDIATE V_SENTENCIA;
        	
       		V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA MIG2 USING(
				SELECT NUM_OFERTA, ACT_ID FROM (SELECT MIG.NUM_OFERTA, ROW_NUMBER() OVER ( PARTITION BY MIG.NUM_OFERTA ORDER BY ACT.ACT_ID) row_num, ACT.ACT_ID FROM '||V_ESQUEMA||'.OFR_OFERTAS OFR
                		INNER JOIN '||V_ESQUEMA||'.ACT_OFR ACO ON ACO.OFR_ID = OFR.OFR_ID
                   		INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = ACO.ACT_ID
                    		INNER JOIN '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA MIG ON MIG.NUM_OFERTA = OFR.OFR_NUM_OFERTA) WHERE ROW_NUM = 1
                    		)
                    		AUX ON (AUX.NUM_OFERTA = MIG2.NUM_OFERTA)
                    	WHEN MATCHED THEN UPDATE SET
                    	MIG2.ACT_ID = AUX.ACT_ID';
                   
        	EXECUTE IMMEDIATE V_SENTENCIA;
        	
        	
        	       V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA MIG2 USING(
				SELECT MIG.NUM_OFERTA, TAP.TAP_ID FROM 
				'||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA MIG 
				INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_CODIGO = MIG.TAREA_NUEVA_TRAMITE)
                    		AUX ON (AUX.NUM_OFERTA = MIG2.NUM_OFERTA)
                    	WHEN MATCHED THEN UPDATE SET
                    	MIG2.TAP_ID = AUX.TAP_ID';
                   
        	EXECUTE IMMEDIATE V_SENTENCIA;

	COMMIT;
	DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.MIG2_OFR_MAPEO_NUM_OFERTAS cargada. '||SQL%ROWCOUNT||' Filas.');

EXCEPTION
	WHEN OTHERS THEN
		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------');
		DBMS_OUTPUT.put_line(SQLERRM);
		ROLLBACK;
		RAISE;
END;
/
EXIT;
