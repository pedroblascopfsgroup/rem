--/*
--#########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20210727
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.11
--## INCIDENCIA_LINK=HREOS-14680
--## PRODUCTO=NO
--## 
--## Finalidad:
--## 
--## INSTRUCCIONES:
--## VERSIONES:
--## 		0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	TABLE_COUNT NUMBER(10,0) := 0;
	TABLE_COUNT_2 NUMBER(10,0) := 0;
	MAX_NUM_OFR NUMBER(10,0) := 0;
	V_NUM_TABLAS NUMBER(10,0) := 0;
	V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01'; --REM01
	V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER'; --REMMASTER
	V_USUARIO VARCHAR2(50 CHAR) := 'MIG_CAIXA';
	V_TABLA VARCHAR2(40 CHAR) := 'MIG2_OFR_MAPEO_NUM_OFERTAS';
	V_SENTENCIA VARCHAR2(32000 CHAR);
	V_NUM_TABLAS_2 NUMBER(16);
	V_MSQL VARCHAR2(32000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.

BEGIN

	--Inicio del proceso de volcado sobre OFR_OFERTAS
	DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.MIG2_OFR_MAPEO_NUM_OFERTAS');

	V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.OFR_OFERTAS OFR USING(
		SELECT COD_OFERTA_CAIXA FROM '||V_ESQUEMA||'.MIG2_OFR_MAPEO_NUM_OFERTAS) AUX ON (OFR.OFR_NUM_OFERTA = AUX.COD_OFERTA_CAIXA)
		WHEN MATCHED THEN UPDATE SET
		OFR.OFR_WEBCOM_ID =  NULL';

		EXECUTE IMMEDIATE V_SENTENCIA;

		
	V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.OFR_OFERTAS OFR USING(
		SELECT COD_OFERTA_CAIXA, COD_OFERTA_BANKIA FROM '||V_ESQUEMA||'.MIG2_OFR_MAPEO_NUM_OFERTAS) AUX ON (OFR.OFR_NUM_OFERTA = AUX.COD_OFERTA_CAIXA)
		WHEN MATCHED THEN UPDATE SET
		OFR.OFR_NUM_OFERTA =  COD_OFERTA_BANKIA';


		EXECUTE IMMEDIATE V_SENTENCIA;
	
	V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO USING(
		SELECT DISTINCT ECO.ECO_ID, EEC.DD_EEC_ID FROM '||V_ESQUEMA||'.OFR_OFERTAS OFR
		JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
		JOIN '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA AUX ON AUX.NUM_OFERTA = OFR.OFR_NUM_OFERTA
		JOIN '||V_ESQUEMA||'.DD_EEC_EST_EXP_COMERCIAL EEC ON EEC.DD_EEC_CODIGO = AUX.NUEVO_ESTADO_ECO)
		AUX ON (AUX.ECO_ID = ECO.ECO_ID)
		WHEN MATCHED THEN UPDATE SET
		ECO.DD_EEC_ID = AUX.DD_EEC_ID,
		ECO.USUARIOMODIFICAR = ''HREOS-15241'',
		ECO.FECHAMODIFICAR = SYSDATE';
                   
        	EXECUTE IMMEDIATE V_SENTENCIA;
        
        V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO USING(
		SELECT DISTINCT ECO.ECO_ID, EEB.DD_EEB_ID FROM '||V_ESQUEMA||'.OFR_OFERTAS OFR
		JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
		JOIN '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA AUX ON AUX.NUM_OFERTA = OFR.OFR_NUM_OFERTA
		JOIN '||V_ESQUEMA||'.DD_EEB_ESTADO_EXPEDIENTE_BC EEB ON EEB.DD_EEB_CODIGO = AUX.NUEVO_ESTADO_EEB)
		AUX ON (AUX.ECO_ID = ECO.ECO_ID)
		WHEN MATCHED THEN UPDATE SET
		ECO.DD_EEB_ID = AUX.DD_EEB_ID,
		ECO.USUARIOMODIFICAR = ''HREOS-15241'',
		ECO.FECHAMODIFICAR = SYSDATE';
                   
        	EXECUTE IMMEDIATE V_SENTENCIA;
        	
        V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.ACT_TRA_TRAMITE TRA USING(
		SELECT DISTINCT TRA.TRA_ID FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO 
		JOIN '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA AUX ON ECO.TBJ_ID = AUX.TBJ_ID
       	JOIN '||V_ESQUEMA||'.ACT_TRA_TRAMITE TRA ON TRA.TBJ_ID = ECO.TBJ_ID
		WHERE TRA.USUARIOCREAR != ''MIG_CAIXA'')
		AUX ON (AUX.TRA_ID = TRA.TRA_ID)
		WHEN MATCHED THEN UPDATE SET
		TRA.TBJ_ID = NULL,
		TRA.USUARIOMODIFICAR = ''HREOS-15241'',
		TRA.FECHAMODIFICAR = SYSDATE';
                   
        	EXECUTE IMMEDIATE V_SENTENCIA;
        	
        V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO USING(
		SELECT DISTINCT ECO.ECO_ID FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO 
		JOIN '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA AUX ON ECO.TBJ_ID = AUX.TBJ_ID
		WHERE ECO.USUARIOCREAR != ''MIG_CAIXA'')
		AUX ON (AUX.ECO_ID = ECO.ECO_ID)
		WHEN MATCHED THEN UPDATE SET
		ECO.TBJ_ID = NULL,
		ECO.USUARIOMODIFICAR = ''HREOS-15241'',
		ECO.FECHAMODIFICAR = SYSDATE';
                   
        	EXECUTE IMMEDIATE V_SENTENCIA;
        
	--Modificacion estado EEB si tiene arras firmadas
        	
        V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO USING(
		SELECT DISTINCT ECO.ECO_ID FROM '||V_ESQUEMA||'.OFR_OFERTAS OFR
		JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
		JOIN '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA AUX ON AUX.NUM_OFERTA = OFR.OFR_NUM_OFERTA
		JOIN '||V_ESQUEMA||'.RES_RESERVAS RES ON RES.ECO_ID = ECO.ECO_ID
		JOIN '||V_ESQUEMA||'.DD_ERE_ESTADOS_RESERVA ERE ON ERE.DD_ERE_ID = RES.DD_ERE_ID
		WHERE ERE.DD_ERE_CODIGO = ''02'')
		AUX ON (AUX.ECO_ID = ECO.ECO_ID)
		WHEN MATCHED THEN UPDATE SET
		ECO.DD_EEB_ID = (SELECT DD_EEB_ID FROM '||V_ESQUEMA||'.DD_EEB_ESTADO_EXPEDIENTE_BC EEB WHERE DD_EEB_CODIGO = ''014''),
		ECO.USUARIOMODIFICAR = ''HREOS-15241'',
		ECO.FECHAMODIFICAR = SYSDATE';
		
	        EXECUTE IMMEDIATE V_SENTENCIA;
        
        COMMIT;

	DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.MIG2_OFR_MAPEO_NUM_OFERTAS cargada. '||SQL%ROWCOUNT||' Filas.');

EXCEPTION
	WHEN OTHERS THEN
		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------');
		DBMS_OUTPUT.put_line(SQLERRM);
		ROLLBACK;
		RAISE;
END;
/
EXIT;
