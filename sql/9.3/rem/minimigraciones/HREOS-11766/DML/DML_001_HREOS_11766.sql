--/*
--#########################################
--## AUTOR=Daniel Algaba
--## FECHA_CREACION=20201020
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-11766
--## PRODUCTO=NO
--## 
--## Finalidad: Actualizacion tarifas Divarian en la tabla ACT_CFT_CONFIG_TARIFA.
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	
	V_TABLA VARCHAR2(30 CHAR) := 'ACT_ART_ADMISION_REV_TITULO'; -- Variable para tabla de salida para el borrado	
	V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error	
	V_SQL VARCHAR2(8000 CHAR);--Sentencia a ejecutar	
	PL_OUTPUT VARCHAR2(32000 CHAR);
	V_USUARIO VARCHAR2(50 CHAR) := 'HREOS-11766';
	

BEGIN

	--Adapto los campos insertados en la temporal para luego volcarlos al tarifario
	DBMS_OUTPUT.PUT_LINE('[INICIO]'||CHR(10));	
	DBMS_OUTPUT.PUT_LINE('[INFO] PREPARANDO LOS DATOS DE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||'
		(
			ART_ID
			, ACT_ID
			, ART_REVISADO
			, ART_FECHA_REVISION_TITULO
			, ART_RATIFICACION
			, ART_INST_LIB_ARRENDATARIA
			, ART_SIT_INI_INSCRIPCION
			, ART_POSESORIA_INI
			, ART_SIT_INI_CARGAS
			, ART_PORC_PROPIEDAD
			, ART_TIPO_TITULARIDAD
			--, ART_OBSERVACIONES
			, ART_AUTORIZ_TRANSMISION
			, ART_ANOTACION_CONCURSO
			, ART_EST_GES_CA
			, ART_CONS_FISICA
			, ART_PORC_CONS_TASACION_CF
			, ART_CONS_JURIDICA
			, ART_PORC_CONS_TASACION_CJ
			, ART_CERTIFICADO_FIN_OBRA
			, ART_AFO_ACTA_FIN_OBRA
			, ART_LIC_PRIMERA_OCIPACION
			, ART_BOLETINES
			, ART_SEGURO_DECENAL
			, ART_CEDULA_HABITABILIDAD
			, ART_FECHA_CONTRATO_ALQ
			, ART_LEGISLACION_APLICABLE_ALQ
			, ART_DURACION_CONTRATO_ALQ
			, ART_TIPO_ARRENDAMIENTO
			, ART_NOTIF_ARRENDATARIOS
			, ART_TIPO_EXP_ADM
			, ART_EST_GES_EA
			, ART_TIPO_INCI_REGISTRAL
			, ART_EST_GES_CR
			, ART_TIPO_OCUPACION_LEGAL
			, ART_TIPO_INCI_ILOC
			, ART_EST_GES_IL
			, ART_DETERIORO_GRAVE
			, ART_TIPO_INCI_OTROS
			, ART_EST_GES_OT
			, USUARIOCREAR
			, FECHACREAR
			, DD_SNR_ID
			, DD_PTO_ID
			, TIPO_TITULO_ACTIVO_ENTRADA
			, SUBTIPO_TITULO_ACTIVO_ENTRADA
			, TIPO_TIT_ACT_ENT_REF
			, SUBTIPO_TIT_ACT_ENT_REF
		)			
		SELECT 
		'||V_ESQUEMA||'.S_'||V_TABLA||'.NEXTVAL ART_ID
		, ACT.ACT_ID
		, CASE WHEN TMP.ART_REVISADO = ''SI'' THEN (SELECT DD_SIN_ID FROM '||V_ESQUEMA_M||'.DD_SIN_SINO WHERE DD_SIN_CODIGO = ''01'')
            WHEN TMP.ART_REVISADO = ''NO'' THEN (SELECT DD_SIN_ID FROM '||V_ESQUEMA_M||'.DD_SIN_SINO WHERE DD_SIN_CODIGO = ''02'')
            ELSE NULL END ART_REVISADO
		, TO_DATE(TMP.ART_FECHA_REVISION_TITULO,''dd/mm/yy'') TMP.ART_FECHA_REVISION_TITULO
		, (SELECT DD_SNA_ID FROM '||V_ESQUEMA||'.DD_SNA_SI_NO_NA WHERE DD_SNA_CODIGO = TMP.ART_RATIFICACION) ART_RATIFICACION
		, (SELECT DD_SNA_ID FROM '||V_ESQUEMA||'.DD_SNA_SI_NO_NA WHERE DD_SNA_CODIGO = TMP.ART_INST_LIB_ARRENDATARIA) ART_INST_LIB_ARRENDATARIA
		, (SELECT DD_SII_ID FROM '||V_ESQUEMA||'.DD_SII_SIT_INI_INSCRIPCION WHERE DD_SII_CODIGO = TMP.ART_SIT_INI_INSCRIPCION) ART_SIT_INI_INSCRIPCION
		, (SELECT DD_SPI_ID FROM '||V_ESQUEMA||'.DD_SPI_SIT_POSESORIA_INI WHERE DD_SPI_CODIGO = TMP.ART_POSESORIA_INI) ART_POSESORIA_INI
		, (SELECT DD_SIC_ID FROM '||V_ESQUEMA||'.DD_SIC_SIT_INI_CARGAS WHERE DD_SIC_CODIGO = TMP.ART_SIT_INI_CARGAS) ART_SIT_INI_CARGAS
		, ART_PORC_PROPIEDAD
		, (SELECT DD_TTI_ID FROM '||V_ESQUEMA||'.DD_TTI_TIPO_TITULARIDAD WHERE DD_TTI_CODIGO = TMP.ART_TIPO_TITULARIDAD) ART_TIPO_TITULARIDAD
		--, ART_OBSERVACIONES
		, (SELECT DD_AUT_ID FROM '||V_ESQUEMA||'.DD_AUT_AUTORIZ_TRANSMISION WHERE DD_AUT_CODIGO = TMP.ART_AUTORIZ_TRANSMISION) ART_AUTORIZ_TRANSMISION
		, (SELECT DD_ANC_ID FROM '||V_ESQUEMA||'.DD_ANC_ANOTACION_CONCURSO WHERE DD_ANC_CODIGO = TMP.ART_ANOTACION_CONCURSO) ART_ANOTACION_CONCURSO
		, (SELECT DD_ESG_ID FROM '||V_ESQUEMA||'.DD_ESG_ESTADO_GESTION WHERE DD_ESG_CODIGO = TMP.ART_EST_GES_CA) ART_EST_GES_CA
		, (SELECT DD_SIN_ID FROM '||V_ESQUEMA_M||'.DD_SIN_SINO WHERE DD_SIN_CODIGO = TMP.ART_CONS_FISICA) ART_CONS_FISICA
		, ART_PORC_CONS_TASACION_CF
		, (SELECT DD_SIN_ID FROM '||V_ESQUEMA_M||'.DD_SIN_SINO WHERE DD_SIN_CODIGO = TMP.ART_CONS_JURIDICA) ART_CONS_JURIDICA
		, ART_PORC_CONS_TASACION_CJ
		, (SELECT DD_CFO_ID FROM '||V_ESQUEMA||'.DD_CFO_CERTIFICADO_FIN_OBRA WHERE DD_CFO_CODIGO = TMP.ART_CERTIFICADO_FIN_OBRA) ART_CERTIFICADO_FIN_OBRA
		, (SELECT DD_AFO_ID FROM '||V_ESQUEMA||'.DD_AFO_ACTA_FIN_OBRA WHERE DD_AFO_CODIGO = TMP.ART_AFO_ACTA_FIN_OBRA) ART_AFO_ACTA_FIN_OBRA
		, (SELECT DD_LPO_ID FROM '||V_ESQUEMA||'.DD_LPO_LIC_PRIMERA_OCUPACION WHERE DD_LPO_CODIGO = TMP.ART_LIC_PRIMERA_OCIPACION) ART_LIC_PRIMERA_OCIPACION
		, (SELECT DD_BOL_ID FROM '||V_ESQUEMA||'.DD_BOL_BOLETINES WHERE DD_BOL_CODIGO = TMP.ART_BOLETINES) ART_BOLETINES
		, (SELECT DD_SDC_ID FROM '||V_ESQUEMA||'.DD_SDC_SEGURO_DECENAL WHERE DD_SDC_CODIGO = TMP.ART_SEGURO_DECENAL) ART_SEGURO_DECENAL
		, (SELECT DD_CEH_ID FROM '||V_ESQUEMA||'.DD_CEH_CEDULA_HABITABILIDAD WHERE DD_CEH_CODIGO = TMP.ART_CEDULA_HABITABILIDAD) ART_CEDULA_HABITABILIDAD
		, TO_DATE(TMP.ART_FECHA_CONTRATO_ALQ,''dd/mm/yy'') ART_FECHA_CONTRATO_ALQ
		, ART_LEGISLACION_APLICABLE_ALQ
		, ART_DURACION_CONTRATO_ALQ
		, (SELECT DD_TIA_ID FROM '||V_ESQUEMA||'.DD_TIA_TIPO_ARRENDAMIENTO WHERE DD_TIA_CODIGO = TMP.ART_TIPO_ARRENDAMIENTO) ART_TIPO_ARRENDAMIENTO
		, (SELECT DD_SIN_ID FROM '||V_ESQUEMA_M||'.DD_SIN_SINO WHERE DD_SIN_CODIGO = TMP.ART_NOTIF_ARRENDATARIOS) ART_NOTIF_ARRENDATARIOS
		, (SELECT DD_TEA_ID FROM '||V_ESQUEMA||'.DD_TEA_TIPO_EXP_ADM WHERE DD_TEA_CODIGO = TMP.ART_TIPO_EXP_ADM) ART_TIPO_EXP_ADM
		, (SELECT DD_ESG_ID FROM '||V_ESQUEMA||'.DD_ESG_ESTADO_GESTION WHERE DD_ESG_CODIGO = TMP.ART_EST_GES_EA) ART_EST_GES_EA
		, (SELECT DD_TIR_ID FROM '||V_ESQUEMA||'.DD_TIR_TIPO_INCI_REGISTRAL WHERE DD_TIR_CODIGO = TMP.ART_TIPO_INCI_REGISTRAL) ART_TIPO_INCI_REGISTRAL
		, (SELECT DD_ESG_ID FROM '||V_ESQUEMA||'.DD_ESG_ESTADO_GESTION WHERE DD_ESG_CODIGO = TMP.ART_EST_GES_CR) ART_EST_GES_CR
		, (SELECT DD_TOL_ID FROM '||V_ESQUEMA||'.DD_TOL_TIPO_OCUPACION_LEGAL WHERE DD_TOL_CODIGO = TMP.ART_TIPO_OCUPACION_LEGAL) ART_TIPO_OCUPACION_LEGAL
		, ART_TIPO_INCI_ILOC
		, (SELECT DD_ESG_ID FROM '||V_ESQUEMA||'.DD_ESG_ESTADO_GESTION WHERE DD_ESG_CODIGO = TMP.ART_EST_GES_IL) ART_EST_GES_IL
		, ART_DETERIORO_GRAVE
		, ART_TIPO_INCI_OTROS
		, (SELECT DD_ESG_ID FROM '||V_ESQUEMA||'.DD_ESG_ESTADO_GESTION WHERE DD_ESG_CODIGO = TMP.ART_EST_GES_OT) ART_EST_GES_OT
		, ''HREOS-11766'' USUARIOCREAR
		, SYSDATE FECHACREAR
		, (SELECT DD_SNR_ID FROM '||V_ESQUEMA||'.DD_SNR_SITUACION_CONSTRUCTIVA_REGISTRAL WHERE DD_SNR_CODIGO = TMP.DD_SNR_ID) DD_SNR_ID
		, (SELECT DD_PTO_ID FROM '||V_ESQUEMA||'.DD_PTO_PROTECCION_OFICIAL WHERE DD_PTO_CODIGO = TMP.DD_PTO_ID) DD_PTO_ID
		, (SELECT DD_TTA_ID FROM '||V_ESQUEMA||'.DD_TTA_TIPO_TITULO_ACTIVO WHERE DD_TTA_CODIGO = TMP.TIPO_TITULO_ACTIVO_ENTRADA) TIPO_TITULO_ACTIVO_ENTRADA
		, (SELECT DD_STA_ID FROM '||V_ESQUEMA||'.DD_STA_SUBTIPO_TITULO_ACTIVO WHERE DD_STA_CODIGO = TMP.SUBTIPO_TITULO_ACTIVO_ENTRADA) SUBTIPO_TITULO_ACTIVO_ENTRADA
		, (SELECT DD_TTA_ID FROM '||V_ESQUEMA||'.DD_TTA_TIPO_TITULO_ACTIVO WHERE DD_TTA_CODIGO = TMP.TIPO_TIT_ACT_ENT_REF) TIPO_TIT_ACT_ENT_REF
		, (SELECT DD_STA_ID FROM '||V_ESQUEMA||'.DD_STA_SUBTIPO_TITULO_ACTIVO WHERE DD_STA_CODIGO = TMP.SUBTIPO_TIT_ACT_ENT_REF) SUBTIPO_TIT_ACT_ENT_REF
		FROM '||V_ESQUEMA||'.TMP_ACT_ART_ADMISION_REV_TITULO TMP
		JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON TMP.ACT_ID = ACT.ACT_NUM_ACTIVO';
					
	DBMS_OUTPUT.PUT_LINE(V_SQL);
	EXECUTE IMMEDIATE V_SQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han mergeado en total '||SQL%ROWCOUNT||' registros en la tabla '||V_TABLA);
	COMMIT;
	
	PL_OUTPUT := PL_OUTPUT || '[FIN]'||CHR(10);
	DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);

EXCEPTION
    WHEN OTHERS THEN
      PL_OUTPUT := PL_OUTPUT ||'[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE)||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||'-----------------------------------------------------------'||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||SQLERRM||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||V_SQL||CHR(10);
      DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
