--/*
--#########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20210927
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-15200
--## PRODUCTO=NO
--## 
--## Finalidad:
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 

DECLARE

    -- Esquemas
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
    V_ESQUEMA_M VARCHAR2(15 CHAR) := 'REMMASTER';
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    -- Errores
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    -- Usuario
    V_USUARIO VARCHAR2(50 CHAR) := 'AUX_HREOS_15200_3';
    -- Tablas
    V_TABLA_ACTIVO VARCHAR2(100 CHAR):= 'OFR_OFERTAS_CAIXA';
    V_TABLA_AUX  VARCHAR2(100 CHAR):= 'AUX_HREOS_15200_3';
    
BEGIN

	DBMS_OUTPUT.PUT_LINE('[INICIO]');	
	
	
  	V_TABLA_ACTIVO := 'IOC_INTERLOCUTOR_PBC_CAIXA';
  	
  	V_MSQL :='INSERT INTO '||V_ESQUEMA||'.IOC_INTERLOCUTOR_PBC_CAIXA(
			IOC_ID,
			IOC_ID_PERSONA_HAYA,
			IAP_ID,
			DD_TDI_ID,
			IOC_NOMBRE,
			IOC_APELLIDOS,
			IOC_PERSONA_FISICA,
			DD_PAI_ID,
			DD_ECV_ID,
			IOC_DIRECCION,
			IOC_CODIGO_POSTAL,
			DD_LOC_ID,
			DD_PRV_ID,
			DD_PAI_NAC_ID,
			DD_LOC_NAC_ID,
			IAP_FECHA_NACIMIENTO,
			IOC_TELEFONO1,
			IOC_TELEFONO2,
			IOC_EMAIL,
			VERSION,
			USUARIOCREAR,
			FECHACREAR,
			BORRADO,
			IOC_DOC_IDENTIFICATIVO
			)SELECT '||V_ESQUEMA||'.S_IOC_INTERLOCUTOR_PBC_CAIXA.NEXTVAL, AUX.ID_PERSONA_HAYA, IAP.IAP_ID,  
			(SELECT DD_TDI_ID FROM '||V_ESQUEMA||'.DD_TDI_TIPO_DOCUMENTO_ID WHERE DD_TDI_CODIGO = AUX.TIPO_IDENTIFICACION), AUX.NOMBRE, AUX.APELLIDOS, AUX.PERSONA_FISICA,
			(SELECT DD_PAI_ID FROM '||V_ESQUEMA||'.DD_PAI_PAISES WHERE DD_PAI_CODIGO = AUX.PAIS),
			(SELECT DD_ECV_ID FROM '||V_ESQUEMA||'.DD_ECV_ESTADOS_CIVILES WHERE DD_ECV_CODIGO = ESTADO_CIVIL), AUX.CALLE, AUX.COD_POSTAL,
			(SELECT DD_LOC_ID FROM '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD WHERE DD_LOC_CODIGO = AUX.POBLACION), 
			(SELECT DD_PRV_ID FROM '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA WHERE DD_PRV_CODIGO = AUX.PROVINCIA), 
			(SELECT DD_PAI_ID FROM '||V_ESQUEMA||'.DD_PAI_PAISES WHERE DD_PAI_CODIGO = AUX.PAIS_NACIMIENTO),
			(SELECT DD_LOC_ID FROM '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD WHERE DD_LOC_CODIGO = AUX.MUNICIPIO_NACIMIENTO), TO_DATE(AUX.FECHA_NACIMIENTO, ''yy-mm-dd''), AUX.TELEFONO, AUX.TLF_MOVIL, AUX.EMAIL,
			 1, ''HREOS-15200'', SYSDATE,0, AUX.DOC_IDENTIFICATIVO
			 FROM '||V_ESQUEMA||'.AUX_HREOS_15200_2 AUX
             		 JOIN '||V_ESQUEMA||'.AUX_HREOS_15200_3 AUX2 ON AUX.ID_PERSONA_HAYA = AUX2.ID_PERSONA_HAYA
			 JOIN '||V_ESQUEMA||'.IAP_INFO_ADC_PERSONA IAP ON AUX.ID_PERSONA_HAYA = IAP.ID_PERSONA_HAYA
			 WHERE AUX2.FUNCION NOT IN (''1'', ''2'', ''6'', ''8'', ''11'') AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.IOC_INTERLOCUTOR_PBC_CAIXA IOC WHERE IOC.IOC_ID_PERSONA_HAYA = AUX.ID_PERSONA_HAYA)
  	 ';

  	EXECUTE IMMEDIATE V_MSQL;
  	
  	DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_ACTIVO||' ACTUALIZADAS '||SQL%ROWCOUNT||' FILAS.');
 

  	V_TABLA_ACTIVO := 'CLC_CLIENTE_COMERCIAL';
  	
  	V_MSQL :='INSERT INTO '||V_ESQUEMA||'.CLC_CLIENTE_COMERCIAL(
				CLC_ID,
				CLC_REM_ID,
				CLC_NOMBRE,
				CLC_APELLIDOS,
				DD_TDI_ID,
				CLC_DOCUMENTO,
				CLC_TELEFONO1,
				CLC_TELEFONO2,
				CLC_EMAIL,
				CLC_DIRECCION,
				CLC_CODIGO_POSTAL,
				DD_PRV_ID,
				DD_LOC_ID,
				VERSION,
				USUARIOCREAR,
				FECHACREAR,
				BORRADO,
				DD_TPE_ID,
				DD_ECV_ID,
				CLC_ID_PERSONA_HAYA,
				DD_PAI_ID,
				IAP_ID,
				CLC_FECHA_NACIMIENTO,
				DD_LOC_NAC_ID,
				DD_PAI_NAC_ID
			)SELECT '||V_ESQUEMA||'.S_CLC_CLIENTE_COMERCIAL.NEXTVAL, '||V_ESQUEMA||'.S_CLC_REM_ID.NEXTVAL,NOMBRE, APELLIDOS, IDENTIFICACION, DOC_IDENTIFICATIVO, TELEFONO, TLF_MOVIL, EMAIL, CALLE, COD_POSTAL, PROVINCIA, POBLACION, VERSION, USUARIO_CREAR, 
            FECHA_CREAR,BORRADO, PERSONA_FISICA, ESTADO_CIVIL, ID_PERSONA_HAYA, PAIS, IAP_ID, FECHA_NACIMIENTO, MUNICIPIO, PAIS_NAC  FROM (SELECT DISTINCT  AUX.NOMBRE, AUX.APELLIDOS,
			(SELECT DD_TDI_ID FROM '||V_ESQUEMA||'.DD_TDI_TIPO_DOCUMENTO_ID WHERE DD_TDI_CODIGO = AUX.TIPO_IDENTIFICACION) AS IDENTIFICACION, AUX.DOC_IDENTIFICATIVO, 
			AUX.TELEFONO, AUX.TLF_MOVIL, AUX.EMAIL, AUX.CALLE, AUX.COD_POSTAL, 
			(SELECT DD_PRV_ID FROM '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA WHERE DD_PRV_CODIGO = AUX.PROVINCIA) AS PROVINCIA,
			(SELECT DD_LOC_ID FROM '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD WHERE DD_LOC_CODIGO = AUX.POBLACION) AS POBLACION,
			1 AS VERSION, ''HREOS-15200'' AS USUARIO_CREAR, SYSDATE AS FECHA_CREAR,0 AS BORRADO,  CASE WHEN AUX.PERSONA_FISICA = 1 THEN 1 WHEN AUX.PERSONA_FISICA = 0 THEN 2 END AS PERSONA_FISICA, 
			(SELECT DD_ECV_ID FROM '||V_ESQUEMA||'.DD_ECV_ESTADOS_CIVILES WHERE DD_ECV_CODIGO = ESTADO_CIVIL) AS ESTADO_CIVIL,
			 AUX.ID_PERSONA_HAYA, (SELECT DD_PAI_ID FROM '||V_ESQUEMA||'.DD_PAI_PAISES WHERE DD_PAI_CODIGO = AUX.PAIS_NACIMIENTO) AS PAIS, IAP.IAP_ID, TO_DATE(AUX.FECHA_NACIMIENTO, ''yy-mm-dd'') AS FECHA_NACIMIENTO,
			(SELECT DD_LOC_ID FROM '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD WHERE DD_LOC_CODIGO = AUX.MUNICIPIO_NACIMIENTO) AS MUNICIPIO,
			(SELECT DD_PAI_ID FROM '||V_ESQUEMA||'.DD_PAI_PAISES WHERE DD_PAI_CODIGO = AUX.PAIS_NACIMIENTO) AS PAIS_NAC
			 FROM '||V_ESQUEMA||'.AUX_HREOS_15200_2 AUX
             		 JOIN '||V_ESQUEMA||'.AUX_HREOS_15200_3 AUX2 ON AUX.ID_PERSONA_HAYA = AUX2.ID_PERSONA_HAYA
			 JOIN '||V_ESQUEMA||'.IAP_INFO_ADC_PERSONA IAP ON AUX.ID_PERSONA_HAYA = IAP.ID_PERSONA_HAYA
			 WHERE AUX2.FUNCION IN (''1'', ''2'', ''6'', ''8'', ''11'') AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.CLC_CLIENTE_COMERCIAL CLC WHERE CLC.CLC_ID_PERSONA_HAYA = AUX.ID_PERSONA_HAYA))
  	 ';

  	EXECUTE IMMEDIATE V_MSQL;
  	
  	DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_ACTIVO||' ACTUALIZADAS '||SQL%ROWCOUNT||' FILAS.');
  	
  	
  	V_TABLA_ACTIVO := 'COM_COMPRADOR';
  	
  	V_MSQL :='INSERT INTO '||V_ESQUEMA||'.COM_COMPRADOR(
			COM_ID,
			DD_TPE_ID,
			COM_NOMBRE,
			COM_APELLIDOS,
			DD_TDI_ID,
			COM_DOCUMENTO,
			COM_TELEFONO1,
			COM_TELEFONO2,
			COM_EMAIL,
			COM_DIRECCION,
			COM_CODIGO_POSTAL,
			VERSION,
			USUARIOCREAR,
			FECHACREAR,
			BORRADO,
			CLC_ID,
			DD_LOC_ID,
			DD_PRV_ID,
			ID_PERSONA_HAYA,
			COM_FORMA_JURIDICA,
			IAP_ID,
			DD_LOC_NAC_ID,
			DD_PAI_NAC_ID,
			COM_FECHA_NACIOCONST)
SELECT '||V_ESQUEMA||'.S_COM_COMPRADOR.NEXTVAL, PERSONA_FISICA, NOMBRE, APELLIDOS, TIPO_IDENTIFICACION, DOC_IDENTIFICATIVO, TELEFONO, TLF_MOVIL, EMAIL, CALLE, COD_POSTAL, VERSION, USUARIOCREAR, FECHACREAR, BORRADO, CLC_ID, POBLACION, PROVINCIA, 
ID_PERSONA_HAYA, FORMA_JURIDICA, IAP_ID, MUN_NAC, PAI_NAC, FEC_NAC FROM ( SELECT  PERSONA_FISICA, NOMBRE, APELLIDOS, TIPO_IDENTIFICACION, DOC_IDENTIFICATIVO, TELEFONO, TLF_MOVIL, EMAIL, CALLE, COD_POSTAL, VERSION, USUARIOCREAR, FECHACREAR, BORRADO, CLC_ID, POBLACION, PROVINCIA, 
ID_PERSONA_HAYA, FORMA_JURIDICA, IAP_ID, MUN_NAC, PAI_NAC, FEC_NAC, ROW_NUM
FROM ( SELECT DISTINCT CASE WHEN AUX.PERSONA_FISICA = 1 THEN 1 WHEN AUX.PERSONA_FISICA = 0 THEN 2 END AS PERSONA_FISICA, 
			AUX.NOMBRE, AUX.APELLIDOS, (SELECT DD_TDI_ID FROM '||V_ESQUEMA||'.DD_TDI_TIPO_DOCUMENTO_ID WHERE DD_TDI_CODIGO = AUX.TIPO_IDENTIFICACION) AS TIPO_IDENTIFICACION, AUX.DOC_IDENTIFICATIVO,
			AUX.TELEFONO, AUX.TLF_MOVIL, AUX.EMAIL, AUX.CALLE, AUX.COD_POSTAL,  1 AS VERSION, ''HREOS-15200'' AS USUARIOCREAR, SYSDATE AS FECHACREAR,0 AS BORRADO, CLC.CLC_ID, 
			(SELECT DD_LOC_ID FROM '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD WHERE DD_LOC_CODIGO = AUX.POBLACION) AS POBLACION, 
			(SELECT DD_PRV_ID FROM '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA WHERE DD_PRV_CODIGO = AUX.PROVINCIA) AS PROVINCIA, AUX.ID_PERSONA_HAYA AS ID_PERSONA_HAYA,
			(SELECT DD_FOJ_ID FROM '||V_ESQUEMA||'.DD_FOJ_FORMA_JURIDICA WHERE DD_FOJ_CODIGO = FORMA_JURIDICA) AS FORMA_JURIDICA, IAP.IAP_ID AS IAP_ID,
			(SELECT DD_LOC_ID FROM '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD WHERE DD_LOC_CODIGO = AUX.MUNICIPIO_NACIMIENTO) MUN_NAC,
			(SELECT DD_PAI_ID FROM '||V_ESQUEMA||'.DD_PAI_PAISES WHERE DD_PAI_CODIGO = AUX.PAIS_NACIMIENTO) AS PAI_NAC, TO_DATE(AUX.FECHA_NACIMIENTO, ''yy-mm-dd'') AS FEC_NAC, ROW_NUMBER() OVER (
      PARTITION BY AUX.DOC_IDENTIFICATIVO
      ORDER BY AUX.DOC_IDENTIFICATIVO) AS ROW_NUM
			 FROM '||V_ESQUEMA||'.AUX_HREOS_15200_2 AUX
             		 JOIN '||V_ESQUEMA||'.AUX_HREOS_15200_3 AUX2 ON AUX.ID_PERSONA_HAYA = AUX2.ID_PERSONA_HAYA
			 JOIN '||V_ESQUEMA||'.IAP_INFO_ADC_PERSONA IAP ON AUX.ID_PERSONA_HAYA = IAP.ID_PERSONA_HAYA
			 JOIN '||V_ESQUEMA||'.CLC_CLIENTE_COMERCIAL CLC ON CLC.CLC_ID_PERSONA_HAYA = AUX.ID_PERSONA_HAYA
			 WHERE AUX2.FUNCION IN (''1'', ''2'', ''6'', ''8'', ''11'') AND NOT EXISTS (SELECT 1 FROM '||V_ESQUEMA||'.COM_COMPRADOR COM WHERE COM.ID_PERSONA_HAYA = AUX.ID_PERSONA_HAYA OR COM.COM_DOCUMENTO = AUX.DOC_IDENTIFICATIVO)) WHERE ROW_NUM = 1)
  	 ';

  	EXECUTE IMMEDIATE V_MSQL;
  	
  	DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_ACTIVO||' ACTUALIZADAS '||SQL%ROWCOUNT||' FILAS.');


  	V_TABLA_ACTIVO := 'IEX_INTERLOCUTOR_EXPEDIENTE';
       DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZAR '||V_TABLA_ACTIVO||' ');
  	
  	 V_MSQL :='INSERT INTO '||V_ESQUEMA||'.IEX_INTERLOCUTOR_EXPEDIENTE(
			IEX_ID,
			IOC_ID,
			ECO_ID,
			DD_FIO_ID,
			DD_EIC_ID,
			VERSION,
			USUARIOCREAR,
			FECHACREAR,
			BORRADO
			)SELECT '||V_ESQUEMA||'.S_IEX_INTERLOCUTOR_EXPEDIENTE.NEXTVAL, IOC.IOC_ID, ECO.ECO_ID, (SELECT DD_FIO_ID FROM '||V_ESQUEMA||'.DD_FIO_FUN_INTERLOCUTOR_OFERTA WHERE DD_FIO_CODIGO = AUX.FUNCION), NULL, 1, ''HREOS-15200'', SYSDATE,0 FROM 
			'||V_ESQUEMA||'.AUX_HREOS_15200_3 AUX
			 JOIN '||V_ESQUEMA||'.IOC_INTERLOCUTOR_PBC_CAIXA IOC ON AUX.ID_PERSONA_HAYA = IOC.IOC_ID_PERSONA_HAYA
			 JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_NUM_OFERTA = AUX.CODIGO_OFERTA
			 JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
			  WHERE AUX.FUNCION NOT IN (''1'', ''2'', ''6'', ''8'', ''11'')';

  	EXECUTE IMMEDIATE V_MSQL;

  	DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_ACTIVO||' ACTUALIZADAS '||SQL%ROWCOUNT||' FILAS.');
  	
  	V_TABLA_ACTIVO := 'CEX_COMPRADOR_EXPEDIENTE';

       DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZAR '||V_TABLA_ACTIVO||' ');
  	
  	 V_MSQL :='INSERT INTO '||V_ESQUEMA||'.CEX_COMPRADOR_EXPEDIENTE(
			COM_ID,
			ECO_ID,
			DD_ECV_ID,
			VERSION,
			BORRADO,
			DD_PAI_ID,
			CEX_ID_PERSONA_HAYA,
			USUARIOCREAR,
			FECHACREAR,
			CEX_C4C_ID,
			DD_FIO_ID
			)SELECT COM.COM_ID , ECO.ECO_ID, 
			(SELECT DD_ECV_ID FROM '||V_ESQUEMA||'.DD_ECV_ESTADOS_CIVILES WHERE DD_ECV_CODIGO = AUX2.ESTADO_CIVIL) ,
			 1,0,(SELECT DD_PAI_ID FROM '||V_ESQUEMA||'.DD_PAI_PAISES WHERE DD_PAI_CODIGO = AUX2.PAIS_NACIMIENTO), AUX.ID_PERSONA_HAYA, ''HREOS-15200'', SYSDATE, 
			(SELECT DD_ECC_ID FROM '||V_ESQUEMA||'.DD_ECC_ESTADO_COMUNICACION_C4C WHERE DD_ECC_CODIGO = ''01''),
			(SELECT DD_FIO_ID FROM '||V_ESQUEMA||'.DD_FIO_FUN_INTERLOCUTOR_OFERTA WHERE DD_FIO_CODIGO = AUX.FUNCION)
			 FROM '||V_ESQUEMA||'.AUX_HREOS_15200_3 AUX
			 JOIN '||V_ESQUEMA||'.AUX_HREOS_15200_2 AUX2 ON AUX.ID_PERSONA_HAYA = AUX2.ID_PERSONA_HAYA
			 JOIN '||V_ESQUEMA||'.IAP_INFO_ADC_PERSONA IAP ON AUX.ID_PERSONA_HAYA = IAP.ID_PERSONA_HAYA
			 JOIN '||V_ESQUEMA||'.COM_COMPRADOR COM ON COM.ID_PERSONA_HAYA = AUX.ID_PERSONA_HAYA
			 JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_NUM_OFERTA = AUX.CODIGO_OFERTA
			 JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
			 WHERE AUX.FUNCION IN (''1'', ''2'', ''6'', ''8'', ''11'')';

  	EXECUTE IMMEDIATE V_MSQL;

  	DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_ACTIVO||' ACTUALIZADAS '||SQL%ROWCOUNT||' FILAS.');
  	
  	V_TABLA_ACTIVO := 'OFR_TIA_TITULARES_ADICIONALES';

        DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZAR '||V_TABLA_ACTIVO||' ');
       
        	
  	 V_MSQL :='INSERT INTO '||V_ESQUEMA||'.OFR_TIA_TITULARES_ADICIONALES(
			TIA_ID,
			OFR_ID,
			TIA_NOMBRE,
			DD_TDI_ID,
			TIA_DOCUMENTO,
			VERSION,
			USUARIOCREAR,
			FECHACREAR,
			BORRADO,
			TIA_APELLIDOS,
			TIA_DIRECCION,
			DD_LOC_ID,
			DD_PRV_ID,
			TIA_CODPOSTAL,
			DD_ECV_ID,
			TIA_TELEFONO1,
			TIA_TELEFONO2,
			TIA_EMAIL,
			DD_TPE_ID,
			DD_PAI_ID,
			TIA_C4C_ID,
			TIA_ID_PERSONA_HAYA,
			IAP_ID,
			TIA_FECHA_NACIMIENTO,
			DD_LOC_NAC_ID,
			DD_PAI_NAC_ID
			)SELECT '||V_ESQUEMA||'.S_OFR_TIA_TIT_ADICIONALES.NEXTVAL, OFR.OFR_ID, AUX.NOMBRE,
			(SELECT DD_TDI_ID FROM '||V_ESQUEMA||'.DD_TDI_TIPO_DOCUMENTO_ID WHERE DD_TDI_CODIGO = AUX.TIPO_IDENTIFICACION), 
			AUX.DOC_IDENTIFICATIVO,  1, ''HREOS-15200'', SYSDATE,0, AUX.APELLIDOS, AUX.CALLE,
			(SELECT DD_LOC_ID FROM '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD WHERE DD_LOC_CODIGO = AUX.POBLACION), 
			(SELECT DD_PRV_ID FROM '||V_ESQUEMA_M||'.DD_PRV_PROVINCIA WHERE DD_PRV_CODIGO = AUX.PROVINCIA),AUX.COD_POSTAL, 
			(SELECT DD_ECV_ID FROM '||V_ESQUEMA||'.DD_ECV_ESTADOS_CIVILES WHERE DD_ECV_CODIGO = ESTADO_CIVIL),
			AUX.TELEFONO, AUX.TLF_MOVIL, AUX.EMAIL, 
			CASE WHEN AUX.PERSONA_FISICA = 1 THEN 1 WHEN AUX.PERSONA_FISICA = 0 THEN 2 END AS PERSONA_FISICA,
			(SELECT DD_PAI_ID FROM '||V_ESQUEMA||'.DD_PAI_PAISES WHERE DD_PAI_CODIGO = AUX.PAIS_NACIMIENTO),
			(SELECT DD_ECC_ID FROM '||V_ESQUEMA||'.DD_ECC_ESTADO_COMUNICACION_C4C WHERE DD_ECC_CODIGO = ''01''),
			AUX.ID_PERSONA_HAYA, IAP.IAP_ID,TO_DATE(AUX.FECHA_NACIMIENTO, ''yy-mm-dd''),
			(SELECT DD_LOC_ID FROM '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD WHERE DD_LOC_CODIGO = AUX.MUNICIPIO_NACIMIENTO),
			(SELECT DD_PAI_ID FROM '||V_ESQUEMA||'.DD_PAI_PAISES WHERE DD_PAI_CODIGO = AUX.PAIS_NACIMIENTO)
			 FROM '||V_ESQUEMA||'.AUX_HREOS_15200_2 AUX
             		 JOIN '||V_ESQUEMA||'.AUX_HREOS_15200_3 AUX2 ON AUX.ID_PERSONA_HAYA = AUX2.ID_PERSONA_HAYA
             		 JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_NUM_OFERTA = AUX2.CODIGO_OFERTA
			 JOIN '||V_ESQUEMA||'.IAP_INFO_ADC_PERSONA IAP ON AUX.ID_PERSONA_HAYA = IAP.ID_PERSONA_HAYA
			 JOIN '||V_ESQUEMA||'.CLC_CLIENTE_COMERCIAL CLC ON CLC.CLC_ID_PERSONA_HAYA = AUX.ID_PERSONA_HAYA
			 WHERE AUX2.FUNCION IN (''1'', ''2'', ''6'', ''8'', ''11'')';

  	EXECUTE IMMEDIATE V_MSQL;

  	DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_ACTIVO||' ACTUALIZADAS '||SQL%ROWCOUNT||' FILAS.');


        
    COMMIT;

    DBMS_OUTPUT.PUT_LINE('[FIN]: IDS MODIFICADOS con éxito');

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
