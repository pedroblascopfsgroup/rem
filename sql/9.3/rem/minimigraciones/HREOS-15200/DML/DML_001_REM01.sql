--/*
--#########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20210927
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-15200
--## PRODUCTO=NO
--## 
--## Finalidad:
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 

DECLARE

    -- Esquemas
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
    V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    -- Errores
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    -- Usuario
    V_USUARIO VARCHAR2(50 CHAR) := 'AUX_HREOS_15200_1';
    -- Tablas
    V_TABLA_ACTIVO VARCHAR2(100 CHAR):= 'OFR_OFERTAS_CAIXA';
    V_TABLA_AUX  VARCHAR2(100 CHAR):= 'AUX_HREOS_15200_1';
    
BEGIN

	DBMS_OUTPUT.PUT_LINE('[INICIO]');	


       DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZAR '||V_TABLA_ACTIVO||' ');
  	
  	 V_MSQL :='MERGE INTO '||V_ESQUEMA||'.OFR_OFERTAS_CAIXA CAI USING (
			SELECT CAI.OFR_CAIXA_ID, CODIGO_OFERTA,
			OF_SOSPECHOSA,
			ENTIDAD_FINANCIERA,
			MEP.DD_MEP_ID AS MEDIO_PAGO,
			OCULTA_IDENTIDAD_TITULAR,
			ACTITUD_INCOHERENTE,
			PAGO_INTERMEDIARIO,
			TITULOS_PORTADOR,
			PAI.DD_PAI_ID AS PAIS_TRANFERENCIA,
			DD_FOP_ID AS FINALIDAD_OPERACION,
			MOTIVO_COMPRA,
			ORI_FONDOS_PROPIOS,
			ORI_FONDOS_BANCO,
			FPF.DD_PFP_ID AS PROC_FONDOS_PROPIOS,
			DETECCION_INDICIO,
			SANCION_PBCHRE,
			FECHASANCION_PBCHRE,
			INFORME_PBCHRE,
			CASE WHEN RIESGO_OPERACION = ''A'' THEN ''01'' WHEN RIESGO_OPERACION = ''M'' THEN ''02'' WHEN RIESGO_OPERACION = ''B'' THEN ''03'' END AS RIESGO_OPERACION,
			VALIDAR_DOCUMENTACION 
			FROM '||V_ESQUEMA||'.AUX_HREOS_15200_1 AUX
			JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_NUM_OFERTA = AUX.CODIGO_OFERTA
			JOIN '||V_ESQUEMA||'.OFR_OFERTAS_CAIXA CAI ON CAI.OFR_ID = OFR.OFR_ID
			LEFT JOIN '||V_ESQUEMA||'.DD_MEP_MEDIO_PAGO MEP ON MEP.DD_MEP_CODIGO_PBC = AUX.MEDIO_PAGO
			LEFT JOIN '||V_ESQUEMA||'.DD_PAI_PAISES PAI ON PAI.DD_PAI_CODIGO = AUX.PAIS_TRANFERENCIA
			LEFT JOIN '||V_ESQUEMA||'.DD_PFP_PROC_FONDOS_PROPIOS FPF ON FPF.DD_PFP_CODIGO_BC = AUX.PROC_FONDOS_PROPIOS
			LEFT JOIN '||V_ESQUEMA||'.DD_FOP_FINALIDAD_OPERACION FOP ON FOP.DD_FOP_CODIGO_PBC = AUX.FINALIDAD_OPERACION
			) TMP ON (TMP.OFR_CAIXA_ID = CAI.OFR_CAIXA_ID) WHEN MATCHED THEN UPDATE SET
			CAI.DD_MEP_ID = TMP.MEDIO_PAGO,
			CAI.OFR_OCULTA_IDENTIDAD_TITULAR = TMP.OCULTA_IDENTIDAD_TITULAR,
			CAI.OFR_ACTITUD_INCOHERENTE = TMP.ACTITUD_INCOHERENTE,
			CAI.OFR_PAGO_INTERMEDIARIO = TMP.PAGO_INTERMEDIARIO,
			CAI.OFR_TITULOS_PORTADOR = TMP.TITULOS_PORTADOR,
			CAI.DD_PAI_TRANSFERENCIA_ID = TMP.PAIS_TRANFERENCIA,
			CAI.DD_FOP_FINALIDAD_OPERACION = TMP.FINALIDAD_OPERACION,
			CAI.OFR_MOTIVO_COMPRA = TMP.MOTIVO_COMPRA,
			CAI.OFR_ORI_FONDOS_PROPIOS = TMP.ORI_FONDOS_PROPIOS,
			CAI.OFR_FONDOS_BANCO = TMP.ORI_FONDOS_BANCO,
			CAI.DD_PFP_PROC_FONDOS_PROPIOS = TMP.PROC_FONDOS_PROPIOS,
			CAI.OFR_DETECCION_INDICIO = TMP.DETECCION_INDICIO,
			CAI.OFR_SANCION_PBC = TMP.SANCION_PBCHRE,
			CAI.OFR_FECHA_SANCION = TMP.FECHASANCION_PBCHRE,
			CAI.OFR_INFORME_PBC = TMP.INFORME_PBCHRE,
			CAI.DD_ROP_BC_ID = (SELECT DD_ROP_ID FROM '||V_ESQUEMA||'.DD_ROP_RIESGO_OPERACION WHERE DD_ROP_CODIGO = TMP.RIESGO_OPERACION),
			CAI.OFR_CHECK_DOCUMENTAL_COMPLETO = TMP.VALIDAR_DOCUMENTACION,
			CAI.DD_ECC_ID = (SELECT DD_ECC_ID FROM '||V_ESQUEMA||'.DD_ECC_ESTADO_COMUNICACION_C4C WHERE DD_ECC_CODIGO = ''01''),
			CAI.USUARIOMODIFICAR = ''AUX_HREOS_15200_1'',
            		CAI.FECHAMODIFICAR = SYSDATE';

  	EXECUTE IMMEDIATE V_MSQL;

  	DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_ACTIVO||' ACTUALIZADAS '||SQL%ROWCOUNT||' FILAS.');
  	
  	V_TABLA_ACTIVO := 'OFR_OFERTAS';
  	
  	 V_MSQL :='MERGE INTO '||V_ESQUEMA||'.OFR_OFERTAS OFR USING (
			SELECT OFR.OFR_ID, AUX.OF_SOSPECHOSA
			FROM '||V_ESQUEMA||'.AUX_HREOS_15200_1 AUX
			JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_NUM_OFERTA = AUX.CODIGO_OFERTA
            ) AUX ON (AUX.OFR_ID = OFR.OFR_ID)
            WHEN MATCHED THEN UPDATE SET
            OFR.OFR_SOSPECHOSA = AUX.OF_SOSPECHOSA,
            OFR.USUARIOMODIFICAR = ''AUX_HREOS_15200_1'',
            OFR.FECHAMODIFICAR = SYSDATE';

  	EXECUTE IMMEDIATE V_MSQL;

  	DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_ACTIVO||' ACTUALIZADAS '||SQL%ROWCOUNT||' FILAS.');
  	
  	 V_TABLA_ACTIVO := 'COE_CONDICIONANTES_EXPEDIENTE';
  	
  	 V_MSQL :='MERGE INTO '||V_ESQUEMA||'.COE_CONDICIONANTES_EXPEDIENTE COE USING (
			SELECT COE.COE_ID, AUX.ENTIDAD_FINANCIERA
			FROM '||V_ESQUEMA||'.AUX_HREOS_15200_1 AUX
			JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_NUM_OFERTA = AUX.CODIGO_OFERTA
			JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
			JOIN '||V_ESQUEMA||'.COE_CONDICIONANTES_EXPEDIENTE COE ON COE.ECO_ID = ECO.ECO_ID
            ) AUX ON (AUX.COE_ID = COE.COE_ID)
            WHEN MATCHED THEN UPDATE SET
            COE.DD_ETF_ID = (SELECT DD_ETF_ID FROM '||V_ESQUEMA||'.DD_ETF_ENTIDAD_FINANCIERA WHERE DD_ETF_CODIGO = AUX.ENTIDAD_FINANCIERA),
            COE.USUARIOMODIFICAR = ''AUX_HREOS_15200_1'',
            COE.FECHAMODIFICAR = SYSDATE';

  	EXECUTE IMMEDIATE V_MSQL;

  	DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_ACTIVO||' ACTUALIZADAS '||SQL%ROWCOUNT||' FILAS.');

        
    COMMIT;

    DBMS_OUTPUT.PUT_LINE('[FIN]: MODIFICADOS con éxito');

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
