--/*
--#########################################
--## AUTOR=Alejandra García
--## FECHA_CREACION=20210930
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-15446
--## PRODUCTO=NO
--## 
--## Finalidad:
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 

DECLARE

    -- Esquemas
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
    V_ESQUEMA_M VARCHAR2(15 CHAR) := 'REMMASTER';
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    -- Errores
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    -- Tablas
    V_TABLA_ACTIVO VARCHAR2(100 CHAR):= 'ACT_PAC_PERIMETRO_ACTIVO';
    
BEGIN

	DBMS_OUTPUT.PUT_LINE('[INICIO]');	
	
	
  	V_TABLA_ACTIVO := 'ACT_PAC_PERIMETRO_ACTIVO';
  	
  	V_MSQL :='MERGE INTO '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO T1
				USING (
					SELECT 
						  ACT.ACT_ID AS ACT_ID
						, AUX.PAC_INCLUIDO AS PAC_INCLUIDO
						, AUX.PAC_CHECK_TRA_ADMISION AS PAC_CHECK_TRA_ADMISION
						, AUX.PAC_FECHA_TRA_ADMISION AS PAC_FECHA_TRA_ADMISION
						, AUX.PAC_MOTIVO_TRA_ADMISION AS PAC_MOTIVO_TRA_ADMISION
						, AUX.PAC_CHECK_GESTIONAR AS PAC_CHECK_GESTIONAR
						, AUX.PAC_FECHA_GESTIONAR AS PAC_FECHA_GESTIONAR
						, AUX.PAC_MOTIVO_GESTIONAR AS PAC_MOTIVO_GESTIONAR
						, AUX.PAC_CHECK_ASIGNAR_MEDIADOR AS PAC_CHECK_ASIGNAR_MEDIADOR
						, AUX.PAC_FECHA_ASIGNAR_MEDIADOR AS PAC_FECHA_ASIGNAR_MEDIADOR
						, AUX.PAC_MOTIVO_ASIGNAR_MEDIADOR AS PAC_MOTIVO_ASIGNAR_MEDIADOR
						, AUX.PAC_CHECK_COMERCIALIZAR AS PAC_CHECK_COMERCIALIZAR
						, AUX.PAC_FECHA_COMERCIALIZAR AS PAC_FECHA_COMERCIALIZAR
						, AUX.DD_MCO_ID AS DD_MCO_ID 
						, AUX.PAC_CHECK_FORMALIZAR AS PAC_CHECK_FORMALIZAR
						, AUX.PAC_FECHA_FORMALIZAR AS PAC_FECHA_FORMALIZAR
						, AUX.PAC_MOTIVO_FORMALIZAR AS PAC_MOTIVO_FORMALIZAR
						, AUX.VERSION AS VERSION
						, AUX.USUARIOCREAR AS USUARIOCREAR
						, AUX.FECHACREAR AS FECHACREAR
						, AUX.USUARIOMODIFICAR AS USUARIOMODIFICAR
						, AUX.FECHAMODIFICAR AS FECHAMODIFICAR
						, AUX.USUARIOBORRAR AS USUARIOBORRAR
						, AUX.FECHABORRAR AS FECHABORRAR
						, AUX.BORRADO AS BORRADO
						, AUX.PAC_MOT_EXCL_COMERCIALIZAR AS PAC_MOT_EXCL_COMERCIALIZAR
						, AUX.PAC_CHECK_PUBLICAR AS PAC_CHECK_PUBLICAR
						, AUX.PAC_FECHA_PUBLICAR AS PAC_FECHA_PUBLICAR
						, AUX.PAC_MOTIVO_PUBLICAR AS PAC_MOTIVO_PUBLICAR
						, AUX.PAC_OFERTAS_VIVAS AS PAC_OFERTAS_VIVAS
						, AUX.PAC_TRABAJOS_VIVOS AS PAC_TRABAJOS_VIVOS
						, AUX.PAC_CHECK_ADMISION AS PAC_CHECK_ADMISION
						, AUX.PAC_FECHA_ADMISION AS PAC_FECHA_ADMISION
						, AUX.PAC_MOTIVO_ADMISION AS PAC_MOTIVO_ADMISION
						, AUX.PAC_CHECK_GESTION_COMERCIAL AS PAC_CHECK_GESTION_COMERCIAL
						, AUX.PAC_FECHA_GESTION_COMERCIAL AS PAC_FECHA_GESTION_COMERCIAL
						, AUX.PAC_MOTIVO_GESTION_COMERCIAL AS PAC_MOTIVO_GESTION_COMERCIAL
						, AUX.PAC_EXCLUIR_VALIDACIONES AS PAC_EXCLUIR_VALIDACIONES
					FROM '||V_ESQUEMA||'.AUX_HREOS_15446 AUX
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO=AUX.ACT_NUM_ACTIVO
						AND ACT.BORRADO=0
				) T2 ON (T1.ACT_ID = T2.ACT_ID )
				WHEN MATCHED THEN UPDATE SET
					  T1.PAC_INCLUIDO = T2.PAC_INCLUIDO
					, T1.PAC_CHECK_TRA_ADMISION = T2.PAC_CHECK_TRA_ADMISION
					, T1.PAC_FECHA_TRA_ADMISION = T2.PAC_FECHA_TRA_ADMISION
					, T1.PAC_MOTIVO_TRA_ADMISION = T2.PAC_MOTIVO_TRA_ADMISION
					, T1.PAC_CHECK_GESTIONAR = T2.PAC_CHECK_GESTIONAR
					, T1.PAC_FECHA_GESTIONAR = T2.PAC_FECHA_GESTIONAR
					, T1.PAC_MOTIVO_GESTIONAR = T2.PAC_MOTIVO_GESTIONAR
					, T1.PAC_CHECK_ASIGNAR_MEDIADOR = T2.PAC_CHECK_ASIGNAR_MEDIADOR
					, T1.PAC_FECHA_ASIGNAR_MEDIADOR = T2.PAC_FECHA_ASIGNAR_MEDIADOR
					, T1.PAC_MOTIVO_ASIGNAR_MEDIADOR = T2.PAC_MOTIVO_ASIGNAR_MEDIADOR
					, T1.PAC_CHECK_COMERCIALIZAR = T2.PAC_CHECK_COMERCIALIZAR
					, T1.PAC_FECHA_COMERCIALIZAR = T2.PAC_FECHA_COMERCIALIZAR
					, T1.DD_MCO_ID = T2.DD_MCO_ID 
					, T1.PAC_CHECK_FORMALIZAR = T2.PAC_CHECK_FORMALIZAR
					, T1.PAC_FECHA_FORMALIZAR = T2.PAC_FECHA_FORMALIZAR
					, T1.PAC_MOTIVO_FORMALIZAR = T2.PAC_MOTIVO_FORMALIZAR
					, T1.VERSION = T2.VERSION
					, T1.USUARIOCREAR = T2.USUARIOCREAR
					, T1.FECHACREAR = T2.FECHACREAR
					, T1.USUARIOMODIFICAR = T2.USUARIOMODIFICAR
					, T1.FECHAMODIFICAR = T2.FECHAMODIFICAR
					, T1.USUARIOBORRAR = T2.USUARIOBORRAR
					, T1.FECHABORRAR = T2.FECHABORRAR
					, T1.BORRADO = T2.BORRADO
					, T1.PAC_MOT_EXCL_COMERCIALIZAR = T2.PAC_MOT_EXCL_COMERCIALIZAR
					, T1.PAC_CHECK_PUBLICAR = T2.PAC_CHECK_PUBLICAR
					, T1.PAC_FECHA_PUBLICAR = T2.PAC_FECHA_PUBLICAR
					, T1.PAC_MOTIVO_PUBLICAR = T2.PAC_MOTIVO_PUBLICAR
					, T1.PAC_OFERTAS_VIVAS = T2.PAC_OFERTAS_VIVAS
					, T1.PAC_TRABAJOS_VIVOS = T2.PAC_TRABAJOS_VIVOS
					, T1.PAC_CHECK_ADMISION = T2.PAC_CHECK_ADMISION
					, T1.PAC_FECHA_ADMISION = T2.PAC_FECHA_ADMISION
					, T1.PAC_MOTIVO_ADMISION = T2.PAC_MOTIVO_ADMISION
					, T1.PAC_CHECK_GESTION_COMERCIAL = T2.PAC_CHECK_GESTION_COMERCIAL
					, T1.PAC_FECHA_GESTION_COMERCIAL = T2.PAC_FECHA_GESTION_COMERCIAL
					, T1.PAC_MOTIVO_GESTION_COMERCIAL = T2.PAC_MOTIVO_GESTION_COMERCIAL
					, T1.PAC_EXCLUIR_VALIDACIONES = T2.PAC_EXCLUIR_VALIDACIONES
			';

  	EXECUTE IMMEDIATE V_MSQL;
  	
  	DBMS_OUTPUT.PUT_LINE('  [INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_ACTIVO||' ACTUALIZADAS '||SQL%ROWCOUNT||' FILAS.');
 
        
    COMMIT;

    DBMS_OUTPUT.PUT_LINE('[FIN]: IDS MODIFICADOS con éxito');

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
