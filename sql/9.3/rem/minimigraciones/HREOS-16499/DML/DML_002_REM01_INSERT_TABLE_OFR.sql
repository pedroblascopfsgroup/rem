--/*
--#########################################
--## AUTOR=Santi Monzó
--## FECHA_CREACION=20211203
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## ARTEFACTO=batch
--## INCIDENCIA_LINK=HREOS-16499
--## PRODUCTO=NO
--## 
--## Finalidad:
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
V_USUARIO VARCHAR2(50 CHAR) := 'HREOS-16499';
V_SQL VARCHAR2(30000 CHAR) := '';
V_NUM NUMBER(25);

--Tablas AUX
V_TABLA_AUX VARCHAR2(30 CHAR) := 'AUX_ACT_TRASPASO_ACTIVO';
V_TABLA_AUX1 VARCHAR2(30 CHAR) := 'AUX_OFR_ID';
V_TABLA_AUX2 VARCHAR2(30 CHAR) := 'AUX_ECO_ID';


--Tablas OFERTAS
V_TABLA_OFR VARCHAR2 (30 CHAR) := 'OFR_OFERTAS';
V_TABLA_ACT_OFR VARCHAR2 (30 CHAR) := 'ACT_OFR';
V_TABLA_ECO VARCHAR2 (30 CHAR) := 'ECO_EXPEDIENTE_COMERCIAL';
V_TABLA_ECO_COND VARCHAR2 (30 CHAR) := 'ECO_COND_CONDICIONES_ACTIVO';
V_SENTENCIA VARCHAR2(2600 CHAR);


BEGIN

	
	--INSERT EN AUX_ECO_ID

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.AUX_ECO_ID (

				ECO_ID_VIEJO,
				ECO_ID_NUEVO
				)
				SELECT 
					ECO_ID_VIEJO,
					'||V_ESQUEMA||'.S_ECO_EXPEDIENTE_COMERCIAL.NEXTVAL                    ECO_ID_NUEVO

				FROM(
				SELECT DISTINCT
					ECO_EXP.ECO_ID  ECO_ID_VIEJO
					
					FROM '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID 
					JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID 
					JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
					JOIN '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID)';

      EXECUTE IMMEDIATE V_SQL;


	--INSERT EN ECO_EXPEDIENTE_COMERCIAL

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL(
				ECO_ID,
				ECO_NUM_EXPEDIENTE,
				OFR_ID,
				DD_EEC_ID,
				ECO_FECHA_ALTA,
				ECO_FECHA_SANCION,
				ECO_FECHA_ANULACION,
				ECO_FECHA_CONT_PROPIETARIO,
				ECO_PETICIONARIO_ANULACION,
				ECO_IMP_DEV_ENTREGAS,
				ECO_FECHA_DEV_ENTREGAS,
				VERSION,
				USUARIOCREAR,
				FECHACREAR,
				USUARIOMODIFICAR,
				FECHAMODIFICAR,
				USUARIOBORRAR,
				FECHABORRAR,
				BORRADO,
				ECO_FECHA_INICIO_ALQUILER,
				ECO_FECHA_FIN_ALQUILER,
				ECO_IMPORTE_RENTA_ALQUILER,
				ECO_NUMERO_CONTRATO_ALQUILER,
				ECO_PLAZO_OPCION_COMPRA,
				ECO_PRIMA_OPCION_COMPRA,
				ECO_PRECIO_OPCION_COMPRA,
				ECO_CONDICIONES_OPCION_COMPRA,
				ECO_CONFLICTO_INTERESES,
				ECO_RIESGO_REPUTACIONAL,
				DD_COS_ID,
				DD_COS_ID_PROPUESTO,
				ECO_FECHA_SANCION_COMITE,
				ECO_ESTADO_PBC,
				ECO_FECHA_VENTA,
				DD_MAN_ID,
				ECO_BLOQUEADO,
				DD_MDE_ID,
				ECO_MDE_OTROS,
				DD_EEC_ID_ANT,
				TBJ_ID,
				DD_COS_ID_SUPERIOR,
				ECO_NECESITA_FINANCIACION,
				ECO_ASISTENCIA_PBC,
				ECO_ASISTENCIA_PBC_DESCRIPCION,
				DD_TAL_ID,
				ECO_TUBO_INQUILINO_DONE,
				DD_MAO_ID,
				DD_MRE_ID,
				DD_COA_ID,
				ECO_DOCUMENTACION_OK,
				ECO_FECHA_VALIDACION,
				ECO_FECHA_POSICIONAMIENTO_PREVISTA,
				ECO_CORRECW,
				ECO_COMOA3,
				ECO_DEVOL_AUTO_NUMBER,
				ECO_FECHA_RECOMENDACION_CES,
				ECO_ESTADO_PBC_R,
				ECO_FECHA_ENVIO_ADVISORY_NOTE,
				ECO_FECHA_CONT_VENTA,
				ECO_FECHA_GRAB_VENTA,
				DD_EEB_ID,
				ECO_ESTADO_ARRAS,
				ECO_ESTADO_CN,
				ECO_FECHA_RESER_DEPOS,
				ECO_FECHA_CONTAB,
				ECO_FECHA_FIRMA_CONT,
				ECO_NUM_PROTOCOLO,
				DD_MRA_ID,
				ECO_MESES_DURACION_CNT_ALQ,
				ECO_DETALLE_ANUL_ALQ,
				ECO_ID_ANTERIOR)

				SELECT DISTINCT
				AUX_ECO_ID.ECO_ID_NUEVO                    ECO_ID,
				ECO_EXP.ECO_NUM_EXPEDIENTE,
				AUX_OFR_ID.OFR_ID_NUEVO						OFR_ID,
				ECO_EXP.DD_EEC_ID,
				ECO_EXP.ECO_FECHA_ALTA,
				ECO_EXP.ECO_FECHA_SANCION,
				ECO_EXP.ECO_FECHA_ANULACION,
				ECO_EXP.ECO_FECHA_CONT_PROPIETARIO,
				ECO_EXP.ECO_PETICIONARIO_ANULACION,
				ECO_EXP.ECO_IMP_DEV_ENTREGAS,
				ECO_EXP.ECO_FECHA_DEV_ENTREGAS,
				''0''                                                    VERSION,
				''HREOS-16499''                                   	  USUARIOCREAR,
				SYSDATE                                                   FECHACREAR,
				NULL                                                      USUARIOMODIFICAR,
				NULL                                                      FECHAMODIFICAR,
				NULL                                                      USUARIOBORRAR,
				NULL                                                      FECHABORRAR,
				ECO_EXP.BORRADO                                                        BORRADO,
				ECO_EXP.ECO_FECHA_INICIO_ALQUILER,
				ECO_EXP.ECO_FECHA_FIN_ALQUILER,
				ECO_EXP.ECO_IMPORTE_RENTA_ALQUILER,
				ECO_EXP.ECO_NUMERO_CONTRATO_ALQUILER,
				ECO_EXP.ECO_PLAZO_OPCION_COMPRA,
				ECO_EXP.ECO_PRIMA_OPCION_COMPRA,
				ECO_EXP.ECO_PRECIO_OPCION_COMPRA,
				ECO_EXP.ECO_CONDICIONES_OPCION_COMPRA,
				ECO_EXP.ECO_CONFLICTO_INTERESES,
				ECO_EXP.ECO_RIESGO_REPUTACIONAL,
				ECO_EXP.DD_COS_ID,
				ECO_EXP.DD_COS_ID_PROPUESTO,
				ECO_EXP.ECO_FECHA_SANCION_COMITE,
				ECO_EXP.ECO_ESTADO_PBC,
				ECO_EXP.ECO_FECHA_VENTA,
				ECO_EXP.DD_MAN_ID,
				ECO_EXP.ECO_BLOQUEADO,
				ECO_EXP.DD_MDE_ID,
				ECO_EXP.ECO_MDE_OTROS,
				ECO_EXP.DD_EEC_ID_ANT,
				ECO_EXP.TBJ_ID,
				ECO_EXP.DD_COS_ID_SUPERIOR,
				ECO_EXP.ECO_NECESITA_FINANCIACION,
				ECO_EXP.ECO_ASISTENCIA_PBC,
				ECO_EXP.ECO_ASISTENCIA_PBC_DESCRIPCION,
				ECO_EXP.DD_TAL_ID,
				ECO_EXP.ECO_TUBO_INQUILINO_DONE,
				ECO_EXP.DD_MAO_ID,
				ECO_EXP.DD_MRE_ID,
				ECO_EXP.DD_COA_ID,
				ECO_EXP.ECO_DOCUMENTACION_OK,
				ECO_EXP.ECO_FECHA_VALIDACION,
				ECO_EXP.ECO_FECHA_POSICIONAMIENTO_PREVISTA,
				ECO_EXP.ECO_CORRECW,
				ECO_EXP.ECO_COMOA3,
				ECO_EXP.ECO_DEVOL_AUTO_NUMBER,
				ECO_EXP.ECO_FECHA_RECOMENDACION_CES,
				ECO_EXP.ECO_ESTADO_PBC_R,
				ECO_EXP.ECO_FECHA_ENVIO_ADVISORY_NOTE,
				ECO_EXP.ECO_FECHA_CONT_VENTA,
				ECO_EXP.ECO_FECHA_GRAB_VENTA,
				ECO_EXP.DD_EEB_ID,
				ECO_EXP.ECO_ESTADO_ARRAS,
				ECO_EXP.ECO_ESTADO_CN,
				ECO_EXP.ECO_FECHA_RESER_DEPOS,
				ECO_EXP.ECO_FECHA_CONTAB,
				ECO_EXP.ECO_FECHA_FIRMA_CONT,
				ECO_EXP.ECO_NUM_PROTOCOLO,
				ECO_EXP.DD_MRA_ID,
				ECO_EXP.ECO_MESES_DURACION_CNT_ALQ,
				ECO_EXP.ECO_DETALLE_ANUL_ALQ,
				ECO_EXP.ECO_ID_ANTERIOR

				FROM '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID 
				JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID 
				JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
				JOIN '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID
				JOIN '||V_ESQUEMA||'.AUX_ECO_ID AUX_ECO_ID ON AUX_ECO_ID.ECO_ID_VIEJO = ECO_EXP.ECO_ID';
      EXECUTE IMMEDIATE V_SQL;

	
--INSERT EN ECO_COND_CONDICIONES_ACTIVO

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.ECO_COND_CONDICIONES_ACTIVO  (
				COND_ID,
				DD_ETI_ID,
				COND_POSESION_INICIAL,
				DD_SIP_ID,
				COND_RENUNCIA_SNMTO_EVICCION,
				COND_RENUNCIA_SNMTO_VICIOS,
				ACT_ID,
				ECO_ID,
					VERSION,
					USUARIOCREAR,
					FECHACREAR,
					USUARIOMODIFICAR,
					FECHAMODIFICAR,
					USUARIOBORRAR,
					FECHABORRAR,
					BORRADO
					)
								
					SELECT 
					'||V_ESQUEMA||'.S_ECO_COND_CONDICIONES_ACTIVO.NEXTVAL                    COND_ID,
					ECO_COND.DD_ETI_ID,
					ECO_COND.COND_POSESION_INICIAL,
					ECO_COND.DD_SIP_ID,
					ECO_COND.COND_RENUNCIA_SNMTO_EVICCION,
					ECO_COND.COND_RENUNCIA_SNMTO_VICIOS,
					ACT2.ACT_ID,
					AUX_ECO_ID.ECO_ID_NUEVO                             ECO_ID,

					''0''                                                    VERSION,
					''HREOS-16499''                                   	  USUARIOCREAR,
					SYSDATE                                                   FECHACREAR,
					NULL                                                      USUARIOMODIFICAR,
					NULL                                                      FECHAMODIFICAR,
					NULL                                                      USUARIOBORRAR,
					NULL                                                      FECHABORRAR,
					ECO_COND.BORRADO                                                         BORRADO
					FROM '||V_ESQUEMA||'.AUX_ACT_TRASPASO_ACTIVO AUX
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON AUX.ACT_NUM_ACTIVO_ANT = ACT.ACT_NUM_ACTIVO
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT2 ON AUX.ACT_NUM_ACTIVO_NUV = ACT2.ACT_NUM_ACTIVO
					JOIN '||V_ESQUEMA||'.ACT_OFR ACT_OFR ON ACT.ACT_ID = ACT_OFR.ACT_ID
					JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON ACT_OFR.OFR_ID = OFR.OFR_ID    
					JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
					JOIN '||V_ESQUEMA||'.ECO_COND_CONDICIONES_ACTIVO ECO_COND ON ECO_COND.ECO_ID = ECO_EXP.ECO_ID AND ACT.ACT_ID = ECO_COND.ACT_ID
					JOIN '||V_ESQUEMA||'.AUX_ECO_ID AUX_ECO_ID ON AUX_ECO_ID.ECO_ID_VIEJO = ECO_EXP.ECO_ID';
      EXECUTE IMMEDIATE V_SQL;

  
  COMMIT;

  V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_ECO||''',''2''); END;';
  EXECUTE IMMEDIATE V_SENTENCIA;

  V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_ECO_COND||''',''2''); END;';
  EXECUTE IMMEDIATE V_SENTENCIA;






  
  
  
EXCEPTION

WHEN OTHERS THEN
     DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
     DBMS_OUTPUT.put_line('-----------------------------------------------------------');
     DBMS_OUTPUT.put_line(SQLERRM);
     ROLLBACK;
     RAISE;
END;
/

EXIT;
