--/*
--#########################################
--## AUTOR=Santi Monzó
--## FECHA_CREACION=20211203
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## ARTEFACTO=batch
--## INCIDENCIA_LINK=HREOS-16499
--## PRODUCTO=NO
--## 
--## Finalidad:
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
V_USUARIO VARCHAR2(50 CHAR) := 'HREOS-16499';
V_SQL VARCHAR2(30000 CHAR) := '';
V_NUM NUMBER(25);

--Tablas AUX
V_TABLA_AUX VARCHAR2(30 CHAR) := 'AUX_ACT_TRASPASO_ACTIVO';
V_TABLA_AUX1 VARCHAR2(30 CHAR) := 'AUX_OFR_ID';
V_TABLA_AUX2 VARCHAR2(30 CHAR) := 'AUX_ECO_ID';


--Tablas OFERTAS
V_TABLA_OFR VARCHAR2 (30 CHAR) := 'OFR_OFERTAS';
V_TABLA_ACT_OFR VARCHAR2 (30 CHAR) := 'ACT_OFR';
V_TABLA_ECO VARCHAR2 (30 CHAR) := 'ECO_EXPEDIENTE_COMERCIAL';
V_TABLA_ECO_COND VARCHAR2 (30 CHAR) := 'ECO_COND_CONDICIONES_ACTIVO';
V_TABLA_COE VARCHAR2 (30 CHAR) := 'COE_CONDICIONANTES_EXPEDIENTE';
V_TABLA_ACT_ECO VARCHAR2 (30 CHAR) := 'ACT_ECO_INFORME_JURIDICO';
V_SENTENCIA VARCHAR2(2600 CHAR);


BEGIN

	
	--INSERT EN COE_CONDICIONANTES_EXPEDIENTE

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.COE_CONDICIONANTES_EXPEDIENTE  (
				COE_ID,
				ECO_ID,
				COE_SOLICITA_FINANCIACION,
				COE_ENTIDAD_FINANCIACION_AJENA,
				COE_INICIO_EXPEDIENTE,
				COE_INICIO_FINANCIACION,
				COE_FIN_FINANCIACION,
				DD_ESF_ID,
				DD_TCC_ID,
				COE_PORCENTAJE_RESERVA,
				COE_PLAZO_FIRMA_RESERVA,
				COE_IMPORTE_RESERVA,
				DD_TIT_ID,
				COE_TIPO_APLICABLE,
				COE_RENUNCIA_EXENCION,
				COE_RESERVA_CON_IMPUESTO,
				COE_GASTOS_PLUSVALIA,
				DD_TPC_ID_PLUSVALIA,
				COE_GASTOS_NOTARIA,
				DD_TPC_ID_NOTARIA,
				COE_GASTOS_OTROS,
				DD_TPC_ID_GASTOS_OTROS,
				COE_FECHA_ACTUALIZACION_CARGAS,
				COE_CARGAS_IMPUESTOS,
				DD_TPC_ID_IMPUESTOS,
				COE_CARGAS_COMUNIDAD,
				DD_TPC_ID_COMUNIDAD,
				COE_CARGAS_OTROS,
				DD_TPC_ID_CARGAS_OTROS,
				COE_SUJETO_TANTEO_RETRACTO,
				COE_RENUNCIA_SNMTO_EVICCION,
				COE_RENUNCIA_SNMTO_VICIOS,
				COE_VPO,
				COE_LICENCIA,
				DD_TPC_ID_LICENCIA,
				COE_PROCEDE_DESCALIFICACION,
				DD_TPC_ID_DESCALIFICACION,
				VERSION,
				USUARIOCREAR,
				FECHACREAR,
				USUARIOMODIFICAR,
				FECHAMODIFICAR,
				USUARIOBORRAR,
				FECHABORRAR,
				BORRADO,
				COE_POSESION_INICIAL,
				DD_SIP_ID,
				DD_ETI_ID,
				COE_ESTADO_TRAMITE,
				COE_GASTOS_IBI,
				COE_GASTOS_COMUNIDAD,
				COE_GASTOS_SUMINISTROS,
				DD_TPC_ID_IBI,
				DD_TPC_ID_COMUNIDAD_ALQUILER,
				DD_TPC_ID_SUMINISTROS,
				COE_SOLICITA_RESERVA,
				COE_OPERACION_EXENTA,
				COE_INVERSION_SUJETO_PASIVO,
				ALQ_FIANZA_MESES,
				ALQ_FIANZA_IMPORTE,
				ALQ_FIANZA_ACTUALIZABLE,
				ALQ_DEPOSITO_MESES,
				ALQ_DEPOSITO_IMPORTE,
				ALQ_DEPOSITO_ACTUALIZABLE,
				ALQ_AVALISTA,
				ALQ_FIADOR_DOCUMENTO,
				ALQ_FIADOR_ENTIDAD_BANCARIA,
				ALQ_IMPORTE_AVAL,
				ALQ_RENUNCIA_TANTEO,
				ALQ_CARENCIA,
				ALQ_BONIFICACION,
				ALQ_GASTOS_REPERCUTIBLES,
				ALQ_NUMERO_AVAL,
				ALQ_RENTA_FIJO,
				ALQ_RENTA_PORCENTUAL,
				ALQ_RENTA_IPC,
				ALQ_RENTA_PORC_IMPUESTOS,
				ALQ_RENTA_REVISION_MERCADO,
				ALQ_RENTA_MERCADO_FECHA,
				ALQ_RENTA_MERCADO_CADA,
				ALQ_FECHA_FIJO,
				ALQ_FECHA_INC_RENTA,
				ALQ_CARENCIA_MESES,
				ALQ_CARENCIA_IMPORTE,
				ALQ_BONIFICACION_MESES,
				ALQ_BONIFICACION_IMPORTE,
				ALQ_BONIFICACION_DURACION,
				ALQ_REPERCUTIBLES_COMMENTS,
				ALQ_ENTIDAD_COMMENTS,
				ALQ_FECHA_FIRMA,
				COE_DEPOSITO_RESERVA,
				DD_ETF_ID,
				ID_FINANCIACION_BOARDING,
				COE_TRIBUTOS_PROPIEDAD
				)
				
				
				SELECT 
				'||V_ESQUEMA||'.S_COE_CONDICIONANTES_EXP.NEXTVAL                    COE_ID,
				AUX_ECO_ID.ECO_ID_NUEVO,
				COE.COE_SOLICITA_FINANCIACION,
				COE.COE_ENTIDAD_FINANCIACION_AJENA,
				COE.COE_INICIO_EXPEDIENTE,
				COE.COE_INICIO_FINANCIACION,
				COE.COE_FIN_FINANCIACION,
				COE.DD_ESF_ID,
				COE.DD_TCC_ID,
				COE.COE_PORCENTAJE_RESERVA,
				COE.COE_PLAZO_FIRMA_RESERVA,
				COE.COE_IMPORTE_RESERVA,
				COE.DD_TIT_ID,
				COE.COE_TIPO_APLICABLE,
				COE.COE_RENUNCIA_EXENCION,
				COE.COE_RESERVA_CON_IMPUESTO,
				COE.COE_GASTOS_PLUSVALIA,
				COE.DD_TPC_ID_PLUSVALIA,
				COE.COE_GASTOS_NOTARIA,
				COE.DD_TPC_ID_NOTARIA,
				COE.COE_GASTOS_OTROS,
				COE.DD_TPC_ID_GASTOS_OTROS,
				COE.COE_FECHA_ACTUALIZACION_CARGAS,
				COE.COE_CARGAS_IMPUESTOS,
				COE.DD_TPC_ID_IMPUESTOS,
				COE.COE_CARGAS_COMUNIDAD,
				COE.DD_TPC_ID_COMUNIDAD,
				COE.COE_CARGAS_OTROS,
				COE.DD_TPC_ID_CARGAS_OTROS,
				COE.COE_SUJETO_TANTEO_RETRACTO,
				COE.COE_RENUNCIA_SNMTO_EVICCION,
				COE.COE_RENUNCIA_SNMTO_VICIOS,
				COE.COE_VPO,
				COE.COE_LICENCIA,
				COE.DD_TPC_ID_LICENCIA,
				COE.COE_PROCEDE_DESCALIFICACION,
				COE.DD_TPC_ID_DESCALIFICACION,
				''0''                                                    VERSION,
				''HREOS-16499''                                   	  USUARIOCREAR,
				SYSDATE                                                   FECHACREAR,
				NULL                                                      USUARIOMODIFICAR,
				NULL                                                      FECHAMODIFICAR,
				NULL                                                      USUARIOBORRAR,
				NULL                                                      FECHABORRAR,
				COE.BORRADO                                                         BORRADO,  
				COE.COE_POSESION_INICIAL,
				COE.DD_SIP_ID,
				COE.DD_ETI_ID,
				COE.COE_ESTADO_TRAMITE,
				COE.COE_GASTOS_IBI,
				COE.COE_GASTOS_COMUNIDAD,
				COE.COE_GASTOS_SUMINISTROS,
				COE.DD_TPC_ID_IBI,
				COE.DD_TPC_ID_COMUNIDAD_ALQUILER,
				COE.DD_TPC_ID_SUMINISTROS,
				COE.COE_SOLICITA_RESERVA,
				COE.COE_OPERACION_EXENTA,
				COE.COE_INVERSION_SUJETO_PASIVO,
				COE.ALQ_FIANZA_MESES,
				COE.ALQ_FIANZA_IMPORTE,
				COE.ALQ_FIANZA_ACTUALIZABLE,
				COE.ALQ_DEPOSITO_MESES,
				COE.ALQ_DEPOSITO_IMPORTE,
				COE.ALQ_DEPOSITO_ACTUALIZABLE,
				COE.ALQ_AVALISTA,
				COE.ALQ_FIADOR_DOCUMENTO,
				COE.ALQ_FIADOR_ENTIDAD_BANCARIA,
				COE.ALQ_IMPORTE_AVAL,
				COE.ALQ_RENUNCIA_TANTEO,
				COE.ALQ_CARENCIA,
				COE.ALQ_BONIFICACION,
				COE.ALQ_GASTOS_REPERCUTIBLES,
				COE.ALQ_NUMERO_AVAL,
				COE.ALQ_RENTA_FIJO,
				COE.ALQ_RENTA_PORCENTUAL,
				COE.ALQ_RENTA_IPC,
				COE.ALQ_RENTA_PORC_IMPUESTOS,
				COE.ALQ_RENTA_REVISION_MERCADO,
				COE.ALQ_RENTA_MERCADO_FECHA,
				COE.ALQ_RENTA_MERCADO_CADA,
				COE.ALQ_FECHA_FIJO,
				COE.ALQ_FECHA_INC_RENTA,
				COE.ALQ_CARENCIA_MESES,
				COE.ALQ_CARENCIA_IMPORTE,
				COE.ALQ_BONIFICACION_MESES,
				COE.ALQ_BONIFICACION_IMPORTE,
				COE.ALQ_BONIFICACION_DURACION,
				COE.ALQ_REPERCUTIBLES_COMMENTS,
				COE.ALQ_ENTIDAD_COMMENTS,
				COE.ALQ_FECHA_FIRMA,
				COE.COE_DEPOSITO_RESERVA,
				COE.DD_ETF_ID,
				COE.ID_FINANCIACION_BOARDING,
				COE.COE_TRIBUTOS_PROPIEDAD
				
				FROM '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID 
				JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID 
				JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
				JOIN '||V_ESQUEMA||'.COE_CONDICIONANTES_EXPEDIENTE COE ON COE.ECO_ID = ECO_EXP.ECO_ID
				JOIN '||V_ESQUEMA||'.AUX_ECO_ID AUX_ECO_ID ON AUX_ECO_ID.ECO_ID_VIEJO = COE.ECO_ID
				';

      EXECUTE IMMEDIATE V_SQL;


	--INSERT EN ACT_ECO_INFORME_JURIDICO

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_ECO_INFORME_JURIDICO  (
				ACT_ECO_IJ_ID,   
				ECO_ID,
				ACT_ID,
				ACT_ECO_FECHA_EMISION,
				VERSION,
				USUARIOCREAR,
				FECHACREAR,
				USUARIOMODIFICAR,
				FECHAMODIFICAR,
				USUARIOBORRAR,
				FECHABORRAR,
				BORRADO

				)
				
				
				SELECT 
				'||V_ESQUEMA||'.S_ACT_ECO_INFORME_JURIDICO.NEXTVAL                  ACT_ECO_IJ_ID,   
				AUX_ECO_ID.ECO_ID_NUEVO                                         ECO_ID,
				ACT2.ACT_ID                                   ACT_ID,
				ACT_ECO.ACT_ECO_FECHA_EMISION                             ACT_ECO_FECHA_EMISION,
				''0''                                                       VERSION,
				''HREOS-16499''                                    	      USUARIOCREAR,
				SYSDATE                                                   FECHACREAR,
				NULL                                                      USUARIOMODIFICAR,
				NULL                                                      FECHAMODIFICAR,
				NULL                                                      USUARIOBORRAR,
				NULL                                                      FECHABORRAR,
				ACT_ECO.BORRADO                                                         BORRADO
				
				FROM '||V_ESQUEMA||'.AUX_ACT_TRASPASO_ACTIVO AUX
				JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON AUX.ACT_NUM_ACTIVO_ANT = ACT.ACT_NUM_ACTIVO
				JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT2 ON AUX.ACT_NUM_ACTIVO_NUV = ACT2.ACT_NUM_ACTIVO 
				JOIN '||V_ESQUEMA||'.ACT_OFR ACT_OFR ON ACT.ACT_ID = ACT_OFR.ACT_ID
				JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON ACT_OFR.OFR_ID = OFR.OFR_ID    
				JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
				JOIN '||V_ESQUEMA||'.ACT_ECO_INFORME_JURIDICO ACT_ECO ON ACT_ECO.ECO_ID = ECO_EXP.ECO_ID AND ACT.ACT_ID = ACT_ECO.ACT_ID
				JOIN '||V_ESQUEMA||'.AUX_ECO_ID AUX_ECO_ID ON AUX_ECO_ID.ECO_ID_VIEJO = ECO_EXP.ECO_ID';
      EXECUTE IMMEDIATE V_SQL;

	
  
  COMMIT;

  V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_COE||''',''2''); END;';
  EXECUTE IMMEDIATE V_SENTENCIA;

  V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_ACT_ECO||''',''2''); END;';
  EXECUTE IMMEDIATE V_SENTENCIA;






  
  
  
EXCEPTION

WHEN OTHERS THEN
     DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
     DBMS_OUTPUT.put_line('-----------------------------------------------------------');
     DBMS_OUTPUT.put_line(SQLERRM);
     ROLLBACK;
     RAISE;
END;
/

EXIT;
