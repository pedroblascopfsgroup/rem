--/*
--#########################################
--## AUTOR=Santi Monzó
--## FECHA_CREACION=20211203
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## ARTEFACTO=batch
--## INCIDENCIA_LINK=HREOS-16499
--## PRODUCTO=NO
--## 
--## Finalidad:
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
V_USUARIO VARCHAR2(50 CHAR) := 'HREOS-16499';
V_SQL VARCHAR2(30000 CHAR) := '';
V_NUM NUMBER(25);

--Tablas AUX
V_TABLA_AUX VARCHAR2(30 CHAR) := 'AUX_ACT_TRASPASO_ACTIVO';
V_TABLA_AUX1 VARCHAR2(30 CHAR) := 'AUX_OFR_ID';
V_TABLA_AUX2 VARCHAR2(30 CHAR) := 'AUX_ECO_ID';
V_TABLA_AUX3 VARCHAR2(30 CHAR) := 'AUX_COM_ID';


--Tablas OFERTAS
V_TABLA_OFR VARCHAR2 (30 CHAR) := 'OFR_OFERTAS';
V_TABLA_ACT_OFR VARCHAR2 (30 CHAR) := 'ACT_OFR';
V_TABLA_ECO VARCHAR2 (30 CHAR) := 'ECO_EXPEDIENTE_COMERCIAL';
V_TABLA_ECO_COND VARCHAR2 (30 CHAR) := 'ECO_COND_CONDICIONES_ACTIVO';
V_TABLA_COE VARCHAR2 (30 CHAR) := 'COE_CONDICIONANTES_EXPEDIENTE';
V_TABLA_ACT_ECO VARCHAR2 (30 CHAR) := 'ACT_ECO_INFORME_JURIDICO';
V_TABLA_COM VARCHAR2 (30 CHAR) := 'COM_COMPRADOR';
V_TABLA_CEX VARCHAR2 (30 CHAR) := 'CEX_COMPRADOR_EXPEDIENTE';
V_TABLA_FOR VARCHAR2 (30 CHAR) := 'FOR_FORMALIZACION';
V_SENTENCIA VARCHAR2(2600 CHAR);


BEGIN

	--INSERT EN AUX_COM_ID

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.AUX_COM_ID (
				COM_ID_VIEJO,
				COM_ID_NUEVO
				)
				SELECT 
						COM_ID_VIEJO,
						'||V_ESQUEMA||'.S_COM_COMPRADOR.NEXTVAL	COM_ID_NUEVO

						FROM(
						SELECT DISTINCT
						CEX.COM_ID AS COM_ID_VIEJO
					
				FROM '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID 
				JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID        
				JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
				JOIN '||V_ESQUEMA||'.CEX_COMPRADOR_EXPEDIENTE CEX ON CEX.ECO_ID = ECO_EXP.ECO_ID)';

      EXECUTE IMMEDIATE V_SQL;


	
	--INSERT EN COM_COMPRADOR

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.COM_COMPRADOR  (
				COM_ID,
				DD_TPE_ID,
				COM_NOMBRE,
				COM_APELLIDOS,
				DD_TDI_ID,
				COM_DOCUMENTO,
				COM_TELEFONO1,
				COM_TELEFONO2,
				COM_EMAIL,
				COM_DIRECCION,
				COM_CODIGO_POSTAL,
				VERSION,
				USUARIOCREAR,
				FECHACREAR,
				USUARIOMODIFICAR,
				FECHAMODIFICAR,
				USUARIOBORRAR,
				FECHABORRAR,
				BORRADO,
				CLC_ID,
				DD_LOC_ID,
				DD_PRV_ID,
				ID_COMPRADOR_URSUS,
				ID_COMPRADOR_URSUS_BH,
				COM_ENVIADO,
				COM_CESION_DATOS,
				COM_TRANSF_INTER,
				COM_COMUNI_TERCEROS,
				ID_PERSONA_HAYA,
				ADCOM_ID,
				PROBLEMAS_URSUS,
				NOMBRE_CONYUGE_URSUS,
				DD_ECV_ID_URSUS,
				DD_REM_ID_URSUS,
				N_URSUS_CONYUGE,
				COM_COD_COMPRADOR_DIVARIAN,
				COM_PRP,
				DD_PAI_NAC_ID,
				COM_FECHA_NACIOCONST,
				COM_FORMA_JURIDICA,
				DD_PRV_NAC_ID,
				IAP_ID,
				COM_FECHA_NACIMIENTO,
				DD_LOC_NAC_ID,
				COM_ID_PERSONA_HAYA_CAIXA
				)
					
				SELECT DISTINCT
				AUX_COM_ID.COM_ID_NUEVO    COM_ID,
				COMPR.DD_TPE_ID,
				COMPR.COM_NOMBRE,
				COMPR.COM_APELLIDOS,
				COMPR.DD_TDI_ID,
				NULL 					COM_DOCUMENTO,
				COMPR.COM_TELEFONO1,
				COMPR.COM_TELEFONO2,
				COMPR.COM_EMAIL,
				COMPR.COM_DIRECCION,
				COMPR.COM_CODIGO_POSTAL,
					''0''                                                    VERSION,
				''HREOS-16499''                                    	  USUARIOCREAR,
				SYSDATE                                                   FECHACREAR,
				NULL                                                      USUARIOMODIFICAR,
				NULL                                                      FECHAMODIFICAR,
				NULL                                                      USUARIOBORRAR,
				NULL                                                      FECHABORRAR,
				COMPR.BORRADO                                                         BORRADO,
					COMPR.CLC_ID,
				COMPR.DD_LOC_ID,
				COMPR.DD_PRV_ID,
				COMPR.ID_COMPRADOR_URSUS,
				COMPR.ID_COMPRADOR_URSUS_BH,
				COMPR.COM_ENVIADO,
				COMPR.COM_CESION_DATOS,
				COMPR.COM_TRANSF_INTER,
				COMPR.COM_COMUNI_TERCEROS,
				COMPR.ID_PERSONA_HAYA,
				COMPR.ADCOM_ID,
				COMPR.PROBLEMAS_URSUS,
				COMPR.NOMBRE_CONYUGE_URSUS,
				COMPR.DD_ECV_ID_URSUS,
				COMPR.DD_REM_ID_URSUS,
				COMPR.N_URSUS_CONYUGE,
				COMPR.COM_COD_COMPRADOR_DIVARIAN,
				COMPR.COM_PRP,
				COMPR.DD_PAI_NAC_ID,
				COMPR.COM_FECHA_NACIOCONST,
				COMPR.COM_FORMA_JURIDICA,
				COMPR.DD_PRV_NAC_ID,
				COMPR.IAP_ID,
				COMPR.COM_FECHA_NACIMIENTO,
				COMPR.DD_LOC_NAC_ID,
				COMPR.COM_ID_PERSONA_HAYA_CAIXA
				
				FROM '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID 
				JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID 
				JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
				JOIN '||V_ESQUEMA||'.CEX_COMPRADOR_EXPEDIENTE CEX ON CEX.ECO_ID = ECO_EXP.ECO_ID
				JOIN '||V_ESQUEMA||'.COM_COMPRADOR COMPR ON COMPR.COM_ID = CEX.COM_ID  
				JOIN '||V_ESQUEMA||'.AUX_COM_ID AUX_COM_ID ON AUX_COM_ID.COM_ID_VIEJO = COMPR.COM_ID';

      EXECUTE IMMEDIATE V_SQL;


	--INSERT EN CEX_COMPRADOR_EXPEDIENTE

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.CEX_COMPRADOR_EXPEDIENTE  (
				COM_ID,
				ECO_ID,
				DD_ECV_ID,
				DD_REM_ID,
				CEX_DOCUMENTO_CONYUGE,
				CEX_ANTIGUO_DEUDOR,
				CEX_RELACION_ANT_DEUDOR,
				DD_UAC_ID,
				CEX_IMPTE_PROPORCIONAL_OFERTA,
				CEX_IMPTE_FINANCIADO,
				CEX_RESPONSABLE_TRAMITACION,
				CEX_PORCION_COMPRA,
				CEX_TITULAR_RESERVA,
				CEX_TITULAR_CONTRATACION,
				CEX_NOMBRE_RTE,
				CEX_APELLIDOS_RTE,
				DD_TDI_ID_RTE,
				CEX_DOCUMENTO_RTE,
				CEX_TELEFONO1_RTE,
				CEX_TELEFONO2_RTE,
				CEX_EMAIL_RTE,
				CEX_DIRECCION_RTE,
				CEX_CODIGO_POSTAL_RTE,
				CEX_RELACION_HRE,
				DD_EPB_ID,
				CEX_FECHA_PETICION,
				CEX_FECHA_RESOLUCION,
				DD_LOC_ID_RTE,
				DD_PRV_ID_RTE,
				CEX_NUM_FACTURA,
				CEX_FECHA_FACTURA,
				DD_TGP_ID,
				CEX_FECHA_BAJA,
				DD_PAI_ID,
				DD_PAI_ID_RTE,
				CEX_ID_PERSONA_HAYA,
				DD_TPI_ID,
				ADCOM_ID,
				DD_TDI_ID_CONYUGE,
				CEX_CLI_URSUS_CONYUGE_REM,
				CEX_NUM_URSUS_CONYUGE_REM,
				CEX_NUM_URSUS_CONYUGE_BH_REM,
				VERSION,
				USUARIOCREAR,
				FECHACREAR,
				USUARIOMODIFICAR,
				FECHAMODIFICAR,
				USUARIOBORRAR,
				FECHABORRAR,
				BORRADO,
				CEX_C4C_ID,
				DD_ECL_ID,
				ECO_ECL_FECHA,
				CEX_USUFRUCTUARIO,
				CEX_SOCIEDAD,
				DD_VIC_ID,
				CEX_PRP,
				CEX_OFICINA_TRABAJO,
				DD_PRV_NAC_ID_REP,
				IAP_REPR_ID,
				CEX_FECHA_NACIMIENTO_REPR,
				CEX_LOC_NAC_REPR,
				DD_PAI_NAC_REPR_ID,
				DD_FIO_ID,
				DD_FIO_REPR_ID,
				DD_EIC_ID,
				DD_EIC_REPR_ID,
				CEX_ID_PERSONA_HAYA_REPR,
				CEX_ID_PERSONA_HAYA_CAIXA,
				CEX_ID_PERSONA_HAYA_CAIXA_REPR

				)
				
			
				
				SELECT DISTINCT
					AUX_COM_ID.COM_ID_NUEVO                 COM_ID,   
				AUX_ECO_ID.ECO_ID_NUEVO, 
				CEX.DD_ECV_ID,
				CEX.DD_REM_ID,
				CEX.CEX_DOCUMENTO_CONYUGE,
				CEX.CEX_ANTIGUO_DEUDOR,
				CEX.CEX_RELACION_ANT_DEUDOR,
				CEX.DD_UAC_ID,
				CEX.CEX_IMPTE_PROPORCIONAL_OFERTA,
				CEX.CEX_IMPTE_FINANCIADO,
				CEX.CEX_RESPONSABLE_TRAMITACION,
				CEX.CEX_PORCION_COMPRA,
				CEX.CEX_TITULAR_RESERVA,
				CEX.CEX_TITULAR_CONTRATACION,
				CEX.CEX_NOMBRE_RTE,
				CEX.CEX_APELLIDOS_RTE,
				CEX.DD_TDI_ID_RTE,
				CEX.CEX_DOCUMENTO_RTE,
				CEX.CEX_TELEFONO1_RTE,
				CEX.CEX_TELEFONO2_RTE,
				CEX.CEX_EMAIL_RTE,
				CEX.CEX_DIRECCION_RTE,
				CEX.CEX_CODIGO_POSTAL_RTE,
				CEX.CEX_RELACION_HRE,
				CEX.DD_EPB_ID,
				CEX.CEX_FECHA_PETICION,
				CEX.CEX_FECHA_RESOLUCION,
				CEX.DD_LOC_ID_RTE,
				CEX.DD_PRV_ID_RTE,
				CEX.CEX_NUM_FACTURA,
				CEX.CEX_FECHA_FACTURA,
				CEX.DD_TGP_ID,
				CEX.CEX_FECHA_BAJA,
				CEX.DD_PAI_ID,
				CEX.DD_PAI_ID_RTE,
				CEX.CEX_ID_PERSONA_HAYA,
				CEX.DD_TPI_ID,
				CEX.ADCOM_ID,
				CEX.DD_TDI_ID_CONYUGE,
				CEX.CEX_CLI_URSUS_CONYUGE_REM,
				CEX.CEX_NUM_URSUS_CONYUGE_REM,
				CEX.CEX_NUM_URSUS_CONYUGE_BH_REM,
				''0''                                                       VERSION,
				''HREOS-16499''                                    	      USUARIOCREAR,
				SYSDATE                                                   FECHACREAR,
				NULL                                                      USUARIOMODIFICAR,
				NULL                                                      FECHAMODIFICAR,
				NULL                                                      USUARIOBORRAR,
				NULL                                                      FECHABORRAR,
				0                                                         BORRADO,
				CEX.CEX_C4C_ID,
				CEX.DD_ECL_ID,
				CEX.ECO_ECL_FECHA,
				CEX.CEX_USUFRUCTUARIO,
				CEX.CEX_SOCIEDAD,
				CEX.DD_VIC_ID,
				CEX.CEX_PRP,
				CEX.CEX_OFICINA_TRABAJO,
				CEX.DD_PRV_NAC_ID_REP,
				CEX.IAP_REPR_ID,
				CEX.CEX_FECHA_NACIMIENTO_REPR,
				CEX.CEX_LOC_NAC_REPR,
				CEX.DD_PAI_NAC_REPR_ID,
				CEX.DD_FIO_ID,
				CEX.DD_FIO_REPR_ID,
				CEX.DD_EIC_ID,
				CEX.DD_EIC_REPR_ID,
				CEX.CEX_ID_PERSONA_HAYA_REPR,
				CEX.CEX_ID_PERSONA_HAYA_CAIXA,
				CEX.CEX_ID_PERSONA_HAYA_CAIXA_REPR

				
				FROM '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID 
				JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID 
				JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
				JOIN '||V_ESQUEMA||'.CEX_COMPRADOR_EXPEDIENTE CEX ON CEX.ECO_ID = ECO_EXP.ECO_ID
				JOIN '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID
				JOIN '||V_ESQUEMA||'.AUX_ECO_ID AUX_ECO_ID ON AUX_ECO_ID.ECO_ID_VIEJO = ECO_EXP.ECO_ID
				JOIN '||V_ESQUEMA||'.AUX_COM_ID AUX_COM_ID ON AUX_COM_ID.COM_ID_VIEJO = CEX.COM_ID';
      EXECUTE IMMEDIATE V_SQL;

	
	--INSERT EN FOR_FORMALIZACION

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.FOR_FORMALIZACION  (
				FOR_ID,
				ECO_ID,
				FOR_NOMBRE_NOTARIO,
				FOR_DIRECCION_NOTARIO,
				FOR_CONTACTO_NOTARIO,
				FOR_CONTACTO_CARGO,
				FOR_CONTACTO_EMAIL,
				FOR_CONTACTO_TELEFONO,
				FOR_PETICIONARIO,
				FOR_FECHA_PETICION,
				FOR_FECHA_RESOLUCION,
				FOR_FECHA_ESCRITURA,
				FOR_FECHA_CONTABILIZACION,
				FOR_FECHA_PAGO,
				FOR_IMPORTE,
				FOR_FORMA_PAGO,
				FOR_GASTOS_CARGO,
				FOR_MOTIVO_RESOLUCION,
				VERSION,
				USUARIOCREAR,
				FECHACREAR,
				USUARIOMODIFICAR,
				FECHAMODIFICAR,
				USUARIOBORRAR,
				FECHABORRAR,
				BORRADO,
				DD_TRC_ID,
				FOR_NUMEXPEDIENTE,
				FOR_CAPITALCONCEDIDO

				)
				
			SELECT   
				'||V_ESQUEMA||'.S_FOR_FORMALIZACION.NEXTVAL                  FOR_ID, 
				AUX_ECO_ID.ECO_ID_NUEVO,
				FORMA.FOR_NOMBRE_NOTARIO,
				FORMA.FOR_DIRECCION_NOTARIO,
				FORMA.FOR_CONTACTO_NOTARIO,
				FORMA.FOR_CONTACTO_CARGO,
				FORMA.FOR_CONTACTO_EMAIL,
				FORMA.FOR_CONTACTO_TELEFONO,
				FORMA.FOR_PETICIONARIO,
				FORMA.FOR_FECHA_PETICION,
				FORMA.FOR_FECHA_RESOLUCION,
				FORMA.FOR_FECHA_ESCRITURA,
				FORMA.FOR_FECHA_CONTABILIZACION,
				FORMA.FOR_FECHA_PAGO,
				FORMA.FOR_IMPORTE,
				FORMA.FOR_FORMA_PAGO,
				FORMA.FOR_GASTOS_CARGO,
				FORMA.FOR_MOTIVO_RESOLUCION,
				''0''                                                       VERSION,
				''HREOS-16499''                                    	      USUARIOCREAR,
				SYSDATE                                                   FECHACREAR,
				NULL                                                      USUARIOMODIFICAR,
				NULL                                                      FECHAMODIFICAR,
				NULL                                                      USUARIOBORRAR,
				NULL                                                      FECHABORRAR,
				FORMA.BORRADO,
				FORMA.DD_TRC_ID,
				FORMA.FOR_NUMEXPEDIENTE,
				FORMA.FOR_CAPITALCONCEDIDO
				
				FROM '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID 
				JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID 
				JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
				JOIN '||V_ESQUEMA||'.FOR_FORMALIZACION FORMA ON FORMA.ECO_ID = ECO_EXP.ECO_ID
				JOIN '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID
				JOIN '||V_ESQUEMA||'.AUX_ECO_ID AUX_ECO_ID ON AUX_ECO_ID.ECO_ID_VIEJO = ECO_EXP.ECO_ID';

      EXECUTE IMMEDIATE V_SQL;
  
  COMMIT;

  V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_COM||''',''2''); END;';
  EXECUTE IMMEDIATE V_SENTENCIA;

  V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_CEX||''',''2''); END;';
  EXECUTE IMMEDIATE V_SENTENCIA;

 V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_FOR||''',''2''); END;';
  EXECUTE IMMEDIATE V_SENTENCIA;




  
  
  
EXCEPTION

WHEN OTHERS THEN
     DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
     DBMS_OUTPUT.put_line('-----------------------------------------------------------');
     DBMS_OUTPUT.put_line(SQLERRM);
     ROLLBACK;
     RAISE;
END;
/

EXIT;
