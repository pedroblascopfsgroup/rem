--/*
--#########################################
--## AUTOR=Santi Monzó
--## FECHA_CREACION=20211203
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## ARTEFACTO=batch
--## INCIDENCIA_LINK=HREOS-16499
--## PRODUCTO=NO
--## 
--## Finalidad:
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
V_USUARIO VARCHAR2(50 CHAR) := 'HREOS-16499';
V_SQL VARCHAR2(30000 CHAR) := '';
V_NUM NUMBER(25);

--Tablas AUX
V_TABLA_AUX VARCHAR2(30 CHAR) := 'AUX_ACT_TRASPASO_ACTIVO';
V_TABLA_AUX1 VARCHAR2(30 CHAR) := 'AUX_OFR_ID';
V_TABLA_AUX2 VARCHAR2(30 CHAR) := 'AUX_ECO_ID';
V_TABLA_AUX3 VARCHAR2(30 CHAR) := 'AUX_COM_ID';
V_TABLA_AUX4 VARCHAR2(30 CHAR) := 'AUX_GEH_ID';
V_TABLA_AUX5 VARCHAR2(30 CHAR) := 'AUX_GEE_ID';

--Tablas OFERTAS

V_TABLA_GEX VARCHAR2 (30 CHAR) := 'GEX_GASTOS_EXPEDIENTE';
V_TABLA_POS VARCHAR2 (30 CHAR) := 'POS_POSICIONAMIENTO';
V_SENTENCIA VARCHAR2(2600 CHAR);


BEGIN


	
	--INSERT EN GEX_GASTOS_EXPEDIENTE

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.GEX_GASTOS_EXPEDIENTE  (
					GEX_ID,
					ECO_ID,
					DD_ACC_ID,
					GEX_CODIGO,
					GEX_NOMBRE,
					DD_TCC_ID,
					GEX_IMPORTE_CALCULO,
					GEX_IMPORTE_FINAL,
					GEX_PAGADOR,
					VERSION,
					USUARIOCREAR,
					FECHACREAR,
					USUARIOMODIFICAR,
					FECHAMODIFICAR,
					USUARIOBORRAR,
					FECHABORRAR,
					BORRADO,
					GEX_PROVEEDOR,
					GEX_OBSERVACIONES,
					GEX_APROBADO,
					DD_DEG_ID,
					DD_TPH_ID,
					ACT_ID,
					GEX_EDITADO,
					GEX_IMPORTE_ORIGINAL
					)
					
				
				WITH AUX_ACT_ID
									AS( 
										SELECT DISTINCT
					ACT.ACT_ID AS ACT_ID_VIEJO
					,ACT2.ACT_ID AS ACT_ID_NUEVO
					,(ROW_NUMBER () OVER (PARTITION BY ACT_OFR.OFR_ID ORDER BY ACT_OFR.OFR_ID DESC) )RN
					FROM '||V_ESQUEMA||'.AUX_ACT_TRASPASO_ACTIVO AUX
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON AUX.ACT_NUM_ACTIVO_ANT = ACT.ACT_NUM_ACTIVO
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT2 ON AUX.ACT_NUM_ACTIVO_NUV = ACT2.ACT_NUM_ACTIVO
					JOIN '||V_ESQUEMA||'.ACT_OFR ACT_OFR ON ACT.ACT_ID = ACT_OFR.ACT_ID 
					JOIN '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID ON AUX_OFR_ID.OFR_ID_VIEJO = ACT_OFR.OFR_ID
					JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID 
					JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
					JOIN '||V_ESQUEMA||'.GEX_GASTOS_EXPEDIENTE GEX ON GEX.ECO_ID = ECO_EXP.ECO_ID
					JOIN '||V_ESQUEMA||'.AUX_ECO_ID AUX_ECO_ID ON AUX_ECO_ID.ECO_ID_VIEJO = ECO_EXP.ECO_ID)
			
					SELECT 
					'||V_ESQUEMA||'.S_GEX_GASTOS_EXPEDIENTE.NEXTVAL GEX_ID,
					AUX_ECO_ID.ECO_ID_NUEVO,
					GEX.DD_ACC_ID,
					GEX.GEX_CODIGO,
					GEX.GEX_NOMBRE,
					GEX.DD_TCC_ID,
					GEX.GEX_IMPORTE_CALCULO,
					GEX.GEX_IMPORTE_FINAL,
					GEX.GEX_PAGADOR,
					''0''                                                    VERSION,
					''HREOS-16499''                                   	  USUARIOCREAR,
					SYSDATE                                                   FECHACREAR,
					NULL                                                      USUARIOMODIFICAR,
					NULL                                                      FECHAMODIFICAR,
					NULL                                                      USUARIOBORRAR,
					NULL                                                      FECHABORRAR,
					GEX.BORRADO,
					GEX.GEX_PROVEEDOR,
					GEX.GEX_OBSERVACIONES,
					GEX.GEX_APROBADO,
					GEX.DD_DEG_ID,
					GEX.DD_TPH_ID,
					AUX_ACT_ID.ACT_ID_NUEVO,
					GEX.GEX_EDITADO,
					GEX.GEX_IMPORTE_ORIGINAL  
					
					FROM '||V_ESQUEMA||'.AUX_ACT_TRASPASO_ACTIVO AUX
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON AUX.ACT_NUM_ACTIVO_ANT = ACT.ACT_NUM_ACTIVO 
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT2 ON AUX.ACT_NUM_ACTIVO_NUV = ACT2.ACT_NUM_ACTIVO 
					JOIN '||V_ESQUEMA||'.ACT_OFR ACT_OFR ON ACT.ACT_ID = ACT_OFR.ACT_ID
					JOIN '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID ON AUX_OFR_ID.OFR_ID_VIEJO = ACT_OFR.OFR_ID
					JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID 
					JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
					JOIN '||V_ESQUEMA||'.GEX_GASTOS_EXPEDIENTE GEX ON GEX.ECO_ID = ECO_EXP.ECO_ID
					JOIN '||V_ESQUEMA||'.AUX_ECO_ID AUX_ECO_ID ON AUX_ECO_ID.ECO_ID_VIEJO = ECO_EXP.ECO_ID 
					JOIN '||V_ESQUEMA||'.AUX_ACT_ID AUX_ACT_ID ON AUX_ACT_ID.ACT_ID_VIEJO = ACT.ACT_ID AND AUX_ACT_ID.RN = 1';

      EXECUTE IMMEDIATE V_SQL;


	--INSERT EN POS_POSICIONAMIENTO

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.POS_POSICIONAMIENTO  (
				POS_ID,
				ECO_ID,
				POS_FECHA_AVISO,
				POS_NOTARIA,
				POS_FECHA_POSICIONAMIENTO,
				POS_MOTIVO_APLAZAMIENTO,
				VERSION,
				USUARIOCREAR,
				FECHACREAR,
				USUARIOMODIFICAR,
				FECHAMODIFICAR,
				USUARIOBORRAR,
				FECHABORRAR,
				BORRADO,
				PVE_ID_NOTARIO,
				POS_FECHA_FIN_POSICIONAMIENTO,
				LUGAR_FIRMA,
				POS_FECHA_ENVIO,
				POS_FECHA_VALIDACION_BC,
				POS_OBSERVACIONES_BC,
				POS_OBSERVACIONES_REM,
				POS_VALIDACION_BC,
				DD_MAB_ID
					)
				SELECT 
					'||V_ESQUEMA||'.S_POS_POSICIONAMIENTO.NEXTVAL  POS_ID,
					AUX_ECO_ID.ECO_ID_NUEVO,
					POS.POS_FECHA_AVISO,
					POS.POS_NOTARIA,
					POS.POS_FECHA_POSICIONAMIENTO,
					POS.POS_MOTIVO_APLAZAMIENTO,
					''0''                                                    VERSION,
					''HREOS-16499''                                   	  USUARIOCREAR,
					SYSDATE                                                   FECHACREAR,
					NULL                                                      USUARIOMODIFICAR,
					NULL                                                      FECHAMODIFICAR,
					NULL                                                      USUARIOBORRAR,
					NULL                                                      FECHABORRAR,
					POS.BORRADO,
					POS.PVE_ID_NOTARIO,
					POS.POS_FECHA_FIN_POSICIONAMIENTO,
					POS.LUGAR_FIRMA,
					POS.POS_FECHA_ENVIO,
					POS.POS_FECHA_VALIDACION_BC,
					POS.POS_OBSERVACIONES_BC,
					POS.POS_OBSERVACIONES_REM,
					POS.POS_VALIDACION_BC,
					POS.DD_MAB_ID
					
					FROM '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID 
					JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID 
					JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
					JOIN '||V_ESQUEMA||'.POS_POSICIONAMIENTO POS ON POS.ECO_ID = ECO_EXP.ECO_ID
					JOIN '||V_ESQUEMA||'.AUX_ECO_ID AUX_ECO_ID ON AUX_ECO_ID.ECO_ID_VIEJO = POS.ECO_ID';

      EXECUTE IMMEDIATE V_SQL;
  
  COMMIT;

  V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_GEX||''',''2''); END;';
  EXECUTE IMMEDIATE V_SENTENCIA;

  V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_POS||''',''2''); END;';
  EXECUTE IMMEDIATE V_SENTENCIA;





  
  
  
EXCEPTION

WHEN OTHERS THEN
     DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
     DBMS_OUTPUT.put_line('-----------------------------------------------------------');
     DBMS_OUTPUT.put_line(SQLERRM);
     ROLLBACK;
     RAISE;
END;
/

EXIT;
