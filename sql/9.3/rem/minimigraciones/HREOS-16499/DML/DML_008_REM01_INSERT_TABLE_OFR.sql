--/*
--#########################################
--## AUTOR=Santi Monzó
--## FECHA_CREACION=20211203
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## ARTEFACTO=batch
--## INCIDENCIA_LINK=HREOS-16499
--## PRODUCTO=NO
--## 
--## Finalidad:
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE

V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
V_USUARIO VARCHAR2(50 CHAR) := 'HREOS-16499';
V_SQL VARCHAR2(30000 CHAR) := '';
V_NUM NUMBER(25);

--Tablas AUX
V_TABLA_AUX VARCHAR2(30 CHAR) := 'AUX_ACT_TRASPASO_ACTIVO';
V_TABLA_AUX1 VARCHAR2(30 CHAR) := 'AUX_OFR_ID';
V_TABLA_AUX2 VARCHAR2(30 CHAR) := 'AUX_ECO_ID';
V_TABLA_AUX3 VARCHAR2(30 CHAR) := 'AUX_COM_ID';
V_TABLA_AUX4 VARCHAR2(30 CHAR) := 'AUX_GEH_ID';
V_TABLA_AUX5 VARCHAR2(30 CHAR) := 'AUX_GEE_ID';

--Tablas OFERTAS

V_TABLA_RES VARCHAR2 (30 CHAR) := 'RES_RESERVAS';
V_TABLA_OEX VARCHAR2 (30 CHAR) := 'OEX_OBS_EXPEDIENTE';
V_SENTENCIA VARCHAR2(2600 CHAR);


BEGIN


	
	--INSERT EN RES_RESERVAS

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.RES_RESERVAS  (
				RES_ID,
				ECO_ID,
				RES_NUM_RESERVA,
				RES_FECHA_ENVIO,
				RES_FECHA_FIRMA,
				RES_FECHA_VENCIMIENTO,
				RES_FECHA_ANULACION,
				RES_MOTIVO_ANULACION,
				DD_TAR_ID,
				DD_ERE_ID,
				VERSION,
				USUARIOCREAR,
				FECHACREAR,
				USUARIOMODIFICAR,
				FECHAMODIFICAR,
				USUARIOBORRAR,
				FECHABORRAR,
				BORRADO,
				RES_FECHA_SOLICITUD,
				RES_FECHA_RESOLUCION,
				RES_IND_IMP_ANULACION,
				RES_IMPORTE_DEVUELTO,
				DD_EDE_ID,
				DD_MAN_ID,
				DD_MAR_ID,
				DD_DER_ID,
				RES_FECHA_CONTABILIZACION,
				RES_FECHA_VIGENCIA_ARRAS,
				RES_FECHA_AMPLIACION_ARRAS,
				RES_SOLICITUD_AMPLIACION_ARRAS,
				DD_MAA_ID,
				RES_FECHA_PROR_PROP_ARRAS,
				RES_FECHA_COM_CLIENTE,
				RES_FECHA_COM_CLIENTE_RESC,
				RES_FECHA_RESCISION,
				RES_FECHA_CONT_ARRAS
					)
					SELECT
					'||V_ESQUEMA||'.S_RES_RESERVAS.NEXTVAL  RES_ID,
					AUX_ECO_ID.ECO_ID_NUEVO,
					RES.RES_NUM_RESERVA,
					RES.RES_FECHA_ENVIO,
					RES.RES_FECHA_FIRMA,
					RES.RES_FECHA_VENCIMIENTO,
					RES.RES_FECHA_ANULACION,
					RES.RES_MOTIVO_ANULACION,
					RES.DD_TAR_ID,
					RES.DD_ERE_ID,
					''0''                                                    VERSION,
					''HREOS-16499''                                   	  USUARIOCREAR,
					SYSDATE                                                   FECHACREAR,
					NULL                                                      USUARIOMODIFICAR,
					NULL                                                      FECHAMODIFICAR,
					NULL                                                      USUARIOBORRAR,
					NULL                                                      FECHABORRAR,
					RES.BORRADO,
					RES.RES_FECHA_SOLICITUD,
					RES.RES_FECHA_RESOLUCION,
					RES.RES_IND_IMP_ANULACION,
					RES.RES_IMPORTE_DEVUELTO,
					RES.DD_EDE_ID,
					RES.DD_MAN_ID,
					RES.DD_MAR_ID,
					RES.DD_DER_ID,
					RES.RES_FECHA_CONTABILIZACION,
					RES.RES_FECHA_VIGENCIA_ARRAS,
					RES.RES_FECHA_AMPLIACION_ARRAS,
					RES.RES_SOLICITUD_AMPLIACION_ARRAS,
					RES.DD_MAA_ID,
					RES.RES_FECHA_PROR_PROP_ARRAS,
					RES.RES_FECHA_COM_CLIENTE,
					RES.RES_FECHA_COM_CLIENTE_RESC,
					RES.RES_FECHA_RESCISION,
					RES.RES_FECHA_CONT_ARRAS
					
					FROM '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID 
					JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID 
					JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
					JOIN '||V_ESQUEMA||'.RES_RESERVAS RES ON RES.ECO_ID = ECO_EXP.ECO_ID
					JOIN '||V_ESQUEMA||'.AUX_ECO_ID AUX_ECO_ID ON AUX_ECO_ID.ECO_ID_VIEJO = RES.ECO_ID';

      EXECUTE IMMEDIATE V_SQL;


	--INSERT EN POS_POSICIONAMIENTO

	V_SQL := 'INSERT INTO '||V_ESQUEMA||'.OEX_OBS_EXPEDIENTE  (
				OEX_ID,
				ECO_ID,
				USU_ID,
				OEX_OBSERVACION,
				OEX_FECHA,
				VERSION,
				USUARIOCREAR,
				FECHACREAR,
				USUARIOMODIFICAR,
				FECHAMODIFICAR,
				USUARIOBORRAR,
				FECHABORRAR,
				BORRADO
					)

					SELECT 
					'||V_ESQUEMA||'.S_OEX_OBS_EXPEDIENTE.NEXTVAL  OEX_ID,
					AUX_ECO_ID.ECO_ID_NUEVO,
					OEX.USU_ID,
					OEX.OEX_OBSERVACION,
					OEX.OEX_FECHA,
					''0''                                                    VERSION,
					''HREOS-16499''                                   	  USUARIOCREAR,
					SYSDATE                                                   FECHACREAR,
					NULL                                                      USUARIOMODIFICAR,
					NULL                                                      FECHAMODIFICAR,
					NULL                                                      USUARIOBORRAR,
					NULL                                                      FECHABORRAR,
					OEX.BORRADO
					
					FROM '||V_ESQUEMA||'.AUX_OFR_ID AUX_OFR_ID 
					JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON AUX_OFR_ID.OFR_ID_VIEJO = OFR.OFR_ID 
					JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO_EXP ON ECO_EXP.OFR_ID = OFR.OFR_ID
					JOIN '||V_ESQUEMA||'.OEX_OBS_EXPEDIENTE OEX ON OEX.ECO_ID = ECO_EXP.ECO_ID
					JOIN '||V_ESQUEMA||'.AUX_ECO_ID AUX_ECO_ID ON AUX_ECO_ID.ECO_ID_VIEJO = OEX.ECO_ID';

      EXECUTE IMMEDIATE V_SQL;
  
  COMMIT;

  V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_RES||''',''2''); END;';
  EXECUTE IMMEDIATE V_SENTENCIA;

  V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_OEX||''',''2''); END;';
  EXECUTE IMMEDIATE V_SENTENCIA;





  
  
  
EXCEPTION

WHEN OTHERS THEN
     DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
     DBMS_OUTPUT.put_line('-----------------------------------------------------------');
     DBMS_OUTPUT.put_line(SQLERRM);
     ROLLBACK;
     RAISE;
END;
/

EXIT;
