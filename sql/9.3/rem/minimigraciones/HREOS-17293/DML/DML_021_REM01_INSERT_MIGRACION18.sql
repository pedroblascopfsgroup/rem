--/*
--#########################################
--## AUTOR=Santi Monzó
--## FECHA_CREACION=20211117
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## ARTEFACTO=batch
--## INCIDENCIA_LINK=HREOS-17293
--## PRODUCTO=NO
--## 
--## Finalidad:
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE



	V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
	V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER';
	V_USUARIO VARCHAR2(50 CHAR) := 'HREOS-17293';
	V_SQL VARCHAR2(4500 CHAR) := '';
	V_NUM NUMBER(25);
	V_SENTENCIA VARCHAR2(4000 CHAR);
	TABLE_COUNT NUMBER(10,0) := 0;
	
	V_TABLA_ACT VARCHAR2 (30 CHAR) := 'ACT_ACTIVO';
	V_TABLA_AGA VARCHAR2 (30 CHAR) := 'ACT_AGA_AGRUPACION_ACTIVO';
	V_TABLA_AGR VARCHAR2 (30 CHAR) := 'ACT_AGR_AGRUPACION';
	V_TABLA_AUX VARCHAR2 (30 CHAR) := 'AUX_ACT_TRASPASO_ACTIVO';

	V_TABLA VARCHAR2 (30 CHAR) := 'ACT_ASI_ASISTIDA';
	V_TABLA_2 VARCHAR2 (30 CHAR) := 'ACT_LCO_LOTE_COMERCIAL';
	V_TABLA_3 VARCHAR2 (30 CHAR) := 'ACT_ONV_OBRA_NUEVA';
	V_TABLA_4 VARCHAR2 (30 CHAR) := 'ACT_RES_RESTRINGIDA';
	V_TABLA_5 VARCHAR2 (30 CHAR) := 'ACT_RAL_RESTRINGIDA_ALQUILER';
	V_TABLA_6 VARCHAR2 (30 CHAR) := 'ACT_ROB_RESTRINGIDA_OBREM';
	V_TABLA_7 VARCHAR2 (30 CHAR) := 'ACT_PRY_PROYECTO';
	V_TABLA_8 VARCHAR2 (30 CHAR) := 'ACT_PAL_PROMOCION_ALQUILER';

	V_TABLA_AUX_MIG VARCHAR2 (30 CHAR) := 'AUX_SEGUIR_MIGRACION';
	V_TABLA_AUX_2 VARCHAR2 (30 CHAR) := 'AUX_AGA_AGR';

	

BEGIN
      
      DBMS_OUTPUT.PUT_LINE('[INICIO]');

     V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA_AUX_MIG||' WHERE SEGUIR_MIGRACION = 0';
    EXECUTE IMMEDIATE V_SQL INTO V_NUM;
    
    IF V_NUM > 0  THEN
        
        DBMS_OUTPUT.PUT_LINE('[INFO] YA HAY ACTIVOS INSERTADOS EN ACT_ACTIVO DE LOS QUE SE QUIEREN INSERTAR');
        
    ELSE 


DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'. [ACT_ASI_ASISTIDA ]');

	
	EXECUTE IMMEDIATE ('
	INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (

	AGR_ID
	,DD_PRV_ID
	,DD_LOC_ID
	,DD_EAS_ID
	,ASI_DIRECCION
	,ASI_CP
	,ASI_ACREEDOR_PDV
	)

	SELECT DISTINCT
	AUX_AGA_AGR.AGR_ID_NUEVO  		                AGR_ID
    ,ASI.DD_PRV_ID
    ,ASI.DD_LOC_ID
    ,ASI.DD_EAS_ID
    ,ASI.ASI_DIRECCION
    ,ASI.ASI_CP
    ,ASI.ASI_ACREEDOR_PDV

	FROM '||V_ESQUEMA||'.'||V_TABLA_AUX||' AUX
	JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT ON AUX.ACT_NUM_ACTIVO_ANT = ACT.ACT_NUM_ACTIVO 
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA ON ACT.ACT_ID = AGA.ACT_ID
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGR||' AGR ON AGR.AGR_ID = AGA.AGR_ID AND agr.BORRADO=0
    JOIN '||V_ESQUEMA||'.'||V_TABLA||' ASI ON ASI.AGR_ID = AGR.AGR_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT2 ON AUX.ACT_NUM_ACTIVO_NUV = ACT2.ACT_NUM_ACTIVO
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA2 ON ACT2.ACT_ID = AGA2.ACT_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AUX_2||' AUX_AGA_AGR ON AUX_AGA_AGR.AGR_ID_VIEJO = AGR.AGR_ID
	')
  ;
    
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' cargada. '||SQL%ROWCOUNT||' Filas.');


  COMMIT;
  
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA||''',''1''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA||' ANALIZADA.');




DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA_2||'. [ACT_LCO_LOTE_COMERCIAL ]');

	
	EXECUTE IMMEDIATE ('
	INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_2||' (

	AGR_ID
	,DD_PRV_ID
	,DD_LOC_ID
	,DD_ELC_ID
	,LCO_DIRECCION
	,LCO_ACREEDOR_PDV
	,LCO_GESTORIA_FORMALIZACION
	,LCO_GESTOR_COMERCIAL
	,LCO_GESTOR_FORMALIZACION
	,LCO_GESTOR_COMER_BACK_OFFICE
	,LCO_CP
	)

	SELECT DISTINCT
	AUX_AGA_AGR.AGR_ID_NUEVO  		                AGR_ID
	,LCO.DD_PRV_ID
	,LCO.DD_LOC_ID
	,LCO.DD_ELC_ID
	,LCO.LCO_DIRECCION
	,LCO.LCO_ACREEDOR_PDV
	,LCO.LCO_GESTORIA_FORMALIZACION
	,LCO.LCO_GESTOR_COMERCIAL
	,LCO.LCO_GESTOR_FORMALIZACION
	,LCO.LCO_GESTOR_COMER_BACK_OFFICE
	,LCO.LCO_CP

	FROM '||V_ESQUEMA||'.'||V_TABLA_AUX||' AUX
	JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT ON AUX.ACT_NUM_ACTIVO_ANT = ACT.ACT_NUM_ACTIVO 
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA ON ACT.ACT_ID = AGA.ACT_ID
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGR||' AGR ON AGR.AGR_ID = AGA.AGR_ID AND agr.BORRADO=0
    JOIN '||V_ESQUEMA||'.'||V_TABLA_2||' LCO ON LCO.AGR_ID = AGR.AGR_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT2 ON AUX.ACT_NUM_ACTIVO_NUV = ACT2.ACT_NUM_ACTIVO
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA2 ON ACT2.ACT_ID = AGA2.ACT_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AUX_2||' AUX_AGA_AGR ON AUX_AGA_AGR.AGR_ID_VIEJO = AGR.AGR_ID
	')
  ;
    
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_2||' cargada. '||SQL%ROWCOUNT||' Filas.');


  COMMIT;
  
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_2||''',''1''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_2||' ANALIZADA.');



DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA_3||'. [ACT_ONV_OBRA_NUEVA ]');

	
	EXECUTE IMMEDIATE ('
	INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_3||' (

	AGR_ID
	,DD_PRV_ID
	,DD_LOC_ID
	,DD_EON_ID
	,ONV_DIRECCION
	,ONV_ACREEDOR_PDV
	,ONV_CP
	,ONV_VENTA_PLANO
	)

	SELECT DISTINCT
	AUX_AGA_AGR.AGR_ID_NUEVO  		                AGR_ID
	,ONV.DD_PRV_ID
	,ONV.DD_LOC_ID
	,ONV.DD_EON_ID
	,ONV.ONV_DIRECCION
	,ONV.ONV_ACREEDOR_PDV
	,ONV.ONV_CP
	,ONV.ONV_VENTA_PLANO

	FROM '||V_ESQUEMA||'.'||V_TABLA_AUX||' AUX
	JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT ON AUX.ACT_NUM_ACTIVO_ANT = ACT.ACT_NUM_ACTIVO 
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA ON ACT.ACT_ID = AGA.ACT_ID
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGR||' AGR ON AGR.AGR_ID = AGA.AGR_ID AND agr.BORRADO=0
    JOIN '||V_ESQUEMA||'.'||V_TABLA_3||' ONV ON ONV.AGR_ID = AGR.AGR_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT2 ON AUX.ACT_NUM_ACTIVO_NUV = ACT2.ACT_NUM_ACTIVO
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA2 ON ACT2.ACT_ID = AGA2.ACT_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AUX_2||' AUX_AGA_AGR ON AUX_AGA_AGR.AGR_ID_VIEJO = AGR.AGR_ID
	')
  ;
    
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_3||' cargada. '||SQL%ROWCOUNT||' Filas.');


  COMMIT;
  
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_3||''',''1''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_3||' ANALIZADA.');




DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA_4||'. [ACT_RES_RESTRINGIDA ]');

	
	EXECUTE IMMEDIATE ('
	INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_4||' (

    AGR_ID
    ,DD_PRV_ID
    ,DD_LOC_ID
    ,RES_DIRECCION
    ,RES_ACREEDOR_PDV
    ,RES_CP
	)

	SELECT DISTINCT
	AUX_AGA_AGR.AGR_ID_NUEVO  		                AGR_ID
    ,RES.DD_PRV_ID
    ,RES.DD_LOC_ID
    ,RES.RES_DIRECCION
    ,RES.RES_ACREEDOR_PDV
    ,RES.RES_CP

	FROM '||V_ESQUEMA||'.'||V_TABLA_AUX||' AUX
	JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT ON AUX.ACT_NUM_ACTIVO_ANT = ACT.ACT_NUM_ACTIVO 
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA ON ACT.ACT_ID = AGA.ACT_ID
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGR||' AGR ON AGR.AGR_ID = AGA.AGR_ID AND agr.BORRADO=0
    JOIN '||V_ESQUEMA||'.'||V_TABLA_4||' RES ON RES.AGR_ID = AGR.AGR_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT2 ON AUX.ACT_NUM_ACTIVO_NUV = ACT2.ACT_NUM_ACTIVO
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA2 ON ACT2.ACT_ID = AGA2.ACT_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AUX_2||' AUX_AGA_AGR ON AUX_AGA_AGR.AGR_ID_VIEJO = AGR.AGR_ID
	')
  ;
    
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_4||' cargada. '||SQL%ROWCOUNT||' Filas.');


  COMMIT;
  
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_4||''',''1''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_4||' ANALIZADA.');



DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA_5||'. [ACT_RAL_RESTRINGIDA_ALQUILER ]');

	
	EXECUTE IMMEDIATE ('
	INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_5||' (

    AGR_ID
    ,DD_PRV_ID
    ,DD_LOC_ID
    ,RAL_DIRECCION
    ,RAL_ACREEDOR_PDV
    ,RAL_CP
	)

	SELECT DISTINCT
	AUX_AGA_AGR.AGR_ID_NUEVO  		                AGR_ID
    ,RAL.DD_PRV_ID
    ,RAL.DD_LOC_ID
    ,RAL.RAL_DIRECCION
    ,RAL.RAL_ACREEDOR_PDV
    ,RAL.RAL_CP

	FROM '||V_ESQUEMA||'.'||V_TABLA_AUX||' AUX
	JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT ON AUX.ACT_NUM_ACTIVO_ANT = ACT.ACT_NUM_ACTIVO 
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA ON ACT.ACT_ID = AGA.ACT_ID
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGR||' AGR ON AGR.AGR_ID = AGA.AGR_ID AND agr.BORRADO=0
    JOIN '||V_ESQUEMA||'.'||V_TABLA_5||' RAL ON RAL.AGR_ID = AGR.AGR_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT2 ON AUX.ACT_NUM_ACTIVO_NUV = ACT2.ACT_NUM_ACTIVO
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA2 ON ACT2.ACT_ID = AGA2.ACT_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AUX_2||' AUX_AGA_AGR ON AUX_AGA_AGR.AGR_ID_VIEJO = AGR.AGR_ID
	')
  ;
    
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_5||' cargada. '||SQL%ROWCOUNT||' Filas.');


  COMMIT;
  
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_5||''',''1''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_5||' ANALIZADA.');



	  DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA_6||'. [ACT_ROB_RESTRINGIDA_OBREM ]');

	
	EXECUTE IMMEDIATE ('
	INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_6||' (

    AGR_ID
    ,DD_PRV_ID
    ,DD_LOC_ID
    ,ROB_DIRECCION
    ,ROB_ACREEDOR_PDV
    ,ROB_CP
	)

	SELECT DISTINCT
	AUX_AGA_AGR.AGR_ID_NUEVO  		                AGR_ID
    ,DD_PRV_ID
    ,DD_LOC_ID
    ,ROB_DIRECCION
    ,ROB_ACREEDOR_PDV
    ,ROB_CP

	FROM '||V_ESQUEMA||'.'||V_TABLA_AUX||' AUX
	JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT ON AUX.ACT_NUM_ACTIVO_ANT = ACT.ACT_NUM_ACTIVO 
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA ON ACT.ACT_ID = AGA.ACT_ID
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGR||' AGR ON AGR.AGR_ID = AGA.AGR_ID AND agr.BORRADO=0
    JOIN '||V_ESQUEMA||'.'||V_TABLA_6||' ROB ON ROB.AGR_ID = AGR.AGR_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT2 ON AUX.ACT_NUM_ACTIVO_NUV = ACT2.ACT_NUM_ACTIVO
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA2 ON ACT2.ACT_ID = AGA2.ACT_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AUX_2||' AUX_AGA_AGR ON AUX_AGA_AGR.AGR_ID_VIEJO = AGR.AGR_ID
	')
  ;
    
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_6||' cargada. '||SQL%ROWCOUNT||' Filas.');


  COMMIT;
  
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_6||''',''1''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_6||' ANALIZADA.');



	  DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA_7||'. [ACT_PRY_PROYECTO ]');

	
	EXECUTE IMMEDIATE ('
	INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_7||' (

    AGR_ID
    ,DD_PRV_ID
    ,DD_LOC_ID
    ,PRY_DIRECCION
    ,PRY_ACREEDOR_PDV
    ,PRY_CP
    ,DD_TPA_ID
    ,DD_SAC_ID
    ,DD_EAC_ID
    ,PRY_GESTOR_ACTIVO
    ,PRY_DOBLE_GESTOR_ACTIVO
    ,PRY_GESTOR_COMERCIAL
    ,DD_CRA_ID
	)

	SELECT DISTINCT
	AUX_AGA_AGR.AGR_ID_NUEVO  		                AGR_ID
    ,PRY.DD_PRV_ID
    ,PRY.DD_LOC_ID
    ,PRY.PRY_DIRECCION
    ,PRY.PRY_ACREEDOR_PDV
    ,PRY.PRY_CP
    ,PRY.DD_TPA_ID
    ,PRY.DD_SAC_ID
    ,PRY.DD_EAC_ID
    ,PRY.PRY_GESTOR_ACTIVO
    ,PRY.PRY_DOBLE_GESTOR_ACTIVO
    ,PRY.PRY_GESTOR_COMERCIAL
    ,PRY.DD_CRA_ID

	FROM '||V_ESQUEMA||'.'||V_TABLA_AUX||' AUX
	JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT ON AUX.ACT_NUM_ACTIVO_ANT = ACT.ACT_NUM_ACTIVO 
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA ON ACT.ACT_ID = AGA.ACT_ID
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGR||' AGR ON AGR.AGR_ID = AGA.AGR_ID AND agr.BORRADO=0
    JOIN '||V_ESQUEMA||'.'||V_TABLA_7||' PRY ON PRY.AGR_ID = AGR.AGR_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT2 ON AUX.ACT_NUM_ACTIVO_NUV = ACT2.ACT_NUM_ACTIVO
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA2 ON ACT2.ACT_ID = AGA2.ACT_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AUX_2||' AUX_AGA_AGR ON AUX_AGA_AGR.AGR_ID_VIEJO = AGR.AGR_ID
	')
  ;
    
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_7||' cargada. '||SQL%ROWCOUNT||' Filas.');


  COMMIT;
  
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_7||''',''1''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_7||' ANALIZADA.');




	  DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA_8||'. [ACT_PAL_PROMOCION_ALQUILER ]');

	
	EXECUTE IMMEDIATE ('
	INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_8||' (

    AGR_ID
    ,DD_PRV_ID
    ,DD_LOC_ID
    ,PAL_DIRECCION
    ,PAL_CP
	)

	SELECT DISTINCT
	AUX_AGA_AGR.AGR_ID_NUEVO  		                AGR_ID
    ,PAL.DD_PRV_ID
    ,PAL.DD_LOC_ID
    ,PAL.PAL_DIRECCION
    ,PAL.PAL_CP

	FROM '||V_ESQUEMA||'.'||V_TABLA_AUX||' AUX
	JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT ON AUX.ACT_NUM_ACTIVO_ANT = ACT.ACT_NUM_ACTIVO 
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA ON ACT.ACT_ID = AGA.ACT_ID
	JOIN '||V_ESQUEMA||'.'||V_TABLA_AGR||' AGR ON AGR.AGR_ID = AGA.AGR_ID AND agr.BORRADO=0
    JOIN '||V_ESQUEMA||'.'||V_TABLA_8||' PAL ON PAL.AGR_ID = AGR.AGR_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_ACT||' ACT2 ON AUX.ACT_NUM_ACTIVO_NUV = ACT2.ACT_NUM_ACTIVO
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AGA||' AGA2 ON ACT2.ACT_ID = AGA2.ACT_ID
    JOIN '||V_ESQUEMA||'.'||V_TABLA_AUX_2||' AUX_AGA_AGR ON AUX_AGA_AGR.AGR_ID_VIEJO = AGR.AGR_ID
	')
  ;
    
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA_8||' cargada. '||SQL%ROWCOUNT||' Filas.');

  END IF;
  COMMIT;
  
      V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA_8||''',''1''); END;';
      EXECUTE IMMEDIATE V_SENTENCIA;
      DBMS_OUTPUT.PUT_LINE('[INFO] '||V_ESQUEMA||'.'||V_TABLA_8||' ANALIZADA.');

      DBMS_OUTPUT.PUT_LINE('[FIN]');
      
EXCEPTION
      WHEN OTHERS THEN
            DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
            DBMS_OUTPUT.put_line('-----------------------------------------------------------');
            DBMS_OUTPUT.put_line(SQLERRM);
            ROLLBACK;
            RAISE;
END;

/

EXIT;