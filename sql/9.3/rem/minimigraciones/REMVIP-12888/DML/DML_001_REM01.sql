--/*
--#########################################
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20230103
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-12888
--## PRODUCTO=NO
--## 
--## Finalidad: Script que MODIFICA en GESTORES.
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	
	V_TABLA_TMP VARCHAR2(50 CHAR) := 'AUX_REMVIP_12233'; -- Variable para tabla 	
	V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_MSQL VARCHAR2(4000 CHAR);--Variable para consultar la existencia de registros en la tabla
	V_NUM NUMBER(16); --Variable para comprobar si existen registros
	PL_OUTPUT VARCHAR2(32000 CHAR);
	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-12888';
	

BEGIN

	DBMS_OUTPUT.PUT_LINE('[INICIO]'||CHR(10));		

	-- Comprobar que existen los activos
    V_MSQL := 'SELECT COUNT (1) FROM '||V_ESQUEMA||'.'||V_TABLA_TMP||' WHERE ACT_NUM_ACTIVO IN
            (SELECT ACT_NUM_ACTIVO FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE BORRADO = 0)';
	EXECUTE IMMEDIATE V_MSQL INTO V_NUM;
	
	IF V_NUM > 0 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO] Se han encontrado '||V_NUM||' registros en la tabla de activos');	

		DBMS_OUTPUT.PUT_LINE('[INFO] INFORMAMOS ACT_ID PARA PRECISION');
		
		V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA_TMP||' T1 USING 
						(SELECT DISTINCT ACT.ACT_ID, TMP.ACT_NUM_ACTIVO FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
						JOIN '||V_ESQUEMA||'.'||V_TABLA_TMP||' TMP ON TMP.ACT_NUM_ACTIVO = ACT.ACT_NUM_ACTIVO
						WHERE ACT.BORRADO = 0) T2
					ON (T1.ACT_NUM_ACTIVO = T2.ACT_NUM_ACTIVO)
					WHEN MATCHED THEN UPDATE SET
					T1.ACT_ID = T2.ACT_ID';
		EXECUTE IMMEDIATE V_MSQL;	

		DBMS_OUTPUT.PUT_LINE('[INFO] Se han ACTUALIZADO '||SQL%ROWCOUNT||' registros: '||V_TABLA_TMP||'');
	 
        COMMIT;

		DBMS_OUTPUT.PUT_LINE('[INFO] INFORMAMOS USU_ID PARA PRECISION');

		V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA_TMP||' T1 USING
						(SELECT DISTINCT USU.USU_ID, TMP.USU_USERNAME FROM '||V_ESQUEMA_M||'.USU_USUARIOS USU
						JOIN '||V_ESQUEMA||'.'||V_TABLA_TMP||' TMP ON TMP.USU_USERNAME = USU.USU_USERNAME
						WHERE USU.BORRADO = 0) T2
					ON (T1.USU_USERNAME = T2.USU_USERNAME)
					WHEN MATCHED THEN UPDATE SET
					T1.USU_ID = T2.USU_ID';
		EXECUTE IMMEDIATE V_MSQL;

		DBMS_OUTPUT.PUT_LINE('[INFO] Se han ACTUALIZADO '||SQL%ROWCOUNT||' registros: '||V_TABLA_TMP||'');

        COMMIT;

        DBMS_OUTPUT.PUT_LINE('[INFO] BORRAMOS EN GEE_GESTOR_ENTIDAD');

        V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD T1 USING
                        (SELECT DISTINCT GEE.GEE_ID
                        FROM '||V_ESQUEMA||'.'||V_TABLA_TMP||' TMP
                        JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GAC.ACT_ID = TMP.ACT_ID
                        JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID AND GEE.BORRADO = 0
                        JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_ID = GEE.DD_TGE_ID AND DD_TGE_CODIGO = ''SCOM''
                        WHERE TMP.USU_ID IS NOT NULL AND TMP.ACT_ID IS NOT NULL) T2
                    ON (T1.GEE_ID = T2.GEE_ID)
                    WHEN MATCHED THEN UPDATE SET
                    T1.BORRADO = 1,
                    T1.USUARIOBORRAR = '''||V_USUARIO||''',
                    T1.FECHABORRAR = SYSDATE';
        EXECUTE IMMEDIATE V_MSQL;

        DBMS_OUTPUT.PUT_LINE('[INFO] Se han BORRADO '||SQL%ROWCOUNT||' registros: GEE_GESTOR_ENTIDAD');

        COMMIT;

        DBMS_OUTPUT.PUT_LINE('[INFO] INSERTAR EN GEE_GESTOR_ENTIDAD');

        V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD
                    (GEE_ID,USU_ID,DD_TGE_ID,USUARIOCREAR,FECHACREAR,USUARIOMODIFICAR)
                        SELECT '||V_ESQUEMA||'.S_GEE_GESTOR_ENTIDAD.NEXTVAL, TMP.USU_ID,
                        (SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = ''SCOM''),
                        '''||V_USUARIO||''', SYSDATE, TO_CHAR(TMP.ACT_ID)
                        FROM '||V_ESQUEMA||'.'||V_TABLA_TMP||' TMP
                        WHERE TMP.USU_ID IS NOT NULL AND TMP.ACT_ID IS NOT NULL';
        EXECUTE IMMEDIATE V_MSQL;

        DBMS_OUTPUT.PUT_LINE('[INFO] Se han INSERTADO '||SQL%ROWCOUNT||' registros: GEE_GESTOR_ENTIDAD');

        COMMIT;

        V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO (GEE_ID, ACT_ID)
                    SELECT GEE_ID, TO_NUMBER(USUARIOMODIFICAR) FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD WHERE USUARIOCREAR = '''||V_USUARIO||'''
                    AND USUARIOMODIFICAR IS NOT NULL AND USUARIOMODIFICAR != '''||V_USUARIO||'''';
        EXECUTE IMMEDIATE V_MSQL;

        DBMS_OUTPUT.PUT_LINE('[INFO]: REGISTROS INSERTADOS EN GAH_GESTOR_ACTIVO_HISTORICO: ' ||SQL%ROWCOUNT);

        COMMIT;

        DBMS_OUTPUT.PUT_LINE('[INFO] INSERTAMOS EN GEH_GESTOR_ENTIDAD_HIST');

        V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST
                    (GEH_ID,USU_ID,DD_TGE_ID,GEH_FECHA_DESDE,USUARIOCREAR,FECHACREAR,USUARIOMODIFICAR)
                        SELECT '||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL, TMP.USU_ID,
                        (SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = ''SCOM''),
                        SYSDATE, '''||V_USUARIO||''', SYSDATE, TO_CHAR(TMP.ACT_ID)
                        FROM '||V_ESQUEMA||'.'||V_TABLA_TMP||' TMP
                        WHERE TMP.USU_ID IS NOT NULL AND TMP.ACT_ID IS NOT NULL';
        EXECUTE IMMEDIATE V_MSQL;

        DBMS_OUTPUT.PUT_LINE('[INFO] Se han INSERTADO '||SQL%ROWCOUNT||' registros: GEH_GESTOR_ENTIDAD_HIST');

        COMMIT;

        DBMS_OUTPUT.PUT_LINE('[INFO] INFORMAMOS FECHA FIN EN GEH_GESTOR_ENTIDAD_HIST SI NO LO TIENE ACTIVO');

        V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST T1 USING (
                       SELECT DISTINCT GEH.GEH_ID FROM '||V_ESQUEMA||'.'||V_TABLA_TMP||' TMP
                       JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAC ON GAC.ACT_ID = TMP.ACT_ID
                       JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH ON GEH.GEH_ID = GAC.GEH_ID AND GEH.BORRADO = 0
                       JOIN '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR TGE ON TGE.DD_TGE_ID = GEH.DD_TGE_ID AND DD_TGE_CODIGO = ''SCOM''
                       WHERE GEH.GEH_FECHA_HASTA IS NULL AND TMP.ACT_ID IS NOT NULL) T2
                   ON (T1.GEH_ID = T2.GEH_ID)
                   WHEN MATCHED THEN UPDATE SET
                T1.GEH_FECHA_HASTA = SYSDATE,
                T1.USUARIOMODIFICAR = '''||V_USUARIO||''',
                T1.FECHAMODIFICAR = SYSDATE';
        EXECUTE IMMEDIATE V_MSQL;

        DBMS_OUTPUT.PUT_LINE('[INFO] Se han ACTUALIZADO '||SQL%ROWCOUNT||' registros: GEH_GESTOR_ENTIDAD_HIST');

        COMMIT;

        V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO (GEH_ID, ACT_ID)
                    SELECT GEH_ID, TO_NUMBER(USUARIOMODIFICAR) FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST WHERE USUARIOCREAR = '''||V_USUARIO||'''
                    AND USUARIOMODIFICAR IS NOT NULL AND USUARIOMODIFICAR != '''||V_USUARIO||'''';
        EXECUTE IMMEDIATE V_MSQL;

        DBMS_OUTPUT.PUT_LINE('[INFO]: REGISTROS INSERTADOS EN GAH_GESTOR_ACTIVO_HISTORICO: ' ||SQL%ROWCOUNT);

        COMMIT;

        DBMS_OUTPUT.PUT_LINE('[INFO] QUITAMOS MARCA DE BORRADO GEH Y GEE');

        V_MSQL:='UPDATE '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST
                    SET USUARIOMODIFICAR = NULL
                    WHERE USUARIOCREAR = '''||V_USUARIO||''' AND USUARIOMODIFICAR IS NOT NULL';
        EXECUTE IMMEDIATE V_MSQL;

        DBMS_OUTPUT.PUT_LINE('[INFO] Se han ACTUALIZADO '||SQL%ROWCOUNT||' registros: GEH_GESTOR_ENTIDAD_HIST');

        V_MSQL:='UPDATE '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD
                    SET USUARIOMODIFICAR = NULL
                    WHERE USUARIOCREAR = '''||V_USUARIO||''' AND USUARIOMODIFICAR IS NOT NULL';
        EXECUTE IMMEDIATE V_MSQL;

        DBMS_OUTPUT.PUT_LINE('[INFO] Se han ACTUALIZADO '||SQL%ROWCOUNT||' registros: GEE_GESTOR_ENTIDAD');

	END IF;
	 
	COMMIT;	


	DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
    WHEN OTHERS THEN
      PL_OUTPUT := PL_OUTPUT ||'[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE)||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||'-----------------------------------------------------------'||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||SQLERRM||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||V_MSQL||CHR(10);
      DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
