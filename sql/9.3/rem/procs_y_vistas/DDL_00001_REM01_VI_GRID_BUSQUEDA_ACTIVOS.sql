--/*
--##########################################
--## AUTOR=Guillem Rey
--## FECHA_CREACION=20200918
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-8040
--## PRODUCTO=NO
--## 
--## Finalidad: Crear vista para rellenar el grid de la busqueda de activos
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 [HREOS-10081] Versión inicial (Creación de la vista)
--##        0.2 [REMVIP-7161] Añadir campo equipo de gestión
--##        0.3 [HREOS-10769] Añadir campos BBVA_NUM_ACTIVO y BBVA_ID_DIVARIAN
--##		0.4 Juan Bautista Alfonso - - REMVIP-7935 - Modificado fecha posesion para que cargue de la vista V_FECHA_POSESION_ACTIVO
--##		0.5 Guillem Rey -- REMVIP-8040 - APU - Destino Comercial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE    
    ERR_NUM NUMBER; -- Numero de error
    ERR_MSG VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_MSQL VARCHAR2(4000 CHAR); 
    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_GRID_BUSQUEDA_ACTIVOS' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_GRID_BUSQUEDA_ACTIVOS...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.V_GRID_BUSQUEDA_ACTIVOS';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_GRID_BUSQUEDA_ACTIVOS... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_GRID_BUSQUEDA_ACTIVOS' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_GRID_BUSQUEDA_ACTIVOS...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.V_GRID_BUSQUEDA_ACTIVOS';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_GRID_BUSQUEDA_ACTIVOS... borrada OK');
  END IF;

    
  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_GRID_BUSQUEDA_ACTIVOS...');
  EXECUTE IMMEDIATE 'CREATE VIEW ' || V_ESQUEMA || '.V_GRID_BUSQUEDA_ACTIVOS 
	AS
    
    SELECT
		  	ACT.ACT_ID,	
            TPVIA.DD_TVI_DESCRIPCION || '' '' || BIE_LOC.BIE_LOC_NOMBRE_VIA || '' ''|| BIE_LOC.BIE_LOC_NUMERO_DOMICILIO || '' '' || LOC.DD_LOC_DESCRIPCION || '' '' || PRV.DD_PRV_DESCRIPCION AS TOKEN_GMAPS,
			ACT_LOC.LOC_LONGITUD								AS LONGITUD,
			ACT_LOC.LOC_LATITUD 									AS LATITUD,
			ACT.ACT_NUM_ACTIVO 									AS NUM_ACTIVO,	
			ACT.ACT_NUM_ACTIVO_SAREB 					AS NUM_ACTIVO_SAREB,
			ACT.ACT_NUM_ACTIVO_PRINEX 				AS NUM_ACTIVO_PRINEX,
			ACT.ACT_NUM_ACTIVO_UVEM 					AS NUM_ACTIVO_UVEM,
			ACT.ACT_NUM_ACTIVO_DIVARIAN			AS NUM_ACTIVO_DIVARIAN,
			ACT.ACT_RECOVERY_ID 								AS  NUM_RECOVERY,
	        TPA.DD_TPA_CODIGO 									AS TIPO_ACTIVO_CODIGO,
	        TPA.DD_TPA_DESCRIPCION 						AS TIPO_ACTIVO_DESCRIPCION,
	        STA.DD_SAC_CODIGO 										AS SUBTIPO_ACTIVO_CODIGO,
	        STA.DD_SAC_DESCRIPCION 							AS SUBTIPO_ACTIVO_DESCRIPCION,	 
	        CRA.DD_CRA_CODIGO									AS CARTERA_CODIGO,
	        CRA.DD_CRA_DESCRIPCION 						AS CARTERA_DESCRIPCION,
			SCR.DD_SCR_CODIGO 									AS SUBCARTERA_CODIGO,
	        SCR.DD_SCR_DESCRIPCION 						AS SUBCARTERA_DESCRIPCION,
	        TTA.DD_TTA_CODIGO 										AS TIPO_TITULO_ACTIVO_CODIGO,
	        TTA.DD_TTA_DESCRIPCION 							AS TIPO_TITULO_ACTIVO_DESCRIPCION,
			STA.DD_STA_CODIGO 										AS SUBTIPO_TITULO_ACTIVO_CODIGO,
	        TPVIA.DD_TVI_CODIGO 									AS TIPO_VIA_CODIGO,
	        TPVIA.DD_TVI_DESCRIPCION						AS TIPO_VIA_DESCRIPCION,
          	BIE_LOC.BIE_LOC_NOMBRE_VIA 				AS NOMBRE_VIA,	
	        LOC.DD_LOC_CODIGO 									AS LOCALIDAD_CODIGO,
	        LOC.DD_LOC_DESCRIPCION 						AS LOCALIDAD_DESCRIPCION,
	        PRV.DD_PRV_CODIGO 									AS PROVINCIA_CODIGO,
	        PRV.DD_PRV_DESCRIPCION 						AS PROVINCIA_DESCRIPCION,
          	BIE_LOC.BIE_LOC_COD_POST 					AS COD_POSTAL,
			SCM.DD_SCM_CODIGO 									AS SITUACION_COMERCIAL_CODIGO,
			SCM.DD_SCM_DESCRIPCION 						AS SITUACION_COMERCIAL_DESCRIPCION,			
			ACT.ACT_ADMISION 											AS ADMISION,
			ACT.ACT_GESTION 											AS GESTION,
			ACT.ACT_SELLO_CALIDAD 							AS SELLO_CALIDAD,	                    
          	RTG.DD_RTG_CODIGO 									AS FLAG_RATING_CODIGO,
			RTG.DD_RTG_DESCRIPCION							AS FLAG_RATING_DESCRIPCION,
 			ACT.ACT_COD_PROMOCION_PRINEX 	AS COD_PROMO_PRINEX,
            BIE_DAT.BIE_DREG_NUM_FINCA 				AS NUM_FINCA,						
 			EAC.DD_EAC_CODIGO 									AS ESTADO_ACTIVO_CODIGO,
			EAC.DD_EAC_DESCRIPCION							AS ESTADO_ACTIVO_DESCRIPCION,
			BIE_CIC.DD_CIC_CODIGO 								AS PAIS_CODIGO,
			TUD.DD_TUD_CODIGO 									AS TIPO_USO_DESTINO_CODIGO,
  			CLA.DD_CLA_CODIGO										AS CLASE_ACTIVO_BANCARIO_CODIGO,
            SCA.DD_SCA_CODIGO 									AS SUBCLASE_ACTIVO_BANCARIO_CODIGO,
			LOCREG.DD_LOC_DESCRIPCION 				AS LOCALIDAD_REGISTRO_DESCRIPCION,
			BIE_DAT.BIE_DREG_NUM_REGISTRO		AS NUM_REGISTRO,
			ACT_REG.REG_IDUFIR										AS IDUFIR,
			TIT.TIT_FECHA_INSC_REG								AS FECHA_INSCRIPCION_REGISTRO,
			ACT.ACT_DIVISION_HORIZONTAL				AS DIVISION_HORIZONTAL,
			PRO.PRO_NOMBRE											AS NOMBRE_PROPIETARIO,
			PRO.PRO_DOCIDENTIF									AS DOCUMENTO_PROPIETARIO,
			ACT_SIT.SPS_OCUPADO									AS OCUPADO,
			FPA.FECHA_POSESION	AS FECHA_TOMA_POSESION,
          	ACT_SIT.SPS_ACC_TAPIADO							AS ACCESO_TAPIADO,
			ACT_SIT.SPS_ACC_ANTIOCUPA					AS ACCESO_ANTIOCUPA,
			TPO.DD_TPO_CODIGO									AS TITULO_POSESORIO_CODIGO,
			TPO.DD_TPO_DESCRIPCION						AS TITULO_POSESORIO_DESCRIPCION,
			TIT.DD_TPA_CODIGO										AS CON_TITULO_CODIGO,			
			TCO.DD_TCO_CODIGO									AS TIPO_COMERCIALIZACION_CODIGO,		
			ACT.ACT_CON_CARGAS									AS CON_CARGAS,
			ECG.DD_ECG_CODIGO										AS ESTADO_COMUNICACION_GENCAT,
			DIR_COM.DD_TDC_CODIGO						AS DIRECCION_COMERCIAL,
			ACT.ACT_PERIMETRO_MACC						AS PERIMETRO_MACC,
			TIPOSEG.DD_TS_CODIGO 								AS TIPO_SEGMENTO_CODIGO,
            EQG.DD_EQG_CODIGO                           AS DD_EQG_EQUIPO_GESTION,
			BBVA.BBVA_NUM_ACTIVO						AS BBVA_NUM_ACTIVO,
			BBVA.BBVA_ID_DIVARIAN						AS BBVA_ID_DIVARIAN
            
		FROM '|| V_ESQUEMA ||'.ACT_ACTIVO ACT 
		LEFT JOIN '|| V_ESQUEMA ||'.ACT_LOC_LOCALIZACION ACT_LOC 							ON ACT_LOC.ACT_ID = ACT.ACT_ID
		LEFT JOIN '|| V_ESQUEMA ||'.ACT_SPS_SIT_POSESORIA ACT_SIT 								ON ACT.ACT_ID = ACT_SIT.ACT_ID
		LEFT JOIN '|| V_ESQUEMA ||'.V_FECHA_POSESION_ACTIVO FPA ON FPA.ACT_ID = ACT.ACT_ID
		LEFT JOIN '|| V_ESQUEMA ||'.BIE_LOCALIZACION BIE_LOC											ON ACT.BIE_ID = BIE_LOC.BIE_ID
		LEFT JOIN '|| V_ESQUEMA ||'.BIE_DATOS_REGISTRALES BIE_DAT 								ON ACT.BIE_ID = BIE_DAT.BIE_ID
 		LEFT JOIN '|| V_ESQUEMA ||'.ACT_ABA_ACTIVO_BANCARIO ABA								ON ABA.ACT_ID = ACT.ACT_ID
		LEFT JOIN '|| V_ESQUEMA ||'.ACT_REG_INFO_REGISTRAL ACT_REG 						ON ACT.ACT_ID = ACT_REG.ACT_ID
		LEFT JOIN '|| V_ESQUEMA ||'.ACT_TIT_TITULO TIT																ON TIT.ACT_ID = ACT.ACT_ID
		LEFT JOIN '|| V_ESQUEMA ||'.ACT_PAC_PROPIETARIO_ACTIVO PAC						ON PAC.ACT_ID = ACT.ACT_ID
		LEFT JOIN '|| V_ESQUEMA ||'.ACT_PRO_PROPIETARIO PRO										ON PRO.PRO_ID = PAC.PRO_ID
		LEFT JOIN '|| V_ESQUEMA ||'.ACT_CMG_COMUNICACION_GENCAT CMG				ON CMG.ACT_ID = ACT.ACT_ID 

        LEFT JOIN '|| V_ESQUEMA ||'.DD_CLA_CLASE_ACTIVO CLA 											ON CLA.DD_CLA_ID = ABA.DD_CLA_ID
        LEFT JOIN '|| V_ESQUEMA ||'.DD_SCA_SUBCLASE_ACTIVO SCA 									ON SCA.DD_SCA_ID = ABA.DD_SCA_ID
		LEFT JOIN '|| V_ESQUEMA ||'.DD_SAC_SUBTIPO_ACTIVO STA										ON STA.DD_SAC_ID = ACT.DD_SAC_ID
	    LEFT JOIN '|| V_ESQUEMA ||'.DD_TPA_TIPO_ACTIVO TPA 											ON TPA.DD_TPA_ID = ACT.DD_TPA_ID	    
	    LEFT JOIN '|| V_ESQUEMA ||'.DD_TTA_TIPO_TITULO_ACTIVO TTA							ON TTA.DD_TTA_ID =  ACT.DD_TTA_ID
  		LEFT JOIN '|| V_ESQUEMA ||'.DD_STA_SUBTIPO_TITULO_ACTIVO STA					ON STA.DD_STA_ID =  ACT.DD_STA_ID
		LEFT JOIN '|| V_ESQUEMA ||'.DD_TPA_TIPO_TITULO_ACT TIT										ON TIT.DD_TPA_ID = ACT_SIT.DD_TPA_ID
		LEFT JOIN '|| V_ESQUEMA ||'.DD_ECG_ESTADO_COM_GENCAT ECG 						ON ECG.DD_ECG_ID = CMG.DD_ECG_ID  
		LEFT JOIN '|| V_ESQUEMA ||'.DD_TDC_TERRITORIOS_DIR_COM DIR_COM 			ON DIR_COM.DD_TDC_ID = ACT.DD_TDC_ID 
		LEFT JOIN '|| V_ESQUEMA ||'.ACT_APU_ACTIVO_PUBLICACION APU					ON APU.ACT_ID = ACT.ACT_ID
		LEFT JOIN '|| V_ESQUEMA ||'.DD_TCO_TIPO_COMERCIALIZACION TCO 				ON TCO.DD_TCO_ID = APU.DD_TCO_ID

	    LEFT JOIN '|| V_ESQUEMA ||'.DD_CRA_CARTERA CRA														ON CRA.DD_CRA_ID = ACT.DD_CRA_ID	    
 		LEFT JOIN '|| V_ESQUEMA ||'.DD_SCR_SUBCARTERA SCR 												ON SCR.DD_SCR_ID = ACT.DD_SCR_ID	     
		LEFT JOIN '|| V_ESQUEMA ||'.DD_RTG_RATING_ACTIVO RTG 										ON RTG.DD_RTG_ID = ACT.DD_RTG_ID
		LEFT JOIN '|| V_ESQUEMA ||'.DD_SCM_SITUACION_COMERCIAL SCM		 				ON SCM.DD_SCM_ID = ACT.DD_SCM_ID
		LEFT JOIN '|| V_ESQUEMA ||'.DD_TUD_TIPO_USO_DESTINO TUD 							ON TUD.DD_TUD_ID = ACT.DD_TUD_ID		
		LEFT JOIN '|| V_ESQUEMA ||'.DD_EAC_ESTADO_ACTIVO EAC										ON EAC.DD_EAC_ID = ACT.DD_EAC_ID
		LEFT JOIN '|| V_ESQUEMA ||'.DD_TPO_TIPO_TITULO_POSESORIO TPO				ON TPO.DD_TPO_ID = ACT_SIT.DD_TPO_ID
		LEFT JOIN '|| V_ESQUEMA ||'.DD_TS_TIPO_SEGMENTO TIPOSEG								ON TIPOSEG.DD_TS_ID = ACT.DD_TS_ID 

		LEFT JOIN '|| V_ESQUEMA_M ||'.DD_TVI_TIPO_VIA TPVIA												ON TPVIA.DD_TVI_ID = BIE_LOC.DD_TVI_ID
		LEFT JOIN '|| V_ESQUEMA_M ||'.DD_LOC_LOCALIDAD LOC 											ON LOC.DD_LOC_ID = BIE_LOC.DD_LOC_ID		
		LEFT JOIN '|| V_ESQUEMA_M ||'.DD_LOC_LOCALIDAD LOCREG									ON LOCREG.DD_LOC_ID = BIE_DAT.DD_LOC_ID
		LEFT JOIN '|| V_ESQUEMA_M ||'.DD_CIC_CODIGO_ISO_CIRBE_BKP BIE_CIC 		ON BIE_LOC.DD_CIC_ID = BIE_CIC.DD_CIC_ID
		LEFT JOIN '|| V_ESQUEMA_M ||'.DD_PRV_PROVINCIA PRV											ON PRV.DD_PRV_ID = LOC.DD_PRV_ID
		LEFT JOIN ' || V_ESQUEMA || '.DD_EQG_EQUIPO_GESTION EQG                 ON EQG.DD_EQG_ID = ACT.DD_EQG_ID
 		LEFT JOIN ' || V_ESQUEMA || '.ACT_BBVA_ACTIVOS BBVA						ON BBVA.ACT_ID = ACT.ACT_ID
		WHERE ACT.BORRADO = 0';
        
DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_GRID_BUSQUEDA_ACTIVOS...Creada OK');
  
EXCEPTION
    WHEN OTHERS THEN
         ERR_NUM := SQLCODE;
         ERR_MSG := SQLERRM;

         DBMS_OUTPUT.PUT_LINE('KO no modificada');
         DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
         DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------'); 
         DBMS_OUTPUT.PUT_LINE(ERR_MSG);

         ROLLBACK;
         RAISE;   
		 
END;
/

EXIT;
