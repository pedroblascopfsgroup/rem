--/*
--##########################################
--## AUTOR=Javier Esbrí
--## FECHA_CREACION=20211202
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-13272
--## PRODUCTO=NO
--## 
--## Finalidad: Crear vista para obtener los datos del buscador de ofertas
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 [REMVIP-7883] Versión inicial (Creación de la vista)
--##        0.2 [HREOS-14529] Añadir nuevo campo para filtro (FECHA_OFERTA_PENDIENTE)
--##        0.3 [REMVIP-10875] Añadir nuevo campo para filtro (FECHA_ENT_CRM_SF)
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE    
    ERR_NUM NUMBER; -- Numero de error
    ERR_MSG VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_MSQL VARCHAR2(4000 CHAR); 
    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_GRID_BUSQUEDA_OFERTAS' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_GRID_BUSQUEDA_OFERTAS...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.V_GRID_BUSQUEDA_OFERTAS';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.V_GRID_BUSQUEDA_OFERTAS... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_GRID_BUSQUEDA_OFERTAS' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_GRID_BUSQUEDA_OFERTAS...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.V_GRID_BUSQUEDA_OFERTAS';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_GRID_BUSQUEDA_OFERTAS... borrada OK');
  END IF;
    
  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_GRID_BUSQUEDA_OFERTAS...');
  EXECUTE IMMEDIATE 'CREATE VIEW ' || V_ESQUEMA || '.V_GRID_BUSQUEDA_OFERTAS 
	AS          
        SELECT 
			    OFR.OFR_ID,
		 		OFR.OFR_NUM_OFERTA AS NUM_OFERTA,		    	
				OFR.OFR_FECHA_ALTA AS FECHA_ALTA,
				TOF.DD_TOF_CODIGO AS TIPO_OFERTA_CODIGO,
		    	TOF.DD_TOF_DESCRIPCION AS TIPO_OFERTA_DESCRIPCION,
				NVL(AGR.AGR_NUM_AGRUP_REM, ACT.ACT_NUM_ACTIVO) AS NUM_ACTIVO_AGRUPACION,
		    	NVL(CLC.CLC_RAZON_SOCIAL, CLC.CLC_NOMBRE || NVL2(CLC.CLC_APELLIDOS, '' '' || CLC.CLC_APELLIDOS, '''')) AS OFERTANTE_NOMBRE,
				CLC.CLC_TELEFONO1 ||'' ''|| CLC.CLC_TELEFONO2 AS OFERTANTE_TELEFONO,
				CLC.CLC_EMAIL AS OFERTANTE_EMAIL,
				CLC.CLC_DOCUMENTO AS OFERTANTE_DOC,
		    	OFR.OFR_IMPORTE AS IMPORTE_OFERTA,	
				EOF.DD_EOF_CODIGO AS ESTADO_OFERTA_CODIGO,
			    EOF.DD_EOF_DESCRIPCION AS ESTADO_OFERTA_DESCRIPCION, 		
			    ECO.ECO_NUM_EXPEDIENTE AS NUM_EXPEDIENTE,
				ECO.ECO_ID,
				EEC.DD_EEC_CODIGO AS ESTADO_EXPEDIENTE_CODIGO,
			    EEC.DD_EEC_DESCRIPCION AS ESTADO_EXPEDIENTE_DESCRIPCION,
				CAP.DD_CAP_CODIGO AS CANAL_PRESCRIPCION_CODIGO,
				CAP.DD_CAP_DESCRIPCION AS CANAL_PRESCRIPCION_DESCRIPCION,
				AGR.AGR_ID,			
 				AGR.AGR_NUM_AGRUP_REM AS NUM_AGRUPACION,    
				ACT.ACT_ID,				
 				ACT.ACT_NUM_ACTIVO AS NUM_ACTIVO,
				RES.RES_FECHA_FIRMA AS FECHA_FIRMA_RESERVA,
				VIS.VIS_ID,
				VIS.VIS_NUM_VISITA AS NUM_VISITA,
				PVEPRES.PVE_NOMBRE AS CANAL_NOMBRE,
				TPR.DD_TPR_CODIGO AS CANAL_CODIGO,
				TPR.DD_TPR_DESCRIPCION AS CANAL_DESCRIPCION,
				CRA.DD_CRA_CODIGO AS CARTERA_CODIGO,
				SCR.DD_SCR_CODIGO AS SUBCARTERA_CODIGO,        		
				TCR.DD_TCR_CODIGO AS TIPO_COMERCIALIZACION_CODIGO,				
				ACT.ACT_NUM_ACTIVO_UVEM AS NUM_ACTIVO_UVEM,
				ACT.ACT_NUM_ACTIVO_SAREB AS NUM_ACTIVO_SAREB,
				ACT.ACT_NUM_ACTIVO_PRINEX AS NUM_ACTIVO_PRINEX,
				ACT.ACT_COD_PROMOCION_PRINEX AS COD_PROMO_PRINEX,
				OFR.OFR_OFERTA_EXPRESS AS OFERTA_EXPRESS,
				OFR.OFR_FECHA_OFERTA_PENDIENTE AS FECHA_OFERTA_PENDIENTE,
				OFR.FECHA_ENT_CRM_SF AS FECHA_ENT_CRM_SF
		
		FROM '|| V_ESQUEMA ||'.OFR_OFERTAS OFR
    	    JOIN (SELECT MIN(ACT_ID) AS ACT_ID, OFR_ID FROM '|| V_ESQUEMA ||'.ACT_OFR GROUP BY OFR_ID)
		            ACTOFR                                                                              ON ACTOFR.OFR_ID = OFR.OFR_ID		
			JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT 														ON ACT.ACT_ID = ACTOFR.ACT_ID
			JOIN '|| V_ESQUEMA ||'.CLC_CLIENTE_COMERCIAL CLC 								            ON CLC.CLC_ID = OFR.CLC_ID
			
			LEFT JOIN '|| V_ESQUEMA ||'.VIS_VISITAS VIS 												ON VIS.VIS_ID = OFR.VIS_ID
			LEFT JOIN '|| V_ESQUEMA ||'.ACT_PVE_PROVEEDOR PVEPRES 			                            ON PVEPRES.PVE_ID = OFR.PVE_ID_PRESCRIPTOR
			LEFT JOIN '|| V_ESQUEMA ||'.ECO_EXPEDIENTE_COMERCIAL ECO 		                            ON ECO.OFR_ID = OFR.OFR_ID
			LEFT JOIN '|| V_ESQUEMA ||'.RES_RESERVAS RES 											    ON RES.ECO_ID = ECO.ECO_ID	
			LEFT JOIN '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR 						                    ON AGR.AGR_ID = OFR.AGR_ID
			JOIN '|| V_ESQUEMA ||'.DD_CRA_CARTERA CRA  								            		ON ACT.DD_CRA_ID = CRA.DD_CRA_ID
			JOIN '|| V_ESQUEMA ||'.DD_SCR_SUBCARTERA SCR  						                    	ON ACT.DD_SCR_ID = SCR.DD_SCR_ID
			JOIN '|| V_ESQUEMA ||'.DD_TCR_TIPO_COMERCIALIZAR TCR                               	ON ACT.DD_TCR_ID = TCR.DD_TCR_ID			
			LEFT JOIN '|| V_ESQUEMA ||'.DD_TPR_TIPO_PROVEEDOR TPR 			                            ON TPR.DD_TPR_ID = PVEPRES.DD_TPR_ID			
			LEFT JOIN '|| V_ESQUEMA ||'.DD_EEC_EST_EXP_COMERCIAL EEC 		                            	ON EEC.DD_EEC_ID = ECO.DD_EEC_ID
			LEFT JOIN '|| V_ESQUEMA ||'.DD_CAP_CANAL_PRESCRIPCION CAP 	                                ON CAP.DD_CAP_ID = OFR.DD_CAP_ID			
			JOIN '|| V_ESQUEMA ||'.DD_TOF_TIPOS_OFERTA TOF 					                    		ON TOF.DD_TOF_ID = OFR.DD_TOF_ID
			JOIN '|| V_ESQUEMA ||'.DD_EOF_ESTADOS_OFERTA EOF				                        	ON EOF.DD_EOF_ID = OFR.DD_EOF_ID				
		WHERE OFR.BORRADO  = 0';
        
DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_GRID_BUSQUEDA_OFERTAS...Creada OK');
  
EXCEPTION
    WHEN OTHERS THEN
         ERR_NUM := SQLCODE;
         ERR_MSG := SQLERRM;

         DBMS_OUTPUT.PUT_LINE('KO no modificada');
         DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
         DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------'); 
         DBMS_OUTPUT.PUT_LINE(ERR_MSG);

         ROLLBACK;
         RAISE;   
		 
END;
/

EXIT;
