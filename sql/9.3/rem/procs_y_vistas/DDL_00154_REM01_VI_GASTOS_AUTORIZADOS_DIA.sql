--/*
--##########################################
--## AUTOR=Carlos Santos Vílchez
--## FECHA_CREACION=20210601
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9705
--## PRODUCTO=SI
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##        0.2 REMVIP-11128 - Añadido nombre propietario
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.    
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- N?mero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas
	V_ESQUEMA_3 VARCHAR2(20 CHAR) := 'REM_QUERY';
    V_ESQUEMA_4 VARCHAR2(20 CHAR) := 'PFSREM';
	V_TABLA VARCHAR2(30 CHAR) := 'V_GASTOS_AUTORIZADOS_DIA';
    V_MSQL VARCHAR2(4000 CHAR);

    CUENTA NUMBER;
    
BEGIN

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_GASTOS_AUTORIZADOS_DIA...');
  EXECUTE IMMEDIATE 'CREATE OR REPLACE VIEW ' || V_ESQUEMA || '.V_GASTOS_AUTORIZADOS_DIA AS
	SELECT DISTINCT
	GPV.GPV_NUM_GASTO_HAYA AS ID_GASTO_HAYA, 
	GPV.GPV_REF_EMISOR AS NUM_FACTURA, 
	ACT.ACT_NUM_ACTIVO AS ID_HAYA, 
	BBVA.BBVA_NUM_ACTIVO AS ID_BBVA,
	GDE.GDE_FECHA_TOPE_PAGO AS FECHA_TOPE_PAGO, 
	PRO.PRO_DOCIDENTIF AS CIF_PROPIETARIO, 
	PRO.PRO_NOMBRE AS NOMBRE_PROPIETARIO,
	PVE.PVE_DOCIDENTIF AS CIF_PROVEEDOR,
	PVE.PVE_NOMBRE AS NOMBRE_PROVEEDOR, 
	GGE.GGE_FECHA_EAH AS FECHA_AUTORIZACION,
	SCR.DD_SCR_DESCRIPCION AS SUBCARTERA,
	TGA.DD_TGA_DESCRIPCION AS TIPO_GASTO,
	STG.DD_STG_DESCRIPCION AS SUBTIPO_GASTO,
	TPA.DD_TPA_DESCRIPCION AS PAGADO_POR

	FROM '|| V_ESQUEMA ||'.GPV_GASTOS_PROVEEDOR GPV
	JOIN '|| V_ESQUEMA ||'.DD_DEG_DESTINATARIOS_GASTO DEG ON GPV.DD_DEG_ID = DEG.DD_DEG_ID AND DEG.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.DD_EGA_ESTADOS_GASTO EGA ON GPV.DD_EGA_ID = EGA.DD_EGA_ID
	JOIN '|| V_ESQUEMA ||'.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID AND GGE.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.DD_EAH_ESTADOS_AUTORIZ_HAYA EAH ON EAH.DD_EAH_ID = GGE.DD_EAH_ID AND EAH.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = GPV.PRO_ID AND PRO.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.ACT_PVE_PROVEEDOR PVE ON PVE.PVE_ID = GPV.PVE_ID_EMISOR AND PVE.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.GLD_GASTOS_LINEA_DETALLE GLD ON GLD.GPV_ID = GPV.GPV_ID AND GLD.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.DD_STG_SUBTIPOS_GASTO STG ON STG.DD_STG_ID = GLD.DD_STG_ID AND STG.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.GLD_ENT GLDENT ON GLD.GLD_ID = GLDENT.GLD_ID AND GLDENT.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.DD_ENT_ENTIDAD_GASTO ENT ON GLDENT.DD_ENT_ID = ENT.DD_ENT_ID
	JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON GLDENT.ENT_ID = ACT.ACT_ID AND ACT.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.DD_SCR_SUBCARTERA SCR ON SCR.DD_SCR_ID = ACT.DD_SCR_ID AND SCR.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.ACT_BBVA_ACTIVOS BBVA ON BBVA.ACT_ID = ACT.ACT_ID AND BBVA.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.DD_TGA_TIPOS_GASTO TGA ON TGA.DD_TGA_ID = GPV.DD_TGA_ID AND TGA.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GPV.GPV_ID = GDE.GPV_ID AND GDE.BORRADO = 0
	JOIN '|| V_ESQUEMA ||'.DD_TPA_TIPOS_PAGADOR TPA ON TPA.DD_TPA_ID = GDE.DD_TPA_ID AND TPA.BORRADO = 0

	WHERE GPV.BORRADO = 0
	AND ENT.DD_ENT_CODIGO = ''ACT''
	AND EGA.DD_EGA_CODIGO = ''03''
	AND DEG.DD_DEG_CODIGO = ''01''
	AND CRA.DD_CRA_CODIGO = ''16''
	AND SCR.DD_SCR_CODIGO IN (''153'',''154'',''155'',''157'',''158'')
	AND EAH.DD_EAH_CODIGO = ''03''
	AND TGA.DD_TGA_CODIGO IN (''01'',''02'',''03'',''04'',''05'',''06'',''07'',''08'',''09'',''10'',''11'',''12'',''14'',''15'',''16'',''17'',''18'')
	AND TPA.DD_TPA_CODIGO IN (''01'', ''02'', ''03'')
	AND GGE.GGE_FECHA_EAH LIKE TO_DATE(SYSDATE,''DD-MM-YY'')
	';

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_GASTOS_AUTORIZADOS_DIA...Creada OK');

  IF V_ESQUEMA_MASTER != V_ESQUEMA THEN

		EXECUTE IMMEDIATE 'GRANT ALL ON "'||V_ESQUEMA||'"."'||V_TABLA||'" TO "'||V_ESQUEMA_MASTER||'" WITH GRANT OPTION';
		DBMS_OUTPUT.PUT_LINE('[INFO] PERMISOS SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||' OTORGADOS A '||V_ESQUEMA_MASTER||''); 

	END IF;

	IF V_ESQUEMA_3 != V_ESQUEMA THEN

		EXECUTE IMMEDIATE 'GRANT ALL ON "'||V_ESQUEMA||'"."'||V_TABLA||'" TO "'||V_ESQUEMA_3||'" WITH GRANT OPTION';
		DBMS_OUTPUT.PUT_LINE('[INFO] PERMISOS SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||' OTORGADOS A '||V_ESQUEMA_3||''); 

	END IF;

	IF V_ESQUEMA_4 != V_ESQUEMA THEN

		EXECUTE IMMEDIATE 'GRANT ALL ON "'||V_ESQUEMA||'"."'||V_TABLA||'" TO "'||V_ESQUEMA_4||'" WITH GRANT OPTION';
		DBMS_OUTPUT.PUT_LINE('[INFO] PERMISOS SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||' OTORGADOS A '||V_ESQUEMA_4||''); 

	END IF;

  EXCEPTION
	     WHEN OTHERS THEN
	          err_num := SQLCODE;
	          err_msg := SQLERRM;
	
	          DBMS_OUTPUT.PUT_LINE('KO no modificada');
	          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
	          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
	          DBMS_OUTPUT.put_line(err_msg);
	
	          ROLLBACK;
	          RAISE;   
  
END;
/

EXIT;
