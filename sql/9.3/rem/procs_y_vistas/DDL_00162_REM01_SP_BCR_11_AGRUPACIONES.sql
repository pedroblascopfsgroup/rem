--/*
--##########################################
--## AUTOR=Daniel Algaba
--## FECHA_CREACION=20210617
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-14271
--## PRODUCTO=NO
--##
--## Finalidad: 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;						

CREATE OR REPLACE PROCEDURE SP_BCR_11_AGRUPACIONES
   (     
      FLAG_EN_REM IN NUMBER
      , SALIDA OUT VARCHAR2
      , COD_RETORNO OUT NUMBER
   )

   AS

   V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar
   V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
   V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
   ERR_NUM NUMBER(25); -- Vble. auxiliar para registrar errores en el script.
   ERR_MSG VARCHAR2(10024 CHAR); -- Vble. auxiliar para registrar errores en el script.
   V_AUX NUMBER(10); -- Variable auxiliar

   V_FECHA_INICIO VARCHAR2(100 CHAR);
   V_FECHA_FIN VARCHAR2(100 CHAR);

BEGIN
      SALIDA := '[INICIO]'||CHR(10);

      #ESQUEMA#.OPERACION_DDL.DDL_TABLE('TRUNCATE','AUX_BC_AGR_SACAR_ACT');
      #ESQUEMA#.OPERACION_DDL.DDL_TABLE('TRUNCATE','AUX_BC_AGRUPACIONES_NUEVAS');
      #ESQUEMA#.OPERACION_DDL.DDL_TABLE('TRUNCATE','AUX_BC_AGRUPACIONES');
      #ESQUEMA#.OPERACION_DDL.DDL_TABLE('TRUNCATE','AUX_BC_AGRUPACIONES_REJECTS');
      #ESQUEMA#.OPERACION_DDL.DDL_TABLE('TRUNCATE','AUX_BC_AGRUPACIONES_ANYADIR');

      SALIDA := SALIDA || '[INFO] SE VA A PROCEDER A ACTUALIZAR/INSERTAR ACTIVOS EN AGRUPACIONES.'|| CHR(10);

      SALIDA := SALIDA || '   [INFO] 0 - CARGAMOS ACTIVOS EN AUXULIAR'||CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES AUX
                  SELECT 
                  APR.NUM_IDENTIFICATIVO ACTIVO
                  , APR.PROMO_CONJUNTA_OB_REM
                  , APR.PROMO_CONJUNTA_VENTA
                  , APR.PROMO_CONJUNTA_ALQUILER
                  , APR.PROMO_COMERCIAL
                  FROM '|| V_ESQUEMA ||'.AUX_APR_BCR_STOCK APR';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      INSERTADOS '|| SQL%ROWCOUNT|| CHR(10);

      SALIDA := SALIDA || '   [INFO] 1 - VALIDAMOS LAS AGRUPACIONES'||CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS
                  WITH PRINCIPAL AS (
                  SELECT 
                  AUX.NUM_IDENTIFICATIVO
                  , APU.DD_TCO_ID
                  FROM AUX_BC_AGRUPACIONES AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.PROMO_CONJUNTA_OB_REM = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_APU_ACTIVO_PUBLICACION APU ON APU.ACT_ID = ACT.ACT_ID AND APU.BORRADO = 0
                  WHERE AUX.PROMO_CONJUNTA_OB_REM IS NOT NULL
                  )
                  SELECT 
                  AUX.NUM_IDENTIFICATIVO
                  , AUX.PROMO_CONJUNTA_OB_REM
                  , NULL PROMO_CONJUNTA_VENTA
                  , NULL PROMO_CONJUNTA_ALQUILER
                  , NULL PROMO_COMERCIAL
                  , ''Restringidas - Tipo de comercialización diferente al principal'' ERROR
                  FROM AUX_BC_AGRUPACIONES AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.NUM_IDENTIFICATIVO = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_APU_ACTIVO_PUBLICACION APU ON APU.ACT_ID = ACT.ACT_ID AND APU.BORRADO = 0
                  JOIN PRINCIPAL PRI ON PRI.NUM_IDENTIFICATIVO = AUX.NUM_IDENTIFICATIVO
                  WHERE AUX.PROMO_CONJUNTA_OB_REM IS NOT NULL
                  AND APU.DD_TCO_ID <> PRI.DD_TCO_ID';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      RECHAZADOS POR TIPO DE COMERCIALIZACIÓN DIFERENTE AL PRINCIPAL '|| SQL%ROWCOUNT|| CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS
                  WITH PRINCIPAL AS (
                  SELECT 
                  AUX.NUM_IDENTIFICATIVO
                  , BIE_LOC.BIE_LOC_COD_POST
                  FROM AUX_BC_AGRUPACIONES AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.PROMO_CONJUNTA_OB_REM = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.BIE_LOCALIZACION BIE_LOC ON ACT.BIE_ID = BIE_LOC.BIE_ID AND BIE_LOC.BORRADO = 0
                  WHERE AUX.PROMO_CONJUNTA_OB_REM IS NOT NULL
                  )
                  SELECT 
                  AUX.NUM_IDENTIFICATIVO
                  , AUX.PROMO_CONJUNTA_OB_REM
                  , NULL PROMO_CONJUNTA_VENTA
                  , NULL PROMO_CONJUNTA_ALQUILER
                  , NULL PROMO_COMERCIAL
                  , ''Restringidas - Activo en diferente ubicación que el principal'' ERROR
                  FROM AUX_BC_AGRUPACIONES AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.NUM_IDENTIFICATIVO = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.BIE_LOCALIZACION BIE_LOC ON ACT.BIE_ID = BIE_LOC.BIE_ID AND BIE_LOC.BORRADO = 0
                  JOIN PRINCIPAL PRI ON PRI.NUM_IDENTIFICATIVO = AUX.NUM_IDENTIFICATIVO
                  WHERE AUX.PROMO_CONJUNTA_OB_REM IS NOT NULL
                  AND BIE_LOC.BIE_LOC_COD_POST <> PRI.BIE_LOC_COD_POST';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      RECHAZADOS POR UBICACIÓN DIFERENTE AL PRINCIPAL '|| SQL%ROWCOUNT|| CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS
                  WITH PRINCIPAL AS (
                  SELECT 
                  AUX.NUM_IDENTIFICATIVO
                  , PRO.PRO_ID
                  FROM AUX_BC_AGRUPACIONES AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.PROMO_CONJUNTA_OB_REM = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_PAC_PROPIETARIO_ACTIVO PRO ON PRO.ACT_ID = ACT.ACT_ID AND PRO.BORRADO = 0
                  WHERE AUX.PROMO_CONJUNTA_OB_REM IS NOT NULL
                  )
                  SELECT 
                  AUX.NUM_IDENTIFICATIVO
                  , AUX.PROMO_CONJUNTA_OB_REM
                  , NULL PROMO_CONJUNTA_VENTA
                  , NULL PROMO_CONJUNTA_ALQUILER
                  , NULL PROMO_COMERCIAL
                  , ''Restringidas - Diferente propietario que el principal'' ERROR
                  FROM AUX_BC_AGRUPACIONES AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.NUM_IDENTIFICATIVO = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_PAC_PROPIETARIO_ACTIVO PRO ON PRO.ACT_ID = ACT.ACT_ID AND PRO.BORRADO = 0
                  JOIN PRINCIPAL PRI ON PRI.NUM_IDENTIFICATIVO = AUX.NUM_IDENTIFICATIVO
                  WHERE AUX.PROMO_CONJUNTA_OB_REM IS NOT NULL
                  AND PRO.PRO_ID <> PRI.PRO_ID';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      RECHAZADOS POR PROPIETARIO DIFERENTE AL PRINCIPAL '|| SQL%ROWCOUNT|| CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS
                  WITH PRINCIPAL AS (
                  SELECT 
                  AUX.NUM_IDENTIFICATIVO
                  , PAC.PAC_INCLUIDO
                  , PAC.PAC_CHECK_ADMISION
                  , PAC.PAC_CHECK_COMERCIALIZAR
                  , PAC.PAC_CHECK_FORMALIZAR
                  , PAC.PAC_CHECK_GESTIONAR
                  FROM AUX_BC_AGRUPACIONES AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.PROMO_CONJUNTA_OB_REM = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID AND PAC.BORRADO = 0
                  WHERE AUX.PROMO_CONJUNTA_OB_REM IS NOT NULL
                  )
                  SELECT 
                  AUX.NUM_IDENTIFICATIVO
                  , AUX.PROMO_CONJUNTA_OB_REM
                  , NULL PROMO_CONJUNTA_VENTA
                  , NULL PROMO_CONJUNTA_ALQUILER
                  , NULL PROMO_COMERCIAL
                  , ''Restringidas - Diferente perímetro que el principal'' ERROR
                  FROM AUX_BC_AGRUPACIONES AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.NUM_IDENTIFICATIVO = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID AND PAC.BORRADO = 0
                  JOIN PRINCIPAL PRI ON PRI.NUM_IDENTIFICATIVO = AUX.NUM_IDENTIFICATIVO
                  WHERE AUX.PROMO_CONJUNTA_OB_REM IS NOT NULL
                  AND (PAC.PAC_INCLUIDO <> PRI.PAC_INCLUIDO
                  OR PAC.PAC_CHECK_ADMISION <> PRI.PAC_CHECK_ADMISION
                  OR PAC.PAC_CHECK_ADMISION <> PRI.PAC_CHECK_ADMISION
                  OR PAC.PAC_CHECK_COMERCIALIZAR <> PRI.PAC_CHECK_COMERCIALIZAR
                  OR PAC.PAC_CHECK_FORMALIZAR <> PRI.PAC_CHECK_FORMALIZAR
                  OR PAC.PAC_CHECK_GESTIONAR <> PRI.PAC_CHECK_GESTIONAR)';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      RECHAZADOS POR PERÍMETRO DIFERENTE AL PRINCIPAL '|| SQL%ROWCOUNT|| CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS
                  SELECT 
                  AUX.NUM_IDENTIFICATIVO
                  , NULL PROMO_CONJUNTA_OB_REM
                  , AUX.PROMO_CONJUNTA_VENTA
                  , NULL PROMO_CONJUNTA_ALQUILER
                  , NULL PROMO_COMERCIAL
                  , ''Comercial-venta - Tipo de comercialización diferente a venta'' ERROR
                  FROM AUX_BC_AGRUPACIONES AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.NUM_IDENTIFICATIVO = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_APU_ACTIVO_PUBLICACION APU ON APU.ACT_ID = ACT.ACT_ID AND APU.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.DD_TCO_TIPO_COMERCIALIZACION TCO ON TCO.DD_TCO_ID = APU.DD_TCO_ID AND TCO.BORRADO = 0
                  WHERE AUX.PROMO_CONJUNTA_VENTA IS NOT NULL
                  AND TCO.DD_TCO_CODIGO NOT IN (''01'',''02'')';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      RECHAZADOS POR TIPO DE COMERCIALIZACIÓN DIFERENTE A VENTA '|| SQL%ROWCOUNT|| CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS
                  WITH PRINCIPAL AS (
                  SELECT 
                  AUX.NUM_IDENTIFICATIVO
                  , PAC.PAC_CHECK_FORMALIZAR
                  FROM AUX_BC_AGRUPACIONES AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.PROMO_CONJUNTA_VENTA = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID AND PAC.BORRADO = 0
                  WHERE AUX.PROMO_CONJUNTA_VENTA IS NOT NULL
                  )
                  SELECT 
                  AUX.NUM_IDENTIFICATIVO
                  , NULL PROMO_CONJUNTA_OB_REM
                  , AUX.PROMO_CONJUNTA_VENTA
                  , NULL PROMO_CONJUNTA_ALQUILER
                  , NULL PROMO_COMERCIAL
                  , ''Comercial-venta - Diferente estado de formalización'' ERROR
                  FROM AUX_BC_AGRUPACIONES AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.NUM_IDENTIFICATIVO = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID AND PAC.BORRADO = 0
                  JOIN PRINCIPAL PRI ON PRI.NUM_IDENTIFICATIVO = AUX.NUM_IDENTIFICATIVO
                  WHERE AUX.PROMO_CONJUNTA_VENTA IS NOT NULL
                  AND PAC.PAC_CHECK_FORMALIZAR <> PRI.PAC_CHECK_FORMALIZAR';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      RECHAZADOS POR FORMALIZACIÓN DIFERENTE '|| SQL%ROWCOUNT|| CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS
                  SELECT 
                  AUX.NUM_IDENTIFICATIVO
                  , NULL PROMO_CONJUNTA_OB_REM
                  , NULL PROMO_CONJUNTA_VENTA
                  , AUX.PROMO_CONJUNTA_ALQUILER
                  , NULL PROMO_COMERCIAL
                  , ''Comercial-alquiler - Tipo de comercialización diferente a alquiler'' ERROR
                  FROM AUX_BC_AGRUPACIONES AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.NUM_IDENTIFICATIVO = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_APU_ACTIVO_PUBLICACION APU ON APU.ACT_ID = ACT.ACT_ID AND APU.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.DD_TCO_TIPO_COMERCIALIZACION TCO ON TCO.DD_TCO_ID = APU.DD_TCO_ID AND TCO.BORRADO = 0
                  WHERE AUX.PROMO_CONJUNTA_ALQUILER IS NOT NULL
                  AND TCO.DD_TCO_CODIGO NOT IN (''02'',''03'')';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      RECHAZADOS POR TIPO DE COMERCIALIZACIÓN DIFERENTE A ALQUILER '|| SQL%ROWCOUNT|| CHR(10);

      SALIDA := SALIDA || '   [INFO] 2 - ACTIVOS QUE CAMBIAN DE AGRUPACIÓN'||CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGR_SACAR_ACT AUX
                  SELECT 
                  AGR.AGR_UVEM_COAGIW COD_AGRUPACION
                  , ''02'' TIPO
                  , APR.NUM_IDENTIFICATIVO ACTIVO
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES APR
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON APR.NUM_IDENTIFICATIVO = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGA.ACT_ID = ACT.ACT_ID AND AGA.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_ID = AGA.AGR_ID AND AGR.BORRADO = 0 AND AGR.AGR_FECHA_BAJA IS NULL AND AGR.AGR_UVEM_COAGIW IS NOT NULL
                  JOIN '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION TAG ON AGR.DD_TAG_ID = TAG.DD_TAG_ID AND TAG.BORRADO = 0 AND TAG.DD_TAG_CODIGO = ''02''
                  WHERE NVL(APR.PROMO_CONJUNTA_OB_REM,-1) <> AGR.AGR_UVEM_COAGIW';
   
      EXECUTE IMMEDIATE V_MSQL;

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGR_SACAR_ACT AUX
                  SELECT 
                  AGR.AGR_UVEM_COAGIW COD_AGRUPACION
                  , ''14'' TIPO
                  , APR.NUM_IDENTIFICATIVO ACTIVO
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES APR
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON APR.NUM_IDENTIFICATIVO = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGA.ACT_ID = ACT.ACT_ID AND AGA.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_ID = AGA.AGR_ID AND AGR.BORRADO = 0 AND AGR.AGR_FECHA_BAJA IS NULL AND AGR.AGR_UVEM_COAGIW IS NOT NULL
                  JOIN '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION TAG ON AGR.DD_TAG_ID = TAG.DD_TAG_ID AND TAG.BORRADO = 0 AND TAG.DD_TAG_CODIGO = ''14''
                  WHERE NVL(APR.PROMO_CONJUNTA_VENTA,-1) <> AGR.AGR_UVEM_COAGIW';
   
      EXECUTE IMMEDIATE V_MSQL;

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGR_SACAR_ACT AUX
                  SELECT 
                  AGR.AGR_UVEM_COAGIW COD_AGRUPACION
                  , ''15'' TIPO
                  , APR.NUM_IDENTIFICATIVO ACTIVO
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES APR
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON APR.NUM_IDENTIFICATIVO = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGA.ACT_ID = ACT.ACT_ID AND AGA.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_ID = AGA.AGR_ID AND AGR.BORRADO = 0 AND AGR.AGR_FECHA_BAJA IS NULL AND AGR.AGR_UVEM_COAGIW IS NOT NULL
                  JOIN '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION TAG ON AGR.DD_TAG_ID = TAG.DD_TAG_ID AND TAG.BORRADO = 0 AND TAG.DD_TAG_CODIGO = ''15''
                  WHERE NVL(APR.PROMO_CONJUNTA_ALQUILER,-1) <> AGR.AGR_UVEM_COAGIW';
   
      EXECUTE IMMEDIATE V_MSQL;

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGR_SACAR_ACT AUX
                  SELECT 
                  AGR.AGR_UVEM_COAGIW COD_AGRUPACION
                  , ''01'' TIPO
                  , APR.NUM_IDENTIFICATIVO ACTIVO
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES APR
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON APR.NUM_IDENTIFICATIVO = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGA.ACT_ID = ACT.ACT_ID AND AGA.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_ID = AGA.AGR_ID AND AGR.BORRADO = 0 AND AGR.AGR_FECHA_BAJA IS NULL AND AGR.AGR_UVEM_COAGIW IS NOT NULL
                  JOIN '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION TAG ON AGR.DD_TAG_ID = TAG.DD_TAG_ID AND TAG.BORRADO = 0 AND TAG.DD_TAG_CODIGO = ''01''
                  WHERE NVL(APR.PROMO_COMERCIAL,-1) <> AGR.AGR_UVEM_COAGIW';
   
      EXECUTE IMMEDIATE V_MSQL;

      V_MSQL := 'MERGE INTO '|| V_ESQUEMA ||'.ACT_AGA_AGRUPACION_ACTIVO AGA
                  USING (
                  SELECT 
                  AGA.AGA_ID
                  , ACT.ACT_ID
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGR_SACAR_ACT AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_UVEM_COAGIW = AUX.COD_AGRUPACION AND AGR.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.ACTIVO = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGR.AGR_ID = AGA.AGR_ID AND AGA.ACT_ID = ACT.ACT_ID AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = AUX.TIPO) AND AGA.BORRADO = 0
                  ) AUX
                  ON (AGA.AGA_ID = AUX.AGA_ID)
                  WHEN MATCHED THEN
                     UPDATE SET AGA.BORRADO = 1
                     , AGA.USUARIOBORRAR = ''STOCK_BC''
                     , AGA.FECHABORRAR = SYSDATE';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      RELACIONADOS '|| SQL%ROWCOUNT|| CHR(10);

      SALIDA := SALIDA || '   [INFO] 3 - AÑADIR ACTIVOS A AGRUPACIONES EXISTENTES'||CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_ANYADIR AUX
                  SELECT 
                  APR.PROMO_CONJUNTA_OB_REM COD_AGRUPACION
                  , ''02'' TIPO
                  , APR.NUM_IDENTIFICATIVO ACTIVO
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES APR
                  WHERE APR.PROMO_CONJUNTA_OB_REM IS NOT NULL
                  AND EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR 
                  WHERE AGR.BORRADO = 0 
                  AND AGR.AGR_FECHA_BAJA IS NULL
                  AND AGR.AGR_UVEM_COAGIW = APR.PROMO_CONJUNTA_OB_REM)
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS REJ
                  WHERE REJ.PROMO_CONJUNTA_OB_REM IS NOT NULL
                  AND REJ.NUM_IDENTIFICATIVO = APR.NUM_IDENTIFICATIVO
                  AND REJ.PROMO_CONJUNTA_OB_REM = APR.PROMO_CONJUNTA_OB_REM)';
   
      EXECUTE IMMEDIATE V_MSQL;

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_ANYADIR AUX
                  SELECT 
                  APR.PROMO_CONJUNTA_VENTA COD_AGRUPACION
                  , ''14'' TIPO
                  , APR.NUM_IDENTIFICATIVO ACTIVO
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES APR
                  WHERE APR.PROMO_CONJUNTA_VENTA IS NOT NULL
                  AND EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR 
                  WHERE AGR.BORRADO = 0 
                  AND AGR.AGR_FECHA_BAJA IS NULL
                  AND AGR.AGR_UVEM_COAGIW = APR.PROMO_CONJUNTA_VENTA)
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS REJ
                  WHERE REJ.PROMO_CONJUNTA_VENTA IS NOT NULL
                  AND REJ.NUM_IDENTIFICATIVO = APR.NUM_IDENTIFICATIVO
                  AND REJ.PROMO_CONJUNTA_VENTA = APR.PROMO_CONJUNTA_VENTA)';
   
      EXECUTE IMMEDIATE V_MSQL;

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_ANYADIR AUX
                  SELECT 
                  APR.PROMO_CONJUNTA_ALQUILER COD_AGRUPACION
                  , ''15'' TIPO
                  , APR.NUM_IDENTIFICATIVO ACTIVO
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES APR
                  WHERE APR.PROMO_CONJUNTA_ALQUILER IS NOT NULL
                  AND EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR 
                  WHERE AGR.BORRADO = 0 
                  AND AGR.AGR_FECHA_BAJA IS NULL
                  AND AGR.AGR_UVEM_COAGIW = APR.PROMO_CONJUNTA_ALQUILER)
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS REJ
                  WHERE REJ.PROMO_CONJUNTA_ALQUILER IS NOT NULL
                  AND REJ.NUM_IDENTIFICATIVO = APR.NUM_IDENTIFICATIVO
                  AND REJ.PROMO_CONJUNTA_ALQUILER = APR.PROMO_CONJUNTA_ALQUILER)';
   
      EXECUTE IMMEDIATE V_MSQL;

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_ANYADIR AUX
                  SELECT 
                  APR.PROMO_COMERCIAL COD_AGRUPACION
                  , ''01'' TIPO
                  , APR.NUM_IDENTIFICATIVO ACTIVO
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES APR
                  WHERE APR.PROMO_COMERCIAL IS NOT NULL
                  AND EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR 
                  WHERE AGR.BORRADO = 0 
                  AND AGR.AGR_FECHA_BAJA IS NULL
                  AND AGR.AGR_UVEM_COAGIW = APR.PROMO_COMERCIAL)
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS REJ
                  WHERE REJ.PROMO_COMERCIAL IS NOT NULL
                  AND REJ.NUM_IDENTIFICATIVO = APR.NUM_IDENTIFICATIVO
                  AND REJ.PROMO_COMERCIAL = APR.PROMO_COMERCIAL)';
   
      EXECUTE IMMEDIATE V_MSQL;

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.ACT_AGA_AGRUPACION_ACTIVO
                  (AGA_ID
                  , AGR_ID
                  , ACT_ID
                  , AGA_FECHA_INCLUSION
                  , ACT_AGA_PARTICIPACION_UA
                  , USUARIOCREAR
                  , FECHACREAR)
                  SELECT 
                  '|| V_ESQUEMA ||'.S_ACT_AGA_AGRUPACION_ACTIVO.NEXTVAL AGA_ID
                  , AGR.AGR_ID
                  , ACT.ACT_ID
                  , SYSDATE AGA_FECHA_INCLUSION
                  , NULL ACT_AGA_PARTICIPACION_UA
                  , ''STOCK_BC'' USUARIOCREAR
                  , SYSDATE FECHACREAR
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_ANYADIR AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON AUX.ACTIVO = ACT.ACT_NUM_ACTIVO_CAIXA AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_UVEM_COAGIW = AUX.COD_AGRUPACION AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = AUX.TIPO) AND AGR.BORRADO = 0 
                  WHERE AGR.AGR_FECHA_BAJA IS NULL
                  AND NOT EXISTS (SELECT 1 FROM '|| V_ESQUEMA ||'.ACT_AGA_AGRUPACION_ACTIVO AGA WHERE AGA.BORRADO = 0 AND AGR.AGR_ID = AGA.AGR_ID AND ACT.ACT_ID = AGA.ACT_ID)';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      RELACIONADOS '|| SQL%ROWCOUNT|| CHR(10);

      SALIDA := SALIDA || '   [INFO] 4 - AGRUPACIONES NUEVAS'||CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_NUEVAS AUX
                  SELECT 
                  APR.PROMO_CONJUNTA_OB_REM COD_AGRUPACION
                  , ''02'' TIPO
                  , APR.NUM_IDENTIFICATIVO ACTIVO
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES APR
                  WHERE APR.PROMO_CONJUNTA_OB_REM IS NOT NULL
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR 
                  WHERE AGR.BORRADO = 0 
                  AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''02'')
                  AND AGR.AGR_FECHA_BAJA IS NULL
                  AND AGR.AGR_UVEM_COAGIW = APR.PROMO_CONJUNTA_OB_REM)
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS REJ
                  WHERE REJ.PROMO_CONJUNTA_OB_REM IS NOT NULL
                  AND REJ.NUM_IDENTIFICATIVO = APR.NUM_IDENTIFICATIVO
                  AND REJ.PROMO_CONJUNTA_OB_REM = APR.PROMO_CONJUNTA_OB_REM)
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS REJ
                  WHERE REJ.PROMO_CONJUNTA_OB_REM IS NOT NULL
                  AND REJ.NUM_IDENTIFICATIVO = APR.PROMO_CONJUNTA_OB_REM)';
   
      EXECUTE IMMEDIATE V_MSQL;

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_NUEVAS AUX
                  SELECT 
                  APR.PROMO_CONJUNTA_VENTA COD_AGRUPACION
                  , ''14'' TIPO
                  , APR.NUM_IDENTIFICATIVO ACTIVO
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES APR
                  WHERE APR.PROMO_CONJUNTA_VENTA IS NOT NULL
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR 
                  WHERE AGR.BORRADO = 0 
                  AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''14'')
                  AND AGR.AGR_FECHA_BAJA IS NULL
                  AND AGR.AGR_UVEM_COAGIW = APR.PROMO_CONJUNTA_VENTA)
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS REJ
                  WHERE REJ.PROMO_CONJUNTA_VENTA IS NOT NULL
                  AND REJ.NUM_IDENTIFICATIVO = APR.NUM_IDENTIFICATIVO
                  AND REJ.PROMO_CONJUNTA_VENTA = APR.PROMO_CONJUNTA_VENTA)
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS REJ
                  WHERE REJ.PROMO_CONJUNTA_VENTA IS NOT NULL
                  AND REJ.NUM_IDENTIFICATIVO = APR.PROMO_CONJUNTA_VENTA)';
   
      EXECUTE IMMEDIATE V_MSQL;

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_NUEVAS AUX
                  SELECT 
                  APR.PROMO_CONJUNTA_ALQUILER COD_AGRUPACION
                  , ''15'' TIPO
                  , APR.NUM_IDENTIFICATIVO ACTIVO
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES APR
                  WHERE APR.PROMO_CONJUNTA_ALQUILER IS NOT NULL
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR 
                  WHERE AGR.BORRADO = 0 
                  AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''15'')
                  AND AGR.AGR_FECHA_BAJA IS NULL
                  AND AGR.AGR_UVEM_COAGIW = APR.PROMO_CONJUNTA_ALQUILER)
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS REJ
                  WHERE REJ.PROMO_CONJUNTA_ALQUILER IS NOT NULL
                  AND REJ.NUM_IDENTIFICATIVO = APR.NUM_IDENTIFICATIVO
                  AND REJ.PROMO_CONJUNTA_ALQUILER = APR.PROMO_CONJUNTA_ALQUILER)
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS REJ
                  WHERE REJ.PROMO_CONJUNTA_ALQUILER IS NOT NULL
                  AND REJ.NUM_IDENTIFICATIVO = APR.PROMO_CONJUNTA_ALQUILER)';
   
      EXECUTE IMMEDIATE V_MSQL;

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_NUEVAS AUX
                  SELECT 
                  APR.PROMO_COMERCIAL COD_AGRUPACION
                  , ''01'' TIPO
                  , APR.NUM_IDENTIFICATIVO ACTIVO
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES APR
                  WHERE APR.PROMO_COMERCIAL IS NOT NULL
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR 
                  WHERE AGR.BORRADO = 0 
                  AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''01'')
                  AND AGR.AGR_FECHA_BAJA IS NULL
                  AND AGR.AGR_UVEM_COAGIW = APR.PROMO_COMERCIAL)
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS REJ
                  WHERE REJ.PROMO_COMERCIAL IS NOT NULL
                  AND REJ.NUM_IDENTIFICATIVO = APR.NUM_IDENTIFICATIVO
                  AND REJ.PROMO_COMERCIAL = APR.PROMO_COMERCIAL)
                  AND NOT EXISTS (SELECT 1 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_REJECTS REJ
                  WHERE REJ.PROMO_COMERCIAL IS NOT NULL
                  AND REJ.NUM_IDENTIFICATIVO = APR.PROMO_COMERCIAL)';
   
      EXECUTE IMMEDIATE V_MSQL;

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION
                  (AGR_ID
                  , DD_TAG_ID
                  , AGR_NOMBRE
                  , AGR_NUM_AGRUP_REM
                  , AGR_FECHA_ALTA
                  , AGR_ACT_PRINCIPAL
                  , AGR_SEG_VISITAS
                  , USUARIOCREAR
                  , FECHACREAR
                  , AGR_IS_FORMALIZACION
                  , AGR_UVEM_COAGIW)
                  SELECT 
                  '|| V_ESQUEMA ||'.S_ACT_AGR_AGRUPACION.NEXTVAL AGR_ID
                  , (SELECT DD_TAG_ID FROM '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = AUX.TIPO) DD_TAG_ID
                  , BIE_LOC.BIE_LOC_NOMBRE_VIA || '' '' || BIE_LOC.BIE_LOC_PORTAL AGR_NOMBRE
                  , '|| V_ESQUEMA ||'.S_AGR_NUM_AGRUP_REM.NEXTVAL AGR_NUM_AGRUP_REM
                  , SYSDATE AGR_FECHA_ALTA
                  , CASE WHEN AUX.TIPO = ''02'' THEN ACT.ACT_ID ELSE NULL END AGR_ACT_PRINCIPAL
                  , 0 AGR_SEG_VISITAS
                  , ''STOCK_BC'' USUARIOCREAR
                  , SYSDATE FECHACREAR
                  , 1 AGR_IS_FORMALIZACION
                  , AUX.COD_AGRUPACION AGR_UVEM_COAGIW
                  FROM (SELECT BCAN.COD_AGRUPACION, BCAN.ACTIVO, BCAN.TIPO 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_NUEVAS BCAN
                  WHERE BCAN.COD_AGRUPACION = BCAN.ACTIVO) AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO_CAIXA = AUX.ACTIVO AND ACT.BORRADO = 0
                  LEFT JOIN '|| V_ESQUEMA ||'.BIE_LOCALIZACION BIE_LOC ON ACT.BIE_ID = BIE_LOC.BIE_ID AND BIE_LOC.BORRADO = 0';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      AGRUPACIONES NUEVAS '|| SQL%ROWCOUNT|| CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.ACT_RES_RESTRINGIDA
                  (AGR_ID
                  , DD_PRV_ID
                  , DD_LOC_ID
                  , RES_DIRECCION
                  , RES_CP)
                  SELECT 
                  AGR_ID
                  , BIE_LOC.DD_PRV_ID
                  , BIE_LOC.DD_LOC_ID
                  , BIE_LOC.BIE_LOC_NOMBRE_VIA || '' '' || BIE_LOC.BIE_LOC_PORTAL RES_DIRECCION
                  , BIE_LOC.BIE_LOC_COD_POST RES_CP
                  FROM (SELECT BCAN.COD_AGRUPACION, BCAN.ACTIVO, BCAN.TIPO 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_NUEVAS BCAN
                  WHERE BCAN.COD_AGRUPACION = BCAN.ACTIVO
                  AND BCAN.TIPO = ''02'') AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO_CAIXA = AUX.ACTIVO AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_ACT_PRINCIPAL = ACT.ACT_ID AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = AUX.TIPO) AND AGR.BORRADO = 0
                  LEFT JOIN '|| V_ESQUEMA ||'.BIE_LOCALIZACION BIE_LOC ON ACT.BIE_ID = BIE_LOC.BIE_ID AND BIE_LOC.BORRADO = 0';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      RESTRINGIDAS '|| SQL%ROWCOUNT|| CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.ACT_LCO_LOTE_COMERCIAL
                  (AGR_ID
                  , DD_PRV_ID
                  , DD_LOC_ID
                  , LCO_CP)
                  SELECT 
                  AGR_ID
                  , BIE_LOC.DD_PRV_ID
                  , BIE_LOC.DD_LOC_ID
                  , BIE_LOC.BIE_LOC_COD_POST LCO_CP
                  FROM (SELECT BCAN.COD_AGRUPACION, BCAN.TIPO 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_NUEVAS BCAN
                  WHERE BCAN.TIPO = ''14''
                  GROUP BY BCAN.COD_AGRUPACION, BCAN.TIPO) AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO_CAIXA = AUX.COD_AGRUPACION AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_UVEM_COAGIW = AUX.COD_AGRUPACION AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = AUX.TIPO) AND AGR.BORRADO = 0
                  LEFT JOIN '|| V_ESQUEMA ||'.BIE_LOCALIZACION BIE_LOC ON ACT.BIE_ID = BIE_LOC.BIE_ID AND BIE_LOC.BORRADO = 0';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      COMERCIAL VENTA '|| SQL%ROWCOUNT|| CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.ACT_LCO_LOTE_COMERCIAL
                  (AGR_ID
                  , DD_PRV_ID
                  , DD_LOC_ID
                  , LCO_CP)
                  SELECT 
                  AGR_ID
                  , BIE_LOC.DD_PRV_ID
                  , BIE_LOC.DD_LOC_ID
                  , BIE_LOC.BIE_LOC_COD_POST LCO_CP
                  FROM (SELECT BCAN.COD_AGRUPACION, BCAN.TIPO 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_NUEVAS BCAN
                  WHERE BCAN.TIPO = ''15''
                  GROUP BY BCAN.COD_AGRUPACION, BCAN.TIPO) AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO_CAIXA = AUX.COD_AGRUPACION AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_UVEM_COAGIW = AUX.COD_AGRUPACION AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = AUX.TIPO) AND AGR.BORRADO = 0
                  LEFT JOIN '|| V_ESQUEMA ||'.BIE_LOCALIZACION BIE_LOC ON ACT.BIE_ID = BIE_LOC.BIE_ID AND BIE_LOC.BORRADO = 0';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      COMERCIAL ALQUILER '|| SQL%ROWCOUNT|| CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.ACT_ONV_OBRA_NUEVA
                  (AGR_ID
                  , DD_PRV_ID
                  , DD_LOC_ID
                  , ONV_DIRECCION
                  , ONV_CP)
                  SELECT 
                  AGR_ID
                  , BIE_LOC.DD_PRV_ID
                  , BIE_LOC.DD_LOC_ID
                  , BIE_LOC.BIE_LOC_NOMBRE_VIA || '' '' || BIE_LOC.BIE_LOC_PORTAL ONV_DIRECCION
                  , BIE_LOC.BIE_LOC_COD_POST ONV_CP
                  FROM (SELECT BCAN.COD_AGRUPACION, BCAN.TIPO 
                  FROM '|| V_ESQUEMA ||'.AUX_BC_AGRUPACIONES_NUEVAS BCAN
                  WHERE BCAN.TIPO = ''01''
                  GROUP BY BCAN.COD_AGRUPACION, BCAN.TIPO) AUX
                  JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO_CAIXA = AUX.COD_AGRUPACION AND ACT.BORRADO = 0
                  JOIN '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_UVEM_COAGIW = AUX.COD_AGRUPACION AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = AUX.TIPO) AND AGR.BORRADO = 0
                  LEFT JOIN '|| V_ESQUEMA ||'.BIE_LOCALIZACION BIE_LOC ON ACT.BIE_ID = BIE_LOC.BIE_ID AND BIE_LOC.BORRADO = 0';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      OBRA NUEVA '|| SQL%ROWCOUNT|| CHR(10);

      V_MSQL := 'INSERT INTO '|| V_ESQUEMA ||'.ACT_AGA_AGRUPACION_ACTIVO
               (AGA_ID
               , AGR_ID
               , ACT_ID
               , AGA_FECHA_INCLUSION
               , AGA_PRINCIPAL
               , ACT_AGA_PARTICIPACION_UA
               , USUARIOCREAR
               , FECHACREAR)
               SELECT 
               '|| V_ESQUEMA ||'.S_ACT_AGA_AGRUPACION_ACTIVO.NEXTVAL AGA_ID
               , AGR.AGR_ID
               , ACT.ACT_ID
               , SYSDATE AGA_FECHA_INCLUSION
               , CASE WHEN AUX.TIPO = ''02'' AND AUX.COD_AGRUPACION = AUX.ACTIVO THEN 1 
                  WHEN AUX.TIPO = ''02'' THEN 0
                  ELSE NULL END AGA_PRINCIPAL
               , NULL ACT_AGA_PARTICIPACION_UA
               , ''STOCK_BC'' USUARIOCREAR
               , SYSDATE FECHACREAR
               FROM AUX_BC_AGRUPACIONES_NUEVAS AUX
               JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO_CAIXA = AUX.ACTIVO AND ACT.BORRADO = 0
               JOIN '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_UVEM_COAGIW = AUX.COD_AGRUPACION AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM '|| V_ESQUEMA ||'.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = AUX.TIPO) AND AGR.BORRADO = 0';
   
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      ACTIVOS RELACIONADOS '|| SQL%ROWCOUNT|| CHR(10);

      SALIDA := SALIDA || '   [INFO] 5 - AGRUPACIONES SIN ACTIVOS'||CHR(10);

      V_MSQL := 'MERGE INTO '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR
                  USING (
                  SELECT 
                  AGR.AGR_ID, AGR.AGR_NUM_AGRUP_REM
                  FROM '|| V_ESQUEMA ||'.ACT_AGR_AGRUPACION AGR
                  WHERE AGR.BORRADO = 0 
                  AND AGR.AGR_UVEM_COAGIW IS NOT NULL
                  AND AGR.AGR_FECHA_BAJA IS NULL
                  AND 0 = (SELECT COUNT(AGA.ACT_ID)
                  FROM '|| V_ESQUEMA ||'.ACT_AGA_AGRUPACION_ACTIVO AGA
                  WHERE AGA.BORRADO = 0 
                  AND AGA.AGR_ID = AGR.AGR_ID)
                  ) AUX
                  ON (AGR.AGR_ID = AUX.AGR_ID)
                  WHEN MATCHED THEN
                     UPDATE SET AGR.AGR_FECHA_BAJA = SYSDATE
                     , AGR.USUARIOMODIFICAR = ''STOCK_BC''
                     , AGR.FECHAMODIFICAR = SYSDATE';
                     
      EXECUTE IMMEDIATE V_MSQL;

      SALIDA := SALIDA || '   [INFO]      AGRUPACIONES DADAS DE BAJA '|| SQL%ROWCOUNT|| CHR(10);

COMMIT;

EXCEPTION
   WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      SALIDA := SALIDA || CHR(10) ||'    [ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM);
      SALIDA := SALIDA || CHR(10) ||'    '||ERR_MSG;
      ROLLBACK;
      RAISE;
END SP_BCR_11_AGRUPACIONES;
/
EXIT;
