--/*
--##########################################
--## AUTOR=Santi Monzó
--## FECHA_CREACION=20220822
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-18574
--## PRODUCTO=NO
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        HREOS-HREOS-17405: Vista para sacar las ofertas de una agrupación o activo, en concurrencia y ordenadas.
--##        HREOS-17698: Añadir deposito para sacar su estado, y concurrencia.
--##        HREOS-18320: Cambior de donde se aprovisionan los campos de FECHA_INGRESO_DEPOSITO y FECHA_INGRESO_DOCUMENTACION.
--##        HREOS-18322: Quitar relaciones con la tabla OFC_OFERTAS_CONCURRENCIA.
--##        HREOS-18445: Alejandro Valverde - Añadir campo FECHA_ENT_CRM_SF
--##        HREOS-18511: Javier Esbri - Añadir campo OFR_CONCURRENCIA
--##		HREOS-18526: Alejandro Valverde - Eliminar comprobacion DEP_FECHA_INICIO IS NOT NULL
--##        HREOS-18574  Santi Monzó - Incidencia DIASCONCURRENCIA
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    seq_count number(3); -- Vble. para validar la existencia de las Secuencias.
    table_count number(3); -- Vble. para validar la existencia de las Tablas.
    v_column_count number(3); -- Vble. para validar la existencia de las Columnas.    
    v_constraint_count number(3); -- Vble. para validar la existencia de las Constraints.
    err_num NUMBER; -- N?mero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_MSQL VARCHAR2(32000 CHAR); 

    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'VI_GRID_OFR_ACT_AGR_CONCU' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.VI_GRID_OFR_ACT_AGR_CONCU...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.VI_GRID_OFR_ACT_AGR_CONCU... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'VI_GRID_OFR_ACT_AGR_CONCU' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.VI_GRID_OFR_ACT_AGR_CONCU...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.VI_GRID_OFR_ACT_AGR_CONCU... borrada OK');
  END IF;

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.VI_GRID_OFR_ACT_AGR_CONCU...');
  V_MSQL := 'CREATE VIEW ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU
	AS
		
		WITH ORDENACIONCONCURRENCIA AS (
			SELECT ID as IDOFERTA, ROWNUM as ORDENFINAL FROM(
				SELECT
				
					OFR.OFR_ID AS ID,
					row_number() over (order by OFR.OFR_IMPORTE desc) as numFila,
					1 as orden,
					ofr.OFR_IMPORTE AS IMPORTE
					
					FROM ' || V_ESQUEMA || '.OFR_OFERTAS OFR
					JOIN ' || V_ESQUEMA || '.DEP_DEPOSITO DEP ON DEP.OFR_ID = OFR.OFR_ID AND DEP.DEP_FECHA_INGRESO IS NOT NULL AND DEP.BORRADO = 0
					WHERE OFR.BORRADO  = 0  AND OFR.OFR_CONCURRENCIA = 1
					
				UNION 
					SELECT
					OFR.OFR_ID AS ID,
					row_number() over (order by OFR.OFR_IMPORTE desc) as numFila,
					2 as orden,
					ofr.OFR_IMPORTE AS IMPORTE
					
					FROM ' || V_ESQUEMA || '.OFR_OFERTAS OFR
					JOIN ' || V_ESQUEMA || '.DEP_DEPOSITO DEP ON DEP.OFR_ID = OFR.OFR_ID AND DEP.DEP_FECHA_INGRESO IS NULL AND DEP.DEP_FECHA_INICIO IS NOT NULL AND DEP.BORRADO = 0
					WHERE OFR.BORRADO  = 0  AND OFR.OFR_CONCURRENCIA = 1
						
				UNION
					SELECT
					OFR.OFR_ID AS ID,
					row_number() over (order by OFR.OFR_IMPORTE desc) as numFila,
					3 as orden,
					ofr.OFR_IMPORTE AS IMPORTE
					
					FROM ' || V_ESQUEMA || '.OFR_OFERTAS OFR
					JOIN ' || V_ESQUEMA || '.DEP_DEPOSITO DEP ON DEP.OFR_ID = OFR.OFR_ID AND DEP.DEP_FECHA_INGRESO IS NULL AND DEP.DEP_FECHA_INICIO IS NULL AND DEP.BORRADO = 0
					WHERE OFR.BORRADO  = 0  AND OFR.OFR_CONCURRENCIA = 1
				
				ORDER BY ORDEN, numFila ASC
			) T
		)  
		
		 SELECT
				OFR.OFR_ID AS ID,
		    OFR.OFR_NUM_OFERTA,
				OFR.OFR_FECHA_ALTA,
		    TOF.DD_TOF_DESCRIPCION,
				TOF.DD_TOF_CODIGO,
				NVL2(AGR.AGR_NUM_AGRUP_REM, AGR.AGR_NUM_AGRUP_REM, ACT.ACT_NUM_ACTIVO) AS NUM_ACTIVO_AGRUPACION,
		    	NVL2(CLC.CLC_RAZON_SOCIAL,CLC.CLC_RAZON_SOCIAL, CLC.CLC_NOMBRE || NVL2(CLC.CLC_APELLIDOS, '' '' || CLC.CLC_APELLIDOS, '''')) AS OFERTANTE,
		    OFR.OFR_IMPORTE,
				OFR.OFR_IMPORTE_CONTRAOFERTA,
		    EOF.DD_EOF_DESCRIPCION,
				EOF.DD_EOF_CODIGO,
		    ECO.ECO_NUM_EXPEDIENTE,
				ECO.ECO_ID,
		    EEC.DD_EEC_DESCRIPCION,
				EEC.DD_EEC_CODIGO,
				AGR.AGR_ID,
		    OFR.OFR_ID,
				ACT.ACT_ID,
				TPR.DD_TPR_CODIGO AS CANAL,
				TPR.DD_TPR_DESCRIPCION AS CANAL_DESCRIPCION,
				OFR.OFR_OFERTA_EXPRESS AS OFERTA_EXPRESS,
				DECODE(GEN.ACT_ID,NULL,0,1)  AS GENCAT,
		  	C4C.DD_ECC_CODIGO AS EST_CODIGO_C4C,
        	DEP.DEP_FECHA_INGRESO as FECHA_INGRESO_DEPOSITO,
        	DEP.DEP_FECHA_INICIO AS FECHA_INGRESO_DOCUMENTACION,
			EDP.DD_EDP_DESCRIPCION,
				EDP.DD_EDP_CODIGO,
			CON.CON_ID,
				CON.CON_FECHA_INI AS FECHA_INICIO_CONCURRENCIA,
				CON.CON_FECHA_FIN AS FECHA_FIN_CONCURRENCIA,
				,CASE
					WHEN CON.CON_FECHA_FIN > sysdate THEN ROUND(SYSDATE-OFR.OFR_FECHA_ALTA, 0)
					ELSE ROUND(CON.CON_FECHA_FIN-OFR.OFR_FECHA_ALTA, 0)         
				END AS DIASCONCURRENCIA
			ORDENACION.ORDENFINAL	AS ORDEN_GANADOR,
			OFR.FECHA_ENT_CRM_SF,
			OFR.OFR_CONCURRENCIA AS OFERTA_CONCURRENCIA

		FROM ' || V_ESQUEMA || '.OFR_OFERTAS OFR
		JOIN ORDENACIONCONCURRENCIA ORDENACION								ON ORDENACION.IDOFERTA = OFR.OFR_ID 
    	INNER JOIN ' || V_ESQUEMA || '.ACT_OFR AOF 					   		ON OFR.OFR_ID = AOF.OFR_ID
		INNER JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT 						ON ACT.ACT_ID = AOF.ACT_ID and act.borrado = 0
		INNER JOIN ' || V_ESQUEMA || '.DD_TOF_TIPOS_OFERTA TOF 				ON TOF.DD_TOF_ID = OFR.DD_TOF_ID
		INNER JOIN ' || V_ESQUEMA || '.DD_EOF_ESTADOS_OFERTA EOF 			ON EOF.DD_EOF_ID = OFR.DD_EOF_ID
		LEFT JOIN ' || V_ESQUEMA || '.ACT_PVE_PROVEEDOR PVEPRES 			ON PVEPRES.PVE_ID = OFR.PVE_ID_PRESCRIPTOR
		LEFT JOIN ' || V_ESQUEMA || '.DD_TPR_TIPO_PROVEEDOR TPR 			ON TPR.DD_TPR_ID = PVEPRES.DD_TPR_ID
		LEFT JOIN ' || V_ESQUEMA || '.ECO_EXPEDIENTE_COMERCIAL ECO 			ON ECO.OFR_ID = OFR.OFR_ID
		LEFT JOIN ' || V_ESQUEMA || '.DD_EEC_EST_EXP_COMERCIAL EEC 			ON EEC.DD_EEC_ID = ECO.DD_EEC_ID
		INNER JOIN ' || V_ESQUEMA || '.CLC_CLIENTE_COMERCIAL CLC 			ON CLC.CLC_ID = OFR.CLC_ID
		LEFT JOIN ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR 			  	ON AGR.AGR_ID = OFR.AGR_ID and agr.borrado = 0
		LEFT JOIN ' || V_ESQUEMA || '.VI_ACTIVOS_AFECTOS_GENCAT GEN 		ON GEN.ACT_ID = ACT.ACT_ID
		LEFT JOIN ' || V_ESQUEMA || '.OFR_OFERTAS_CAIXA CBX					ON OFR.OFR_ID = CBX.OFR_ID
		LEFT JOIN ' || V_ESQUEMA || '.DD_ECC_ESTADO_COMUNICACION_C4C C4C	ON CBX.DD_ECC_ID = C4C.DD_ECC_ID
		LEFT JOIN ' || V_ESQUEMA || '.DEP_DEPOSITO DEP 						ON DEP.OFR_ID = OFR.OFR_ID and DEP.borrado = 0
		LEFT JOIN ' || V_ESQUEMA || '.DD_EDP_EST_DEPOSITO EDP 				ON EDP.DD_EDP_ID = DEP.DD_EDP_ID
		LEFT JOIN ' || V_ESQUEMA || '.CON_CONCURRENCIA CON 				ON CON.ACT_ID = ACT.ACT_ID and CON.borrado = 0
		WHERE OFR.BORRADO  = 0 AND EOF.DD_EOF_CODIGO IN (''01'',''03'',''04'',''05'',''07'',''05'',''08'', ''09'') AND TOF.DD_TOF_CODIGO IN (''01'')
		ORDER BY ORDENACION.ORDENFINAL ASC';
		

  EXECUTE IMMEDIATE	V_MSQL;
    
  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.VI_GRID_OFR_ACT_AGR_CONCU...Creada OK');
  EXECUTE IMMEDIATE 'COMMENT ON TABLE ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU IS ''VISTA PARA RECOGER LAS OFERTAS DE CONCURRENCIA DE ACTIVOS Y AGRUPACIONES''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.OFR_NUM_OFERTA IS ''Número de la oferta''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.OFR_FECHA_ALTA IS ''Fecha de creación de la oferta''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.DD_TOF_DESCRIPCION IS ''Descripción del tipo de la oferta''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.DD_TOF_CODIGO IS ''Código del tipo de la oferta''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.NUM_ACTIVO_AGRUPACION IS ''Número de agrupación o activo''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.OFERTANTE IS ''Nombre y apellidos del Cliente comercial que realiza la oferta''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.OFR_IMPORTE IS ''Importe ofertado''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.DD_EOF_DESCRIPCION IS ''Estado de la oferta''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.DD_EOF_CODIGO IS ''Código del estado de la oferta''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.ECO_NUM_EXPEDIENTE IS ''Número del expediente comercial relacionado con la oferta''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.ECO_ID IS ''Código identificador único del expediente comercial relacionado con la oferta''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.DD_EEC_DESCRIPCION IS ''Estado del expediente comercial relacionado con la oferta''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.AGR_ID IS ''Código identificador único de la agrupación.''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.OFR_ID IS ''Código identificador único de la oferta.''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.GENCAT IS ''Activos que pertenecen a GENCAT.''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.FECHA_INGRESO_DEPOSITO IS ''Fecha ingreso del depósito''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.FECHA_INGRESO_DOCUMENTACION IS ''Fecha ingreso de la documentación''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.ORDEN_GANADOR IS ''Orden de ofertas ganadoras.''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.DD_EDP_DESCRIPCION IS ''Descripción estado depósito''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.DD_EDP_CODIGO IS ''Código estado depósito''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.CON_ID IS ''Código identificador único de la concurrencia relacionado con el activo de la oferta''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.FECHA_INICIO_CONCURRENCIA IS ''Fecha inicio concurrencia''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.FECHA_FIN_CONCURRENCIA IS ''Fecha fin concurrencia''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_GRID_OFR_ACT_AGR_CONCU.PERIODO_CONCURRENCIA IS ''Periodo concurrencia''';

  
  DBMS_OUTPUT.PUT_LINE('Creados los comentarios en CREATE VIEW '|| V_ESQUEMA ||'.VI_GRID_OFR_ACT_AGR_CONCU...Creada OK');
  EXCEPTION
  WHEN OTHERS THEN
    ERR_NUM := SQLCODE;
    ERR_MSG := SQLERRM;
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(ERR_MSG);
    ROLLBACK;
    RAISE; 
END;
/

EXIT;
