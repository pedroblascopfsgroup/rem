--/*
--##########################################
--## AUTOR=Daniel Algaba
--## FECHA_CREACION=20200703
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-10460
--## PRODUCTO=NO
--##
--## Finalidad: 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versi√≥n inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

CREATE OR REPLACE PROCEDURE #ESQUEMA#.SP_CND_CONV_SAREB (
    PL_OUTPUT       OUT VARCHAR2) AS

    V_ESQUEMA VARCHAR2(15 CHAR) := '#ESQUEMA#';
    V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := '#ESQUEMA_MASTER#';
    V_MSQL VARCHAR2(16000 CHAR);
    CURSOR CONDICIONADOS IS
      SELECT 
            'INSERT INTO '|| V_ESQUEMA ||'.CONV_SAREB_ACTIVO (ACT_ID, TABLA_DESTINO, CAMPO_DESTINO, VALOR_DESTINO)' || CHR(10)
            || 'SELECT AUX.ACT_ID, ''' || #ESQUEMA#.CCS.DD_CCS_TABLA || ''' TABLA_DESTINO, ''' || CCS.DD_CCS_CAMPO || ''' CAMPO_DESTINO, AUX.CAMPO VALOR_DESTINO' || CHR(10)
            || 'FROM' || '(SELECT ACT.ACT_ID, ' || CCS_ORIGEN.DD_CCS_CAMPO || ' CAMPO' || CHR(10)
            || 'FROM '|| #ESQUEMA#.CCS_ORIGEN.DD_CCS_TABLA || ' TMP' || CHR(10)
            || 'JOIN '|| V_ESQUEMA ||'.ACT_ACTIVO ACT ON ACT.ACT_NUM_ACTIVO = TO_NUMBER(TMP.ACT_NUM_ACTIVO) AND ACT.BORRADO = 0' || CHR(10)
            || 'WHERE '
            || RTRIM(LISTAGG(CF4.AC4_CONDICION, ' AND ' || CHR(10))
            WITHIN GROUP (ORDER BY CF4.AC4_CONDICION) || ') AUX') as CONDICIONADOS
            FROM #ESQUEMA#.ACT_CONF4_CONDICIONES CF4
            JOIN #ESQUEMA#.ACT_CONF2_ACCION CF2 ON CF4.AC2_ID = CF2.AC2_ID AND CF2.BORRADO = 0
            LEFT JOIN #ESQUEMA#.DD_CCS_CAMPOS_CONV_SAREB CCS ON CF2.DD_CCS_ID = CCS.DD_CCS_ID AND CCS.BORRADO = 0
            JOIN #ESQUEMA#.ACT_CONF3_MAPEO CF3 ON CCS.DD_CCS_ID = CF3.DD_CCS_ID_DESTINO AND CF3.BORRADO = 0
            LEFT JOIN #ESQUEMA#.DD_CCS_CAMPOS_CONV_SAREB CCS_ORIGEN ON CF3.DD_CCS_ID_ORIGEN = CCS_ORIGEN.DD_CCS_ID AND CCS_ORIGEN.BORRADO = 0
            LEFT JOIN #ESQUEMA#.DD_ACS_ACCION_CONV_SAREB ACS ON CF2.DD_ACS_ID = ACS.DD_ACS_ID AND ACS.BORRADO = 0
            WHERE CF4.BORRADO = 0 AND CCS.DD_CCS_DESTINO = 1 AND CCS_ORIGEN.DD_CCS_ORIGEN = 1 AND ACS.DD_ACS_CODIGO = 'ACT_CND'
            GROUP BY
             CF4.AC2_ID
            , CCS.DD_CCS_TABLA
            , CCS.DD_CCS_CAMPO
            , CCS_ORIGEN.DD_CCS_CAMPO
            , CCS_ORIGEN.DD_CCS_TABLA;
BEGIN
    PL_OUTPUT := PL_OUTPUT || '[INICIO]' || CHR(10);
    
	OPEN CONDICIONADOS;
	LOOP
		FETCH CONDICIONADOS INTO V_MSQL;
		EXIT WHEN CONDICIONADOS%NOTFOUND;

		EXECUTE IMMEDIATE V_MSQL;
		PL_OUTPUT := PL_OUTPUT || 'Cambios condicionados ' ||SQL%ROWCOUNT|| ' sobre campo ' || ' de la tabla ' || CHR(10);
	END LOOP;
	CLOSE CONDICIONADOS;
	COMMIT;
    
	PL_OUTPUT := PL_OUTPUT || '[FIN]' || CHR(10);
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        PL_OUTPUT := PL_OUTPUT || 'OK. Sin cambios que realizar' || CHR(10);
    WHEN OTHERS THEN
        PL_OUTPUT := PL_OUTPUT || 'KO. No se ha podido completar la operativa: ' || TO_CHAR(SQLCODE) || CHR(10);
        PL_OUTPUT := PL_OUTPUT || '-----------------------------------------------------------' || CHR(10);
        PL_OUTPUT := PL_OUTPUT || SQLERRM || CHR(10);
        PL_OUTPUT := PL_OUTPUT || V_MSQL || CHR(10);
        ROLLBACK;
        RAISE;
END SP_CND_CONV_SAREB;
/
EXIT;
