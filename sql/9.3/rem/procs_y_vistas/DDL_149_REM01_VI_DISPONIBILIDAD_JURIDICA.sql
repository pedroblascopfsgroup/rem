--/*
--##########################################
--## AUTOR=Remus Ovidiu Viorel
--## FECHA_CREACION=20210702
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9951
--## PRODUCTO=NO
--## Finalidad: DDL
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 

DECLARE
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_MASTER VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas
    err_num NUMBER; -- Vble. número de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_MSQL VARCHAR2(4000 CHAR);

    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'V_DISPONIBILIDAD_JURIDICA' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_DISPONIBILIDAD_JURIDICA...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.V_DISPONIBILIDAD_JURIDICA';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.V_DISPONIBILIDAD_JURIDICA... borrada OK');
  END IF;

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_DISPONIBILIDAD_JURIDICA...');
  EXECUTE IMMEDIATE '  CREATE OR REPLACE FORCE VIEW '|| V_ESQUEMA ||'."V_DISPONIBILIDAD_JURIDICA" ("ACT_ID", "ACT_NUM_ACTIVO", "NUM_INTERNO_BBVA", "DEP_JURIDICAMENTE", "FECHA_DEP_JURIDICA") AS 
  		SELECT DISTINCT
		ACT.ACT_ID,
		ACT.ACT_NUM_ACTIVO,
		SUBSTR(BBVA.BBVA_NUM_ACTIVO, 1, 6) AS NUM_INTERNO_BBVA,
		CASE
		    WHEN TIT.TIT_FECHA_INSC_REG IS NOT NULL AND ETI.DD_ETI_CODIGO = ''02'' AND (ECA.DD_ECA_CODIGO = ''05'' OR ECA.DD_ECA_CODIGO IS NULL) AND VTA_POS.FECHA_POSESION IS NOT NULL
		    THEN ''S''
		    ELSE ''N''
		END AS DEP_JURIDICAMENTE
		,CASE
		    WHEN VTA_POS.FECHA_POSESION IS NOT NULL
			AND COALESCE(TIT.TIT_FECHA_INSC_REG,BIEADJ.BIE_ADJ_F_INSCRIP_TITULO) IS NOT NULL
			AND (((ECA.DD_ECA_CODIGO IN (''04'',''05'')) AND ACT.ACT_FECHA_REV_CARGAS IS NOT NULL) OR ECA.DD_ECA_CODIGO IS NULL)
		    THEN (
		 CASE
			WHEN VTA_POS.FECHA_POSESION IS NOT NULL
				AND VTA_POS.FECHA_POSESION>=COALESCE(TIT.TIT_FECHA_INSC_REG,BIEADJ.BIE_ADJ_F_INSCRIP_TITULO,TO_DATE(''19000101'',''yyyymmdd''))
				  AND VTA_POS.FECHA_POSESION>=CASE WHEN CANCEL.FC_CANCELACION_ULTIMA_CARGA IS NOT NULL AND CANCEL.FC_CANCELACION_ULTIMA_CARGA <> TO_DATE(''19000101'',''yyyymmdd'') 
				  THEN CANCEL.FC_CANCELACION_ULTIMA_CARGA ELSE 		NVL(ACT.ACT_FECHA_REV_CARGAS,TO_DATE(''19000101'',''yyyymmdd'')) END
			    THEN TO_CHAR(VTA_POS.FECHA_POSESION,''DD.MM.YYYY'')
			    WHEN COALESCE(TIT.TIT_FECHA_INSC_REG,BIEADJ.BIE_ADJ_F_INSCRIP_TITULO) IS NOT NULL
				AND COALESCE(TIT.TIT_FECHA_INSC_REG,BIEADJ.BIE_ADJ_F_INSCRIP_TITULO)>=COALESCE(VTA_POS.FECHA_POSESION,TO_DATE(''19000101'',''yyyymmdd''))
				AND COALESCE(TIT.TIT_FECHA_INSC_REG,BIEADJ.BIE_ADJ_F_INSCRIP_TITULO)>=CASE WHEN CANCEL.FC_CANCELACION_ULTIMA_CARGA IS NOT NULL AND CANCEL.FC_CANCELACION_ULTIMA_CARGA <> TO_DATE(''19000101'',''yyyymmdd'') 
				THEN CANCEL.FC_CANCELACION_ULTIMA_CARGA ELSE NVL(ACT.ACT_FECHA_REV_CARGAS,TO_DATE(''19000101'',''yyyymmdd'')) END
			    THEN TO_CHAR(COALESCE(TIT.TIT_FECHA_INSC_REG,BIEADJ.BIE_ADJ_F_INSCRIP_TITULO),''DD.MM.YYYY'')
			    WHEN (CANCEL.FC_CANCELACION_ULTIMA_CARGA IS NOT NULL AND CANCEL.FC_CANCELACION_ULTIMA_CARGA <> TO_DATE(''19000101'',''yyyymmdd''))
				AND CANCEL.FC_CANCELACION_ULTIMA_CARGA>=COALESCE(VTA_POS.FECHA_POSESION,TO_DATE(''19000101'',''yyyymmdd''))
				AND CANCEL.FC_CANCELACION_ULTIMA_CARGA>=COALESCE(TIT.TIT_FECHA_INSC_REG,BIEADJ.BIE_ADJ_F_INSCRIP_TITULO,TO_DATE(''19000101'',''yyyymmdd''))
			    THEN TO_CHAR(CANCEL.FC_CANCELACION_ULTIMA_CARGA ,''DD.MM.YYYY'')
			    WHEN (CANCEL.FC_CANCELACION_ULTIMA_CARGA IS NULL OR CANCEL.FC_CANCELACION_ULTIMA_CARGA = TO_DATE(''19000101'',''yyyymmdd''))
				AND NVL(ACT.ACT_FECHA_REV_CARGAS,TO_DATE(''19000101'',''yyyymmdd''))>=COALESCE(VTA_POS.FECHA_POSESION,TO_DATE(''19000101'',''yyyymmdd''))
				AND NVL(ACT.ACT_FECHA_REV_CARGAS,TO_DATE(''19000101'',''yyyymmdd''))>=COALESCE(TIT.TIT_FECHA_INSC_REG,BIEADJ.BIE_ADJ_F_INSCRIP_TITULO,TO_DATE(''19000101'',''yyyymmdd''))
			    THEN TO_CHAR(ACT.ACT_FECHA_REV_CARGAS,''DD.MM.YYYY'')
			END
		    )
		    ELSE NULL 
		END AS FECHA_DEP_JURIDICA
		FROM '|| V_ESQUEMA ||'.ACT_ACTIVO ACT
		JOIN '|| V_ESQUEMA ||'.ACT_BBVA_ACTIVOS BBVA ON BBVA.ACT_ID = ACT.ACT_ID AND BBVA.BORRADO = 0
		LEFT JOIN '|| V_ESQUEMA ||'.ACT_AJD_ADJJUDICIAL AJD ON AJD.ACT_ID = ACT.ACT_ID AND AJD.BORRADO = 0
		JOIN '|| V_ESQUEMA ||'.ACT_TIT_TITULO TIT ON ACT.ACT_ID = TIT.ACT_ID AND TIT.BORRADO = 0
		LEFT JOIN '|| V_ESQUEMA ||'.DD_ETI_ESTADO_TITULO ETI ON TIT.DD_ETI_ID = ETI.DD_ETI_ID AND ETI.BORRADO = 0
		LEFT JOIN '|| V_ESQUEMA ||'.DD_ECA_ESTADO_CARGA_ACTIVOS ECA ON ACT.DD_ECA_ID = ECA.DD_ECA_ID AND ECA.BORRADO = 0
		JOIN '|| V_ESQUEMA ||'.V_FECHA_POSESION_ACTIVO VTA_POS ON VTA_POS.ACT_ID = ACT.ACT_ID
		LEFT JOIN  '|| V_ESQUEMA ||'.BIE_ADJ_ADJUDICACION  BIEADJ ON BIEADJ.BIE_ADJ_ID=AJD.BIE_ADJ_ID AND BIEADJ.BORRADO=0
		LEFT JOIN (
			SELECT 
			ID_AAII
			,MAX(FC_CANCELACION_CARGA) AS FC_CANCELACION_ULTIMA_CARGA
			FROM (
			    SELECT 
			     ACT.ACT_NUM_ACTIVO																	AS ID_AAII
			    ,ACT_CRG.CRG_ID																		AS ID_CARGA
			    ,COALESCE(ACT_CRG.CRG_FECHA_CANCEL_REGISTRAL,BIE_CAR.BIE_CAR_FECHA_CANCELACION)		AS FC_CANCELACION_CARGA
			    FROM '|| V_ESQUEMA ||'.ACT_ACTIVO ACT
			    INNER JOIN '|| V_ESQUEMA ||'.ACT_CRG_CARGAS ACT_CRG
				ON ACT_CRG.ACT_ID = ACT.ACT_ID
				AND ACT_CRG.BORRADO = 0
			    INNER JOIN '|| V_ESQUEMA ||'.BIE_CAR_CARGAS BIE_CAR
				ON ACT_CRG.BIE_CAR_ID = BIE_CAR.BIE_CAR_ID
				AND BIE_CAR.BORRADO = 0
			    WHERE ACT.BORRADO = 0
				AND ACT.DD_CRA_ID = 162) EXTRACCION_FC_CANCELACION_CARGA
			GROUP BY ID_AAII
		    ) CANCEL 
		    ON ACT.ACT_NUM_ACTIVO = CANCEL.ID_AAII
		WHERE ACT.BORRADO = 0';

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.V_DISPONIBILIDAD_JURIDICA...Creada OK');

  COMMIT;

EXCEPTION
  WHEN OTHERS THEN
    ERR_NUM := SQLCODE;
    ERR_MSG := SQLERRM;
    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(ERR_MSG);
    ROLLBACK;
    RAISE; 
  
END;
/

EXIT;
