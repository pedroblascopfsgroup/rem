--/*
--##########################################
--## AUTOR=Juan Beltrán
--## FECHA_CREACION=20191014
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-8018
--## PRODUCTO=NO
--## Finalidad: DDL creación vista VI_BUSQUEDA_JUNTAS.
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial 		- Juan Beltrán - 20190718 - HREOS-6636
--##        0.2 Modificar codProveedor 	- Juan Beltrán - 20191014 - HREOS-8018
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE
    
    err_num NUMBER; -- Número de errores.
    err_msg VARCHAR2(2048); -- Mensaje de error.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_MSQL VARCHAR2(4000 CHAR); 

    CUENTA NUMBER;
    
BEGIN

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'VI_BUSQUEDA_JUNTAS' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='MATERIALIZED VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.VI_BUSQUEDA_JUNTAS...');
    EXECUTE IMMEDIATE 'DROP MATERIALIZED VIEW ' || V_ESQUEMA || '.VI_BUSQUEDA_JUNTAS';  
    DBMS_OUTPUT.PUT_LINE('DROP MATERIALIZED VIEW '|| V_ESQUEMA ||'.VI_BUSQUEDA_JUNTAS... borrada OK');
  END IF;

  SELECT COUNT(*) INTO CUENTA FROM ALL_OBJECTS WHERE OBJECT_NAME = 'VI_BUSQUEDA_JUNTAS' AND OWNER=V_ESQUEMA AND OBJECT_TYPE='VIEW';  
  IF CUENTA>0 THEN
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.VI_BUSQUEDA_JUNTAS...');
    EXECUTE IMMEDIATE 'DROP VIEW ' || V_ESQUEMA || '.VI_BUSQUEDA_JUNTAS';  
    DBMS_OUTPUT.PUT_LINE('DROP VIEW '|| V_ESQUEMA ||'.VI_BUSQUEDA_JUNTAS... borrada OK');
  END IF;

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.VI_BUSQUEDA_JUNTAS...');
  EXECUTE IMMEDIATE 'CREATE VIEW ' || V_ESQUEMA || '.VI_BUSQUEDA_JUNTAS
	AS
		SELECT			
			JCM.JCM_ID,
			JCM.ACT_ID,
			ACT.ACT_NUM_ACTIVO,
			PVE.PVE_COD_REM,
			PVE.PVE_NOMBRE,
			JCM.JCM_FECHA_JUNTA,
			JCM.JCM_COMUNIDAD,
			CRA.DD_CRA_DESCRIPCION,
			LOC.BIE_LOC_DIRECCION,
			JCM.JCM_PORCENTAJE_PARTICIPACION,
			JCM.JCM_PROMOCION_MAYOR_50,
			JCM.JCM_PROMOCION_ENTRE_20_50,
			JCP.DD_JCP_DESCRIPCION,
			JCM.JCM_ACT_JUDIC_CON_PROMOCION,
			JCM.JCM_DERRAMA_MAYOR_5000,
			JCM.JCM_MODIFICACIONES_ESTATUTOS,
			JCM.JCM_ITE,
			JCM.JCM_ACTUACIONES_CONTRA_MOROSOS,
			JCM.JCM_MODIFICA_CUOTA,
			JCM.JCM_OTROS,
			JCM.JCM_IMPORTE,
			JCM.JCM_CUOTA_ORDINARIA,
			JCM.JCM_CUOTA_EXTRA,
			JCM.JCM_SUMINISTROS,
			JCM.JCM_PROPUESTA,
			JCM.JCM_GUION_DE_VOTO,
			JCM.JCM_INDICACIONES
            
		FROM ' || V_ESQUEMA || '.ACT_JCM_JUNTA_COM_PROPIETARIOS JCM
		JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = JCM.ACT_ID
		JOIN ' || V_ESQUEMA || '.DD_JCP_JUNTA_COMUNIDADES JCP ON JCP.DD_JCP_ID = JCM.DD_JCP_ID
		JOIN ' || V_ESQUEMA || '.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID
		JOIN ' || V_ESQUEMA || '.ACT_PVE_PROVEEDOR PVE ON PVE.PVE_ID = JCM.JCM_COMUNIDAD
		JOIN ' || V_ESQUEMA || '.DD_JCP_JUNTA_COMUNIDADES JCP ON JCP.DD_JCP_ID = JCM.DD_JCP_ID
		JOIN ' || V_ESQUEMA || '.BIE_LOCALIZACION LOC ON LOC.BIE_ID = ACT.BIE_ID		
		WHERE JCM.BORRADO = 0 ';
	

  DBMS_OUTPUT.PUT_LINE('CREATE VIEW '|| V_ESQUEMA ||'.VI_BUSQUEDA_JUNTAS...Creada OK');
  
  EXECUTE IMMEDIATE 'COMMENT ON TABLE ' || V_ESQUEMA || '.VI_BUSQUEDA_JUNTAS IS ''VISTA PARA RECOGER LA INFORMACION DE JUNTAS''';
  EXECUTE IMMEDIATE 'COMMENT ON COLUMN ' || V_ESQUEMA || '.VI_BUSQUEDA_JUNTAS.JCM_ID IS ''Numero Junta comunidad de propietarios'''; 
  
  DBMS_OUTPUT.PUT_LINE('Creados los comentarios en CREATE VIEW '|| V_ESQUEMA ||'.VI_BUSQUEDA_JUNTAS...Creada OK');
  COMMIT;
EXCEPTION
     WHEN OTHERS THEN 
         DBMS_OUTPUT.PUT_LINE('KO!');
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;  
END;
/

EXIT;
