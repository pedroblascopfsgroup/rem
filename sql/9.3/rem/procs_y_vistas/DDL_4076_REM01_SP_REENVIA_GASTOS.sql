--/*
--##########################################
--## AUTOR=DAP
--## FECHA_CREACION=20220526
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-XXXXX
--## PRODUCTO=NO
--##
--## Finalidad: 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial - [REMVIP-1535] - DAP
--##        0.2 Añadir borrado lógico a la HIST_ENVIO_PEDIDOS - [HREOS-15232] - Alejandra García
--##			0.3 Añadir opciones para reenvío gastos según interfaz (BC, BC/CXB, CXB, RESTO), será de uso obligatorio, poner RESTO para interfaces distintas a CXB y BC
--##			0.4 Añadir opciones para envío informativo o a propietario, y simplificar las opciones de cartera
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

CREATE OR REPLACE PROCEDURE #ESQUEMA#.SP_REENVIA_GASTOS
        (     
		  V_LISTA_GASTOS IN VARCHAR2
		, INTERFAZ IN VARCHAR2 /*OPCIONES: BC, CXB, RESTO*/
		, V_USUARIO_MODIFICAR IN VARCHAR2
        , PL_OUTPUT OUT VARCHAR2
    )

   AS

   V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar
   V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
   V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
   ERR_NUM NUMBER(25); -- Vble. auxiliar para registrar errores en el script.
   ERR_MSG VARCHAR2(10024 CHAR); -- Vble. auxiliar para registrar errores en el script.
   V_NUM_TABLAS NUMBER(16); -- Variable auxiliar
   USUARIO_CONSULTA_REM VARCHAR2(50 CHAR):= 'REM_QUERY';
   V_CLIENTE NUMBER(16);

BEGIN	
	
	PL_OUTPUT := '[INICIO]' || CHR(10);

	IF INTERFAZ IS NULL OR (INTERFAZ IS NOT NULL AND INTERFAZ NOT IN ('CXB', 'BC', 'RESTO')) THEN

		PL_OUTPUT := PL_OUTPUT || '	[INFO]: NO SE HA INFORMADO A QUÉ INTERFAZ AFECTA EL REENVÍO.' || CHR(10);

	ELSIF INTERFAZ IS NOT NULL AND (INTERFAZ IN ('CXB', 'BC', 'RESTO'))  THEN

		V_SQL := 'TRUNCATE TABLE '||V_ESQUEMA||'.TMP_REENVIO_GASTOS';
		EXECUTE IMMEDIATE V_SQL;
		PL_OUTPUT := PL_OUTPUT || '	[INFO]: TABLA TMP TRUNCADA.'|| CHR(10);

		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.TMP_REENVIO_GASTOS (GPV_ID)
			SELECT GPV.GPV_ID
			FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV
			WHERE GPV.BORRADO = 0
				AND GPV.GPV_NUM_GASTO_HAYA IN ('||V_LISTA_GASTOS||')
			';
		EXECUTE IMMEDIATE V_SQL;
		PL_OUTPUT := PL_OUTPUT || '	[INFO]: ' || SQL%ROWCOUNT || ' GASTOS INSERTADOS EN TABLA TMP.'|| CHR(10);

		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.H_REENVIO_GASTOS (GPV_ID, USUARIO, FECHA, DD_EGA_ID, DD_EAH_ID, DD_EAP_ID, GGE_FECHA_EAH, GGE_FECHA_EAP, GGE_FECHA_ENVIO_PRPTRIO, GGE_FECHA_ENVIO_INFORMATIVA)
			SELECT GPV.GPV_ID, '''||V_USUARIO_MODIFICAR||''' USUARIO, SYSDATE FECHA, GPV.DD_EGA_ID, GGE.DD_EAH_ID, GGE.DD_EAP_ID, GGE.GGE_FECHA_EAH, GGE.GGE_FECHA_EAP, GGE.GGE_FECHA_ENVIO_PRPTRIO, GGE.GGE_FECHA_ENVIO_INFORMATIVA
			FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV
			JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
				AND GGE.BORRADO = 0
			JOIN '||V_ESQUEMA||'.TMP_REENVIO_GASTOS TMP ON TMP.GPV_ID = GPV.GPV_ID
			WHERE GPV.BORRADO = 0
			';
		EXECUTE IMMEDIATE V_SQL;
		PL_OUTPUT := PL_OUTPUT || '	[INFO]: ' || SQL%ROWCOUNT || ' GASTOS SE INTENTARÁN REENVIAR. (REVISAR LOG).'|| CHR(10);

		IF INTERFAZ = 'CXB' THEN

			V_SQL := 'SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_SOCIEDAD_PAGADORA = ''0001''';
			EXECUTE IMMEDIATE V_SQL INTO V_CLIENTE;

			V_SQL := 'MERGE INTO '||V_ESQUEMA||'.HIST_ENVIO_PEDIDOS T1 USING
						(SELECT 
							HIST.GPV_ID,
							HIST.HIST_ID
						FROM '||V_ESQUEMA||'.HIST_ENVIO_PEDIDOS HIST
						JOIN '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV ON GPV.GPV_ID=HIST.GPV_ID
							AND GPV.BORRADO = 0
						JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
							AND GGE.BORRADO = 0
						JOIN '||V_ESQUEMA||'.TMP_REENVIO_GASTOS TMP ON TMP.GPV_ID = GPV.GPV_ID
						WHERE HIST.BORRADO=0
							AND (NVL(GGE.GGE_CLIENTE_PAGADOR, 0) = '||V_CLIENTE||' OR NVL(GGE.GGE_CLIENTE_INFORMADOR, 0) = '||V_CLIENTE||')
						)T2 
				 ON (T1.HIST_ID = T2.HIST_ID) 
				 WHEN MATCHED THEN UPDATE SET 
				 		T1.BORRADO = 1,
						T1.USUARIOMODIFICAR = '''||V_USUARIO_MODIFICAR||''',
						T1.FECHAMODIFICAR = SYSDATE
				';
			EXECUTE IMMEDIATE V_SQL;

		END IF;

		IF INTERFAZ IN ('BC', 'CXB') THEN	

			IF INTERFAZ = 'BC' THEN
				V_SQL := 'SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_SOCIEDAD_PAGADORA = ''0015''';
				EXECUTE IMMEDIATE V_SQL INTO V_CLIENTE;
			END IF;

			V_SQL := 'MERGE INTO '||V_ESQUEMA||'.GGE_GASTOS_GESTION T1 USING
							(SELECT TMP.GPV_ID
								, CASE WHEN NVL(GGE.GGE_CLIENTE_PAGADOR, 0) = '||V_CLIENTE||' THEN NULL ELSE GGE.GGE_FECHA_ENVIO_PRPTRIO END FECHA_ENVIO_PRPTRIO
								, CASE WHEN NVL(GGE.GGE_CLIENTE_INFORMADOR, 0) = '||V_CLIENTE||' THEN NULL ELSE GGE.GGE_FECHA_ENVIO_INFORMATIVA END FECHA_ENVIO_INFORMATIVA
							FROM '||V_ESQUEMA||'.TMP_REENVIO_GASTOS TMP
							JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = TMP.GPV_ID
								AND GGE.BORRADO = 0 
							WHERE NVL(GGE.GGE_CLIENTE_PAGADOR, 0) = '||V_CLIENTE||' OR NVL(GGE.GGE_CLIENTE_INFORMADOR, 0) = '||V_CLIENTE||'
						) T2 ON (T1.GPV_ID = T2.GPV_ID) 
						WHEN MATCHED THEN
							UPDATE
							SET T1.DD_EAH_ID = 3,
								T1.GGE_FECHA_EAH = SYSDATE,
								T1.DD_EAP_ID = 1,
								T1.GGE_FECHA_EAP = NULL,
								T1.GGE_MOTIVO_RECHAZO_PROP = NULL,
								T1.GGE_FECHA_ENVIO_PRPTRIO = T2.FECHA_ENVIO_PRPTRIO,
								T1.GGE_FECHA_ENVIO_INFORMATIVA = T2.FECHA_ENVIO_INFORMATIVA,
								T1.USUARIOMODIFICAR = '''||V_USUARIO_MODIFICAR||''',
								T1.FECHAMODIFICAR = SYSDATE
						WHERE NVL(T1.GGE_CLIENTE_PAGADOR, 0) = '||V_CLIENTE||' OR NVL(T1.GGE_CLIENTE_INFORMADOR, 0) = '||V_CLIENTE;
			EXECUTE IMMEDIATE V_SQL;
			
			V_SQL := 'MERGE INTO '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR T1 USING
							(SELECT TMP.GPV_ID
							FROM '||V_ESQUEMA||'.TMP_REENVIO_GASTOS TMP
							JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = TMP.GPV_ID
								AND GGE.BORRADO = 0 
							WHERE NVL(GGE.GGE_CLIENTE_PAGADOR, 0) = '||V_CLIENTE||' OR NVL(GGE.GGE_CLIENTE_INFORMADOR, 0) = '||V_CLIENTE||'
						)T2 ON (T1.GPV_ID = T2.GPV_ID) 
						WHEN MATCHED THEN
							UPDATE
							SET T1.DD_EGA_ID = 3,
								T1.PRG_ID = NULL,
								T1.USUARIOMODIFICAR = '''||V_USUARIO_MODIFICAR||''',
								T1.FECHAMODIFICAR = SYSDATE';
			EXECUTE IMMEDIATE V_SQL;
			PL_OUTPUT := PL_OUTPUT || '	[INFO]: ' || SQL%ROWCOUNT || ' GASTOS MARCADOS PARA REENVIO A '||INTERFAZ||'.' || CHR(10);
			
		END IF;

     	IF INTERFAZ = 'RESTO' THEN

	     	V_SQL := 'MERGE INTO '||V_ESQUEMA||'.GGE_GASTOS_GESTION T1 USING
							'||V_ESQUEMA||'.TMP_REENVIO_GASTOS
						T2 ON (T1.GPV_ID = T2.GPV_ID) 
						WHEN MATCHED THEN
							UPDATE
							SET T1.DD_EAH_ID = 3,
								T1.GGE_FECHA_EAH = SYSDATE,
								T1.DD_EAP_ID = 1,
								T1.GGE_FECHA_EAP = NULL,
								T1.GGE_MOTIVO_RECHAZO_PROP = NULL,
								T1.GGE_FECHA_ENVIO_PRPTRIO = NULL,
								T1.USUARIOMODIFICAR = '''||V_USUARIO_MODIFICAR||''',
								T1.FECHAMODIFICAR = SYSDATE';
			EXECUTE IMMEDIATE V_SQL;
			
			V_SQL := 'MERGE INTO '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR T1 USING
							'||V_ESQUEMA||'.TMP_REENVIO_GASTOS
						T2 ON (T1.GPV_ID = T2.GPV_ID) 
						WHEN MATCHED THEN
							UPDATE
							SET T1.DD_EGA_ID = 3,
								T1.PRG_ID = NULL,
								T1.USUARIOMODIFICAR = '''||V_USUARIO_MODIFICAR||''',
								T1.FECHAMODIFICAR = SYSDATE';
			EXECUTE IMMEDIATE V_SQL;
			PL_OUTPUT := PL_OUTPUT || '	[INFO]: ' || SQL%ROWCOUNT || ' GASTOS REENVIADOS A '||INTERFAZ||'.' || CHR(10);

		END IF;

	END IF;
			
	COMMIT;
 
	PL_OUTPUT := PL_OUTPUT || '[FIN]' || CHR(10);

EXCEPTION
   WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    [ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM);
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    '||ERR_MSG;
      ROLLBACK;
      RAISE;
END SP_REENVIA_GASTOS;
/
EXIT
