--/*
--##########################################
--## AUTOR=Alejandra García
--## FECHA_CREACION=20210917
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-15232
--## PRODUCTO=NO
--##
--## Finalidad: 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial - [REMVIP-1535] - DAP
--##        0.2 Añadir borrado lógico a la HIST_ENVIO_PEDIDOS - [HREOS-15232] - Alejandra García
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

CREATE OR REPLACE PROCEDURE #ESQUEMA#.SP_REENVIA_GASTOS
        (     
		  V_LISTA_GASTOS IN VARCHAR2
		, V_USUARIO_MODIFICAR IN VARCHAR2
        , PL_OUTPUT OUT VARCHAR2
    )

   AS

   V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar
   V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
   V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
   ERR_NUM NUMBER(25); -- Vble. auxiliar para registrar errores en el script.
   ERR_MSG VARCHAR2(10024 CHAR); -- Vble. auxiliar para registrar errores en el script.
   V_NUM_TABLAS NUMBER(16); -- Variable auxiliar
   USUARIO_CONSULTA_REM VARCHAR2(50 CHAR):= 'REM_QUERY';

BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');		

			V_SQL := 'INSERT INTO '||V_ESQUEMA||'.H_REENVIO_GASTOS (GPV_ID, USUARIO, FECHA, DD_EGA_ID, DD_EAH_ID, DD_EAP_ID)
				SELECT GPV.GPV_ID, '''||V_USUARIO_MODIFICAR||''' USUARIO, SYSDATE FECHA, GPV.DD_EGA_ID, GGE.DD_EAH_ID, GGE.DD_EAP_ID
				FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV
				JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
					AND GGE.BORRADO = 0
				WHERE GPV.BORRADO = 0
					AND GPV.GPV_NUM_GASTO_HAYA IN ('||V_LISTA_GASTOS||') 
				';
			EXECUTE IMMEDIATE V_SQL;
				
        	V_SQL := 'MERGE INTO '||V_ESQUEMA||'.GGE_GASTOS_GESTION T1 USING
							(SELECT GPV_ID FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV WHERE GPV_NUM_GASTO_HAYA IN ('||V_LISTA_GASTOS||')
							)T2 ON (
							T1.GPV_ID = T2.GPV_ID
						) WHEN MATCHED THEN
							UPDATE
							SET T1.DD_EAH_ID = 3,
								T1.GGE_FECHA_EAH = SYSDATE,
								T1.DD_EAP_ID = 1,
								T1.GGE_FECHA_EAP = NULL,
								T1.GGE_MOTIVO_RECHAZO_PROP = NULL,
								T1.GGE_FECHA_ENVIO_PRPTRIO = NULL,
								T1.USUARIOMODIFICAR = '''||V_USUARIO_MODIFICAR||''',
								T1.FECHAMODIFICAR = SYSDATE';
			
			EXECUTE IMMEDIATE V_SQL;
			
			V_SQL := 'MERGE INTO '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR T1 USING
							(SELECT GPV_ID FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV WHERE GPV_NUM_GASTO_HAYA IN ('||V_LISTA_GASTOS||')
							)T2 ON (
							T1.GPV_ID = T2.GPV_ID
						) WHEN MATCHED THEN
							UPDATE
							SET T1.DD_EGA_ID = 3,
								T1.PRG_ID = NULL,
								T1.USUARIOMODIFICAR = '''||V_USUARIO_MODIFICAR||''',
								T1.FECHAMODIFICAR = SYSDATE';
								
			EXECUTE IMMEDIATE V_SQL;

			V_SQL := 'MERGE INTO '||V_ESQUEMA||'.HIST_ENVIO_PEDIDOS T1 USING
							(SELECT 
								HIST.GPV_ID,
								HIST.HIST_ID
							FROM '||V_ESQUEMA||'.HIST_ENVIO_PEDIDOS HIST
							JOIN '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV ON GPV.GPV_ID=HIST.GPV_ID
							WHERE GPV.GPV_NUM_GASTO_HAYA IN ('||V_LISTA_GASTOS||')
							AND HIST.BORRADO=0
							)T2 
					 ON ( T1.HIST_ID = T2.HIST_ID ) 
					 WHEN MATCHED THEN UPDATE SET 
					 		T1.BORRADO = 1,
							T1.USUARIOMODIFICAR = '''||V_USUARIO_MODIFICAR||''',
							T1.FECHAMODIFICAR = SYSDATE';
								
			EXECUTE IMMEDIATE V_SQL;
			
    COMMIT;
    
    PL_OUTPUT := PL_OUTPUT ||'[FIN]: GASTOS REENVIADOS CORRECTAMENTE '|| CHR(10);

EXCEPTION
   WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    [ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM);
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    '||ERR_MSG;
      ROLLBACK;
      RAISE;
END SP_REENVIA_GASTOS;
/
EXIT
