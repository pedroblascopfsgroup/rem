--/*
--##########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20220214
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=2.0.17
--## INCIDENCIA_LINK=HREOS-17157
--## PRODUCTO=NO
--##
--## Finalidad: 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

CREATE OR REPLACE PROCEDURE #ESQUEMA#.SP_CALCULO_CLIENTE_PAGADOR_CAIXA
   (  PL_OUTPUT OUT VARCHAR2
   )
   
   AS

   V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar        
   V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
   V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
   ACT_ID NUMBER(32);
   ERR_NUM NUMBER(25); -- Vble. auxiliar para registrar errores en el script.
   ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
   DESCRIPCION VARCHAR2(64 CHAR);

BEGIN



	V_SQL := 'MERGE INTO '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE USING(
		SELECT GGE.GGE_ID, CASE WHEN PRO.PRO_SOCIEDAD_PAGADORA = ''0015'' AND GIC.GIC_FECHA_DEVENGO_ESPECIAL <= TO_DATE(''15/11/2021'',''DD/MM/YYYY'') THEN  ''0001''
		WHEN PRO.PRO_SOCIEDAD_PAGADORA = ''0015'' AND GIC.GIC_FECHA_DEVENGO_ESPECIAL > TO_DATE(''15/11/2021'',''DD/MM/YYYY'') THEN  ''0015'' 
		WHEN PRO.PRO_SOCIEDAD_PAGADORA = ''0001'' THEN ''0001''
		WHEN PRO.PRO_SOCIEDAD_PAGADORA = ''3148'' THEN ''0015'' 
		WHEN PRO.PRO_DOCIDENTIF NOT IN (''A08663619'',''A58032244'',''B46644290'') THEN ''0001'' END AS CLIENTE_PAGADOR,
		CASE WHEN PRO.PRO_SOCIEDAD_PAGADORA = ''0001'' AND GIC.GIC_FECHA_DEVENGO_ESPECIAL > TO_DATE(''15/11/2021'',''DD/MM/YYYY'') THEN  ''0015''  END AS CLIENTE_INFORMADO
		FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR  GPV
		JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
		JOIN '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
		JOIN '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO EGA ON EGA.DD_EGA_ID = GPV.DD_EGA_ID
		JOIN '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = GPV.PRO_ID
		JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = PRO.DD_CRA_ID
		WHERE GGE.GGE_CLIENTE_PAGADOR IS NULL AND EGA.DD_EGA_CODIGO NOT IN (''05'',''04'',''06'') AND GIC.GIC_FECHA_DEVENGO_ESPECIAL IS NOT NULL AND CRA.DD_CRA_CODIGO = ''03'') AUX ON (AUX.GGE_ID = GGE.GGE_ID)
		WHEN MATCHED THEN UPDATE SET
		GGE.GGE_CLIENTE_PAGADOR = (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_SOCIEDAD_PAGADORA = AUX.CLIENTE_PAGADOR),
		GGE.GGE_CLIENTE_INFORMADOR = (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_SOCIEDAD_PAGADORA = AUX.CLIENTE_INFORMADO),
		WHERE AUX.CLIENTE_PAGADOR IS NOT NULL';
			EXECUTE IMMEDIATE V_SQL;

COMMIT;

EXCEPTION
   WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    [ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM);
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    '||ERR_MSG;
      ROLLBACK;
      RAISE;
END SP_CALCULO_CLIENTE_PAGADOR_CAIXA;
/
EXIT;
