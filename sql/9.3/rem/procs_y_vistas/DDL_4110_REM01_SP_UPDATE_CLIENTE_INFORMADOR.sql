--/*
--##########################################
--## AUTOR=Alejandra García
--## FECHA_CREACION=20221005
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-12540
--## PRODUCTO=NO
--##
--## Finalidad: 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial - [HREOS-17157] - PIER GOTTA
--##        0.2 Modificación consulta - [HREOS-17266] - Alejandra García
--##        0.3 Añadir tipos de gastos Pendiente autorizar y Incompleto - [HREOS-] - Alejandra García
--##		0.4 Añadir Distinct para quitar duplicados para varias lineas de detale - [REMVIP-12540] - Juan Bautista Alfonso
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

CREATE OR REPLACE PROCEDURE #ESQUEMA#.SP_CALCULO_CLIENTE_PAGADOR_CAIXA
   (  PL_OUTPUT OUT VARCHAR2
   )
   
   AS

   V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar        
   V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
   V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
   ACT_ID NUMBER(32);
   ERR_NUM NUMBER(25); -- Vble. auxiliar para registrar errores en el script.
   ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
   DESCRIPCION VARCHAR2(64 CHAR);

BEGIN



	V_SQL := 'MERGE INTO '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE USING(
			WITH GASTOS_ACTIVOS_MIGRADOS AS (
					SELECT DISTINCT
						GPV.GPV_ID
					FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR  GPV
					JOIN '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = GPV.PRO_ID
						AND PRO.BORRADO = 0
					JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = PRO.DD_CRA_ID
						AND CRA.BORRADO = 0
					JOIN '||V_ESQUEMA||'.GLD_GASTOS_LINEA_DETALLE GLD ON GLD.GPV_ID = GPV.GPV_ID
						AND GLD.BORRADO = 0
					JOIN '||V_ESQUEMA||'.GLD_ENT GEN ON GEN.GLD_ID = GLD.GLD_ID
						AND GEN.BORRADO = 0 
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = GEN.ENT_ID
						AND GEN.BORRADO = 0
					JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_ID = ACT.DD_SCM_ID
						AND SCM.BORRADO = 0
					WHERE GPV.BORRADO = 0
					AND CRA.DD_CRA_CODIGO = ''03''
					AND ACT.ACT_NUM_ACTIVO_UVEM IS NOT NULL
					AND ACT.ACT_NUM_ACTIVO_CAIXA IS NOT NULL
                    AND PRO.PRO_DOCIDENTIF NOT IN (''A08663619'',''A58032244'',''B46644290'')
			), ACTIVOS_NO_MIGRADOS AS (
					SELECT DISTINCT
						GPV.GPV_ID
					FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR  GPV
					JOIN '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = GPV.PRO_ID
						AND PRO.BORRADO = 0
					JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = PRO.DD_CRA_ID
						AND CRA.BORRADO = 0
					JOIN '||V_ESQUEMA||'.GLD_GASTOS_LINEA_DETALLE GLD ON GLD.GPV_ID = GPV.GPV_ID
						AND GLD.BORRADO = 0
					JOIN '||V_ESQUEMA||'.GLD_ENT GEN ON GEN.GLD_ID = GLD.GLD_ID
						AND GEN.BORRADO = 0
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = GEN.ENT_ID
						AND GEN.BORRADO = 0
					JOIN '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_ID = ACT.DD_SCM_ID
						AND SCM.BORRADO = 0
                    JOIN '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
                        AND GIC.BORRADO = 0
					WHERE GPV.BORRADO = 0
					AND CRA.DD_CRA_CODIGO = ''03''
					AND ACT.ACT_NUM_ACTIVO_UVEM IS NOT NULL
					AND ACT.ACT_NUM_ACTIVO_CAIXA IS NULL
					AND SCM.DD_SCM_CODIGO = ''05''
                    AND PRO.PRO_DOCIDENTIF NOT IN (''A08663619'',''A58032244'',''B46644290'')
                    AND GIC.GIC_FECHA_DEVENGO_ESPECIAL IS NOT NULL
                    AND NOT EXISTS (SELECT
                                        1
                                    FROM GASTOS_ACTIVOS_MIGRADOS MIG
                                    WHERE MIG.GPV_ID = GPV.GPV_ID
                                    )
				), GASTOS_SIN_ACTIVOS AS (
					SELECT DISTINCT
						GPV.GPV_ID
					FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR  GPV
					JOIN '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = GPV.PRO_ID
						AND PRO.BORRADO = 0
					JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = PRO.DD_CRA_ID
						AND CRA.BORRADO = 0
					JOIN '||V_ESQUEMA||'.GLD_GASTOS_LINEA_DETALLE GLD ON GLD.GPV_ID = GPV.GPV_ID
						AND GLD.BORRADO = 0
					LEFT JOIN '||V_ESQUEMA||'.GLD_ENT GEN ON GEN.GLD_ID = GLD.GLD_ID
						AND GEN.BORRADO = 0
					WHERE GPV.BORRADO = 0
					AND CRA.DD_CRA_CODIGO = ''03''
                    AND GEN.GLD_ENT_ID IS NULL
                    AND PRO.PRO_DOCIDENTIF NOT IN (''A08663619'',''A58032244'',''B46644290'')
				)
			SELECT DISTINCT
				  GGE.GGE_ID
				, CASE 
					WHEN PRO.PRO_SOCIEDAD_PAGADORA = ''0015'' AND GIC.GIC_FECHA_DEVENGO_ESPECIAL <= TO_DATE(''15/11/2021'',''DD/MM/YYYY'') AND GIC.GIC_FECHA_DEVENGO_ESPECIAL IS NOT NULL THEN  ''0001''
					WHEN PRO.PRO_SOCIEDAD_PAGADORA = ''0015'' AND (GPV.PRO_ID_TITULAR_CARTA IS NULL OR GPV.PRO_ID_TITULAR_CARTA = (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_SOCIEDAD_PAGADORA = ''0015'')) 
                             AND GIC.GIC_FECHA_DEVENGO_ESPECIAL > TO_DATE(''15/11/2021'',''DD/MM/YYYY'') AND GIC.GIC_FECHA_DEVENGO_ESPECIAL IS NOT NULL THEN  ''0015''
					WHEN PRO.PRO_SOCIEDAD_PAGADORA = ''0001'' THEN ''0001''
					WHEN PRO.PRO_SOCIEDAD_PAGADORA = ''3148'' THEN ''0015''
					WHEN PRO.PRO_DOCIDENTIF NOT IN (''A08663619'',''A58032244'',''B46644290'') AND GLD.GLD_LINEA_SIN_ACTIVOS = 1 AND SIN_ACTIVOS.GPV_ID IS NOT NULL AND GIC.GIC_FECHA_DEVENGO_ESPECIAL IS NOT NULL THEN ''0001'' 
					WHEN ACTIV.GPV_ID IS NOT NULL  THEN ''0001''
                    WHEN PRO.PRO_SOCIEDAD_PAGADORA = ''0015'' AND 
						GPV.PRO_ID_TITULAR_CARTA IS NOT NULL AND GPV.PRO_ID_TITULAR_CARTA <> (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_SOCIEDAD_PAGADORA = ''0015'') THEN ''0001''
				  END AS CLIENTE_PAGADOR
				, CASE  
					WHEN PRO.PRO_SOCIEDAD_PAGADORA = ''0001'' AND GIC.GIC_FECHA_DEVENGO_ESPECIAL > TO_DATE(''15/11/2021'',''DD/MM/YYYY'') AND GIC.GIC_FECHA_DEVENGO_ESPECIAL IS NOT NULL THEN  ''0015''                  
					WHEN PRO.PRO_SOCIEDAD_PAGADORA = ''0015'' AND 
						GPV.PRO_ID_TITULAR_CARTA IS NOT NULL AND GPV.PRO_ID_TITULAR_CARTA <> (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_SOCIEDAD_PAGADORA = ''0015'') AND
						GIC.GIC_FECHA_DEVENGO_ESPECIAL > TO_DATE(''15/11/2021'',''DD/MM/YYYY'') AND GIC.GIC_FECHA_DEVENGO_ESPECIAL IS NOT NULL THEN ''0015''
				  END AS CLIENTE_INFORMADO
			FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR  GPV
			JOIN '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE ON GGE.GPV_ID = GPV.GPV_ID
				AND GGE.BORRADO = 0
			JOIN '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
				AND GIC.BORRADO = 0
			JOIN '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO EGA ON EGA.DD_EGA_ID = GPV.DD_EGA_ID
				AND EGA.BORRADO = 0
			JOIN '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = GPV.PRO_ID
				AND PRO.BORRADO = 0
			JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = PRO.DD_CRA_ID
				AND CRA.BORRADO = 0
			JOIN '||V_ESQUEMA||'.GLD_GASTOS_LINEA_DETALLE GLD ON GLD.GPV_ID = GPV.GPV_ID
				AND GLD.BORRADO = 0
			JOIN '||V_ESQUEMA||'.DD_DEG_DESTINATARIOS_GASTO DEG ON DEG.DD_DEG_ID = GPV.DD_DEG_ID
				AND DEG.BORRADO = 0
			LEFT JOIN ACTIVOS_NO_MIGRADOS ACTIV ON ACTIV.GPV_ID = GPV.GPV_ID
            LEFT JOIN GASTOS_SIN_ACTIVOS SIN_ACTIVOS ON SIN_ACTIVOS.GPV_ID = GPV.GPV_ID
			WHERE GGE.GGE_CLIENTE_PAGADOR IS NULL 
			AND EGA.DD_EGA_CODIGO NOT IN (''05'',''04'',''06'',''13'',''01'',''12'') 
			AND CRA.DD_CRA_CODIGO = ''03''
			AND GPV.BORRADO = 0
			AND DEG.DD_DEG_CODIGO = ''01''
		) AUX ON (AUX.GGE_ID = GGE.GGE_ID)
		WHEN MATCHED THEN UPDATE SET
		GGE.GGE_CLIENTE_PAGADOR = (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_SOCIEDAD_PAGADORA = AUX.CLIENTE_PAGADOR),
		GGE.GGE_CLIENTE_INFORMADOR = (SELECT PRO_ID FROM '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO WHERE PRO_SOCIEDAD_PAGADORA = AUX.CLIENTE_INFORMADO)
		WHERE AUX.CLIENTE_PAGADOR IS NOT NULL';
			EXECUTE IMMEDIATE V_SQL;

COMMIT;

EXCEPTION
   WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    [ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM);
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    '||ERR_MSG;
      ROLLBACK;
      RAISE;
END SP_CALCULO_CLIENTE_PAGADOR_CAIXA;
/
EXIT;
