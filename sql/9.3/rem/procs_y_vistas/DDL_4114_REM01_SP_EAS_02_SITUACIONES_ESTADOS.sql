--/*
--##########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20220720
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-18226
--## PRODUCTO=NO
--## Finalidad: 
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

CREATE OR REPLACE PROCEDURE #ESQUEMA#.SP_EAS_02_SITUACIONES_ESTADOS (
      PL_OUTPUT       OUT VARCHAR2
)
AS

  V_ESQUEMA VARCHAR2(15 CHAR) := '#ESQUEMA#';
  V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := '#ESQUEMA_MASTER#';
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.  

  V_SQL VARCHAR2(8000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.

BEGIN

    DBMS_OUTPUT.PUT_LINE('[INICIO]');
    
        V_SQL := 'TRUNCATE TABLE ' || V_ESQUEMA || '.AUX_APR_SITUACIONES_ESTADOS';
   	
   	EXECUTE IMMEDIATE V_SQL;

        V_SQL := 'MERGE INTO ' || V_ESQUEMA || '.AUX_APR_SITUACIONES_ESTADOS APR USING(
						WITH ACTIVO_MATRIZ AS (
			SELECT AGA.AGR_ID, ACT.ACT_NUM_ACTIVO, ACT.ACT_ID, ACT.DD_SAC_ID
			FROM ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR 
			JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGR.AGR_ID = AGA.AGR_ID AND AGA.BORRADO = 0
			JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = AGA.ACT_ID AND ACT.BORRADO = 0 
			WHERE AGR.BORRADO = 0 AND AGR.AGR_FECHA_BAJA IS NULL AND 
			AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') AND AGA.AGA_PRINCIPAL = 1)
            
                    SELECT 
		     ACT.ACT_NUM_ACTIVO AS ZZEXTERNALID, 
                    ''PA'' AS CODIGO_SITUACION,
                    ''Posesión activo'' AS DESCRIPCION_SITUACION,
                    EQV.DD_CODIGO_CAIXA AS CODIGO_ESTADO,
                    TO_CHAR(CAI.FEC_EST_POSESORIO_BC,''YYYYMMDD'') AS FECHA_INICIO,
                    NULL AS FECHA_FIN,
		    NULL AS NOTAS
		     FROM ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR 
		     JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGR.AGR_ID = AGA.AGR_ID AND AGA.BORRADO = 0
		     JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = AGA.ACT_ID AND ACT.BORRADO = 0
			 JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0     
             JOIN '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID AND PAC.BORRADO = 0   
		     JOIN ACTIVO_MATRIZ MAT ON MAT.AGR_ID = AGR.AGR_ID
                    JOIN ' || V_ESQUEMA || '.ACT_ACTIVO_CAIXA CAI ON CAI.ACT_ID = MAT.ACT_ID
                    LEFT JOIN ' || V_ESQUEMA || '.DD_ETP_ESTADO_POSESORIO ETP ON ETP.DD_ETP_ID = CAI.DD_ETP_ID
		     LEFT JOIN ' || V_ESQUEMA || '.DD_EQV_CAIXA_REM EQV ON EQV.DD_NOMBRE_CAIXA = ''ESTADO_POSESORIO'' AND EQV.DD_CODIGO_REM = ETP.DD_ETP_CODIGO  AND EQV.BORRADO=0  
				WHERE AGR.BORRADO = 0 
				AND AGR.AGR_FECHA_BAJA IS NULL 
				AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') 
				AND AGA.AGA_PRINCIPAL = 0
				AND CRA.DD_CRA_CODIGO = ''03''
				AND PAC.PAC_INCLUIDO = 1
				AND CAI.FEC_EST_POSESORIO_BC IS NOT NULL
                     UNION ALL
                     SELECT 
		      ACT.ACT_NUM_ACTIVO AS ZZEXTERNALID, 
                     ''TA'' AS CODIGO_SITUACION,
                     ''Situación técnica activo'' AS DESCRIPCION_SITUACION,
                     EQV.DD_CODIGO_CAIXA AS CODIGO_ESTADO,
            	     TO_CHAR(CAI.FECHA_EAT_EST_TECNICO,''YYYYMMDD'') AS FECHA_INICIO,
            	    NULL AS FECHA_FIN,
		    NULL AS NOTAS
		     FROM ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR 
		     JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGR.AGR_ID = AGA.AGR_ID AND AGA.BORRADO = 0
		     JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = AGA.ACT_ID AND ACT.BORRADO = 0 
			 JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0     
             JOIN '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID AND PAC.BORRADO = 0  
	            JOIN ACTIVO_MATRIZ MAT ON MAT.AGR_ID = AGR.AGR_ID
                    JOIN ' || V_ESQUEMA || '.ACT_ACTIVO_CAIXA CAI ON CAI.ACT_ID = MAT.ACT_ID
                    LEFT JOIN ' || V_ESQUEMA || '.DD_EAT_EST_TECNICO EAT ON EAT.DD_EAT_ID = CAI.DD_EAT_ID
		    LEFT JOIN ' || V_ESQUEMA || '.DD_EQV_CAIXA_REM EQV ON EQV.DD_NOMBRE_CAIXA = ''ESTADO_TECNICO'' AND EQV.DD_CODIGO_REM = EAT.DD_EAT_CODIGO  AND EQV.BORRADO=0  
				WHERE AGR.BORRADO = 0 
				AND AGR.AGR_FECHA_BAJA IS NULL 
				AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') 
				AND AGA.AGA_PRINCIPAL = 0
				AND CRA.DD_CRA_CODIGO = ''03''
				AND PAC.PAC_INCLUIDO = 1
				AND CAI.FECHA_EAT_EST_TECNICO IS NOT NULL
           	    UNION ALL
		    SELECT 
		     ACT.ACT_NUM_ACTIVO AS ZZEXTERNALID, 
		    ''CA'' AS CODIGO_SITUACION,
		    ''Situación comercial alquiler'' AS DESCRIPCION_SITUACION,
		    EQV.DD_CODIGO_CAIXA AS CODIGO_ESTADO,
		    TO_CHAR(CAI.FECHA_ECA_EST_COM_ALQUILER,''YYYYMMDD'') AS FECHA_INICIO,
		    NULL AS FECHA_FIN,
		    NULL AS NOTAS
		    FROM ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR 
		    JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGR.AGR_ID = AGA.AGR_ID AND AGA.BORRADO = 0
		    JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = AGA.ACT_ID AND ACT.BORRADO = 0
			JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0     
            JOIN '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID AND PAC.BORRADO = 0   
		    JOIN ACTIVO_MATRIZ MAT ON MAT.AGR_ID = AGR.AGR_ID
		    JOIN ' || V_ESQUEMA || '.ACT_ACTIVO_CAIXA CAI ON CAI.ACT_ID = MAT.ACT_ID
		    LEFT JOIN ' || V_ESQUEMA || '.DD_ECA_EST_COM_ALQUILER ECA ON ECA.DD_ECA_ID = CAI.DD_ECA_ID
		    LEFT JOIN ' || V_ESQUEMA || '.DD_EQV_CAIXA_REM EQV ON EQV.DD_NOMBRE_CAIXA = ''ESTADO_COMERCIAL_ALQUILER'' AND EQV.DD_CODIGO_REM = ECA.DD_ECA_CODIGO  AND EQV.BORRADO=0  
				WHERE AGR.BORRADO = 0 
				AND AGR.AGR_FECHA_BAJA IS NULL 
				AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') 
				AND AGA.AGA_PRINCIPAL = 0
				AND CRA.DD_CRA_CODIGO = ''03''
				AND PAC.PAC_INCLUIDO = 1
				AND CAI.FECHA_ECA_EST_COM_ALQUILER IS NOT NULL
			) AUX ON (AUX.ZZEXTERNALID = APR.ZZEXTERNALID) 
			WHEN NOT MATCHED THEN INSERT
			(
			APR.ZZEXTERNALID,
			APR.TIPSIT,
			APR.ESTAD,
			APR.FIREA,
			APR.FFEST,
			APR.NOTA
			) VALUES(
			AUX.ZZEXTERNALID,
			AUX.CODIGO_SITUACION,
			AUX.CODIGO_ESTADO,
			AUX.FECHA_INICIO,
			AUX.FECHA_FIN,
			AUX.NOTAS)';

        EXECUTE IMMEDIATE V_SQL;

    DBMS_OUTPUT.PUT_LINE('[INFO] FIN UPDATE / INSERT');
    COMMIT;

EXCEPTION
   WHEN OTHERS
   THEN
      DBMS_OUTPUT.put_line ('ERROR: ' || TO_CHAR (SQLCODE));
      DBMS_OUTPUT.put_line (SQLERRM);
      ROLLBACK;
      RAISE;
END SP_EAS_02_SITUACIONES_ESTADOS;
/
EXIT;
