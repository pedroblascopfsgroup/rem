--/*
--##########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20220721
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=HREOS-18229
--## PRODUCTO=NO
--## Finalidad: 
--##           
--## INSTRUCCIONES: Configurar las variables necesarias en el principio del DECLARE
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

CREATE OR REPLACE PROCEDURE #ESQUEMA#.SP_EAS_08_TEXTOS_ADICIONALES (
      PL_OUTPUT       OUT VARCHAR2
)
AS

  V_ESQUEMA VARCHAR2(15 CHAR) := '#ESQUEMA#';
  V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := '#ESQUEMA_MASTER#';
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.  

  V_SQL VARCHAR2(8000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.

BEGIN

    DBMS_OUTPUT.PUT_LINE('[INICIO]');
    
        V_SQL := 'TRUNCATE TABLE ' || V_ESQUEMA || '.AUX_APR_TEXTOS_ADICIONALES';
   	
   	EXECUTE IMMEDIATE V_SQL;

	    V_SQL := 'MERGE INTO ' || V_ESQUEMA || '.AUX_APR_TEXTOS_ADICIONALES APR USING(
					WITH ACTIVO_MATRIZ AS (SELECT AGA.AGR_ID, ACT.ACT_ID, ACT.ACT_NUM_ACTIVO_CAIXA
					FROM ACT_AGR_AGRUPACION AGR
					JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO aga ON aga.AGR_ID = AGR.AGR_ID AND aga.BORRADO = 0
					JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = aga.ACT_ID AND ACT.BORRADO = 0                                                              
					WHERE AGR.BORRADO = 0 AND AGR.AGR_FECHA_BAJA IS NULL
					AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') AND AGA.AGA_PRINCIPAL = 1)
					SELECT 
					ACT.ACT_NUM_ACTIVO AS ZZEXTERNALID, 
					''RE01'' AS TEXTCATE,
					SUBSTR(REPLACE(ACT.ACT_DESCRIPCION, '';'','',''), 1, 2800) AS XTEXTCATE
					FROM ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR 
					JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGR.AGR_ID = AGA.AGR_ID AND AGA.BORRADO = 0
					JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = AGA.ACT_ID AND ACT.BORRADO = 0
					JOIN ACTIVO_MATRIZ MAT ON MAT.AGR_ID = AGR.AGR_ID
					JOIN ' || V_ESQUEMA || '.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0     
					JOIN ' || V_ESQUEMA || '.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID AND PAC.BORRADO = 0   
						WHERE AGR.BORRADO = 0 
						AND AGR.AGR_FECHA_BAJA IS NULL 
						AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') 
						AND AGA.AGA_PRINCIPAL = 0
						AND CRA.DD_CRA_CODIGO = ''03''
						AND PAC.PAC_INCLUIDO = 1
						AND MAT.ACT_NUM_ACTIVO_CAIXA IS NOT NULL
			) AUX ON (AUX.ZZEXTERNALID = APR.ZZEXTERNALID AND AUX.TEXTCATE = APR.TEXTCATE) 
			WHEN NOT MATCHED THEN INSERT
			(
			APR.ZZEXTERNALID,
			APR.TEXTCATE,
			APR.XTEXTCATE
			) VALUES(
			AUX.ZZEXTERNALID,
			AUX.TEXTCATE,
			AUX.XTEXTCATE)';

        EXECUTE IMMEDIATE V_SQL;

		V_SQL := 'MERGE INTO ' || V_ESQUEMA || '.AUX_APR_TEXTOS_ADICIONALES APR USING(
						WITH ACTIVO_MATRIZ AS (SELECT AGA.AGR_ID, ACT.ACT_ID, ACT.ACT_NUM_ACTIVO_CAIXA
						FROM ACT_AGR_AGRUPACION AGR
						JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO aga ON aga.AGR_ID = AGR.AGR_ID AND aga.BORRADO = 0
						JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = aga.ACT_ID AND ACT.BORRADO = 0                                                              
						WHERE AGR.BORRADO = 0 AND AGR.AGR_FECHA_BAJA IS NULL
						AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') AND AGA.AGA_PRINCIPAL = 1)
						SELECT 
						ACT.ACT_NUM_ACTIVO AS ZZEXTERNALID, 
						''RE04'' AS TEXTCATE,
						SUBSTR(REPLACE(MTO_V.DD_MTO_DESCRIPCION || '' '' || APU.APU_MOT_OCULTACION_MANUAL_V || '' '' || MTO_A.DD_MTO_DESCRIPCION || '' '' || APU.APU_MOT_OCULTACION_MANUAL_A, '';'','',''), 1, 2800) AS XTEXTCATE
						FROM ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR 
						JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGR.AGR_ID = AGA.AGR_ID AND AGA.BORRADO = 0
						JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = AGA.ACT_ID AND ACT.BORRADO = 0 
						JOIN ACTIVO_MATRIZ MAT ON MAT.AGR_ID = AGR.AGR_ID
						JOIN ' || V_ESQUEMA || '.ACT_APU_ACTIVO_PUBLICACION APU ON ACT.ACT_ID = APU.ACT_ID  
						JOIN ' || V_ESQUEMA || '.ACT_PAC_PERIMETRO_ACTIVO PAC ON ACT.ACT_ID = PAC.ACT_ID 
						JOIN ' || V_ESQUEMA || '.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0  
						LEFT JOIN ' || V_ESQUEMA || '.DD_EPV_ESTADO_PUB_VENTA EPV ON EPV.DD_EPV_ID = APU.DD_EPV_ID AND EPV.BORRADO = 0
						LEFT JOIN ' || V_ESQUEMA || '.DD_EPA_ESTADO_PUB_ALQUILER EPA ON EPA.DD_EPA_ID = APU.DD_EPA_ID AND EPA.BORRADO = 0
						LEFT JOIN ' || V_ESQUEMA || '.DD_MTO_MOTIVOS_OCULTACION MTO_V ON MTO_V.DD_MTO_ID = APU.DD_MTO_V_ID AND MTO_V.BORRADO = 0
						LEFT JOIN ' || V_ESQUEMA || '.DD_MTO_MOTIVOS_OCULTACION MTO_A ON MTO_A.DD_MTO_ID = APU.DD_MTO_A_ID AND MTO_A.BORRADO = 0
							WHERE AGR.BORRADO = 0 
							AND AGR.AGR_FECHA_BAJA IS NULL 
							AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') 
							AND AGA.AGA_PRINCIPAL = 0
							AND CRA.DD_CRA_CODIGO = ''03''
							AND PAC.PAC_INCLUIDO = 1
							AND MAT.ACT_NUM_ACTIVO_CAIXA IS NOT NULL
							AND (EPV.DD_EPV_CODIGO = ''04'' OR EPA.DD_EPA_CODIGO = ''04'')
			) AUX ON (AUX.ZZEXTERNALID = APR.ZZEXTERNALID AND AUX.TEXTCATE = APR.TEXTCATE) 
			WHEN NOT MATCHED THEN INSERT
			(
			APR.ZZEXTERNALID,
			APR.TEXTCATE,
			APR.XTEXTCATE
			) VALUES(
			AUX.ZZEXTERNALID,
			AUX.TEXTCATE,
			AUX.XTEXTCATE)';

        EXECUTE IMMEDIATE V_SQL;

		V_SQL := 'MERGE INTO ' || V_ESQUEMA || '.AUX_APR_TEXTOS_ADICIONALES APR USING(
					WITH ACTIVO_MATRIZ AS (SELECT AGA.AGR_ID, ACT.ACT_ID, ACT.ACT_NUM_ACTIVO_CAIXA
					FROM ACT_AGR_AGRUPACION AGR
					JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO aga ON aga.AGR_ID = AGR.AGR_ID AND aga.BORRADO = 0
					JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = aga.ACT_ID AND ACT.BORRADO = 0                                                              
					WHERE AGR.BORRADO = 0 AND AGR.AGR_FECHA_BAJA IS NULL
					AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') AND AGA.AGA_PRINCIPAL = 1)
					SELECT
					ACT.ACT_NUM_ACTIVO AS ZZEXTERNALID, 
					''RE07'' AS TEXTCATE,
					SUBSTR(REPLACE(REPLACE(REPLACE(ICO.ICO_INFO_DISTRIBUCION_INTERIOR, CHR(10), '' ''), CHR(13), '' '') || '' '' ||REPLACE(REPLACE(EDIF.EDI_DESCRIPCION, CHR(10), '' ''), CHR(13), '' ''), '';'','',''), 1, 2800) AS XTEXTCATE
					FROM ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR 
					JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGR.AGR_ID = AGA.AGR_ID AND AGA.BORRADO = 0
					JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = AGA.ACT_ID AND ACT.BORRADO = 0 
					JOIN ACTIVO_MATRIZ MAT ON MAT.AGR_ID = AGR.AGR_ID
					JOIN ' || V_ESQUEMA || '.ACT_ICO_INFO_COMERCIAL ICO ON ACT.ACT_ID = ICO.ACT_ID
					JOIN ' || V_ESQUEMA || '.ACT_EDI_EDIFICIO EDIF ON EDIF.ICO_ID = ICO.ICO_ID
					JOIN ' || V_ESQUEMA || '.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0     
					JOIN ' || V_ESQUEMA || '.ACT_PAC_PERIMETRO_ACTIVO PAC ON PAC.ACT_ID = ACT.ACT_ID AND PAC.BORRADO = 0  
						WHERE AGR.BORRADO = 0 
						AND AGR.AGR_FECHA_BAJA IS NULL 
						AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') 
						AND AGA.AGA_PRINCIPAL = 0
						AND CRA.DD_CRA_CODIGO = ''03''
						AND PAC.PAC_INCLUIDO = 1
						AND MAT.ACT_NUM_ACTIVO_CAIXA IS NOT NULL
			) AUX ON (AUX.ZZEXTERNALID = APR.ZZEXTERNALID AND AUX.TEXTCATE = APR.TEXTCATE) 
			WHEN NOT MATCHED THEN INSERT
			(
			APR.ZZEXTERNALID,
			APR.TEXTCATE,
			APR.XTEXTCATE
			) VALUES(
			AUX.ZZEXTERNALID,
			AUX.TEXTCATE,
			AUX.XTEXTCATE)';

        EXECUTE IMMEDIATE V_SQL;

		V_SQL := 'MERGE INTO ' || V_ESQUEMA || '.AUX_APR_TEXTOS_ADICIONALES APR USING(
					WITH ACTIVO_MATRIZ AS (SELECT AGA.AGR_ID, ACT.ACT_ID, ACT.ACT_NUM_ACTIVO_CAIXA
					FROM ACT_AGR_AGRUPACION AGR
					JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO aga ON aga.AGR_ID = AGR.AGR_ID AND aga.BORRADO = 0
					JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = aga.ACT_ID AND ACT.BORRADO = 0                                                              
					WHERE AGR.BORRADO = 0 AND AGR.AGR_FECHA_BAJA IS NULL
					AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') AND AGA.AGA_PRINCIPAL = 1)
					SELECT  
					ACT.ACT_NUM_ACTIVO AS ZZEXTERNALID, 
					''RE02'' AS TEXTCATE,
					SUBSTR(REPLACE(PAC.PAC_MOT_EXCL_COMERCIALIZAR, '';'','',''), 1, 2800) AS XTEXTCATE
					FROM ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR 
					JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGR.AGR_ID = AGA.AGR_ID AND AGA.BORRADO = 0
					JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = AGA.ACT_ID AND ACT.BORRADO = 0
					JOIN ACTIVO_MATRIZ MAT ON MAT.AGR_ID = AGR.AGR_ID
					JOIN ' || V_ESQUEMA || '.ACT_APU_ACTIVO_PUBLICACION APU ON ACT.ACT_ID = APU.ACT_ID  
					JOIN ' || V_ESQUEMA || '.ACT_PAC_PERIMETRO_ACTIVO PAC ON ACT.ACT_ID = PAC.ACT_ID
					JOIN ' || V_ESQUEMA || '.DD_TCO_TIPO_COMERCIALIZACION TCO ON TCO.DD_TCO_ID = ACT.DD_TCO_ID
					JOIN ' || V_ESQUEMA || '.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0     
						WHERE AGR.BORRADO = 0 
						AND AGR.AGR_FECHA_BAJA IS NULL 
						AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') 
						AND AGA.AGA_PRINCIPAL = 0
						AND CRA.DD_CRA_CODIGO = ''03''
						AND PAC.PAC_INCLUIDO = 1
						AND TCO.DD_TCO_CODIGO IN (''02'',''03'')
						AND PAC.PAC_CHECK_COMERCIALIZAR = 0
						AND MAT.ACT_NUM_ACTIVO_CAIXA IS NOT NULL
			) AUX ON (AUX.ZZEXTERNALID = APR.ZZEXTERNALID AND AUX.TEXTCATE = APR.TEXTCATE) 
			WHEN NOT MATCHED THEN INSERT
			(
			APR.ZZEXTERNALID,
			APR.TEXTCATE,
			APR.XTEXTCATE
			) VALUES(
			AUX.ZZEXTERNALID,
			AUX.TEXTCATE,
			AUX.XTEXTCATE)';

        EXECUTE IMMEDIATE V_SQL;

		V_SQL := 'MERGE INTO ' || V_ESQUEMA || '.AUX_APR_TEXTOS_ADICIONALES APR USING(
					WITH ACTIVO_MATRIZ AS (SELECT AGA.AGR_ID, ACT.ACT_ID, ACT.ACT_NUM_ACTIVO_CAIXA
					FROM ACT_AGR_AGRUPACION AGR
					JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO aga ON aga.AGR_ID = AGR.AGR_ID AND aga.BORRADO = 0
					JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = aga.ACT_ID AND ACT.BORRADO = 0                                                              
					WHERE AGR.BORRADO = 0 AND AGR.AGR_FECHA_BAJA IS NULL
					AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') AND AGA.AGA_PRINCIPAL = 1)
					SELECT  
					ACT.ACT_NUM_ACTIVO AS ZZEXTERNALID, 
					''RE03'' AS TEXTCATE,
					SUBSTR(REPLACE(PAC.PAC_MOT_EXCL_COMERCIALIZAR, '';'','',''), 1, 2800) AS XTEXTCATE
					FROM ' || V_ESQUEMA || '.ACT_AGR_AGRUPACION AGR 
					JOIN ' || V_ESQUEMA || '.ACT_AGA_AGRUPACION_ACTIVO AGA ON AGR.AGR_ID = AGA.AGR_ID AND AGA.BORRADO = 0
					JOIN ' || V_ESQUEMA || '.ACT_ACTIVO ACT ON ACT.ACT_ID = AGA.ACT_ID AND ACT.BORRADO = 0
					JOIN ACTIVO_MATRIZ MAT ON MAT.AGR_ID = AGR.AGR_ID
					JOIN ' || V_ESQUEMA || '.ACT_APU_ACTIVO_PUBLICACION APU ON ACT.ACT_ID = APU.ACT_ID  
					JOIN ' || V_ESQUEMA || '.ACT_PAC_PERIMETRO_ACTIVO PAC ON ACT.ACT_ID = PAC.ACT_ID
					JOIN ' || V_ESQUEMA || '.DD_TCO_TIPO_COMERCIALIZACION TCO ON TCO.DD_TCO_ID = ACT.DD_TCO_ID
					JOIN ' || V_ESQUEMA || '.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID AND CRA.BORRADO = 0     
						WHERE AGR.BORRADO = 0 
						AND AGR.AGR_FECHA_BAJA IS NULL 
						AND AGR.DD_TAG_ID = (SELECT DD_TAG_ID FROM ' || V_ESQUEMA || '.DD_TAG_TIPO_AGRUPACION WHERE DD_TAG_CODIGO = ''16'') 
						AND AGA.AGA_PRINCIPAL = 0
						AND CRA.DD_CRA_CODIGO = ''03''
						AND PAC.PAC_INCLUIDO = 1
						AND TCO.DD_TCO_CODIGO IN (''02'',''01'')
						AND PAC.PAC_CHECK_COMERCIALIZAR = 0
						AND MAT.ACT_NUM_ACTIVO_CAIXA IS NOT NULL
			) AUX ON (AUX.ZZEXTERNALID = APR.ZZEXTERNALID AND AUX.TEXTCATE = APR.TEXTCATE) 
			WHEN NOT MATCHED THEN INSERT
			(
			APR.ZZEXTERNALID,
			APR.TEXTCATE,
			APR.XTEXTCATE
			) VALUES(
			AUX.ZZEXTERNALID,
			AUX.TEXTCATE,
			AUX.XTEXTCATE)';

        EXECUTE IMMEDIATE V_SQL;

        

    DBMS_OUTPUT.PUT_LINE('[INFO] FIN UPDATE / INSERT');
    COMMIT;

EXCEPTION
   WHEN OTHERS
   THEN
      DBMS_OUTPUT.put_line ('ERROR: ' || TO_CHAR (SQLCODE));
      DBMS_OUTPUT.put_line (SQLERRM);
      ROLLBACK;
      RAISE;
END SP_EAS_08_TEXTOS_ADICIONALES;
/
EXIT;
