--/*
--##########################################
--## AUTOR=Carles Molins
--## FECHA_CREACION=20191119
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-5796
--## PRODUCTO=NO
--## 
--## Finalidad: BORRAR TRAMITE GENCAT 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Version inicial
--##########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_ESQUEMA VARCHAR2(50 CHAR) := '#ESQUEMA#';
    V_ESQUEMA_M VARCHAR2(50 CHAR) := '#ESQUEMA_MASTER#';    
    V_ITEM VARCHAR2(30 CHAR) := 'REMVIP-5796';
    V_SQL VARCHAR2(4000 CHAR);

BEGIN
	
	V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_TRA_TRAMITE SET BORRADO = 1, USUARIOBORRAR = '''||V_ITEM||''', FECHABORRAR = SYSDATE
				WHERE TRA_ID IN (
				    SELECT AUX.TRA_ID
				    FROM(
				        SELECT TAC.TRA_ID,
				        ROW_NUMBER() OVER(PARTITION BY TAC.TRA_ID ORDER BY TAR.TAR_ID DESC) AS RN
				        FROM '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP
				        INNER JOIN '||V_ESQUEMA||'.DD_TPO_TIPO_PROCEDIMIENTO TPO ON TPO.DD_TPO_ID = TAP.DD_TPO_ID
				        INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TAP.TAP_ID = TEX.TAP_ID
				        INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TEX.TAR_ID = TAR.TAR_ID
				        INNER JOIN '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC ON TAR.TAR_ID = TAC.TAR_ID
				        WHERE DD_TPO_CODIGO = ''T016''
				        AND TAC.ACT_ID IN
				        (
				            SELECT ACT.ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
				            JOIN '||V_ESQUEMA||'.ACT_CMG_COMUNICACION_GENCAT CMG ON CMG.ACT_ID = ACT.ACT_ID AND CMG.BORRADO = 0
				            WHERE NOT EXISTS (SELECT * FROM '||V_ESQUEMA||'.VI_ACTIVOS_AFECTOS_GENCAT GEN WHERE GEN.ACT_ID = ACT.ACT_ID)
				            AND CMG.FECHACREAR > TO_DATE(''14/11/2019'', ''DD/MM/YYYY'')
				        )
				    ) AUX
				    WHERE RN = 1
				)';
	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('	[INFO] Se han eliminado '||SQL%ROWCOUNT||' trámites de GENCAT');

	V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_OFG_OFERTA_GENCAT SET BORRADO = 1, USUARIOBORRAR = '''||V_ITEM||''', FECHABORRAR = SYSDATE
				WHERE CMG_ID IN (
				    SELECT CMG.CMG_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
				    JOIN '||V_ESQUEMA||'.ACT_CMG_COMUNICACION_GENCAT CMG ON CMG.ACT_ID = ACT.ACT_ID AND CMG.BORRADO = 0
				    WHERE NOT EXISTS (SELECT * FROM '||V_ESQUEMA||'.VI_ACTIVOS_AFECTOS_GENCAT GEN WHERE GEN.ACT_ID = ACT.ACT_ID)
				    AND CMG.FECHACREAR > TO_DATE(''14/11/2019'', ''DD/MM/YYYY'')
				)';
	EXECUTE IMMEDIATE V_SQL;

	V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_ADG_ADECUACION_GENCAT SET BORRADO = 1, USUARIOBORRAR = '''||V_ITEM||''', FECHABORRAR = SYSDATE
				WHERE CMG_ID IN (
				    SELECT CMG.CMG_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
				    JOIN '||V_ESQUEMA||'.ACT_CMG_COMUNICACION_GENCAT CMG ON CMG.ACT_ID = ACT.ACT_ID AND CMG.BORRADO = 0
				    WHERE NOT EXISTS (SELECT * FROM '||V_ESQUEMA||'.VI_ACTIVOS_AFECTOS_GENCAT GEN WHERE GEN.ACT_ID = ACT.ACT_ID)
				    AND CMG.FECHACREAR > TO_DATE(''14/11/2019'', ''DD/MM/YYYY'')
				)';
	EXECUTE IMMEDIATE V_SQL;

	V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_CMG_COMUNICACION_GENCAT SET BORRADO = 1, USUARIOBORRAR = '''||V_ITEM||''', FECHABORRAR = SYSDATE
				WHERE CMG_ID IN (
				    SELECT CMG.CMG_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
				    JOIN '||V_ESQUEMA||'.ACT_CMG_COMUNICACION_GENCAT CMG ON CMG.ACT_ID = ACT.ACT_ID AND CMG.BORRADO = 0
				    WHERE NOT EXISTS (SELECT * FROM '||V_ESQUEMA||'.VI_ACTIVOS_AFECTOS_GENCAT GEN WHERE GEN.ACT_ID = ACT.ACT_ID)
				    AND CMG.FECHACREAR > TO_DATE(''14/11/2019'', ''DD/MM/YYYY'')
				)';
	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('	[INFO] Se han eliminado '||SQL%ROWCOUNT||' comunicaciones con GENCAT');
	
    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(SQLERRM);
        DBMS_OUTPUT.put_line(V_SQL);
        ROLLBACK;
        RAISE;   
END;
/
EXIT;