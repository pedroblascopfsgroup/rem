--/*
--#########################################
--## AUTOR=Viorel Remus Ovidiu
--## FECHA_CREACION=20191203
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-5910
--## PRODUCTO=NO
--## 
--## Finalidad: ACTUALIZAR PORCENTAJE PARTICIPACION ACTIVOS A 100%
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	
    err_num NUMBER; -- Numero de error.
    err_msg VARCHAR2(2048); -- Mensaje de error.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_USUARIOMODIFICAR VARCHAR(100 CHAR):= 'REMVIP-5910';
    V_SQL VARCHAR2(32000 CHAR);
    V_NUM_TABLAS NUMBER;
    V_COUNT NUMBER(16):= 0; -- Vble. para contar updates
    
BEGIN	

    DBMS_OUTPUT.PUT_LINE('[INICIO]');
    DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZAR IMPORTE TOTAL TRABAJOS');

    V_SQL :='MERGE INTO '||V_ESQUEMA||'.ACT_TBJ T1 USING (
		SELECT TBJ_NUM_TRABAJO, TBJ_ID, ACT_TBJ_PARTICIPACION FROM 
			    (SELECT TBJ_NUM_TRABAJO, TBJ.TBJ_IMPORTE_TOTAL AS IMPORTE_ACTUAL, ACT_TBJ_PARTICIPACION, TBJ.TBJ_ID
			    FROM '||V_ESQUEMA||'.ACT_TCT_TRABAJO_CFGTARIFA CFG 
			    JOIN '||V_ESQUEMA||'.ACT_TBJ_TRABAJO TBJ ON CFG.TBJ_ID = TBJ.TBJ_ID 
		    	    JOIN '||V_ESQUEMA||'.ACT_TBJ ACTTBJ ON ACTTBJ.TBJ_ID = TBJ.TBJ_ID
			    AND TBJ.TBJ_NUM_TRABAJO IN 
			(166193,
			167231,
			170461,
			168111,
			168326,
			168300,
			170712,
			169325,
			165836,
			170168,
			167890,
			167995,
			169717,
			168862,
			165821,
			167360,
			156039,
			169702,
			158654,
			153785,
			167277,
			167362,
			165280,
			158219,
			159994,
			156108,
			163094,
			162422,
			166052,
			165815,
			166463,
			167508,
			167515,
			167744,
			169169,
			169939,
			167986,
			169392,
			166877,
			167891,
			167999,
			167657,
			170864,
			170745,
			169641,
			168786,
			168075,
			167612,
			168321,
			169744,
			170641,
			170871,
			169954,
			167588,
			168908,
			169616,
			170069,
			170358,
			167133,
			169068,
			169284,
			170076,
			170421,
			170985,
			170989,
			166248,
			157962,
			170640,
			170609,
			157774,
			169025,
			166855,
			166861,
			168141,
			167375,
			167438,
			161902,
			155378,
			170458,
			158397,
			166974,
			167173,
			162979,
			160645,
			166685,
			169162,
			170212,
			168548,
			169519,
			156338,
			158653,
			159161,
			162713,
			167440,
			167268,
			167093,
			168290,
			168013,
			170911,
			162921,
			170330,
			170715,
			165562,
			167700,
			168706,
			165846,
			169894,
			171006,
			165880,
			167443,
			168623,
			169422,
			169592,
			167740,
			168720,
			166377,
			168960,
			168946,
			168314,
			170955,
			168453,
			170933,
			169643,
			168881,
			168860,
			165431,
			167658,
			166984,
			166872,
			160899,
			169716,
			159594,
			160791,
			157396,
			166581,
			167436,
			159068,
			161833,
			162045,
			161643,
			165734,
			166469,
			167594,
			168406,
			170853,
			170055,
			168550,
			169577,
			161818,
			167432,
			167083,
			166670,
			167992,
			170436,
			166032,
			168782,
			170909,
			168601,
			167755,
			168234,
			167921,
			170426,
			170483,
			156653,
			168354,
			167478,
			167887,
			168145,
			165641,
			166281,
			166978,
			162152,
			155922,
			154315,
			154778,
			169424,
			161908,
			167430,
			165637,
			158140,
			159065,
			161439,
			166879,
			166884,
			167750,
			170622,
			167435,
			167269,
			166888,
			170456,
			169523,
			169167,
			169555,
			165826,
			170203,
			166614,
			167473,
			170232,
			170242,
			169952,
			170048,
			165141,
			168696,
			168448,
			169035,
			169026,
			170443,
			169390,
			168874,
			166878,
			167429,
			166667,
			166680,
			162701,
			151164,
			170215,
			170217,
			158229,
			157277,
			166061,
			167169,
			154994,
			162158,
			166211,
			165737,
			166573,
			170459,
			170941,
			170216,
			169938,
			155545,
			161640,
			165553,
			166326,
			168012,
			166904,
			170760,
			167716,
			168398,
			163880,
			170254,
			165847,
			167296,
			168024,
			170079,
			165695,
			168134,
			168360,
			169528,
			168228,
			169488,
			168414,
			167541,
			167556,
			163484,
			170857,
			169788,
			169127,
			169395,
			169164,
			167521,
			167283,
			166673,
			162712,
			162982,
			160311,
			157982,
			166883,
			162154,
			157915,
			162042,
			166987,
			167512,
			168405,
			168888,
			169642,
			169130,
			161398,
			167516,
			166889,
			170440,
			169397,
			168879,
			168889,
			170967,
			160417,
			168252,
			168319,
			168324,
			168917,
			169664,
			169432,
			167104,
			167962,
			167475,
			168801,
			170642,
			168602,
			169560,
			170737,
			170773,
			167707,
			166412,
			168898,
			167543,
			165104,
			169786,
			169790,
			166457,
			159413,
			170735,
			170934,
			169719,
			170213,
			161731,
			154093,
			166046,
			166676,
			167168,
			166472,
			157631,
			158757,
			161443,
			168007,
			170623,
			170220,
			170052,
			168552,
			168288,
			169398,
			169160,
			168870,
			156365,
			159727,
			161828,
			167281,
			167178,
			166585,
			166198,
			169718,
			166937,
			166105,
			169951,
			168593,
			169461,
			170452,
			166590,
			9000040108,
			9000041902,
			9000042195,
			9000043262,
			9000045417,
			9000049145,
			9000051334,
			9000051362,
			9000052503,
			9000052902,
			9000052930,
			9000057580,
			9000058054,
			9000058629,
			9000059872,
			9000060273,
			9000060458,
			9000060595,
			9000061857,
			9000062192,
			9000062730,
			9000062732,
			9000063228,
			9000064115,
			9000065973,
			9000066548,
			9000069543,
			9000069979,
			9000070025,
			9000070765,
			9000070839,
			9000072578,
			9000075511,
			9000077617,
			9000080514,
			9000083662,
			9000093251,
			9000094388,
			9000094845,
			9000095140,
			9000096227,
			9000100328,
			9000101048,
			9000101239,
			9000101252,
			9000101458,
			9000103345,
			9000105216,
			9000105259,
			9000105432,
			9000105715,
			9000108738,
			9000112187,
			9000112294,
			9000112499,
			9000114283,
			9000115106,
			9000121948,
			9000123868,
			9000123869,
			9000123878,
			9000123880,
			9000123892,
			9000123904,
			9000124027,
			9000124185,
			9000124872,
			9000125786,
			9000125941,
			9000126404,
			9000127247,
			9000127252,
			9000127310,
			9000128027,
			9000128313,
			9000128319,
			9000128353,
			9000128355,
			9000128359,
			9000128361,
			9000128363,
			9000128472,
			9000128489,
			9000128498,
			9000128654,
			9000128656,
			9000129071,
			9000129134,
			9000129535,
			9000129753,
			9000129791,
			9000130231,
			9000139107,
			9000139579,
			9000139581,
			9000139586,
			9000139607,
			9000144596,
			9000144600,
			9000144608,
			9000152154,
			9000155943,
			9000156392,
			9000171307,
			9000173318,
			9000174733,
			9000176520,
			9000177982,
			9000185819,
			9000186907,
			9000188095,
			9000194933,
			9000197754,
			9000202533,
			9000206922,
			9000211720,
			9000228872,
			171069,
			167165,
			153102,
			170425,
			168010,
			168982,
			170639,
			169954,
			168156,
			168899,
			170811,
			165844,
			169923,
			168420,
			169639,
			166983,
			167167,
			170624,
			168857,
			166905,
			165741,
			158771,
			169170,
			160467,
			168872,
			158216,
			166769,
			169132,
			166777,
			170427,
			168407,
			170733,
			9000041672,
			9000079896,
			9000093191,
			9000095140,
			9000099062,
			9000127049,
			9000128356,
			9000128502,
			9000182819) 
		GROUP BY TBJ_NUM_TRABAJO, TBJ.TBJ_IMPORTE_TOTAL, TBJ.USUARIOCREAR, ACT_TBJ_PARTICIPACION, TBJ.TBJ_ID
		ORDER BY TBJ_NUM_TRABAJO ASC) WHERE ACT_TBJ_PARTICIPACION <> 100)T2
		ON (T1.TBJ_ID=T2.TBJ_ID)
		WHEN MATCHED THEN UPDATE SET 
		T1.ACT_TBJ_PARTICIPACION = 100
		,T1.VERSION = 1'; 	


      EXECUTE IMMEDIATE V_SQL;
    
      DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado  '||SQL%ROWCOUNT||' registros .');

     COMMIT;

     DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT
