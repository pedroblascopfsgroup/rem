--/*
--###########################################
--## AUTOR=Carles Molins
--## FECHA_CREACION=20191224
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6062
--## PRODUCTO=NO
--## 
--## Finalidad:
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE
	V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
	V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
	ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
	ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO]');

	-- PRESCRIPCIÓN

	V_MSQL := 'MERGE INTO REM01.GEX_GASTOS_EXPEDIENTE T1
				USING (
					SELECT GEX.GEX_ID
					FROM REM01.OFR_OFERTAS OFR
					JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
					JOIN REM01.DD_EOF_ESTADOS_OFERTA EOF ON EOF.DD_EOF_ID = OFR.DD_EOF_ID AND DD_EOF_CODIGO = ''01''
					JOIN REM01.DD_EEC_EST_EXP_COMERCIAL EEC ON EEC.DD_EEC_ID = ECO.DD_EEC_ID AND DD_EEC_CODIGO = ''08''
					JOIN REM01.GEX_GASTOS_EXPEDIENTE GEX ON GEX.ECO_ID = ECO.ECO_ID
					JOIN REM01.DD_ACC_ACCION_GASTOS ACC ON ACC.DD_ACC_ID = GEX.DD_ACC_ID AND DD_ACC_CODIGO = ''04''
					WHERE OFR.OFR_VENTA_DIRECTA = 1
					AND OFR.FECHACREAR > TO_DATE(''31/10/2019'', ''DD/MM/YYYY'')
				) T2
				ON (T1.GEX_ID = T2.GEX_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.GEX_IMPORTE_CALCULO = 0
					,T1.GEX_IMPORTE_FINAL = 0
					,T1.GEX_EDITADO = 1
					,T1.USUARIOMODIFICAR = ''REMVIP-6062''
					,T1.FECHAMODIFICAR = SYSDATE
				';
	EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('	[INFO] '||SQL%ROWCOUNT||' registros Prescipción actualizados');

	-- CUSTODIO

	V_MSQL := 'MERGE INTO REM01.GEX_GASTOS_EXPEDIENTE T1
				USING (
					SELECT GEX.GEX_ID, VI.IMP_ACT_OFERTA
					FROM REM01.OFR_OFERTAS OFR
					JOIN REM01.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID
					JOIN REM01.DD_EOF_ESTADOS_OFERTA EOF ON EOF.DD_EOF_ID = OFR.DD_EOF_ID AND DD_EOF_CODIGO = ''01''
					JOIN REM01.DD_EEC_EST_EXP_COMERCIAL EEC ON EEC.DD_EEC_ID = ECO.DD_EEC_ID AND DD_EEC_CODIGO = ''08''
					JOIN REM01.GEX_GASTOS_EXPEDIENTE GEX ON GEX.ECO_ID = ECO.ECO_ID
					JOIN REM01.DD_ACC_ACCION_GASTOS ACC ON ACC.DD_ACC_ID = GEX.DD_ACC_ID AND DD_ACC_CODIGO = ''05''
					JOIN REM01.V_LISTADO_ACT_EXP VI ON VI.ECO_ID = ECO.ECO_ID AND VI.ACT_ID = GEX.ACT_ID
					WHERE OFR.OFR_VENTA_DIRECTA = 1
					AND OFR.FECHACREAR > TO_DATE(''31/10/2019'', ''DD/MM/YYYY'')
				) T2
				ON (T1.GEX_ID = T2.GEX_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.GEX_IMPORTE_CALCULO = 0.2
					,T1.GEX_IMPORTE_FINAL = (0.002 * T2.IMP_ACT_OFERTA)
					,T1.GEX_EDITADO = 1
					,T1.USUARIOMODIFICAR = ''REMVIP-6062''
					,T1.FECHAMODIFICAR = SYSDATE
				';
	EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('	[INFO] '||SQL%ROWCOUNT||' registros Custodio actualizados');

	COMMIT;
	DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION

	WHEN OTHERS THEN
		ERR_NUM := SQLCODE;
		ERR_MSG := SQLERRM;

		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
		DBMS_OUTPUT.put_line(err_msg);

		ROLLBACK;
		RAISE;          

END;
/
EXIT
