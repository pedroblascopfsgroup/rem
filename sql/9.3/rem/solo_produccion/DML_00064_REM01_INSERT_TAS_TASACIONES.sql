--/*
--##########################################
--## AUTOR=Viorel Remus Ovidiu
--## FECHA_CREACION=20200102
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6122
--## PRODUCTO=NO
--## 
--## Finalidad: Script que añade en ACT_TAS_TASACION los datos añadidos en T_ARRAY_DATA
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
        V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA_1 VARCHAR2(25 CHAR):= 'BIE_VALORACIONES';
    V_TABLA_2 VARCHAR2(25 CHAR):= 'ACT_TAS_TASACION';
    V_TABLA_3 VARCHAR2(25 CHAR):= 'BIE_DATOS_REGISTRALES';
    V_COUNT NUMBER(16); -- Vble. para contar.
    V_KOUNT NUMBER(16); -- Vble. para kontar.
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

	ACT_NUM_ACTIVO NUMBER(16);
	ACT_ID NUMBER(16);
	NUM_SECUENCIA_VAL NUMBER(16);
	NUM_SECUENCIA_TAS NUMBER(16);
	BIE_ID NUMBER(16);

    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-6122';    
    
    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    			-- NUM_ACT	NºFINCA 	FECHA_TAS	IMPORTE_TAS		TASADORA
			 T_TIPO_DATA('6044011','','26/07/2019','178436,85','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044023','','06/09/2019','133769,5','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044026','','11/10/2019','255639,01','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044031','','18/10/2019','9735,56','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044033','','06/09/2019','8197,76','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044035','','13/09/2019','198834,35','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044036','','04/10/2019','89098,16','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044037','','11/10/2019','27038,06','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044039','','18/10/2019','13523,97','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044043','','25/10/2019','128297,4','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044046','','11/10/2019','126731,27','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044051','','13/09/2019','12628,11','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044055','','06/09/2019','47258,41','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044057','','04/10/2019','30611,13','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044077','','06/09/2019','52492,69','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044091','','13/09/2019','35531,69','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044093','','22/11/2019','101484,3','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044096','','11/10/2019','8898,14','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044101','','06/09/2019','114579,72','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044102','','20/09/2019','66100,46','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044106','','06/09/2019','89430,99','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044114','','13/09/2019','203089,97','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044121','','31/10/2019','7750,37','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044127','','20/09/2019','3883,38','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044128','','20/09/2019','85093,87','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044133','','20/09/2019','216582,84','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044134','','11/10/2019','141445,03','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044135','','08/11/2019','8928,38','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044147','','13/12/2019','60017,68','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044166','','04/10/2019','113243,23','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044167','','04/10/2019','79775,62','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044169','','13/09/2019','57357,71','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044171','','13/09/2019','39827,83','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044172','','31/10/2019','3134,99','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044174','','04/12/2019','101568,59','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044177','','11/10/2019','93861,11','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044178','','11/10/2019','8898,14','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044198','','25/10/2019','127801,48','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044202','','20/09/2019','35745,48','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044205','','06/09/2019','8197,76','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044216','','25/10/2019','14051,16','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044222','','04/12/2019','123467,34','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044228','','06/09/2019','115237,26','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044229','','11/10/2019','99746,48','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044231','','11/10/2019','37190,05','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044232','','11/10/2019','113504,31','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044261','','27/09/2019','71806,92','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044262','','27/09/2019','69934,11','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044264','','04/12/2019','54950,45','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044265','','27/09/2019','145454,6','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044272','','31/12/2019','48931,02','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044273','','13/12/2019','14397,24','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044274','','06/09/2019','52344,32','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044276','','18/10/2019','117604,39','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044287','','27/09/2019','66581,12','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044290','','06/09/2019','230390,22','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044299','','13/09/2019','124544,5','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044303','','31/12/2019','62529,47','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6044313','','20/09/2019','204391,92','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6084928','','06/09/2019','8091,61','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6084934','','25/10/2019','120935,45','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6084943','','06/09/2019','100785,49','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6084993','','27/09/2019','110730,12','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6084999','','11/10/2019','157376,13','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6085006','','25/10/2019','45289,9','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6128432','','11/10/2019','91105,56','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762164','','11/10/2019','48972,77','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762166','','06/09/2019','102422,89','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762170','','04/12/2019','38761,89','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762176','','08/11/2019','139349,75','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762178','','13/09/2019','27658,94','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762180','','13/09/2019','34617,91','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762183','','13/09/2019','35788,11','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762185','','13/09/2019','31190,75','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762186','','13/09/2019','26711,97','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762193','','13/09/2019','154867,34','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762195','','11/10/2019','289811,76','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762197','','13/09/2019','39880,9','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762201','','13/09/2019','59917,43','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762204','','20/09/2019','70965,14','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762205','','11/10/2019','70705,14','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762206','','13/09/2019','49406,73','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762213','','06/09/2019','399629,97','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762219','','13/09/2019','31397,05','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762229','','11/10/2019','74702,77','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762232','','13/09/2019','109727,02','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762234','','13/09/2019','115656,3','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762235','','13/09/2019','94417,94','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762236','','18/10/2019','49192,39','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762241','','31/10/2019','327742,06','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762246','','11/10/2019','115405,41','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762248','','18/10/2019','8655,8','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762250','','25/10/2019','38092,64','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762251','','08/11/2019','130607,31','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762253','','13/09/2019','5143,25','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762255','','11/10/2019','70051,85','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762270','','13/09/2019','29746,68','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762274','','11/10/2019','135974,97','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762280','','11/10/2019','58513,03','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762289','','20/09/2019','89833,17','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762294','','11/10/2019','30072,17','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762297','','27/09/2019','637741,21','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762298','','20/09/2019','107794,47','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762299','','27/09/2019','200240,83','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762300','','18/10/2019','7652,74','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762316','','13/09/2019','41511,11','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762321','','18/10/2019','192893,73','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762327','','18/10/2019','14407,47','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762329','','18/10/2019','41248,9','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762333','','31/12/2019','134381,23','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762338','','11/10/2019','83977,5','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762344','','11/10/2019','96926,68','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762347','','27/09/2019','39873,48','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762351','','25/10/2019','4882,8','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762352','','13/09/2019','10137,64','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762354','','27/09/2019','169108,91','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762359','','13/09/2019','30474','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762360','','04/10/2019','100591,18','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762365','','20/09/2019','265173,6','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762366','','18/10/2019','238655,2','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762374','','11/10/2019','60409,16','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762376','','15/07/2019','91836,29','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762382','','18/10/2019','64172,99','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762391','','11/10/2019','65601,38','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762393','','20/09/2019','77631,36','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762396','','11/10/2019','104891,54','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762397','','11/10/2019','51139,17','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762398','','06/09/2019','60285,62','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762403','','20/09/2019','101123,63','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6762405','','06/09/2019','97917,99','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6764557','','20/09/2019','134934,13','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6782713','','11/10/2019','52952,67','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6788173','','22/11/2019','817249,73','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6788176','','20/09/2019','117962,5','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6800129','','13/09/2019','58853,55','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6801267','','13/09/2019','45407,32','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6803449','','13/09/2019','31969,08','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6813894','','13/09/2019','63568,16','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6815904','','31/12/2019','145233,72','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6840017','','20/09/2019','103087,69','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('6950349','','11/10/2019','66469,9','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('7007131','','13/09/2019','195249,78','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('7007133','','11/10/2019','36077,18','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('7292507','','11/10/2019','293140,11','ARCO VALORACIONES', '03'),
			 T_TIPO_DATA('7292508','','10/10/2019','31647,03','ARCO VALORACIONES', '03')

		); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN	
	
    DBMS_OUTPUT.PUT_LINE('[INICIO] ');


    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
      LOOP
      
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
    	ACT_NUM_ACTIVO := TRIM(V_TMP_TIPO_DATA(1));
       	EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO INTO V_KOUNT;
  			  
		IF V_KOUNT > 0 THEN 
	  			  
			EXECUTE IMMEDIATE 'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO INTO ACT_ID;
			
			EXECUTE IMMEDIATE 'SELECT BIE_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO INTO BIE_ID;
			
			EXECUTE IMMEDIATE 'SELECT '||V_ESQUEMA||'.S_BIE_VALORACIONES.NEXTVAL FROM DUAL' INTO NUM_SECUENCIA_VAL;
			
			EXECUTE IMMEDIATE 'SELECT '||V_ESQUEMA||'.S_ACT_TAS_TASACION.NEXTVAL FROM DUAL' INTO NUM_SECUENCIA_TAS;
	
			V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_1||' (BIE_ID, BIE_VAL_ID, BIE_FECHA_VALOR_TASACION, FECHACREAR, 
			USUARIOCREAR, VERSION, BORRADO)
					  SELECT '''||BIE_ID||''', 
							 '''||NUM_SECUENCIA_VAL||''',
							 TO_DATE('''||TRIM(V_TMP_TIPO_DATA(3))||''', ''DD/MM/YYYY''),
							 SYSDATE,
							 '''||V_USUARIO||''',
							 0,
							 0
					  FROM DUAL';

			EXECUTE IMMEDIATE V_SQL;
			
			DBMS_OUTPUT.PUT_LINE('INSERTADO EL ACTIVO '||ACT_NUM_ACTIVO||' EN '||V_TABLA_1);
			
			V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_2||' (ACT_ID, BIE_VAL_ID, TAS_ID, DD_TTS_ID, TAS_NOMBRE_TASADOR, FECHACREAR, 
			USUARIOCREAR, VERSION, BORRADO, TAS_FECHA_INI_TASACION, TAS_IMPORTE_TAS_FIN)
					  SELECT '''||ACT_ID||''',
							 '''||NUM_SECUENCIA_VAL||''',
							 '''||NUM_SECUENCIA_TAS||''',
							 (SELECT DD_TTS_ID FROM '||V_ESQUEMA||'.DD_TTS_TIPO_TASACION WHERE DD_TTS_CODIGO = '''||TRIM(V_TMP_TIPO_DATA(6))||'''),
							 '''||TRIM(V_TMP_TIPO_DATA(5))||''',
							 SYSDATE,
							 '''||V_USUARIO||''',
							 0,
							 0,
							 TO_DATE('''||TRIM(V_TMP_TIPO_DATA(3))||''', ''DD/MM/YYYY''),
							 TO_NUMBER('''|| REPLACE( TRIM(V_TMP_TIPO_DATA(4)), ',', '.' )  ||''',''99999999.99'')
					  FROM DUAL';
			EXECUTE IMMEDIATE V_SQL;
			
			DBMS_OUTPUT.PUT_LINE('INSERTADO EL ACTIVO '||ACT_NUM_ACTIVO||' EN '||V_TABLA_2);
			
			V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
				
		ELSE
			
			DBMS_OUTPUT.PUT_LINE('[INFO] El activo '||ACT_NUM_ACTIVO||' no existe!');
			
		END IF;
		
      END LOOP;
    COMMIT;

    DBMS_OUTPUT.PUT_LINE('[INFO] Se han insertado en total '||V_COUNT_UPDATE||' registros en la tabla '||V_TABLA_1);
    DBMS_OUTPUT.PUT_LINE('[INFO] Se han insertado en total '||V_COUNT_UPDATE||' registros en la tabla '||V_TABLA_2);
   

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;
/
EXIT
