--/*
--#########################################
--## AUTOR=Viorel Remus Ovidiu
--## FECHA_CREACION=20200102
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6121
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	
    err_num NUMBER; -- Numero de error.
    err_msg VARCHAR2(2048); -- Mensaje de error.
    V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01'; -- Configuracion Esquemas.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER'; -- Configuracion Esquemas.
    V_USUARIOMODIFICAR VARCHAR(100 CHAR):= 'REMVIP-6121';
    V_SQL VARCHAR2(32000 CHAR);

BEGIN			
			
	DBMS_OUTPUT.PUT_LINE('[INICIO] Actualiza datos registrales ');			


	 V_SQL := 'MERGE INTO '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD T1
        USING (

		SELECT 
		GPV_ID
		FROM 	'||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR 
		WHERE 1 = 1
		AND BORRADO = 0
		AND GPV_NUM_GASTO_HAYA IN ( 11070871,
11070863,
11070864,
11071042,
11069804,
11069814,
11070052,
11070337,
11070362,
11070372,
11070723,
11070757,
11070798,
11070865,
11071043,
11069805,
11069815,
11070053,
11070338,
11070363,
11070373,
11070731,
11070758,
11070799,
11070866,
11070001,
11070742,
11070746,
11065565,
11071352,
11071385,
11072347,
11074351,
11074368,
11074386,
11065615,
11065619,
11065631,
11065636,
11065641,
11066009,
11066027,
11066032,
11066038,
11066042,
11066047,
11066052,
11066057,
11066285,
11066298,
11066303,
11066308,
11066331,
11066336,
11066341,
11066346,
11066351,
11066404,
11066409,
11066414,
11066419,
11066424,
11066429,
11066434,
11066439,
11066445,
11066450,
11066455,
11066461,
11066466,
11066471,
11066476,
11066481,
11066486,
11066491,
11070879,
11070884,
11070943,
11070948,
11071178,
11071191,
11071196,
11071201,
11071206,
11071211,
11071367,
11071410,
11071436,
11071448,
11071453,
11071460,
11071465,
11072302,
11072356,
11071044,
11069806,
11069816,
11070054,
11070339,
11070350,
11070374,
11070730,
11070759,
11070793,
11070867,
11071045,
11069807,
11069817,
11070055,
11070340,
11070351,
11070375,
11070724,
11070764,
11070794,
11070874,
11071046,
11069792,
11069818,
11070056,
11070341,
11070353,
11070376,
11070725,
11070760,
11070795,
11070875,
11070002,
11070743,
11070747,
11070751,
11065566,
11071353,
11071386,
11072342,
11074352,
11074369,
11074387,
11065616,
11065620,
11065632,
11065637,
11065642,
11066010,
11066028,
11066033,
11066039,
11066043,
11066048,
11066053,
11066058,
11066286,
11066299,
11066304,
11066309,
11066332,
11066337,
11066342,
11066347,
11066352,
11066405,
11066410,
11066415,
11066420,
11066425,
11066430,
11066435,
11066440,
11066446,
11066451,
11066456,
11066462,
11066467,
11066472,
11066477,
11066482,
11066487,
11066492,
11070880,
11070885,
11070944,
11070949,
11071179,
11071192,
11071197,
11071202,
11071207,
11071212,
11071368,
11071411,
11071437,
11071449,
11071454,
11071461,
11071466,
11072303,
11072357,
11071047,
11069793,
11069819,
11070057,
11070342,
11070354,
11070377,
11070726,
11070761,
11070796,
11070876,
11071048,
11069794,
11069820,
11070058,
11070343,
11070355,
11070378,
11070727,
11070762,
11070792,
11070877,
11071049,
11069795,
11069821,
11070059,
11070344,
11070356,
11070379,
11070728,
11070752,
11070790,
11070872,
11065567,
11071359,
11071387,
11072343,
11074346,
11074370,
11074388,
11065617,
11065621,
11065633,
11065638,
11065643,
11066011,
11066029,
11066034,
11066036,
11066044,
11066049,
11066054,
11066059,
11066287,
11066300,
11066305,
11066310,
11066333,
11066338,
11066343,
11066348,
11066353,
11066406,
11066411,
11066416,
11066421,
11066426,
11066431,
11066436,
11066441,
11066447,
11066452,
11066457,
11066463,
11066468,
11066473,
11066478,
11066483,
11066488,
11066493,
11070881,
11070886,
11070945,
11070950,
11071180,
11071193,
11071198,
11071203,
11071208,
11071213,
11071369,
11071412,
11071438,
11071450,
11071455,
11071462,
11071467,
11072304,
11072358,
11071050,
11069796,
11069822,
11070060,
11070345,
11070357,
11070380,
11070729,
11070753,
11070791,
11070873,
11071051,
11069797,
11069823,
11070061,
11070346,
11070358,
11070381,
11070732,
11070754,
11070800,
11070869,
11071052,
11069798,
11069824,
11070062,
11070347,
11070352,
11070382,
11070733,
11070766,
11070801,
11071161,
11074589,
11070445,
11070787,
11069879,
11069901,
11069907,
11070080,
11070088,
11070094,
11070424,
11070465,
11070785,
11070860,
11069871,
11069851,
11069877,
11069881,
11069883,
11070789,
11070112,
11069847,
11069869,
11070467,
11070834,
11069845,
11069849,
11069865,
11069867,
11069873,
11069875,
11069903,
11069905,
11069909,
11070090,
11070106,
11070108,
11070426,
11070431,
11070433,
11070435,
11070463,
11070828,
11070830,
11070832,
11070858,
11069857,
11070809,
11069895,
11070388,
11069891,
11070394,
11069893,
11070775,
11069827,
11069853,
11070777,
11070068,
11070420,
11070451,
11070453,
11070457,
11070769,
11070807,
11070110,
11070410,
11070429,
11070773,
11069831,
11069833,
11070070,
11070082,
11070084,
11070392,
11070396,
11070402,
11070414,
11070449,
11070850,
11070852,
11070418,
11069809,
11069835,
11070412,
11069837,
11070856,
11070822,
11070818,
11070811,
11070820,
11070838,
11069829,
11069859,
11069861,
11069887,
11069889,
11070096,
11070098,
11070102,
11070422,
11070771,
11070779,
11070824,
11069855,
11069885,
11070400,
11070455,
11070459,
11070461,
11070814,
11070816,
11070840,
11070848,
11069841,
11069843,
11069863,
11069897,
11069899,
11070074,
11070076,
11070078,
11070086,
11070390,
11070398,
11070416,
11070437,
11070441,
11070443,
11070781,
11070783,
11070826,
11070072,
11070100,
11070104,
11070854,
11069839,
11070836) 
        ) T2 
        ON (T1.GPV_ID = T2.GPV_ID )
	WHEN MATCHED THEN UPDATE
	SET T1.GIC_CUENTA_CONTABLE = ''6220000000'',
	    T1.GIC_PTDA_PRESUPUESTARIA = ''G011339'',
	    T1.USUARIOMODIFICAR = ''' || V_USUARIOMODIFICAR || ''',
	    T1.FECHAMODIFICAR   = SYSDATE

	';

	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Actualizados '||SQL%ROWCOUNT||' registros en GIC_GASTOS_INFO_CONTABILIDAD gastos anteriores a 2017');  


-----------------------------------------------------------------------------------------------------------------


 V_SQL := 'MERGE INTO '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD T1
        USING (

		SELECT 
		GPV_ID
		FROM 	'||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR 
		WHERE 1 = 1
		AND BORRADO = 0
		AND GPV_NUM_GASTO_HAYA IN (11012201,
11028242,
11030176,
11029588,
11030076,
11030098,
11030183,
11030185,
11030187,
11011620,
11012178,
11012190,
11033253,
11028939,
11028941,
11028948,
11028950,
11028952,
11032084,
11032092,
11032094,
11032985,
11034633,
11034639,
11009994,
11010003,
11010004,
11032204,
11028238,
11028239
) 

        ) T2 
        ON (T1.GPV_ID = T2.GPV_ID )
	WHEN MATCHED THEN UPDATE
	SET T1.GIC_CUENTA_CONTABLE = ''6220000000'',
	    T1.GIC_PTDA_PRESUPUESTARIA = ''G011309'',
	    T1.USUARIOMODIFICAR = ''' || V_USUARIOMODIFICAR || ''',
	    T1.FECHAMODIFICAR   = SYSDATE

	';

	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Actualizados '||SQL%ROWCOUNT||' registros en GIC_GASTOS_INFO_CONTABILIDAD gastos 2018-2019');  


	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN] Proceso realizado');
	

EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT
