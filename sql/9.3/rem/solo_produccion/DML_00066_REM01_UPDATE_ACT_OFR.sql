--/*
--##########################################
--## AUTOR=Adrián Molina
--## FECHA_CREACION=20200109
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-6146
--## PRODUCTO=NO
--##
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 
DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    V_NUM_FILAS NUMBER(16); -- Vble. para validar la existencia de un registro.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-6146T'; -- USUARIOCREAR/USUARIOMODIFICAR.
    V_ECO_ID NUMBER(16); 
    
    ACT_NUM_ACTIVO NUMBER(16);
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
		T_JBV(193394, 6948596, '32632,81'),
		T_JBV(193394, 6948609, '27052,86'),
		T_JBV(193394, 6948765, '31583,59'),
		T_JBV(193394, 6949505, '26695,94'),
		T_JBV(193394, 6948759, '25841,58'),
		T_JBV(193394, 6949375, '27293,91'),
		T_JBV(193394, 6949523, '27400,87'),
		T_JBV(193394, 6948774, '39592,16'),
		T_JBV(193394, 6948768, '2182,34'),
		T_JBV(193394, 6949377, '2182,34'),
		T_JBV(193394, 6949324, '2182,34'),
		T_JBV(193394, 6948619, '2574,81'),
		T_JBV(193394, 6948734, '2705,63'),
		T_JBV(193394, 6948493, '2182,34'),
		T_JBV(193394, 6949333, '2182,34'),
		T_JBV(193394, 6948657, '2182,34'),
		T_JBV(193394, 6949491, '2182,34'),
		T_JBV(193394, 6949772, '2182,34'),
		T_JBV(193394, 6948617, '2182,34'),
		T_JBV(193394, 6949451, '2182,34'),
		T_JBV(193394, 6948800, '2182,34'),
		T_JBV(193394, 6948797, '2182,34'),
		T_JBV(193394, 6949465, '2182,34'),
		T_JBV(193394, 6949551, '2182,34'),
		T_JBV(193394, 6949341, '2182,34'),
		T_JBV(193394, 6948661, '2182,34'),
		T_JBV(193394, 6949309, '2574,81'),
		T_JBV(193394, 6949325, '2443,99'),
		T_JBV(193394, 6949326, '3098,09'),
		T_JBV(193394, 6949742, '2705,63'),
		T_JBV(193394, 6949321, '2443,99'),
		T_JBV(193394, 6948470, '2182,34'),
		T_JBV(193394, 6949759, '2705,63'),
		T_JBV(193394, 6949761, '2182,34'),
		T_JBV(193394, 6949336, '2705,63'),
		T_JBV(193394, 6949363, '2182,34'),
		T_JBV(193394, 6948464, '2182,34'),
		T_JBV(193394, 6949340, '2182,34'),
		T_JBV(193394, 6949373, '2182,34'),
		T_JBV(193394, 6948626, '2182,34'),
		T_JBV(193394, 6949448, '2182,34'),
		T_JBV(193394, 6949454, '2182,34'),
		T_JBV(193394, 6948637, '2182,34'),
		T_JBV(193394, 6948460, '2182,34'),
		T_JBV(193394, 6949327, '2182,34'),
		T_JBV(193394, 6949493, '2182,34'),
		T_JBV(193394, 6949780, '2182,34'),
		T_JBV(193394, 6949752, '2182,34'),
		T_JBV(193394, 6948503, '2182,34'),
		T_JBV(193394, 6948595, '2182,34'),
		T_JBV(193394, 6948792, '2182,34'),
		T_JBV(193394, 6948773, '2182,34'),
		T_JBV(193394, 6948614, '2182,34'),
		T_JBV(193394, 6949342, '2182,34'),
		T_JBV(193394, 6948742, '2574,81'),
		T_JBV(193394, 6948649, '2967,27'),
		T_JBV(193394, 6949497, '2182,34'),
		T_JBV(193394, 6949484, '2182,34'),
		T_JBV(193394, 6949388, '2182,34'),
		T_JBV(193394, 6949347, '2182,34'),
		T_JBV(193394, 6948746, '2182,34'),
		T_JBV(193394, 6948599, '2182,34'),
		T_JBV(193394, 6949737, '2182,34'),
		T_JBV(193394, 6949365, '2574,81'),
		T_JBV(193394, 6949346, '2182,34'),
		T_JBV(193394, 6949344, '2574,81'),
		T_JBV(193394, 6948628, '2574,81'),
		T_JBV(193394, 6949370, '2182,34'),
		T_JBV(193394, 6949790, '2182,34'),
		T_JBV(193394, 6948455, '3883,01'),
		T_JBV(193394, 6949320, '2836,45'),
		T_JBV(193394, 6949352, '2182,34'),
		T_JBV(193394, 6949784, '2574,81'),
		T_JBV(193394, 6948505, '2574,81'),
		T_JBV(193394, 6948748, '2967,27'),
		T_JBV(193394, 6949483, '2836,45'),
		T_JBV(193394, 6948640, '0'),
		T_JBV(193394, 6949776, '2967,27'),
		T_JBV(193394, 6949750, '261,64'),
		T_JBV(193394, 6948669, '392,46'),
		T_JBV(193394, 6948675, '523,28'),
		T_JBV(193394, 6949357, '654,1'),
		T_JBV(193394, 6948821, '392,46'),
		T_JBV(193394, 6949521, '523,28'),
		T_JBV(193394, 6949296, '654,1'),
		T_JBV(193394, 6948833, '784,92'),
		T_JBV(193394, 6949745, '784,92'),
		T_JBV(193394, 6949785, '784,92')
	); 
	V_TMP_JBV T_JBV;
    
BEGIN	
	
	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
	V_TMP_JBV := V_JBV(I);
	
  	ACT_NUM_ACTIVO := TRIM(V_TMP_JBV(2));
	
	V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO;
	
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS;
	
	IF V_NUM_FILAS = 1 THEN
		V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_OFR 
							SET ACT_OFR_IMPORTE = '''||V_TMP_JBV(3)||'''
								,OFR_ACT_PORCEN_PARTICIPACION = 100 * ('''||V_TMP_JBV(3)||'''/ (SELECT OFR_IMPORTE FROM '||V_ESQUEMA||'.OFR_OFERTAS
									WHERE OFR_NUM_OFERTA = (SELECT OFR_NUM_OFERTA FROM '||V_ESQUEMA||'.OFR_OFERTAS WHERE OFR_ID = (SELECT OFR_ID FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL WHERE ECO_NUM_EXPEDIENTE = '||V_TMP_JBV(1)||'))))
 									WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||')
 									AND OFR_ID = (SELECT OFR_ID FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL WHERE ECO_NUM_EXPEDIENTE = '||V_TMP_JBV(1)||')';
	
		EXECUTE IMMEDIATE V_MSQL;
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO CON ACT_NUM_ACTIVO: '||ACT_NUM_ACTIVO||' ACTUALIZADO');
		
		V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
		
	ELSE
		
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO NO EXISTE');
		
	END IF;
	
	END LOOP;
		
	COMMIT;
	
	DBMS_OUTPUT.PUT_LINE('[FIN] Se han updateado en total '||V_COUNT_UPDATE||' registros');
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
