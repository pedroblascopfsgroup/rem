--/*
--###########################################
--## AUTOR=Carles Molins
--## FECHA_CREACION=20200108
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-5529
--## PRODUCTO=NO
--## 
--## Finalidad:
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE
	V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
	V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
	ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
	ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	
	V_ACT_ID NUMBER(16);
	V_ECO_ID NUMBER(16);
	V_IMP_ACT_OFERTA NUMBER(16,2);
	V_COUNT NUMBER(16);
	
	TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	V_JBV T_ARRAY_JBV := T_ARRAY_JBV( 
		--T_JBV(ID_Haya, Num_Expediente),
		T_JBV(6935947, 155869),
		T_JBV(7015800, 160894),
		T_JBV(7071690, 170593),
		T_JBV(6850741, 181274),
		T_JBV(6857013, 181318),
		T_JBV(6976525, 181276),
		T_JBV(6947769, 160034),
		T_JBV(6880554, 170419),
		T_JBV(6873835, 170417),
		T_JBV(6873699, 181086),
		T_JBV(6875729, 160025),
		T_JBV(6854209, 169268),
		T_JBV(6965662, 167114),
		T_JBV(6878848, 168012),
		T_JBV(6878215, 164918),
		T_JBV(7226869, 181920),
		T_JBV(7029985, 170038),
		T_JBV(7100915, 171675),
		T_JBV(6875205, 157737),
		T_JBV(6885083, 176793),
		T_JBV(6867697, 153112),
		T_JBV(6867698, 153112),
		T_JBV(6868082, 153112),
		T_JBV(6868163, 153112),
		T_JBV(6868164, 153112),
		T_JBV(6868165, 153112),
		T_JBV(6867432, 153112),
		T_JBV(6867379, 153112),
		T_JBV(6867380, 153112),
		T_JBV(6867381, 153112),
		T_JBV(6867331, 153112),
		T_JBV(6867332, 153112),
		T_JBV(6867333, 153112),
		T_JBV(6867242, 153112),
		T_JBV(6866845, 153112),
		T_JBV(6866846, 153112),
		T_JBV(6866847, 153112),
		T_JBV(6857205, 153108),
		T_JBV(6857206, 153108),
		T_JBV(6857207, 153108),
		T_JBV(6857771, 153108),
		T_JBV(6857772, 153108),
		T_JBV(6857773, 153108),
		T_JBV(6857774, 153108),
		T_JBV(6857775, 153108),
		T_JBV(6857776, 153108),
		T_JBV(6857741, 153108),
		T_JBV(6857743, 153108),
		T_JBV(6857744, 153108),
		T_JBV(6857745, 153108),
		T_JBV(6858124, 153108),
		T_JBV(6858125, 153108),
		T_JBV(6858126, 153108),
		T_JBV(6858128, 153108),
		T_JBV(6858129, 153108),
		T_JBV(6860168, 153108),
		T_JBV(6860169, 153108),
		T_JBV(6860170, 153108),
		T_JBV(6860171, 153108),
		T_JBV(6860173, 153108),
		T_JBV(6860174, 153108),
		T_JBV(6860175, 153108),
		T_JBV(6859744, 153108),
		T_JBV(6859746, 153108),
		T_JBV(6859650, 153108),
		T_JBV(6859651, 153108),
		T_JBV(6859652, 153108),
		T_JBV(6859653, 153108),
		T_JBV(6859655, 153108),
		T_JBV(6858437, 153108),
		T_JBV(6858438, 153108),
		T_JBV(6868154, 147512),
		T_JBV(6867690, 147512),
		T_JBV(6867041, 147512),
		T_JBV(6867053, 147512),
		T_JBV(6866414, 147512),
		T_JBV(6866415, 147512),
		T_JBV(6866531, 147512),
		T_JBV(6866532, 147512),
		T_JBV(6868055, 147512),
		T_JBV(6862527, 161890),
		T_JBV(7014368, 161890),
		T_JBV(7014376, 163185),
		T_JBV(6864994, 163185),
		T_JBV(7073152, 174709),
		T_JBV(7073153, 174709),
		T_JBV(7073159, 174709),
		T_JBV(7073161, 174709),
		T_JBV(7073164, 174709),
		T_JBV(7073165, 174709),
		T_JBV(7073167, 174709),
		T_JBV(7073168, 174709),
		T_JBV(6884987, 157134),
		T_JBV(7020149, 158728),
		T_JBV(7032217, 158728),
		T_JBV(7032214, 158728),
		T_JBV(6976494, 158728),
		T_JBV(6976503, 158728),
		T_JBV(6976504, 158728),
		T_JBV(6879340, 159793),
		T_JBV(6879802, 159793),
		T_JBV(6879805, 159793),
		T_JBV(6880645, 159793),
		T_JBV(6880160, 159793),
		T_JBV(6881088, 159793),
		T_JBV(6875999, 159723),
		T_JBV(6825220, 159723),
		T_JBV(6884288, 160038),
		T_JBV(6935759, 160038),
		T_JBV(7007725, 160038),
		T_JBV(7007733, 160038),
		T_JBV(6850205, 159944),
		T_JBV(6850102, 159944),
		T_JBV(6849621, 159944),
		T_JBV(6882197, 159932),
		T_JBV(6882805, 159932),
		T_JBV(6957052, 159932),
		T_JBV(6880935, 159932),
		T_JBV(6879905, 159945),
		T_JBV(6879287, 159945),
		T_JBV(6976507, 160045),
		T_JBV(6883501, 160045),
		T_JBV(6882850, 160045),
		T_JBV(6882077, 160045),
		T_JBV(6948976, 160045),
		T_JBV(7015786, 160045),
		T_JBV(7004785, 160045),
		T_JBV(6966715, 159941),
		T_JBV(6966644, 159941),
		T_JBV(6885418, 159962),
		T_JBV(6885543, 159962),
		T_JBV(6861969, 159874),
		T_JBV(6862904, 159874),
		T_JBV(6947864, 159952),
		T_JBV(6974073, 159952),
		T_JBV(6885327, 159952),
		T_JBV(6885283, 159952),
		T_JBV(6885286, 159952),
		T_JBV(6884614, 159952),
		T_JBV(6884620, 159952),
		T_JBV(7008844, 159952),
		T_JBV(7015803, 159952),
		T_JBV(7009388, 159952),
		T_JBV(6861608, 160096),
		T_JBV(6861118, 160096),
		T_JBV(6947788, 177291),
		T_JBV(6949786, 177291),
		T_JBV(6948616, 177294),
		T_JBV(6966668, 177294),
		T_JBV(6885493, 169691),
		T_JBV(6966509, 169691),
		T_JBV(7072582, 169665),
		T_JBV(7072589, 169665),
		T_JBV(7072592, 169665),
		T_JBV(6869674, 170423),
		T_JBV(6869676, 170423),
		T_JBV(6869678, 170423),
		T_JBV(6870111, 170423),
		T_JBV(6870191, 170423),
		T_JBV(6869954, 170423),
		T_JBV(6870912, 170423),
		T_JBV(6870913, 170423),
		T_JBV(6870914, 170423),
		T_JBV(6870654, 170423),
		T_JBV(7031396, 170527),
		T_JBV(7068165, 170527),
		T_JBV(7005843, 170527),
		T_JBV(7005072, 170474),
		T_JBV(6938672, 170474),
		T_JBV(7030359, 170533),
		T_JBV(7072902, 170533),
		T_JBV(6935222, 170503),
		T_JBV(7074589, 170503),
		T_JBV(7074355, 170510),
		T_JBV(7072728, 170510),
		T_JBV(7068340, 170529),
		T_JBV(7068357, 170529),
		T_JBV(7068372, 170529),
		T_JBV(7068377, 170529),
		T_JBV(7068378, 170529),
		T_JBV(7068454, 170529),
		T_JBV(7068458, 170529),
		T_JBV(7068465, 170529),
		T_JBV(7068470, 170529),
		T_JBV(7068385, 170529),
		T_JBV(7068401, 170529),
		T_JBV(7068407, 170529),
		T_JBV(7068409, 170529),
		T_JBV(6881281, 178212),
		T_JBV(6880681, 178212),
		T_JBV(6880615, 178212),
		T_JBV(7018712, 180753),
		T_JBV(6855242, 180753),
		T_JBV(6979140, 180753),
		T_JBV(7009806, 180841),
		T_JBV(7071260, 180841),
		T_JBV(7072820, 180841),
		T_JBV(6949109, 180865),
		T_JBV(6949379, 180865),
		T_JBV(6948621, 180865),
		T_JBV(6949664, 180865),
		T_JBV(6949698, 180865),
		T_JBV(6949720, 180865),
		T_JBV(6949721, 180865),
		T_JBV(6949724, 180865),
		T_JBV(6949726, 180865),
		T_JBV(6949728, 180865),
		T_JBV(6949730, 180865),
		T_JBV(6949746, 180865),
		T_JBV(6949749, 180865),
		T_JBV(6949755, 180865),
		T_JBV(6949766, 180865),
		T_JBV(6949443, 180865),
		T_JBV(6949306, 180865),
		T_JBV(6949308, 180865),
		T_JBV(6949316, 180865),
		T_JBV(6949293, 180865),
		T_JBV(6949477, 180865),
		T_JBV(6949479, 180865),
		T_JBV(6949486, 180865),
		T_JBV(6949492, 180865),
		T_JBV(6949494, 180865),
		T_JBV(6949499, 180865),
		T_JBV(6949082, 180865),
		T_JBV(6949084, 180865),
		T_JBV(6949095, 180865),
		T_JBV(6949031, 180865),
		T_JBV(6949048, 180865),
		T_JBV(6949051, 180865),
		T_JBV(6949063, 180865),
		T_JBV(6949073, 180865),
		T_JBV(6948685, 180865),
		T_JBV(6948686, 180865),
		T_JBV(6948688, 180865),
		T_JBV(6948694, 180865),
		T_JBV(6948697, 180865),
		T_JBV(6948698, 180865),
		T_JBV(6948653, 180865),
		T_JBV(6948656, 180865),
		T_JBV(6948667, 180865),
		T_JBV(6948676, 180865),
		T_JBV(6948677, 180865),
		T_JBV(6948702, 180865),
		T_JBV(6948706, 180865),
		T_JBV(6948570, 180865),
		T_JBV(6948571, 180865),
		T_JBV(6948572, 180865),
		T_JBV(6948577, 180865),
		T_JBV(6948583, 180865),
		T_JBV(6948597, 180865),
		T_JBV(6948604, 180865),
		T_JBV(6948615, 180865),
		T_JBV(6948546, 180865),
		T_JBV(6948395, 180865),
		T_JBV(6948403, 180865),
		T_JBV(6948410, 180865),
		T_JBV(6948411, 180865),
		T_JBV(6948422, 180865),
		T_JBV(6948423, 180865),
		T_JBV(6948444, 180865),
		T_JBV(6948447, 180865),
		T_JBV(6948448, 180865),
		T_JBV(6948450, 180865),
		T_JBV(6948479, 180865),
		T_JBV(6948488, 180865),
		T_JBV(7071678, 180727),
		T_JBV(6935592, 180775),
		T_JBV(6935594, 180775),
		T_JBV(6935635, 180775),
		T_JBV(7031847, 181103),
		T_JBV(7071138, 181103),
		T_JBV(7225622, 181103),
		T_JBV(7225637, 181103),
		T_JBV(7224496, 181084),
		T_JBV(6957147, 181084),
		T_JBV(6885595, 181112),
		T_JBV(7072959, 181112),
		T_JBV(7072841, 181112),
		T_JBV(7072855, 181118),
		T_JBV(7076186, 181118),
		T_JBV(6973835, 181169),
		T_JBV(6973852, 181169),
		T_JBV(6884921, 181178),
		T_JBV(6884461, 181178),
		T_JBV(6875835, 181186),
		T_JBV(6825256, 181186),
		T_JBV(6860481, 181949),
		T_JBV(6861287, 181949),
		T_JBV(6860486, 181949),
		T_JBV(6861982, 181949),
		T_JBV(6861292, 180823),
		T_JBV(6861293, 180823),
		T_JBV(6861286, 180823),
		T_JBV(6861086, 180823),
		T_JBV(6861980, 180823),
		T_JBV(6861981, 180823),
		T_JBV(6860485, 180823),
		T_JBV(6859739, 180823),
		T_JBV(6859791, 180823),
		T_JBV(6859800, 180823),
		T_JBV(6849738, 180772),
		T_JBV(6849740, 180772),
		T_JBV(6866659, 180798),
		T_JBV(6867224, 180798),
		T_JBV(6867065, 180798),
		T_JBV(6868656, 180798),
		T_JBV(6862017, 181842),
		T_JBV(6862025, 181842),
		T_JBV(6861090, 181842),
		T_JBV(6859798, 181842),
		T_JBV(6861083, 181842),
		T_JBV(6860358, 181843),
		T_JBV(6860359, 181843),
		T_JBV(6859732, 181843),
		T_JBV(6859733, 181843),
		T_JBV(6859734, 181843),
		T_JBV(6859735, 181843),
		T_JBV(6860335, 181843),
		T_JBV(6861896, 181843),
		T_JBV(6861285, 181843),
		T_JBV(6861288, 181844),
		T_JBV(6861897, 181844),
		T_JBV(6862018, 181844),
		T_JBV(6860336, 181844),
		T_JBV(6859799, 181844),
		T_JBV(6859736, 181844),
		T_JBV(6861084, 181844),
		T_JBV(6861085, 181844),
		T_JBV(6861050, 181844),
		T_JBV(6859737, 181823),
		T_JBV(6860480, 181823),
		T_JBV(6860483, 181823),
		T_JBV(6860484, 181823),
		T_JBV(6862020, 181823),
		T_JBV(6861291, 181823),
		T_JBV(6861088, 181823),
		T_JBV(6861294, 181823),
		T_JBV(6862038, 181823),
		T_JBV(6862039, 181825),
		T_JBV(6862040, 181825),
		T_JBV(6861295, 181825),
		T_JBV(6862021, 181825),
		T_JBV(6862022, 181825),
		T_JBV(6862023, 181825),
		T_JBV(6861983, 181825),
		T_JBV(6861984, 181825),
		T_JBV(6861052, 181825),
		T_JBV(6861053, 181832),
		T_JBV(6861054, 181832),
		T_JBV(6860487, 181832),
		T_JBV(6861091, 181832),
		T_JBV(6859740, 181832),
		T_JBV(6862024, 181832),
		T_JBV(6861296, 181832),
		T_JBV(6861089, 181832),
		T_JBV(6862041, 181832)
	); 
	V_TMP_JBV T_JBV;

BEGIN
	
	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	
	V_COUNT := 0;
	
	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	LOOP
 
		V_TMP_JBV := V_JBV(I);
		
		V_MSQL := 'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||TRIM(V_TMP_JBV(1));
		EXECUTE IMMEDIATE V_MSQL INTO V_ACT_ID;
		
		V_MSQL := 'SELECT ECO_ID FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL WHERE ECO_NUM_EXPEDIENTE = '||TRIM(V_TMP_JBV(2));
		EXECUTE IMMEDIATE V_MSQL INTO V_ECO_ID;
		
		V_MSQL := 'SELECT IMP_ACT_OFERTA FROM '||V_ESQUEMA||'.V_LISTADO_ACT_EXP WHERE ACT_ID = '||V_ACT_ID||' AND ECO_ID = '||V_ECO_ID;
		EXECUTE IMMEDIATE V_MSQL INTO V_IMP_ACT_OFERTA;
		
		-- CUSTODIO
		
		V_MSQL := 'UPDATE REM01.GEX_GASTOS_EXPEDIENTE 
				    SET GEX_IMPORTE_CALCULO = 0.2
				        ,GEX_IMPORTE_FINAL = (0.002 * '||V_IMP_ACT_OFERTA||')
				        ,GEX_EDITADO = 1
				        ,USUARIOMODIFICAR = ''REMVIP-5529''
				        ,FECHAMODIFICAR = SYSDATE
					WHERE ACT_ID = '||V_ACT_ID||'
					AND ECO_ID = '||V_ECO_ID||'
					AND DD_ACC_ID = 5
					';
		EXECUTE IMMEDIATE V_MSQL;
		
		V_COUNT := V_COUNT + 1;
	
	END LOOP;

	DBMS_OUTPUT.PUT_LINE('	[INFO] '||V_COUNT||' registros Custodio actualizados');

	COMMIT;
	DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION

	WHEN OTHERS THEN
		ERR_NUM := SQLCODE;
		ERR_MSG := SQLERRM;

		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
		DBMS_OUTPUT.put_line(err_msg);

		ROLLBACK;
		RAISE;          

END;
/
EXIT
