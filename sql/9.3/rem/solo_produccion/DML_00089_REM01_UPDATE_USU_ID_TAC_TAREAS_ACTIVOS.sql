--/*
--##########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20200130
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6314
--## PRODUCTO=NO
--##
--## Finalidad:  
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 
DECLARE

    PL_OUTPUT VARCHAR2(32000 CHAR);
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    V_NUM_FILAS_1 NUMBER(16); -- Vble. para validar la existencia de un registro.
    V_NUM_FILAS_2 NUMBER(16); -- Vble. para validar la existencia de un registro.
    V_NUM_FILAS_3 NUMBER(16); -- Vble. para validar la existencia de un registro.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-6314'; -- USUARIOCREAR/USUARIOMODIFICAR. 
    
    TAR_ID NUMBER(16);
    USU_ID NUMBER(16);
    V_COUNT_UPDATE_1 NUMBER(16):= 0; -- Vble. para contar updates
    
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	-- TAR_ID, USU_ID 

	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
				T_JBV(4917911,29642),
				T_JBV(4917875,29642),
				T_JBV(4917483,29642),
				T_JBV(4917425,29642),
				T_JBV(4917334,29642),
				T_JBV(4917288,29642),
				T_JBV(4917263,29642),
				T_JBV(4917176,29642),
				T_JBV(4917114,29642),
				T_JBV(4916999,29642),
				T_JBV(4916876,29642),
				T_JBV(4916848,29642),
				T_JBV(4916822,29642),
				T_JBV(4916761,29642),
				T_JBV(4916678,29642),
				T_JBV(4916614,29642),
				T_JBV(4916553,29642),
				T_JBV(4916542,29642),
				T_JBV(4916536,29642),
				T_JBV(4916532,29642),
				T_JBV(4916527,29642),
				T_JBV(4916521,29642),
				T_JBV(4916497,29642),
				T_JBV(4916467,29642),
				T_JBV(4916444,29642),
				T_JBV(4916393,29642),
				T_JBV(4916378,29642),
				T_JBV(4916291,29642),
				T_JBV(4912691,29642),
				T_JBV(4912624,29642),
				T_JBV(4912545,29642),
				T_JBV(4912488,29642),
				T_JBV(4910734,86356),
				T_JBV(4910310,86356),
				T_JBV(4910281,86356),
				T_JBV(4908420,86356),
				T_JBV(4908324,86356),
				T_JBV(4907611,86356),
				T_JBV(4907598,86356),
				T_JBV(4907577,86356),
				T_JBV(4907378,86356),
				T_JBV(4907324,86356),
				T_JBV(4907230,86356),
				T_JBV(4907173,86356),
				T_JBV(4907167,86356),
				T_JBV(4907157,86356),
				T_JBV(4907150,86356),
				T_JBV(4907138,86356),
				T_JBV(4907127,86356),
				T_JBV(4907118,86356),
				T_JBV(4907113,86356),
				T_JBV(4907103,86356),
				T_JBV(4907095,86356),
				T_JBV(4907083,86356),
				T_JBV(4907071,86356),
				T_JBV(4907053,86356),
				T_JBV(4907009,86356),
				T_JBV(4907006,86356),
				T_JBV(4906994,86356),
				T_JBV(4906992,86356),
				T_JBV(4906974,86356),
				T_JBV(4906947,86356),
				T_JBV(4906820,86356),
				T_JBV(4906686,86356),
				T_JBV(4906545,86356),
				T_JBV(4906287,86356),
				T_JBV(4906267,86356),
				T_JBV(4906235,86356),
				T_JBV(4905890,86356),
				T_JBV(4904980,86356),
				T_JBV(4904979,86356),
				T_JBV(4904978,86356),
				T_JBV(4904977,86356),
				T_JBV(4904976,86356),
				T_JBV(4904974,86356),
				T_JBV(4904973,86356),
				T_JBV(4904972,86356),
				T_JBV(4904971,86356),
				T_JBV(4904961,86356),
				T_JBV(4904957,86356),
				T_JBV(4904943,86356),
				T_JBV(4904936,86356),
				T_JBV(4904928,86356),
				T_JBV(4904884,86356),
				T_JBV(4904882,86356),
				T_JBV(4904880,86356),
				T_JBV(4904878,86356),
				T_JBV(4904876,86356),
				T_JBV(4904875,86356),
				T_JBV(4904873,86356),
				T_JBV(4904872,86356),
				T_JBV(4904870,86356),
				T_JBV(4904869,86356),
				T_JBV(4904867,86356),
				T_JBV(4904866,86356),
				T_JBV(4904865,86356),
				T_JBV(4904864,86356),
				T_JBV(4904863,86356),
				T_JBV(4904862,86356),
				T_JBV(4904861,86356),
				T_JBV(4904859,86356),
				T_JBV(4904858,86356),
				T_JBV(4904856,86356),
				T_JBV(4904854,86356),
				T_JBV(4904850,86356),
				T_JBV(4904848,86356),
				T_JBV(4904847,86356),
				T_JBV(4904846,86356),
				T_JBV(4904845,86356),
				T_JBV(4904844,86356),
				T_JBV(4904832,86356),
				T_JBV(4904831,86356),
				T_JBV(4904830,86356),
				T_JBV(4904829,86356),
				T_JBV(4904828,86356),
				T_JBV(4904827,86356),
				T_JBV(4904825,86356),
				T_JBV(4904823,86356),
				T_JBV(4904822,86356),
				T_JBV(4904820,86356),
				T_JBV(4904818,86356),
				T_JBV(4904817,86356),
				T_JBV(4904815,86356),
				T_JBV(4904813,86356),
				T_JBV(4904803,86356),
				T_JBV(4904792,86356),
				T_JBV(4904789,86356),
				T_JBV(4904788,86356),
				T_JBV(4904787,86356),
				T_JBV(4904786,86356),
				T_JBV(4904785,86356),
				T_JBV(4904784,86356),
				T_JBV(4904783,86356),
				T_JBV(4904782,86356),
				T_JBV(4904781,86356),
				T_JBV(4904780,86356),
				T_JBV(4904779,86356),
				T_JBV(4904778,86356),
				T_JBV(4904777,86356),
				T_JBV(4904776,86356),
				T_JBV(4904775,86356),
				T_JBV(4904774,86356),
				T_JBV(4904773,86356),
				T_JBV(4904772,86356),
				T_JBV(4904771,86356),
				T_JBV(4904770,86356),
				T_JBV(4904769,86356),
				T_JBV(4904768,86356),
				T_JBV(4904767,86356),
				T_JBV(4904766,86356),
				T_JBV(4904765,86356),
				T_JBV(4904764,86356),
				T_JBV(4904762,86356),
				T_JBV(4904760,86356),
				T_JBV(4904759,86356),
				T_JBV(4904758,86356),
				T_JBV(4904757,86356),
				T_JBV(4904756,86356),
				T_JBV(4904755,86356),
				T_JBV(4904754,86356),
				T_JBV(4904753,86356),
				T_JBV(4904752,86356),
				T_JBV(4904751,86356),
				T_JBV(4904750,86356),
				T_JBV(4904749,86356),
				T_JBV(4904748,86356),
				T_JBV(4904747,86356),
				T_JBV(4904746,86356),
				T_JBV(4904745,86356),
				T_JBV(4904744,86356),
				T_JBV(4904743,86356),
				T_JBV(4904219,86356),
				T_JBV(4904218,86356),
				T_JBV(4904217,86356),
				T_JBV(4904216,86356),
				T_JBV(4904209,86356),
				T_JBV(4904203,86356),
				T_JBV(4903935,86356),
				T_JBV(4903875,86356),
				T_JBV(4903824,86356),
				T_JBV(4903682,86356),
				T_JBV(4903661,86356),
				T_JBV(4903648,86356),
				T_JBV(4903643,86356),
				T_JBV(4903638,86356),
				T_JBV(4903634,86356),
				T_JBV(4903626,86356),
				T_JBV(4903609,86356),
				T_JBV(4903587,86356),
				T_JBV(4903573,86356),
				T_JBV(4903561,86356),
				T_JBV(4903547,86356),
				T_JBV(4903541,86356),
				T_JBV(4903523,86356),
				T_JBV(4903521,86356),
				T_JBV(4903504,86356),
				T_JBV(4903498,86356),
				T_JBV(4903490,86356),
				T_JBV(4903479,86356),
				T_JBV(4903462,86356),
				T_JBV(4903457,86356),
				T_JBV(4903441,86356),
				T_JBV(4903397,86356),
				T_JBV(4903366,86356),
				T_JBV(4903340,86356),
				T_JBV(4903324,86356),
				T_JBV(4903287,86356),
				T_JBV(4903229,86356),
				T_JBV(4903192,86356),
				T_JBV(4902994,86356),
				T_JBV(4902961,86356),
				T_JBV(4902936,86356),
				T_JBV(4902916,86356),
				T_JBV(4902910,86356),
				T_JBV(4902877,86356),
				T_JBV(4902833,86356),
				T_JBV(4902829,86356),
				T_JBV(4902798,86356),
				T_JBV(4902783,86356),
				T_JBV(4902764,86356),
				T_JBV(4902749,86356),
				T_JBV(4902740,86356),
				T_JBV(4902736,86356),
				T_JBV(4902716,86356),
				T_JBV(4902698,86356),
				T_JBV(4902627,86356),
				T_JBV(4902131,86356),
				T_JBV(4900562,86356),
				T_JBV(4900523,86356),
				T_JBV(4900376,86356),
				T_JBV(4900216,86356),
				T_JBV(4900102,86356),
				T_JBV(4900099,86356),
				T_JBV(4900098,86356),
				T_JBV(4900094,86356),
				T_JBV(4900089,86356),
				T_JBV(4899990,86356),
				T_JBV(4898823,86356),
				T_JBV(4898806,86356),
				T_JBV(4898798,86356),
				T_JBV(4898787,86356),
				T_JBV(4898771,86356),
				T_JBV(4898759,86356)

				); 
	V_TMP_JBV T_JBV;
    
BEGIN	
	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	
	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
	V_TMP_JBV := V_JBV(I);
  	
  	TAR_ID := TRIM(V_TMP_JBV(1));

	USU_ID := TRIM(V_TMP_JBV(2));

	V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TAR_ID = '||TAR_ID;
	
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS_1;
	
	IF V_NUM_FILAS_1 > 0 THEN
	
		V_MSQL := 'UPDATE '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS 
               		   SET USU_ID = '||USU_ID||', 
                    	   USUARIOMODIFICAR = ''REMVIP-6314'', 
                    	   FECHAMODIFICAR = SYSDATE 
		           WHERE TAR_ID = '||TAR_ID;

	
		EXECUTE IMMEDIATE V_MSQL;
    
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO CON TAR_ID: '||TAR_ID||' ACTUALIZADO');
		
		V_COUNT_UPDATE_1 := V_COUNT_UPDATE_1 + 1;
		
	ELSE
		
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO NO EXISTE');
		
	END IF;
	
	END LOOP;

	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN] Se han updateado en total '||V_COUNT_UPDATE_1||' registros EN TAC_TAREAS_ACTIVOS');

	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN]');
	
	COMMIT;
	
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
