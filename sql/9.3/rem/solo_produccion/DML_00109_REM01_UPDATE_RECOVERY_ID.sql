--/*
--##########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20200213
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6373
--## PRODUCTO=NO
--##
--## Finalidad:  
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 
DECLARE

    PL_OUTPUT VARCHAR2(32000 CHAR);
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    V_NUM_FILAS_1 NUMBER(16); -- Vble. para validar la existencia de un registro.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-6373'; -- USUARIOCREAR/USUARIOMODIFICAR. 
    
    ACT_NUM NUMBER(16);
    RECOVERY_ID NUMBER(16);
    V_COUNT_UPDATE_1 NUMBER(16):= 0; -- Vble. para contar updates
    
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	-- TAR_ID, USU_ID 

	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
				T_JBV(6966144,100315909),
				T_JBV(6978799,100333009),
				T_JBV(6785769,100321389),
				T_JBV(6079110,100414361),
				T_JBV(7224429,100359309),
				T_JBV(7228642,100335720),
				T_JBV(7101748,100384282),
				T_JBV(7228647,100322629),
				T_JBV(7101684,100333424),
				T_JBV(7228630,100386978),
				T_JBV(7228649,100366000),
				T_JBV(7228632,100356942),
				T_JBV(7101722,100336020),
				T_JBV(7228634,100322123),
				T_JBV(7228637,100393378),
				T_JBV(7101675,100382541),
				T_JBV(7228651,100373987),
				T_JBV(7228648,100325824),
				T_JBV(7228650,100353488),
				T_JBV(7228645,100355382),
				T_JBV(7228644,100372941),
				T_JBV(7228635,100329787),
				T_JBV(7101746,100352036),
				T_JBV(7101743,100331908),
				T_JBV(7228646,100318222),
				T_JBV(7228639,100320045),
				T_JBV(7101733,100325253),
				T_JBV(7228640,100346864),
				T_JBV(7228636,100325645),
				T_JBV(7101670,100315157),
				T_JBV(7228631,100343573),
				T_JBV(7228641,100344511),
				T_JBV(7101668,100368139),
				T_JBV(7101688,100361449),
				T_JBV(6950475,100326784),
				T_JBV(6780717,100374618),
				T_JBV(6942533,100411040),
				T_JBV(6942549,100409296),
				T_JBV(7075615,100372344),
				T_JBV(7071398,100321300),
				T_JBV(7030549,100390737),
				T_JBV(6891601,100365430),
				T_JBV(6890920,100320822),
				T_JBV(6890939,100366577),
				T_JBV(6934184,100398148),
				T_JBV(6891930,100352021),
				T_JBV(6890886,100337950),
				T_JBV(7017042,100404336),
				T_JBV(6890880,100315763),
				T_JBV(7007843,100347631),
				T_JBV(6890941,100373022),
				T_JBV(6890921,100397590),
				T_JBV(6890943,100328905),
				T_JBV(6890879,100369690),
				T_JBV(6890899,100391096),
				T_JBV(6890944,100370764),
				T_JBV(6890878,100342463),
				T_JBV(6890898,100339933),
				T_JBV(6890916,100360114),
				T_JBV(6890918,100371740),
				T_JBV(7017045,100404506),
				T_JBV(6890915,100392375),
				T_JBV(7029357,100384196),
				T_JBV(6890930,100359310),
				T_JBV(6890940,100400786),
				T_JBV(6890932,100371571),
				T_JBV(7007838,100343613),
				T_JBV(6890931,100364875),
				T_JBV(6890913,100358371),
				T_JBV(6891052,100372650),
				T_JBV(6890912,100361655),
				T_JBV(6891049,100319865),
				T_JBV(7007845,100370043),
				T_JBV(7014825,100398901),
				T_JBV(6827448,100391616),
				T_JBV(6886462,100337330),
				T_JBV(7014575,100363663),
				T_JBV(6844274,100371930),
				T_JBV(6973688,100414149),
				T_JBV(6959548,100327723),
				T_JBV(6973071,100382277),
				T_JBV(6937591,100345814),
				T_JBV(6959539,100378476),
				T_JBV(6745041,100376934),
				T_JBV(6934431,100338272),
				T_JBV(6744940,100425369),
				T_JBV(6745249,100367217),
				T_JBV(6741340,100403148),
				T_JBV(6084718,100334397),
				T_JBV(6084757,100385682),
				T_JBV(6738171,100409438),
				T_JBV(6084744,100344156),
				T_JBV(6732400,100429709),
				T_JBV(6084752,100320048),
				T_JBV(6084762,100393572),
				T_JBV(6084750,100365666),
				T_JBV(6084747,100390086),
				T_JBV(6711311,100385958),
				T_JBV(6084763,100396007),
				T_JBV(6084759,100393538),
				T_JBV(6084751,100378607),
				T_JBV(6084758,100398641),
				T_JBV(6080672,100325140),
				T_JBV(6075828,100390050),
				T_JBV(6075826,100335008),
				T_JBV(6075876,100341858),
				T_JBV(6711033,100369915),
				T_JBV(6075859,100316576),
				T_JBV(6075829,100367896),
				T_JBV(6075877,100400693),
				T_JBV(6075754,100327222),
				T_JBV(6075863,100375761),
				T_JBV(6732046,100328889),
				T_JBV(6075858,100350714),
				T_JBV(6075873,100355817),
				T_JBV(6075753,100357930),
				T_JBV(6075878,100322013),
				T_JBV(6075856,100384344),
				T_JBV(6075857,100389482),
				T_JBV(6075861,100347625),
				T_JBV(6075862,100345538),
				T_JBV(6075860,100343921),
				T_JBV(6075824,100361257),
				T_JBV(6075874,100316040),
				T_JBV(6075825,100370420),
				T_JBV(6714853,100368233),
				T_JBV(6081248,100394303),
				T_JBV(6076408,100338448),
				T_JBV(6726084,100353924),
				T_JBV(6136650,100319204),
				T_JBV(6827951,100350944),
				T_JBV(6827907,100325320),
				T_JBV(6525036,100354857),
				T_JBV(6781603,100342821),
				T_JBV(6077041,100389857),
				T_JBV(6780914,100323398),
				T_JBV(6780642,100375772),
				T_JBV(6136791,100345037),
				T_JBV(6819186,100375813),
				T_JBV(6082277,100319947),
				T_JBV(6135592,100320971),
				T_JBV(6134774,100411335),
				T_JBV(6135899,100413209),
				T_JBV(6082564,100350532),
				T_JBV(6082671,100353859),
				T_JBV(6133771,100408384),
				T_JBV(6077664,100369174),
				T_JBV(6134232,100405863),
				T_JBV(6135703,100394196),
				T_JBV(6136504,100362715),
				T_JBV(6811723,100318412),
				T_JBV(6082866,100405813),
				T_JBV(6077831,100405970),
				T_JBV(6077890,100351385),
				T_JBV(6077892,100331374),
				T_JBV(6077893,100368040),
				T_JBV(6078254,100417910),
				T_JBV(6077891,100404623),
				T_JBV(6082867,100405908),
				T_JBV(6083183,100386837),
				T_JBV(6083181,100373681),
				T_JBV(6083187,100323610),
				T_JBV(6083138,100369277),
				T_JBV(6078567,100402842),
				T_JBV(6083335,100362755),
				T_JBV(6083245,100340061),
				T_JBV(6083334,100374374),
				T_JBV(6785794,100399965),
				T_JBV(6084017,100417290),
				T_JBV(6079369,100404810),
				T_JBV(6079377,100405499),
				T_JBV(6031931,100413676),
				T_JBV(6079419,100395482),
				T_JBV(6036918,100408841)
				); 
	V_TMP_JBV T_JBV;
    
BEGIN	
	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	
	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
	V_TMP_JBV := V_JBV(I);
  	
  	ACT_NUM := TRIM(V_TMP_JBV(1));

	RECOVERY_ID := TRIM(V_TMP_JBV(2));

	V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM;
	
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS_1;
	
	IF V_NUM_FILAS_1 > 0 THEN
	
		V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_ACTIVO 
               		   SET ACT_RECOVERY_ID = '||RECOVERY_ID||', 
                    	   USUARIOMODIFICAR = ''REMVIP-6373'', 
                    	   FECHAMODIFICAR = SYSDATE 
		           WHERE ACT_NUM_ACTIVO = '||ACT_NUM;

		EXECUTE IMMEDIATE V_MSQL;
    
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO CON ACT_NUM_ACTIVO: '||ACT_NUM||' ACTUALIZADO');
		
		V_COUNT_UPDATE_1 := V_COUNT_UPDATE_1 + 1;
		
	ELSE
		
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO NO EXISTE');
		
	END IF;
	
	END LOOP;

	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN] Se han updateado en total '||V_COUNT_UPDATE_1||' registros EN ACT_ACTIVO');
	
	COMMIT;
	
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
