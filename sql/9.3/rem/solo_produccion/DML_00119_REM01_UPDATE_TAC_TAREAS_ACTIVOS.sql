--/*
--##########################################
--## AUTOR=Adrián Molina Garrido
--## FECHA_CREACION=20200411
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6938
--## PRODUCTO=NO
--##
--## Finalidad:
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

    V_TABLA VARCHAR2(30 CHAR) := 'TAC_TAREAS_ACTIVOS';  -- Tabla a modificar
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-6938'; -- USUARIOCREAR/USUARIOMODIFICAR

BEGIN

		DBMS_OUTPUT.PUT_LINE('[INICIO]');

        V_MSQL :=   'MERGE INTO REM01.TAC_TAREAS_ACTIVOS T1
                     USING (
                         SELECT DISTINCT TAC.TAR_ID, GES.USU_ID AS HAYAGBOINM
                         FROM REM01.ECO_EXPEDIENTE_COMERCIAL ECO
                         JOIN REM01.ACT_OFR AO ON AO.OFR_ID = ECO.OFR_ID
                         JOIN REM01.ACT_TRA_TRAMITE TRA ON TRA.TBJ_ID = ECO.TBJ_ID
                         JOIN REM01.TAC_TAREAS_ACTIVOS TAC ON TAC.TRA_ID = TRA.TRA_ID
                         JOIN REM01.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
                         LEFT JOIN REMMASTER.USU_USUARIOS USU ON USU.USU_ID = TAC.USU_ID
                         JOIN REM01.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
                         JOIN REM01.ACT_ACTIVO ACT ON TAC.ACT_ID = ACT.ACT_ID
                         JOIN REM01.GAH_GESTOR_ACTIVO_HISTORICO GAH ON ACT.ACT_ID = GAH.ACT_ID
                         JOIN REM01.GEH_GESTOR_ENTIDAD_HIST GEH ON GAH.GEH_ID = GEH.GEH_ID AND GEH.DD_TGE_ID = 441
                         LEFT JOIN REM01.GEH_GESTOR_ENTIDAD_HIST GES ON GES.USU_ID = GEH.USU_ID
                         WHERE TEX.BORRADO = 0 AND USU.USU_ID IS NULL AND TAP.TAP_CODIGO = ''T017_RespuestaOfertanteCES''
                         AND ECO.ECO_NUM_EXPEDIENTE IN (
                         201501,
                         201542,
                         201545,
                         201547,
                         201548,
                         201560,
                         201563,
                         201603,
                         201874,
                         202064,
                         202109,
                         202822,
                         203248,
                         203375,
                         203567,
                         203596,
                         203638,
                         203923,
                         204013,
                         204160,
                         204459,
                         204622,
                         204662,
                         204665,
                         204774,
                         204780,
                         204805,
                         204837,
                         204908,
                         204916,
                         204927,
                         204961,
                         204962,
                         204982,
                         205030,
                         205058,
                         205059,
                         205101,
                         205103,
                         205118,
                         205123,
                         205154,
                         205155,
                         205156,
                         205220,
                         205223,
                         205229,
                         205231,
                         205269,
                         205271,
                         205288,
                         205291,
                         205313,
                         205342,
                         205356,
                         205367,
                         205376,
                         205383,
                         205414,
                         205417,
                         205420,
                         205432,
                         205447,
                         205448,
                         205462,
                         205464,
                         205466,
                         205497,
                         205504,
                         205519,
                         205528,
                         205536,
                         205539,
                         205540,
                         205542,
                         205547,
                         205563,
                         205570,
                         205574,
                         205578,
                         205580,
                         205581,
                         205583,
                         205593,
                         205594,
                         205609,
                         205613,
                         205620,
                         205626,
                         205628,
                         205631,
                         205634,
                         205637,
                         205646,
                         205650,
                         205666,
                         205667,
                         205670,
                         205675,
                         205679,
                         205688,
                         205695,
                         205697,
                         205699,
                         205702,
                         205710,
                         205711,
                         205714,
                         205719,
                         205722,
                         205725,
                         205730,
                         205731,
                         205732,
                         205735,
                         205738,
                         205739,
                         205740,
                         205745,
                         205750,
                         205753,
                         205754,
                         205758,
                         205761,
                         205763,
                         205767,
                         205770,
                         205774,
                         205778,
                         205779,
                         205780,
                         205787,
                         205788,
                         205789,
                         205793,
                         205796,
                         205797,
                         205800,
                         205802,
                         205803,
                         205804,
                         205805,
                         205806,
                         205807,
                         205810,
                         205811,
                         205813,
                         205815,
                         205816,
                         205822,
                         205823,
                         205825,
                         205826,
                         205830,
                         205832,
                         205834,
                         205839,
                         205841,
                         205844,
                         205851,
                         205853,
                         205857,
                         205858,
                         205863,
                         205864,
                         205865,
                         205866,
                         205867,
                         205868,
                         205873,
                         205874,
                         205878,
                         205882,
                         205883,
                         205884,
                         205885,
                         205886,
                         205887,
                         205888,
                         205889,
                         205890,
                         205896,
                         205897,
                         205901,
                         205903,
                         205904,
                         205906,
                         205907,
                         205909,
                         205912,
                         205913,
                         205915,
                         205916,
                         205918,
                         205920,
                         205921,
                         205922,
                         205924,
                         205930,
                         205931,
                         205934,
                         205940,
                         205941,
                         205944,
                         205945,
                         205947,
                         205949,
                         205953,
                         205954,
                         205955,
                         205956,
                         205957,
                         205958,
                         205962,
                         205965,
                         205966,
                         205967,
                         205968,
                         205969,
                         205970,
                         205971,
                         205972,
                         205973,
                         205974,
                         205975,
                         205976,
                         205977,
                         205978,
                         205980,
                         205982,
                         205983,
                         205984,
                         205985,
                         205986,
                         205988,
                         205990,
                         205991,
                         205993,
                         205997,
                         205999,
                         206000,
                         206001,
                         206002,
                         206003,
                         206008,
                         206009,
                         206010,
                         206011,
                         206012,
                         206013,
                         206014,
                         206015,
                         206016,
                         206018,
                         206020,
                         206021,
                         206022,
                         206023,
                         206024,
                         206025,
                         206026,
                         206027,
                         206028,
                         206031,
                         206033,
                         206034,
                         206035,
                         206037,
                         206038,
                         206039,
                         206040,
                         206042,
                         206045,
                         206046,
                         206047,
                         206048,
                         206049,
                         206050,
                         206052,
                         206053,
                         206055,
                         206056,
                         206057,
                         206062,
                         206063,
                         206064,
                         206067,
                         206068,
                         206072,
                         206073,
                         206075,
                         206076,
                         206078,
                         206080,
                         206081,
                         206082,
                         206083,
                         206084,
                         206086,
                         206088,
                         206091,
                         206092,
                         206093,
                         206094,
                         206096,
                         206099,
                         206101,
                         206102,
                         206103,
                         206105,
                         206106,
                         206107,
                         206108,
                         206110,
                         206112,
                         206113,
                         206114,
                         206117,
                         206118,
                         206119,
                         206121,
                         206122,
                         206123,
                         206125,
                         206127,
                         206128,
                         206130,
                         206133,
                         206137,
                         206139,
                         206140,
                         206141,
                         206143,
                         206145,
                         206146,
                         206147,
                         206148,
                         206150,
                         206152,
                         206153,
                         206155,
                         206157,
                         206159,
                         206162,
                         206163,
                         206164,
                         206165,
                         206166,
                         206168,
                         206171,
                         206175,
                         206177,
                         206178,
                         206179,
                         206181,
                         206182,
                         206183,
                         206184,
                         206185,
                         206187,
                         206189,
                         206190,
                         206192,
                         206193,
                         206194,
                         206195,
                         206196,
                         206197,
                         206200,
                         206201,
                         206202,
                         206203,
                         206204,
                         206205,
                         206206,
                         206207,
                         206209,
                         206210,
                         206212,
                         206213,
                         206216,
                         206217,
                         206218,
                         206220,
                         206222,
                         206223,
                         206224,
                         206227,
                         206228,
                         206229,
                         206231,
                         206232,
                         206233,
                         206234,
                         206235,
                         206237,
                         206238,
                         206240,
                         206241,
                         206242,
                         206243,
                         206244,
                         206245,
                         206246,
                         206247,
                         206248,
                         206249,
                         206253,
                         206254,
                         206256,
                         206257,
                         206258,
                         206260,
                         206262,
                         206263,
                         206264,
                         206266,
                         206267,
                         206268,
                         206274,
                         206275,
                         206276,
                         206277,
                         206278,
                         206279,
                         206280,
                         206281,
                         206282,
                         206283,
                         206285,
                         206286,
                         206288,
                         206289,
                         206290,
                         206292,
                         206293,
                         206294,
                         206295,
                         206298,
                         206299,
                         206300,
                         206301,
                         206302,
                         206303,
                         206305,
                         206306,
                         206308,
                         206309,
                         206310,
                         206312,
                         206316,
                         206318,
                         206319,
                         206321,
                         206322,
                         206323,
                         206325,
                         206326,
                         206327,
                         206335,
                         206336,
                         206337,
                         206338,
                         206340,
                         206341,
                         206342,
                         206343,
                         206344,
                         206346,
                         206349,
                         206350,
                         206351,
                         206352,
                         206353,
                         206354,
                         206355,
                         206356,
                         206357,
                         206358,
                         206360,
                         206363,
                         206364,
                         206365,
                         206367,
                         206368,
                         206369,
                         206370,
                         206372,
                         206373,
                         206374,
                         206375,
                         206376,
                         206379,
                         206381,
                         206382,
                         206384,
                         206385,
                         206386,
                         206387,
                         206388,
                         206389,
                         206390,
                         206391,
                         206392,
                         206393,
                         206394,
                         206397,
                         206398,
                         206400,
                         206401,
                         206402,
                         206403,
                         206404,
                         206405,
                         206407,
                         206408,
                         206409,
                         206410,
                         206411,
                         206412,
                         206413,
                         206415,
                         206416,
                         206417,
                         206418,
                         206419,
                         206420,
                         206421,
                         206422,
                         206423,
                         206424,
                         206426,
                         206427,
                         206429,
                         206430,
                         206431,
                         206432,
                         206434,
                         206435,
                         206436,
                         206437,
                         206438,
                         206439,
                         207260,
                         207409,
                         207706,
                         207768,
                         207923,
                         207949,
                         207955,
                         208054,
                         208064,
                         208065,
                         208072,
                         208087,
                         208091,
                         208094,
                         208102,
                         208104,
                         208109,
                         208114,
                         208117,
                         208118,
                         208122,
                         208130,
                         208132,
                         208138,
                         208139,
                         208142,
                         208143,
                         208147,
                         208148,
                         208149,
                         208150,
                         208152,
                         208153,
                         208154,
                         208156,
                         208160,
                         208164,
                         208165,
                         208166,
                         208167,
                         208168,
                         208171,
                         208174,
                         208178,
                         208179,
                         208182,
                         208185,
                         208187,
                         208188,
                         208189,
                         208190,
                         208193,
                         208195,
                         208196,
                         208197,
                         208199,
                         208200,
                         208201,
                         208205,
                         208208,
                         208209,
                         208211,
                         208212,
                         208215,
                         208216,
                         208218,
                         208219,
                         208221,
                         208225,
                         208226,
                         208227,
                         208230,
                         208231,
                         208233,
                         208236,
                         208237,
                         208238,
                         208241,
                         208242,
                         208243,
                         208244,
                         208245,
                         208248,
                         208249,
                         208264,
                         208273,
                         208282,
                         208290,
                         208302,
                         208309,
                         208316,
                         208317,
                         208325,
                         208328,
                         208329,
                         208331,
                         208333,
                         208334,
                         208336,
                         208337,
                         208339,
                         208341,
                         208342,
                         208344,
                         208345,
                         208347,
                         208348,
                         208349,
                         208355,
                         208356,
                         208358,
                         208359,
                         208360,
                         208361,
                         208364,
                         208365,
                         208366,
                         208367,
                         208368,
                         208369,
                         208370,
                         208372,
                         208373,
                         208374,
                         208375,
                         208376,
                         208377,
                         208378,
                         208379,
                         208380,
                         208381,
                         208382,
                         208384,
                         208387,
                         208389,
                         208390,
                         208393,
                         208395,
                         208396,
                         208398,
                         208399,
                         208403,
                         208404,
                         208411,
                         208412,
                         208413,
                         208414,
                         208415,
                         208416,
                         208417,
                         208418,
                         208420,
                         208421,
                         208422,
                         208423,
                         208424,
                         208425,
                         208426,
                         208428,
                         208429,
                         208430,
                         208431,
                         208432,
                         208434,
                         208436,
                         208437,
                         208439,
                         208440,
                         208441,
                         208444,
                         208445,
                         208446,
                         208447,
                         208448,
                         208449,
                         208450,
                         208451,
                         208452,
                         208453,
                         208454,
                         208455,
                         208456,
                         208458,
                         208459,
                         208460,
                         208461,
                         208463,
                         208464,
                         208465,
                         208466,
                         208467,
                         208468,
                         208469,
                         208471,
                         208474,
                         208475,
                         208476,
                         208477,
                         208478,
                         208479,
                         208481,
                         208487,
                         208490,
                         208491,
                         208492,
                         208493,
                         208494,
                         208495,
                         208496,
                         208498,
                         208499,
                         208502,
                         208503,
                         208504,
                         208505,
                         208506,
                         208509,
                         208510,
                         208512,
                         208515,
                         208516,
                         208518,
                         208519,
                         208520,
                         208521,
                         208522,
                         208524,
                         208525,
                         208527,
                         208528,
                         208530,
                         208532,
                         208533,
                         208534,
                         208535,
                         208536,
                         208537,
                         208538,
                         208541,
                         208542,
                         208543,
                         208544,
                         208547,
                         208548,
                         208549,
                         208551,
                         208552,
                         208554,
                         208555,
                         208557,
                         208558,
                         208559,
                         208560,
                         208561,
                         208562,
                         208564,
                         208566,
                         208567,
                         208569,
                         208571,
                         208572,
                         208574,
                         208575,
                         208576,
                         208577,
                         208579,
                         208580,
                         208581,
                         208582,
                         208583,
                         208584,
                         208585,
                         208589,
                         208591,
                         208592,
                         208593,
                         208594,
                         208595,
                         208596,
                         208597,
                         208601,
                         208602,
                         208604,
                         208606,
                         208607,
                         208609,
                         208610,
                         208611,
                         208615,
                         208616,
                         208617,
                         208619,
                         208621,
                         208622,
                         208625,
                         208643,
                         208645,
                         208646,
                         208650,
                         208652,
                         208659,
                         208662,
                         208664,
                         208666,
                         208669,
                         208673,
                         208678,
                         208679,
                         208680,
                         208681,
                         208682,
                         208683,
                         208738
                         )
                     ) T2
                     ON (T1.TAR_ID = T2.TAR_ID)
                     WHEN MATCHED THEN UPDATE SET
                         T1.USU_ID = T2.HAYAGBOINM
                         ,T1.USUARIOMODIFICAR = ''REMVIP-6938''
                         ,FECHAMODIFICAR = SYSDATE';

        EXECUTE IMMEDIATE V_MSQL;

        DBMS_OUTPUT.PUT_LINE('  [INFO] '||SQL%ROWCOUNT||' registros actualizados en la act_pta_patrimonio_activo');

        COMMIT;

        DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
    WHEN OTHERS THEN
    err_num := SQLCODE;
    err_msg := SQLERRM;

    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------');
    DBMS_OUTPUT.put_line(err_msg);
    DBMS_OUTPUT.put_line(V_MSQL);
    ROLLBACK;
    RAISE;

END;

/

EXIT
