--/*
--#########################################
--## AUTOR=Viorel Remus Ovidiu
--## FECHA_CREACION=20200221
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6357
--## PRODUCTO=NO
--## 
--## Finalidad: 
--## 
--## INSTRUCCIONES:  
--## VERSIONES:
--## 		0.1 Versión inicial
--## 		0.2 Cambio relación con PROVEEDORES
--## 		0.3 HREOS-9086 Correcciones
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01'; --REM01
	V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER'; --REMMASTER
	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-6357';
	V_TABLA VARCHAR2(40 CHAR) := 'ACT_PVC_PROVEEDOR_CONTACTO';
	V_TABLA_MIG VARCHAR2(40 CHAR) := 'MIG2_PVC_PROVEEDOR_CONTACTO';
	V_SENTENCIA VARCHAR2(32000 CHAR);

BEGIN
	--Inicio del proceso de volcado sobre ACT_PVC_PROVEEDOR_CONTACTO
	DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE MIGRACION SOBRE LA TABLA '||V_ESQUEMA||'.'||V_TABLA||'.');

	V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' PVC
		USING (
			SELECT 
				PVE.PVE_ID,
				MIG.PVC_NOMBRE,
				PRD.PRD_ID,
				MIG.PVC_IND_PRINCIPAL,
				CPC.DD_CPC_ID,
				MIG.PVC_CARGO,
				MIG.PVC_FECHA_ALTA,
				MIG.PVC_FECHA_BAJA,
				MIG.PVC_OBSERVACIONES,
				ROW_NUMBER() OVER (PARTITION BY 
					MIG.PVE_COD_ORIGEN, 
					MIG.PVC_NOMBRE ORDER BY MIG.PVC_PROVINCIA,
					MIG.PVC_CP,
					MIG.PVC_DIRECCION,
					MIG.PVC_TELF1,
					MIG.PVC_TELF2,
					MIG.PVC_FAX,
					MIG.PVC_EMAIL,
					MIG.PVC_IND_PRINCIPAL,
					MIG.PVC_COD_CARGO,
					MIG.PVC_CARGO,
					MIG.PVC_FECHA_ALTA,
					MIG.PVC_FECHA_BAJA,
					MIG.PVC_OBSERVACIONES,
					MIG.PVC_COD_DIRECCION,
					MIG.PVC_COD_USUARIO
				) AS ORDEN 
			FROM '||V_ESQUEMA||'.'||V_TABLA_MIG||' MIG
			INNER JOIN '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR PVE ON PVE.PVE_COD_PRINEX = MIG.PVE_COD_ORIGEN /*(PVE.PVE_COD_PRINEX = MIG.PVE_COD_ORIGEN OR (MIG.PVE_COD_ORIGEN IS NULL AND PVE.PVE_COD_REM = MIG.PVE_REM_ID) AND PVE.PVE_FECHA_BAJA IS NULL)*/
			INNER JOIN '||V_ESQUEMA||'.'||V_TABLA||' PVC ON PVC.PVE_ID = PVE.PVE_ID
			LEFT JOIN '||V_ESQUEMA||'.ACT_PRD_PROVEEDOR_DIRECCION PRD ON PRD.PVE_COD_DIRECC_UVEM = MIG.PVC_COD_DIRECCION
			LEFT JOIN '||V_ESQUEMA||'.DD_CPC_CARGO_PROV_CONTACTO CPC ON CPC.DD_CPC_CODIGO = MIG.PVC_COD_CARGO
			WHERE PVC.PVC_NOMBRE = MIG.PVC_NOMBRE AND MIG.VALIDACION = 0
		) AUX
		ON (
			AUX.PVC_NOMBRE = PVC.PVC_NOMBRE AND 
			AUX.PVE_ID = PVC.PVE_ID AND 
			AUX.ORDEN = 1
		)
		WHEN MATCHED THEN UPDATE SET
			PVC.PRD_ID = AUX.PRD_ID, 
			PVC.PVC_PRINCIPAL = AUX.PVC_IND_PRINCIPAL, 
			PVC.DD_CPC_ID = AUX.DD_CPC_ID,
			PVC.PVC_CARGO = AUX.PVC_CARGO, 
			PVC.PVC_FECHA_ALTA = AUX.PVC_FECHA_ALTA,
			PVC.PVC_FECHA_BAJA = AUX.PVC_FECHA_BAJA, 
			PVC.USUARIOMODIFICAR = '''||V_USUARIO||''', 
			PVC.FECHAMODIFICAR = SYSDATE
		';
	EXECUTE IMMEDIATE V_SENTENCIA;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' actualizada. '||SQL%ROWCOUNT||' Filas.');
	
	V_SENTENCIA := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' PVC (
		PVC_ID,
		PVE_ID,
		DD_PRV_ID,
		USU_ID,
		DD_TDI_ID,
		PVC_DOCIDENTIF,
		PVC_NOMBRE,
		PVC_APELLID01,
		PVC_APELLID02,
		PVC_CP,
		PVC_DIRECCION,
		PVC_TELF1,
		PVC_TELF2,
		PVC_FAX,
		PVC_EMAIL,
		PVC_PRINCIPAL,
		DD_CPC_ID,
		PVC_CARGO,
		PVC_FECHA_ALTA,
		PVC_FECHA_BAJA,
		PVC_OBSERVACIONES,
		PRD_ID,
		USUARIOCREAR,
		FECHACREAR
	)
	SELECT 
		'||V_ESQUEMA||'.S_'||V_TABLA||'.NEXTVAL,
		PVE.PVE_ID,
		PRV.DD_PRV_ID,
		USU.USU_ID,
		TDI.DD_TDI_ID,
		MIG.PVC_DOCUMENTO,
		MIG.PVC_NOMBRE,
		MIG.PVC_APELLIDO1,
		MIG.PVC_APELLIDO2,
		MIG.PVC_CP,
		MIG.PVC_DIRECCION,
		MIG.PVC_TELF1,
		MIG.PVC_TELF2,
		MIG.PVC_FAX,
		MIG.PVC_EMAIL,
		MIG.PVC_IND_PRINCIPAL,
		CPC.DD_CPC_ID,
		MIG.PVC_CARGO,
		MIG.PVC_FECHA_ALTA,
		MIG.PVC_FECHA_BAJA,
		MIG.PVC_OBSERVACIONES,
		PRD.PRD_ID,
		'''||V_USUARIO||''',
		SYSDATE
	FROM '||V_ESQUEMA||'.'||V_TABLA_MIG||' 					MIG
	INNER JOIN '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR 			PVE ON PVE.PVE_COD_PRINEX = MIG.PVE_COD_ORIGEN /*ON (PVE.PVE_COD_PRINEX = MIG.PVE_COD_ORIGEN OR (MIG.PVE_COD_ORIGEN IS NULL AND PVE.PVE_COD_REM = MIG.PVE_REM_ID) AND PVE.PVE_FECHA_BAJA IS NULL)*/
	LEFT JOIN '||V_ESQUEMA_MASTER||'.DD_PRV_PROVINCIA 		PRV ON PRV.DD_PRV_CODIGO = MIG.PVC_PROVINCIA
	LEFT JOIN '||V_ESQUEMA_MASTER||'.USU_USUARIOS 			USU ON USU.USU_USERNAME = MIG.PVC_COD_USUARIO 
	LEFT JOIN '||V_ESQUEMA||'.DD_TDI_TIPO_DOCUMENTO_ID 		TDI ON TDI.DD_TDI_CODIGO = MIG.PVC_TIPO_DOCUMENTO
	LEFT JOIN '||V_ESQUEMA||'.DD_CPC_CARGO_PROV_CONTACTO 	CPC ON CPC.DD_CPC_CODIGO = MIG.PVC_COD_CARGO
	LEFT JOIN '||V_ESQUEMA||'.ACT_PRD_PROVEEDOR_DIRECCION 	PRD ON PRD.PVE_COD_DIRECC_UVEM = MIG.PVC_COD_DIRECCION
	LEFT JOIN '||V_ESQUEMA||'.'||V_TABLA||' 				PVC ON PVC.PVE_ID = PVE.PVE_ID AND PVC.PVC_DOCIDENTIF = MIG.PVC_DOCUMENTO
	WHERE MIG.VALIDACION = 0 AND PVC.PVC_ID IS NULL
	';
	EXECUTE IMMEDIATE V_SENTENCIA ;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'.'||V_TABLA||' cargada. '||SQL%ROWCOUNT||' Filas.');
	
	COMMIT;
	
	V_SENTENCIA := 'BEGIN '||V_ESQUEMA||'.OPERACION_DDL.DDL_TABLE(''ANALYZE'','''||V_TABLA||''',''1''); END;';
	EXECUTE IMMEDIATE V_SENTENCIA;

EXCEPTION
	WHEN OTHERS THEN
		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------');
		DBMS_OUTPUT.put_line(SQLERRM);
		ROLLBACK;
		RAISE;
END;

/

EXIT;
