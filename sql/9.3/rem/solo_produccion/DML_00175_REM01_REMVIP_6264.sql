--/*
--##########################################
--## AUTOR=Carles Molins
--## FECHA_CREACION=20200302
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6264
--## PRODUCTO=NO
--##
--## Finalidad:
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versi贸n inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	V_USUARIO VARCHAR2(25 CHAR):= 'REMVIP-6264'; -- Incidencia Link
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_COUNT NUMBER(16);
	V_ACT_ID NUMBER(16);
    
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
	T_JBV(202049),
	T_JBV(6875756),
	T_JBV(6875757),
	T_JBV(6850817),
	T_JBV(6877412),
	T_JBV(122280),
	T_JBV(127801),
	T_JBV(7033137),
	T_JBV(7037290),
	T_JBV(7033140),
	T_JBV(7042220),
	T_JBV(7053017),
	T_JBV(7056931),
	T_JBV(7037062),
	T_JBV(7040132),
	T_JBV(7035101),
	T_JBV(7041927),
	T_JBV(7035105),
	T_JBV(7040140),
	T_JBV(7048109),
	T_JBV(7035103),
	T_JBV(7046709),
	T_JBV(7053018),
	T_JBV(7035100),
	T_JBV(7035102),
	T_JBV(7048159),
	T_JBV(7032710),
	T_JBV(7049244),
	T_JBV(7046782),
	T_JBV(7035104),
	T_JBV(7057496),
	T_JBV(7076053),
	T_JBV(7007721),
	T_JBV(180178),
	T_JBV(7007712),
	T_JBV(7007708),
	T_JBV(180322),
	T_JBV(161271),
	T_JBV(107744),
	T_JBV(202022),
	T_JBV(202048),
	T_JBV(91374),
	T_JBV(6035525),
	T_JBV(6037082),
	T_JBV(86784),
	T_JBV(76760),
	T_JBV(91178),
	T_JBV(90159),
	T_JBV(78352),
	T_JBV(6042354),
	T_JBV(77026),
	T_JBV(74950),
	T_JBV(154231),
	T_JBV(6028629),
	T_JBV(6075824),
	T_JBV(169230),
	T_JBV(202021),
	T_JBV(175123),
	T_JBV(202050),
	T_JBV(201959),
	T_JBV(175005),
	T_JBV(201848),
	T_JBV(201958),
	T_JBV(943053),
	T_JBV(6973105),
	T_JBV(6877273),
	T_JBV(6880312),
	T_JBV(6999271),
	T_JBV(6987354),
	T_JBV(7008928),
	T_JBV(6875176),
	T_JBV(6875179),
	T_JBV(6881578),
	T_JBV(6855019),
	T_JBV(6858982),
	T_JBV(6880906),
	T_JBV(6983919),
	T_JBV(6984061),
	T_JBV(6857561),
	T_JBV(6983058),
	T_JBV(7017855),
	T_JBV(6859334),
	T_JBV(6859101),
	T_JBV(6851016),
	T_JBV(6983229),
	T_JBV(6983616),
	T_JBV(6984242),
	T_JBV(6984068),
	T_JBV(6878574),
	T_JBV(6875803),
	T_JBV(6997146),
	T_JBV(7001850),
	T_JBV(6987155),
	T_JBV(6997568),
	T_JBV(6981956),
	T_JBV(6990864),
	T_JBV(6997252),
	T_JBV(6980736),
	T_JBV(6984094),
	T_JBV(6984094),
	T_JBV(6985410),
	T_JBV(6984065),
	T_JBV(6989752),
	T_JBV(6988975),
	T_JBV(6943714),
	T_JBV(6994282),
	T_JBV(6983488),
	T_JBV(6986349),
	T_JBV(6980734),
	T_JBV(5963370),
	T_JBV(5926549),
	T_JBV(6057946),
	T_JBV(6962610),
	T_JBV(6053400),
	T_JBV(5966914),
	T_JBV(5926883),
	T_JBV(5951635),
	T_JBV(5937695),
	T_JBV(5966068),
	T_JBV(5960731),
	T_JBV(5960999),
	T_JBV(5944145),
	T_JBV(5962528),
	T_JBV(5952434),
	T_JBV(5969566),
	T_JBV(5953609),
	T_JBV(5969368),
	T_JBV(5937456),
	T_JBV(5927362),
	T_JBV(5933314),
	T_JBV(5966866),
	T_JBV(6352513),
	T_JBV(5951748),
	T_JBV(6853347),
	T_JBV(6036355),
	T_JBV(6079352),
	T_JBV(7071269),
	T_JBV(7015857),
	T_JBV(6875851),
	T_JBV(187650),
	T_JBV(6857383),
	T_JBV(6876172),
	T_JBV(6857588),
	T_JBV(202049),
	T_JBV(6850817),
	T_JBV(6877412),
	T_JBV(6875757),
	T_JBV(127801),
	T_JBV(7037290),
	T_JBV(7037062),
	T_JBV(7035103),
	T_JBV(180322),
	T_JBV(7058598),
	T_JBV(7051347),
	T_JBV(7035105),
	T_JBV(7033137),
	T_JBV(7056261),
	T_JBV(7053018),
	T_JBV(7049131),
	T_JBV(7035104),
	T_JBV(7035101),
	T_JBV(7017431),
	T_JBV(7017432),
	T_JBV(122280),
	T_JBV(7007712),
	T_JBV(7035102),
	T_JBV(7033140),
	T_JBV(107744),
	T_JBV(161271),
	T_JBV(7046472),
	T_JBV(7035100),
	T_JBV(7007708),
	T_JBV(7007721),
	T_JBV(180178),
	T_JBV(6134367),
	T_JBV(6039864),
	T_JBV(6075824),
	T_JBV(6040775),
	T_JBV(6042354),
	T_JBV(6035525),
	T_JBV(6037082),
	T_JBV(6028629),
	T_JBV(90197),
	T_JBV(86784),
	T_JBV(78352),
	T_JBV(91374),
	T_JBV(91178),
	T_JBV(90159),
	T_JBV(76760),
	T_JBV(201641),
	T_JBV(169230),
	T_JBV(202048),
	T_JBV(202021),
	T_JBV(175123),
	T_JBV(202050),
	T_JBV(201958),
	T_JBV(201848),
	T_JBV(202022),
	T_JBV(201959),
	T_JBV(175005),
	T_JBV(6858951),
	T_JBV(6859803),
	T_JBV(7226692),
	T_JBV(6858412),
	T_JBV(6989752),
	T_JBV(6985410),
	T_JBV(6987155),
	T_JBV(7001850),
	T_JBV(6997568),
	T_JBV(6057946),
	T_JBV(6877273),
	T_JBV(7008928),
	T_JBV(6984242),
	T_JBV(6875176),
	T_JBV(6859101),
	T_JBV(6980734),
	T_JBV(6875803),
	T_JBV(6984068),
	T_JBV(6997146),
	T_JBV(6984094),
	T_JBV(6984094),
	T_JBV(6986349),
	T_JBV(6984061),
	T_JBV(6999271),
	T_JBV(6853347),
	T_JBV(6973105),
	T_JBV(6875179),
	T_JBV(6859334),
	T_JBV(6858982),
	T_JBV(6855019),
	T_JBV(6881578),
	T_JBV(6851016),
	T_JBV(6857561),
	T_JBV(6859167),
	T_JBV(6983616),
	T_JBV(6981956),
	T_JBV(7017855),
	T_JBV(6880312),
	T_JBV(6983229),
	T_JBV(6994282),
	T_JBV(6863141),
	T_JBV(6980736),
	T_JBV(6880906),
	T_JBV(6878574),
	T_JBV(6983919),
	T_JBV(6987354),
	T_JBV(6983058),
	T_JBV(6997252),
	T_JBV(6984065),
	T_JBV(6990864),
	T_JBV(6983488),
	T_JBV(6988975),
	T_JBV(5966914),
	T_JBV(5953609),
	T_JBV(6943714),
	T_JBV(6962610),
	T_JBV(6053400),
	T_JBV(5926549),
	T_JBV(5937695),
	T_JBV(5963370),
	T_JBV(5966866),
	T_JBV(5933314),
	T_JBV(5951635),
	T_JBV(5960731),
	T_JBV(5944145),
	T_JBV(5962528),
	T_JBV(5952434),
	T_JBV(5966068),
	T_JBV(5926883),
	T_JBV(5960999),
	T_JBV(5951748),
	T_JBV(5969566),
	T_JBV(5969368),
	T_JBV(5927362),
	T_JBV(5937456),
	T_JBV(6353246),
	T_JBV(6352513),
	T_JBV(6036355),
	T_JBV(6079352),
	T_JBV(7071269),
	T_JBV(6881941),
	T_JBV(7015857),
	T_JBV(6875851),
	T_JBV(6880611),
	T_JBV(6031383),
	T_JBV(187650),
	T_JBV(6876172),
	T_JBV(6857383),
	T_JBV(6857587)
	);
	V_TMP_JBV T_JBV;

BEGIN	

	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
		V_TMP_JBV := V_JBV(I);
		
		V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||TRIM(V_TMP_JBV(1));
		EXECUTE IMMEDIATE V_SQL INTO V_COUNT;

		IF V_COUNT > 0 THEN
		
			V_SQL := 'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||TRIM(V_TMP_JBV(1));
			EXECUTE IMMEDIATE V_SQL INTO V_ACT_ID;
		
			V_SQL := 'CALL '||V_ESQUEMA||'.SP_ASC_ACT_SIT_COM_VACIOS_V2 ('||V_ACT_ID||')';
			EXECUTE IMMEDIATE V_SQL;
		
			V_SQL := 'CALL '||V_ESQUEMA||'.SP_CAMBIO_ESTADO_PUBLICACION ('||V_ACT_ID||',1,'''||V_USUARIO||''')';
			EXECUTE IMMEDIATE V_SQL;
			
			DBMS_OUTPUT.put_line('	[INFO] Se ha recalculado la situaci贸n comercial y el estado de publicaci贸n del activo '||TRIM(V_TMP_JBV(1)));
			
		ELSE
		
			DBMS_OUTPUT.put_line('	[INFO] No existe el activo '||TRIM(V_TMP_JBV(1)));
		
		END IF;
	
	END LOOP;
		
	COMMIT;
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecuci贸n:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;