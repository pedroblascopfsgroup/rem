--/*
--#########################################
--## AUTOR=José Antonio Gigante Pamplona
--## FECHA_CREACION=20200319
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6606
--## PRODUCTO=NO
--## 
--## Finalidad: Actualizacion registros 
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	V_TABLA VARCHAR2(100 CHAR) := 'DD_ETG_EQV_TIPO_GASTO_RU_SIN_PROV'; -- Tabla Destino
	V_TABLA_AUX VARCHAR2(100 CHAR) := 'DD_ETG_EQV_TIPO_GASTO_RU'; -- Tabla origen
	V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_SQL VARCHAR2(4000 CHAR);
	PL_OUTPUT VARCHAR2(32000 CHAR);
	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-6606';
	V_NUM_REGISTROS NUMBER; -- Cuenta registros 
	V_FLAG_VACIADO NUMBER := 0;
    TYPE T_TABLA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_TABLA IS TABLE OF T_TABLA;
	
    M_TABLA T_ARRAY_TABLA := T_ARRAY_TABLA(
      --DD_STG_ID|COGRUG_POS|COTACA_POS|COSBAC_POS|COGRUG_NEG|COTACA_NEG|COSBAC_NEG|Descrip Pos| Descrip Neg-----
	    T_TABLA('1','3','60','3','3','60','53','IBIS','DEVOLUCIÓN IBIS')
		,T_TABLA('2','3','60','3','3','60','53','IBI RÚSTICO','DEVOLUCIÓN IBI RÚSTICO')
		,T_TABLA('4','3','60','1','3','60','51','PLUSVALÍA','DEVOLUCIÓN PLUSVALÍA')
		,T_TABLA('16','3','60','6','3','60','56','OTRAS TASAS','DEVOLUCIÓN OTRAS TASAS')
		,T_TABLA('18','3','60','6','3','60','56','OTRAS TASAS','DEVOLUCIÓN OTRAS TASAS')
		,T_TABLA('26','3','60','4','3','60','54','COMUNIDAD ORDINARIA','DEVOLUCIÓN COMUNIDAD ORDINARIA')
		,T_TABLA('27','3','60','4','3','60','54','EXTRAS COMUNIDAD','DEVOLUCIÓN EXTRAS COMUNIDAD')
		,T_TABLA('93','3','60','4','3','60','54','COMUNIDAD ORDINARIA','DEVOLUCIÓN EXTRAS COMUNIDAD')
		,T_TABLA('35','3','60','5','3','60','55','SUMINISTROS LUZ','DEVOLUCIÓN SUMINISTROS LUZ')
		,T_TABLA('36','3','60','5','3','60','55','SUMINISTROS AGUA','DEVOLUCIÓN SUMINISTROS AGUA')
		,T_TABLA('37','3','60','5','3','60','55','SUMINISTROS GAS','DEVOLUCIÓN SUMINISTROS GAS')
		,T_TABLA('38','3','60','5','3','60','55','OTROS SUMINISTROS','DEVOLUCIÓN OTROS SUMINISTROS')
		,T_TABLA('43','3','60','2','3','60','52','GASTOS REGISTRALES','ABONO/FACTURA')
		,T_TABLA('44','3','60','2','3','60','52','GASTOS REGISTRALES','ABONO/FACTURA')

    ); 
    V_TMP_TABLA T_TABLA;
	
BEGIN
	/* En primer lugar si procede insertamos los valores de DD_ETG_EQV_TIPO_GASTO_RU 
		si DD_ETG_EQV_TIPO_GASTO_RU_SIN_PROV ESTA VACIA, SI NO SOLO SE ACTUALIZA
	*/
  V_SQL := 'SELECT COUNT(1) FROM ALL_TAB_COLUMNS WHERE TABLE_NAME = '''||V_TABLA_AUX||'''';
  EXECUTE IMMEDIATE V_SQL INTO V_NUM_REGISTROS;
  
  IF V_NUM_REGISTROS > 0 THEN
	V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA||'';
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_REGISTROS;
	IF V_NUM_REGISTROS < 1 THEN
		DBMS_OUTPUT.PUT_LINE('[INFO]: RELLENANDO '||V_TABLA||' con los valores de '||V_TABLA_AUX||'.');
		V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||'
		(DD_ETG_ID
			,DD_TGA_ID
			,DD_STG_ID
			,DD_ETG_CODIGO
			,DD_ETG_DESCRIPCION_POS
			,DD_ETG_DESCRIPCION_LARGA_POS
			,DD_TPR_ID
			,COGRUG_POS
			,COTACA_POS
			,COSBAC_POS
			,DD_ETG_DESCRIPCION_NEG
			,DD_ETG_DESCRIPCION_LARGA_NEG
			,COGRUG_NEG
			,COTACA_NEG
			,COSBAC_NEG
			,VERSION
			,USUARIOCREAR
			,FECHACREAR
			,USUARIOMODIFICAR
			,FECHAMODIFICAR
			,USUARIOBORRAR
			,FECHABORRAR
			,BORRADO
		)
		
		SELECT  '||V_ESQUEMA||'.S_'||V_TABLA||'.NEXTVAL 
			,AUX.DD_TGA_ID
			,AUX.DD_STG_ID
			,AUX.DD_ETG_CODIGO
			,AUX.DD_ETG_DESCRIPCION_POS
			,AUX.DD_ETG_DESCRIPCION_LARGA_POS
			,AUX.DD_TPR_ID
			,AUX.COGRUG_POS
			,AUX.COTACA_POS
			,AUX.COSBAC_POS
			,AUX.DD_ETG_DESCRIPCION_NEG
			,AUX.DD_ETG_DESCRIPCION_LARGA_NEG
			,AUX.COGRUG_NEG
			,AUX.COTACA_NEG
			,AUX.COSBAC_NEG
			,AUX.VERSION
			,AUX.USUARIOCREAR
			,AUX.FECHACREAR
			,AUX.USUARIOMODIFICAR
			,AUX.FECHAMODIFICAR
			,AUX.USUARIOBORRAR
			,AUX.FECHABORRAR
			,AUX.BORRADO
		FROM '||V_ESQUEMA||'.'||V_TABLA_AUX||' AUX
		
		';
		EXECUTE IMMEDIATE V_SQL;
		DBMS_OUTPUT.PUT_LINE('[INFO] Se han insertado en total '||sql%rowcount||' registros en la tabla '||V_ESQUEMA||'.'||V_TABLA||'');
		COMMIT;
	END IF;
  END IF;
	-- Ahora actualizamos
	DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZANDO '|| V_TABLA);
    FOR I IN M_TABLA.FIRST .. M_TABLA.LAST
      LOOP
	  V_TMP_TABLA := M_TABLA(I);

	  V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' 
		SET FECHAMODIFICAR = SYSDATE,
		USUARIOMODIFICAR = '''||V_USUARIO||''',
		COGRUG_POS = '''||V_TMP_TABLA(2)||''',
		COTACA_POS = '''||V_TMP_TABLA(3)||''',
		COSBAC_POS = '''||V_TMP_TABLA(4)||''',
		COGRUG_NEG = '''||V_TMP_TABLA(5)||''',
		COTACA_NEG = '''||V_TMP_TABLA(6)||''',
		COSBAC_NEG = '''||V_TMP_TABLA(7)||''',
		DD_ETG_DESCRIPCION_POS = '''||V_TMP_TABLA(8)||''',
		DD_ETG_DESCRIPCION_LARGA_POS = '''||V_TMP_TABLA(8)||''',
		DD_ETG_DESCRIPCION_NEG = '''||V_TMP_TABLA(9)||''',
		DD_ETG_DESCRIPCION_LARGA_NEG = '''||V_TMP_TABLA(9)||'''
		WHERE DD_STG_ID = '''||V_TMP_TABLA(1)||'''
		';
		EXECUTE IMMEDIATE V_SQL;	
		V_NUM_REGISTROS := V_NUM_REGISTROS + sql%rowcount;
	END LOOP;
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualzado en total '||sql%rowcount||' registros en la tabla '||V_ESQUEMA||'.'||V_TABLA||'');
	COMMIT;

	PL_OUTPUT := PL_OUTPUT || '[FIN]'||CHR(10);
	DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);

EXCEPTION
    WHEN OTHERS THEN
      PL_OUTPUT := PL_OUTPUT ||'[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE)||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||'-----------------------------------------------------------'||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||SQLERRM||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||V_SQL||CHR(10);
      DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
