--/*
--##########################################
--## AUTOR=GUILLEM REY
--## FECHA_CREACION=20200313
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6675
--## PRODUCTO=NO
--##
--## Finalidad: Modificar la fecha de ejecución de los trabajos 9000293750 y 9000291474
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;
DECLARE

    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_MSQL VARCHAR2(32000 CHAR);

    ERR_NUM NUMBER; -- Numero de errores
    ERR_MSG VARCHAR2(2048); -- Mensaje de error

    -- EDITAR NÚMERO DE ITEM
    V_ITEM VARCHAR2(20) := 'REMVIP-6675';
    
    CURSOR CURSOR_AGR1 IS SELECT ACT_ID FROM #ESQUEMA#.ACT_ICM_INF_COMER_HIST_MEDI 
								WHERE ACT_ID IN (SELECT ACT_ID FROM #ESQUEMA#.ACT_AGA_AGRUPACION_ACTIVO 
												WHERE AGR_ID = (SELECT AGR_ID FROM #ESQUEMA#.ACT_AGR_AGRUPACION 
													WHERE AGR_NUM_AGRUP_REM = 5564486 AND BORRADO = 0) AND BORRADO = 0)
								AND ICO_MEDIADOR_ID != (SELECT PVE_ID FROM #ESQUEMA#.ACT_PVE_PROVEEDOR WHERE PVE_COD_REM = 662) 
								AND ICM_FECHA_HASTA IS NULL;
								
								
	CURSOR CURSOR_AGR2 IS SELECT ACT_ID FROM #ESQUEMA#.ACT_ICM_INF_COMER_HIST_MEDI 
								WHERE ACT_ID IN (SELECT ACT_ID FROM #ESQUEMA#.ACT_AGA_AGRUPACION_ACTIVO 
												WHERE AGR_ID = (SELECT AGR_ID FROM #ESQUEMA#.ACT_AGR_AGRUPACION 
													WHERE AGR_NUM_AGRUP_REM = 5933087 AND BORRADO = 0) AND BORRADO = 0)
								AND ICO_MEDIADOR_ID != (SELECT PVE_ID FROM #ESQUEMA#.ACT_PVE_PROVEEDOR WHERE PVE_COD_REM = 10006467) 
								AND ICM_FECHA_HASTA IS NULL;
	
	CURSOR CURSOR_AGR3 IS SELECT ACT_ID FROM #ESQUEMA#.ACT_ICM_INF_COMER_HIST_MEDI 
								WHERE ACT_ID IN (SELECT ACT_ID FROM #ESQUEMA#.ACT_AGA_AGRUPACION_ACTIVO 
												WHERE AGR_ID = (SELECT AGR_ID FROM #ESQUEMA#.ACT_AGR_AGRUPACION 
													WHERE AGR_NUM_AGRUP_REM = 1000001182 AND BORRADO = 0) AND BORRADO = 0)
								AND ICO_MEDIADOR_ID != (SELECT PVE_ID FROM #ESQUEMA#.ACT_PVE_PROVEEDOR WHERE PVE_COD_REM = 10006467) 
								AND ICM_FECHA_HASTA IS NULL;
	V_ACT_ID NUMBER(16);
	
BEGIN
    
    DBMS_OUTPUT.PUT_LINE('[INICIO]');
								
    OPEN CURSOR_AGR1;
      	LOOP
      		FETCH CURSOR_AGR1 INTO V_ACT_ID;
      		EXIT WHEN CURSOR_AGR1%NOTFOUND;
        V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_ICM_INF_COMER_HIST_MEDI SET ICM_FECHA_HASTA = SYSDATE, FECHAMODIFICAR = SYSDATE, USUARIOMODIFICAR = '''||V_ITEM||''' 
					WHERE ACT_ID = '||V_ACT_ID||' AND ICM_FECHA_HASTA IS NULL';
		EXECUTE IMMEDIATE V_MSQL;
		V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_ICM_INF_COMER_HIST_MEDI(ICM_ID, ACT_ID, ICO_MEDIADOR_ID, ICM_FECHA_DESDE, VERSION, USUARIOCREAR, FECHACREAR, BORRADO, DD_TRL_ID)
					SELECT '||V_ESQUEMA||'.S_ACT_ICM_INF_COMER_HIST_MEDI.NEXTVAL, '||V_ACT_ID||', (SELECT PVE_ID FROM '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR WHERE PVE_COD_REM = 662),
					SYSDATE, 0, '''||V_ITEM||''', SYSDATE, 0, (SELECT DD_TRL_ID FROM '||V_ESQUEMA||'.DD_TRL_TIPO_ROLES_MEDIADOR WHERE DD_TRL_CODIGO = ''01'') FROM DUAL';					
		EXECUTE IMMEDIATE V_MSQL;
		V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL SET ICO_MEDIADOR_ID = (SELECT PVE_ID FROM '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR WHERE PVE_COD_REM = 662), 
					FECHAMODIFICAR = SYSDATE, USUARIOMODIFICAR = '''||V_ITEM||''' WHERE ACT_ID = '||V_ACT_ID;					
		EXECUTE IMMEDIATE V_MSQL;
	END LOOP;
	CLOSE CURSOR_AGR1;
	
	OPEN CURSOR_AGR2;
      	LOOP
      		FETCH CURSOR_AGR2 INTO V_ACT_ID;
      		EXIT WHEN CURSOR_AGR2%NOTFOUND;
	    V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_ICM_INF_COMER_HIST_MEDI SET ICM_FECHA_HASTA = SYSDATE, FECHAMODIFICAR = SYSDATE, USUARIOMODIFICAR = '''||V_ITEM||''' 
					WHERE ACT_ID = '||V_ACT_ID||' AND ICM_FECHA_HASTA IS NULL';
		EXECUTE IMMEDIATE V_MSQL;
		V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_ICM_INF_COMER_HIST_MEDI(ICM_ID, ACT_ID, ICO_MEDIADOR_ID, ICM_FECHA_DESDE, VERSION, USUARIOCREAR, FECHACREAR, BORRADO, DD_TRL_ID)
					SELECT '||V_ESQUEMA||'.S_ACT_ICM_INF_COMER_HIST_MEDI.NEXTVAL, '||V_ACT_ID||', (SELECT PVE_ID FROM '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR WHERE PVE_COD_REM = 10006467),
					SYSDATE, 0, '''||V_ITEM||''', SYSDATE, 0, (SELECT DD_TRL_ID FROM '||V_ESQUEMA||'.DD_TRL_TIPO_ROLES_MEDIADOR WHERE DD_TRL_CODIGO = ''01'') FROM DUAL';					
		EXECUTE IMMEDIATE V_MSQL;
		V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL SET ICO_MEDIADOR_ID = (SELECT PVE_ID FROM '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR WHERE PVE_COD_REM = 10006467), 
					FECHAMODIFICAR = SYSDATE, USUARIOMODIFICAR = '''||V_ITEM||''' WHERE ACT_ID = '||V_ACT_ID;					
		EXECUTE IMMEDIATE V_MSQL;
	END LOOP;
	CLOSE CURSOR_AGR2;
	
	OPEN CURSOR_AGR3;
      	LOOP
      		FETCH CURSOR_AGR3 INTO V_ACT_ID;
      		EXIT WHEN CURSOR_AGR3%NOTFOUND;
	    V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_ICM_INF_COMER_HIST_MEDI SET ICM_FECHA_HASTA = SYSDATE, FECHAMODIFICAR = SYSDATE, USUARIOMODIFICAR = '''||V_ITEM||''' 
					WHERE ACT_ID = '||V_ACT_ID||' AND ICM_FECHA_HASTA IS NULL';
		EXECUTE IMMEDIATE V_MSQL;
		V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_ICM_INF_COMER_HIST_MEDI(ICM_ID, ACT_ID, ICO_MEDIADOR_ID, ICM_FECHA_DESDE, VERSION, USUARIOCREAR, FECHACREAR, BORRADO, DD_TRL_ID)
					SELECT '||V_ESQUEMA||'.S_ACT_ICM_INF_COMER_HIST_MEDI.NEXTVAL, '||V_ACT_ID||', (SELECT PVE_ID FROM '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR WHERE PVE_COD_REM = 10006467),
					SYSDATE, 0, '''||V_ITEM||''', SYSDATE, 0, (SELECT DD_TRL_ID FROM '||V_ESQUEMA||'.DD_TRL_TIPO_ROLES_MEDIADOR WHERE DD_TRL_CODIGO = ''01'') FROM DUAL';					
		EXECUTE IMMEDIATE V_MSQL;
		V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL SET ICO_MEDIADOR_ID = (SELECT PVE_ID FROM '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR WHERE PVE_COD_REM = 10006467), 
					FECHAMODIFICAR = SYSDATE, USUARIOMODIFICAR = '''||V_ITEM||''' WHERE ACT_ID = '||V_ACT_ID;					
		EXECUTE IMMEDIATE V_MSQL;
	END LOOP;
	CLOSE CURSOR_AGR3;
	
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;