--/*
--##########################################
--## AUTOR=Viorel Remus Ovidiu
--## FECHA_CREACION=20200318
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6688
--## PRODUCTO=NO
--##
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 
DECLARE

    PL_OUTPUT VARCHAR2(32000 CHAR);
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    V_NUM_FILAS NUMBER(16); -- Vble. para validar la existencia de un registro.
    V_NUM_FILAS_1 NUMBER(16); -- Vble. para validar la existencia de un registro.
    V_NUM_FILAS_2 NUMBER(16); -- Vble. para validar la existencia de un registro.
    V_NUM_FILAS_3 NUMBER(16); -- Vble. para validar la existencia de un registro.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-6688_7'; -- USUARIOCREAR/USUARIOMODIFICAR.
    V_ECO_ID NUMBER(16); 
    
    TRA_ID NUMBER(16);
    TAR_ID NUMBER(16);
    TEX_ID NUMBER(16);
    ACT_ID NUMBER(16);
    USU_ID NUMBER(16);
    SUP_ID NUMBER(16);
    ECO_ID NUMBER(16);
    TEX_TOKEN NUMBER(16);

    SEQ_TAR_ID NUMBER(16);

    V_COUNT_UPDATE_1 NUMBER(16):= 0; -- Vble. para contar updates
    V_COUNT_UPDATE_2 NUMBER(16):= 0; -- Vble. para contar updates
    V_COUNT_UPDATE_3 NUMBER(16):= 0; -- Vble. para contar updates

    
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	--TRA_ID , TAR_ID, ACT_ID, USU_ID, ECO_NUM_EXPEDIENTE

	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
	T_JBV(71204, 3682690, 41040, 39272, 5272),
	T_JBV(461730, 5024573, 73269, 39274, 198998),
	T_JBV(277081, 4192697, 72121, 39274, 149592),
	T_JBV(286698, 4258233, 37721, 39272, 153616),
	T_JBV(326595, 4420215, 72118, 39274, 166788),
	T_JBV(375435, 4603677, 68002, 39274, 178045),
	T_JBV(378776, 4675048, 74993, 39272, 178972),
	T_JBV(383133, 4731600, 260472, 39272, 180195),
	T_JBV(420243, 5026784, 354854, 39272, 189754),
	T_JBV(432839, 5026772, 354902, 39272, 192406),
	T_JBV(436052, 4990304, 1805, 39274, 193231),
	T_JBV(441386, 4999355, 2873, 39274, 194317),
	T_JBV(441387, 4999369, 556, 39274, 194318),
	T_JBV(442779, 5027459, 292572, 39274, 194611),
	T_JBV(444643, 4988959, 4187, 39274, 195019),
	T_JBV(445063, 5027586, 74109, 39274, 195123),
	T_JBV(445271, 4999505, 40158, 39274, 195194),
	T_JBV(446818, 4993466, 49585, 39272, 195704),
	T_JBV(448130, 4993684, 254461, 39272, 195781),
	T_JBV(449239, 5007624, 344174, 39274, 196079),
	T_JBV(450545, 4985953, 12807, 39254, 196416),
	T_JBV(450930, 5026749, 74779, 39274, 196497),
	T_JBV(454385, 5003664, 4473, 39274, 197263),
	T_JBV(271723, 4118836, 49165, 39272, 147517),
	T_JBV(40830, 3040104, 49357, 39274, 20099),
	T_JBV(64009, 3064355, 3301, 39274, 85580),
	T_JBV(67330, 3079133, 37173, 39274, 86750),
	T_JBV(95946, 3248669, 2384, 39274, 96786),
	T_JBV(101032, 3236651, 53770, 39274, 98824),
	T_JBV(103360, 3249668, 45173, 39274, 99807),
	T_JBV(112785, 3312092, 3612, 39274, 103416),
	T_JBV(114187, 3464231, 263810, 39274, 103975),
	T_JBV(114860, 3311648, 149, 39274, 104294),
	T_JBV(115163, 3312817, 46628, 39274, 104371),
	T_JBV(115410, 3314018, 46639, 39274, 104451),
	T_JBV(115515, 3351553, 678, 39274, 104475),
	T_JBV(115517, 3351519, 629, 39274, 104476),
	T_JBV(115673, 3315663, 45165, 39274, 104519),
	T_JBV(118717, 3331075, 46617, 39274, 105522),
	T_JBV(119193, 3334492, 38591, 39274, 105703),
	T_JBV(119370, 3335573, 38580, 39274, 105768),
	T_JBV(121659, 3342304, 46644, 39274, 106121),
	T_JBV(124224, 3353928, 46640, 39274, 106876),
	T_JBV(124378, 3354829, 53745, 39274, 106938),
	T_JBV(136710, 3400655, 38724, 39274, 107810),
	T_JBV(136712, 3400686, 49389, 39274, 107811),
	T_JBV(137830, 3421497, 49075, 39274, 108191),
	T_JBV(140804, 3424223, 4666, 39272, 109036),
	T_JBV(140816, 3425267, 45162, 39274, 109042),
	T_JBV(141520, 3453708, 48009, 39274, 109210),
	T_JBV(141944, 3433853, 13188, 39274, 109325),
	T_JBV(141947, 3433834, 13314, 39274, 109327),
	T_JBV(144095, 3438920, 45169, 39274, 110212),
	T_JBV(145400, 3447925, 3419, 39274, 110671),
	T_JBV(146682, 3453903, 49102, 39274, 111155),
	T_JBV(147354, 3456821, 431, 39274, 111348),
	T_JBV(147652, 3458631, 2620, 39274, 111449),
	T_JBV(148837, 3476102, 4524, 39274, 111902),
	T_JBV(149853, 3503470, 37241, 39274, 112281),
	T_JBV(150142, 3478650, 47992, 39274, 112370),
	T_JBV(150441, 3478549, 45729, 39274, 112500),
	T_JBV(150536, 3474257, 3211, 39274, 112545),
	T_JBV(151473, 3478795, 72969, 39274, 112839),
	T_JBV(154484, 3497339, 38577, 39274, 113434),
	T_JBV(154781, 3499393, 37992, 39274, 113544),
	T_JBV(176069, 3577793, 50420, 39274, 115298),
	T_JBV(176633, 3582753, 737, 39274, 115475),
	T_JBV(177289, 3588635, 39759, 39274, 115667),
	T_JBV(177522, 3586040, 47997, 39274, 115688),
	T_JBV(178125, 3587025, 1952, 39274, 115913),
	T_JBV(179671, 3593890, 39744, 39274, 116310),
	T_JBV(179954, 3604391, 45964, 39274, 116411),
	T_JBV(182051, 3606205, 45963, 39274, 117924),
	T_JBV(182396, 3614371, 45860, 39274, 118048),
	T_JBV(182878, 3608564, 73726, 39274, 118196),
	T_JBV(182936, 3608795, 46626, 39274, 118208),
	T_JBV(183302, 3616212, 45764, 39274, 118262),
	T_JBV(184304, 3629586, 45155, 39274, 118486),
	T_JBV(185931, 3621061, 45966, 39274, 118720),
	T_JBV(186066, 3625130, 263887, 39274, 118764),
	T_JBV(187059, 3631379, 3491, 39274, 119105),
	T_JBV(188098, 3632939, 42848, 39274, 119479),
	T_JBV(188366, 3635104, 73818, 39274, 119617),
	T_JBV(188676, 3636276, 274, 39274, 119721),
	T_JBV(189348, 3639543, 249, 39274, 119945),
	T_JBV(189767, 3648339, 37850, 39274, 120113),
	T_JBV(190682, 3645762, 54311, 39274, 120327),
	T_JBV(192052, 3651715, 3528, 39274, 120712),
	T_JBV(192703, 3688083, 4518, 39274, 120906),
	T_JBV(192850, 3657205, 49317, 39274, 120952),
	T_JBV(193654, 3659386, 38088, 39274, 121181),
	T_JBV(193660, 3659418, 38037, 39274, 121185),
	T_JBV(193665, 3659470, 38117, 39274, 121186),
	T_JBV(193711, 3680282, 12725, 39274, 121206),
	T_JBV(206847, 3727176, 73817, 39274, 126531),
	T_JBV(207494, 3692251, 659, 39274, 126756),
	T_JBV(218074, 3734477, 46543, 39274, 128250),
	T_JBV(219324, 3748985, 1688, 39274, 128732),
	T_JBV(220810, 3747180, 262160, 39274, 129281),
	T_JBV(221812, 3811855, 54327, 39274, 129564),
	T_JBV(222069, 3780516, 73816, 39274, 129662),
	T_JBV(222718, 3776800, 49077, 39274, 129910),
	T_JBV(223599, 3759310, 39129, 39274, 130127),
	T_JBV(223601, 3759331, 46541, 39274, 130129),
	T_JBV(224858, 3766438, 45960, 39274, 130648),
	T_JBV(224913, 3766764, 48479, 39274, 130679),
	T_JBV(225858, 3771964, 122820, 39274, 131039),
	T_JBV(226424, 3812635, 2813, 39274, 131163),
	T_JBV(226981, 3784668, 4699, 39274, 131415),
	T_JBV(228588, 3785969, 38826, 39274, 132079),
	T_JBV(228592, 3785988, 39339, 39274, 132082),
	T_JBV(229580, 3790890, 50721, 39274, 132508),
	T_JBV(233036, 3810321, 3493, 39274, 133874),
	T_JBV(235256, 3820492, 54319, 39274, 134734),
	T_JBV(235839, 3823958, 39634, 39274, 134983),
	T_JBV(237550, 3847929, 588, 39274, 135700),
	T_JBV(237889, 3865861, 2233, 39274, 135849),
	T_JBV(238433, 3838461, 42371, 39272, 136026),
	T_JBV(239826, 3847191, 42370, 39272, 136561),
	T_JBV(242054, 3857396, 5725, 39274, 137324),
	T_JBV(244151, 3865020, 261351, 39274, 137846),
	T_JBV(244857, 3868631, 2512, 39274, 138114),
	T_JBV(245944, 3874456, 37169, 39274, 138490),
	T_JBV(245954, 3874495, 37236, 39274, 138497),
	T_JBV(250289, 3898871, 73647, 39274, 140216),
	T_JBV(250933, 3903003, 39605, 39274, 140446),
	T_JBV(250941, 3907591, 74738, 39274, 140451),
	T_JBV(251238, 3905836, 46024, 39274, 140594),
	T_JBV(251309, 3905160, 73906, 39274, 140621),
	T_JBV(251573, 3907004, 13459, 39274, 140769),
	T_JBV(251631, 3907355, 13456, 39274, 140785),
	T_JBV(251829, 3908144, 13458, 39274, 140851),
	T_JBV(251866, 3908341, 13468, 39274, 140873),
	T_JBV(254599, 3925114, 74518, 39274, 141873),
	T_JBV(254822, 3924863, 50408, 39274, 141967),
	T_JBV(256163, 3932792, 73448, 39274, 142581),
	T_JBV(256915, 3936676, 3138, 39274, 142809),
	T_JBV(258296, 3991483, 179, 39274, 143324),
	T_JBV(277365, 4044270, 46212, 39272, 149726),
	T_JBV(295761, 4152512, 333938, 39274, 157250),
	T_JBV(306308, 4271668, 258958, 39272, 160842),
	T_JBV(308338, 4223630, 1950, 39274, 161582),
	T_JBV(359972, 4743403, 388701, 39274, 174485),
	T_JBV(375435, 4550534, 68002, 39274, 178045),
	T_JBV(380714, 4659086, 73753, 39272, 179445),
	T_JBV(394925, 4657596, 40492, 39272, 183578),
	T_JBV(398929, 4681649, 49400, 39274, 184857),
	T_JBV(401483, 4698777, 349119, 39274, 185466),
	T_JBV(418940, 4784643, 389110, 39272, 189422),
	T_JBV(420180, 4788344, 67567, 39274, 189732),
	T_JBV(425084, 4805015, 12726, 39274, 190542),
	T_JBV(425886, 4808903, 345149, 39272, 190734),
	T_JBV(434882, 4862896, 3259, 39272, 192934),
	T_JBV(448130, 4921479, 254461, 39272, 195781),
	T_JBV(450545, 4935199, 12807, 39254, 196416),
	T_JBV(37743, 3029288, 3529, 39900, 18863),
	T_JBV(239826, 3847361, 42370, 39451, 136561),
	T_JBV(238433, 3838485, 42371, 39451, 136026),
	T_JBV(244383, 3994482, 74933, 53048, 137953),
	T_JBV(66782, 4362551, 57238, 53048, 86576),
	T_JBV(191865, 3781590, 74946, 53048, 120650),
	T_JBV(188585, 3653993, 74942, 53048, 119699),
	T_JBV(182650, 3650895, 74904, 53048, 118114),
	T_JBV(384860, 4665450, 49561, 39372, 180583),
	T_JBV(33002, 4362546, 57205, 53048, 10007),
	T_JBV(29722, 3039030, 264, 39900, 9374),
	T_JBV(66781, 4362550, 57237, 53048, 86575),
	T_JBV(264177, 4123049, 42571, 53048, 145535),
	T_JBV(192974, 3685143, 74935, 53048, 120990),
	T_JBV(109342, 3282863, 45878, 39764, 102215),
	T_JBV(110279, 3287355, 45722, 42892, 102481),
	T_JBV(123718, 3408657, 39507, 40000, 106661),
	T_JBV(190613, 3645481, 47008, 40000, 120301),
	T_JBV(247194, 3881987, 49143, 39688, 139033),
	T_JBV(263495, 3978106, 5916, 40000, 145423),
	T_JBV(79899, 3183162, 274, 39906, 91364),
	T_JBV(78135, 3131539, 38135, 74225, 90599),
	T_JBV(77582, 3129188, 38138, 39764, 90449),
	T_JBV(73935, 3111553, 38227, 74225, 89190),
	T_JBV(72472, 3103204, 38127, 40015, 88513),
	T_JBV(65087, 3069415, 2282, 40015, 85957),
	T_JBV(33022, 3018680, 42487, 39960, 10025),
	T_JBV(33001, 3018521, 42317, 29496, 10006),
	T_JBV(32973, 3018702, 42586, 39764, 9993),
	T_JBV(32972, 3018700, 42286, 39764, 9992),
	T_JBV(32971, 3018704, 42316, 39764, 9991),
	T_JBV(32470, 3022109, 580, 39906, 9811),
	T_JBV(32418, 3018898, 1043, 42892, 9763),
	T_JBV(31895, 3040038, 2856, 40000, 9665),
	T_JBV(31818, 3013839, 3529, 39673, 9584)

		); 
	V_TMP_JBV T_JBV;
    
BEGIN	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ACTUALIZACION TRAMITES Y TAREAS');

	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
	V_TMP_JBV := V_JBV(I);
	
  	TRA_ID := TRIM(V_TMP_JBV(1));
  	
  	TAR_ID := TRIM(V_TMP_JBV(2));

	ACT_ID := TRIM(V_TMP_JBV(3));

	USU_ID := TRIM(V_TMP_JBV(4));
  	
  	ECO_ID := TRIM(V_TMP_JBV(5));


	--COMPROBAMOS SI EXISTE TRABAJO

	V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL WHERE ECO_NUM_EXPEDIENTE = '||ECO_ID;
	
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS;
	
	IF V_NUM_FILAS > 0 THEN 
	
	--QUITAMOS EL TOKEN DEL TRAMITE

		V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TRA_ID = '||TRA_ID||' AND TAR_ID = '||TAR_ID||' AND ACT_ID = '||ACT_ID||'';
	
		EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS_1;
	
		IF V_NUM_FILAS_1 > 0 THEN
	
			V_MSQL := 'UPDATE '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS 
					   SET USU_ID = '||USU_ID||',
					   USUARIOMODIFICAR = '''||V_USR||''',
					   FECHAMODIFICAR = SYSDATE 
					   WHERE TRA_ID = '||TRA_ID||' AND TAR_ID = '||TAR_ID||' AND ACT_ID = '||ACT_ID||'';
	

			EXECUTE IMMEDIATE V_MSQL;
	    
			DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO CON TRA_ID: '||TRA_ID||' ACTUALIZADO');
		
			V_COUNT_UPDATE_1 := V_COUNT_UPDATE_1 + 1;
		
		ELSE
		
			DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO NO EXISTE');
		
		END IF;
        
   	ELSE
		
	DBMS_OUTPUT.PUT_LINE('[INFO] EXPEDIENTE NO EXISTE');
		
	END IF; 

   	END LOOP;

	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN] Se han updateado en total '||V_COUNT_UPDATE_1||' registros EN TAC_TAREAS_ACTIVOS');

	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN] ');

	COMMIT;

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
