--/*
--#########################################
--## AUTOR=José Antonio Gigante
--## FECHA_CREACION=20200402
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6788
--## PRODUCTO=NO
--## 
--## Finalidad: Actualizacion registros 
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

	V_TABLA VARCHAr(100 char) := 'RES_RESERVAS';
	V_ESQUEMA VARCHAR2(25 CHAR):= 'REM01';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= 'REMMASTER';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_SQL VARCHAR2(4000 CHAR);
	PL_OUTPUT VARCHAR2(32000 CHAR);
	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-6788';
	
    TYPE T_TABLA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_TABLA IS TABLE OF T_TABLA;

    M_TABLA T_ARRAY_TABLA := T_ARRAY_TABLA(
      --|COD_OFERTA_REM|FECHA_CONTABLE_RESERVA_PRINEX|-----------------------
			T_TABLA('90240240','07/02/2020')
			,T_TABLA(90240640,'20/02/2020')
			-- DUPLICADO EN HOJA DE CÁLCULO ,T_TABLA('90240820','26/02/2020')
			,T_TABLA(90240820,'26/02/2020')
			,T_TABLA(90241013,'17/02/2020')
			,T_TABLA(90243767,'28/02/2020')
			,T_TABLA(90237735,'24/01/2020')
			,T_TABLA(90237751,'16/01/2020')
			,T_TABLA(90240369,'17/02/2020')
			,T_TABLA(90244318,'05/03/2020')
			,T_TABLA(90245385,'11/02/2020')
			,T_TABLA(90238064,'27/01/2020')
			,T_TABLA(90241641,'25/02/2020')
			,T_TABLA(90236462,'01/01/2020')
			,T_TABLA(90238636,'05/02/2020')

    ); 
    V_TMP_TABLA T_TABLA;
	
BEGIN
	DBMS_OUTPUT.PUT_LINE('[INFO]: Actualizando '|| V_TABLA);

    FOR I IN M_TABLA.FIRST .. M_TABLA.LAST
	LOOP
		V_TMP_TABLA := M_TABLA(I);

		V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' 
		SET 
		RES_FECHA_CONTABILIZACION = TO_DATE('''||V_TMP_TABLA(2)||''', ''DD/MM/YYYY''),
		FECHAMODIFICAR = SYSDATE,
		USUARIOMODIFICAR = '''||V_USUARIO||'''
		WHERE RES_ID =
		(	
			SELECT RES_ID 
			FROM '||V_ESQUEMA||'.'||V_TABLA||' RES
			JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.ECO_ID = RES.ECO_ID
			JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = ECO.OFR_ID
			WHERE OFR.OFR_NUM_OFERTA = '||V_TMP_TABLA(1)||'
		)
		';
		EXECUTE IMMEDIATE V_SQL;	
	END LOOP;
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han gestionado en total '||sql%rowcount||' registros en la tabla '||V_ESQUEMA||'.'||V_TABLA||'');
	COMMIT;

	PL_OUTPUT := PL_OUTPUT || '[FIN]'||CHR(10);
	DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);

EXCEPTION
    WHEN OTHERS THEN
      PL_OUTPUT := PL_OUTPUT ||'[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE)||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||'-----------------------------------------------------------'||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||SQLERRM||CHR(10);
      PL_OUTPUT := PL_OUTPUT ||V_SQL||CHR(10);
      DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
