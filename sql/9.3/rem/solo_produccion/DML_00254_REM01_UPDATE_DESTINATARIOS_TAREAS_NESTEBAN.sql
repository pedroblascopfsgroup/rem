--/*
--##########################################
--## AUTOR=Viorel Remus Ovidiu
--## FECHA_CREACION=20200416
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6966
--## PRODUCTO=NO
--##
--## INSTRUCCIONES: actualizar destinatario de tarea a nesteban
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 
DECLARE

    PL_OUTPUT VARCHAR2(32000 CHAR);
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    V_NUM_FILAS NUMBER(16); -- Vble. para validar la existencia de un registro.
    V_NUM_FILAS_1 NUMBER(16); -- Vble. para validar la existencia de un registro.
    V_NUM_FILAS_2 NUMBER(16); -- Vble. para validar la existencia de un registro.
    V_NUM_FILAS_3 NUMBER(16); -- Vble. para validar la existencia de un registro.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-6966'; -- USUARIOCREAR/USUARIOMODIFICAR.
    V_ECO_ID NUMBER(16); 
    
    TRA_ID NUMBER(16);
    TAR_ID NUMBER(16);
    TEX_ID NUMBER(16);
    ACT_ID NUMBER(16);
    USU_ID NUMBER(16);
    SUP_ID NUMBER(16);
    ECO_ID NUMBER(16);
    TEX_TOKEN NUMBER(16);

    SEQ_TAR_ID NUMBER(16);

    V_COUNT_UPDATE_1 NUMBER(16):= 0; -- Vble. para contar updates
    V_COUNT_UPDATE_2 NUMBER(16):= 0; -- Vble. para contar updates
    V_COUNT_UPDATE_3 NUMBER(16):= 0; -- Vble. para contar updates

    
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	--TRA_ID , TAR_ID, ACT_ID, USU_ID, ECO_NUM_EXPEDIENTE

	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
T_JBV(475575, 5157413,496011 ,88062 ,204681 ),
T_JBV(473726, 5157209,452924 ,88062 ,205601 ),
T_JBV(474386, 5157239,484357 ,69814 ,206184 ),
T_JBV(478643, 5157673,452277 ,39518 ,206308 ),
T_JBV(479419, 5157743,493716 ,69814 ,206408 ),
T_JBV(476173, 5157386,493156 ,88062 ,207832 ),
T_JBV(476065, 5157443,487123 ,39518 ,207878 ),
T_JBV(478226, 5157663,463442 ,89626 ,208057 ),
T_JBV(480037, 5157849,468190 ,89626 ,208103 ),
T_JBV(476891, 5157474,447708 ,75235 ,208190 ),
T_JBV(475335, 5157366,457283 ,75235 ,208641 ),
T_JBV(478132, 5157552,485129 ,69814 ,205909 ),
T_JBV(476553, 5157465,454995 ,39518 ,207664 ),
T_JBV(473891, 5157205,466867 ,89626 ,207933 ),
T_JBV(474458, 5157271,477555 ,88062 ,208344 ),
T_JBV(477383, 5157538,484361 ,39518 ,206242 ),
T_JBV(480211, 5157820,486200 ,69814 ,207846 ),
T_JBV(480276, 5157811,473656 ,69814 ,207882 ),
T_JBV(479574, 5157749,475561 ,88062 ,208360 ),
T_JBV(477256, 5157598,487096 ,88353 ,208487 ),
T_JBV(475989, 5157392,498755 ,69814 ,208512 ),
T_JBV(558624, 5161074,463401 ,89626 ,208717 ),
T_JBV(475540, 5157390,462158 ,88062 ,205156 ),
T_JBV(474198, 5157268,454857 ,88062 ,205220 ),
T_JBV(479972, 5157841,458027 ,40000 ,205954 ),
T_JBV(480128, 5157863,485462 ,88062 ,206164 ),
T_JBV(476357, 5157508,485128 ,88062 ,206372 ),
T_JBV(474536, 5157338,481146 ,88353 ,206386 ),
T_JBV(475674, 5157435,493710 ,69814 ,206409 ),
T_JBV(480261, 5157795,490728 ,39518 ,207076 ),
T_JBV(478302, 5157701,495616 ,88353 ,208119 ),
T_JBV(478817, 5157690,472111 ,40000 ,208143 ),
T_JBV(478082, 5157585,463245 ,88062 ,208509 ),
T_JBV(480059, 5157793,463717 ,88062 ,208656 ),
T_JBV(477177, 5161105,469516 ,89626 ,202663 ),
T_JBV(477261, 5157554,486222 ,69814 ,205025 ),
T_JBV(479998, 5157858,454859 ,75235 ,205965 ),
T_JBV(475423, 5157401,466652 ,88062 ,205976 ),
T_JBV(477918, 5157603,486227 ,88062 ,206091 ),
T_JBV(478297, 5157654,484364 ,88062 ,206256 ),
T_JBV(475416, 5157419,450736 ,88353 ,206293 ),
T_JBV(480733, 5157810,473974 ,69814 ,207527 ),
T_JBV(474534, 5157317,499956 ,88062 ,208264 ),
T_JBV(477499, 5157556,452064 ,88353 ,208316 ),
T_JBV(474592, 5157286,498747 ,89626 ,208658 ),
T_JBV(475568, 5157385,476611 ,89626 ,205012 ),
T_JBV(479102, 5157787,464955 ,88353 ,205464 ),
T_JBV(474955, 5157352,471577 ,75235 ,206424 ),
T_JBV(473647, 5157199,467102 ,89626 ,208062 ),
T_JBV(477567, 5157592,456295 ,75235 ,208150 ),
T_JBV(480706, 5157845,495824 ,88062 ,208182 ),
T_JBV(474271, 5157276,447302 ,39518 ,208410 ),
T_JBV(474703, 5157331,484358 ,40000 ,208441 ),
T_JBV(479420, 5157782,499072 ,89626 ,208573 ),
T_JBV(478736, 5157656,470186 ,39740 ,205981 ),
T_JBV(475960, 5157379,490726 ,88062 ,206062 ),
T_JBV(473896, 5157214,485461 ,88062 ,206163 ),
T_JBV(477161, 5157516,495887 ,88062 ,206266 ),
T_JBV(474097, 5157247,462687 ,40000 ,206430 ),
T_JBV(474702, 5157365,466918 ,89626 ,206446 ),
T_JBV(478171, 5157653,471831 ,89626 ,207713 ),
T_JBV(474587, 5157301,444710 ,89626 ,207970 ),
T_JBV(479256, 5157704,457179 ,39518 ,208227 ),
T_JBV(476319, 5157382,495825 ,88062 ,208290 ),
T_JBV(478033, 5157617,500033 ,88062 ,208390 ),
T_JBV(479675, 5157737,496160 ,39518 ,208430 ),
T_JBV(473693, 5157197,466194 ,88062 ,208516 ),
T_JBV(559119, 5160501,464907 ,39518 ,208820 ),
T_JBV(479443, 5157729,464187 ,75235 ,204985 ),
T_JBV(479845, 5157777,463781 ,75235 ,206127 ),
T_JBV(478303, 5157650,463607 ,89626 ,206503 ),
T_JBV(474395, 5157262,495006 ,89626 ,207884 ),
T_JBV(477642, 5157558,447705 ,75235 ,208189 ),
T_JBV(474920, 5157347,496554 ,88062 ,208341 ),
T_JBV(474513, 5157240,484363 ,40000 ,208464 ),
T_JBV(478005, 5161159,491636 ,69814 ,208514 )
		); 
	V_TMP_JBV T_JBV;
    
BEGIN	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ACTUALIZACION TRAMITES Y TAREAS');

	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
	V_TMP_JBV := V_JBV(I);
	
  	TRA_ID := TRIM(V_TMP_JBV(1));
  	
  	TAR_ID := TRIM(V_TMP_JBV(2));

	ACT_ID := TRIM(V_TMP_JBV(3));

	USU_ID := TRIM(V_TMP_JBV(4));
  	
  	ECO_ID := TRIM(V_TMP_JBV(5));


	--COMPROBAMOS SI EXISTE TRABAJO

	V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL WHERE ECO_NUM_EXPEDIENTE = '||ECO_ID;
	
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS;
	
	IF V_NUM_FILAS > 0 THEN 
	
	--COMPROBAMOS SI EXISTE TAREA

		V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TRA_ID = '||TRA_ID||' AND TAR_ID = '||TAR_ID||' AND ACT_ID = '||ACT_ID||'';
	
		EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS_1;
	
		IF V_NUM_FILAS_1 > 0 THEN
	
			V_MSQL := 'UPDATE '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS 
					   SET USU_ID = 87742 ,
					   USUARIOMODIFICAR = '''||V_USR||''',
					   FECHAMODIFICAR = SYSDATE 
					   WHERE TRA_ID = '||TRA_ID||' AND TAR_ID = '||TAR_ID||' AND ACT_ID = '||ACT_ID||'';
	

			EXECUTE IMMEDIATE V_MSQL;
	    
			DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO CON TRA_ID: '||TRA_ID||' ACTUALIZADO');
		
			V_COUNT_UPDATE_1 := V_COUNT_UPDATE_1 + 1;
		
		ELSE
		
			DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO NO EXISTE');
		
		END IF;
        
   	ELSE
		
	DBMS_OUTPUT.PUT_LINE('[INFO] EXPEDIENTE NO EXISTE');
		
	END IF; 

   	END LOOP;

	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN] Se han updateado en total '||V_COUNT_UPDATE_1||' registros EN TAC_TAREAS_ACTIVOS');

	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN] ');

	COMMIT;

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
