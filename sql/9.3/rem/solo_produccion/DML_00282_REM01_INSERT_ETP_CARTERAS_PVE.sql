--/*
--#########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20200430
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-7123
--## PRODUCTO=NO
--## 
--## Finalidad: Se añade relación de 
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE


	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_SQL VARCHAR2(4000 CHAR);

BEGIN

-----------------------------------------------------------------------------------------------------------------

	DBMS_OUTPUT.PUT_LINE('[INICIO] AÑADE TODAS LAS CARTERAS A LOS PROVEEDORES VIGENTES DE TIPO FUERZA ');
										
	 V_SQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_ETP_ENTIDAD_PROVEEDOR (
			ETP_ID,
			DD_CRA_ID,
			PVE_ID,
			VERSION,
			USUARIOCREAR,
			FECHACREAR,
			BORRADO
			)
			SELECT '||V_ESQUEMA||'.S_ACT_ETP_ENTIDAD_PROVEEDOR.NEXTVAL AS ETP_ID, 
			(SELECT DD_CRA_ID FROM '||V_ESQUEMA||'.DD_CRA_CARTERA WHERE DD_CRA_CODIGO = CARTERAS_FALTANTES) AS DD_CRA_ID,
			PVE_ID AS PVE_ID,
			0 AS VERSION,
			''REMVIP-7123'' AS USUARIOCREAR,
			SYSDATE AS FECHACREAR,
			0 AS BORRADO
			FROM (WITH TMP AS (SELECT PVE_ID, MAX(CAJAMAR) AS CAJAMAR, MAX(SAREB) AS SAREB,MAX(BANKIA) AS BANKIA,MAX(OTRAS_CARTERAS) AS OTRAS_CARTERAS,
			MAX(SIN_DEFINIR) AS SIN_DEFINIR,MAX(HYT) AS HYT,MAX(CERBERUS) AS CERBERUS,MAX(LIBERBANK) AS LIBERBANK,
			MAX(TANGO) AS TANGO,MAX(THIRD_PARTIES) AS THIRD_PARTIES,MAX(GIANTS) AS GIANTS,MAX(EGEO) AS EGEO,MAX(ZEUS) AS ZEUS,MAX(GALEON) AS GALEON
			FROM(
			SELECT PVE.PVE_ID, CASE WHEN CRA.DD_CRA_CODIGO = ''01'' THEN 1 ELSE 0 END AS CAJAMAR,
			CASE WHEN CRA.DD_CRA_CODIGO = ''02'' THEN 1 ELSE 0 END AS SAREB,
			CASE WHEN CRA.DD_CRA_CODIGO = ''03'' THEN 1 ELSE 0 END AS BANKIA,
			CASE WHEN CRA.DD_CRA_CODIGO = ''04'' THEN 1 ELSE 0 END AS OTRAS_CARTERAS,
			CASE WHEN CRA.DD_CRA_CODIGO = ''05'' THEN 1 ELSE 0 END AS SIN_DEFINIR,
			CASE WHEN CRA.DD_CRA_CODIGO = ''06'' THEN 1 ELSE 0 END AS HYT,
			CASE WHEN CRA.DD_CRA_CODIGO = ''07'' THEN 1 ELSE 0 END AS CERBERUS,
			CASE WHEN CRA.DD_CRA_CODIGO = ''08'' THEN 1 ELSE 0 END AS LIBERBANK,
			CASE WHEN CRA.DD_CRA_CODIGO = ''10'' THEN 1 ELSE 0 END AS TANGO,
			CASE WHEN CRA.DD_CRA_CODIGO = ''11'' THEN 1 ELSE 0 END AS THIRD_PARTIES,
			CASE WHEN CRA.DD_CRA_CODIGO = ''12'' THEN 1 ELSE 0 END AS GIANTS,
			CASE WHEN CRA.DD_CRA_CODIGO = ''13'' THEN 1 ELSE 0 END AS EGEO,
			CASE WHEN CRA.DD_CRA_CODIGO = ''14'' THEN 1 ELSE 0 END AS ZEUS,
			CASE WHEN CRA.DD_CRA_CODIGO = ''15'' THEN 1 ELSE 0 END AS GALEON
			FROM '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR PVE
			LEFT JOIN '||V_ESQUEMA||'.ACT_ETP_ENTIDAD_PROVEEDOR ETP ON PVE.PVE_ID = ETP.PVE_ID
			LEFT JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ETP.DD_CRA_ID
			JOIN '||V_ESQUEMA||'.DD_TPR_TIPO_PROVEEDOR TPR ON TPR.DD_TPR_ID = PVE.DD_TPR_ID
			JOIN '||V_ESQUEMA||'.DD_EPR_ESTADO_PROVEEDOR EPR ON EPR.DD_EPR_ID = PVE.DD_EPR_ID
			WHERE TPR.DD_TPR_CODIGO IN (''04'', ''18'') AND EPR.DD_EPR_CODIGO = ''04''
			) GROUP BY PVE_ID)
			SELECT PVE_ID, ''01'' AS CARTERAS_FALTANTES FROM TMP WHERE CAJAMAR = 0
			UNION ALL
			SELECT PVE_ID, ''02'' AS CARTERAS_FALTANTES FROM TMP WHERE SAREB = 0
			UNION ALL
			SELECT PVE_ID, ''03'' AS CARTERAS_FALTANTES FROM TMP WHERE BANKIA = 0
			UNION ALL
			SELECT PVE_ID, ''04'' AS CARTERAS_FALTANTES FROM TMP WHERE OTRAS_CARTERAS = 0
			UNION ALL
			SELECT PVE_ID, ''05'' AS CARTERAS_FALTANTES FROM TMP WHERE SIN_DEFINIR = 0
			UNION ALL
			SELECT PVE_ID, ''06'' AS CARTERAS_FALTANTES FROM TMP WHERE HYT = 0
			UNION ALL
			SELECT PVE_ID, ''07'' AS CARTERAS_FALTANTES FROM TMP WHERE CERBERUS = 0
			UNION ALL
			SELECT PVE_ID, ''08'' AS CARTERAS_FALTANTES FROM TMP WHERE LIBERBANK = 0
			UNION ALL
			SELECT PVE_ID, ''10'' AS CARTERAS_FALTANTES FROM TMP WHERE TANGO = 0
			UNION ALL
			SELECT PVE_ID, ''11'' AS CARTERAS_FALTANTES FROM TMP WHERE THIRD_PARTIES = 0
			UNION ALL
			SELECT PVE_ID, ''12'' AS CARTERAS_FALTANTES FROM TMP WHERE GIANTS = 0
			UNION ALL
			SELECT PVE_ID, ''13'' AS CARTERAS_FALTANTES FROM TMP WHERE EGEO = 0
			UNION ALL
			SELECT PVE_ID, ''14'' AS CARTERAS_FALTANTES FROM TMP WHERE ZEUS = 0
			UNION ALL
			SELECT PVE_ID, ''15'' AS CARTERAS_FALTANTES FROM TMP WHERE GALEON = 0)';

	EXECUTE IMMEDIATE V_SQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Creados '||SQL%ROWCOUNT||' relaciones proveedores-carteras ');  

	COMMIT;


EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      DBMS_OUTPUT.PUT_LINE(V_SQL);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
