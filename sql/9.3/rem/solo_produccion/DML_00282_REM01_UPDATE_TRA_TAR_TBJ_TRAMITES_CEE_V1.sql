--/*
--##########################################
--## AUTOR=Viorel Remus Ovidiu
--## FECHA_CREACION=20200429
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6597
--## PRODUCTO=NO
--##
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 
DECLARE

    PL_OUTPUT VARCHAR2(32000 CHAR);
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    V_NUM_FILAS_1 NUMBER(16); -- Vble. para validar la existencia de un registro.
    V_NUM_FILAS_2 NUMBER(16); -- Vble. para validar la existencia de un registro.
    V_NUM_FILAS_3 NUMBER(16); -- Vble. para validar la existencia de un registro.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-6597'; -- USUARIOCREAR/USUARIOMODIFICAR.
    V_ECO_ID NUMBER(16); 
    
    TRA_ID NUMBER(16);
    TAR_ID NUMBER(16);
    ACT_ID NUMBER(16);
    NUM_TRABAJO NUMBER(16);
    V_COUNT_UPDATE_1 NUMBER(16):= 0; -- Vble. para contar updates
    V_COUNT_UPDATE_2 NUMBER(16):= 0; -- Vble. para contar updates
    V_COUNT_UPDATE_3 NUMBER(16):= 0; -- Vble. para contar updates
    
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	--ACT_ID, TRA_ID , TAR_ID, TBJ_NUM_TRABAJO 

	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
		T_JBV(253866,146165,3451036,9000094086),
		T_JBV(51821,386748,4610475,9000245537),
		T_JBV(324874,447527,4919856,9000287363),
		T_JBV(264901,421605,4792011,9000269767),
		T_JBV(264901,421605,4793634,9000269767),
		T_JBV(273503,421517,4791909,9000269682),
		T_JBV(273503,421517,4814265,9000269682),
		T_JBV(51860,386762,4610508,9000245551),
		T_JBV(430769,424024,4801929,9000271712),
		T_JBV(430778,424020,4801924,9000271708),
		T_JBV(430770,424025,4801930,9000271713),
		T_JBV(430772,424022,4801927,9000271710),
		T_JBV(430775,424027,4801932,9000271715),
		T_JBV(430768,424034,4801940,9000271722),
		T_JBV(430782,424038,4801944,9000271726),
		T_JBV(430767,424032,4801938,9000271720),
		T_JBV(51814,386751,4610478,9000245540),
		T_JBV(51852,386747,4610474,9000245536),
		T_JBV(51816,386753,4610480,9000245542),
		T_JBV(51838,386746,4610473,9000245535),
		T_JBV(430773,424033,4801939,9000271721),
		T_JBV(430764,424021,4801926,9000271709),
		T_JBV(430777,424037,4801943,9000271725),
		T_JBV(51854,386765,4610511,9000245554),
		T_JBV(51869,386763,4610509,9000245552),
		T_JBV(51848,386767,4610513,9000245556),
		T_JBV(51815,386768,4610514,9000245557),
		T_JBV(430780,424036,4801942,9000271724),
		T_JBV(430771,424018,4801922,9000271706),
		T_JBV(430762,424029,4801934,9000271717),
		T_JBV(430765,424031,4801937,9000271719),
		T_JBV(150536,470329,5038644,9000304792),
		T_JBV(150536,470351,5038700,9000304813),
		T_JBV(228927,470336,5038651,9000304799),
		T_JBV(228927,470358,5038707,9000304820),
		T_JBV(221524,326142,4314859,9000200692),
		T_JBV(246142,470332,5038647,9000304795),
		T_JBV(246142,470354,5038703,9000304816),
		T_JBV(246143,470355,5038704,9000304817),
		T_JBV(246143,470373,5038723,9000304835),
		T_JBV(246144,470356,5038705,9000304818),
		T_JBV(246144,470374,5038724,9000304836),
		T_JBV(247099,470352,5038701,9000304814),
		T_JBV(247099,470370,5038720,9000304832),
		T_JBV(430759,424017,4801921,9000271705),
		T_JBV(430779,424023,4801928,9000271711),
		T_JBV(430763,424039,4801945,9000271727),
		T_JBV(430760,424026,4801931,9000271714),
		T_JBV(430761,424040,4801946,9000271728),
		T_JBV(430776,424028,4801933,9000271716),
		T_JBV(430766,424035,4801941,9000271723),
		T_JBV(430774,424019,4801923,9000271707),
		T_JBV(430781,424030,4801935,9000271718),
		T_JBV(250019,326549,4341478,9000200980),
		T_JBV(250019,326549,4316882,9000200980),
		T_JBV(251106,470361,5038711,9000304823),
		T_JBV(251106,470379,5038729,9000304841),
		T_JBV(251098,470363,5038713,9000304825),
		T_JBV(251098,470381,5038731,9000304843),
		T_JBV(308701,356687,4465334,9000223815),
		T_JBV(308701,356687,4460462,9000223815),
		T_JBV(295654,356686,4465351,9000223814),
		T_JBV(295654,356686,4460461,9000223814),
		T_JBV(275248,269848,4007393,9000160359),
		T_JBV(251698,345714,4418853,9000215313),
		T_JBV(251698,345714,4410663,9000215313),
		T_JBV(308947,356670,4460416,9000223798),
		T_JBV(308947,356670,4461099,9000223798),
		T_JBV(265260,385837,4748838,9000244840),
		T_JBV(265260,385837,4605405,9000244840),
		T_JBV(283206,280490,4061208,9000167856),
		T_JBV(283206,280490,4062284,9000167856),
		T_JBV(274962,470335,5038650,9000304798),
		T_JBV(274962,470357,5038706,9000304819),
		T_JBV(333528,385265,4602438,9000244366),
		T_JBV(333528,385265,4748878,9000244366),
		T_JBV(345944,470344,5038659,9000304807),
		T_JBV(345944,470366,5038716,9000304828),
		T_JBV(398488,345867,4410842,9000215499),
		T_JBV(392436,345638,4410577,9000215239),
		T_JBV(392436,345863,4410838,9000215497),
		T_JBV(397998,345877,4410853,9000215504),
		T_JBV(397998,345877,4712995,9000215504),
		T_JBV(422290,387752,4616915,9000246393),
		T_JBV(422290,387752,4616895,9000246393),
		T_JBV(427757,405699,4723193,9000259698),
		T_JBV(427757,405699,4719105,9000259698)
				); 
	V_TMP_JBV T_JBV;
    
BEGIN	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ACTUALIZACION TRAMITES, TAREAS Y TRABAJOS CEE DUPLICADOS');
	
	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
	V_TMP_JBV := V_JBV(I);
	
  	ACT_ID := TRIM(V_TMP_JBV(1));
  	
  	TRA_ID := TRIM(V_TMP_JBV(2));

	TAR_ID := TRIM(V_TMP_JBV(3));

	NUM_TRABAJO := TRIM(V_TMP_JBV(4));

	--UPDATE ACT_TRA_TRAMITE
	
	V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.ACT_TRA_TRAMITE WHERE TRA_ID = '||TRA_ID;
	
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS_1;
	
	IF V_NUM_FILAS_1 = 1 THEN
	
		V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_TRA_TRAMITE 
					SET TRA_FECHA_FIN = SYSDATE,
					DD_EPR_ID = 5,
				   	USUARIOMODIFICAR = '''||V_USR||''',
				   	FECHAMODIFICAR = SYSDATE 
				   	WHERE TRA_ID = '||TRA_ID;
	

		EXECUTE IMMEDIATE V_MSQL;
    
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO CON TRA_ID: '||TRA_ID||' ACTUALIZADO');
		
		V_COUNT_UPDATE_1 := V_COUNT_UPDATE_1 + 1;
		
	ELSE
		
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO NO EXISTE');
		
	END IF;

	--UPDATE TAR_TAREAS_NOTIFICACIONES

	V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES WHERE TAR_ID = '||TAR_ID;
	
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS_2;
	
	IF V_NUM_FILAS_2 = 1 THEN
	
		V_MSQL := 'UPDATE '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES 
				   	SET BORRADO = 1,
					TAR_FECHA_FIN = SYSDATE,
					TAR_TAREA_FINALIZADA = 1,
					USUARIOBORRAR = '''||V_USR||''',
					FECHABORRAR = SYSDATE
				   	WHERE TAR_ID = '||TAR_ID;

	
		EXECUTE IMMEDIATE V_MSQL;
    
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO CON TAR_ID: '||TAR_ID||' ACTUALIZADO');
		
		V_COUNT_UPDATE_2 := V_COUNT_UPDATE_2 + 1;
		
	ELSE
		
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO NO EXISTE');
		
	END IF;

	--UPDATE TEX_TAREA_EXTERNA

	V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.ACT_TBJ_TRABAJO WHERE TBJ_NUM_TRABAJO = '||NUM_TRABAJO;
	
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS_3;
	
	IF V_NUM_FILAS_3 = 1 THEN
	
		V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_TBJ_TRABAJO 
				   SET DD_EST_ID = 2,
				   USUARIOMODIFICAR = '''||V_USR||''',
				   FECHAMODIFICAR = SYSDATE 
				   WHERE TBJ_NUM_TRABAJO = '||NUM_TRABAJO;

	
		EXECUTE IMMEDIATE V_MSQL;
    
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO CON TBJ_NUM_TRABAJO: '||NUM_TRABAJO||' ACTUALIZADO');
		
		V_COUNT_UPDATE_3 := V_COUNT_UPDATE_3 + 1;
		
	ELSE
		
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO NO EXISTE');
		
	END IF;
	
	END LOOP;

	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN] Se han updateado en total '||V_COUNT_UPDATE_1||' registros EN ACT_TRA_TRAMITE');

	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN] Se han updateado en total '||V_COUNT_UPDATE_2||' registros EN TAR_TAREAS_NOTIFICACIONES');

	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN] Se han updateado en total '||V_COUNT_UPDATE_3||' registros EN ACT_TBJ_TRABAJO');

	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN]');
	
	COMMIT;
	
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
