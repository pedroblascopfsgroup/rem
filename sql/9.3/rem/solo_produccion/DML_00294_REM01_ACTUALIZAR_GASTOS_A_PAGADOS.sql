--/*
--###########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20200511
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6398
--## PRODUCTO=NO
--## 
--## Finalidad: ACTUALIZAR GASTOS A PAGADO
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  V_NUM_TABLAS_2 NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  GPV_NUM_GASTO NUMBER(16);
  GDE_FECHA_PAGO VARCHAR2(50 CHAR);
  V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
  V_COUNT_INSERT NUMBER(16):= 0; -- Vble. para contar inserts
  V_USUARIO VARCHAR2(100 CHAR) := 'REMVIP-6398';
	
   V_PAR VARCHAR( 32000 CHAR );
   V_RET VARCHAR( 1024 CHAR );  
  
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 

   V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
    --GPV_NUM_GASTO_HAYA, GDE_FECHA_PAGO
T_JBV('10381109','05/10/2018'),
T_JBV('10381108','16/05/2019'),
T_JBV('10370860','07/05/2019'),
T_JBV('10343644','26/04/2019'),
T_JBV('10343592','26/04/2019'),
T_JBV('10343565','28/02/2019'),
T_JBV('10343554','28/03/2019'),
T_JBV('10280319','25/02/2019'),
T_JBV('10398910','21/03/2019'),
T_JBV('10398913','21/03/2019'),
T_JBV('10464365','11/04/2019'),
T_JBV('10493677','15/05/2019'),
T_JBV('10409940','25/03/2019'),
T_JBV('9474949','20/06/2018'),
T_JBV('9199847','06/05/2015'),
T_JBV('9474940','15/06/2018'),
T_JBV('9474942','15/06/2018'),
T_JBV('9474943','15/06/2018'),
T_JBV('9474945','15/06/2018'),
T_JBV('9474946','15/06/2018'),
T_JBV('9474948','15/06/2018'),
T_JBV('9474950','15/06/2018'),
T_JBV('9474951','15/06/2018'),
T_JBV('9562661','15/06/2018'),
T_JBV('9562662','15/06/2018'),
T_JBV('9562663','15/06/2018'),
T_JBV('10340726','17/05/2019'),
T_JBV('10340730','17/05/2019'),
T_JBV('10340732','17/05/2019'),
T_JBV('9199846','06/09/2017'),
T_JBV('9199848','03/07/2017'),
T_JBV('10502170','15/05/2019'),
T_JBV('9208107','02/08/2016'),
T_JBV('9183519','25/06/2016'),
T_JBV('9176972','05/04/2019'),
T_JBV('9171098','05/04/2019'),
T_JBV('9496173','19/04/2018'),
T_JBV('9184237','30/08/2017'),
T_JBV('9182670','30/08/2017'),
T_JBV('9180516','23/12/2016'),
T_JBV('9180157','31/01/2017'),
T_JBV('9175658','12/07/2016'),
T_JBV('9174431','23/12/2016'),
T_JBV('9171911','23/12/2016'),
T_JBV('9171717','27/07/2017'),
T_JBV('9171118','02/08/2016'),
T_JBV('9586370','25/01/2018'),
T_JBV('9556271','25/01/2018'),
T_JBV('9424485','12/12/2017'),
T_JBV('9181775','26/01/2018'),
T_JBV('9497378','16/11/2015'),
T_JBV('9172775','19/01/2018'),
T_JBV('9172774','19/01/2018'),
T_JBV('9208266','19/01/2018'),
T_JBV('9479723','21/03/2018'),
T_JBV('9483645','21/03/2018'),
T_JBV('9186678','19/01/2018'),
T_JBV('9173756','19/01/2018'),
T_JBV('9186516','19/01/2018'),
T_JBV('9180942','19/01/2018'),
T_JBV('9208087','19/01/2018'),
T_JBV('9482543','23/03/2018'),
T_JBV('9464223','17/04/2017'),
T_JBV('9466653','03/10/2017'),
T_JBV('9424264','12/12/2017'),
T_JBV('9483652','16/07/2018'),
T_JBV('9424405','12/12/2017'),
T_JBV('9483624','23/03/2018'),
T_JBV('9479749','21/03/2018'),
T_JBV('9485776','21/03/2018'),
T_JBV('9424219','12/12/2017'),
T_JBV('9431078','12/01/2018'),
T_JBV('9431092','12/01/2018'),
T_JBV('9431075','12/01/2018'),
T_JBV('9431087','12/01/2018'),
T_JBV('9431089','12/01/2018'),
T_JBV('9431088','12/01/2018'),
T_JBV('9431084','12/01/2018'),
T_JBV('9431073','12/01/2018'),
T_JBV('9430470','12/01/2018'),
T_JBV('9430472','12/01/2018'),
T_JBV('9431076','12/01/2018'),
T_JBV('9430465','12/01/2018'),
T_JBV('9430452','12/01/2018'),
T_JBV('9431085','12/01/2018'),
T_JBV('9423470','12/12/2017'),
T_JBV('9423459','12/12/2017'),
T_JBV('9430468','12/01/2018'),
T_JBV('9430453','12/01/2018'),
T_JBV('9431090','12/01/2018'),
T_JBV('9430455','12/01/2018'),
T_JBV('9430456','12/01/2018'),
T_JBV('9423468','12/12/2017'),
T_JBV('9430460','12/01/2018'),
T_JBV('9423469','12/12/2017'),
T_JBV('9431091','12/01/2018'),
T_JBV('9430458','12/01/2018'),
T_JBV('9430459','12/01/2018'),
T_JBV('9483697','21/03/2018'),
T_JBV('9424420','12/12/2017'),
T_JBV('9424332','12/12/2017'),
T_JBV('9424328','12/12/2017'),
T_JBV('9424270','12/12/2017'),
T_JBV('9424456','12/12/2017'),
T_JBV('9424453','12/12/2017'),
T_JBV('9424336','12/12/2017'),
T_JBV('9424229','12/12/2017'),
T_JBV('9424383','12/12/2017'),
T_JBV('9424392','12/12/2017'),
T_JBV('9424459','12/12/2017'),
T_JBV('9424358','12/12/2017'),
T_JBV('9424341','12/12/2017'),
T_JBV('9424406','12/12/2017'),
T_JBV('9424411','12/12/2017'),
T_JBV('9424397','12/12/2017'),
T_JBV('9424425','12/12/2017'),
T_JBV('9424362','12/12/2017'),
T_JBV('9424351','12/12/2017'),
T_JBV('9424356','12/12/2017'),
T_JBV('9424388','12/12/2017'),
T_JBV('9424378','12/12/2017'),
T_JBV('9424366','12/12/2017'),
T_JBV('9424355','12/12/2017'),
T_JBV('9424401','12/12/2017'),
T_JBV('9424261','12/12/2017'),
T_JBV('9424348','12/12/2017'),
T_JBV('9424466','12/12/2017'),
T_JBV('9424426','12/12/2017'),
T_JBV('9424477','12/12/2017'),
T_JBV('9424365','12/12/2017'),
T_JBV('9424239','12/12/2017'),
T_JBV('9424323','12/12/2017'),
T_JBV('9424288','12/12/2017'),
T_JBV('9424440','12/12/2017'),
T_JBV('9424470','12/12/2017'),
T_JBV('9424361','12/12/2017'),
T_JBV('9424218','12/12/2017'),
T_JBV('9424436','12/12/2017'),
T_JBV('9424433','12/12/2017'),
T_JBV('9424479','12/12/2017'),
T_JBV('9424478','12/12/2017'),
T_JBV('9424481','12/12/2017'),
T_JBV('9424305','12/12/2017'),
T_JBV('9424334','12/12/2017'),
T_JBV('9424374','12/12/2017'),
T_JBV('9424480','12/12/2017'),
T_JBV('9424232','12/12/2017'),
T_JBV('9424228','12/12/2017'),
T_JBV('9424482','12/12/2017'),
T_JBV('9424486','12/12/2017'),
T_JBV('9424315','12/12/2017'),
T_JBV('9424450','12/12/2017'),
T_JBV('9424249','12/12/2017'),
T_JBV('9424484','12/12/2017'),
T_JBV('9424380','12/12/2017'),
T_JBV('9424242','12/12/2017'),
T_JBV('9424345','12/12/2017'),
T_JBV('9424301','12/12/2017'),
T_JBV('9424266','12/12/2017'),
T_JBV('9424372','12/12/2017'),
T_JBV('9424487','12/12/2017'),
T_JBV('9424395','12/12/2017'),
T_JBV('9424389','12/12/2017'),
T_JBV('9424393','12/12/2017'),
T_JBV('9424417','12/12/2017'),
T_JBV('9424346','12/12/2017'),
T_JBV('9424489','12/12/2017'),
T_JBV('9424421','12/12/2017'),
T_JBV('9424307','12/12/2017'),
T_JBV('9424463','12/12/2017'),
T_JBV('9424292','12/12/2017'),
T_JBV('9424344','12/12/2017'),
T_JBV('9424483','12/12/2017'),
T_JBV('9424352','12/12/2017'),
T_JBV('9424357','12/12/2017'),
T_JBV('9424376','12/12/2017'),
T_JBV('9424347','12/12/2017'),
T_JBV('9423766','12/12/2017'),
T_JBV('9424367','12/12/2017'),
T_JBV('9423760','12/12/2017'),
T_JBV('9424297','12/12/2017'),
T_JBV('9424403','12/12/2017'),
T_JBV('9424398','12/12/2017'),
T_JBV('9424237','12/12/2017'),
T_JBV('9424412','12/12/2017'),
T_JBV('9424419','12/12/2017'),
T_JBV('9424428','12/12/2017'),
T_JBV('9424423','12/12/2017'),
T_JBV('9424444','12/12/2017'),
T_JBV('9424415','12/12/2017'),
T_JBV('9424255','12/12/2017'),
T_JBV('9424402','12/12/2017'),
T_JBV('9424313','12/12/2017'),
T_JBV('9424274','12/12/2017'),
T_JBV('9424260','12/12/2017'),
T_JBV('9424287','12/12/2017'),
T_JBV('9424282','12/12/2017'),
T_JBV('9424285','12/12/2017'),
T_JBV('9424435','12/12/2017'),
T_JBV('9424291','12/12/2017'),
T_JBV('9424431','12/12/2017'),
T_JBV('9424295','12/12/2017'),
T_JBV('9424317','12/12/2017'),
T_JBV('9424309','12/12/2017'),
T_JBV('9424306','12/12/2017'),
T_JBV('9424278','12/12/2017'),
T_JBV('9424468','12/12/2017'),
T_JBV('9424424','12/12/2017'),
T_JBV('9424316','12/12/2017'),
T_JBV('9424281','12/12/2017'),
T_JBV('9424299','12/12/2017'),
T_JBV('9423758','12/12/2017'),
T_JBV('9424331','12/12/2017'),
T_JBV('9424303','12/12/2017'),
T_JBV('9424473','12/12/2017'),
T_JBV('9424320','12/12/2017'),
T_JBV('9424319','12/12/2017'),
T_JBV('9424335','12/12/2017'),
T_JBV('9424326','12/12/2017'),
T_JBV('9424339','12/12/2017'),
T_JBV('9424324','12/12/2017'),
T_JBV('9423764','12/12/2017'),
T_JBV('9424240','12/12/2017'),
T_JBV('9424223','12/12/2017'),
T_JBV('9424236','12/12/2017'),
T_JBV('9423762','12/12/2017'),
T_JBV('9424243','12/12/2017'),
T_JBV('9424246','12/12/2017'),
T_JBV('9424340','12/12/2017'),
T_JBV('9424271','12/12/2017'),
T_JBV('9199849','12/12/2017'),
T_JBV('9424350','12/12/2017'),
T_JBV('9423755','12/12/2017'),
T_JBV('9483574','23/03/2018'),
T_JBV('9483636','23/03/2018'),
T_JBV('9424432','12/01/2018'),
T_JBV('9424454','12/01/2018'),
T_JBV('9424443','12/01/2018'),
T_JBV('9424451','12/01/2018'),
T_JBV('9424460','12/01/2018'),
T_JBV('9424464','12/01/2018'),
T_JBV('9424462','12/01/2018'),
T_JBV('9479754','21/03/2018'),
T_JBV('9483680','21/03/2018')


	); 
	V_TMP_JBV T_JBV;
    
BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');

	 
    -- LOOP  -----------------------------------------------------------------
    DBMS_OUTPUT.PUT_LINE('[INFO]: CAMBIAR ESTADO A PAGADO Y PONER FECHA PAGO');
   FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
	V_TMP_JBV := V_JBV(I);

  	GPV_NUM_GASTO := TRIM(V_TMP_JBV(1));
  	
  	GDE_FECHA_PAGO := TRIM(V_TMP_JBV(2));


	V_MSQL := 'UPDATE '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR SET DD_EGA_ID = 5 
					, USUARIOMODIFICAR = '''||V_USUARIO||'''
					, FECHAMODIFICAR = SYSDATE
			WHERE GPV_NUM_GASTO_HAYA = '||GPV_NUM_GASTO||'';
				
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZADO CORRECTAMENTE EL ESTADO DEL GASTO '''||GPV_NUM_GASTO||''' ');

	V_MSQL := 'UPDATE '||V_ESQUEMA||'.GDE_GASTOS_DETALLE_ECONOMICO SET GDE_FECHA_PAGO = TO_DATE('''||GDE_FECHA_PAGO||''',''DD/MM/YYYY'')
					, USUARIOMODIFICAR = '''||V_USUARIO||'''
					, FECHAMODIFICAR = SYSDATE
			WHERE GPV_ID = (SELECT GPV_ID FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR WHERE GPV_NUM_GASTO_HAYA = '||GPV_NUM_GASTO||')';
				
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZADA CORRECTAMENTE FECHA_PAGO DEL GASTO '''||GPV_NUM_GASTO||'''');

	V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
			
		
    END LOOP;
    COMMIT;
   
	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN] Se han updateado en total '||V_COUNT_UPDATE||' GASTOS ');

	DBMS_OUTPUT.PUT_LINE('********************************************************************');


   DBMS_OUTPUT.PUT_LINE('[FIN] ');

EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
