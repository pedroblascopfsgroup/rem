--/*
--###########################################
--## AUTOR=GUILLEM REY
--## FECHA_CREACION=20200520
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-7340
--## PRODUCTO=NO
--## 
--## Finalidad: ELIMINAR TAREAS DUPLICADAS Y REPOSICIONAR TRAMITES
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 VersiÃ³n inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  V_USUARIO VARCHAR2(100 CHAR) := 'REMVIP-7340';
  USU_ID  NUMBER(16);
  V_TRA_ID  NUMBER(16);
  V_TARS VARCHAR2(4000 CHAR);
  PL_OUTPUT VARCHAR2(32000 CHAR);
  TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	

	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
		T_JBV(916870600001),
		T_JBV(916860100001),
		T_JBV(916777600001),
		T_JBV(916441000001),
		T_JBV(915734900001),
		T_JBV(916868300001),
		T_JBV(914435600001),
		T_JBV(915754000001),
		T_JBV(915066300001),
		T_JBV(916442600001),
		T_JBV(915750000001),
		T_JBV(914435000001),
		T_JBV(915675700001),
		T_JBV(915463900001),
		T_JBV(916824900001),
		T_JBV(916928600003),
		T_JBV(916826100001),
		T_JBV(915816300001),
		T_JBV(915680300001),
		T_JBV(915092900001),
		T_JBV(916747500001),
		T_JBV(915044000001),
		T_JBV(916480700001),
		T_JBV(916777600002),
		T_JBV(916824900002),
		T_JBV(915464000001),
		T_JBV(916759900001),
		T_JBV(916850200001),
		T_JBV(916823300001),
		T_JBV(916947800001),
		T_JBV(916173500001),
		T_JBV(916633000001),
		T_JBV(916013700001),
		T_JBV(914960000001),
		T_JBV(916933500001),
		T_JBV(916078900001),
		T_JBV(916341100001),
		T_JBV(916439900001),
		T_JBV(916612600001),
		T_JBV(915710700001),
		T_JBV(916845000001),
		T_JBV(916928700003),
		T_JBV(916928600002),
		T_JBV(916057800001),
		T_JBV(916839500001),
		T_JBV(916787500002),
		T_JBV(914535000001),
		T_JBV(916922800001),
		T_JBV(916234100001),
		T_JBV(915393700001),
		T_JBV(916889700001),
		T_JBV(914861100001),
		T_JBV(914952200001),
		T_JBV(916341300001),
		T_JBV(916493900001),
		T_JBV(916697900001),
		T_JBV(916706300001),
		T_JBV(916747900001),
		T_JBV(916839700001),
		T_JBV(914435000002),
		T_JBV(916040100001),
		T_JBV(916669100001),
		T_JBV(915044100001),
		T_JBV(916659200001),
		T_JBV(916669600001),
		T_JBV(916780600001),
		T_JBV(916759300001),
		T_JBV(914539900001),
		T_JBV(916491900001),
		T_JBV(916491300001),
		T_JBV(916826000001),
		T_JBV(916843300001),
		T_JBV(916645600001),
		T_JBV(916491400001),
		T_JBV(916491400002),
		T_JBV(916734300001),
		T_JBV(916574100001),
		T_JBV(916129600001),
		T_JBV(916391400001),
		T_JBV(916928600001),
		T_JBV(916928700002),
		T_JBV(916425400001),
		T_JBV(916680500001),
		T_JBV(916885900001),
		T_JBV(916824900003),
		T_JBV(916637600001),
		T_JBV(916664000001),
		T_JBV(916571400001),
		T_JBV(916863000001),
		T_JBV(916571500001),
		T_JBV(916912700001),
		T_JBV(916381900001),
		T_JBV(916025900001),
		T_JBV(916841600001),
		T_JBV(916787500001),
		T_JBV(916818800001),
		T_JBV(916928700001),
		T_JBV(916513700001),
		T_JBV(914301600001),
		T_JBV(916450000001),
		T_JBV(916752600001),
		T_JBV(916810000001)
	); 
	V_TMP_JBV T_JBV;
BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');

	
	
	FOR I IN V_JBV.FIRST .. V_JBV.LAST	
	LOOP 
		V_TMP_JBV := V_JBV(I);
		
		V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_TBJ_TRABAJO WHERE TBJ_NUM_TRABAJO = '||TRIM(V_TMP_JBV(1));
		EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;
		
		IF V_NUM_TABLAS > 0 THEN
			V_MSQL := 'SELECT TRA_ID FROM '||V_ESQUEMA||'.ACT_TRA_TRAMITE WHERE TBJ_ID = (SELECT TBJ_ID FROM '||V_ESQUEMA||'.ACT_TBJ_TRABAJO WHERE TBJ_NUM_TRABAJO = '||TRIM(V_TMP_JBV(1))||') AND BORRADO = 0';
			EXECUTE IMMEDIATE V_MSQL INTO V_TRA_ID;
			
			--Cierre Economico
			--NUM TAREAS CERRADAS
			V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES 
						WHERE TAR_ID IN (SELECT TAC.TAR_ID FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
										INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
										INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
										WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_CierreEconomico'') AND TAR_TAREA_FINALIZADA = 1';
			EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;
			
			IF V_NUM_TABLAS = 0 THEN 
			
				--NUM TAREAS ACTIVAS
				V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES 
						WHERE TAR_ID IN (SELECT TAC.TAR_ID FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
										INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
										INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
										WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_CierreEconomico'') AND TAR_TAREA_FINALIZADA = 0';
				EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;
		
				IF V_NUM_TABLAS > 1 THEN
				
					--ELIMINAR ACTIVAS MENOS 1
					V_MSQL := 'SELECT LISTAGG(TAR_ID,'','') WITHIN GROUP (ORDER BY TAR_ID) AS TAREAS
							FROM (SELECT TAR.TAR_ID 
							    ,ROW_NUMBER() OVER (PARTITION BY TAC.TRA_ID ORDER BY TAR.TAR_ID ASC) AS RN
							    FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
							    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
							    INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
							    INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
							    WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_CierreEconomico'') 
							WHERE RN > 1';
					EXECUTE IMMEDIATE V_MSQL INTO V_TARS;
					
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR WHERE TEX_ID IN (SELECT TEX_ID FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||'))';
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ETN_EXTAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
					EXECUTE IMMEDIATE V_MSQL;
					
					--PREPARAR EL ALTA_BPM_INSTANCES
					V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_TRA_TRAMITE SET TRA_PROCESS_BPM = NULL WHERE TRA_ID = '||V_TRA_ID;
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'UPDATE '||V_ESQUEMA||'.TEX_TAREA_EXTERNA SET TEX_TOKEN_ID_BPM = NULL WHERE TAR_ID = (SELECT TAR_ID FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES 
									WHERE TAR_ID IN (SELECT TAC.TAR_ID FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
										INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
										INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
										WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_CierreEconomico'') AND TAR_TAREA_FINALIZADA = 0)';
					EXECUTE IMMEDIATE V_MSQL;
					
				--NUM TAREAS ACTIVAS
				ELSIF V_NUM_TABLAS = 1 THEN
				
					--PREPARAR EL ALTA_BPM_INSTANCES
					V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_TRA_TRAMITE SET TRA_PROCESS_BPM = NULL WHERE TRA_ID = '||V_TRA_ID;
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'UPDATE '||V_ESQUEMA||'.TEX_TAREA_EXTERNA SET TEX_TOKEN_ID_BPM = NULL WHERE TAR_ID = (SELECT TAR_ID FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES 
									WHERE TAR_ID IN (SELECT TAC.TAR_ID FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
										INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
										INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
										WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_CierreEconomico'') AND TAR_TAREA_FINALIZADA = 0)';
					EXECUTE IMMEDIATE V_MSQL;
					
				END IF;
				
			--NUM TAREAS CERRADAS	
			ELSIF V_NUM_TABLAS > 1 THEN
			
				--ELIMINAR CERRADAS MENOS 1
				V_MSQL := 'SELECT LISTAGG(TAR_ID,'','') WITHIN GROUP (ORDER BY TAR_ID) AS TAREAS
							FROM (SELECT TAR.TAR_ID 
							    ,ROW_NUMBER() OVER (PARTITION BY TAC.TRA_ID ORDER BY TAR.TAR_FECHA_FIN ASC) AS RN
							    FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
							    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
							    INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
							    INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
							    WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_CierreEconomico'' AND TAR.TAR_FECHA_FIN IS NOT NULL) 
							WHERE RN > 1';
				EXECUTE IMMEDIATE V_MSQL INTO V_TARS;
				
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR WHERE TEX_ID IN (SELECT TEX_ID FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||'))';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ETN_EXTAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				
				--CERRAR TRAMITE
				V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_TRA_TRAMITE SET TRA_FECHA_FIN = SYSDATE, DD_EPR_ID = 5, USUARIOMODIFICAR = '''||V_USUARIO||''', FECHAMODIFICAR = SYSDATE WHERE TRA_ID = '||V_TRA_ID;
				EXECUTE IMMEDIATE V_MSQL;
				
				--ELIMINAR ACTIVAS
				V_MSQL := 'SELECT LISTAGG(TAC.TAR_ID,'','') WITHIN GROUP (ORDER BY TAC.TAR_ID) AS TAREAS
						    FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
						    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
						    INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
						    INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
						    WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_CierreEconomico'' AND TAR.TAR_FECHA_FIN IS NULL';
				EXECUTE IMMEDIATE V_MSQL INTO V_TARS;
					
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR WHERE TEX_ID IN (SELECT TEX_ID FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||'))';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ETN_EXTAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				
			--NUM TAREAS CERRADAS = 1
			ELSE
			
				--CERRAR TRAMITE
				V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_TRA_TRAMITE SET TRA_FECHA_FIN = SYSDATE, DD_EPR_ID = 5, USUARIOMODIFICAR = '''||V_USUARIO||''', FECHAMODIFICAR = SYSDATE WHERE TRA_ID = '||V_TRA_ID;
				EXECUTE IMMEDIATE V_MSQL;
				
				--ELIMINAR ACTIVAS
				V_MSQL := 'SELECT LISTAGG(TAC.TAR_ID,'','') WITHIN GROUP (ORDER BY TAC.TAR_ID) AS TAREAS
						    FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
						    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
						    INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
						    INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
						    WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_CierreEconomico'' AND TAR.TAR_FECHA_FIN IS NULL';
				EXECUTE IMMEDIATE V_MSQL INTO V_TARS;
				
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR WHERE TEX_ID IN (SELECT TEX_ID FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||'))';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ETN_EXTAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;				
				
			END IF;
			
			
			--Validacion Trabajo
			--NUM TAREAS CERRADAS
			V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES 
						WHERE TAR_ID IN (SELECT TAC.TAR_ID FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
										INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
										INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
										WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ValidacionTrabajo'') AND TAR_TAREA_FINALIZADA = 1';
			EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;
			
			IF V_NUM_TABLAS = 0 THEN 
			
				--NUM TAREAS ACTIVAS
				V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES 
						WHERE TAR_ID IN (SELECT TAC.TAR_ID FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
										INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
										INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
										WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ValidacionTrabajo'') AND TAR_TAREA_FINALIZADA = 0';
				EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;
		
				--NUM TAREAS ACTIVAS
				IF V_NUM_TABLAS > 1 THEN
				
					--ELIMINAR ACTIVAS MENOS 1
					V_MSQL := 'SELECT LISTAGG(TAR_ID,'','') WITHIN GROUP (ORDER BY TAR_ID) AS TAREAS
							FROM (SELECT TAR.TAR_ID 
							    ,ROW_NUMBER() OVER (PARTITION BY TAC.TRA_ID ORDER BY TAR.TAR_ID ASC) AS RN
							    FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
							    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
							    INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
							    INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
							    WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ValidacionTrabajo'') 
							WHERE RN > 1';
					EXECUTE IMMEDIATE V_MSQL INTO V_TARS;
					
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR WHERE TEX_ID IN (SELECT TEX_ID FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||'))';
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ETN_EXTAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
					EXECUTE IMMEDIATE V_MSQL;
					
					--PREPARAR ALTA_BPM_INSTANCES
					V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_TRA_TRAMITE SET TRA_PROCESS_BPM = NULL WHERE TRA_ID = '||V_TRA_ID;
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'UPDATE '||V_ESQUEMA||'.TEX_TAREA_EXTERNA SET TEX_TOKEN_ID_BPM = NULL WHERE TAR_ID = (SELECT TAR_ID FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES 
									WHERE TAR_ID IN (SELECT TAC.TAR_ID FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
										INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
										INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
										WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ValidacionTrabajo'') AND TAR_TAREA_FINALIZADA = 0)';
					EXECUTE IMMEDIATE V_MSQL;
				
				--NUM TAREAS ACTIVAS
				ELSIF V_NUM_TABLAS = 1 THEN
				
					--PREPARAR ALTA_BPM_INSTANCES
					V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_TRA_TRAMITE SET TRA_PROCESS_BPM = NULL WHERE TRA_ID = '||V_TRA_ID;
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'UPDATE '||V_ESQUEMA||'.TEX_TAREA_EXTERNA SET TEX_TOKEN_ID_BPM = NULL WHERE TAR_ID = (SELECT TAR_ID FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES 
									WHERE TAR_ID IN (SELECT TAC.TAR_ID FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
										INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
										INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
										WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ValidacionTrabajo'') AND TAR_TAREA_FINALIZADA = 0)';
					EXECUTE IMMEDIATE V_MSQL;
					
				END IF;
			
			--NUM TAREAS CERRADAS
			ELSIF V_NUM_TABLAS > 1 THEN
			
				--ELIMINAR CERRADAS MENOS 1
				V_MSQL := 'SELECT LISTAGG(TAR_ID,'','') WITHIN GROUP (ORDER BY TAR_ID) AS TAREAS
							FROM (SELECT TAR.TAR_ID 
							    ,ROW_NUMBER() OVER (PARTITION BY TAC.TRA_ID ORDER BY TAR.TAR_FECHA_FIN ASC) AS RN
							    FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
							    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
							    INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
							    INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
							    WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ValidacionTrabajo'' AND TAR.TAR_FECHA_FIN IS NOT NULL) 
							WHERE RN > 1';
				EXECUTE IMMEDIATE V_MSQL INTO V_TARS;
				
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR WHERE TEX_ID IN (SELECT TEX_ID FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||'))';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ETN_EXTAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				
				--ELIMINAR ACTIVAS
				V_MSQL := 'SELECT LISTAGG(TAC.TAR_ID,'','') WITHIN GROUP (ORDER BY TAC.TAR_ID) AS TAREAS
						    FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
						    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
						    INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
						    INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
						    WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ValidacionTrabajo'' AND TAR.TAR_FECHA_FIN IS NULL';
				EXECUTE IMMEDIATE V_MSQL INTO V_TARS;
					
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR WHERE TEX_ID IN (SELECT TEX_ID FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||'))';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ETN_EXTAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				
			--NUM TAREAS CERRADAS = 1
			ELSE
			
				--ELIMINAR ACTIVAS
				V_MSQL := 'SELECT LISTAGG(TAC.TAR_ID,'','') WITHIN GROUP (ORDER BY TAC.TAR_ID) AS TAREAS
						    FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
						    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
						    INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
						    INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
						    WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ValidacionTrabajo'' AND TAR.TAR_FECHA_FIN IS NULL';
				EXECUTE IMMEDIATE V_MSQL INTO V_TARS;
					
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR WHERE TEX_ID IN (SELECT TEX_ID FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||'))';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ETN_EXTAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				
			END IF;
			
			
			--Resultado Tarificada
			--NUM TAREAS CERRADAS
			V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES 
						WHERE TAR_ID IN (SELECT TAC.TAR_ID FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
										INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
										INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
										WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ResultadoTarificada'') AND TAR_TAREA_FINALIZADA = 1';
			EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;
			
			IF V_NUM_TABLAS = 0 THEN 
			
				--NUM TAREAS ACTIVAS
				V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES 
						WHERE TAR_ID IN (SELECT TAC.TAR_ID FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
										INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
										INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
										WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ResultadoTarificada'') AND TAR_TAREA_FINALIZADA = 0';
				EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;
		
				--NUM TAREAS ACTIVAS
				IF V_NUM_TABLAS > 1 THEN
				
					--ELIMINAR ACTIVAS MENOS 1
					V_MSQL := 'SELECT LISTAGG(TAR_ID,'','') WITHIN GROUP (ORDER BY TAR_ID) AS TAREAS
							FROM (SELECT TAR.TAR_ID 
							    ,ROW_NUMBER() OVER (PARTITION BY TAC.TRA_ID ORDER BY TAR.TAR_ID ASC) AS RN
							    FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
							    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
							    INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
							    INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
							    WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ResultadoTarificada'') 
							WHERE RN > 1';
					EXECUTE IMMEDIATE V_MSQL INTO V_TARS;
					
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR WHERE TEX_ID IN (SELECT TEX_ID FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||'))';
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ETN_EXTAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
					EXECUTE IMMEDIATE V_MSQL;
					
					--PREPARAR ALTA_BPM_INSTANCES
					V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_TRA_TRAMITE SET TRA_PROCESS_BPM = NULL WHERE TRA_ID = '||V_TRA_ID;
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'UPDATE '||V_ESQUEMA||'.TEX_TAREA_EXTERNA SET TEX_TOKEN_ID_BPM = NULL WHERE TAR_ID = (SELECT TAR_ID FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES 
									WHERE TAR_ID IN (SELECT TAC.TAR_ID FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
										INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
										INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
										WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ResultadoTarificada'') AND TAR_TAREA_FINALIZADA = 0)';
					EXECUTE IMMEDIATE V_MSQL;
				
				--NUM TAREAS ACTIVAS
				ELSIF V_NUM_TABLAS = 1 THEN
				
					--PREPARAR ALTA_BPM_INSTANCES
					V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_TRA_TRAMITE SET TRA_PROCESS_BPM = NULL WHERE TRA_ID = '||V_TRA_ID;
					EXECUTE IMMEDIATE V_MSQL;
					V_MSQL := 'UPDATE '||V_ESQUEMA||'.TEX_TAREA_EXTERNA SET TEX_TOKEN_ID_BPM = NULL WHERE TAR_ID = (SELECT TAR_ID FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES 
									WHERE TAR_ID IN (SELECT TAC.TAR_ID FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
										INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
										INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
										WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ResultadoTarificada'') AND TAR_TAREA_FINALIZADA = 0)';
					EXECUTE IMMEDIATE V_MSQL;
					
				END IF;
			
			--NUM TAREAS CERRADAS
			ELSIF V_NUM_TABLAS > 1 THEN
			
				--ELIMINAR CERRADAS MENOS 1
				V_MSQL := 'SELECT LISTAGG(TAR_ID,'','') WITHIN GROUP (ORDER BY TAR_ID) AS TAREAS
							FROM (SELECT TAR.TAR_ID 
							    ,ROW_NUMBER() OVER (PARTITION BY TAC.TRA_ID ORDER BY TAR.TAR_FECHA_FIN ASC) AS RN
							    FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
							    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
							    INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
							    INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
							    WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ResultadoTarificada'' AND TAR.TAR_FECHA_FIN IS NOT NULL) 
							WHERE RN > 1';
				EXECUTE IMMEDIATE V_MSQL INTO V_TARS;
				
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR WHERE TEX_ID IN (SELECT TEX_ID FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||'))';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ETN_EXTAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				
				--ELIMINAR ACTIVAS
				V_MSQL := 'SELECT LISTAGG(TAC.TAR_ID,'','') WITHIN GROUP (ORDER BY TAC.TAR_ID) AS TAREAS
						    FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
						    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
						    INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
						    INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
						    WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ResultadoTarificada'' AND TAR.TAR_FECHA_FIN IS NULL';
				EXECUTE IMMEDIATE V_MSQL INTO V_TARS;
					
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR WHERE TEX_ID IN (SELECT TEX_ID FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||'))';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ETN_EXTAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				
			--NUM TAREAS CERRADAS = 1
			ELSE
			
				--ELIMINAR ACTIVAS
				V_MSQL := 'SELECT LISTAGG(TAC.TAR_ID,'','') WITHIN GROUP (ORDER BY TAC.TAR_ID) AS TAREAS
						    FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC
						    INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID
						    INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID
						    INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID
						    WHERE TAC.TRA_ID = '||V_TRA_ID||' AND TAP.TAP_CODIGO = ''T004_ResultadoTarificada'' AND TAR.TAR_FECHA_FIN IS NULL';
				EXECUTE IMMEDIATE V_MSQL INTO V_TARS;
					
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR WHERE TEX_ID IN (SELECT TEX_ID FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||'))';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TEX_TAREA_EXTERNA WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ETN_EXTAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES WHERE TAR_ID IN ('||TRIM(V_TARS)||')';
				EXECUTE IMMEDIATE V_MSQL;
				
			END IF;
					
		END IF;
	
	END LOOP;
	
	#ESQUEMA#.ALTA_BPM_INSTANCES(V_USUARIO, PL_OUTPUT);
	
    COMMIT;
	
   	DBMS_OUTPUT.PUT_LINE('[FIN] ');
	
EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecuciÃ³n:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
