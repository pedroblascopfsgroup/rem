--/*
--##########################################
--## AUTOR=Carles Molins
--## FECHA_CREACION=20200602
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-7414
--## PRODUCTO=NO
--##
--## Finalidad:
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USUARIOMODIFICAR VARCHAR2(25 CHAR):= 'REMVIP-7414'; -- Configuracion Esquema

BEGIN	        

    DBMS_OUTPUT.PUT_LINE('[INICIO]');
			
	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_PVC_PROVEEDOR_CONTACTO T1
				USING (
				    SELECT PVE.PVE_ID, PVE.DD_PRV_ID, PVE.DD_TDI_ID, PVE.PVE_DOCIDENTIF, 
				        CASE WHEN PVE.PVE_NOMBRE IS NOT NULL 
				            THEN PVE_NOMBRE
				            ELSE PVE.PVE_NOMBRE_COMERCIAL
				        END PVE_NOMBRE,
				        PVE.PVE_CP, PVE.PVE_DIRECCION, PVE_TELF1, PVE_TELF2, PVE_FAX, PVE_EMAIL,
				        PVE_FECHA_ALTA, PVE_FECHA_BAJA
				    FROM '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR PVE
				    LEFT JOIN '||V_ESQUEMA||'.ACT_PVC_PROVEEDOR_CONTACTO PVC ON PVE.PVE_ID = PVC.PVE_ID
				    WHERE PVC.PVC_ID IS NULL AND DD_EPR_ID = 4
				    AND PVE_COD_REM IN (
				    3000,
				    3996,
				    110061028,
				    110065129,
				    110073951,
				    110074602,
				    110082511,
				    110098137,
				    110103313,
				    110103592,
				    110107995,
				    110113502,
				    110113701,
				    110113705,
				    110113871,
				    110114287,
				    110114383,
				    110115293,
				    110115433,
				    110115468,
				    110115540,
				    110115924,
				    110115932,
				    110116171,
				    110116334,
				    110116709,
				    110128995,
				    110158601,
				    110158712,
				    110158789,
				    110158862,
				    110158943,
				    110161113,
				    110163888,
				    110163902,
				    110165247,
				    110165253,
				    110165287,
				    110165569,
				    110166513,
				    110166767,
				    110166785,
				    110167578,
				    110082814,
				    110098164,
				    110102868,
				    110103018,
				    110114150,
				    110115334,
				    110115379,
				    110116091,
				    110155485,
				    110155735,
				    110155841,
				    110158317,
				    110158502,
				    110158987,
				    110161388,
				    110161389,
				    110161479,
				    110161810,
				    110161855,
				    110076153,
				    110076154,
				    110117005,
				    10033562 ,
				    110061008,
				    110065065,
				    110073140,
				    110080883,
				    110081006,
				    110081039,
				    110082715,
				    110097738,
				    110098100,
				    110098494,
				    110099900,
				    110099901,
				    110099902,
				    110103085,
				    110113408,
				    110113898,
				    110115394,
				    110116875,
				    110116905,
				    110117269,
				    110117302,
				    110128558,
				    110128592,
				    110128602,
				    110155762,
				    110155765,
				    110156889,
				    110156893,
				    110156940,
				    110156942,
				    110156946,
				    110156995,
				    110157145,
				    110158290,
				    110158435,
				    110158436,
				    110158861,
				    110158866,
				    110158867,
				    110159247,
				    110159352,
				    110159460,
				    110161020,
				    110161022,
				    110061003,
				    110061004,
				    110073952,
				    110074142,
				    110074143,
				    110074144,
				    110074145,
				    110074146,
				    110074250,
				    110074603,
				    110074727,
				    110075081,
				    110078522,
				    110081028,
				    110081037,
				    110081090,
				    110081794,
				    110081912,
				    110081913,
				    110081914,
				    110081915,
				    110082129,
				    110082256,
				    110082371,
				    110082985,
				    110097650,
				    110097848,
				    110098133,
				    110098472,
				    110112716,
				    110112734,
				    110112741,
				    110112780,
				    110112818,
				    110112819,
				    110112909,
				    110112931,
				    110112955,
				    110113006,
				    110113007,
				    110113494,
				    110113495,
				    110113497,
				    110113517,
				    110113580,
				    110113583,
				    110113743,
				    110113874,
				    110113894,
				    110113896,
				    110114074,
				    110114097,
				    110114131,
				    110114132,
				    110114253,
				    110114292,
				    110114294,
				    110114355,
				    110114954,
				    110115226,
				    110115373,
				    110115376,
				    110115386,
				    110115429,
				    110115431,
				    110115434,
				    110115460,
				    110115465,
				    110115496,
				    110115519,
				    110115558,
				    110115690,
				    110115925,
				    110115934,
				    110115958,
				    110115959,
				    110115962,
				    110116045,
				    110116089,
				    110116092,
				    110116100,
				    110116102,
				    110116127,
				    110116153,
				    110116169,
				    110116173,
				    110116176,
				    110116181,
				    110116194,
				    110116201,
				    110116236,
				    110116237,
				    110116316,
				    110116329,
				    110116333,
				    110116368,
				    110116481,
				    110116623,
				    110116635,
				    110116728,
				    110116736,
				    110116748,
				    110117036,
				    110117041,
				    110117124,
				    110117125,
				    110117151,
				    110117381,
				    110117382,
				    110117476,
				    110117477,
				    110117480,
				    110117728,
				    110117731,
				    110117734,
				    110117817,
				    110117911,
				    110117913,
				    110117958,
				    110118043,
				    110118313,
				    110128603,
				    110128959,
				    110128965,
				    110129030,
				    110155415,
				    110155501,
				    110155694,
				    110155702,
				    110155724,
				    110155904,
				    110156754,
				    110156804,
				    110156849,
				    110156859,
				    110157025,
				    110157114,
				    110158431,
				    110158563,
				    110158868,
				    110159242,
				    110159307,
				    110159365,
				    110159451,
				    110159551,
				    110159552,
				    110161070,
				    110161103,
				    110161114,
				    110161149,
				    110161214,
				    110161295,
				    110161668,
				    110161866,
				    110162300,
				    110162717,
				    110162719,
				    110165227,
				    110165235,
				    110165290,
				    110165335,
				    110165393,
				    110165399,
				    110165471,
				    110165484,
				    110165485,
				    110165518,
				    110165588,
				    110165608,
				    110165627,
				    110165669,
				    110165671,
				    110165673,
				    110165966,
				    110165976,
				    110165977,
				    110166219,
				    110166221,
				    110166299,
				    110166448,
				    110166449,
				    110166463,
				    110166475,
				    110166793,
				    110166918,
				    110167028,
				    110167062,
				    110167109,
				    110167111,
				    110167122,
				    110167160,
				    110167175,
				    110167264,
				    110167265,
				    110077959,
				    110077960,
				    110078529,
				    110078530,
				    110081026,
				    110081578,
				    110081580,
				    110082200,
				    110082319,
				    110103607,
				    110103777,
				    110112779,
				    110113584,
				    110114379,
				    110115327,
				    110115367,
				    110115961,
				    110116096,
				    110116101,
				    110116238,
				    110116315,
				    110116480,
				    110128260,
				    110156755,
				    110156897,
				    110156900,
				    110158559,
				    110158561,
				    110161227,
				    110163860,
				    110166805,
				    110167485,
				    110167512,
				    10011890 ,
				    110075830,
				    110097806,
				    110114128,
				    110118014,
				    110118054,
				    110118316,
				    110118317,
				    110118318,
				    110156842,
				    110156843,
				    110158599,
				    10012081 ,
				    110074383,
				    110079032,
				    110080815,
				    110082800,
				    110115550,
				    110116128,
				    110116487,
				    110117264,
				    110118048,
				    110118145,
				    110128647,
				    110128982,
				    110155555,
				    110155792,
				    110156939,
				    110156991,
				    110157023,
				    110159753,
				    110160344,
				    110160858,
				    110161019,
				    110161383,
				    110161384,
				    110129044,
				    10011840 ,
				    10011841 ,
				    10011842 ,
				    110116239,
				    110128969,
				    110163424,
				    110116186,
				    110128318,
				    110128320,
				    110155321,
				    110155860,
				    110163896,
				    110164776,
				    110164777,
				    110164779,
				    110164780,
				    110165649,
				    110166301,
				    110166995,
				    110167527,
				    110167528,
				    110169247,
				    110163863,
				    110165545,
				    110165629,
				    110166566,
				    110166749,
				    110169933,
				    110161440,
				    110161754,
				    110161761,
				    110162727,
				    110162840,
				    110163450,
				    110165248,
				    110165801,
				    110166162,
				    110166186,
				    110166450,
				    110166714,
				    110166786,
				    110167180,
				    110169922,
				    110169923,
				    110167281,
				    110167295,
				    110167303,
				    110167310,
				    110167319,
				    110167322,
				    110167459,
				    110167461,
				    110167463,
				    110167483,
				    110167529,
				    110167587,
				    110167606,
				    110167719,
				    110169230,
				    110169232,
				    110169233,
				    110169234,
				    110169236,
				    110169237,
				    110169258,
				    110169261,
				    110169436,
				    110169438,
				    110169457,
				    110169488,
				    110169511,
				    110169867,
				    110169868,
				    110169947,
				    110169965,
				    110169967,
				    110169970,
				    110169972,
				    110169983,
				    110169984,
				    110169985,
				    110170026,
				    110170033,
				    110170034,
				    110169948,
				    110170014,
				    110166701,
				    110166841,
				    110170129,
				    110170175,
				    110186249,
				    110186282,
				    110186285,
				    110186286,
				    110186288,
				    110186290,
				    110186321,
				    110186324,
				    110186340,
				    110186341,
				    110186343,
				    110186356,
				    110186358,
				    110186370,
				    110186372,
				    110186373,
				    110186395,
				    110186398,
				    110186416,
				    110186420,
				    110186417,
				    110186428,
				    110186390,
				    110186427,
				    110186463,
				    110186465,
				    110186497,
				    110186526,
				    110186535,
				    110186592,
				    110186636,
				    110186639,
				    110186642,
				    110187010,
				    110187011,
				    110187012,
				    110187013,
				    110187015,
				    110187017,
				    110187018,
				    110187030,
				    110187033,
				    110187124,
				    110187128,
				    110187129,
				    110187143,
				    110187152,
				    110187155,
				    110187157,
				    110187158,
				    110187159,
				    110187160,
				    110187176,
				    110187202,
				    110187205,
				    110187208,
				    110187229,
				    110187230
				    )
				) T2
				ON (T1.PVE_ID = T2.PVE_ID)
				WHEN NOT MATCHED THEN INSERT (
				    T1.PVC_ID, T1.PVE_ID, T1.DD_PRV_ID, T1.DD_TDI_ID, T1.PVC_DOCIDENTIF, T1.PVC_NOMBRE, T1.PVC_CP, T1.PVC_DIRECCION,
				    T1.PVC_TELF1, T1.PVC_TELF2, T1.PVC_FAX, T1.PVC_EMAIL, T1.VERSION, T1.USUARIOCREAR, T1.FECHACREAR, T1.BORRADO,
				    T1.PVC_PRINCIPAL, T1.PVC_FECHA_ALTA, T1.PVC_FECHA_BAJA
				) VALUES (
				    '||V_ESQUEMA||'.S_ACT_PVC_PROVEEDOR_CONTACTO.NEXTVAL, T2.PVE_ID, T2.DD_PRV_ID, T2.DD_TDI_ID, T2.PVE_DOCIDENTIF,
				    T2.PVE_NOMBRE, T2.PVE_CP, T2.PVE_DIRECCION, T2.PVE_TELF1, T2.PVE_TELF2, T2.PVE_FAX, T2.PVE_EMAIL,
				    0, ''REMVIP-7414'', SYSDATE, 0, 1, T2.PVE_FECHA_ALTA, T2.PVE_FECHA_BAJA
				)';

	EXECUTE IMMEDIATE V_MSQL;
    DBMS_OUTPUT.PUT_LINE('	[INFO]	Se han insertado '||SQL%ROWCOUNT||' proveedores contacto.' );

    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
	WHEN OTHERS THEN
	err_num := SQLCODE;
	err_msg := SQLERRM;
	
	DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
	DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
	DBMS_OUTPUT.put_line(err_msg);
	
	ROLLBACK;
	RAISE;          

END;
/
EXIT