--/*
--###########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20200602
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-7446
--## PRODUCTO=NO
--## 
--## Finalidad: ACTUALIZAR estado trabajos
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;
alter session set NLS_NUMERIC_CHARACTERS = '.,';


DECLARE
  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  V_USUARIO VARCHAR2(100 CHAR) := 'REMVIP-7446';
  USU_ID  NUMBER(16);
  TBJ_ID  NUMBER(16);
	
  
BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ACTUALIZAR ESTADOS DE TRABAJOS A PENDIENTE DE PAGO');

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_TBJ_TRABAJO T1
	    USING (SELECT DISTINCT TBJ_ID FROM '||V_ESQUEMA||'.ACT_TBJ_TRABAJO TBJ 
		   WHERE TBJ_NUM_TRABAJO IN (916945400001,
		916944500001,
		916943000001,
		916942700001,
		916942400001,
		916942000001,
		916941100001,
		916940900001,
		916940600001,
		916940100001,
		916940000001,
		916939100001,
		916938500001,
		916938400001,
		916938300001,
		916938200001,
		916938100001,
		916937100001,
		916936600001,
		916936300001,
		916936100001,
		916936000001,
		916935700001,
		916935500001,
		916934200001,
		916934100001,
		916934000001,
		916933900001,
		916933700001,
		916933600001,
		916933200001,
		916933100001,
		916932800001,
		916932600001,
		916930400001,
		916929800001,
		916929700001,
		916929100001,
		916928900001,
		916927800001,
		916927600001,
		916927300001,
		916927100001,
		916927000001,
		916926900001,
		916926800001,
		916926700001,
		916926600001,
		916926500001,
		916925200001,
		916924900001,
		916924500001,
		916923700001,
		916923400001,
		916923300001,
		916922700001,
		916922100001,
		916921900001,
		916921600001,
		916921500001,
		916921200001,
		916915900001,
		916915200001,
		916914900001,
		916914700001,
		916914600001,
		916913300001,
		916913200001,
		916912800001,
		916912500001,
		916912300001,
		916912200001,
		916912100001,
		916911900001,
		916911400001,
		916911300001,
		916911200001,
		916911100001,
		916911000001,
		916910200001,
		916909800001,
		916909600001,
		916909500001,
		916909200001,
		916908000001,
		916907800001,
		916907500001,
		916907400001,
		916907300001,
		916907200001,
		916907100001,
		916907000001,
		916906900001,
		916906800001,
		916906700001,
		916906600001,
		916906400001,
		916906300001,
		916906100001,
		916906000001,
		916905900001,
		916905800001,
		916905700001,
		916905600001,
		916905500001,
		916905400001,
		916904300001,
		916904100001,
		916903800001,
		916903600001,
		916903500001,
		916903400001,
		916902700001,
		916894100001,
		916893000001,
		916884900001,
		916884800001,
		916884600001,
		916882800001,
		916882200001,
		916882100001,
		916880700001,
		916879800001,
		916878800001,
		916878300001,
		916877900001,
		916871200001,
		916871000001,
		916867800001,
		916867000001,
		916864000001,
		916862700001,
		916862000001,
		916860900001,
		916860800001,
		916859700001,
		916859300001,
		916848500001,
		916843100001,
		916842100001,
		916840400001,
		916840300001,
		916833900001,
		916832400001,
		916832200001,
		916814900001,
		916811700001,
		916811600001,
		916804900001,
		916794100001,
		916791000001,
		916790900001,
		916790700001,
		916787600001,
		916787200001,
		916774800001,
		916730600001,
		916704900001,
		916699700001,
		916670400001,
		916669800001,
		916665100001,
		916638900001,
		916638700001,
		916620400001,
		916618100001,
		916616200001,
		916614800001,
		916613200001,
		916610100001,
		916602100001,
		916600700001,
		916583700001,
		916583600001,
		916582300001,
		916567600001,
		916562200001,
		916557700001,
		916557100001,
		916555300001,
		916555200001,
		916509900001,
		916503100001,
		916492700001,
		916470100001,
		916453800001,
		916431800001,
		916424200001,
		916414700001,
		916386200001,
		916365000001,
		916363500001,
		916242000001,
		916241800001,
		916241600001,
		916241100001,
		916241000001,
		916240500001,
		916240400001,
		916212000001,
		916197200001,
		916197100001,
		916178800001,
		916122100001,
		916119500001,
		916119300001,
		915996300001,
		915943100001,
		915899300001,
		915871700001,
		915871400001,
		915871200001,
		915821400001,
		915797200001,
		915797000001,
		915756800001,
		915756700001,
		915756600001,
		915753000001,
		916717400001,
		916678000001,
		916676700001,
		916616800001,
		916557300001,
		916499600001,
		916494100001,
		916494000001,
		916477800001,
		916400700001,
		916216600001,
		916212800001,
		916138500001,
		915832800001,
		916820300001,
		916803800001,
		916772900001,
		916570700001,
		916379400001,
		916316900001,
		915991300001,
		915737700001,
		915727400001,
		915621100001,
		915558300001,
		915551900001,
		915546500001,
		915481700001,
		915460800001,
		915443800001,
		915384700001,
		915378000001,
		915251100001,
		915125100001,
		915079800001,
		915059900001,
		915049800001,
		915013500001,
		914916400001,
		914892800001,
		914850100001,
		914830100001,
		914813300001,
		914799600001,
		914799100001,
		914798000001,
		914772500001,
		914742200001,
		914741600001,
		914727200001,
		914714600001,
		914711100001,
		914706100001,
		914704900001,
		914704500001,
		914704400001,
		914700400001,
		914699000001,
		914698800001,
		914698700001,
		914692800001,
		914690900001,
		914681600001,
		914680500001,
		914656200001,
		914655900001,
		914632600001,
		914620400001,
		914617700001,
		914575500001,
		914441000001,
		914389600001,
		914351300001,
		914262000001,
		914259600001,
		914732300001,
		914505200001,
		915619700001,
		916960700001
)
		  ) T2
	    ON (T1.TBJ_ID = T2.TBJ_ID)
	  WHEN MATCHED THEN
	    UPDATE 
	       SET T1.USUARIOMODIFICAR = ''REMVIP-7446'',
		   T1.FECHAMODIFICAR = SYSDATE,
	   	   T1.DD_EST_ID = 5';
		
	EXECUTE IMMEDIATE V_MSQL;  
	
	DBMS_OUTPUT.PUT_LINE('[INFO] Actualizados '||SQL%ROWCOUNT||' registros EN ACT_TBJ_TRABAJO ');  

    	COMMIT;

   	DBMS_OUTPUT.PUT_LINE('[FIN] ');

EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
