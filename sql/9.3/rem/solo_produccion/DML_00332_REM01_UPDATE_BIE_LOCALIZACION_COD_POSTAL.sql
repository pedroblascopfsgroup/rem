--/*
--###########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20200609
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-7494
--## PRODUCTO=NO
--## 
--## Finalidad: UPDATE CODIGO POSTAL
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  V_NUM_TABLAS_2 NUMBER(16); -- Vble. para validar la existencia de una tabla.  
  V_NUM_TABLAS_3 NUMBER(16); -- Vble. para validar la existencia de una tabla. 
  V_NUM_TABLAS_4 NUMBER(16); -- Vble. para validar la existencia de una tabla.  
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  NUM_ACT NUMBER(16);
  ACT_ID  NUMBER(16);
  CODIGO_POSTAL VARCHAR2(20 CHAR);
  LOC_ID  NUMBER(16);
  BIE_ID NUMBER(16);
  V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
  V_USUARIO VARCHAR2(100 CHAR) := 'REMVIP-7494';
  
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 

   V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
    -- NUM ACTIVO,  CODIGO_POSTAL

T_JBV(69532,'11139'),
T_JBV(174485,'11139'),
T_JBV(155958,'30005'),
T_JBV(155418,'30005'),
T_JBV(155961,'30005'),
T_JBV(198262,'11139'),
T_JBV(201449,'11139'),
T_JBV(174190,'11139'),
T_JBV(72336,'03739'),
T_JBV(69131,'11139'),
T_JBV(146759,'43480'),
T_JBV(155695,'30005'),
T_JBV(174484,'11139'),
T_JBV(161082,'14011'),
T_JBV(201530,'11139'),
T_JBV(173994,'11139'),
T_JBV(201450,'11139'),
T_JBV(165405,'46980'),
T_JBV(154200,'41702'),
T_JBV(72142,'03739'),
T_JBV(138406,'30005'),
T_JBV(198269,'11139'),
T_JBV(201531,'11139'),
T_JBV(173995,'11139'),
T_JBV(201452,'11139'),
T_JBV(155011,'50011'),
T_JBV(174432,'11139'),
T_JBV(69125,'11139'),
T_JBV(138296,'30005'),
T_JBV(155834,'30005'),
T_JBV(73826,'03739'),
T_JBV(71918,'03739'),
T_JBV(148756,'21430'),
T_JBV(132355,'30005'),
T_JBV(198385,'11139'),
T_JBV(159309,'05002'),
T_JBV(144932,'30005'),
T_JBV(144645,'30005'),
T_JBV(145064,'30005'),
T_JBV(72143,'03739'),
T_JBV(69533,'11139'),
T_JBV(201451,'11139'),
T_JBV(133955,'46900'),
T_JBV(132245,'46400'),
T_JBV(198386,'11139'),
T_JBV(70235,'46184'),
T_JBV(138104,'30005'),
T_JBV(138148,'30005'),
T_JBV(199489,'46500'),
T_JBV(163423,'30566'),
T_JBV(73401,'03739'),
T_JBV(145065,'30005'),
T_JBV(155412,'30005'),
T_JBV(70419,'11139'),
T_JBV(174191,'11139'),
T_JBV(198387,'11139'),
T_JBV(65110,'33012'),
T_JBV(71043,'02006'),
T_JBV(72023,'03739'),
T_JBV(155164,'30005'),
T_JBV(131895,'30005'),
T_JBV(198330,'11139'),
T_JBV(201406,'11139'),
T_JBV(138410,'30005'),
T_JBV(69034,'11139'),
T_JBV(951939,'04640'),
T_JBV(180817,'29680'),
T_JBV(142786,'05194'),
T_JBV(177257,'30165'),
T_JBV(75957,'46980'),
T_JBV(136552,'26300'),
T_JBV(182098,'40197'),
T_JBV(6130425,'03724'),
T_JBV(199830,'35200'),
T_JBV(160626,'46980'),
T_JBV(6128178,'04740'),
T_JBV(64375,'46980'),
T_JBV(199863,'46500'),
T_JBV(106813,'18600'),
T_JBV(150810,'46520'),
T_JBV(173356,'29680'),
T_JBV(63249,'26009'),
T_JBV(6345749,'03400'),
T_JBV(6345772,'03400'),
T_JBV(6345774,'03400'),
T_JBV(6345762,'03400'),
T_JBV(7004084,'21130'),
T_JBV(7006667,'22640'),
T_JBV(7006666,'22640'),
T_JBV(7006669,'22640'),
T_JBV(7006668,'22640'),
T_JBV(7006670,'22640'),
T_JBV(7006671,'22640'),
T_JBV(7074231,'35432'),
T_JBV(7074232,'35432'),
T_JBV(7074233,'35432'),
T_JBV(7074234,'35432'),
T_JBV(7074235,'35432'),
T_JBV(7074236,'35432'),
T_JBV(7074237,'35432'),
T_JBV(7074238,'35432'),
T_JBV(7074239,'35432'),
T_JBV(7074240,'35432'),
T_JBV(7074241,'35432'),
T_JBV(7074242,'35432'),
T_JBV(7074243,'35432'),
T_JBV(7074244,'35432'),
T_JBV(7074245,'35432'),
T_JBV(7074262,'15220'),
T_JBV(7071175,'15823'),
T_JBV(7071174,'15823'),
T_JBV(6977660,'24228'),
T_JBV(6702898,'02520'),
T_JBV(6705613,'06010'),
T_JBV(6705612,'06010'),
T_JBV(6705614,'06010'),
T_JBV(6705605,'06010'),
T_JBV(6705609,'06010'),
T_JBV(6705606,'06010'),
T_JBV(6705611,'06010'),
T_JBV(6705608,'06010'),
T_JBV(6752865,'26007'),
T_JBV(6752890,'26007'),
T_JBV(6762984,'17200'),
T_JBV(6772367,'28701'),
T_JBV(6772368,'28701'),
T_JBV(6772372,'28701'),
T_JBV(6772371,'28701')

	); 
	V_TMP_JBV T_JBV;
    
BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');

	 
    -- LOOP  -----------------------------------------------------------------
    DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZA CODIGP POSTAL');
   FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
	V_TMP_JBV := V_JBV(I);

  	NUM_ACT := TRIM(V_TMP_JBV(1));
  	
  	CODIGO_POSTAL := TRIM(V_TMP_JBV(2));

	V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||NUM_ACT||'';
				
        EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
        
        --Si existe realizamos otra comprobacion
        IF V_NUM_TABLAS > 0 THEN	

		--Comprobamos el dato a insertar
		V_SQL := 'SELECT BIE_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||NUM_ACT||'';
				
		EXECUTE IMMEDIATE V_SQL INTO BIE_ID;

		--BIE_LOCALIZACION

		V_SQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.BIE_LOCALIZACION WHERE BIE_ID = '||BIE_ID||'';
				
		EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS_2;
		
		--Si existe realizamos otra comprobacion
		IF V_NUM_TABLAS_2 > 0 THEN

			V_MSQL := 'UPDATE '||V_ESQUEMA||'.BIE_LOCALIZACION SET BIE_LOC_COD_POST = '''||CODIGO_POSTAL||'''
							, USUARIOMODIFICAR = '''||V_USUARIO||'''
							, FECHAMODIFICAR = SYSDATE
					WHERE BIE_ID = '||BIE_ID||'';
						
			EXECUTE IMMEDIATE V_MSQL;
			
			DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZADO CORRECTAMENTE CODIGO POSTAL DEL ACTIVO '||NUM_ACT||' ');

			V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
			
			--El activo no existe
		ELSE
				 
			DBMS_OUTPUT.PUT_LINE('[INFO]: EL ACTIVO '||NUM_ACT||' NO EXISTE');	
		END IF;
		
	--El activo no existe
	ELSE
		DBMS_OUTPUT.PUT_LINE('[INFO]: EL ACTIVO '||NUM_ACT||' NO EXISTE ');
	END IF;
		
    END LOOP;
    COMMIT;
   
	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN] Se han updateado en total '||V_COUNT_UPDATE||' registros en BIE_LOC_LOCALIZACION ');


EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
