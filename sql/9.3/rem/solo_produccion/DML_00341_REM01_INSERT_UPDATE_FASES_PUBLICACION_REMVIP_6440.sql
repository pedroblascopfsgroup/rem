--/*
--##########################################
--## AUTOR=Viorel Remus Ovidiu
--## FECHA_CREACION=20200617
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-6440
--## PRODUCTO=NO
--##
--## Finalidad: primera tirada Fases de publicacion
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USUARIO VARCHAR2(32 CHAR) := 'REMVIP-6440';


 BEGIN

	DBMS_OUTPUT.put_line('[INICIO] PRIMERA TIRADA FASES DE PUBLICACION');

----------------------------------------------------------------------------

	DBMS_OUTPUT.put_line('[INFO] INSERCION FASES PUBLICACION A ACTIVOS QUE NO TIENEN NINGUNA FASE');

	V_SQL := 'INSERT INTO  '||V_ESQUEMA||'.ACT_HFP_HIST_FASES_PUB(HFP_ID, ACT_ID, DD_FSP_ID, USU_ID,HFP_FECHA_INI,VERSION,USUARIOCREAR,FECHACREAR,BORRADO )
		   SELECT 
		   '||V_ESQUEMA||'.S_ACT_HFP_HIST_FASES_PUB.NEXTVAL AS HFP_ID,
		   ACT_ID AS ACT_ID,
		   (SELECT DD_FSP_ID FROM '||V_ESQUEMA||'.DD_FSP_FASE_PUBLICACION WHERE DD_FSP_CODIGO = ''01'') AS DD_FSP_ID,
		   (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''BATCH_USER'') AS USU_ID,
		   SYSDATE AS HFP_FECHA_INI,
		   0 AS VERSION,
		   ''REMVIP-6440-1'' AS USUARIOCREAR,
		   SYSDATE AS FECHACREAR,
		   0 AS BORRADO
		FROM 
			'||V_ESQUEMA||'.ACT_ACTIVO 
		WHERE 
			ACT_ID NOT IN (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_HFP_HIST_FASES_PUB)';

	EXECUTE IMMEDIATE V_SQL ;
		
	DBMS_OUTPUT.put_line('[INFO] Se han insertado '||SQL%ROWCOUNT||' registros en ACT_HFP_HIST_FASES_PUB');

 	COMMIT;

--------------------------------------------------------------------------------------------------------
-----------Si INDICADOR_1 = 1 O INDICADOR_2 = 1 --> insertamos Fase de publicacion a "No aplica"------

	DBMS_OUTPUT.put_line('[INFO] INSERCION FASES PUBLICACION "NO APLICA" SI INDICADOR_1 = 1 O INDICADOR_2 = 1 ');

	V_SQL := 'INSERT INTO  '||V_ESQUEMA||'.ACT_HFP_HIST_FASES_PUB(HFP_ID, ACT_ID, DD_FSP_ID,DD_SFP_ID, USU_ID,HFP_FECHA_INI, HFP_FECHA_FIN,HFP_COMENTARIO,VERSION,USUARIOCREAR,FECHACREAR,USUARIOMODIFICAR,FECHAMODIFICAR,USUARIOBORRAR, FECHABORRAR, BORRADO )
		SELECT 
		'||V_ESQUEMA||'.S_ACT_HFP_HIST_FASES_PUB.NEXTVAL AS HFP_ID,
		HFP.ACT_ID AS ACT_ID,
		(SELECT DD_FSP_ID FROM '||V_ESQUEMA||'.DD_FSP_FASE_PUBLICACION WHERE DD_FSP_CODIGO = ''01'') AS DD_FSP_ID,
		NULL AS DD_SFP_ID,
		(SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''BATCH_USER'') AS USU_ID,
		SYSDATE AS HFP_FECHA_INI,
		NULL AS HFP_FECHA_FIN,
		NULL AS HFP_COMENTARIO,
		0 AS VERSION,
		''REMVIP-6440-2'' AS USUARIOCREAR,
		SYSDATE AS FECHACREAR,
		NULL AS USUARIOMODIFICAR,
		NULL AS FECHAMODIFICAR,
		NULL AS USUARIOBORRAR,
		NULL AS FECHABORRAR,
		0 AS BORRADO
		FROM '||V_ESQUEMA||'.ACT_HFP_HIST_FASES_PUB HFP
		JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = HFP.ACT_ID 
		JOIN '||V_ESQUEMA||'.V_CONF_ALERTAS_PUBLICACION V_CONF ON ACT.ACT_NUM_ACTIVO = V_CONF.NUM_ACTIVO
		WHERE HFP.HFP_FECHA_FIN IS NULL
		AND (V_CONF.INDICADOR_1 = 1 OR V_CONF.INDICADOR_2 = 1)';

	EXECUTE IMMEDIATE V_SQL ;
		
	DBMS_OUTPUT.put_line('[INFO] Se han insertado '||SQL%ROWCOUNT||' registros en ACT_HFP_HIST_FASES_PUB');

 	COMMIT;

--------------------------------------------------------------------------------------------------------
-----------CERRAMOS FASES ANTERIORES PONIENDO FECHA_FIN------


	DBMS_OUTPUT.put_line('[INFO] ACTUALIZAR FASES PUBLICACION ANTERIORES CON FECHA FIN');

	V_SQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_HFP_HIST_FASES_PUB T1
		USING (

			SELECT HFP.HFP_ID,ROW_NUMBER() OVER(PARTITION BY HFP.ACT_ID ORDER BY HFP.HFP_FECHA_INI ASC NULLS LAST) AS RN
			FROM '||V_ESQUEMA||'.ACT_HFP_HIST_FASES_PUB HFP
			JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = HFP.ACT_ID 
			JOIN '||V_ESQUEMA||'.V_CONF_ALERTAS_PUBLICACION V_CONF ON ACT.ACT_NUM_ACTIVO = V_CONF.NUM_ACTIVO
			WHERE HFP.HFP_FECHA_FIN IS NULL 
			AND (V_CONF.INDICADOR_1 = 1  OR  V_CONF.INDICADOR_2 = 1) 
		)
		T2
		    ON (T1.HFP_ID = T2.HFP_ID AND T2.RN = 1)
		    WHEN MATCHED THEN UPDATE SET
		    T1.HFP_FECHA_FIN = SYSDATE,
			T1.USUARIOMODIFICAR = ''REMVIP-6440-2'',
			T1.FECHAMODIFICAR = SYSDATE,
			T1.VERSION = T1.VERSION + 1';

	EXECUTE IMMEDIATE V_SQL ;
		
	DBMS_OUTPUT.put_line('[INFO] Se han ACTUALIZADO '||SQL%ROWCOUNT||' registros en ACT_HFP_HIST_FASES_PUB');

 	COMMIT;


--------------------------------------------------------------------------------------------------------
-----------Si INDICADOR_1 = 0 Y INDICADOR_2 = 0 --> insertamos Fase de publicacion a "Fase 0"------

	DBMS_OUTPUT.put_line('[INFO] INSERCION FASES PUBLICACION "FASE 0" SI INDICADOR_1 = 0 E INDICADOR_2 = 0 ');

	V_SQL := 'INSERT INTO  '||V_ESQUEMA||'.ACT_HFP_HIST_FASES_PUB(HFP_ID, ACT_ID, DD_FSP_ID,DD_SFP_ID, USU_ID,HFP_FECHA_INI, HFP_FECHA_FIN,HFP_COMENTARIO,VERSION,USUARIOCREAR,FECHACREAR,USUARIOMODIFICAR,FECHAMODIFICAR,USUARIOBORRAR, FECHABORRAR, BORRADO )
		SELECT
		'||V_ESQUEMA||'.S_ACT_HFP_HIST_FASES_PUB.NEXTVAL AS HFP_ID,
		HFP.ACT_ID AS ACT_ID,
		(SELECT DD_FSP_ID FROM '||V_ESQUEMA||'.DD_FSP_FASE_PUBLICACION WHERE DD_FSP_CODIGO = ''02'') AS DD_FSP_ID,
		NULL AS DD_SFP_ID,
		(SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''BATCH_USER'') AS USU_ID,
		SYSDATE AS HFP_FECHA_INI,
		NULL AS HFP_FECHA_FIN,
		NULL AS HFP_COMENTARIO,
		0 AS VERSION,
		''REMVIP-6440-3'' AS USUARIOCREAR,
		SYSDATE AS FECHACREAR,
		NULL AS USUARIOMODIFICAR,
		NULL AS FECHAMODIFICAR,
		NULL AS USUARIOBORRAR,
		NULL AS FECHABORRAR,
		0 AS BORRADO
		FROM '||V_ESQUEMA||'.ACT_HFP_HIST_FASES_PUB HFP
		JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = HFP.ACT_ID  
		JOIN '||V_ESQUEMA||'.V_CONF_ALERTAS_PUBLICACION V_CONF ON ACT.ACT_NUM_ACTIVO = V_CONF.NUM_ACTIVO
		WHERE HFP.HFP_FECHA_FIN IS NULL 
		AND (V_CONF.INDICADOR_1 = 0 AND V_CONF.INDICADOR_2 = 0)';

	EXECUTE IMMEDIATE V_SQL ;
		
	DBMS_OUTPUT.put_line('[INFO] Se han insertado '||SQL%ROWCOUNT||' registros en ACT_HFP_HIST_FASES_PUB');

 	COMMIT;

--------------------------------------------------------------------------------------------------------
-----------CERRAMOS FASES ANTERIORES PONIENDO FECHA_FIN------


	DBMS_OUTPUT.put_line('[INFO] ACTUALIZAR FASES PUBLICACION ANTERIORES CON FECHA FIN');

	V_SQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_HFP_HIST_FASES_PUB T1
		USING (
			SELECT HFP.HFP_ID,ROW_NUMBER() OVER(PARTITION BY HFP.ACT_ID ORDER BY hfp.HFP_FECHA_INI ASC NULLS LAST) AS RN
			FROM '||V_ESQUEMA||'.ACT_HFP_HIST_FASES_PUB HFP
			JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = HFP.ACT_ID 
			JOIN '||V_ESQUEMA||'.V_CONF_ALERTAS_PUBLICACION V_CONF ON ACT.ACT_NUM_ACTIVO = V_CONF.NUM_ACTIVO
			WHERE HFP.HFP_FECHA_FIN IS NULL
			AND (V_CONF.INDICADOR_1 = 0  AND  V_CONF.INDICADOR_2 = 0)
		)
		T2 
		    ON (T1.HFP_ID = T2.HFP_ID AND T2.RN = 1)
		    WHEN MATCHED THEN UPDATE SET
		    T1.HFP_FECHA_FIN = SYSDATE,
			T1.USUARIOMODIFICAR = ''REMVIP-6440-3'',
			T1.FECHAMODIFICAR = SYSDATE,
			T1.VERSION = T1.VERSION + 1';

	EXECUTE IMMEDIATE V_SQL ;
		
	DBMS_OUTPUT.put_line('[INFO] Se han ACTUALIZADO '||SQL%ROWCOUNT||' registros en ACT_HFP_HIST_FASES_PUB');

 	COMMIT;

	DBMS_OUTPUT.put_line('[FIN] EJECUTADO SCRIPT PRIMERA TIRADA FASES DE PUBLICACION');
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;

