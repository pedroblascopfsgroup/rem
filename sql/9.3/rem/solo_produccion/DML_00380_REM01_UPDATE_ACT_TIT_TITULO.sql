--/*
--##########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20200705
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-7712
--## PRODUCTO=NO
--## Finalidad: Actualizar REM01.BIE_ADJ_ADJUDICACION 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.	
    V_CONTADOR NUMBER := 0; -- variable para contar filas.
    V_VALOR NUMBER(16); -- Vble. para validar la existencia de un valor.
    
    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
        -- BIE_ADJ_F_REA_POSESION -- ACT_NUM_ACTIVO ---
		T_TIPO_DATA('113771','2020/03/06'),
		T_TIPO_DATA('108036','2020/03/25'),
		T_TIPO_DATA('108326','2020/03/25'),
		T_TIPO_DATA('167774','2020/04/17'),
		T_TIPO_DATA('175421','2020/03/02'),
		T_TIPO_DATA('161575','2020/03/02'),
		T_TIPO_DATA('174955','2020/03/02'),
		T_TIPO_DATA('178320','2020/02/24'),
		T_TIPO_DATA('180485','2020/03/02'),
		T_TIPO_DATA('175197','2020/03/02'),
		T_TIPO_DATA('176172','2020/03/12'),
		T_TIPO_DATA('189696','2020/02/24'),
		T_TIPO_DATA('137639','2019/02/06'),
		T_TIPO_DATA('90508','2020/04/06'),
		T_TIPO_DATA('180486','2020/03/02'),
		T_TIPO_DATA('146027','2020/02/18'),
		T_TIPO_DATA('174902','2020/03/02'),
		T_TIPO_DATA('66591','2020/04/17'),
		T_TIPO_DATA('72365','2020/04/08'),
		T_TIPO_DATA('108764','2020/03/02'),
		T_TIPO_DATA('124100','2020/03/25'),
		T_TIPO_DATA('183003','2020/03/12'),
		T_TIPO_DATA('93969','2020/04/06'),
		T_TIPO_DATA('90883','2020/03/13'),
		T_TIPO_DATA('96037','2020/03/27'),
		T_TIPO_DATA('190090','2020/02/24'),
		T_TIPO_DATA('200320','2020/04/17'),
		T_TIPO_DATA('71662','2020/03/12'),
		T_TIPO_DATA('88731','2020/04/06'),
		T_TIPO_DATA('108035','2020/03/25'),
		T_TIPO_DATA('108325','2020/03/25'),
		T_TIPO_DATA('141653','2020/02/18'),
		T_TIPO_DATA('133500','2020/04/17'),
		T_TIPO_DATA('180484','2020/03/02'),
		T_TIPO_DATA('150995','2020/04/17'),
		T_TIPO_DATA('193281','2020/02/24'),
		T_TIPO_DATA('177108','2020/03/02'),
		T_TIPO_DATA('183204','2020/03/12'),
		T_TIPO_DATA('191323','2020/03/17'),
		T_TIPO_DATA('91417','2019/12/19'),
		T_TIPO_DATA('92513','2020/03/27'),
		T_TIPO_DATA('71661','2020/03/12'),
		T_TIPO_DATA('90435','2020/03/17'),
		T_TIPO_DATA('71690','2020/03/12'),
		T_TIPO_DATA('99705','2020/04/06'),
		T_TIPO_DATA('83752','2020/03/17'),
		T_TIPO_DATA('161533','2020/03/02'),
		T_TIPO_DATA('193490','2019/12/03'),
		T_TIPO_DATA('69567','2020/03/02'),
		T_TIPO_DATA('93856','2020/04/06'),
		T_TIPO_DATA('108324','2020/03/25'),
		T_TIPO_DATA('116054','2020/03/02'),
		T_TIPO_DATA('141753','2020/02/18'),
		T_TIPO_DATA('148810','2019/12/13'),
		T_TIPO_DATA('145552','2020/02/18'),
		T_TIPO_DATA('145925','2020/02/18'),
		T_TIPO_DATA('179869','2019/12/30'),
		T_TIPO_DATA('180694','2020/03/02'),
		T_TIPO_DATA('180340','2020/03/02'),
		T_TIPO_DATA('180906','2020/03/02'),
		T_TIPO_DATA('7010527','2020/02/26'),
		T_TIPO_DATA('169827','2019/12/16'),
		T_TIPO_DATA('69365','2020/03/02'),
		T_TIPO_DATA('180344','2020/03/02'),
		T_TIPO_DATA('121207','2020/03/25'),
		T_TIPO_DATA('129293','2020/03/16'),
		T_TIPO_DATA('140445','2019/12/13'),
		T_TIPO_DATA('141676','2020/02/18'),
		T_TIPO_DATA('174636','2020/03/02'),
		T_TIPO_DATA('180904','2020/03/02'),
		T_TIPO_DATA('158134','2020/03/05'),
		T_TIPO_DATA('7010528','2020/02/26'),
		T_TIPO_DATA('7010537','2020/02/26'),
		T_TIPO_DATA('83329','2019/03/12'),
		T_TIPO_DATA('83524','2020/03/17'),
		T_TIPO_DATA('87590','2019/12/19'),
		T_TIPO_DATA('99016','2020/04/14'),
		T_TIPO_DATA('7010532','2020/02/26'),
		T_TIPO_DATA('147810','2019/12/13'),
		T_TIPO_DATA('118081','2020/03/02'),
		T_TIPO_DATA('120518','2020/01/13'),
		T_TIPO_DATA('137609','2020/03/02'),
		T_TIPO_DATA('140735','2020/03/12'),
		T_TIPO_DATA('161501','2020/03/02'),
		T_TIPO_DATA('161532','2020/03/02'),
		T_TIPO_DATA('183002','2020/03/12'),
		T_TIPO_DATA('179549','2020/03/16'),
		T_TIPO_DATA('180804','2020/03/02'),
		T_TIPO_DATA('78150','2020/02/28'),
		T_TIPO_DATA('92788','2020/03/27'),
		T_TIPO_DATA('180908','2020/03/02'),
		T_TIPO_DATA('91103','2020/03/13'),
		T_TIPO_DATA('195797','2020/03/17'),
		T_TIPO_DATA('939577','2020/02/24'),
		T_TIPO_DATA('158863','2020/03/05'),
		T_TIPO_DATA('69323','2020/03/02'),
		T_TIPO_DATA('117519','2020/03/02'),
		T_TIPO_DATA('129294','2020/03/16'),
		T_TIPO_DATA('174635','2020/03/02'),
		T_TIPO_DATA('174906','2020/03/02'),
		T_TIPO_DATA('180903','2020/03/02'),
		T_TIPO_DATA('178049','2019/12/03'),
		T_TIPO_DATA('167623','2020/04/17'),
		T_TIPO_DATA('193824','2020/02/24'),
		T_TIPO_DATA('195620','2020/03/17'),
		T_TIPO_DATA('178004','2020/02/24'),
		T_TIPO_DATA('99704','2020/04/06'),
		T_TIPO_DATA('176792','2020/04/17'),
		T_TIPO_DATA('180341','2020/03/02'),
		T_TIPO_DATA('93968','2020/04/06'),
		T_TIPO_DATA('94132','2020/04/06'),
		T_TIPO_DATA('90238','2020/04/06'),
		T_TIPO_DATA('129827','2020/03/16'),
		T_TIPO_DATA('174904','2020/03/02'),
		T_TIPO_DATA('180342','2020/03/02'),
		T_TIPO_DATA('200417','2020/04/17'),
		T_TIPO_DATA('175422','2020/03/02'),
		T_TIPO_DATA('69564','2020/03/02'),
		T_TIPO_DATA('7010535','2020/02/26'),
		T_TIPO_DATA('87230','2020/03/13'),
		T_TIPO_DATA('180905','2020/03/02'),
		T_TIPO_DATA('93855','2020/04/06'),
		T_TIPO_DATA('69322','2020/03/02'),
		T_TIPO_DATA('71563','2020/03/12'),
		T_TIPO_DATA('178539','2020/02/24'),
		T_TIPO_DATA('161325','2020/03/02'),
		T_TIPO_DATA('193823','2020/02/24'),
		T_TIPO_DATA('196470','2020/03/17'),
		T_TIPO_DATA('66594','2020/04/17'),
		T_TIPO_DATA('6801263','2020/03/16'),
		T_TIPO_DATA('69566','2020/03/02'),
		T_TIPO_DATA('91561','2020/03/17'),
		T_TIPO_DATA('93853','2020/04/06'),
		T_TIPO_DATA('90237','2020/04/06'),
		T_TIPO_DATA('175501','2020/03/12'),
		T_TIPO_DATA('90446','2020/04/06'),
		T_TIPO_DATA('189060','2020/02/24'),
		T_TIPO_DATA('90436','2020/03/17'),
		T_TIPO_DATA('162367','2020/03/12'),
		T_TIPO_DATA('165726','2020/02/17'),
		T_TIPO_DATA('174901','2020/03/02'),
		T_TIPO_DATA('103283','2020/01/13'),
		T_TIPO_DATA('165422','2020/03/17'),
		T_TIPO_DATA('175552','2020/03/12'),
		T_TIPO_DATA('194381','2020/03/17'),
		T_TIPO_DATA('194380','2020/03/17'),
		T_TIPO_DATA('66265','2020/04/17'),
		T_TIPO_DATA('7010531','2020/02/26'),
		T_TIPO_DATA('161500','2020/03/02'),
		T_TIPO_DATA('175717','2020/03/12'),
		T_TIPO_DATA('7010530','2020/02/26'),
		T_TIPO_DATA('7010538','2020/02/26'),
		T_TIPO_DATA('88371','2020/04/06'),
		T_TIPO_DATA('109778','2020/03/05'),
		T_TIPO_DATA('141196','2020/04/17'),
		T_TIPO_DATA('143440','2020/04/17'),
		T_TIPO_DATA('145080','2020/03/12'),
		T_TIPO_DATA('153197','2020/03/12'),
		T_TIPO_DATA('178127','2020/02/24'),
		T_TIPO_DATA('178128','2020/02/24'),
		T_TIPO_DATA('190091','2020/02/24'),
		T_TIPO_DATA('174637','2020/03/02'),
		T_TIPO_DATA('194771','2020/03/17'),
		T_TIPO_DATA('195796','2020/03/17'),
		T_TIPO_DATA('174826','2020/03/02'),
		T_TIPO_DATA('176865','2020/04/17'),
		T_TIPO_DATA('178003','2020/02/24'),
		T_TIPO_DATA('178048','2019/12/03'),
		T_TIPO_DATA('180343','2020/03/02'),
		T_TIPO_DATA('76836','2020/02/28'),
		T_TIPO_DATA('99749','2020/04/06'),
		T_TIPO_DATA('7010524','2020/02/26'),
		T_TIPO_DATA('86611','2020/02/24'),
		T_TIPO_DATA('99750','2020/04/06'),
		T_TIPO_DATA('161324','2020/03/02'),
		T_TIPO_DATA('174903','2020/03/02'),
		T_TIPO_DATA('191322','2020/03/17'),
		T_TIPO_DATA('90977','2020/04/14'),
		T_TIPO_DATA('93967','2020/04/06'),
		T_TIPO_DATA('118082','2020/03/02'),
		T_TIPO_DATA('151087','2020/04/17'),
		T_TIPO_DATA('180802','2020/03/02'),
		T_TIPO_DATA('180693','2020/03/02'),
		T_TIPO_DATA('152858','2020/03/12'),
		T_TIPO_DATA('188493','2020/02/24'),
		T_TIPO_DATA('189635','2020/02/24'),
		T_TIPO_DATA('194433','2020/03/17'),
		T_TIPO_DATA('78151','2020/02/28'),
		T_TIPO_DATA('90236','2020/04/06'),
		T_TIPO_DATA('84145','2019/12/16'),
		T_TIPO_DATA('85473','2020/02/24'),
		T_TIPO_DATA('180695','2020/03/02'),
		T_TIPO_DATA('189842','2020/02/24'),
		T_TIPO_DATA('94631','2020/04/06'),
		T_TIPO_DATA('7010525','2020/02/26'),
		T_TIPO_DATA('189843','2020/02/24'),
		T_TIPO_DATA('7010529','2020/02/26'),
		T_TIPO_DATA('120974','2020/03/25'),
		T_TIPO_DATA('130190','2020/03/16'),
		T_TIPO_DATA('130163','2020/03/16'),
		T_TIPO_DATA('143439','2020/04/17'),
		T_TIPO_DATA('161793','2020/03/02'),
		T_TIPO_DATA('162368','2020/03/12'),
		T_TIPO_DATA('180803','2020/03/02'),
		T_TIPO_DATA('190088','2020/02/24'),
		T_TIPO_DATA('200503','2020/03/27'),
		T_TIPO_DATA('167903','2020/03/10'),
		T_TIPO_DATA('174956','2020/03/02'),
		T_TIPO_DATA('195621','2020/03/17'),
		T_TIPO_DATA('78214','2020/02/28'),
		T_TIPO_DATA('7074138','2020/03/10'),
		T_TIPO_DATA('175196','2020/03/02'),
		T_TIPO_DATA('94630','2020/04/06'),
		T_TIPO_DATA('190087','2020/02/24'),
		T_TIPO_DATA('191851','2020/03/17'),
		T_TIPO_DATA('68966','2020/03/19'),
		T_TIPO_DATA('69202','2020/03/02'),
		T_TIPO_DATA('7010536','2020/02/26'),
		T_TIPO_DATA('79175','2020/02/24'),
		T_TIPO_DATA('130162','2020/03/16'),
		T_TIPO_DATA('162365','2020/03/12'),
		T_TIPO_DATA('194210','2020/03/17'),
		T_TIPO_DATA('135324','2020/03/05'),
		T_TIPO_DATA('142676','2019/12/05'),
		T_TIPO_DATA('145243','2020/02/18'),
		T_TIPO_DATA('175195','2020/03/02'),
		T_TIPO_DATA('7072445','2020/03/12'),
		T_TIPO_DATA('76344','2019/03/12'),
		T_TIPO_DATA('89734','2020/04/06'),
		T_TIPO_DATA('99882','2020/04/06'),
		T_TIPO_DATA('90680','2020/03/17'),
		T_TIPO_DATA('140389','2020/03/05'),
		T_TIPO_DATA('7010534','2020/02/26'),
		T_TIPO_DATA('90447','2020/04/06'),
		T_TIPO_DATA('108126','2020/03/02'),
		T_TIPO_DATA('141675','2020/02/18'),
		T_TIPO_DATA('190089','2020/02/24'),
		T_TIPO_DATA('76652','2020/02/28'),
		T_TIPO_DATA('76374','2020/02/28'),
		T_TIPO_DATA('83077','2020/02/28'),
		T_TIPO_DATA('92272','2020/03/17'),
		T_TIPO_DATA('94632','2020/04/06'),
		T_TIPO_DATA('7010533','2020/02/26'),
		T_TIPO_DATA('90507','2020/04/06'),
		T_TIPO_DATA('129403','2020/03/16'),
		T_TIPO_DATA('175419','2020/03/02'),
		T_TIPO_DATA('196055','2020/03/17'),
		T_TIPO_DATA('133341','2018/10/18'),
		T_TIPO_DATA('145551','2020/02/18'),
		T_TIPO_DATA('163816','2020/03/10'),
		T_TIPO_DATA('171208','2020/03/05'),
		T_TIPO_DATA('161323','2020/03/02'),
		T_TIPO_DATA('67972','2020/02/28'),
		T_TIPO_DATA('7010526','2020/02/26'),
		T_TIPO_DATA('90235','2020/04/06'),
		T_TIPO_DATA('174905','2020/03/02'),
		T_TIPO_DATA('178321','2020/02/24'),
		T_TIPO_DATA('93854','2020/04/06')

	); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

BEGIN	
	 
    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
      LOOP
      
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
        V_MSQL := 'SELECT COUNT(ACT_ID) FROM '||V_ESQUEMA||'.ACT_TIT_TITULO
                    where ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO where ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||')';
        
        EXECUTE IMMEDIATE V_MSQL INTO V_VALOR;

        IF V_VALOR = 0 THEN

            DBMS_OUTPUT.PUT_LINE('[INICIO] INSERTANDO EN  ACT_TIT_TITULO...');

		 V_MSQL := 'INSERT INTO ' || V_ESQUEMA || '.ACT_TIT_TITULO
			(
			TIT_ID,
			ACT_ID,
			USUARIOCREAR,
			FECHACREAR,
			BORRADO
			)
			SELECT ' || V_ESQUEMA || '.S_ACT_TIT_TITULO.NEXTVAL AS TIT_ID, 
			(SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO where ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'),
			''REMVIP-7712'' AS USUARIOCREAR,
			SYSDATE AS FECHACREAR,
			0 AS BORRADO
			FROM DUAL';

            EXECUTE IMMEDIATE V_MSQL;

        END IF;

            DBMS_OUTPUT.PUT_LINE('[INICIO] ACTUALIZANDO EN  ACT_TIT_TITULO...');

            V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_TIT_TITULO SET 
		  TIT_FECHA_INSC_REG=TO_DATE('''||V_TMP_TIPO_DATA(2)||''',''YYYY/MM/DD'')
                , USUARIOMODIFICAR = ''REMVIP-7712''
		, FECHAMODIFICAR = SYSDATE
            WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||')';
            EXECUTE IMMEDIATE V_MSQL;
            V_CONTADOR := V_CONTADOR + SQL%ROWCOUNT;
            


    END LOOP;

    DBMS_OUTPUT.PUT_LINE('[INFO] FILAS ACTUALIZADAS: '||V_CONTADOR);
    
    COMMIT;
	
    DBMS_OUTPUT.PUT_LINE('[FIN] Filas actualizadas en la tabla BIE_ADJ_ADJUDICACION');
   

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;

/

EXIT
