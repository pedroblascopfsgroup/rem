--/*
--##########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20200708
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-7709
--## PRODUCTO=NO
--##
--## Finalidad:  
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 
DECLARE

    PL_OUTPUT VARCHAR2(32000 CHAR);
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    V_NUM_FILAS_1 NUMBER(16); -- Vble. para validar la existencia de un registro.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-7709'; -- USUARIOCREAR/USUARIOMODIFICAR. 
    
    ACT_NUM NUMBER(16);
    RECOVERY_ID NUMBER(16);
    V_COUNT_UPDATE_1 NUMBER(16):= 0; -- Vble. para contar updates
    
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	-- TAR_ID, USU_ID 

	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
		T_JBV(9738918,'C+'),
		T_JBV(34571332,'C'),
		T_JBV(13527774,'C'),
		T_JBV(15530505,'C'),
		T_JBV(34486386,'C'),
		T_JBV(20739163,'C+'),
		T_JBV(34427445,'B'),
		T_JBV(34425369,'C'),
		T_JBV(21669405,'C'),
		T_JBV(21807990,'C+'),
		T_JBV(21980590,'C+'),
		T_JBV(22698137,'C'),
		T_JBV(23024666,'C+'),
		T_JBV(27357712,'C+'),
		T_JBV(27529120,'C'),
		T_JBV(27878351,'C+'),
		T_JBV(28834814,'C+'),
		T_JBV(28836638,'A-'),
		T_JBV(34317976,'C+'),
		T_JBV(29270802,'C+'),
		T_JBV(29451212,'C'),
		T_JBV(34294313,'C'),
		T_JBV(29672016,'C'),
		T_JBV(29808487,'C'),
		T_JBV(29901874,'C'),
		T_JBV(34278367,'C+'),
		T_JBV(31028910,'B'),
		T_JBV(31034555,'C'),
		T_JBV(31137683,'C+'),
		T_JBV(31286634,'C+'),
		T_JBV(31316269,'C+'),
		T_JBV(31352646,'B-'),
		T_JBV(31543573,'C'),
		T_JBV(31568582,'C'),
		T_JBV(34177180,'C'),
		T_JBV(33102195,'C'),
		T_JBV(33819563,'C+'),
		T_JBV(33839157,'C'),
		T_JBV(33878873,'C'),
		T_JBV(33883372,'B'),
		T_JBV(34000853,'B'),
		T_JBV(33892977,'B-'),
		T_JBV(33940031,'C'),
		T_JBV(33992397,'B+'),
		T_JBV(5631661,'C'),
		T_JBV(6518582,'C+'),
		T_JBV(34548712,'C+'),
		T_JBV(34548694,'C+'),
		T_JBV(34541455,'B-'),
		T_JBV(12521914,'C+'),
		T_JBV(13205297,'C'),
		T_JBV(34519630,'C+'),
		T_JBV(15752086,'B'),
		T_JBV(16383153,'C+'),
		T_JBV(16476736,'C'),
		T_JBV(19847605,'C'),
		T_JBV(20114835,'C'),
		T_JBV(20324561,'C'),
		T_JBV(34467002,'C'),
		T_JBV(20801275,'C'),
		T_JBV(34439318,'B-'),
		T_JBV(21403980,'C'),
		T_JBV(21775190,'B'),
		T_JBV(34425252,'C+'),
		T_JBV(22154547,'B-'),
		T_JBV(34422867,'B-'),
		T_JBV(22665389,'C+'),
		T_JBV(22701893,'C+'),
		T_JBV(34418191,'C+'),
		T_JBV(34415941,'B'),
		T_JBV(24999777,'C+'),
		T_JBV(25007027,'B-'),
		T_JBV(26130058,'B-'),
		T_JBV(26663893,'C'),
		T_JBV(27877439,'B+'),
		T_JBV(28458180,'C+'),
		T_JBV(34369991,'C'),
		T_JBV(28726566,'C'),
		T_JBV(28817119,'B-'),
		T_JBV(28874119,'C'),
		T_JBV(34352586,'B-'),
		T_JBV(34343350,'C'),
		T_JBV(34339529,'C'),
		T_JBV(29303776,'C'),
		T_JBV(31129845,'B+'),
		T_JBV(31152600,'C'),
		T_JBV(31901834,'C'),
		T_JBV(32038960,'A'),
		T_JBV(33781525,'B-'),
		T_JBV(34014316,'B-'),
		T_JBV(33831609,'B'),
		T_JBV(33904023,'C+'),
		T_JBV(33982015,'C'),
		T_JBV(9449774,'C'),
		T_JBV(34639850,'A-'),
		T_JBV(34635698,'C+'),
		T_JBV(6311765,'B-'),
		T_JBV(34631798,'C+'),
		T_JBV(34610338,'A-'),
		T_JBV(34590851,'B'),
		T_JBV(6899046,'C+'),
		T_JBV(34589397,'B'),
		T_JBV(8644638,'C+'),
		T_JBV(34588485,'B'),
		T_JBV(9208773,'C'),
		T_JBV(10025859,'B+'),
		T_JBV(34578688,'C'),
		T_JBV(10187091,'B-'),
		T_JBV(10288998,'C'),
		T_JBV(34574185,'C+'),
		T_JBV(34573273,'B-'),
		T_JBV(34572964,'B-'),
		T_JBV(34572361,'B-'),
		T_JBV(34570051,'C'),
		T_JBV(34567511,'B-'),
		T_JBV(34567025,'B-'),
		T_JBV(34566113,'C'),
		T_JBV(34560623,'C+'),
		T_JBV(34558257,'C'),
		T_JBV(34556316,'B'),
		T_JBV(34554357,'B-'),
		T_JBV(34549021,'C'),
		T_JBV(34548091,'B-'),
		T_JBV(34546033,'B-'),
		T_JBV(34533968,'B'),
		T_JBV(11943540,'B+'),
		T_JBV(11990509,'B+'),
		T_JBV(34533500,'B'),
		T_JBV(12072983,'C'),
		T_JBV(34527468,'C+'),
		T_JBV(34527117,'C'),
		T_JBV(12516209,'C'),
		T_JBV(12907551,'C'),
		T_JBV(34526673,'C+'),
		T_JBV(34524246,'B-'),
		T_JBV(34524012,'B-'),
		T_JBV(34523703,'B-'),
		T_JBV(13510252,'B-'),
		T_JBV(13667723,'B-'),
		T_JBV(13780821,'C+'),
		T_JBV(13797137,'B-'),
		T_JBV(34523568,'B'),
		T_JBV(14741241,'C'),
		T_JBV(34521492,'B-'),
		T_JBV(34520832,'B-'),
		T_JBV(34520715,'C+'),
		T_JBV(15434481,'C'),
		T_JBV(34517437,'B+'),
		T_JBV(34516525,'C+'),
		T_JBV(34514818,'C'),
		T_JBV(34514566,'B-'),
		T_JBV(34514080,'C'),
		T_JBV(16060016,'B'),
		T_JBV(16061765,'C'),
		T_JBV(34511578,'C'),
		T_JBV(16474291,'B'),
		T_JBV(34511461,'C'),
		T_JBV(16488474,'A-'),
		T_JBV(34511110,'C'),
		T_JBV(16613707,'C'),
		T_JBV(34509698,'C'),
		T_JBV(34504301,'B-'),
		T_JBV(17688071,'B'),
		T_JBV(34501898,'B'),
		T_JBV(34501664,'B-'),
		T_JBV(34501061,'B-'),
		T_JBV(34488093,'B-'),
		T_JBV(34486269,'C+'),
		T_JBV(34484211,'B'),
		T_JBV(34482972,'C'),
		T_JBV(19417249,'C'),
		T_JBV(19545928,'C'),
		T_JBV(19743178,'B+'),
		T_JBV(34482018,'B-'),
		T_JBV(34481826,'B'),
		T_JBV(20255075,'B-'),
		T_JBV(34477402,'B'),
		T_JBV(34477033,'C'),
		T_JBV(34464968,'C+'),
		T_JBV(34463453,'C+'),
		T_JBV(34459749,'C+'),
		T_JBV(34458837,'B'),
		T_JBV(34456761,'B-'),
		T_JBV(20915013,'C'),
		T_JBV(20989652,'B-'),
		T_JBV(34450803,'B-'),
		T_JBV(34441180,'B-'),
		T_JBV(21219707,'C'),
		T_JBV(34436933,'B-'),
		T_JBV(34429872,'B-'),
		T_JBV(34429638,'B-'),
		T_JBV(34429035,'B-'),
		T_JBV(21487948,'C+'),
		T_JBV(21519542,'B-'),
		T_JBV(34428123,'C'),
		T_JBV(21539253,'B-'),
		T_JBV(21655825,'B'),
		T_JBV(34426533,'B'),
		T_JBV(21663897,'B-'),
		T_JBV(21785590,'B'),
		T_JBV(21873758,'B-'),
		T_JBV(21918488,'B-'),
		T_JBV(22295993,'B-'),
		T_JBV(34420323,'B-'),
		T_JBV(22703249,'B-'),
		T_JBV(34418794,'C'),
		T_JBV(22750704,'C'),
		T_JBV(22785510,'B-'),
		T_JBV(22798646,'B+'),
		T_JBV(34418677,'C'),
		T_JBV(23049189,'B-'),
		T_JBV(34416970,'C'),
		T_JBV(23766847,'B+'),
		T_JBV(23789897,'B-'),
		T_JBV(34415707,'C'),
		T_JBV(23919105,'B-'),
		T_JBV(24000354,'B'),
		T_JBV(34415086,'B'),
		T_JBV(24041912,'B-'),
		T_JBV(24199809,'B'),
		T_JBV(24288754,'C'),
		T_JBV(25023675,'C'),
		T_JBV(25045462,'C+'),
		T_JBV(34410409,'C'),
		T_JBV(34409792,'B-'),
		T_JBV(26217978,'B-'),
		T_JBV(26308765,'B'),
		T_JBV(34408043,'C'),
		T_JBV(26482412,'C'),
		T_JBV(26526698,'C'),
		T_JBV(26655821,'C+'),
		T_JBV(34407617,'C'),
		T_JBV(34405775,'B-'),
		T_JBV(34404980,'C+'),
		T_JBV(34401875,'C'),
		T_JBV(27243488,'B-'),
		T_JBV(34399382,'B'),
		T_JBV(34394570,'B-'),
		T_JBV(34393307,'B'),
		T_JBV(27473780,'B-'),
		T_JBV(27473897,'B-'),
		T_JBV(27863508,'C'),
		T_JBV(27978743,'C'),
		T_JBV(28070467,'C'),
		T_JBV(34382580,'B-'),
		T_JBV(34381920,'B-'),
		T_JBV(34379554,'B-'),
		T_JBV(34376080,'B'),
		T_JBV(28309616,'C'),
		T_JBV(28310080,'B-'),
		T_JBV(28417243,'C'),
		T_JBV(34374373,'B-'),
		T_JBV(28430552,'C'),
		T_JBV(34374139,'B-'),
		T_JBV(34373713,'B+'),
		T_JBV(28532903,'C'),
		T_JBV(28548775,'B-'),
		T_JBV(28548892,'B-'),
		T_JBV(34373092,'B'),
		T_JBV(34368125,'B-'),
		T_JBV(34365623,'C+'),
		T_JBV(28658127,'B-'),
		T_JBV(28690352,'B-'),
		T_JBV(28735568,'B'),
		T_JBV(28750584,'C'),
		T_JBV(28751028,'C+'),
		T_JBV(34365137,'B'),
		T_JBV(34358193,'A'),
		T_JBV(34354311,'C'),
		T_JBV(34353381,'C'),
		T_JBV(28849540,'B-'),
		T_JBV(34352955,'C+'),
		T_JBV(29002057,'B-'),
		T_JBV(29027183,'C+'),
		T_JBV(29027318,'B-'),
		T_JBV(34333067,'B'),
		T_JBV(29086142,'B'),
		T_JBV(34323405,'B-'),
		T_JBV(29108173,'B'),
		T_JBV(29110539,'B'),
		T_JBV(34320768,'C'),
		T_JBV(29162068,'B'),
		T_JBV(29162554,'B+'),
		T_JBV(34318168,'B'),
		T_JBV(29186417,'B-'),
		T_JBV(29202238,'B'),
		T_JBV(29213919,'B-'),
		T_JBV(29251382,'B'),
		T_JBV(29265079,'A-'),
		T_JBV(34310503,'C'),
		T_JBV(29374959,'C'),
		T_JBV(29375034,'C'),
		T_JBV(29405992,'C'),
		T_JBV(29715039,'B'),
		T_JBV(34292840,'B-'),
		T_JBV(29756228,'B-'),
		T_JBV(29968750,'C'),
		T_JBV(30005454,'B+'),
		T_JBV(34288164,'C+'),
		T_JBV(30162729,'B-'),
		T_JBV(31010710,'B'),
		T_JBV(34286709,'A-'),
		T_JBV(31014475,'B'),
		T_JBV(31027026,'C'),
		T_JBV(34253475,'B-'),
		T_JBV(31085541,'B+'),
		T_JBV(31087131,'B'),
		T_JBV(31094291,'B-'),
		T_JBV(31142434,'C+'),
		T_JBV(31172176,'B+'),
		T_JBV(31178521,'B'),
		T_JBV(31188804,'B+'),
		T_JBV(34245403,'B-'),
		T_JBV(31206197,'B'),
		T_JBV(31225014,'C+'),
		T_JBV(31236443,'B'),
		T_JBV(31247152,'C'),
		T_JBV(34232132,'C'),
		T_JBV(34226721,'C'),
		T_JBV(31273966,'B'),
		T_JBV(31280775,'C'),
		T_JBV(31313164,'C+'),
		T_JBV(31314931,'C'),
		T_JBV(31331906,'B'),
		T_JBV(34221423,'B-'),
		T_JBV(31370047,'B-'),
		T_JBV(31376140,'B-'),
		T_JBV(31655721,'B'),
		T_JBV(32174154,'B-'),
		T_JBV(32261410,'B-'),
		T_JBV(32289524,'B'),
		T_JBV(32388383,'C'),
		T_JBV(34190507,'B-'),
		T_JBV(34083891,'B-'),
		T_JBV(32877105,'B-'),
		T_JBV(33016958,'B-'),
		T_JBV(34071667,'C+'),
		T_JBV(34070638,'B-'),
		T_JBV(34046017,'B'),
		T_JBV(33793632,'B'),
		T_JBV(34030595,'C'),
		T_JBV(33812441,'B-'),
		T_JBV(34020195,'C'),
		T_JBV(33840611,'C+'),
		T_JBV(33840845,'B+'),
		T_JBV(33841037,'B'),
		T_JBV(33841154,'B'),
		T_JBV(33841388,'B'),
		T_JBV(33841406,'B'),
		T_JBV(34003841,'B'),
		T_JBV(33883858,'B'),
		T_JBV(34001648,'C+'),
		T_JBV(33892509,'C'),
		T_JBV(33903948,'C'),
		T_JBV(33933339,'B+'),
		T_JBV(33994239,'B-'),
		T_JBV(33938637,'A-'),
		T_JBV(33963819,'B'),
		T_JBV(33970745,'B-'),
		T_JBV(33971909,'B-'),
		T_JBV(32388518,'C'),
		T_JBV(33789073,'B-'),
		T_JBV(12619103,'C'),
		T_JBV(22958064,'C'),
		T_JBV(27104838,'C+'),
		T_JBV(29196934,'C+'),
		T_JBV(31499348,'C'),
		T_JBV(31502753,'B-'),
		T_JBV(31767968,'A-'),
		T_JBV(32979186,'C'),
		T_JBV(33883021,'B-')


				); 
	V_TMP_JBV T_JBV;
    
BEGIN	
	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	
	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
	V_TMP_JBV := V_JBV(I);

	V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO_UVEM = '||V_TMP_JBV(1)||'';
	
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS_1;
	
	IF V_NUM_FILAS_1 > 0 THEN
	
		V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_ACTIVO 
               		   SET DD_RTG_ID = (SELECT DD_RTG_ID FROM '||V_ESQUEMA||'.DD_RTG_RATING_ACTIVO WHERE DD_RTG_DESCRIPCION = '''||V_TMP_JBV(2)||'''), 
                    	   USUARIOMODIFICAR = ''REMVIP-7709'', 
                    	   FECHAMODIFICAR = SYSDATE 
		           WHERE ACT_NUM_ACTIVO_UVEM = '||V_TMP_JBV(1)||'';

		EXECUTE IMMEDIATE V_MSQL;
    
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO CON ACT_NUM_ACTIVO_UVEM: '||ACT_NUM||' ACTUALIZADO');
		
		V_COUNT_UPDATE_1 := V_COUNT_UPDATE_1 + 1;
		
	ELSE
		
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO NO EXISTE');
		
	END IF;
	
	END LOOP;

	DBMS_OUTPUT.PUT_LINE('********************************************************************');

	DBMS_OUTPUT.PUT_LINE('[FIN] Se han updateado en total '||V_COUNT_UPDATE_1||' registros EN ACT_ACTIVO');
	
	COMMIT;
	
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(V_MSQL);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
