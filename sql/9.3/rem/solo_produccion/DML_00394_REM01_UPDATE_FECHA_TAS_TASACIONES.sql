--/*
--##########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20200715
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-7794
--## PRODUCTO=NO
--## 
--## Finalidad: Script que añade en ACT_TAS_TASACION los datos añadidos en T_ARRAY_DATA
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
        V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(25 CHAR):= 'ACT_TAS_TASACION';
    V_COUNT NUMBER(16); -- Vble. para contar.
    V_KOUNT NUMBER(16); -- Vble. para kontar.
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

	ACT_NUM_ACTIVO NUMBER(16);
	ACT_ID NUMBER(16);
	NUM_SECUENCIA_VAL NUMBER(16);
	NUM_SECUENCIA_TAS NUMBER(16);
	BIE_ID NUMBER(16);

    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-7794';    
    
    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    			-- NUM_ACT	TAS_IMPORTE_VALOR_TASACION      TAS_IMPORTE_TAS_FIN
				T_TIPO_DATA(7233829,20160407,20160407),
				T_TIPO_DATA(7283025,19530101,19530101),
				T_TIPO_DATA(7230252,20170727,20170727),
				T_TIPO_DATA(7248301,20160201,20160201),
				T_TIPO_DATA(7250536,20070523,20070523),
				T_TIPO_DATA(7263662,20160422,20160422),
				T_TIPO_DATA(7263693,20170620,20170620),
				T_TIPO_DATA(7264087,20180306,20180306),
				T_TIPO_DATA(7264530,20171130,20171130),
				T_TIPO_DATA(7264561,20170407,20170407),
				T_TIPO_DATA(7267110,20151029,20151029),
				T_TIPO_DATA(7268433,20160620,20160620),
				T_TIPO_DATA(7268588,19530101,19530101),
				T_TIPO_DATA(7269037,20170607,20170607),
				T_TIPO_DATA(7269141,20171108,20171108),
				T_TIPO_DATA(7271695,20160308,20160308),
				T_TIPO_DATA(7271868,19530101,19530101),
				T_TIPO_DATA(7283037,20180306,20180306),
				T_TIPO_DATA(7231630,20180110,20180110),
				T_TIPO_DATA(7231677,19530101,19530101),
				T_TIPO_DATA(7232186,20160425,20160425),
				T_TIPO_DATA(7232249,20160427,20160427),
				T_TIPO_DATA(7288718,20170721,20170721),
				T_TIPO_DATA(7232610,20170726,20170726),
				T_TIPO_DATA(7232836,20150420,20150420),
				T_TIPO_DATA(7233245,20160129,20160129),
				T_TIPO_DATA(7233246,20160129,20160129),
				T_TIPO_DATA(7236937,20171201,20171201),
				T_TIPO_DATA(7239159,19530101,19530101),
				T_TIPO_DATA(7247016,20160401,20160401),
				T_TIPO_DATA(7247125,20170216,20170216),
				T_TIPO_DATA(7248737,19530101,19530101),
				T_TIPO_DATA(7249788,20170731,20170731),
				T_TIPO_DATA(7251379,20170426,20170426),
				T_TIPO_DATA(7251678,20171017,20171017),
				T_TIPO_DATA(7251762,19530101,19530101),
				T_TIPO_DATA(7251791,19530101,19530101),
				T_TIPO_DATA(7251803,19530101,19530101),
				T_TIPO_DATA(7251929,19530101,19530101),
				T_TIPO_DATA(7252085,19530101,19530101),
				T_TIPO_DATA(7252098,19530101,19530101),
				T_TIPO_DATA(7252101,20180306,20180306),
				T_TIPO_DATA(7252128,19530101,19530101),
				T_TIPO_DATA(7252379,19530101,19530101),
				T_TIPO_DATA(7252794,20151119,20151119),
				T_TIPO_DATA(7252871,20151117,20151117),
				T_TIPO_DATA(7253414,20171124,20171124),
				T_TIPO_DATA(7253428,19530101,19530101),
				T_TIPO_DATA(7253575,20171017,20171017),
				T_TIPO_DATA(7253947,20170512,20170512),
				T_TIPO_DATA(7254126,19530101,19530101),
				T_TIPO_DATA(7254130,19530101,19530101),
				T_TIPO_DATA(7254611,20171120,20171120),
				T_TIPO_DATA(7254632,20171019,20171019),
				T_TIPO_DATA(7255676,20180406,20180406),
				T_TIPO_DATA(7255909,20150327,20150327),
				T_TIPO_DATA(7255950,19530101,19530101),
				T_TIPO_DATA(7256185,19530101,19530101),
				T_TIPO_DATA(7256499,19530101,19530101),
				T_TIPO_DATA(7256886,19530101,19530101),
				T_TIPO_DATA(7256904,19530101,19530101),
				T_TIPO_DATA(7257482,19530101,19530101),
				T_TIPO_DATA(7257883,20171204,20171204),
				T_TIPO_DATA(7257913,19530101,19530101),
				T_TIPO_DATA(7258139,19530101,19530101),
				T_TIPO_DATA(7258408,20171121,20171121),
				T_TIPO_DATA(7258623,20151201,20151201),
				T_TIPO_DATA(7259915,19530101,19530101),
				T_TIPO_DATA(7259970,19530101,19530101),
				T_TIPO_DATA(7259971,19530101,19530101),
				T_TIPO_DATA(7259972,19530101,19530101),
				T_TIPO_DATA(7260214,20171116,20171116),
				T_TIPO_DATA(7260226,20171116,20171116),
				T_TIPO_DATA(7260312,19530101,19530101),
				T_TIPO_DATA(7261369,20160907,20160907),
				T_TIPO_DATA(7261370,20160907,20160907),
				T_TIPO_DATA(7263545,20161102,20161102),
				T_TIPO_DATA(7268068,20170607,20170607),
				T_TIPO_DATA(7269907,20180309,20180309),
				T_TIPO_DATA(7270829,20160714,20160714),
				T_TIPO_DATA(7270830,20160714,20160714),
				T_TIPO_DATA(7270831,20160714,20160714),
				T_TIPO_DATA(7270832,20160714,20160714),
				T_TIPO_DATA(7270833,20160714,20160714),
				T_TIPO_DATA(7270834,20160714,20160714),
				T_TIPO_DATA(7270835,20160714,20160714),
				T_TIPO_DATA(7270836,20160714,20160714),
				T_TIPO_DATA(7270837,20160714,20160714),
				T_TIPO_DATA(7270838,20160714,20160714),
				T_TIPO_DATA(7270839,20160714,20160714),
				T_TIPO_DATA(7270840,20160714,20160714),
				T_TIPO_DATA(7270841,20160714,20160714),
				T_TIPO_DATA(7270842,20160714,20160714),
				T_TIPO_DATA(7270843,20160714,20160714),
				T_TIPO_DATA(7270844,20160714,20160714),
				T_TIPO_DATA(7270845,20160714,20160714),
				T_TIPO_DATA(7270846,20160714,20160714),
				T_TIPO_DATA(7270847,20160714,20160714),
				T_TIPO_DATA(7270848,20160714,20160714),
				T_TIPO_DATA(7270849,20160714,20160714),
				T_TIPO_DATA(7270850,20160714,20160714),
				T_TIPO_DATA(7270851,20160714,20160714),
				T_TIPO_DATA(7270852,20160714,20160714),
				T_TIPO_DATA(7270853,20160714,20160714),
				T_TIPO_DATA(7270854,20160714,20160714),
				T_TIPO_DATA(7272634,20170111,20170111),
				T_TIPO_DATA(7273274,20180306,20180306),
				T_TIPO_DATA(7273505,20160401,20160401),
				T_TIPO_DATA(7274783,20160120,20160120),
				T_TIPO_DATA(7275286,20150625,20150625),
				T_TIPO_DATA(7277205,19530101,19530101),
				T_TIPO_DATA(7277250,19530101,19530101),
				T_TIPO_DATA(7277552,20160929,20160929),
				T_TIPO_DATA(7278047,19530101,19530101),
				T_TIPO_DATA(7279378,20150824,20150824),
				T_TIPO_DATA(7279379,20150824,20150824),
				T_TIPO_DATA(7279380,20150824,20150824),
				T_TIPO_DATA(7279381,20150824,20150824),
				T_TIPO_DATA(7279382,20150824,20150824),
				T_TIPO_DATA(7279383,20150824,20150824),
				T_TIPO_DATA(7279384,20150824,20150824),
				T_TIPO_DATA(7279385,20150824,20150824),
				T_TIPO_DATA(7279386,20150824,20150824),
				T_TIPO_DATA(7279387,20150824,20150824),
				T_TIPO_DATA(7279388,20150824,20150824),
				T_TIPO_DATA(7279389,20150824,20150824),
				T_TIPO_DATA(7279390,20150824,20150824),
				T_TIPO_DATA(7279391,20150824,20150824),
				T_TIPO_DATA(7279392,20150824,20150824),
				T_TIPO_DATA(7279393,20150824,20150824),
				T_TIPO_DATA(7279394,20150824,20150824),
				T_TIPO_DATA(7279395,20150824,20150824),
				T_TIPO_DATA(7279396,20150824,20150824),
				T_TIPO_DATA(7279397,20150824,20150824),
				T_TIPO_DATA(7279398,20150824,20150824),
				T_TIPO_DATA(7279399,20150824,20150824),
				T_TIPO_DATA(7279400,20150824,20150824),
				T_TIPO_DATA(7279401,20150824,20150824),
				T_TIPO_DATA(7279402,20150824,20150824),
				T_TIPO_DATA(7279403,20150824,20150824),
				T_TIPO_DATA(7279404,20150824,20150824),
				T_TIPO_DATA(7279405,20150824,20150824),
				T_TIPO_DATA(7279406,20150824,20150824),
				T_TIPO_DATA(7279407,20150824,20150824),
				T_TIPO_DATA(7279408,20150824,20150824),
				T_TIPO_DATA(7279409,20150824,20150824),
				T_TIPO_DATA(7279410,20150824,20150824),
				T_TIPO_DATA(7279411,20150824,20150824),
				T_TIPO_DATA(7279412,20150824,20150824),
				T_TIPO_DATA(7279413,20150824,20150824),
				T_TIPO_DATA(7279414,20150824,20150824),
				T_TIPO_DATA(7279415,20150824,20150824),
				T_TIPO_DATA(7279416,20150824,20150824),
				T_TIPO_DATA(7279417,20150824,20150824),
				T_TIPO_DATA(7279418,20150824,20150824),
				T_TIPO_DATA(7279419,20150824,20150824),
				T_TIPO_DATA(7279566,20160208,20160208),
				T_TIPO_DATA(7291972,20161102,20161102),
				T_TIPO_DATA(7280469,20140527,20140527),
				T_TIPO_DATA(7280470,20140527,20140527),
				T_TIPO_DATA(7280471,20140527,20140527),
				T_TIPO_DATA(7280472,20140527,20140527),
				T_TIPO_DATA(7280473,20140527,20140527),
				T_TIPO_DATA(7280474,20140527,20140527),
				T_TIPO_DATA(7280475,20140527,20140527),
				T_TIPO_DATA(7280476,20140527,20140527),
				T_TIPO_DATA(7280477,20140527,20140527),
				T_TIPO_DATA(7280478,20140527,20140527),
				T_TIPO_DATA(7280479,20140527,20140527),
				T_TIPO_DATA(7280480,20140527,20140527),
				T_TIPO_DATA(7280481,20140527,20140527),
				T_TIPO_DATA(7280482,20140527,20140527),
				T_TIPO_DATA(7280483,20140527,20140527),
				T_TIPO_DATA(7280484,20140527,20140527),
				T_TIPO_DATA(7280485,20140527,20140527),
				T_TIPO_DATA(7280486,20140527,20140527),
				T_TIPO_DATA(7280487,20140527,20140527),
				T_TIPO_DATA(7280488,20140527,20140527),
				T_TIPO_DATA(7280489,20140527,20140527),
				T_TIPO_DATA(7280490,20140527,20140527),
				T_TIPO_DATA(7280491,20140527,20140527),
				T_TIPO_DATA(7280492,20140527,20140527),
				T_TIPO_DATA(7280493,20140527,20140527),
				T_TIPO_DATA(7280494,20140527,20140527),
				T_TIPO_DATA(7280495,20140527,20140527),
				T_TIPO_DATA(7280496,20140527,20140527),
				T_TIPO_DATA(7280497,20140527,20140527),
				T_TIPO_DATA(7280498,20140527,20140527),
				T_TIPO_DATA(7280721,20170629,20170629),
				T_TIPO_DATA(7280897,20180614,20180614),
				T_TIPO_DATA(7280898,20180308,20180308),
				T_TIPO_DATA(7280899,20161223,20161223),
				T_TIPO_DATA(7281278,20180306,20180306),
				T_TIPO_DATA(7281571,19530101,19530101),
				T_TIPO_DATA(7281572,19530101,19530101),
				T_TIPO_DATA(7281573,19530101,19530101),
				T_TIPO_DATA(7281574,19530101,19530101),
				T_TIPO_DATA(7281575,19530101,19530101),
				T_TIPO_DATA(7281576,19530101,19530101),
				T_TIPO_DATA(7281577,19530101,19530101),
				T_TIPO_DATA(7281578,19530101,19530101),
				T_TIPO_DATA(7292080,20160322,20160322),
				T_TIPO_DATA(7292081,20160322,20160322),
				T_TIPO_DATA(7282280,20170412,20170412)



		); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN	
	
    DBMS_OUTPUT.PUT_LINE('[INICIO] ');


    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
      LOOP
      
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
    	ACT_NUM_ACTIVO := V_TMP_TIPO_DATA(1);
       	EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO INTO V_KOUNT;
  			  
		IF V_KOUNT > 0 THEN 
	  			  
			EXECUTE IMMEDIATE 'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO INTO ACT_ID;
	
			
			DBMS_OUTPUT.PUT_LINE('UPDATEANDO EL ACTIVO '||ACT_NUM_ACTIVO||' EN '||V_TABLA);
			
			V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' 
				  SET TAS_FECHA_INI_TASACION = TO_DATE('''||V_TMP_TIPO_DATA(3)||''', ''yyyymmdd'')
				     ,USUARIOMODIFICAR = '''||V_USUARIO||'''
				     ,FECHAMODIFICAR = SYSDATE
				  WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '''||V_TMP_TIPO_DATA(1)||''')';
			EXECUTE IMMEDIATE V_SQL;

			V_SQL := 'UPDATE '||V_ESQUEMA||'.BIE_VALORACIONES
				  SET BIE_FECHA_VALOR_TASACION = TO_DATE('''||V_TMP_TIPO_DATA(2)||''', ''yyyymmdd'')
				     ,USUARIOMODIFICAR = '''||V_USUARIO||'''
				     ,FECHAMODIFICAR = SYSDATE
				  WHERE BIE_ID = (SELECT BIE_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '''||V_TMP_TIPO_DATA(1)||''')';

			EXECUTE IMMEDIATE V_SQL;
			
			DBMS_OUTPUT.PUT_LINE('MODIFICANDO EL ACTIVO '||ACT_NUM_ACTIVO||' EN '||V_TABLA);
			
			V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
				
		ELSE
			
			DBMS_OUTPUT.PUT_LINE('[INFO] El activo '||ACT_NUM_ACTIVO||' no existe!');
			
		END IF;
		
      END LOOP;
    COMMIT;

    DBMS_OUTPUT.PUT_LINE('[INFO] Se han insertado en total '||V_COUNT_UPDATE||' registros en la tabla '||V_TABLA);
   

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;
/
EXIT
