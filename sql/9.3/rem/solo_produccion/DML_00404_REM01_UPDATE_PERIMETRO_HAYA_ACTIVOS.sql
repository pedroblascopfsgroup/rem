--/*
--##########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20200723
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-7838
--## PRODUCTO=NO
--##
--## Finalidad: 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

   PAC_INC NUMBER(32):= 0;
   PAC_CHECK_TRA_ADM NUMBER(32):= 0;
   PAC_CHECK_GEST NUMBER(32):= 0;
   PAC_CHECK_ASIGNAR_MED NUMBER(32):= 0;
   PAC_CHECK_COMERC NUMBER(32):= 0;
   PAC_CHECK_FORM NUMBER(32):= 0;
   PL_OUTPUT VARCHAR2(1024 CHAR);
   V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar        
   V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
   V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
   ACT_ID NUMBER(32);
   ERR_NUM NUMBER(25); -- Vble. auxiliar para registrar errores en el script.
   ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
   DESCRIPCION VARCHAR2(64 CHAR);
   V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
   V_USUARIO VARCHAR2(65 CHAR) := 'REMVIP-7838';

    V_TEXT1 VARCHAR2(2400 CHAR); -- Vble. auxiliar
    V_ENTIDAD_ID NUMBER(16);
    V_ID NUMBER(16);
    
    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
		T_TIPO_DATA('7301884'),
T_TIPO_DATA('7301752'),
T_TIPO_DATA('7301753'),
T_TIPO_DATA('7301754'),
T_TIPO_DATA('7301755'),
T_TIPO_DATA('7301756'),
T_TIPO_DATA('7301765'),
T_TIPO_DATA('7301766'),
T_TIPO_DATA('7301767'),
T_TIPO_DATA('7301768'),
T_TIPO_DATA('7301769'),
T_TIPO_DATA('7301770'),
T_TIPO_DATA('7301771'),
T_TIPO_DATA('7301772'),
T_TIPO_DATA('7301773'),
T_TIPO_DATA('7301774'),
T_TIPO_DATA('7301775'),
T_TIPO_DATA('7301776'),
T_TIPO_DATA('7301777'),
T_TIPO_DATA('7301778'),
T_TIPO_DATA('7301779'),
T_TIPO_DATA('7301780'),
T_TIPO_DATA('7301781'),
T_TIPO_DATA('7301782'),
T_TIPO_DATA('7301792'),
T_TIPO_DATA('7301793'),
T_TIPO_DATA('7301794'),
T_TIPO_DATA('7301795'),
T_TIPO_DATA('7301796'),
T_TIPO_DATA('7301797'),
T_TIPO_DATA('7301798'),
T_TIPO_DATA('7301799'),
T_TIPO_DATA('7301800'),
T_TIPO_DATA('7301801'),
T_TIPO_DATA('7301802'),
T_TIPO_DATA('7301803'),
T_TIPO_DATA('7301804'),
T_TIPO_DATA('7301805'),
T_TIPO_DATA('7301806'),
T_TIPO_DATA('7301807'),
T_TIPO_DATA('7301808'),
T_TIPO_DATA('7301809'),
T_TIPO_DATA('7301810'),
T_TIPO_DATA('7301813'),
T_TIPO_DATA('7301814'),
T_TIPO_DATA('7301815'),
T_TIPO_DATA('7301837'),
T_TIPO_DATA('7301838'),
T_TIPO_DATA('7301839'),
T_TIPO_DATA('7301840'),
T_TIPO_DATA('7301841'),
T_TIPO_DATA('7301842'),
T_TIPO_DATA('7301546'),
T_TIPO_DATA('7301547'),
T_TIPO_DATA('7301560'),
T_TIPO_DATA('7301563'),
T_TIPO_DATA('7301140'),
T_TIPO_DATA('7301146'),
T_TIPO_DATA('7301147'),
T_TIPO_DATA('7301148'),
T_TIPO_DATA('7301149'),
T_TIPO_DATA('7301150'),
T_TIPO_DATA('7301151'),
T_TIPO_DATA('7301152'),
T_TIPO_DATA('7301153'),
T_TIPO_DATA('7301154'),
T_TIPO_DATA('7301155'),
T_TIPO_DATA('7301314'),
T_TIPO_DATA('7301315'),
T_TIPO_DATA('7301316'),
T_TIPO_DATA('7301317'),
T_TIPO_DATA('7301318'),
T_TIPO_DATA('7301319'),
T_TIPO_DATA('7301320'),
T_TIPO_DATA('7301321'),
T_TIPO_DATA('7301322'),
T_TIPO_DATA('7301323'),
T_TIPO_DATA('7301324'),
T_TIPO_DATA('7301325'),
T_TIPO_DATA('7301326'),
T_TIPO_DATA('7301327'),
T_TIPO_DATA('7301328'),
T_TIPO_DATA('7301329'),
T_TIPO_DATA('7301330'),
T_TIPO_DATA('7301331'),
T_TIPO_DATA('7301332'),
T_TIPO_DATA('7301333'),
T_TIPO_DATA('7301334'),
T_TIPO_DATA('7301335'),
T_TIPO_DATA('7301336'),
T_TIPO_DATA('7301337'),
T_TIPO_DATA('7301338'),
T_TIPO_DATA('7301339'),
T_TIPO_DATA('7301340'),
T_TIPO_DATA('7301341'),
T_TIPO_DATA('7301342'),
T_TIPO_DATA('7301343'),
T_TIPO_DATA('7301344'),
T_TIPO_DATA('7301345'),
T_TIPO_DATA('7301346'),
T_TIPO_DATA('7301347'),
T_TIPO_DATA('7301348'),
T_TIPO_DATA('7301349'),
T_TIPO_DATA('7301350'),
T_TIPO_DATA('7301351'),
T_TIPO_DATA('7301352'),
T_TIPO_DATA('7301353'),
T_TIPO_DATA('7301354'),
T_TIPO_DATA('7301355'),
T_TIPO_DATA('7301356'),
T_TIPO_DATA('7301357'),
T_TIPO_DATA('7301358'),
T_TIPO_DATA('7301359'),
T_TIPO_DATA('7301360'),
T_TIPO_DATA('7301361'),
T_TIPO_DATA('7301362'),
T_TIPO_DATA('7301363'),
T_TIPO_DATA('7301364'),
T_TIPO_DATA('7301365'),
T_TIPO_DATA('7301366'),
T_TIPO_DATA('7301367'),
T_TIPO_DATA('7301368'),
T_TIPO_DATA('7301369'),
T_TIPO_DATA('7301370'),
T_TIPO_DATA('7301371'),
T_TIPO_DATA('7301372'),
T_TIPO_DATA('7301373'),
T_TIPO_DATA('7301374'),
T_TIPO_DATA('7301375'),
T_TIPO_DATA('7301376'),
T_TIPO_DATA('7301377'),
T_TIPO_DATA('7301378'),
T_TIPO_DATA('7301379'),
T_TIPO_DATA('7301380'),
T_TIPO_DATA('7301381'),
T_TIPO_DATA('7301382'),
T_TIPO_DATA('7301383'),
T_TIPO_DATA('7301384'),
T_TIPO_DATA('7301385'),
T_TIPO_DATA('7301386'),
T_TIPO_DATA('7301387'),
T_TIPO_DATA('7301388'),
T_TIPO_DATA('7301389'),
T_TIPO_DATA('7301394'),
T_TIPO_DATA('7301395'),
T_TIPO_DATA('7301396'),
T_TIPO_DATA('7301397'),
T_TIPO_DATA('7301398'),
T_TIPO_DATA('7301399'),
T_TIPO_DATA('7301400'),
T_TIPO_DATA('7301401'),
T_TIPO_DATA('7301402'),
T_TIPO_DATA('7301403'),
T_TIPO_DATA('7301404'),
T_TIPO_DATA('7301405'),
T_TIPO_DATA('7301406'),
T_TIPO_DATA('7301407'),
T_TIPO_DATA('7301408'),
T_TIPO_DATA('7301409'),
T_TIPO_DATA('7301414'),
T_TIPO_DATA('7301415'),
T_TIPO_DATA('7301416'),
T_TIPO_DATA('7301417'),
T_TIPO_DATA('7301418'),
T_TIPO_DATA('7301419'),
T_TIPO_DATA('7301420'),
T_TIPO_DATA('7301421'),
T_TIPO_DATA('7301422'),
T_TIPO_DATA('7301423'),
T_TIPO_DATA('7301424'),
T_TIPO_DATA('7301425'),
T_TIPO_DATA('7301426'),
T_TIPO_DATA('7301427'),
T_TIPO_DATA('7301428'),
T_TIPO_DATA('7301429'),
T_TIPO_DATA('7301430'),
T_TIPO_DATA('7301431'),
T_TIPO_DATA('7301432'),
T_TIPO_DATA('7301433'),
T_TIPO_DATA('7301434'),
T_TIPO_DATA('7301435'),
T_TIPO_DATA('7301436'),
T_TIPO_DATA('7301437'),
T_TIPO_DATA('7301438'),
T_TIPO_DATA('7301439'),
T_TIPO_DATA('7301440'),
T_TIPO_DATA('7301441'),
T_TIPO_DATA('7301446'),
T_TIPO_DATA('7301447'),
T_TIPO_DATA('7301448'),
T_TIPO_DATA('7301449'),
T_TIPO_DATA('7301450'),
T_TIPO_DATA('7301451'),
T_TIPO_DATA('7301452'),
T_TIPO_DATA('7301453'),
T_TIPO_DATA('7301454'),
T_TIPO_DATA('7301455'),
T_TIPO_DATA('7301458'),
T_TIPO_DATA('7301459'),
T_TIPO_DATA('7301460'),
T_TIPO_DATA('7301461'),
T_TIPO_DATA('7301462'),
T_TIPO_DATA('7301463'),
T_TIPO_DATA('7301464'),
T_TIPO_DATA('7301465'),
T_TIPO_DATA('7301466'),
T_TIPO_DATA('7301467'),
T_TIPO_DATA('7301468'),
T_TIPO_DATA('7301469'),
T_TIPO_DATA('7301470'),
T_TIPO_DATA('7301471'),
T_TIPO_DATA('7301472'),
T_TIPO_DATA('7301473'),
T_TIPO_DATA('7301474'),
T_TIPO_DATA('7301475'),
T_TIPO_DATA('7301476'),
T_TIPO_DATA('7301477'),
T_TIPO_DATA('7301478'),
T_TIPO_DATA('7301479'),
T_TIPO_DATA('7301480'),
T_TIPO_DATA('7301481'),
T_TIPO_DATA('7301482'),
T_TIPO_DATA('7301483'),
T_TIPO_DATA('7301484'),
T_TIPO_DATA('7301485'),
T_TIPO_DATA('7301488'),
T_TIPO_DATA('7301489'),
T_TIPO_DATA('7301490'),
T_TIPO_DATA('7301491'),
T_TIPO_DATA('7301492'),
T_TIPO_DATA('7301493'),
T_TIPO_DATA('7301494'),
T_TIPO_DATA('7301495'),
T_TIPO_DATA('7301496'),
T_TIPO_DATA('7301497'),
T_TIPO_DATA('7301498'),
T_TIPO_DATA('7301499'),
T_TIPO_DATA('7301500'),
T_TIPO_DATA('7301501'),
T_TIPO_DATA('7301502'),
T_TIPO_DATA('7301503'),
T_TIPO_DATA('7301504'),
T_TIPO_DATA('7301505'),
T_TIPO_DATA('7301506'),
T_TIPO_DATA('7301507'),
T_TIPO_DATA('7301508'),
T_TIPO_DATA('7301509'),
T_TIPO_DATA('7301510'),
T_TIPO_DATA('7301511'),
T_TIPO_DATA('7301512'),
T_TIPO_DATA('7301513'),
T_TIPO_DATA('7301514'),
T_TIPO_DATA('7301515'),
T_TIPO_DATA('7301516'),
T_TIPO_DATA('7301517'),
T_TIPO_DATA('7301518'),
T_TIPO_DATA('7301519'),
T_TIPO_DATA('7301520'),
T_TIPO_DATA('7301521'),
T_TIPO_DATA('7301522'),
T_TIPO_DATA('7301523'),
T_TIPO_DATA('7301524'),
T_TIPO_DATA('7301525'),
T_TIPO_DATA('7301529'),
T_TIPO_DATA('7301530'),
T_TIPO_DATA('7301554'),
T_TIPO_DATA('7301555'),
T_TIPO_DATA('7301556'),
T_TIPO_DATA('7301557'),
T_TIPO_DATA('7301564'),
T_TIPO_DATA('7301565'),
T_TIPO_DATA('7301566'),
T_TIPO_DATA('7301567'),
T_TIPO_DATA('7301568'),
T_TIPO_DATA('7301569'),
T_TIPO_DATA('7301129'),
T_TIPO_DATA('7301130'),
T_TIPO_DATA('7301131'),
T_TIPO_DATA('7301156'),
T_TIPO_DATA('7301157'),
T_TIPO_DATA('7301158'),
T_TIPO_DATA('7301159'),
T_TIPO_DATA('7301160'),
T_TIPO_DATA('7301161'),
T_TIPO_DATA('7301162'),
T_TIPO_DATA('7301163'),
T_TIPO_DATA('7301164'),
T_TIPO_DATA('7301165'),
T_TIPO_DATA('7301166'),
T_TIPO_DATA('7301167'),
T_TIPO_DATA('7301168'),
T_TIPO_DATA('7301169'),
T_TIPO_DATA('7301170'),
T_TIPO_DATA('7301171'),
T_TIPO_DATA('7301176'),
T_TIPO_DATA('7301177'),
T_TIPO_DATA('7301178'),
T_TIPO_DATA('7301179'),
T_TIPO_DATA('7301184'),
T_TIPO_DATA('7301185'),
T_TIPO_DATA('7301186'),
T_TIPO_DATA('7301187'),
T_TIPO_DATA('7301188'),
T_TIPO_DATA('7301189'),
T_TIPO_DATA('7301190'),
T_TIPO_DATA('7301191'),
T_TIPO_DATA('7301192'),
T_TIPO_DATA('7301193'),
T_TIPO_DATA('7301194'),
T_TIPO_DATA('7301195'),
T_TIPO_DATA('7301196'),
T_TIPO_DATA('7301197'),
T_TIPO_DATA('7301198'),
T_TIPO_DATA('7301199'),
T_TIPO_DATA('7301204'),
T_TIPO_DATA('7301205'),
T_TIPO_DATA('7301206'),
T_TIPO_DATA('7301207'),
T_TIPO_DATA('7301208'),
T_TIPO_DATA('7301209'),
T_TIPO_DATA('7301210'),
T_TIPO_DATA('7301211'),
T_TIPO_DATA('7301212'),
T_TIPO_DATA('7301213'),
T_TIPO_DATA('7301214'),
T_TIPO_DATA('7301215'),
T_TIPO_DATA('7301216'),
T_TIPO_DATA('7301217'),
T_TIPO_DATA('7301218'),
T_TIPO_DATA('7301219'),
T_TIPO_DATA('7301220'),
T_TIPO_DATA('7301221'),
T_TIPO_DATA('7301222'),
T_TIPO_DATA('7301223'),
T_TIPO_DATA('7301228'),
T_TIPO_DATA('7301229'),
T_TIPO_DATA('7301230'),
T_TIPO_DATA('7301231'),
T_TIPO_DATA('7301232'),
T_TIPO_DATA('7301233'),
T_TIPO_DATA('7301234'),
T_TIPO_DATA('7301235'),
T_TIPO_DATA('7301236'),
T_TIPO_DATA('7301237'),
T_TIPO_DATA('7301238'),
T_TIPO_DATA('7301239'),
T_TIPO_DATA('7301240'),
T_TIPO_DATA('7301241'),
T_TIPO_DATA('7301242'),
T_TIPO_DATA('7301243'),
T_TIPO_DATA('7301244'),
T_TIPO_DATA('7301245'),
T_TIPO_DATA('7301246'),
T_TIPO_DATA('7301247'),
T_TIPO_DATA('7301248'),
T_TIPO_DATA('7301249'),
T_TIPO_DATA('7301250'),
T_TIPO_DATA('7301251'),
T_TIPO_DATA('7301252'),
T_TIPO_DATA('7301253'),
T_TIPO_DATA('7301254'),
T_TIPO_DATA('7301255'),
T_TIPO_DATA('7301256'),
T_TIPO_DATA('7301257'),
T_TIPO_DATA('7301258'),
T_TIPO_DATA('7301259'),
T_TIPO_DATA('7301260'),
T_TIPO_DATA('7301261'),
T_TIPO_DATA('7301262'),
T_TIPO_DATA('7301263'),
T_TIPO_DATA('7301264'),
T_TIPO_DATA('7301265'),
T_TIPO_DATA('7301266'),
T_TIPO_DATA('7301267'),
T_TIPO_DATA('7301268'),
T_TIPO_DATA('7301269'),
T_TIPO_DATA('7301270'),
T_TIPO_DATA('7301271'),
T_TIPO_DATA('7301272'),
T_TIPO_DATA('7301273'),
T_TIPO_DATA('7301274'),
T_TIPO_DATA('7301275'),
T_TIPO_DATA('7301276'),
T_TIPO_DATA('7301277'),
T_TIPO_DATA('7301278'),
T_TIPO_DATA('7301279'),
T_TIPO_DATA('7301280'),
T_TIPO_DATA('7301281'),
T_TIPO_DATA('7301282'),
T_TIPO_DATA('7301283'),
T_TIPO_DATA('7301284'),
T_TIPO_DATA('7301285'),
T_TIPO_DATA('7301286'),
T_TIPO_DATA('7301287'),
T_TIPO_DATA('7301288'),
T_TIPO_DATA('7301289'),
T_TIPO_DATA('7301290'),
T_TIPO_DATA('7301291')


		); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

BEGIN

	DBMS_OUTPUT.PUT_LINE('[INICIO] ');
	 
		
		DBMS_OUTPUT.PUT_LINE('[INFO]: COMIENZA EL PROCESO');
		FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
		LOOP
      
			V_TMP_TIPO_DATA := V_TIPO_DATA(I);
				
				DBMS_OUTPUT.PUT_LINE('[INFO]: SE INICIA LA DESPUBLICACIÓN DEL ACTIVO '''|| TRIM(V_TMP_TIPO_DATA(1)) ||'''...');
				
				--Comprobamos si el activo a despublicar existe
				V_SQL := 'SELECT COUNT(1)  
						FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
						WHERE ACT.ACT_NUM_ACTIVO = '''|| TRIM(V_TMP_TIPO_DATA(1)) ||'''
						';
				EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
			
				--Si existe iniciamos la despublicación
				IF V_NUM_TABLAS = 1 THEN				

				V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_PAC_PERIMETRO_ACTIVO PAC SET
							  PAC_INCLUIDO = '||PAC_INC||'
							, PAC_CHECK_TRA_ADMISION = '||PAC_CHECK_TRA_ADM||'
							, PAC_CHECK_GESTIONAR = '||PAC_CHECK_GEST||'
							, PAC_CHECK_ASIGNAR_MEDIADOR = '||PAC_CHECK_ASIGNAR_MED||'
							, PAC_CHECK_COMERCIALIZAR = '||PAC_CHECK_COMERC||'
							, PAC_CHECK_FORMALIZAR = '||PAC_CHECK_FORM||' 
							, USUARIOMODIFICAR  = '''||V_USUARIO||''' 
          						, FECHAMODIFICAR    = SYSDATE 
						WHERE PAC.ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT WHERE ACT.ACT_NUM_ACTIVO = '''|| TRIM(V_TMP_TIPO_DATA(1)) ||''')';
						 
				EXECUTE IMMEDIATE V_SQL;
	
				PL_OUTPUT := '[INFO] actualizado el perímetro del activo '''|| TRIM(V_TMP_TIPO_DATA(1)) ||'''';

 				DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);

				--Si existe, no hacemos nada   
				ELSE
					DBMS_OUTPUT.PUT_LINE('[INFO]: EL ACTIVO '''|| TRIM(V_TMP_TIPO_DATA(1)) ||''' NO EXISTE');        
				END IF;			
      END LOOP;


COMMIT;
 DBMS_OUTPUT.PUT_LINE('[FIN]: ACTIVOS SACAR FUERA DEL PERIMETRO HAYA CORRECTAMENTE');   

EXCEPTION
   WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    [ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM);
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    '||ERR_MSG;
      ROLLBACK;
      RAISE;
END UPDATE_PAC;
/
EXIT;
