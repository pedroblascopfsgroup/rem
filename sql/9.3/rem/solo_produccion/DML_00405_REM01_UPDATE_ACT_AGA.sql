--/*
--##########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20200723
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-7838
--## PRODUCTO=NO
--##
--## Finalidad: 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE


   PL_OUTPUT VARCHAR2(1024 CHAR);
   V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar        
   V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
   V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
   ACT_ID NUMBER(32);
   ERR_NUM NUMBER(25); -- Vble. auxiliar para registrar errores en el script.
   ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
   DESCRIPCION VARCHAR2(64 CHAR);
   V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
   V_USUARIO VARCHAR2(65 CHAR) := 'REMVIP-7838';

    V_TEXT1 VARCHAR2(2400 CHAR); -- Vble. auxiliar
    V_ENTIDAD_ID NUMBER(16);
    V_ID NUMBER(16);
    
    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
T_TIPO_DATA(1000020827,7301314),
T_TIPO_DATA(1000020827,7301315),
T_TIPO_DATA(1000020827,7301316),
T_TIPO_DATA(1000020827,7301317),
T_TIPO_DATA(1000020828,7301318),
T_TIPO_DATA(1000020828,7301319),
T_TIPO_DATA(1000020828,7301320),
T_TIPO_DATA(1000020828,7301321),
T_TIPO_DATA(1000020829,7301322),
T_TIPO_DATA(1000020829,7301323),
T_TIPO_DATA(1000020829,7301324),
T_TIPO_DATA(1000020829,7301325),
T_TIPO_DATA(1000020830,7301326),
T_TIPO_DATA(1000020830,7301327),
T_TIPO_DATA(1000020830,7301328),
T_TIPO_DATA(1000020830,7301329),
T_TIPO_DATA(1000020831,7301330),
T_TIPO_DATA(1000020831,7301331),
T_TIPO_DATA(1000020831,7301332),
T_TIPO_DATA(1000020831,7301333),
T_TIPO_DATA(1000020832,7301334),
T_TIPO_DATA(1000020832,7301335),
T_TIPO_DATA(1000020832,7301336),
T_TIPO_DATA(1000020832,7301337),
T_TIPO_DATA(1000020833,7301338),
T_TIPO_DATA(1000020833,7301339),
T_TIPO_DATA(1000020833,7301340),
T_TIPO_DATA(1000020833,7301341),
T_TIPO_DATA(1000020834,7301342),
T_TIPO_DATA(1000020834,7301343),
T_TIPO_DATA(1000020834,7301344),
T_TIPO_DATA(1000020834,7301345),
T_TIPO_DATA(1000020835,7301346),
T_TIPO_DATA(1000020835,7301347),
T_TIPO_DATA(1000020835,7301348),
T_TIPO_DATA(1000020835,7301349),
T_TIPO_DATA(1000020836,7301350),
T_TIPO_DATA(1000020836,7301351),
T_TIPO_DATA(1000020836,7301352),
T_TIPO_DATA(1000020836,7301353),
T_TIPO_DATA(1000020837,7301354),
T_TIPO_DATA(1000020837,7301355),
T_TIPO_DATA(1000020837,7301356),
T_TIPO_DATA(1000020837,7301357),
T_TIPO_DATA(1000020838,7301358),
T_TIPO_DATA(1000020838,7301359),
T_TIPO_DATA(1000020838,7301360),
T_TIPO_DATA(1000020838,7301361),
T_TIPO_DATA(1000020839,7301362),
T_TIPO_DATA(1000020839,7301363),
T_TIPO_DATA(1000020839,7301364),
T_TIPO_DATA(1000020839,7301365),
T_TIPO_DATA(1000020840,7301366),
T_TIPO_DATA(1000020840,7301367),
T_TIPO_DATA(1000020840,7301368),
T_TIPO_DATA(1000020840,7301369),
T_TIPO_DATA(1000020841,7301370),
T_TIPO_DATA(1000020841,7301371),
T_TIPO_DATA(1000020841,7301372),
T_TIPO_DATA(1000020841,7301373),
T_TIPO_DATA(1000020842,7301374),
T_TIPO_DATA(1000020842,7301375),
T_TIPO_DATA(1000020842,7301376),
T_TIPO_DATA(1000020842,7301377),
T_TIPO_DATA(1000020843,7301378),
T_TIPO_DATA(1000020843,7301379),
T_TIPO_DATA(1000020843,7301380),
T_TIPO_DATA(1000020843,7301381),
T_TIPO_DATA(1000020844,7301382),
T_TIPO_DATA(1000020844,7301383),
T_TIPO_DATA(1000020844,7301384),
T_TIPO_DATA(1000020844,7301385),
T_TIPO_DATA(1000020845,7301386),
T_TIPO_DATA(1000020845,7301387),
T_TIPO_DATA(1000020845,7301388),
T_TIPO_DATA(1000020845,7301389),
T_TIPO_DATA(1000020848,7301394),
T_TIPO_DATA(1000020848,7301395),
T_TIPO_DATA(1000020848,7301396),
T_TIPO_DATA(1000020848,7301397),
T_TIPO_DATA(1000020849,7301398),
T_TIPO_DATA(1000020849,7301399),
T_TIPO_DATA(1000020849,7301400),
T_TIPO_DATA(1000020849,7301401),
T_TIPO_DATA(1000020850,7301402),
T_TIPO_DATA(1000020850,7301403),
T_TIPO_DATA(1000020850,7301404),
T_TIPO_DATA(1000020850,7301405),
T_TIPO_DATA(1000020851,7301406),
T_TIPO_DATA(1000020851,7301407),
T_TIPO_DATA(1000020851,7301408),
T_TIPO_DATA(1000020851,7301409),
T_TIPO_DATA(1000020853,7301414),
T_TIPO_DATA(1000020853,7301415),
T_TIPO_DATA(1000020853,7301416),
T_TIPO_DATA(1000020853,7301417),
T_TIPO_DATA(1000020854,7301418),
T_TIPO_DATA(1000020854,7301419),
T_TIPO_DATA(1000020854,7301420),
T_TIPO_DATA(1000020854,7301421),
T_TIPO_DATA(1000020855,7301422),
T_TIPO_DATA(1000020855,7301423),
T_TIPO_DATA(1000020855,7301424),
T_TIPO_DATA(1000020855,7301425),
T_TIPO_DATA(1000020856,7301426),
T_TIPO_DATA(1000020856,7301427),
T_TIPO_DATA(1000020856,7301428),
T_TIPO_DATA(1000020856,7301429),
T_TIPO_DATA(1000020857,7301430),
T_TIPO_DATA(1000020857,7301431),
T_TIPO_DATA(1000020857,7301432),
T_TIPO_DATA(1000020857,7301433),
T_TIPO_DATA(1000020858,7301434),
T_TIPO_DATA(1000020858,7301435),
T_TIPO_DATA(1000020858,7301436),
T_TIPO_DATA(1000020858,7301437),
T_TIPO_DATA(1000020859,7301438),
T_TIPO_DATA(1000020859,7301439),
T_TIPO_DATA(1000020859,7301440),
T_TIPO_DATA(1000020859,7301441),
T_TIPO_DATA(1000020861,7301446),
T_TIPO_DATA(1000020861,7301447),
T_TIPO_DATA(1000020861,7301448),
T_TIPO_DATA(1000020861,7301449),
T_TIPO_DATA(1000020862,7301450),
T_TIPO_DATA(1000020862,7301451),
T_TIPO_DATA(1000020862,7301452),
T_TIPO_DATA(1000020862,7301453),
T_TIPO_DATA(1000020863,7301454),
T_TIPO_DATA(1000020863,7301455),
T_TIPO_DATA(1000020865,7301458),
T_TIPO_DATA(1000020865,7301459),
T_TIPO_DATA(1000020866,7301460),
T_TIPO_DATA(1000020866,7301461),
T_TIPO_DATA(1000020867,7301462),
T_TIPO_DATA(1000020867,7301463),
T_TIPO_DATA(1000020868,7301464),
T_TIPO_DATA(1000020868,7301465),
T_TIPO_DATA(1000020869,7301466),
T_TIPO_DATA(1000020869,7301467),
T_TIPO_DATA(1000020870,7301468),
T_TIPO_DATA(1000020870,7301469),
T_TIPO_DATA(1000020871,7301470),
T_TIPO_DATA(1000020871,7301471),
T_TIPO_DATA(1000020872,7301472),
T_TIPO_DATA(1000020872,7301473),
T_TIPO_DATA(1000020873,7301474),
T_TIPO_DATA(1000020873,7301475),
T_TIPO_DATA(1000020874,7301476),
T_TIPO_DATA(1000020874,7301477),
T_TIPO_DATA(1000020875,7301478),
T_TIPO_DATA(1000020875,7301479),
T_TIPO_DATA(1000020876,7301480),
T_TIPO_DATA(1000020876,7301481),
T_TIPO_DATA(1000020877,7301482),
T_TIPO_DATA(1000020877,7301483),
T_TIPO_DATA(1000020878,7301484),
T_TIPO_DATA(1000020878,7301485),
T_TIPO_DATA(1000020880,7301488),
T_TIPO_DATA(1000020880,7301489),
T_TIPO_DATA(1000020881,7301490),
T_TIPO_DATA(1000020881,7301491),
T_TIPO_DATA(1000020882,7301492),
T_TIPO_DATA(1000020882,7301493),
T_TIPO_DATA(1000020883,7301494),
T_TIPO_DATA(1000020883,7301495),
T_TIPO_DATA(1000020884,7301496),
T_TIPO_DATA(1000020884,7301497),
T_TIPO_DATA(1000020885,7301498),
T_TIPO_DATA(1000020885,7301499),
T_TIPO_DATA(1000020886,7301500),
T_TIPO_DATA(1000020886,7301501),
T_TIPO_DATA(1000020887,7301502),
T_TIPO_DATA(1000020887,7301503),
T_TIPO_DATA(1000020888,7301504),
T_TIPO_DATA(1000020888,7301505),
T_TIPO_DATA(1000020889,7301506),
T_TIPO_DATA(1000020889,7301507),
T_TIPO_DATA(1000020890,7301508),
T_TIPO_DATA(1000020890,7301509),
T_TIPO_DATA(1000020891,7301510),
T_TIPO_DATA(1000020891,7301511),
T_TIPO_DATA(1000020892,7301512),
T_TIPO_DATA(1000020892,7301513),
T_TIPO_DATA(1000020893,7301514),
T_TIPO_DATA(1000020893,7301515),
T_TIPO_DATA(1000020894,7301516),
T_TIPO_DATA(1000020894,7301517),
T_TIPO_DATA(1000020895,7301518),
T_TIPO_DATA(1000020895,7301519),
T_TIPO_DATA(1000020896,7301520),
T_TIPO_DATA(1000020896,7301521),
T_TIPO_DATA(1000020897,7301522),
T_TIPO_DATA(1000020897,7301523),
T_TIPO_DATA(1000020898,7301524),
T_TIPO_DATA(1000020898,7301525),
T_TIPO_DATA(1000020900,7301529),
T_TIPO_DATA(1000020900,7301530),
T_TIPO_DATA(1000020905,7301554),
T_TIPO_DATA(1000020905,7301555),
T_TIPO_DATA(1000020906,7301556),
T_TIPO_DATA(1000020906,7301557),
T_TIPO_DATA(1000020909,7301564),
T_TIPO_DATA(1000020909,7301565),
T_TIPO_DATA(1000020910,7301566),
T_TIPO_DATA(1000020910,7301567),
T_TIPO_DATA(1000020908,7301568),
T_TIPO_DATA(1000020908,7301569),
T_TIPO_DATA(1000020769,7301129),
T_TIPO_DATA(1000020769,7301130),
T_TIPO_DATA(1000020769,7301131),
T_TIPO_DATA(1000020774,7301156),
T_TIPO_DATA(1000020774,7301157),
T_TIPO_DATA(1000020774,7301158),
T_TIPO_DATA(1000020774,7301159),
T_TIPO_DATA(1000020775,7301160),
T_TIPO_DATA(1000020775,7301161),
T_TIPO_DATA(1000020775,7301162),
T_TIPO_DATA(1000020775,7301163),
T_TIPO_DATA(1000020776,7301164),
T_TIPO_DATA(1000020776,7301165),
T_TIPO_DATA(1000020776,7301166),
T_TIPO_DATA(1000020776,7301167),
T_TIPO_DATA(1000020777,7301168),
T_TIPO_DATA(1000020777,7301169),
T_TIPO_DATA(1000020777,7301170),
T_TIPO_DATA(1000020777,7301171),
T_TIPO_DATA(1000020779,7301176),
T_TIPO_DATA(1000020779,7301177),
T_TIPO_DATA(1000020779,7301178),
T_TIPO_DATA(1000020779,7301179),
T_TIPO_DATA(1000020781,7301184),
T_TIPO_DATA(1000020781,7301185),
T_TIPO_DATA(1000020781,7301186),
T_TIPO_DATA(1000020781,7301187),
T_TIPO_DATA(1000020782,7301188),
T_TIPO_DATA(1000020782,7301189),
T_TIPO_DATA(1000020782,7301190),
T_TIPO_DATA(1000020782,7301191),
T_TIPO_DATA(1000020783,7301192),
T_TIPO_DATA(1000020783,7301193),
T_TIPO_DATA(1000020783,7301194),
T_TIPO_DATA(1000020783,7301195),
T_TIPO_DATA(1000020784,7301196),
T_TIPO_DATA(1000020784,7301197),
T_TIPO_DATA(1000020784,7301198),
T_TIPO_DATA(1000020784,7301199),
T_TIPO_DATA(1000020786,7301204),
T_TIPO_DATA(1000020786,7301205),
T_TIPO_DATA(1000020786,7301206),
T_TIPO_DATA(1000020786,7301207),
T_TIPO_DATA(1000020787,7301208),
T_TIPO_DATA(1000020787,7301209),
T_TIPO_DATA(1000020787,7301210),
T_TIPO_DATA(1000020787,7301211),
T_TIPO_DATA(1000020788,7301212),
T_TIPO_DATA(1000020788,7301213),
T_TIPO_DATA(1000020788,7301214),
T_TIPO_DATA(1000020788,7301215),
T_TIPO_DATA(1000020789,7301216),
T_TIPO_DATA(1000020789,7301217),
T_TIPO_DATA(1000020789,7301218),
T_TIPO_DATA(1000020789,7301219),
T_TIPO_DATA(1000020790,7301220),
T_TIPO_DATA(1000020790,7301221),
T_TIPO_DATA(1000020790,7301222),
T_TIPO_DATA(1000020790,7301223),
T_TIPO_DATA(1000020792,7301228),
T_TIPO_DATA(1000020792,7301229),
T_TIPO_DATA(1000020792,7301230),
T_TIPO_DATA(1000020792,7301231),
T_TIPO_DATA(1000020793,7301232),
T_TIPO_DATA(1000020793,7301233),
T_TIPO_DATA(1000020793,7301234),
T_TIPO_DATA(1000020793,7301235),
T_TIPO_DATA(1000020794,7301236),
T_TIPO_DATA(1000020794,7301237),
T_TIPO_DATA(1000020794,7301238),
T_TIPO_DATA(1000020794,7301239),
T_TIPO_DATA(1000020795,7301240),
T_TIPO_DATA(1000020795,7301241),
T_TIPO_DATA(1000020795,7301242),
T_TIPO_DATA(1000020795,7301243),
T_TIPO_DATA(1000020796,7301244),
T_TIPO_DATA(1000020796,7301245),
T_TIPO_DATA(1000020796,7301246),
T_TIPO_DATA(1000020796,7301247),
T_TIPO_DATA(1000020797,7301248),
T_TIPO_DATA(1000020797,7301249),
T_TIPO_DATA(1000020798,7301250),
T_TIPO_DATA(1000020798,7301251),
T_TIPO_DATA(1000020799,7301252),
T_TIPO_DATA(1000020799,7301253),
T_TIPO_DATA(1000020800,7301254),
T_TIPO_DATA(1000020800,7301255),
T_TIPO_DATA(1000020801,7301256),
T_TIPO_DATA(1000020801,7301257),
T_TIPO_DATA(1000020802,7301258),
T_TIPO_DATA(1000020802,7301259),
T_TIPO_DATA(1000020803,7301260),
T_TIPO_DATA(1000020803,7301261),
T_TIPO_DATA(1000020804,7301262),
T_TIPO_DATA(1000020804,7301263),
T_TIPO_DATA(1000020805,7301264),
T_TIPO_DATA(1000020805,7301265),
T_TIPO_DATA(1000020806,7301266),
T_TIPO_DATA(1000020806,7301267),
T_TIPO_DATA(1000020807,7301268),
T_TIPO_DATA(1000020807,7301269),
T_TIPO_DATA(1000020808,7301270),
T_TIPO_DATA(1000020808,7301271),
T_TIPO_DATA(1000020809,7301272),
T_TIPO_DATA(1000020809,7301273),
T_TIPO_DATA(1000020810,7301274),
T_TIPO_DATA(1000020810,7301275),
T_TIPO_DATA(1000020812,7301276),
T_TIPO_DATA(1000020812,7301277),
T_TIPO_DATA(1000020813,7301278),
T_TIPO_DATA(1000020813,7301279),
T_TIPO_DATA(1000020814,7301280),
T_TIPO_DATA(1000020814,7301281),
T_TIPO_DATA(1000020815,7301282),
T_TIPO_DATA(1000020815,7301283),
T_TIPO_DATA(1000020816,7301284),
T_TIPO_DATA(1000020816,7301285),
T_TIPO_DATA(1000020817,7301286),
T_TIPO_DATA(1000020817,7301287),
T_TIPO_DATA(1000020818,7301288),
T_TIPO_DATA(1000020818,7301289),
T_TIPO_DATA(1000020819,7301290),
T_TIPO_DATA(1000020819,7301291)

		); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

BEGIN

	DBMS_OUTPUT.PUT_LINE('[INICIO] ');
	 
		
		DBMS_OUTPUT.PUT_LINE('[INFO]: COMIENZA EL PROCESO');
		FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
		LOOP
      
			V_TMP_TIPO_DATA := V_TIPO_DATA(I);
				
				DBMS_OUTPUT.PUT_LINE('[INFO]: SACAR EL ACTIVO '''|| TRIM(V_TMP_TIPO_DATA(2)) ||''' DE LA AGRUACION '''|| TRIM(V_TMP_TIPO_DATA(1)) ||'''');
				
				--Comprobamos si el activo y la agrupacion existen
				V_SQL := 'SELECT COUNT(1)  
						FROM '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO  AGA
					        WHERE AGA.ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT WHERE ACT.ACT_NUM_ACTIVO = '''|| TRIM(V_TMP_TIPO_DATA(2)) ||''')
						AND AGA.AGR_ID = (SELECT AGR_ID FROM '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR WHERE AGR.AGR_NUM_AGRUP_REM = '''|| TRIM(V_TMP_TIPO_DATA(1)) ||''')'
						;
				EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
			
				--Si existe 
				IF V_NUM_TABLAS = 1 THEN				

				V_SQL := 'UPDATE '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO AGA SET
							  BORRADO = 1 
							, USUARIOBORRAR  = '''||V_USUARIO||''' 
          						, FECHABORRAR    = SYSDATE 
						WHERE AGA.ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT WHERE ACT.ACT_NUM_ACTIVO = '''|| TRIM(V_TMP_TIPO_DATA(2)) ||''')
						AND AGA.AGR_ID = (SELECT AGR_ID FROM '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR WHERE AGR.AGR_NUM_AGRUP_REM = '''|| TRIM(V_TMP_TIPO_DATA(1)) ||''')';
						 
				EXECUTE IMMEDIATE V_SQL;
	
				PL_OUTPUT := '[INFO] SACADO EL ACTIVO '''|| TRIM(V_TMP_TIPO_DATA(2)) ||''' DE LA AGRUPACION '''|| TRIM(V_TMP_TIPO_DATA(1)) ||''' ';

 				DBMS_OUTPUT.PUT_LINE(PL_OUTPUT);

				--Si existe, no hacemos nada   
				ELSE
					DBMS_OUTPUT.PUT_LINE('[INFO]: EL ACTIVO '''|| TRIM(V_TMP_TIPO_DATA(1)) ||''' NO EXISTE');        
				END IF;			
      END LOOP;


COMMIT;
 DBMS_OUTPUT.PUT_LINE('[FIN]: ACTIVOS SACAR FUERA DE AGRUPACIONES CORRECTAMENTE');   

EXCEPTION
   WHEN OTHERS THEN
      ERR_NUM := SQLCODE;
      ERR_MSG := SQLERRM;
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    [ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM);
      PL_OUTPUT := PL_OUTPUT || CHR(10) ||'    '||ERR_MSG;
      ROLLBACK;
      RAISE;
END UPDATE_PAC;
/
EXIT;
