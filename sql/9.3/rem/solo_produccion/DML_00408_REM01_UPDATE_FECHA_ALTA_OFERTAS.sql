--/*
--##########################################
--## AUTOR=Viorel Remus Ovidiu
--## FECHA_CREACION=20200727
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-7862
--## PRODUCTO=NO
--## 
--## Finalidad: Script que actualizar fecha alta ofertas
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(25 CHAR):= 'OFR_OFERTAS';
    V_COUNT NUMBER(16); -- Vble. para contar.
    V_KOUNT NUMBER(16); -- Vble. para kontar.
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

	NUM_OFERTA NUMBER(16);
	FECHA_ALTA VARCHAR2(25 CHAR);

    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-7862';    
    
    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    			-- NUM_OFERTA	-FECHA_ALTA

T_TIPO_DATA(6000649,'12/11/2018'),
T_TIPO_DATA(6000973,'18/02/2019'),
T_TIPO_DATA(6006307,'17/10/2019'),
T_TIPO_DATA(6007912,'10/12/2019'),
T_TIPO_DATA(6010596,'07/11/2018'),
T_TIPO_DATA(6011206,'21/05/2019'),
T_TIPO_DATA(6011327,'24/06/2019'),
T_TIPO_DATA(6011345,'14/06/2019'),
T_TIPO_DATA(6011769,'14/06/2019'),
T_TIPO_DATA(6012279,'10/02/2020'),
T_TIPO_DATA(6012588,'13/01/2020'),
T_TIPO_DATA(6013062,'03/12/2019'),
T_TIPO_DATA(90230157,'25/10/2019'),
T_TIPO_DATA(90230162,'13/11/2019'),
T_TIPO_DATA(90230170,'13/11/2019'),
T_TIPO_DATA(90230174,'13/11/2019'),
T_TIPO_DATA(90230183,'25/09/2019'),
T_TIPO_DATA(90230765,'14/11/2019'),
T_TIPO_DATA(90232067,'13/11/2019'),
T_TIPO_DATA(90232068,'14/11/2019'),
T_TIPO_DATA(90232069,'13/11/2019'),
T_TIPO_DATA(90232078,'05/12/2019'),
T_TIPO_DATA(90232079,'20/11/2019'),
T_TIPO_DATA(90232081,'22/11/2019'),
T_TIPO_DATA(90232083,'14/11/2019'),
T_TIPO_DATA(90232085,'26/11/2019'),
T_TIPO_DATA(90232087,'22/11/2019'),
T_TIPO_DATA(90232090,'27/11/2019'),
T_TIPO_DATA(90232093,'22/11/2019'),
T_TIPO_DATA(90232099,'27/11/2019'),
T_TIPO_DATA(90232102,'26/11/2019'),
T_TIPO_DATA(90232979,'21/11/2019'),
T_TIPO_DATA(90233060,'25/11/2019'),
T_TIPO_DATA(90233271,'30/10/2019'),
T_TIPO_DATA(90233279,'31/10/2019'),
T_TIPO_DATA(90233284,'15/10/2019'),
T_TIPO_DATA(90233296,'15/11/2019'),
T_TIPO_DATA(90233536,'20/11/2019'),
T_TIPO_DATA(90233537,'08/11/2019'),
T_TIPO_DATA(90233543,'19/11/2019'),
T_TIPO_DATA(90233649,'19/11/2019'),
T_TIPO_DATA(90234031,'10/12/2019'),
T_TIPO_DATA(90234113,'12/12/2019'),
T_TIPO_DATA(90234436,'02/12/2019'),
T_TIPO_DATA(90235463,'21/11/2019'),
T_TIPO_DATA(90235920,'13/12/2019'),
T_TIPO_DATA(90236080,'20/12/2019'),
T_TIPO_DATA(90236151,'08/11/2019'),
T_TIPO_DATA(90236291,'09/12/2019'),
T_TIPO_DATA(90238564,'17/01/2020'),
T_TIPO_DATA(90241139,'04/12/2019'),
T_TIPO_DATA(90242096,'13/01/2020'),
T_TIPO_DATA(90245070,'25/10/2019'),
T_TIPO_DATA(90245356,'21/11/2019'),
T_TIPO_DATA(90248308,'03/02/2020'),
T_TIPO_DATA(90248446,'19/03/2020'),
T_TIPO_DATA(90248733,'19/03/2020'),
T_TIPO_DATA(90248744,'04/03/2020'),
T_TIPO_DATA(90248865,'31/03/2020'),
T_TIPO_DATA(90248939,'02/03/2020'),
T_TIPO_DATA(90248942,'18/02/2020'),
T_TIPO_DATA(90248945,'09/03/2020'),
T_TIPO_DATA(90248975,'03/02/2020'),
T_TIPO_DATA(90248988,'10/02/2020'),
T_TIPO_DATA(90249014,'10/12/2019'),
T_TIPO_DATA(90249070,'03/02/2020'),
T_TIPO_DATA(90249262,'24/02/2020'),
T_TIPO_DATA(90249359,'25/03/2020'),
T_TIPO_DATA(90249361,'24/02/2020'),
T_TIPO_DATA(90249570,'30/03/2020'),
T_TIPO_DATA(90249624,'27/02/2020'),
T_TIPO_DATA(90249646,'09/03/2020'),
T_TIPO_DATA(90249745,'31/01/2020'),
T_TIPO_DATA(90249746,'06/03/2020'),
T_TIPO_DATA(90249748,'04/03/2020'),
T_TIPO_DATA(90249771,'17/02/2020'),
T_TIPO_DATA(90249773,'26/02/2020'),
T_TIPO_DATA(90249981,'23/03/2020'),
T_TIPO_DATA(90249985,'23/03/2020'),
T_TIPO_DATA(90249987,'24/01/2020'),
T_TIPO_DATA(90249994,'27/03/2020'),
T_TIPO_DATA(90250001,'02/03/2020'),
T_TIPO_DATA(90250005,'02/03/2020'),
T_TIPO_DATA(90250007,'02/03/2020'),
T_TIPO_DATA(90250008,'13/03/2020'),
T_TIPO_DATA(90250019,'08/01/2020'),
T_TIPO_DATA(90250031,'08/01/2020'),
T_TIPO_DATA(90250049,'08/01/2020'),
T_TIPO_DATA(90250094,'08/01/2020'),
T_TIPO_DATA(90250120,'02/03/2020'),
T_TIPO_DATA(90250142,'02/03/2020'),
T_TIPO_DATA(90250195,'09/03/2020'),
T_TIPO_DATA(90250222,'07/04/2020'),
T_TIPO_DATA(90250246,'02/04/2020'),
T_TIPO_DATA(90250281,'02/01/2020'),
T_TIPO_DATA(90250343,'17/02/2020'),
T_TIPO_DATA(90250433,'11/11/2019'),
T_TIPO_DATA(90250451,'10/01/2020'),
T_TIPO_DATA(90250498,'09/03/2020'),
T_TIPO_DATA(90250529,'17/02/2020'),
T_TIPO_DATA(90250554,'09/03/2020'),
T_TIPO_DATA(90250619,'07/05/2020'),
T_TIPO_DATA(90250650,'26/02/2020'),
T_TIPO_DATA(90250736,'03/03/2020'),
T_TIPO_DATA(90250775,'20/01/2020'),
T_TIPO_DATA(90250927,'16/03/2020'),
T_TIPO_DATA(90250979,'14/05/2020'),
T_TIPO_DATA(90250989,'04/03/2020'),
T_TIPO_DATA(90251152,'23/03/2020'),
T_TIPO_DATA(90251518,'18/12/2019'),
T_TIPO_DATA(90251520,'18/12/2019'),
T_TIPO_DATA(90251669,'10/06/2019'),
T_TIPO_DATA(90251779,'03/03/2020'),
T_TIPO_DATA(90251952,'06/04/2020'),
T_TIPO_DATA(90252065,'25/03/2020'),
T_TIPO_DATA(90252105,'21/05/2020'),
T_TIPO_DATA(90252430,'09/03/2020'),
T_TIPO_DATA(90252545,'22/05/2020'),
T_TIPO_DATA(90252560,'31/01/2020'),
T_TIPO_DATA(90253102,'03/03/2020'),
T_TIPO_DATA(90253105,'09/03/2020'),
T_TIPO_DATA(90253107,'06/03/2020'),
T_TIPO_DATA(90253110,'09/03/2020'),
T_TIPO_DATA(90253111,'09/03/2020'),
T_TIPO_DATA(90253150,'24/10/2018'),
T_TIPO_DATA(90253196,'05/02/2020'),
T_TIPO_DATA(90253247,'16/12/2019'),
T_TIPO_DATA(90253405,'19/05/2020'),
T_TIPO_DATA(90253436,'23/03/2020'),
T_TIPO_DATA(90253450,'25/02/2020'),
T_TIPO_DATA(90253496,'12/03/2020'),
T_TIPO_DATA(90253575,'02/12/2019'),
T_TIPO_DATA(90253653,'23/03/2020'),
T_TIPO_DATA(90253813,'31/03/2020'),
T_TIPO_DATA(90253820,'03/03/2020'),
T_TIPO_DATA(90253968,'27/02/2020'),
T_TIPO_DATA(90253974,'01/04/2020'),
T_TIPO_DATA(90254211,'11/05/2020'),
T_TIPO_DATA(90254443,'01/04/2020'),
T_TIPO_DATA(90254504,'19/02/2020'),
T_TIPO_DATA(90254543,'23/03/2020'),
T_TIPO_DATA(90254852,'20/04/2020'),
T_TIPO_DATA(90254889,'26/02/2020'),
T_TIPO_DATA(90254984,'28/05/2020'),
T_TIPO_DATA(90255047,'02/03/2020'),
T_TIPO_DATA(90255057,'20/05/2020'),
T_TIPO_DATA(90255141,'11/12/2018'),
T_TIPO_DATA(90255383,'17/03/2020'),
T_TIPO_DATA(90255516,'11/02/2020'),
T_TIPO_DATA(90255872,'31/01/2020'),
T_TIPO_DATA(90256039,'11/02/2020'),
T_TIPO_DATA(90256075,'28/01/2020'),
T_TIPO_DATA(90256087,'20/02/2020'),
T_TIPO_DATA(90256136,'19/02/2020'),
T_TIPO_DATA(90256384,'02/03/2020'),
T_TIPO_DATA(90256549,'22/01/2020'),
T_TIPO_DATA(90256556,'10/12/2019'),
T_TIPO_DATA(90257056,'28/05/2020'),
T_TIPO_DATA(90257059,'28/05/2020'),
T_TIPO_DATA(90257083,'30/12/2019'),
T_TIPO_DATA(90257320,'12/02/2020'),
T_TIPO_DATA(90257680,'16/06/2020'),
T_TIPO_DATA(90257690,'03/05/2019'),
T_TIPO_DATA(90257848,'16/12/2019'),
T_TIPO_DATA(90257876,'16/01/2020'),
T_TIPO_DATA(90258167,'28/05/2020'),
T_TIPO_DATA(90258998,'18/06/2020'),
T_TIPO_DATA(90260914,'04/06/2020'),
T_TIPO_DATA(90260920,'04/06/2020'),
T_TIPO_DATA(90260922,'11/06/2020'),
T_TIPO_DATA(90260925,'11/06/2020'),
T_TIPO_DATA(90260929,'18/06/2020'),
T_TIPO_DATA(90260934,'28/05/2020')

		); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN	
	
    DBMS_OUTPUT.PUT_LINE('[INICIO] ');


    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
      LOOP
      
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
    	NUM_OFERTA := V_TMP_TIPO_DATA(1);
	FECHA_ALTA := V_TMP_TIPO_DATA(2);
       	EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.OFR_OFERTAS WHERE OFR_NUM_OFERTA = '||NUM_OFERTA INTO V_KOUNT;
  			  
		IF V_KOUNT > 0 THEN 
	  			 
			DBMS_OUTPUT.PUT_LINE('UPDATEANDO LA OFERTA '||NUM_OFERTA||' EN '||V_TABLA);
			
			V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' 
				  SET OFR_FECHA_ALTA = TO_DATE('''||FECHA_ALTA||''', ''DD/MM/YYYY'')
				     ,USUARIOMODIFICAR = '''||V_USUARIO||'''
				     ,FECHAMODIFICAR = SYSDATE
				  WHERE OFR_NUM_OFERTA = '||NUM_OFERTA||'';
			EXECUTE IMMEDIATE V_SQL;
			
			DBMS_OUTPUT.PUT_LINE('MODIFICANDA LA OFERTA '||NUM_OFERTA||' EN '||V_TABLA);
			
			V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
				
		ELSE
			
			DBMS_OUTPUT.PUT_LINE('[INFO] LA OFERTA '||NUM_OFERTA||' no existe!');
			
		END IF;
		
      END LOOP;
    COMMIT;

    DBMS_OUTPUT.PUT_LINE('[INFO] Se han insertado en total '||V_COUNT_UPDATE||' registros en la tabla '||V_TABLA);
   

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;
/
EXIT
