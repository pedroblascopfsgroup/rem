--/*
--##########################################
--## AUTOR=Ivan Repiso
--## FECHA_CREACION=20200812
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-7113
--## PRODUCTO=NO
--## 
--## Finalidad: Actualización gestor comercial 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
	V_MSQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
 	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
 	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	V_USU VARCHAR2(30 CHAR):= 'REMVIP-7113';
	V_GEE_ID NUMBER(16); -- Vble. para el id gestor identidad
	V_ACT_ID NUMBER(16); -- Vble. para el id de activo
	V_GEH_ID NUMBER(16); -- Vble. para el id gestor identidad hist
	V_COUNT NUMBER(16); -- Vble. para comprobar
	err_num NUMBER; -- Numero de errores
	err_msg VARCHAR2(2048); -- Mensaje de error

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(32000 CHAR);
    	TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    	V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    		T_TIPO_DATA('5959151'),
    		T_TIPO_DATA('5965733'),
    		T_TIPO_DATA('6523221')
    	); 
    	V_TMP_TIPO_DATA T_TIPO_DATA;

	
BEGIN
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');


	--Comprobamos la existencia de la usuaria enavarro
	V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''enavarro''';
	EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

	IF V_COUNT = 1 THEN

		FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
	      	LOOP
		V_TMP_TIPO_DATA := V_TIPO_DATA(I);

			--Obtenemos act_id, gee_id y geh_id
			V_MSQL := 'SELECT ACT.ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
				INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GAC.ACT_ID = ACT.ACT_ID
				INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID AND GEE.DD_TGE_ID = (SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = 					''GCOM'') AND GEE.BORRADO = 0
				INNER JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH ON GAH.ACT_ID = ACT.ACT_ID
				INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH ON GEH.GEH_ID = GAH.GEH_ID AND GEH.DD_TGE_ID = (SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE 				DD_TGE_CODIGO = ''GCOM'') AND GEH.GEH_FECHA_HASTA IS NULL AND GEH.BORRADO = 0
				INNER JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON GEE.USU_ID = USU.USU_ID
				WHERE ACT.ACT_NUM_ACTIVO = '''||V_TMP_TIPO_DATA(1)||'''';
			EXECUTE IMMEDIATE V_MSQL INTO V_ACT_ID;
			V_MSQL := 'SELECT GEE.GEE_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
				INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GAC.ACT_ID = ACT.ACT_ID
				INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID AND GEE.DD_TGE_ID = (SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = 					''GCOM'') AND GEE.BORRADO = 0
				INNER JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH ON GAH.ACT_ID = ACT.ACT_ID
				INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH ON GEH.GEH_ID = GAH.GEH_ID AND GEH.DD_TGE_ID = (SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE 				DD_TGE_CODIGO = ''GCOM'') AND GEH.GEH_FECHA_HASTA IS NULL AND GEH.BORRADO = 0
				INNER JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON GEE.USU_ID = USU.USU_ID
				WHERE ACT.ACT_NUM_ACTIVO = '''||V_TMP_TIPO_DATA(1)||'''';
			EXECUTE IMMEDIATE V_MSQL INTO V_GEE_ID;
			V_MSQL := 'SELECT GEH.GEH_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
				INNER JOIN '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC ON GAC.ACT_ID = ACT.ACT_ID
				INNER JOIN '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE ON GEE.GEE_ID = GAC.GEE_ID AND GEE.DD_TGE_ID = (SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = 					''GCOM'') AND GEE.BORRADO = 0
				INNER JOIN '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH ON GAH.ACT_ID = ACT.ACT_ID
				INNER JOIN '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH ON GEH.GEH_ID = GAH.GEH_ID AND GEH.DD_TGE_ID = (SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE 				DD_TGE_CODIGO = ''GCOM'') AND GEH.GEH_FECHA_HASTA IS NULL AND GEH.BORRADO = 0
				INNER JOIN '||V_ESQUEMA_M||'.USU_USUARIOS USU ON GEE.USU_ID = USU.USU_ID
				WHERE ACT.ACT_NUM_ACTIVO = '''||V_TMP_TIPO_DATA(1)||'''';
			EXECUTE IMMEDIATE V_MSQL INTO V_GEH_ID;

			--Comprobamos la existencia de la usuaria enavarro
			V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '''||V_TMP_TIPO_DATA(1)||'''';
			EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;			

			IF V_COUNT = 1 THEN
					
				--ACTUALIZAMOS REGISTROS EN LA GEE
				V_MSQL := 'UPDATE '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD SET 
					USU_ID = (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''enavarro''),
					USUARIOMODIFICAR = '''||V_USU||''',
					FECHAMODIFICAR = SYSDATE
					WHERE GEE_ID = '''||V_GEE_ID||'''';
				
				EXECUTE IMMEDIATE V_MSQL;
				DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZADOS EN GEE  '|| SQL%ROWCOUNT ||' REGISTROS');

				--Actualizamos la fecha fin del gestor antiguo en GEH
				V_MSQL := 'UPDATE '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST SET
					GEH_FECHA_HASTA = TO_DATE(SYSDATE, ''DD/MM/YY''),
					USUARIOMODIFICAR = '''||V_USU||''', 
					FECHAMODIFICAR = SYSDATE 
					WHERE GEH_ID = '''||V_GEH_ID||'''';
				
				EXECUTE IMMEDIATE V_MSQL;
				DBMS_OUTPUT.PUT_LINE('[INFO] MODIFICADOS EN GEH:  '|| SQL%ROWCOUNT ||' REGISTROS ');
					
				--Obtenemos el id de gestor entidad hist > GEH_ID
				V_MSQL := 'SELECT '||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.nextval FROM dual';
				EXECUTE IMMEDIATE V_MSQL INTO V_GEH_ID;	
					
				--INSERTAMOS EN LA GEH
				V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST
					(GEH_ID,USU_ID,DD_TGE_ID,GEH_FECHA_DESDE,USUARIOCREAR,FECHACREAR) VALUES (
					'||V_GEH_ID||', (SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''enavarro''),
					(SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = ''GCOM''), SYSDATE,
					'''||V_USU||''', SYSDATE)';
				
				EXECUTE IMMEDIATE V_MSQL;
				DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS EN GEH:  '|| SQL%ROWCOUNT ||' REGISTROS ');
					
				--INSERTAMOS EN LA GAH
				V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO
					(GEH_ID, ACT_ID) VALUES ('||V_GEH_ID||', '||V_ACT_ID||')';
				
				EXECUTE IMMEDIATE V_MSQL;
				DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS EN GAH:  '|| SQL%ROWCOUNT ||' REGISTROS ');
			
			ELSE 

				DBMS_OUTPUT.PUT_LINE('[INFO] NO EXISTE EL ACTIVO '''||V_TMP_TIPO_DATA(1)||'''');

			END IF;

		END LOOP;

	ELSE 

		DBMS_OUTPUT.PUT_LINE('[INFO] NO EXISTE LA USUARIA ''enavarro''');

	END IF;
	COMMIT;
	DBMS_OUTPUT.PUT_LINE('[FIN] ');
	
	EXCEPTION
	
	    WHEN OTHERS THEN
		DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
		DBMS_OUTPUT.PUT_LINE(SQLERRM);
		DBMS_OUTPUT.PUT_LINE(V_MSQL);
		ROLLBACK;
		RAISE;
END;
/
EXIT;
