--/*
--##########################################
--## AUTOR=Juan Beltrán
--## FECHA_CREACION=20200819
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-7636
--## PRODUCTO=NO
--##
--## Finalidad: Actualizar instrucciones
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Version inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	V_ID NUMBER(16); -- Vble. auxiliar para almacenar temporalmente el numero de la sequencia.
	V_TEXT_TABLA VARCHAR2(2400 CHAR) := 'ACT_TAS_TASACION'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-7636';    

    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(32000 CHAR);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
--      	 ACT_NUM_ACTIVO   TAS_ID_EXTERNO  VALOR_TASACION_BANKIA  FECHA_TASACION
		T_TIPO_DATA('5965067'  ,'681814808'  ,'17220'       ,'09/02/18'),
		T_TIPO_DATA('5968182'  ,'687080470'  ,'35298.9'     ,'03/09/19'),
		T_TIPO_DATA('5942276'  ,'687094536'  ,'143186.62'   ,'08/07/19'),
		T_TIPO_DATA('5939768'  ,'685224642'  ,'40250'       ,'19/12/18'),
		T_TIPO_DATA('5968235'  ,'681683014'  ,'55070.18'    ,'13/03/19'),
		T_TIPO_DATA('5926408'  ,'688910731'  ,'162753.75'   ,'24/02/20'),
		T_TIPO_DATA('5939000'  ,'681683734'  ,'44941.51'    ,'07/03/19'),
		T_TIPO_DATA('5952860'  ,'681688060'  ,'10514.91'    ,'08/03/19'),
		T_TIPO_DATA('5939143'  ,'686518851'  ,'98490'       ,'19/06/19'),
		T_TIPO_DATA('5929454'  ,'681477170'  ,'40896.9'     ,'03/06/19'),
		T_TIPO_DATA('5935855'  ,'681690291'  ,'14414.37'    ,'08/03/19'),
		T_TIPO_DATA('5937134'  ,'678853087'  ,'29848.77'    ,'22/01/19'),
		T_TIPO_DATA('5960310'  ,'684689767'  ,'28473.12'    ,'23/03/18'),
		T_TIPO_DATA('5931540'  ,'689602456'  ,'89670.56'    ,'13/04/20'),
		T_TIPO_DATA('5932218'  ,'680548713'  ,'13665.55'    ,'07/03/19'),
		T_TIPO_DATA('5940323'  ,'689729447'  ,'91588.7'     ,'14/04/20'),
		T_TIPO_DATA('5963353'  ,'689177523'  ,'140612.88'   ,'20/02/20'),
		T_TIPO_DATA('5961556'  ,'681887563'  ,'12728.54'    ,'12/04/18'),
		T_TIPO_DATA('5937929'  ,'683927537'  ,'110495.62'   ,'08/08/18'),
		T_TIPO_DATA('5925766'  ,'681697548'  ,'69705.48'    ,'07/03/19'),
		T_TIPO_DATA('5968086'  ,'681588154'  ,'3470'        ,'22/02/18'),
		T_TIPO_DATA('5934858'  ,'681876854'  ,'50287.9'     ,'11/04/18'),
		T_TIPO_DATA('5943547'  ,'689730163'  ,'125621.51'   ,'21/04/20'),
		T_TIPO_DATA('5964378'  ,'685450665'  ,'27617.28'    ,'21/12/18'),
		T_TIPO_DATA('5926010'  ,'681530901'  ,'40866.07'    ,'15/02/18'),
		T_TIPO_DATA('5948505'  ,'684192057'  ,'49010'       ,'25/09/18'),
		T_TIPO_DATA('5949098'  ,'682812400'  ,'45000'       ,'12/06/18'),
		T_TIPO_DATA('5934947'  ,'689729564'  ,'207392'      ,'17/04/20'),
		T_TIPO_DATA('5968066'  ,'678428164'  ,'70114.02'    ,'16/11/18'),
		T_TIPO_DATA('5968066'  ,'677218905'  ,'70114.02'    ,'16/11/18'),
		T_TIPO_DATA('6048686'  ,'685813855'  ,'9444184'     ,'14/03/19'),
		T_TIPO_DATA('5945715'  ,'676405778'  ,'282981.06'   ,'15/02/16'),
		T_TIPO_DATA('6050078'  ,'687354346'  ,'352429.47'   ,'27/08/19'),
		T_TIPO_DATA('5947685'  ,'681464403'  ,'90279.14'    ,'15/04/19'),
		T_TIPO_DATA('5958163'  ,'677030869'  ,'134439.52'   ,'22/11/18'),
		T_TIPO_DATA('5955256'  ,'688428780'  ,'103323.04'   ,'02/10/19'),
		T_TIPO_DATA('5956545'  ,'680549625'  ,'57414.85'    ,'04/02/19'),
		T_TIPO_DATA('5960138'  ,'688218334'  ,'1600118.2'   ,'10/12/19'),
		T_TIPO_DATA('6058566'  ,'690067140'  ,'84076.72'    ,'15/04/20'),
		T_TIPO_DATA('5968001'  ,'681705414'  ,'52158.65'    ,'05/02/19'),
		T_TIPO_DATA('5937063'  ,'688600478'  ,'34338.72'    ,'08/12/19'),
		T_TIPO_DATA('5962595'  ,'685695683'  ,'15109.09'    ,'14/02/19'),
		T_TIPO_DATA('5970044'  ,'688475866'  ,'50560.24'    ,'15/12/19'),
		T_TIPO_DATA('5962800'  ,'678290337'  ,'47775.63'    ,'05/02/19'),
		T_TIPO_DATA('5964371'  ,'688175059'  ,'166561.34'   ,'15/11/18'),
		T_TIPO_DATA('5940054'  ,'681758944'  ,'370000'      ,'21/03/18'),
		T_TIPO_DATA('6356180'  ,'676751553'  ,'1444145.6'   ,'10/05/16'),
		T_TIPO_DATA('6063003'  ,'678288574'  ,'124766.2'    ,'07/03/19'),
		T_TIPO_DATA('6343953'  ,'688967072'  ,'43475'       ,'02/02/20'),
		T_TIPO_DATA('6343952'  ,'688973455'  ,'120002.5'    ,'02/02/20'),
		T_TIPO_DATA('6343947'  ,'688973707'  ,'46605.2'     ,'02/02/20'),
		T_TIPO_DATA('6062093'  ,'690065550'  ,'68263.57'    ,'24/02/20'),
		T_TIPO_DATA('6351347'  ,'676353402'  ,'93523.05'    ,'21/01/16'),
		T_TIPO_DATA('6344467'  ,'686295727'  ,'39564.95'    ,'27/05/19'),
		T_TIPO_DATA('6064454'  ,'681657388'  ,'130000'      ,'07/03/18'),
		T_TIPO_DATA('6815782'  ,'687073895'  ,'185538.73'   ,'28/05/19'),
		T_TIPO_DATA('6768570'  ,'680543883'  ,'68801.02'    ,'14/01/18'),
		T_TIPO_DATA('6789384'  ,'686270115'  ,'76759.21'    ,'28/05/19'),
		T_TIPO_DATA('6791298'  ,'688173586'  ,'8155.75'     ,'23/10/19'),
		T_TIPO_DATA('6815905'  ,'681807495'  ,'847767.25'   ,'22/02/18'),
		T_TIPO_DATA('6772898'  ,'686209159'  ,'2057.12'     ,'27/05/19'),
		T_TIPO_DATA('6798788'  ,'687077561'  ,'85313.25'    ,'11/07/19'),
		T_TIPO_DATA('6889105'  ,'681814322'  ,'1689354.2'   ,'29/03/18'),
		T_TIPO_DATA('5967081'  ,'676405661'  ,'282981.06'   ,'15/02/16'),
		T_TIPO_DATA('6058371'  ,'677233201'  ,'111129.07'   ,'24/12/18'),
		T_TIPO_DATA('5938888'  ,'685324800'  ,'134428.58'   ,'05/02/19'),
		T_TIPO_DATA('6940758'  ,'687119069'  ,'55334.63'    ,'02/09/19'),
		T_TIPO_DATA('5971620'  ,'683659151'  ,'123000'      ,'16/07/18'),
		T_TIPO_DATA('6956502'  ,'688218568'  ,'54282.6'     ,'13/11/19'),
		T_TIPO_DATA('6962120'  ,'687075971'  ,'101499'      ,'10/06/19'),
		T_TIPO_DATA('6971730'  ,'686265130'  ,'46011.25'    ,'21/06/19'),
		T_TIPO_DATA('6965793'  ,'684277298'  ,'362920'      ,'23/10/18'),
		T_TIPO_DATA('6965830'  ,'687581398'  ,'263456.2'    ,'20/03/20'),
		T_TIPO_DATA('6965677'  ,'686329865'  ,'59808.55'    ,'01/07/19'),
		T_TIPO_DATA('6988334'  ,'685224039'  ,'127340'      ,'21/01/19'),
		T_TIPO_DATA('6996105'  ,'688534583'  ,'29286.97'    ,'15/11/19'),
		T_TIPO_DATA('6998826'  ,'686760100'  ,'585383.56'   ,'06/08/19'),
		T_TIPO_DATA('6990045'  ,'688597190'  ,'1003453.75'  ,'06/02/20'),
		T_TIPO_DATA('6979348'  ,'684386692'  ,'245074.6'    ,'03/02/20'),
		T_TIPO_DATA('6986616'  ,'689724032'  ,'67270.18'    ,'08/04/20'),
		T_TIPO_DATA('7011990'  ,'678848471'  ,'191196.52'   ,'29/05/18'),
		T_TIPO_DATA('6981892'  ,'683930680'  ,'136743.22'   ,'11/09/19'),
		T_TIPO_DATA('7001193'  ,'690066345'  ,'48013.83'    ,'06/02/20'),
		T_TIPO_DATA('6989395'  ,'683985566'  ,'42750'       ,'17/08/18'),
		T_TIPO_DATA('6986485'  ,'690067491'  ,'78915.06'    ,'03/04/20'),
		T_TIPO_DATA('6979893'  ,'690065784'  ,'107790.32'   ,'27/02/20'),
		T_TIPO_DATA('6982459'  ,'690073640'  ,'87477.08'    ,'02/04/20'),
		T_TIPO_DATA('6983589'  ,'685855002'  ,'375964.47'   ,'20/12/18'),
		T_TIPO_DATA('6999135'  ,'688217773'  ,'1542085.1'   ,'12/12/19'),
		T_TIPO_DATA('6983412'  ,'689811873'  ,'162642.12'   ,'24/04/20'),
		T_TIPO_DATA('6982812'  ,'687446900'  ,'4656.18'     ,'04/09/19'),
		T_TIPO_DATA('6990945'  ,'690065919'  ,'201985.36'   ,'14/04/20'),
		T_TIPO_DATA('6989758'  ,'689724383'  ,'119860.8'    ,'27/03/20'),
		T_TIPO_DATA('6982805'  ,'687446279'  ,'4656.18'     ,'04/09/19'),
		T_TIPO_DATA('6988091'  ,'685489974'  ,'28737'       ,'29/01/19'),
		T_TIPO_DATA('6982806'  ,'687446396'  ,'4656.18'     ,'04/09/19'),
		T_TIPO_DATA('6982811'  ,'687446882'  ,'4656.18'     ,'04/09/19'),
		T_TIPO_DATA('6995127'  ,'689632216'  ,'3444.93'     ,'01/04/20'),
		T_TIPO_DATA('6986288'  ,'686298697'  ,'73050.32'    ,'27/05/19'),
		T_TIPO_DATA('6982807'  ,'687446414'  ,'4656.18'     ,'04/09/19'),
		T_TIPO_DATA('6991949'  ,'687263190'  ,'300002.47'   ,'16/08/19'),
		T_TIPO_DATA('6997071'  ,'689812920'  ,'219243.72'   ,'13/04/20'),
		T_TIPO_DATA('6982810'  ,'687446765'  ,'4656.18'     ,'04/09/19'),
		T_TIPO_DATA('6982808'  ,'687446531'  ,'4656.18'     ,'04/09/19'),
		T_TIPO_DATA('6999181'  ,'683740917'  ,'26500'       ,'19/07/18'),
		T_TIPO_DATA('6999268'  ,'687365055'  ,'450569.2'    ,'13/09/19'),
		T_TIPO_DATA('6982813'  ,'687447074'  ,'4656.18'     ,'04/09/19'),
		T_TIPO_DATA('6993306'  ,'689728166'  ,'12149.24'    ,'09/04/20'),
		T_TIPO_DATA('6991463'  ,'687476993'  ,'10338.1'     ,'30/04/20'),
		T_TIPO_DATA('6994361'  ,'690073874'  ,'52350.6'     ,'27/04/20'),
		T_TIPO_DATA('6997054'  ,'689812803'  ,'269356.25'   ,'14/04/20'),
		T_TIPO_DATA('6982814'  ,'687447191'  ,'4656.18'     ,'04/09/19'),
		T_TIPO_DATA('6982803'  ,'687446045'  ,'4656.18'     ,'04/09/19'),
		T_TIPO_DATA('6992139'  ,'689728049'  ,'93221.33'    ,'22/04/20'),
		T_TIPO_DATA('6982804'  ,'687446162'  ,'4656.18'     ,'04/09/19'),
		T_TIPO_DATA('6985779'  ,'687819401'  ,'3300'        ,'12/12/19'),
		T_TIPO_DATA('6998851'  ,'688542439'  ,'36880.13'    ,'18/02/20'),
		T_TIPO_DATA('6992915'  ,'689812785'  ,'188940.42'   ,'27/04/20'),
		T_TIPO_DATA('6998042'  ,'684061011'  ,'130892.96'   ,'16/05/19'),
		T_TIPO_DATA('7030367'  ,'687365775'  ,'134476.19'   ,'16/09/19'),
		T_TIPO_DATA('7073178'  ,'687464049'  ,'50139.75'    ,'17/10/19'),
		T_TIPO_DATA('6980961'  ,'690073757'  ,'92324.49'    ,'14/04/20'),
		T_TIPO_DATA('7074680'  ,'690065298'  ,'8784.23'     ,'13/03/20'),
		T_TIPO_DATA('7099954'  ,'690070049'  ,'117345.9'    ,'07/04/20'),
		T_TIPO_DATA('7091267'  ,'682465568'  ,'6077.64'     ,'12/12/18'),
		T_TIPO_DATA('7090381'  ,'682463861'  ,'5949.89'     ,'12/12/18'),
		T_TIPO_DATA('7091265'  ,'682465685'  ,'5949.89'     ,'12/12/18'),
		T_TIPO_DATA('7091250'  ,'682465334'  ,'6129.69'     ,'12/12/18'),
		T_TIPO_DATA('7090390'  ,'682464305'  ,'6129.69'     ,'12/12/18'),
		T_TIPO_DATA('7091273'  ,'682464539'  ,'5715.68'     ,'12/12/18'),
		T_TIPO_DATA('7091289'  ,'682464287'  ,'5715.68'     ,'12/12/18'),
		T_TIPO_DATA('7091256'  ,'682464773'  ,'5767.73'     ,'12/12/18'),
		T_TIPO_DATA('7089564'  ,'690064872'  ,'65145.15'    ,'25/02/20'),
		T_TIPO_DATA('7091243'  ,'682465451'  ,'5715.68'     ,'12/12/18'),
		T_TIPO_DATA('7089480'  ,'685506725'  ,'3550'        ,'07/02/19'),
		T_TIPO_DATA('7091238'  ,'682465100'  ,'5715.68'     ,'12/12/18'),
		T_TIPO_DATA('7090405'  ,'682464053'  ,'5949.89'     ,'12/12/18'),
		T_TIPO_DATA('7091252'  ,'682464890'  ,'5767.73'     ,'12/12/18'),
		T_TIPO_DATA('7090534'  ,'690067743'  ,'99341.71'    ,'31/03/20'),
		T_TIPO_DATA('7091248'  ,'682464908'  ,'5637.61'     ,'12/12/18'),
		T_TIPO_DATA('7091259'  ,'682465082'  ,'5949.89'     ,'12/12/18'),
		T_TIPO_DATA('7101497'  ,'690071681'  ,'50235.73'    ,'17/04/20'),
		T_TIPO_DATA('7226475'  ,'689602942'  ,'50962.6'     ,'13/04/20'),
		T_TIPO_DATA('6987653'  ,'685489623'  ,'20198.75'    ,'29/01/19'),
		T_TIPO_DATA('6943708'  ,'687119321'  ,'47627.78'    ,'04/09/19'),
		T_TIPO_DATA('7101605'  ,'689733520'  ,'14188.5'     ,'20/04/20')
    ); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
BEGIN
DBMS_OUTPUT.PUT_LINE('[INICIO]');


    -- LOOP para insertar los valores --
    DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZAR DATOS EN '||V_TEXT_TABLA||'');
    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
      LOOP
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
        
        V_SQL :=   'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '''||TRIM(V_TMP_TIPO_DATA(1))||'''';
        EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
        
        IF V_NUM_TABLAS > 0 THEN

        	DBMS_OUTPUT.PUT_LINE('[INFO]: Actualizar tasación para el num_activo  '''||TRIM(V_TMP_TIPO_DATA(1))||'''');
        
        	V_MSQL :=   'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '''||TRIM(V_TMP_TIPO_DATA(1))||'''';        
        	EXECUTE IMMEDIATE V_MSQL INTO V_ID;        
        
	        	V_MSQL :=   'UPDATE '||V_ESQUEMA||'.'||V_TEXT_TABLA||' 
		                    SET TAS_FECHA_RECEPCION_TASACION = TO_DATE('''||TRIM(V_TMP_TIPO_DATA(4))||''', ''DD/MM/YYYY'')									
							 ,TAS_IMPORTE_TAS_FIN = '''||TRIM(V_TMP_TIPO_DATA(3))||'''
				     		 ,USUARIOMODIFICAR = '''||V_USUARIO||'''
						     ,FECHAMODIFICAR = SYSDATE
		                    WHERE TAS_ID_EXTERNO = '''||TRIM(V_TMP_TIPO_DATA(2))||'''
							AND ACT_ID = '||V_ID||'';
		                    
		        EXECUTE IMMEDIATE V_MSQL;
       	
       	END IF;
       
      END LOOP;
      
    COMMIT;    
    DBMS_OUTPUT.PUT_LINE('[FIN]: FINALIZADO CORRECTAMENTE ');

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
