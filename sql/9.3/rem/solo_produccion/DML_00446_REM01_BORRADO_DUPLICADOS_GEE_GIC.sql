--/*
--##########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20200903
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-8014
--## PRODUCTO=NO
--##
--## Finalidad:  
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 VersiÃ³n inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
	V_MSQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
 	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
 	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	V_USU VARCHAR2(30 CHAR):= 'REMVIP-8014';
	err_num NUMBER; -- Numero de errores
	err_msg VARCHAR2(2048); -- Mensaje de error
	
BEGIN
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');

	DBMS_OUTPUT.PUT_LINE('[INFO] BORRADO LOGICO REGISTROS DUPLICADOS TABLA GGE ');

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GGE_GASTOS_GESTION T1
		USING (
		    WITH DUPLICADOS AS (
			SELECT GPV_ID
			FROM '||V_ESQUEMA||'.GGE_GASTOS_GESTION
			WHERE BORRADO = 0
			GROUP BY GPV_ID
			HAVING COUNT(1) > 1
		    )
		    SELECT GPV.GPV_NUM_GASTO_HAYA, EGA.DD_EGA_DESCRIPCION, GGE.GGE_ID, ROW_NUMBER() OVER(PARTITION BY GPV.GPV_ID ORDER BY GGE.FECHACREAR) RN
		    FROM '||V_ESQUEMA||'.GGE_GASTOS_GESTION GGE
		    JOIN '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV ON GPV.GPV_ID = GGE.GPV_ID
		    JOIN '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO EGA ON EGA.DD_EGA_ID = GPV.DD_EGA_ID
		    JOIN DUPLICADOS DUP ON DUP.GPV_ID = GGE.GPV_ID
		) T2
		ON (T1.GGE_ID = T2.GGE_ID AND T2.RN > 1)
		WHEN MATCHED THEN UPDATE SET
		    T1.USUARIOBORRAR = ''REMVIP-8014''
		    , T1.FECHABORRAR = SYSDATE
		    , T1.BORRADO = 1';
			
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZADOS  '|| SQL%ROWCOUNT ||' REGISTROS EN GGE');

	DBMS_OUTPUT.PUT_LINE('[INFO] BORRADO LOGICO REGISTROS DUPLICADOS TABLA GIC ');

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD T1
		USING (
		    WITH DUPLICADOS AS (
			SELECT GPV_ID
			FROM '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD
			WHERE BORRADO = 0
			GROUP BY GPV_ID
			HAVING COUNT(1) > 1
		    )
		    SELECT GPV.GPV_NUM_GASTO_HAYA,GIC.GIC_ID, EGA.DD_EGA_DESCRIPCION, GPV.DD_STG_ID, GRF.DD_GRF_DESCRIPCION, ROW_NUMBER() OVER(PARTITION BY GPV.GPV_ID ORDER BY GIC.FECHACREAR) RN
		    FROM '||V_ESQUEMA||'.GIC_GASTOS_INFO_CONTABILIDAD GIC
		    JOIN '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV ON GPV.GPV_ID = GIC.GPV_ID
		    JOIN '||V_ESQUEMA||'.DD_EGA_ESTADOS_GASTO EGA ON EGA.DD_EGA_ID = GPV.DD_EGA_ID
		    LEFT JOIN '||V_ESQUEMA||'.DD_GRF_GESTORIA_RECEP_FICH GRF ON GRF.DD_GRF_ID = GPV.DD_GRF_ID
		    JOIN DUPLICADOS DUP ON DUP.GPV_ID = GIC.GPV_ID
		) T2
		ON (T1.GIC_ID = T2.GIC_ID AND T2.RN > 1)
		WHEN MATCHED THEN UPDATE SET
		     T1.USUARIOBORRAR = ''REMVIP-8014''
		    , T1.FECHABORRAR = SYSDATE
		    , T1.BORRADO = 1';
			
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZADOS  '|| SQL%ROWCOUNT ||' REGISTROS EN GIC');

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN] ');
	
	EXCEPTION
	
	    WHEN OTHERS THEN
		DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
		DBMS_OUTPUT.PUT_LINE(SQLERRM);
		DBMS_OUTPUT.PUT_LINE(V_MSQL);
		ROLLBACK;
		RAISE;
END;
/
EXIT;
