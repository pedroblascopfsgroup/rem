--/*
--##########################################
--## AUTOR=Ivan Repiso
--## FECHA_CREACION=20200914
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-8048
--## PRODUCTO=NO
--## 
--## Finalidad: Actualización motivo perimetro activo 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
	V_MSQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
 	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
 	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	V_TABLA VARCHAR2(40 CHAR):= 'ACT_PAC_PERIMETRO_ACTIVO'; -- Nombre de la tabla
	V_USU VARCHAR2(30 CHAR):= 'REMVIP-8048';
	V_MOTIVO VARCHAR2(40 CHAR):= 'Putback'; -- Motivo perimetro
	V_COUNT NUMBER(16); -- Vble. para comprobar
	V_KOUNT NUMBER(16); -- Vble. para contar
	err_num NUMBER; -- Numero de errores
	err_msg VARCHAR2(2048); -- Mensaje de error

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(32000 CHAR);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
			T_TIPO_DATA(7042783),
			T_TIPO_DATA(7049973),
			T_TIPO_DATA(7037393),
			T_TIPO_DATA(7037396),
			T_TIPO_DATA(7037390),
			T_TIPO_DATA(7037384),
			T_TIPO_DATA(7037389),
			T_TIPO_DATA(7037383),
			T_TIPO_DATA(7037378),
			T_TIPO_DATA(7037379),
			T_TIPO_DATA(7037370),
			T_TIPO_DATA(7037371),
			T_TIPO_DATA(7037374),
			T_TIPO_DATA(7037375),
			T_TIPO_DATA(7037366),
			T_TIPO_DATA(7037367),
			T_TIPO_DATA(7037369),
			T_TIPO_DATA(7037372),
			T_TIPO_DATA(7037368),
			T_TIPO_DATA(7037365),
			T_TIPO_DATA(7037387),
			T_TIPO_DATA(7037392),
			T_TIPO_DATA(7037377),
			T_TIPO_DATA(7037380),
			T_TIPO_DATA(7037381),
			T_TIPO_DATA(7037386),
			T_TIPO_DATA(7037373),
			T_TIPO_DATA(7037376),
			T_TIPO_DATA(7037391),
			T_TIPO_DATA(7037382),
			T_TIPO_DATA(7037385),
			T_TIPO_DATA(7037388),
			T_TIPO_DATA(7053953),
			T_TIPO_DATA(7053955),
			T_TIPO_DATA(7053954),
			T_TIPO_DATA(7053952),
			T_TIPO_DATA(7053951),
			T_TIPO_DATA(7053950),
			T_TIPO_DATA(7053949),
			T_TIPO_DATA(7053948),
			T_TIPO_DATA(7053947),
			T_TIPO_DATA(7053939),
			T_TIPO_DATA(7053946),
			T_TIPO_DATA(7053944),
			T_TIPO_DATA(7053945),
			T_TIPO_DATA(7053941),
			T_TIPO_DATA(7053937),
			T_TIPO_DATA(7053938),
			T_TIPO_DATA(7053940),
			T_TIPO_DATA(7053942),
			T_TIPO_DATA(7053943),
			T_TIPO_DATA(7053936),
			T_TIPO_DATA(7053934),
			T_TIPO_DATA(7053935),
			T_TIPO_DATA(7058105),
			T_TIPO_DATA(7058093),
			T_TIPO_DATA(7058086),
			T_TIPO_DATA(7058071),
			T_TIPO_DATA(7058097),
			T_TIPO_DATA(7058095),
			T_TIPO_DATA(7058111),
			T_TIPO_DATA(7058079),
			T_TIPO_DATA(7058073),
			T_TIPO_DATA(7058080),
			T_TIPO_DATA(7058083),
			T_TIPO_DATA(7058078),
			T_TIPO_DATA(7058104),
			T_TIPO_DATA(7058075),
			T_TIPO_DATA(7058118),
			T_TIPO_DATA(7058084),
			T_TIPO_DATA(7058109),
			T_TIPO_DATA(7058092),
			T_TIPO_DATA(7058115),
			T_TIPO_DATA(7058117),
			T_TIPO_DATA(7058106),
			T_TIPO_DATA(7058094),
			T_TIPO_DATA(7058072),
			T_TIPO_DATA(7058110),
			T_TIPO_DATA(7058107),
			T_TIPO_DATA(7058082),
			T_TIPO_DATA(7058112),
			T_TIPO_DATA(7058103),
			T_TIPO_DATA(7058108),
			T_TIPO_DATA(7058116),
			T_TIPO_DATA(7058114),
			T_TIPO_DATA(7058077),
			T_TIPO_DATA(7058098),
			T_TIPO_DATA(7058081),
			T_TIPO_DATA(7058100),
			T_TIPO_DATA(7058085),
			T_TIPO_DATA(7058096),
			T_TIPO_DATA(7058101),
			T_TIPO_DATA(7058113),
			T_TIPO_DATA(7058102),
			T_TIPO_DATA(7058090),
			T_TIPO_DATA(7058074),
			T_TIPO_DATA(7058099),
			T_TIPO_DATA(7058089),
			T_TIPO_DATA(7058076),
			T_TIPO_DATA(7058091),
			T_TIPO_DATA(7054983),
			T_TIPO_DATA(7054968),
			T_TIPO_DATA(7054969),
			T_TIPO_DATA(7054986),
			T_TIPO_DATA(7054987),
			T_TIPO_DATA(7054990),
			T_TIPO_DATA(7054993),
			T_TIPO_DATA(7054958),
			T_TIPO_DATA(7054959),
			T_TIPO_DATA(7054961),
			T_TIPO_DATA(7054992),
			T_TIPO_DATA(7054966),
			T_TIPO_DATA(7054967),
			T_TIPO_DATA(7054963),
			T_TIPO_DATA(7054957),
			T_TIPO_DATA(7054960),
			T_TIPO_DATA(7054962),
			T_TIPO_DATA(7054965),
			T_TIPO_DATA(7054970),
			T_TIPO_DATA(7054978),
			T_TIPO_DATA(7054991),
			T_TIPO_DATA(7054974),
			T_TIPO_DATA(7054980),
			T_TIPO_DATA(7054982),
			T_TIPO_DATA(7054984),
			T_TIPO_DATA(7054985),
			T_TIPO_DATA(7054988),
			T_TIPO_DATA(7054973),
			T_TIPO_DATA(7054976),
			T_TIPO_DATA(7054977),
			T_TIPO_DATA(7054979),
			T_TIPO_DATA(7054971),
			T_TIPO_DATA(7054964),
			T_TIPO_DATA(7054981),
			T_TIPO_DATA(7054989),
			T_TIPO_DATA(7054956),
			T_TIPO_DATA(7054972),
			T_TIPO_DATA(7054975),
			T_TIPO_DATA(7054995),
			T_TIPO_DATA(7054994),
			T_TIPO_DATA(7038015),
			T_TIPO_DATA(7053183),
			T_TIPO_DATA(7045553),
			T_TIPO_DATA(7061560),
			T_TIPO_DATA(7034304),
			T_TIPO_DATA(7034384),
			T_TIPO_DATA(7032757),
			T_TIPO_DATA(7032753),
			T_TIPO_DATA(7032759),
			T_TIPO_DATA(7032756),
			T_TIPO_DATA(7032765),
			T_TIPO_DATA(7032767),
			T_TIPO_DATA(7032760),
			T_TIPO_DATA(7032766),
			T_TIPO_DATA(7032751),
			T_TIPO_DATA(7032758),
			T_TIPO_DATA(7032761),
			T_TIPO_DATA(7032763),
			T_TIPO_DATA(7032764),
			T_TIPO_DATA(7032762),
			T_TIPO_DATA(7032752),
			T_TIPO_DATA(7032755),
			T_TIPO_DATA(7032754),
			T_TIPO_DATA(7032768),
			T_TIPO_DATA(7032750),
			T_TIPO_DATA(7052231),
			T_TIPO_DATA(7052226),
			T_TIPO_DATA(7052224),
			T_TIPO_DATA(7052215),
			T_TIPO_DATA(7052214),
			T_TIPO_DATA(7052212),
			T_TIPO_DATA(7052213),
			T_TIPO_DATA(7052211),
			T_TIPO_DATA(7052210),
			T_TIPO_DATA(7052208),
			T_TIPO_DATA(7052206),
			T_TIPO_DATA(7052207),
			T_TIPO_DATA(7052205),
			T_TIPO_DATA(7052204),
			T_TIPO_DATA(7052192),
			T_TIPO_DATA(7052200),
			T_TIPO_DATA(7052195),
			T_TIPO_DATA(7052187),
			T_TIPO_DATA(7052190),
			T_TIPO_DATA(7052198),
			T_TIPO_DATA(7052199),
			T_TIPO_DATA(7052202),
			T_TIPO_DATA(7052196),
			T_TIPO_DATA(7052197),
			T_TIPO_DATA(7052201),
			T_TIPO_DATA(7052194),
			T_TIPO_DATA(7052191),
			T_TIPO_DATA(7052189),
			T_TIPO_DATA(7052203),
			T_TIPO_DATA(7052188),
			T_TIPO_DATA(7052193),
			T_TIPO_DATA(7034251),
			T_TIPO_DATA(7034241),
			T_TIPO_DATA(7034248),
			T_TIPO_DATA(7034235),
			T_TIPO_DATA(7034239),
			T_TIPO_DATA(7034255),
			T_TIPO_DATA(7034238),
			T_TIPO_DATA(7034252),
			T_TIPO_DATA(7034245),
			T_TIPO_DATA(7034240),
			T_TIPO_DATA(7034254),
			T_TIPO_DATA(7034236),
			T_TIPO_DATA(7034250),
			T_TIPO_DATA(7034243),
			T_TIPO_DATA(7034244),
			T_TIPO_DATA(7061026),
			T_TIPO_DATA(7061033),
			T_TIPO_DATA(7061032),
			T_TIPO_DATA(7061042),
			T_TIPO_DATA(7061043),
			T_TIPO_DATA(7061025),
			T_TIPO_DATA(7061031),
			T_TIPO_DATA(7061034),
			T_TIPO_DATA(7061041),
			T_TIPO_DATA(7061030),
			T_TIPO_DATA(7061024),
			T_TIPO_DATA(7061037),
			T_TIPO_DATA(7061027),
			T_TIPO_DATA(7061035),
			T_TIPO_DATA(7061039),
			T_TIPO_DATA(7061044),
			T_TIPO_DATA(7061028),
			T_TIPO_DATA(7061040),
			T_TIPO_DATA(7061036),
			T_TIPO_DATA(7061029),
			T_TIPO_DATA(7061038),
			T_TIPO_DATA(7052222),
			T_TIPO_DATA(7052209),
			T_TIPO_DATA(7052219),
			T_TIPO_DATA(7052216),
			T_TIPO_DATA(7052217),
			T_TIPO_DATA(7052218),
			T_TIPO_DATA(7052220),
			T_TIPO_DATA(7052221),
			T_TIPO_DATA(7052223),
			T_TIPO_DATA(7052225),
			T_TIPO_DATA(7052227),
			T_TIPO_DATA(7052228),
			T_TIPO_DATA(7052229),
			T_TIPO_DATA(7052230),
			T_TIPO_DATA(7037399),
			T_TIPO_DATA(7037397),
			T_TIPO_DATA(7037401),
			T_TIPO_DATA(7037402),
			T_TIPO_DATA(7037404),
			T_TIPO_DATA(7037400),
			T_TIPO_DATA(7037403),
			T_TIPO_DATA(7037398),
			T_TIPO_DATA(7037405),
			T_TIPO_DATA(7052358),
			T_TIPO_DATA(7034246),
			T_TIPO_DATA(7054259),
			T_TIPO_DATA(7054260),
			T_TIPO_DATA(7054261),
			T_TIPO_DATA(7054262),
			T_TIPO_DATA(7054263),
			T_TIPO_DATA(7048439),
			T_TIPO_DATA(7041282),
			T_TIPO_DATA(7041286),
			T_TIPO_DATA(7041281),
			T_TIPO_DATA(7041283),
			T_TIPO_DATA(7041284),
			T_TIPO_DATA(7041285),
			T_TIPO_DATA(7058037),
			T_TIPO_DATA(7058069),
			T_TIPO_DATA(7058046),
			T_TIPO_DATA(7058054),
			T_TIPO_DATA(7058021),
			T_TIPO_DATA(7058045),
			T_TIPO_DATA(7058053),
			T_TIPO_DATA(7058030),
			T_TIPO_DATA(7058036),
			T_TIPO_DATA(7058043),
			T_TIPO_DATA(7058029),
			T_TIPO_DATA(7058047),
			T_TIPO_DATA(7058063),
			T_TIPO_DATA(7058062),
			T_TIPO_DATA(7058044),
			T_TIPO_DATA(7058068),
			T_TIPO_DATA(7058064),
			T_TIPO_DATA(7058027),
			T_TIPO_DATA(7058031),
			T_TIPO_DATA(7058028),
			T_TIPO_DATA(7058040),
			T_TIPO_DATA(7058038),
			T_TIPO_DATA(7058048),
			T_TIPO_DATA(7058060),
			T_TIPO_DATA(7058061),
			T_TIPO_DATA(7058039),
			T_TIPO_DATA(7058024),
			T_TIPO_DATA(7058056),
			T_TIPO_DATA(7058022),
			T_TIPO_DATA(7058055),
			T_TIPO_DATA(7058050),
			T_TIPO_DATA(7058052),
			T_TIPO_DATA(7058051),
			T_TIPO_DATA(7058023),
			T_TIPO_DATA(7058035),
			T_TIPO_DATA(7058033),
			T_TIPO_DATA(7058034),
			T_TIPO_DATA(7058049),
			T_TIPO_DATA(7058032),
			T_TIPO_DATA(7058042),
			T_TIPO_DATA(7058067),
			T_TIPO_DATA(7058066),
			T_TIPO_DATA(7058026),
			T_TIPO_DATA(7058065),
			T_TIPO_DATA(7058057),
			T_TIPO_DATA(7058041),
			T_TIPO_DATA(7058059),
			T_TIPO_DATA(7058025),
			T_TIPO_DATA(7058058),
			T_TIPO_DATA(7046891),
			T_TIPO_DATA(7046896),
			T_TIPO_DATA(7046893)
		); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
	
BEGIN
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');

	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZAMOS TODO LO QUE CONTENGA PUTBACK A NULL');

	V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET 
				PAC_MOTIVO_FORMALIZAR = NULL,
				PAC_MOTIVO_PUBLICAR = NULL,
				PAC_MOT_EXCL_COMERCIALIZAR = NULL,
				USUARIOMODIFICAR = '''||V_USU||''',
				FECHAMODIFICAR = SYSDATE
				WHERE (REGEXP_LIKE(UPPER(PAC_MOTIVO_FORMALIZAR),''.*PUT.?BACK.*'') OR REGEXP_LIKE(UPPER(PAC_MOTIVO_PUBLICAR),''.*PUT.?BACK.*'')
						OR REGEXP_LIKE(UPPER(PAC_MOT_EXCL_COMERCIALIZAR),''.*PUT.?BACK.*''))
				AND BORRADO = 0';
				
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZADOS  '|| SQL%ROWCOUNT ||' REGISTROS EN '||V_TABLA||'');

	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZAMOS MOTIVOS DE ACTIVOS ADJUNTOS A PUTBACK');

	V_KOUNT := 0;

	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
      LOOP
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);

			V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE ACT_ID = 
					(SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||')
					AND BORRADO = 0';
				
			EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

			IF V_COUNT = 0 THEN

				DBMS_OUTPUT.PUT_LINE('[INFO] NO EXISTE EL ACTIVO NUMERO '||V_TMP_TIPO_DATA(1)||' EN '||V_TABLA||'');

			ELSE

				--ACTUALIZAMOS MOTIVOS 
				V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET 
						PAC_MOTIVO_FORMALIZAR = '''||V_MOTIVO||''',
						PAC_MOTIVO_PUBLICAR = '''||V_MOTIVO||''',
						PAC_MOT_EXCL_COMERCIALIZAR = '''||V_MOTIVO||''',
						USUARIOMODIFICAR = '''||V_USU||''',
						FECHAMODIFICAR = SYSDATE
						WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||')
						AND BORRADO = 0';
					
				EXECUTE IMMEDIATE V_MSQL;
				DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZADOS  '|| SQL%ROWCOUNT ||' REGISTROS');

				V_KOUNT := V_KOUNT + 1;

			END IF;

	END LOOP;

	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZADOS  '|| V_KOUNT ||' REGISTROS EN '||V_TABLA||'');

	COMMIT;
	DBMS_OUTPUT.PUT_LINE('[FIN] ');
	
	EXCEPTION
	
	    WHEN OTHERS THEN
		DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
		DBMS_OUTPUT.PUT_LINE(SQLERRM);
		DBMS_OUTPUT.PUT_LINE(V_MSQL);
		ROLLBACK;
		RAISE;
END;
/
EXIT;