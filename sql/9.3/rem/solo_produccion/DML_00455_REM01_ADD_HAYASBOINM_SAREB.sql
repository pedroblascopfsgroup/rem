--/*
--##########################################
--## AUTOR=Ivan Repiso
--## FECHA_CREACION=20200916
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-8009
--## PRODUCTO=NO
--## 
--## Finalidad: Añadir supervisor comercial backoffice inmobiliario Sareb
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
	V_MSQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
 	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
 	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	V_USU VARCHAR2(30 CHAR):= 'REMVIP-8009';
	V_COUNT NUMBER(16); -- Vble. para comprobar
	err_num NUMBER; -- Numero de errores
	err_msg VARCHAR2(2048); -- Mensaje de error

	
BEGIN
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');


	--Comprobamos la existencia de usuario mruiz
	V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''mruiz''';
	EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

	IF V_COUNT = 1 THEN

		V_MSQL := 'MERGE INTO AUX_REMVIP_8009 T1 USING (
						SELECT ACT.ACT_ID FROM ACT_ACTIVO ACT
						LEFT JOIN V_GESTORES_ACTIVO VGA ON VGA.ACT_ID = ACT.ACT_ID AND DD_CRA_CODIGO = 2 AND TIPO_GESTOR = ''HAYASBOINM''
						WHERE ACT.DD_CRA_ID = 2 AND ACT.BORRADO = 0 AND VGA.ACT_ID IS NULL
					) T2
						ON (T1.ACT_ID = T2.ACT_ID)
					WHEN NOT MATCHED THEN
					INSERT (ACT_ID) VALUES (T2.ACT_ID)';
		
		EXECUTE IMMEDIATE V_MSQL;
		DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS EN TABLA AUXILIAR:  '|| SQL%ROWCOUNT ||' REGISTROS');

		--INSERTAMOS TANTOS REGISTROS COMO ACTIVOS EN LA GEE
		V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD
					(GEE_ID,USU_ID,DD_TGE_ID, USUARIOCREAR, 
					FECHACREAR,USUARIOMODIFICAR)
				SELECT  '||V_ESQUEMA||'.S_GEE_GESTOR_ENTIDAD.NEXTVAL,
					(SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''mruiz''),
					(SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = ''HAYASBOINM''),
					'''||V_USU||''',SYSDATE,TO_CHAR(AUX.ACT_ID)
				FROM '||V_ESQUEMA||'.AUX_REMVIP_8009 AUX';
		
		EXECUTE IMMEDIATE V_MSQL;
		DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS EN GEE:  '|| SQL%ROWCOUNT ||' REGISTROS');
		
		--INSERTAMOS EN LA GAC
		V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GAC_GESTOR_ADD_ACTIVO GAC
				(GEE_ID, ACT_ID)
				SELECT UNIQUE GEE.GEE_ID, 
				TO_NUMBER(GEE.USUARIOMODIFICAR)
				FROM '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD GEE
				WHERE GEE.USUARIOCREAR = '''||V_USU||''' AND GEE.USUARIOMODIFICAR IS NOT NULL';		
			
		EXECUTE IMMEDIATE V_MSQL;
		DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS EN GAC:  '|| SQL%ROWCOUNT ||' REGISTROS ');
			
		V_MSQL:='UPDATE '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD
				SET USUARIOMODIFICAR = NULL
				WHERE USUARIOCREAR = '''||V_USU||''' AND USUARIOMODIFICAR IS NOT NULL';
			
		EXECUTE IMMEDIATE V_MSQL;	
			
		--INSERTAMOS EN LA GEH
		V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST
					(GEH_ID,USU_ID,DD_TGE_ID, GEH_FECHA_DESDE,
					USUARIOCREAR, FECHACREAR, USUARIOMODIFICAR)
				SELECT  '||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL,
					(SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''mruiz''),
					(SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = ''HAYASBOINM''),
					SYSDATE,'''||V_USU||''',SYSDATE,TO_CHAR(AUX.ACT_ID)
				FROM '||V_ESQUEMA||'.AUX_REMVIP_8009 AUX';
		
		EXECUTE IMMEDIATE V_MSQL;
		DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS EN GEH:  '|| SQL%ROWCOUNT ||' REGISTROS ');
			
		--INSERTAMOS EN LA GAH
		V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.GAH_GESTOR_ACTIVO_HISTORICO GAH
				(GEH_ID, ACT_ID) 
				SELECT UNIQUE GEH.GEH_ID, 
				TO_NUMBER(GEH.USUARIOMODIFICAR )
				FROM '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST GEH		 
				WHERE GEH.USUARIOCREAR = '''||V_USU||'''  AND GEH.USUARIOMODIFICAR IS NOT NULL';
		
		EXECUTE IMMEDIATE V_MSQL;
		DBMS_OUTPUT.PUT_LINE('[INFO] INSERTADOS EN GAH:  '|| SQL%ROWCOUNT ||' REGISTROS ');
			
		V_MSQL:='UPDATE '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST 
				SET USUARIOMODIFICAR = NULL 
				WHERE USUARIOCREAR = '''||V_USU||''' AND USUARIOMODIFICAR IS NOT NULL';
		
		EXECUTE IMMEDIATE V_MSQL;


		COMMIT;

	ELSE

		DBMS_OUTPUT.PUT_LINE('[INFO] No existe el usuario mruiz');

	END IF;
	
	DBMS_OUTPUT.PUT_LINE('[FIN] ');
	
	EXCEPTION
	
	    WHEN OTHERS THEN
		DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
		DBMS_OUTPUT.PUT_LINE(SQLERRM);
		DBMS_OUTPUT.PUT_LINE(V_MSQL);
		ROLLBACK;
		RAISE;
END;
/
EXIT;
