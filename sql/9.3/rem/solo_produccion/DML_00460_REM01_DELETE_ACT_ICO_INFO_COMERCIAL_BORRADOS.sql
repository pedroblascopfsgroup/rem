--/*
--##########################################
--## AUTOR=GUILLEM REY
--## FECHA_CREACION=20200922
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-8100
--## PRODUCTO=NO
--##
--## Finalidad: Actualizar instrucciones
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Version inicial
--##########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_MSQL1 VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	V_ID NUMBER(16); -- Vble. auxiliar para almacenar temporalmente el numero de la sequencia.
	V_TABLA VARCHAR2(2400 CHAR) := 'AUX_REMVIP_6692'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
	V_TABLA_ICO VARCHAR2(2400 CHAR) := 'ACT_ICO_INFO_COMERCIAL'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
	V_TABLA_VIV VARCHAR2(2400 CHAR) := 'ACT_VIV_VIVIENDA'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
	V_TABLA_APR VARCHAR2(2400 CHAR) := 'ACT_APR_PLAZA_APARCAMIENTO'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
	V_TABLA_LCO VARCHAR2(2400 CHAR) := 'ACT_LCO_LOCAL_COMERCIAL'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
	V_USUARIO_BORRAR VARCHAR2(50 CHAR) := 'REMVIP-6692';

    
BEGIN
	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	
	--ACT_BNY_BANYO
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN ACT_BNY_BANYO');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_BNY_BANYO WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN ACT_BNY_BANYO');
    
    
    --ACT_CRE_CARPINTERIA_EXT
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN ACT_CRE_CARPINTERIA_EXT');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_CRE_CARPINTERIA_EXT WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN ACT_CRE_CARPINTERIA_EXT');
    
    
    --ACT_CRI_CARPINTERIA_INT
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN ACT_CRI_CARPINTERIA_INT');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_CRI_CARPINTERIA_INT WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN ACT_CRI_CARPINTERIA_INT');
    
    
    --ACT_COC_COCINA
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN ACT_COC_COCINA');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_COC_COCINA WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN ACT_COC_COCINA');
    
    
    
    --ACT_DIS_DISTRIBUCION
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN ACT_DIS_DISTRIBUCION');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_DIS_DISTRIBUCION WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN ACT_DIS_DISTRIBUCION');
    
      
    
    --ACT_EDI_EDIFICIO
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN ACT_EDI_EDIFICIO');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_EDI_EDIFICIO WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN ACT_EDI_EDIFICIO');
    
    
    
    --ACT_INF_INFRAESTRUCTURA
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN ACT_INF_INFRAESTRUCTURA');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_INF_INFRAESTRUCTURA WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN ACT_INF_INFRAESTRUCTURA');
    
    
    
    --ACT_INS_INSTALACION
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN ACT_INS_INSTALACION');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_INS_INSTALACION WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN ACT_INS_INSTALACION');
    
    
    --ACT_PRV_PARAMENTO_VERTICAL
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN ACT_PRV_PARAMENTO_VERTICAL');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_PRV_PARAMENTO_VERTICAL WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN ACT_PRV_PARAMENTO_VERTICAL');
    
    
    --ACT_SOL_SOLADO
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN ACT_SOL_SOLADO');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_SOL_SOLADO WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN ACT_SOL_SOLADO');
    
    
    --ACT_ZCO_ZONA_COMUN
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN ACT_ZCO_ZONA_COMUN');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_ZCO_ZONA_COMUN WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN ACT_ZCO_ZONA_COMUN');
    
    --ACT_VIV_VIVIENDA
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN '''||V_TABLA_VIV||'''');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.'||V_TABLA_VIV||' WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN '''||V_TABLA_VIV||'''');
    
    --ACT_LCO_LOCAL_COMERCIAL
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN '''||V_TABLA_LCO||'''');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.'||V_TABLA_LCO||' WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN '''||V_TABLA_LCO||'''');
    
    --ACT_APR_PLAZA_APARCAMIENTO
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR DATOS EN '''||V_TABLA_APR||'''');
	
    V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.'||V_TABLA_APR||' WHERE ICO_ID IN
				(
				SELECT DISTINCT ICO_ID
				FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' 
				WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''
			)';
	EXECUTE IMMEDIATE V_MSQL;
	
    DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' DATOS BORRADOS EN '''||V_TABLA_APR||'''');
    

	--ACT_ICO_INFO_COMERCIAL
	DBMS_OUTPUT.PUT_LINE('[INFO]: BORRANDO Y INSERTANDO DATOS EN ICO_INFO_COMERCIAL');
	
	V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.'||V_TABLA_ICO||' WHERE BORRADO = 1 AND USUARIOBORRAR = '''||V_USUARIO_BORRAR||'''';
			
	EXECUTE IMMEDIATE V_MSQL;
	

    
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN]: FINALIZADO CORRECTAMENTE ');

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
