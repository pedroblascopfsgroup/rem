--/*
--##########################################
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20200929
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-8136
--## PRODUCTO=NO
--## 
--## Finalidad: Script que añade en ACT_TAS_TASACION los datos añadidos en T_ARRAY_DATA
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
        V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    	V_TABLA_1 VARCHAR2(25 CHAR):= 'BIE_VALORACIONES';
    	V_TABLA_2 VARCHAR2(25 CHAR):= 'ACT_TAS_TASACION';
    	V_COUNT NUMBER(16); -- Vble. para contar.
    	V_KOUNT NUMBER(16); -- Vble. para kontar.
    	V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    	ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    	ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

	ACT_NUM_ACTIVO NUMBER(16);
	ACT_ID NUMBER(16);
	NUM_SECUENCIA_VAL NUMBER(16);
	NUM_SECUENCIA_TAS NUMBER(16);
	BIE_ID NUMBER(16);

    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-8136';    
    
    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    			-- NUM_ACT	TIPO_TASACION 	FECHA_TAS	IMPORTE_TAS	TASADORA,  FECHA_CADUCIDAD
		T_TIPO_DATA('6044010','3','11/09/2020','114386.85','ARCO VALORACIONES'),
		T_TIPO_DATA('6044011','3','22/09/2020','53890.78','ARCO VALORACIONES'),
		T_TIPO_DATA('6044020','3','04/09/2020','107142.4','ARCO VALORACIONES'),
		T_TIPO_DATA('6044021','3','04/09/2020','33590.92','ARCO VALORACIONES'),
		T_TIPO_DATA('6044030','3','22/09/2020','343490.04','ARCO VALORACIONES'),
		T_TIPO_DATA('6044037','3','22/09/2020','29885.9','ARCO VALORACIONES'),
		T_TIPO_DATA('6044043','3','04/09/2020','133517.37','ARCO VALORACIONES'),
		T_TIPO_DATA('6044051','3','04/09/2020','15536.9','ARCO VALORACIONES'),
		T_TIPO_DATA('6044080','3','04/09/2020','117849.42','ARCO VALORACIONES'),
		T_TIPO_DATA('6044103','3','04/09/2020','95076.94','ARCO VALORACIONES'),
		T_TIPO_DATA('6044104','3','11/09/2020','76637.16','ARCO VALORACIONES'),
		T_TIPO_DATA('6044105','3','22/09/2020','75545.66','ARCO VALORACIONES'),
		T_TIPO_DATA('6044116','3','04/09/2020','151349.6','ARCO VALORACIONES'),
		T_TIPO_DATA('6044169','3','04/09/2020','57875.2','ARCO VALORACIONES'),
		T_TIPO_DATA('6044175','3','11/09/2020','117495.42','ARCO VALORACIONES'),
		T_TIPO_DATA('6044180','3','04/09/2020','118134.19','ARCO VALORACIONES'),
		T_TIPO_DATA('6044187','3','04/09/2020','56001.86','ARCO VALORACIONES'),
		T_TIPO_DATA('6044188','3','04/09/2020','227719.4','ARCO VALORACIONES'),
		T_TIPO_DATA('6044190','3','22/09/2020','75851.67','ARCO VALORACIONES'),
		T_TIPO_DATA('6044191','3','22/09/2020','76232.07','ARCO VALORACIONES'),
		T_TIPO_DATA('6044202','3','22/09/2020','36608.89','ARCO VALORACIONES'),
		T_TIPO_DATA('6044216','3','04/09/2020','14508.9','ARCO VALORACIONES'),
		T_TIPO_DATA('6044225','3','11/09/2020','125187.98','ARCO VALORACIONES'),
		T_TIPO_DATA('6044228','3','22/09/2020','125258.69','ARCO VALORACIONES'),
		T_TIPO_DATA('6044229','3','04/09/2020','100934.34','ARCO VALORACIONES'),
		T_TIPO_DATA('6044231','3','04/09/2020','39001.52','ARCO VALORACIONES'),
		T_TIPO_DATA('6044232','3','22/09/2020','119319.38','ARCO VALORACIONES'),
		T_TIPO_DATA('6044260','3','04/09/2020','39107.4','ARCO VALORACIONES'),
		T_TIPO_DATA('6044281','3','22/09/2020','76232.07','ARCO VALORACIONES'),
		T_TIPO_DATA('6044292','3','04/09/2020','105938.39','ARCO VALORACIONES'),
		T_TIPO_DATA('6044318','3','04/09/2020','64063.9','ARCO VALORACIONES'),
		T_TIPO_DATA('6084928','3','22/09/2020','8442.46','ARCO VALORACIONES'),
		T_TIPO_DATA('6084990','3','04/09/2020','47983.69','ARCO VALORACIONES'),
		T_TIPO_DATA('6084992','3','04/09/2020','101488.49','ARCO VALORACIONES'),
		T_TIPO_DATA('6084994','3','11/09/2020','49155.26','ARCO VALORACIONES'),
		T_TIPO_DATA('6762164','3','04/09/2020','47184.59','ARCO VALORACIONES'),
		T_TIPO_DATA('6762171','3','22/09/2020','6666.02','ARCO VALORACIONES'),
		T_TIPO_DATA('6762172','3','22/09/2020','42579.05','ARCO VALORACIONES'),
		T_TIPO_DATA('6762174','3','22/09/2020','772.8','ARCO VALORACIONES'),
		T_TIPO_DATA('6762198','3','04/09/2020','76694.06','ARCO VALORACIONES'),
		T_TIPO_DATA('6762201','3','22/09/2020','51139.63','ARCO VALORACIONES'),
		T_TIPO_DATA('6762203','3','04/09/2020','23821.66','ARCO VALORACIONES'),
		T_TIPO_DATA('6762206','3','11/09/2020','49606.71','ARCO VALORACIONES'),
		T_TIPO_DATA('6762213','3','22/09/2020','402099.18','ARCO VALORACIONES'),
		T_TIPO_DATA('6762223','3','04/09/2020','97780.55','ARCO VALORACIONES'),
		T_TIPO_DATA('6762226','3','11/09/2020','73010.96','ARCO VALORACIONES'),
		T_TIPO_DATA('6762227','3','04/09/2020','13896.74','ARCO VALORACIONES'),
		T_TIPO_DATA('6762233','3','22/09/2020','6335.4','ARCO VALORACIONES'),
		T_TIPO_DATA('6762235','3','04/09/2020','96889.48','ARCO VALORACIONES'),
		T_TIPO_DATA('6762239','3','04/09/2020','40023.93','ARCO VALORACIONES'),
		T_TIPO_DATA('6762240','3','11/09/2020','62189.51','ARCO VALORACIONES'),
		T_TIPO_DATA('6762246','3','11/09/2020','115469.85','ARCO VALORACIONES'),
		T_TIPO_DATA('6762250','3','11/09/2020','37512','ARCO VALORACIONES'),
		T_TIPO_DATA('6762253','3','22/09/2020','5914.37','ARCO VALORACIONES'),
		T_TIPO_DATA('6762255','3','22/09/2020','73442.6','ARCO VALORACIONES'),
		T_TIPO_DATA('6762260','3','04/09/2020','54677.01','ARCO VALORACIONES'),
		T_TIPO_DATA('6762264','3','22/09/2020','170960.36','ARCO VALORACIONES'),
		T_TIPO_DATA('6762265','3','22/09/2020','113576.71','ARCO VALORACIONES'),
		T_TIPO_DATA('6762279','3','04/09/2020','118075.05','ARCO VALORACIONES'),
		T_TIPO_DATA('6762280','3','04/09/2020','54172.98','ARCO VALORACIONES'),
		T_TIPO_DATA('6762291','3','22/09/2020','51338.36','ARCO VALORACIONES'),
		T_TIPO_DATA('6762294','3','04/09/2020','31357.84','ARCO VALORACIONES'),
		T_TIPO_DATA('6762301','3','04/09/2020','76962.28','ARCO VALORACIONES'),
		T_TIPO_DATA('6762317','3','04/09/2020','181196.6','ARCO VALORACIONES'),
		T_TIPO_DATA('6762318','3','04/09/2020','193366.88','ARCO VALORACIONES'),
		T_TIPO_DATA('6762321','3','04/09/2020','187767.93','ARCO VALORACIONES'),
		T_TIPO_DATA('6762324','3','11/09/2020','137482.43','ARCO VALORACIONES'),
		T_TIPO_DATA('6762326','3','04/09/2020','42443.88','ARCO VALORACIONES'),
		T_TIPO_DATA('6762348','3','04/09/2020','53649','ARCO VALORACIONES'),
		T_TIPO_DATA('6762350','3','11/09/2020','97003.06','ARCO VALORACIONES'),
		T_TIPO_DATA('6762351','3','04/09/2020','4907.84','ARCO VALORACIONES'),
		T_TIPO_DATA('6762352','3','04/09/2020','11537.74','ARCO VALORACIONES'),
		T_TIPO_DATA('6762354','3','04/09/2020','206131.29','ARCO VALORACIONES'),
		T_TIPO_DATA('6762360','3','04/09/2020','99651.93','ARCO VALORACIONES'),
		T_TIPO_DATA('6762366','3','04/09/2020','224077.92','ARCO VALORACIONES'),
		T_TIPO_DATA('6762374','3','11/09/2020','62458.44','ARCO VALORACIONES'),
		T_TIPO_DATA('6762375','3','04/09/2020','57775.71','ARCO VALORACIONES'),
		T_TIPO_DATA('6762382','3','11/09/2020','62839.47','ARCO VALORACIONES'),
		T_TIPO_DATA('6762385','3','04/09/2020','107449.47','ARCO VALORACIONES'),
		T_TIPO_DATA('6762386','3','11/09/2020','111623.97','ARCO VALORACIONES'),
		T_TIPO_DATA('6762387','3','22/09/2020','98600.02','ARCO VALORACIONES'),
		T_TIPO_DATA('6762391','3','22/09/2020','68906.12','ARCO VALORACIONES'),
		T_TIPO_DATA('6762398','3','04/09/2020','59705.29','ARCO VALORACIONES'),
		T_TIPO_DATA('6762405','3','11/09/2020','94882.86','ARCO VALORACIONES'),
		T_TIPO_DATA('6776330','3','04/09/2020','101729.52','ARCO VALORACIONES'),
		T_TIPO_DATA('6788176','3','22/09/2020','117162.2','ARCO VALORACIONES'),
		T_TIPO_DATA('6814469','3','04/09/2020','205624.09','ARCO VALORACIONES'),
		T_TIPO_DATA('7007132','3','04/09/2020','144872.65','ARCO VALORACIONES'),
		T_TIPO_DATA('7011997','3','04/09/2020','42060.06','ARCO VALORACIONES'),
		T_TIPO_DATA('7011998','3','04/09/2020','7919.7','ARCO VALORACIONES'),
		T_TIPO_DATA('7073193','3','22/09/2020','31292.58','ARCO VALORACIONES'),
		T_TIPO_DATA('7073194','3','22/09/2020','13890.76','ARCO VALORACIONES'),
		T_TIPO_DATA('7075193','3','04/09/2020','348653.17','ARCO VALORACIONES'),
		T_TIPO_DATA('7075808','3','04/09/2020','25842.48','ARCO VALORACIONES'),
		T_TIPO_DATA('7300817','3','22/09/2020','89386.93','ARCO VALORACIONES'),
		T_TIPO_DATA('7300819','3','04/09/2020','7682.86','ARCO VALORACIONES'),
		T_TIPO_DATA('6962192','3','11/09/2020','82271.92','ARCO VALORACIONES'),
		T_TIPO_DATA('6962193','3','11/09/2020','8512.22','ARCO VALORACIONES'),
		T_TIPO_DATA('6762336','3','11/09/2020','239862.86','ARCO VALORACIONES'),
		T_TIPO_DATA('7012907','3','22/09/2020','97133.54','ARCO VALORACIONES')
		); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN	
	
    DBMS_OUTPUT.PUT_LINE('[INICIO] ');


    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
      LOOP
      
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
    	ACT_NUM_ACTIVO := TRIM(V_TMP_TIPO_DATA(1));
       	EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO INTO V_KOUNT;
  			  
		IF V_KOUNT > 0 THEN 
	  			  
			EXECUTE IMMEDIATE 'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO INTO ACT_ID;
			
			EXECUTE IMMEDIATE 'SELECT BIE_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO INTO BIE_ID;
			
			EXECUTE IMMEDIATE 'SELECT '||V_ESQUEMA||'.S_BIE_VALORACIONES.NEXTVAL FROM DUAL' INTO NUM_SECUENCIA_VAL;
			
			EXECUTE IMMEDIATE 'SELECT '||V_ESQUEMA||'.S_ACT_TAS_TASACION.NEXTVAL FROM DUAL' INTO NUM_SECUENCIA_TAS;
	
			V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_1||' (BIE_ID, BIE_VAL_ID, BIE_FECHA_VALOR_TASACION, FECHACREAR, 
			USUARIOCREAR, VERSION, BORRADO)
					  SELECT '''||BIE_ID||''', 
							 '''||NUM_SECUENCIA_VAL||''',
							 TO_DATE('''||TRIM(V_TMP_TIPO_DATA(3))||''', ''DD/MM/YYYY''),
							 SYSDATE,
							 '''||V_USUARIO||''',
							 0,
							 0
					  FROM DUAL';

			EXECUTE IMMEDIATE V_SQL;
			
			DBMS_OUTPUT.PUT_LINE('INSERTADO EL ACTIVO '||ACT_NUM_ACTIVO||' EN '||V_TABLA_1);
			
			V_SQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA_2||' (ACT_ID, BIE_VAL_ID, TAS_ID, DD_TTS_ID, TAS_NOMBRE_TASADOR, FECHACREAR, 
			USUARIOCREAR, VERSION, BORRADO, TAS_FECHA_INI_TASACION, TAS_IMPORTE_TAS_FIN)
					  SELECT '''||ACT_ID||''',
							 '''||NUM_SECUENCIA_VAL||''',
							 '''||NUM_SECUENCIA_TAS||''',
							 '''||TRIM(V_TMP_TIPO_DATA(2))||''',
							 '''||TRIM(V_TMP_TIPO_DATA(5))||''',
							 SYSDATE,
							 '''||V_USUARIO||''',
							 0,
							 0,
							 TO_DATE('''||TRIM(V_TMP_TIPO_DATA(3))||''', ''DD/MM/YYYY''),
							 TO_NUMBER('''|| REPLACE( TRIM(V_TMP_TIPO_DATA(4)), ',', '.' )  ||''',''99999999.99'')
					  FROM DUAL';
			EXECUTE IMMEDIATE V_SQL;
			
			DBMS_OUTPUT.PUT_LINE('INSERTADO EL ACTIVO '||ACT_NUM_ACTIVO||' EN '||V_TABLA_2);
			
			V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
				
		ELSE
			
			DBMS_OUTPUT.PUT_LINE('[INFO] El activo '||ACT_NUM_ACTIVO||' no existe!');
			
		END IF;
		
      END LOOP;
    COMMIT;

    DBMS_OUTPUT.PUT_LINE('[INFO] Se han insertado en total '||V_COUNT_UPDATE||' registros en la tabla '||V_TABLA_1);
    DBMS_OUTPUT.PUT_LINE('[INFO] Se han insertado en total '||V_COUNT_UPDATE||' registros en la tabla '||V_TABLA_2);
   

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;
/
EXIT
