--/*
--#########################################
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20201001
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-8179
--## PRODUCTO=NO
--## 
--## Finalidad: Modificar gasto
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	
    err_num NUMBER; -- Numero de error.
    err_msg VARCHAR2(2048); -- Mensaje de error.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquemas.
    V_USUARIO VARCHAR(100 CHAR):= 'REMVIP-8179';
    V_SQL VARCHAR2(32000 CHAR);
	V_TABLA VARCHAR2(25 CHAR):= 'GPV_GASTOS_PROVEEDOR';
	V_TABLA2 VARCHAR2(30 CHAR):= 'GIC_GASTOS_INFO_CONTABILIDAD';

	V_GASTO NUMBER(16):= 12062451;
	V_TIPO VARCHAR2(25 CHAR):= 'Publicidad';
	V_SUBTIPO VARCHAR2(25 CHAR):= 'Publicidad';
	V_CUENTA NUMBER(16):= 6270000000;
	V_PARTIDA_PRE VARCHAR2(25 CHAR):= 'PP040';
	V_SUBPARTIDA_PRE VARCHAR2(25 CHAR):= 'PUBLICIDAD Y MARKETING';

BEGIN			
			
	DBMS_OUTPUT.PUT_LINE('[INICIO]');	
	DBMS_OUTPUT.PUT_LINE('[INFO] UPDATE EN '||V_TABLA);		

	V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET 
				DD_TGA_ID = (SELECT DD_TGA_ID FROM '||V_ESQUEMA||'.DD_TGA_TIPOS_GASTO WHERE DD_TGA_DESCRIPCION = '''||V_TIPO||''' AND BORRADO = 0),
			    DD_STG_ID = (SELECT DD_STG_ID FROM '||V_ESQUEMA||'.DD_STG_SUBTIPOS_GASTO WHERE DD_STG_DESCRIPCION = '''||V_SUBTIPO||''' AND BORRADO = 0),
			    USUARIOMODIFICAR = '''||V_USUARIO||''', FECHAMODIFICAR = SYSDATE
				WHERE GPV_NUM_GASTO_HAYA = '||V_GASTO||' AND BORRADO = 0';
	EXECUTE IMMEDIATE V_SQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] Modificados '||SQL%ROWCOUNT||' registro/s en '||V_TABLA);

	DBMS_OUTPUT.PUT_LINE('[INFO] UPDATE EN '||V_TABLA2);		

	V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA2||' SET 
				GIC_CUENTA_CONTABLE = '||V_CUENTA||',
			    GIC_PTDA_PRESUPUESTARIA = '''||V_PARTIDA_PRE||''',
				CPS_ID = (SELECT CPS_ID FROM '||V_ESQUEMA||'.CPS_CONFIG_SUBPTDAS_PRE WHERE CPS_CUENTA_CONTABLE = '||V_CUENTA||' AND CPS_DESCRIPCION = '''||V_SUBPARTIDA_PRE||'''
				AND CPS_PARTIDA_PRESUPUESTARIA = '''||V_PARTIDA_PRE||''' AND BORRADO = 0),
			    USUARIOMODIFICAR = '''||V_USUARIO||''', FECHAMODIFICAR = SYSDATE
				WHERE GPV_ID = (SELECT GPV_ID FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE GPV_NUM_GASTO_HAYA = '||V_GASTO||' AND BORRADO = 0)
				AND BORRADO = 0';
	EXECUTE IMMEDIATE V_SQL;
	DBMS_OUTPUT.PUT_LINE('[INFO] Modificados '||SQL%ROWCOUNT||' registro/s en '||V_TABLA2);

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN] Proceso realizado');
	

EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT
