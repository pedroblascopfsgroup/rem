--/*
--##########################################
--## AUTOR=Viorel Remus Ovidiu
--## FECHA_CREACION=20210118
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=RREMVIP-8703
--## PRODUCTO=NO
--## 
--## Finalidad: Script que actualizar fecha alta ofertas
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(25 CHAR):= 'ACT_VAL_VALORACIONES';
    V_COUNT NUMBER(16); -- Vble. para contar.
    V_KOUNT NUMBER(16); -- Vble. para kontar.
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

    ACT_ID NUMBER(16);
    ACT_NUM_ACTIVO NUMBER(16);

    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-8703';    

    
BEGIN	
	
    DBMS_OUTPUT.PUT_LINE('[INICIO] ');
    
     DBMS_OUTPUT.PUT_LINE('[IRPF_SUJETO] ');
    
    V_SQL := 'MERGE INTO REM01.GDE_GASTOS_DETALLE_ECONOMICO T1
		USING (
		    SELECT GLD.GPV_ID, GDE.GDE_IRPF_BASE, GDE.GDE_IRPF_CUOTA
			, ROUND(SUM(NVL(GLD.GLD_PRINCIPAL_SUJETO, 0)), 2) SUJETO
			, ROUND(SUM(NVL(GLD.GLD_PRINCIPAL_NO_SUJETO, 0) + NVL(GLD.GLD_RECARGO, 0) + NVL(GLD.GLD_COSTAS, 0) + NVL(GLD.GLD_INTERES_DEMORA, 0) + NVL(GLD.GLD_PROV_SUPLIDOS, 0) + NVL(GLD.GLD_OTROS_INCREMENTOS, 0)), 2) NO_SUJETO
			, ROUND(SUM(NVL(GLD.GLD_PRINCIPAL_SUJETO, 0)) * GDE.GDE_IRPF_TIPO_IMPOSITIVO / 100, 2) IRPF_SUJETO
			, ROUND(SUM(NVL(GLD.GLD_PRINCIPAL_NO_SUJETO, 0) + NVL(GLD.GLD_RECARGO, 0) + NVL(GLD.GLD_COSTAS, 0) + NVL(GLD.GLD_INTERES_DEMORA, 0) + NVL(GLD.GLD_PROV_SUPLIDOS, 0) + NVL(GLD.GLD_OTROS_INCREMENTOS, 0)) * GDE.GDE_IRPF_TIPO_IMPOSITIVO / 100, 2) IRPF_NO_SUJETO
		    FROM REM01.GPV_GASTOS_PROVEEDOR GPV
		    JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
			AND GDE.BORRADO = 0
		    JOIN REM01.GLD_GASTOS_LINEA_DETALLE GLD ON GLD.GPV_ID = GPV.GPV_ID
			AND GLD.BORRADO = 0
		    JOIN REM01.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = GPV.PRO_ID
			AND PRO.BORRADO = 0
		    JOIN REM01.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = PRO.DD_CRA_ID
			AND CRA.BORRADO = 0
		    JOIN REM01.DD_EGA_ESTADOS_GASTO EGA ON EGA.DD_EGA_ID = GPV.DD_EGA_ID
			AND EGA.BORRADO = 0
		    WHERE GPV.BORRADO = 0
			AND EGA.DD_EGA_CODIGO IN (''01'', ''02'', ''07'', ''08'', ''10'', ''11'', ''12'')
			AND GDE.GDE_IRPF_BASE IS NULL
			AND NVL(GDE.GDE_IRPF_CUOTA, 0) <> 0
			AND NVL(GDE.GDE_IRPF_TIPO_IMPOSITIVO, 0) <> 0
			AND GPV.GPV_FECHA_EMISION >= TO_DATE(''01012018'',''DDMMYYYY'')
		    GROUP BY GLD.GPV_ID, GDE.GDE_IRPF_CUOTA, EGA.DD_EGA_CODIGO, GDE.GDE_IRPF_BASE
			, GDE.GDE_IRPF_TIPO_IMPOSITIVO, GPV.GPV_FECHA_EMISION
		) T2
		ON (T1.GPV_ID = T2.GPV_ID)
		WHEN MATCHED THEN
		    UPDATE SET T1.GDE_IRPF_BASE = T2.SUJETO,
		    T1.USUARIOMODIFICAR = '''||V_USUARIO||''',
		    T1.FECHAMODIFICAR = SYSDATE
		WHERE T1.GDE_IRPF_CUOTA = T2.IRPF_SUJETO';
		
	EXECUTE IMMEDIATE V_SQL;
		
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado correctamente '||SQL%ROWCOUNT||' registros');   
	
	 DBMS_OUTPUT.PUT_LINE('[IRPF_NO_SUJETO] ');

	V_SQL := 'MERGE INTO REM01.GDE_GASTOS_DETALLE_ECONOMICO T1
			USING (
			    SELECT GLD.GPV_ID, GDE.GDE_IRPF_CUOTA
				, ROUND(SUM(NVL(GLD.GLD_PRINCIPAL_SUJETO, 0)), 2) SUJETO
				, ROUND(SUM(NVL(GLD.GLD_PRINCIPAL_NO_SUJETO, 0) + NVL(GLD.GLD_RECARGO, 0) + NVL(GLD.GLD_COSTAS, 0) + NVL(GLD.GLD_INTERES_DEMORA, 0) + NVL(GLD.GLD_PROV_SUPLIDOS, 0) + NVL(GLD.GLD_OTROS_INCREMENTOS, 0)), 2) NO_SUJETO
				, ROUND(SUM(NVL(GLD.GLD_PRINCIPAL_SUJETO, 0)) * GDE.GDE_IRPF_TIPO_IMPOSITIVO / 100, 2) IRPF_SUJETO
				, ROUND(SUM(NVL(GLD.GLD_PRINCIPAL_NO_SUJETO, 0) + NVL(GLD.GLD_RECARGO, 0) + NVL(GLD.GLD_COSTAS, 0) + NVL(GLD.GLD_INTERES_DEMORA, 0) + NVL(GLD.GLD_PROV_SUPLIDOS, 0) + NVL(GLD.GLD_OTROS_INCREMENTOS, 0)) * GDE.GDE_IRPF_TIPO_IMPOSITIVO / 100, 2) IRPF_NO_SUJETO
			    FROM REM01.GPV_GASTOS_PROVEEDOR GPV
			    JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
				AND GDE.BORRADO = 0
			    JOIN REM01.GLD_GASTOS_LINEA_DETALLE GLD ON GLD.GPV_ID = GPV.GPV_ID
				AND GLD.BORRADO = 0
			    JOIN REM01.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = GPV.PRO_ID
				AND PRO.BORRADO = 0
			    JOIN REM01.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = PRO.DD_CRA_ID
				AND CRA.BORRADO = 0
			    JOIN REM01.DD_EGA_ESTADOS_GASTO EGA ON EGA.DD_EGA_ID = GPV.DD_EGA_ID
				AND EGA.BORRADO = 0
			    WHERE GPV.BORRADO = 0
				AND EGA.DD_EGA_CODIGO IN (''01'', ''02'', ''07'', ''08'', ''10'', ''11'', ''12'')
				AND GDE.GDE_IRPF_BASE IS NULL
				AND NVL(GDE.GDE_IRPF_CUOTA, 0) <> 0
				AND NVL(GDE.GDE_IRPF_TIPO_IMPOSITIVO, 0) <> 0
				AND GPV.GPV_FECHA_EMISION >= TO_DATE(''01012018'',''DDMMYYYY'')
			    GROUP BY GLD.GPV_ID, GDE.GDE_IRPF_CUOTA, EGA.DD_EGA_CODIGO, GDE.GDE_IRPF_BASE
				, GDE.GDE_IRPF_TIPO_IMPOSITIVO, GPV.GPV_FECHA_EMISION
			) T2
			ON (T1.GPV_ID = T2.GPV_ID)
			WHEN MATCHED THEN
			    UPDATE SET T1.GDE_IRPF_BASE = T2.NO_SUJETO,
		   	    T1.USUARIOMODIFICAR = '''||V_USUARIO||''',
		    	    T1.FECHAMODIFICAR = SYSDATE
			WHERE T1.GDE_IRPF_CUOTA = T2.IRPF_NO_SUJETO';
			
	EXECUTE IMMEDIATE V_SQL;
		
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado correctamente '||SQL%ROWCOUNT||' registros');   
	
	 DBMS_OUTPUT.PUT_LINE('[DISTINTO DE IRPF_SUJETO O IRPF_NO_SUJETO] ');

	V_SQL := 'MERGE INTO REM01.GDE_GASTOS_DETALLE_ECONOMICO T1
			USING (
			    SELECT GLD.GPV_ID, GDE.GDE_IRPF_CUOTA
				, ROUND(SUM(NVL(GLD.GLD_PRINCIPAL_SUJETO, 0)), 2) SUJETO
				, ROUND(SUM(NVL(GLD.GLD_PRINCIPAL_NO_SUJETO, 0) + NVL(GLD.GLD_RECARGO, 0) + NVL(GLD.GLD_COSTAS, 0) + NVL(GLD.GLD_INTERES_DEMORA, 0) + NVL(GLD.GLD_PROV_SUPLIDOS, 0) + NVL(GLD.GLD_OTROS_INCREMENTOS, 0)), 2) NO_SUJETO
				, ROUND(SUM(NVL(GLD.GLD_PRINCIPAL_SUJETO, 0)) * GDE.GDE_IRPF_TIPO_IMPOSITIVO / 100, 2) IRPF_SUJETO
				, ROUND(SUM(NVL(GLD.GLD_PRINCIPAL_NO_SUJETO, 0) + NVL(GLD.GLD_RECARGO, 0) + NVL(GLD.GLD_COSTAS, 0) + NVL(GLD.GLD_INTERES_DEMORA, 0) + NVL(GLD.GLD_PROV_SUPLIDOS, 0) + NVL(GLD.GLD_OTROS_INCREMENTOS, 0)) * GDE.GDE_IRPF_TIPO_IMPOSITIVO / 100, 2) IRPF_NO_SUJETO
			    FROM REM01.GPV_GASTOS_PROVEEDOR GPV
			    JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
				AND GDE.BORRADO = 0
			    JOIN REM01.GLD_GASTOS_LINEA_DETALLE GLD ON GLD.GPV_ID = GPV.GPV_ID
				AND GLD.BORRADO = 0
			    JOIN REM01.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = GPV.PRO_ID
				AND PRO.BORRADO = 0
			    JOIN REM01.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = PRO.DD_CRA_ID
				AND CRA.BORRADO = 0
			    JOIN REM01.DD_EGA_ESTADOS_GASTO EGA ON EGA.DD_EGA_ID = GPV.DD_EGA_ID
				AND EGA.BORRADO = 0
			    WHERE GPV.BORRADO = 0
				AND EGA.DD_EGA_CODIGO IN (''01'', ''02'', ''07'', ''08'', ''10'', ''11'', ''12'')
				AND GDE.GDE_IRPF_BASE IS NULL
				AND NVL(GDE.GDE_IRPF_CUOTA, 0) <> 0
				AND NVL(GDE.GDE_IRPF_TIPO_IMPOSITIVO, 0) <> 0
				AND GPV.GPV_FECHA_EMISION >= TO_DATE(''01012018'',''DDMMYYYY'')
			    GROUP BY GLD.GPV_ID, GDE.GDE_IRPF_CUOTA, EGA.DD_EGA_CODIGO, GDE.GDE_IRPF_BASE
				, GDE.GDE_IRPF_TIPO_IMPOSITIVO, GPV.GPV_FECHA_EMISION
			) T2
			ON (T1.GPV_ID = T2.GPV_ID)
			WHEN MATCHED THEN
			    UPDATE SET T1.GDE_IRPF_BASE = T2.SUJETO,
		   	    T1.USUARIOMODIFICAR = '''||V_USUARIO||''',
		    	    T1.FECHAMODIFICAR = SYSDATE
			WHERE T1.GDE_IRPF_CUOTA <> T2.IRPF_NO_SUJETO AND T1.GDE_IRPF_CUOTA <> T2.IRPF_SUJETO';

	EXECUTE IMMEDIATE V_SQL;
		
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado correctamente '||SQL%ROWCOUNT||' registros');   
	
    COMMIT;

    DBMS_OUTPUT.PUT_LINE('[FIN]');
   

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;
/
EXIT
