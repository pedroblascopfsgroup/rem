--/*
--###########################################
--## AUTOR=DAP
--## FECHA_CREACION=20210129
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=HREOS-00000
--## PRODUCTO=NO
--## 
--## Finalidad: Rellenar cuentas y partidas de un gasto o varios
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE

	V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
	ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
	V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
	V_USUARIO VARCHAR2(100 CHAR) := 'HREOS-00000';
  
BEGIN	
	
	TRUNCATE TABLE REM01.APR_AUX_GES_CC_PP_GR;

	INSERT INTO REM01.APR_AUX_GES_CC_PP_GR
	WITH SCR AS (
	    SELECT GEN.GLD_ID, ACT.DD_SCR_ID, ROW_NUMBER() OVER(PARTITION BY GEN.GLD_ID ORDER BY 1) RN
	    FROM REM01.GLD_ENT GEN
	    JOIN REM01.DD_ENT_ENTIDAD_GASTO ENT ON ENT.DD_ENT_ID = GEN.DD_ENT_ID
		AND ENT.BORRADO = 0
	    JOIN REM01.ACT_ACTIVO ACT ON ACT.ACT_ID = GEN.ENT_ID
		AND ACT.BORRADO = 0
	    WHERE GEN.BORRADO = 0
		AND ENT.DD_ENT_CODIGO = 'ACT'
	)
	, TBE AS (
	    SELECT GEN.GLD_ID, ILB.DD_TBE_ID, ROW_NUMBER() OVER(PARTITION BY GEN.GLD_ID ORDER BY 1) RN
	    FROM REM01.ACT_ILB_NFO_LIBERBANK ILB
	    JOIN REM01.GLD_ENT GEN ON GEN.ENT_ID = ILB.ACT_ID
		AND GEN.BORRADO = 0
	    JOIN REM01.DD_ENT_ENTIDAD_GASTO ENT ON ENT.DD_ENT_ID = GEN.DD_ENT_ID
		AND ENT.BORRADO = 0
	    WHERE ENT.DD_ENT_CODIGO = 'ACT'
		AND ILB.DD_TBE_ID IS NOT NULL
	)
	, ARRENDADO_VENDIDO AS (
	    SELECT GEN.GLD_ID, SCM.DD_SCM_CODIGO
	    FROM REM01.GLD_ENT GEN
	    JOIN REM01.DD_ENT_ENTIDAD_GASTO ENT ON ENT.DD_ENT_ID = GEN.DD_ENT_ID
		AND ENT.BORRADO = 0
	    JOIN REM01.ACT_ACTIVO ACT ON ACT.ACT_ID = GEN.ENT_ID
		AND ACT.BORRADO = 0
	    JOIN REM01.DD_SCM_SITUACION_COMERCIAL SCM ON SCM.DD_SCM_ID = ACT.DD_SCM_ID
		AND SCM.BORRADO = 0
	    WHERE GEN.BORRADO = 0
		AND ENT.DD_ENT_CODIGO = 'ACT'
	    GROUP BY GEN.GLD_ID, SCM.DD_SCM_CODIGO
	    HAVING COUNT(1) = 1
	)
	SELECT GLD.GLD_ID
	    , GPV.DD_TGA_ID
	    , GLD.DD_STG_ID
	    , CASE 
		WHEN NVL(GLD.GLD_PRINCIPAL_NO_SUJETO, 0) <> 0 
		    THEN 1 
		WHEN NVL(GLD.GLD_IMPORTE_TOTAL, 0) <> 0
		    THEN 1
		    ELSE 0 
		END TIM_BASE
	    , CASE WHEN NVL(GLD.GLD_RECARGO, 0) <> 0 THEN 1 ELSE 0 END TIM_RECARGO
	    , CASE WHEN NVL(GLD.GLD_INTERES_DEMORA, 0) <> 0 THEN 1 ELSE 0 END TIM_INTERESES
	    , CASE WHEN NVL(GLD.GLD_COSTAS, 0) <> 0 THEN 1 ELSE 0 END TIM_TASAS
	    , CRA.DD_CRA_ID
	    , SCR.DD_SCR_ID
	    , GPV.PRO_ID
	    , GIC.EJE_ID
	    , NVL2(ARR.GLD_ID, 1, 0) ARRENDADO
	    , NVL(GDE.GDE_GASTO_REFACTURABLE, 0) REFACTURABLE
	    , TBE.DD_TBE_ID
	    , NVL(GIC.GIC_ACTIVABLE, 0) ACTIVABLE
	    , NVL(GIC.GIC_PLAN_VISITAS, 0) PLAN_VISITAS
	    , GIC.DD_TCH_ID
	    , TRT.DD_TRT_ID
	    , NVL2(VEN.GLD_ID, 1, 0) VENDIDO
	FROM REM01.GPV_GASTOS_PROVEEDOR GPV
	JOIN REM01.DD_GRF_GESTORIA_RECEP_FICH GRF ON GRF.DD_GRF_ID = GPV.DD_GRF_ID
	    AND GRF.BORRADO = 0
	JOIN REM01.GLD_GASTOS_LINEA_DETALLE GLD ON GLD.GPV_ID = GPV.GPV_ID
	    AND GLD.BORRADO = 0
	JOIN REM01.GDE_GASTOS_DETALLE_ECONOMICO GDE ON GDE.GPV_ID = GPV.GPV_ID
	    AND GDE.BORRADO = 0
	JOIN REM01.GIC_GASTOS_INFO_CONTABILIDAD GIC ON GIC.GPV_ID = GPV.GPV_ID
	    AND GIC.BORRADO = 0
	JOIN REM01.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID = GPV.PRO_ID
	    AND PRO.BORRADO = 0
	JOIN REM01.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = PRO.DD_CRA_ID
	    AND CRA.BORRADO = 0
	LEFT JOIN REM01.DD_TRT_TRIBUTOS_A_TERCEROS TRT ON TRT.DD_TRT_ID = GIC.DD_TRT_ID
	    AND TRT.BORRADO = 0
	LEFT JOIN SCR ON SCR.GLD_ID = GLD.GLD_ID
	    AND SCR.RN = 1
	LEFT JOIN TBE ON TBE.GLD_ID = GLD.GLD_ID
	    AND TBE.RN = 1
	LEFT JOIN ARRENDADO_VENDIDO VEN ON VEN.GLD_ID = GLD.GLD_ID
	    AND VEN.DD_SCM_CODIGO = '05'
	LEFT JOIN ARRENDADO_VENDIDO ARR ON ARR.GLD_ID = GLD.GLD_ID
	    AND ARR.DD_SCM_CODIGO = '10'
	WHERE GPV.BORRADO = 0
	    AND TRUNC(GPV.FECHACREAR) = TRUNC(SYSDATE);

	TRUNCATE TABLE REM01.APR_AUX_GES_CC_PP_GR_2;

	INSERT INTO REM01.APR_AUX_GES_CC_PP_GR_2 (GLD_ID, DD_TIM_CODIGO, CCC_CUENTA_CONTABLE, CCC_SUBCUENTA_CONTABLE)
	WITH CALCULO_CUENTAS AS (
	    SELECT AUX.GLD_ID, TIM.DD_TIM_CODIGO
		, CCC.CCC_CUENTA_CONTABLE, CCC.CCC_SUBCUENTA_CONTABLE
		, DENSE_RANK() OVER(
		    PARTITION BY AUX.GLD_ID, NVL(TIM.DD_TIM_CODIGO, 'BAS')
		    ORDER BY NVL2(CCC.DD_SCR_ID, 1, 0) 
		            + NVL2(CCC.PRO_ID, 1, 0) 
		            + NVL2(CCC.DD_TBE_ID, 1, 0)
		            + NVL2(CCC.DD_TCH_ID, 1, 0)
		            + NVL2(CCC.DD_TRT_ID, 1, 0) DESC
		        , CCC.CCC_PRINCIPAL DESC) RN
	    FROM REM01.APR_AUX_GES_CC_PP_GR AUX
	    JOIN REM01.ACT_CONFIG_CTAS_CONTABLES CCC ON (AUX.DD_TGA_ID = CCC.DD_TGA_ID
		AND AUX.DD_STG_ID = CCC.DD_STG_ID
		AND AUX.DD_CRA_ID = CCC.DD_CRA_ID
		AND AUX.EJE_ID = CCC.EJE_ID
		AND AUX.ARRENDADO = CCC.CCC_ARRENDAMIENTO
		AND AUX.REFACTURABLE = CCC.CCC_REFACTURABLE
		AND AUX.VENDIDO = CCC.CCC_VENDIDO
		AND AUX.ACTIVABLE = CCC.CCC_ACTIVABLE
		AND AUX.PLAN_VISITAS = CCC.CCC_PLAN_VISITAS
		AND AUX.DD_SCR_ID = NVL(CCC.DD_SCR_ID, AUX.DD_SCR_ID)
		AND AUX.PRO_ID = NVL(CCC.PRO_ID, AUX.PRO_ID)
		AND NVL(AUX.DD_TBE_ID, 0) = NVL(CCC.DD_TBE_ID, NVL(AUX.DD_TBE_ID, 0))
		AND NVL(AUX.DD_TCH_ID, 0) = NVL(CCC.DD_TCH_ID, NVL(AUX.DD_TCH_ID, 0))
		AND NVL(AUX.DD_TRT_ID, 0) = NVL(CCC.DD_TRT_ID, NVL(AUX.DD_TRT_ID, 0))
		AND CCC.BORRADO = 0)
	    JOIN REM01.DD_TIM_TIPO_IMPORTE TIM ON TIM.DD_TIM_ID = NVL(CCC.DD_TIM_ID, TIM.DD_TIM_ID)
		AND TIM.BORRADO = 0
	)
	, CCC_OK AS (
	    SELECT GLD_ID, DD_TIM_CODIGO
	    FROM CALCULO_CUENTAS
	    WHERE RN = 1
	    GROUP BY GLD_ID, DD_TIM_CODIGO
	    HAVING COUNT(1) = 1
	)
	SELECT CCC.GLD_ID, CCC.DD_TIM_CODIGO, CCC.CCC_CUENTA_CONTABLE
	    , CCC.CCC_SUBCUENTA_CONTABLE
	FROM CALCULO_CUENTAS CCC
	JOIN CCC_OK DUP ON DUP.GLD_ID = CCC.GLD_ID
	    AND DUP.DD_TIM_CODIGO = CCC.DD_TIM_CODIGO
	WHERE CCC.RN = 1;

	MERGE INTO REM01.APR_AUX_GES_CC_PP_GR_2 T1
	USING (
	    WITH CALCULO_PARTIDAS AS (
		SELECT AUX.GLD_ID, TIM.DD_TIM_CODIGO
		    , CPP.CPP_PARTIDA_PRESUPUESTARIA, CPP.CPP_APARTADO, CPP.CPP_CAPITULO
		    , DENSE_RANK() OVER(
		        PARTITION BY AUX.GLD_ID, NVL(TIM.DD_TIM_CODIGO, 'BAS')
		        ORDER BY NVL2(CPP.DD_SCR_ID, 1, 0) 
		                + NVL2(CPP.PRO_ID, 1, 0) 
		                + NVL2(CPP.DD_TBE_ID, 1, 0)
		                + NVL2(CPP.DD_TCH_ID, 1, 0)
		                + NVL2(CPP.DD_TRT_ID, 1, 0) DESC
		            , CPP.CPP_PRINCIPAL DESC) RN
		FROM REM01.APR_AUX_GES_CC_PP_GR AUX
		JOIN REM01.ACT_CONFIG_PTDAS_PREP CPP ON (AUX.DD_TGA_ID = CPP.DD_TGA_ID
		    AND AUX.DD_STG_ID = CPP.DD_STG_ID
		    AND AUX.DD_CRA_ID = CPP.DD_CRA_ID
		    AND AUX.EJE_ID = CPP.EJE_ID
		    AND AUX.ARRENDADO = CPP.CPP_ARRENDAMIENTO
		    AND AUX.REFACTURABLE = CPP.CPP_REFACTURABLE
		    AND AUX.VENDIDO = CPP.CPP_VENDIDO
		    AND AUX.ACTIVABLE = CPP.CPP_ACTIVABLE
		    AND AUX.PLAN_VISITAS = CPP.CPP_PLAN_VISITAS
		    AND AUX.DD_SCR_ID = NVL(CPP.DD_SCR_ID, AUX.DD_SCR_ID)
		    AND AUX.PRO_ID = NVL(CPP.PRO_ID, AUX.PRO_ID)
		    AND NVL(AUX.DD_TBE_ID, 0) = NVL(CPP.DD_TBE_ID, NVL(AUX.DD_TBE_ID, 0))
		    AND NVL(AUX.DD_TCH_ID, 0) = NVL(CPP.DD_TCH_ID, NVL(AUX.DD_TCH_ID, 0))
		    AND NVL(AUX.DD_TRT_ID, 0) = NVL(CPP.DD_TRT_ID, NVL(AUX.DD_TRT_ID, 0))
		    AND CPP.BORRADO = 0)
		JOIN REM01.DD_TIM_TIPO_IMPORTE TIM ON TIM.DD_TIM_ID = NVL(CPP.DD_TIM_ID, TIM.DD_TIM_ID)
		    AND TIM.BORRADO = 0
	    )
	    , CPP_OK AS (
		SELECT GLD_ID, DD_TIM_CODIGO
		FROM CALCULO_PARTIDAS
		WHERE RN = 1
		GROUP BY GLD_ID, DD_TIM_CODIGO
		HAVING COUNT(1) = 1
	    )
	    SELECT CPP.GLD_ID, CPP.DD_TIM_CODIGO, CPP.CPP_PARTIDA_PRESUPUESTARIA
		, CPP.CPP_APARTADO, CPP.CPP_CAPITULO
	    FROM CALCULO_PARTIDAS CPP
	    JOIN CPP_OK DUP ON DUP.GLD_ID = CPP.GLD_ID
		AND DUP.DD_TIM_CODIGO = CPP.DD_TIM_CODIGO
	    WHERE CPP.RN = 1
	) T2
	ON (T1.GLD_ID = T2.GLD_ID AND T1.DD_TIM_CODIGO = T2.DD_TIM_CODIGO)
	WHEN MATCHED THEN
	    UPDATE SET
		T1.CPP_PARTIDA_PRESUPUESTARIA = T2.CPP_PARTIDA_PRESUPUESTARIA
		, T1.CPP_APARTADO = T2.CPP_APARTADO
		, T1.CPP_CAPITULO = T2.CPP_CAPITULO
	WHEN NOT MATCHED THEN
	    INSERT (T1.GLD_ID, T1.DD_TIM_CODIGO, T1.CPP_PARTIDA_PRESUPUESTARIA
		, T1.CPP_APARTADO, T1.CPP_CAPITULO)
	    VALUES (T2.GLD_ID, T2.DD_TIM_CODIGO, T2.CPP_PARTIDA_PRESUPUESTARIA
		, T2.CPP_APARTADO, T2.CPP_CAPITULO);

	COMMIT;

	MERGE INTO REM01.GLD_GASTOS_LINEA_DETALLE T1
	USING (
	    SELECT GLD_ID, CCC_CUENTA_CONTABLE, CPP_PARTIDA_PRESUPUESTARIA
		, CCC_SUBCUENTA_CONTABLE, CPP_APARTADO, CPP_CAPITULO
	    FROM REM01.APR_AUX_GES_CC_PP_GR_2
	    WHERE DD_TIM_CODIGO = 'INT'
	) T2
	ON (T1.GLD_ID = T2.GLD_ID)
	WHEN MATCHED THEN
	    UPDATE SET
			T1.GLD_CCC_INTERESES = T2.CCC_CUENTA_CONTABLE
			, T1.GLD_CPP_INTERESES = T2.CPP_PARTIDA_PRESUPUESTARIA
			, T1.GLD_SUBCUENTA_INTERESES = T2.CCC_SUBCUENTA_CONTABLE
			, T1.GLD_APARTADO_INTERESES = T2.CPP_APARTADO
			, T1.GLD_CAPITULO_INTERESES = T2.CPP_CAPITULO
			, T1.USUARIOMODIFICAR = 'apr_main_gr_gastos_gestoria'
			, T1.FECHAMODIFICAR = SYSDATE
	WHERE NVL(T1.GLD_CCC_BASE, 0) = 0
		AND NVL(T1.GLD_CPP_BASE, 0) = 0
		AND T1.GLD_SUBCUENTA_BASE IS NULL
		AND T1.GLD_APARTADO_BASE IS NULL
		AND T1.GLD_CAPITULO_BASE IS NULL;

	COMMIT;

EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT
