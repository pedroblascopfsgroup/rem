--/*
--#########################################
--## AUTOR=Viorel Remus Ovidiu
--## FECHA_CREACION=20210218
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-8995
--## PRODUCTO=NO
--## 
--## Finalidad: Actualizar precio cliente trabajo
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
ALTER SESSION SET NLS_NUMERIC_CHARACTERS = ',.';
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 

DECLARE


    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar   
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master 
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-8995'; --Vble USUARIOMODIFICAR/USUARIOCREAR

    V_ID NUMBER(16); -- Vble. para el id del activo

    V_ID_PROVEEDOR NUMBER(16); -- Vble. para el id del proveedor

    V_TABLA VARCHAR2(50 CHAR):= 'ACT_TBJ_TRABAJO'; --Vble. Tabla a modificar proveedores
   

	V_COUNT NUMBER(16); -- Vble. para comprobar
    
    
	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(32000 CHAR);
    	TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    	V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
        T_TIPO_DATA('9000183984','29,45','33,8675'),
T_TIPO_DATA('9000135752','432','496,8'),
T_TIPO_DATA('9000138514','1900','2185'),
T_TIPO_DATA('9000116790','29,45','33,8675'),
T_TIPO_DATA('9000130481','382,5','439,875'),
T_TIPO_DATA('916964371254','196,87','226,4005'),
T_TIPO_DATA('916964371057','264,73','304,4395'),
T_TIPO_DATA('916964372309','29,45','33,8675'),
T_TIPO_DATA('916964325373','1802,41','2072,7715'),
T_TIPO_DATA('916964323080','272,76','313,674'),
T_TIPO_DATA('916964314895','476,69','548,1935'),
T_TIPO_DATA('916964301885','5405,1','6215,865'),
T_TIPO_DATA('9000303832','240,1','276,115'),
T_TIPO_DATA('9000273067','29,45','33,8675'),
T_TIPO_DATA('9000272905','1488,33','1711,5795'),
T_TIPO_DATA('9000265577','308,41','354,6715'),
T_TIPO_DATA('9000241389','177,15','203,7225'),
T_TIPO_DATA('9000233412','350','402,5'),
T_TIPO_DATA('9000210245','29,45','33,8675'),
T_TIPO_DATA('9000216983','249','286,35'),
T_TIPO_DATA('9000223609','29,45','33,8675'),
T_TIPO_DATA('9000222202','88,35','101,6025'),
T_TIPO_DATA('9000233745','310,49','357,0635'),
T_TIPO_DATA('9000222575','29,26','33,649'),
T_TIPO_DATA('9000137754','180','207'),
T_TIPO_DATA('9000169066','29,45','33,8675'),
T_TIPO_DATA('9000169462','1308,52','1504,798'),
T_TIPO_DATA('9000142581','221','254,15'),
T_TIPO_DATA('9000130893','113','129,95'),
T_TIPO_DATA('9000112832','383,68','441,232'),
T_TIPO_DATA('9000103244','247','284,05'),
T_TIPO_DATA('9000113829','173','198,95'),
T_TIPO_DATA('9000068393','789,82','908,293'),
T_TIPO_DATA('916964378424','248,17','285,3955'),
T_TIPO_DATA('916964378440','29,45','33,8675'),
T_TIPO_DATA('916964378464','71,81','82,5815'),
T_TIPO_DATA('916964378413','343,55','395,0825'),
T_TIPO_DATA('916964378461','95,38','109,687'),
T_TIPO_DATA('9000249691','29,45','33,8675'),
T_TIPO_DATA('916964338018','98,98','113,827'),
T_TIPO_DATA('9000180899','29,45','33,8675'),
T_TIPO_DATA('9000133308','201,4','231,61'),
T_TIPO_DATA('916964304120','364,59','419,2785'),
T_TIPO_DATA('9000116150','1858','2136,7'),
T_TIPO_DATA('916964303033','170,55','196,1325'),
T_TIPO_DATA('916964311117','706,86','812,889'),
T_TIPO_DATA('916950102359','660,08','759,092'),
T_TIPO_DATA('9000280925','37,9','43,585'),
T_TIPO_DATA('9000282131','1193,8','1372,87'),
T_TIPO_DATA('9000276273','2268,64','2608,936'),
T_TIPO_DATA('9000284850','574,52','660,698'),
T_TIPO_DATA('9000282234','379','435,85'),
T_TIPO_DATA('9000272893','885,12','1017,888'),
T_TIPO_DATA('9000259626','379','435,85'),
T_TIPO_DATA('9000281177','2067,53','2377,6595'),
T_TIPO_DATA('9000272901','250','287,5'),
T_TIPO_DATA('9000226164','220','253'),
T_TIPO_DATA('916964371832','400','460'),
T_TIPO_DATA('916964371205','360','414'),
T_TIPO_DATA('916964372497','540','621'),
T_TIPO_DATA('916964372468','400','460'),
T_TIPO_DATA('916964372500','540','621'),
T_TIPO_DATA('916964372480','400','460'),
T_TIPO_DATA('916964371707','540','621'),
T_TIPO_DATA('916964348342','360','414'),
T_TIPO_DATA('916964348341','360','414'),
T_TIPO_DATA('916964312051','360','414'),
T_TIPO_DATA('916964312034','360','414'),
T_TIPO_DATA('916964334657','360','414'),
T_TIPO_DATA('916964334656','360','414'),
T_TIPO_DATA('916964329936','150','172,5'),
T_TIPO_DATA('916964329959','202,5','232,875'),
T_TIPO_DATA('916964312043','360','414'),
T_TIPO_DATA('916964312024','360','414'),
T_TIPO_DATA('916964334658','360','414'),
T_TIPO_DATA('916964331827','309,78','356,247'),
T_TIPO_DATA('9000302759','56,85','65,3775'),
T_TIPO_DATA('9000278352','227,35','261,4525'),
T_TIPO_DATA('9000280474','439,2','505,08'),
T_TIPO_DATA('9000295550','300,17','345,1955'),
T_TIPO_DATA('9000284678','300','345'),
T_TIPO_DATA('9000286491','360','414'),
T_TIPO_DATA('9000278302','355,2','408,48'),
T_TIPO_DATA('9000250961','27','31,05'),
T_TIPO_DATA('916964326953','464,8','534,52'),
T_TIPO_DATA('9000305455','121,5','139,725')

    	); 
    	V_TMP_TIPO_DATA T_TIPO_DATA;


BEGIN
	DBMS_OUTPUT.PUT_LINE('[INICIO]');
    DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZAMOS PRECIO TRABAJO CLIENTE');
    
    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
            LOOP
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);

            --Comprobamos la existencia del trabajo
            V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_TBJ_TRABAJO WHERE TBJ_NUM_TRABAJO='||V_TMP_TIPO_DATA(1)||' ';
            EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;	

            IF V_COUNT = 1 THEN

   		 --Actualizamos IMPORTE
                    V_MSQL:= 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET
                    TBJ_IMPORTE_TOTAL='''||V_TMP_TIPO_DATA(3)||''',
                    USUARIOMODIFICAR = '''|| V_USUARIO ||''',
                    FECHAMODIFICAR = SYSDATE
                    WHERE TBJ_NUM_TRABAJO='||V_TMP_TIPO_DATA(1)||'';

                    EXECUTE IMMEDIATE V_MSQL;

                    DBMS_OUTPUT.PUT_LINE('[INFO]: TRABAJO '''||V_TMP_TIPO_DATA(1)||''' ACTUALIZADO');

            ELSE 
                DBMS_OUTPUT.PUT_LINE('[INFO] NO EXISTE EL TRABAJO '''||V_TMP_TIPO_DATA(1)||'''');
            END IF;

        END LOOP;

    COMMIT;

    DBMS_OUTPUT.PUT_LINE('[FIN]');
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
