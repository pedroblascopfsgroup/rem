--/*
--##########################################
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20210219
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-8991
--## PRODUCTO=NO
--## 
--## Finalidad: Actualización FECHA CONCRETA Y FECHA TOPE TRABAJOS
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
	V_MSQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
 	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
 	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-8991'; -- USUARIO CREAR/MODIFICAR
	V_COUNT NUMBER(16) := 0; -- Vble. para comprobar
	V_NUM NUMBER(16); -- Vble. para comprobar
	err_num NUMBER; -- Numero de errores
	err_msg VARCHAR2(2048); -- Mensaje de error

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(32000 CHAR);
    	TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    	V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
            T_TIPO_DATA('916964336337','28/09/2020'),
			T_TIPO_DATA('916964347123','27/10/2020'),
			T_TIPO_DATA('916964357530','23/11/2020'),
			T_TIPO_DATA('916964373303','30/12/2020'),
			T_TIPO_DATA('916964379446','21/01/2021'),
			T_TIPO_DATA('916964382737','29/01/2021'),
			T_TIPO_DATA('916964385731','06/02/2021'),
			T_TIPO_DATA('916964369334','20/12/2020'),
			T_TIPO_DATA('916964370815','23/12/2020'),
			T_TIPO_DATA('916964371118','24/12/2020'),
			T_TIPO_DATA('916964371527','24/12/2020'),
			T_TIPO_DATA('916964376295','11/01/2021'),
			T_TIPO_DATA('916964376483','12/01/2021'),
			T_TIPO_DATA('916964376753','12/01/2021'),
			T_TIPO_DATA('916964376215','11/01/2021'),
			T_TIPO_DATA('916964378423','19/01/2021'),
			T_TIPO_DATA('916964371119','24/12/2020'),
			T_TIPO_DATA('916964317873','24/07/2020'),
			T_TIPO_DATA('916964375276','06/01/2021'),
			T_TIPO_DATA('916964379366','21/01/2021'),
			T_TIPO_DATA('916964382731','29/01/2021'),
			T_TIPO_DATA('916964382732','29/01/2021'),
			T_TIPO_DATA('916964376855','13/01/2021'),
			T_TIPO_DATA('916964382734','29/01/2021'),
			T_TIPO_DATA('916964370300','22/12/2020'),
			T_TIPO_DATA('9000306772','10/04/2020'),
			T_TIPO_DATA('916964375858','07/01/2021'),
			T_TIPO_DATA('916964375859','07/01/2021'),
			T_TIPO_DATA('916964375855','07/01/2021'),
			T_TIPO_DATA('916964377741','18/01/2021'),
			T_TIPO_DATA('916964375856','07/01/2021'),
			T_TIPO_DATA('916964353185','12/11/2020'),
			T_TIPO_DATA('916964353307','12/11/2020'),
			T_TIPO_DATA('916964376225','11/01/2021'),
			T_TIPO_DATA('916964376226','11/01/2021'),
			T_TIPO_DATA('916964376260','11/01/2021'),
			T_TIPO_DATA('916964375000','05/01/2021'),
			T_TIPO_DATA('916964379397','21/01/2021'),
			T_TIPO_DATA('916964379406','21/01/2021'),
			T_TIPO_DATA('916964376633','12/01/2021'),
			T_TIPO_DATA('916964376299','11/01/2021'),
			T_TIPO_DATA('916964356149','19/11/2020'),
			T_TIPO_DATA('916964366728','10/12/2020'),
			T_TIPO_DATA('916964351283','05/11/2020'),
			T_TIPO_DATA('916964371363','24/12/2020'),
			T_TIPO_DATA('916964379073','21/01/2021'),
			T_TIPO_DATA('916964357575','23/11/2020'),
			T_TIPO_DATA('916964375289','06/01/2021'),
			T_TIPO_DATA('916964374424','04/01/2021'),
			T_TIPO_DATA('916964386948','09/02/2021'),
			T_TIPO_DATA('916964376462','12/01/2021'),
			T_TIPO_DATA('916964337305','30/09/2020'),
			T_TIPO_DATA('916964372076','28/12/2020'),
			T_TIPO_DATA('9000285577','04/02/2020')
    	); 
    	V_TMP_TIPO_DATA T_TIPO_DATA;
	
BEGIN
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');

	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
        LOOP
    	V_TMP_TIPO_DATA := V_TIPO_DATA(I);

		V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_TBJ_TRABAJO WHERE TBJ_NUM_TRABAJO = '||V_TMP_TIPO_DATA(1)||' AND BORRADO = 0';
		EXECUTE IMMEDIATE V_MSQL INTO V_NUM;

		IF V_NUM = 1 THEN

			V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_TBJ_TRABAJO SET
						TBJ_FECHA_HORA_CONCRETA = TO_TIMESTAMP(CONCAT('''||V_TMP_TIPO_DATA(2)||''', '' 08:00:00''), ''DD/MM/YYYY HH:MI:SS''),
						USUARIOMODIFICAR = '''||V_USUARIO||''',
						FECHAMODIFICAR = SYSDATE
						WHERE TBJ_NUM_TRABAJO = '||V_TMP_TIPO_DATA(1)||' AND BORRADO = 0';
			EXECUTE IMMEDIATE V_MSQL;

			V_COUNT := V_COUNT + 1;

		ELSE 

			DBMS_OUTPUT.PUT_LINE('[INFO] NO EXISTE EL TRABAJO  '||V_TMP_TIPO_DATA(1)||' O ESTA BORRADO');

		END IF;

	END LOOP;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] MODIFICADOS  '|| V_COUNT ||' REGISTROS EN ACT_TBJ_TRABAJO PONIENDO FECHA CONCRETA');

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN] ');
	
	EXCEPTION
	
	    WHEN OTHERS THEN
		DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
		DBMS_OUTPUT.PUT_LINE(SQLERRM);
		DBMS_OUTPUT.PUT_LINE(V_MSQL);
		ROLLBACK;
		RAISE;
END;
/
EXIT;