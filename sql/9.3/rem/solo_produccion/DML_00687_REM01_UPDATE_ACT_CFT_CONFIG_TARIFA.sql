--/*
--#########################################
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20210221
--## ARTEFACTO=Batch
--## VERSION_ARTEFACTO=3.0
--## INCIDENCIA_LINK=REMVIP-9049
--## PRODUCTO=NO
--## 
--## Finalidad: Actualizar tarifas.
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-9049';
    V_USUARIO_2 VARCHAR2(50 CHAR) := 'REMVIP-9049_2';

	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_SQL VARCHAR2(4000 CHAR);

    V_TABLE VARCHAR2(30 CHAR) := 'DD_TTF_TIPO_TARIFA';
    V_TABLE_2 VARCHAR2(30 CHAR) := 'ACT_CFT_CONFIG_TARIFA';
    V_NUM_TABLAS NUMBER(16);
	

    TYPE T_TARIFA IS TABLE OF VARCHAR2(1000);

    TYPE T_ARRAY_TARIFAS IS TABLE OF T_TARIFA;
    V_TARIFAS T_ARRAY_TARIFAS := T_ARRAY_TARIFAS(

		T_TARIFA('BBVA109','SUSTITUCIÓN DE BISAGRAS PUERTA DE PASO','03','123'),
        T_TARIFA('BBVA118','VALLADO CON SIMPLE TORSIÓN HASTA 2M DE ALTURA, INCLUSO POSTES DE SUJECIÓN CADA 3M. UNIDAD TOTALMENTE','03','VAL'),
        T_TARIFA('BBVA123','REPARACIÓN DE HUMEDADES EN FACHADA DE UNIFAMILIARES','03','125'),
        T_TARIFA('BBVA130','REPASO DE INSTALACIÓN ELÉCTRICA Y TELECOMUNICACIONES DE VIVIENDA NO INCLUIDA LA COLOCACIÓN DE LAS TA','03','126'),
        T_TARIFA('BBVA145','REVISIÓN DE LA INSTALACIÓN DE GAS DE VIVIENDA','03','124'),
        T_TARIFA('BBVA147','FÁBRICA DE LADRILLO DE 1/2 PIE. INCLUSO RECIBIDO DE PRECERCOS SI PROCEDE','03','125'),
        T_TARIFA('BBVA167','SUMINISTRO E INSTALACIÓN DE JUEGO DE TAPETAS GAMA MEDIA EN ACABADO LACADO BLANCO O EN MADERA BARNIZA','03','123'),
        T_TARIFA('BBVA172','LEVANTADO DE REVESTIMIENTOS LAMINADOS, MADERA O SIMILAR, INCLUSO ZÓCALO, CAPAS INFERIORES DE AISLAMI','03','125'),
        T_TARIFA('BBVA175','VALLADO COMPUESTO POR PANELES OPACOS DE CHAPA GALVANIZADO DE DE 2M DE ALTURA Y 0,6 MM ESPESOR, INCLU','03','VAL'),
        T_TARIFA('BBVA208','TRATAMIENTO DE PICUDO ROJO EN PALMERAS','03','60'),
        T_TARIFA('BBVA216','BLOQUEO DE ACCESOS','03','128'),
        T_TARIFA('BBVA217','TAPADO CON FÁBRICA DE LADRILLO O BLOQUE DE HORMIGÓN INCLUIDO ENFOSCADO','03','125'),
        T_TARIFA('BBVA222','SUMINISTRO DE COPIA DE LLAVE CONVENCIONAL','03','61'),
        T_TARIFA('BBVA224','SELLADO DE VIDRIO CON SILICONA O GOMAS','03','127'),
        T_TARIFA('BBVA268','EMISIÓN Y ADECUACIÓN BOLETÍN AGUA (SIN INCLUIR ADECUACIÓN)','03','22'),
        T_TARIFA('BBVA269','EMISIÓN Y ADECUACIÓN BOLETÍN LUZ (SIN INCLUIR ADECUACIÓN)','03','23'),
        T_TARIFA('BBVA270','EMISIÓN Y ADECUACIÓN BOLETÍN GAS (SIN INCLUIR ADECUACIÓN)','03','24'),
        T_TARIFA('BBVA271','OBTENCIÓN DUPLICADO DE BOLETINES AGUA','03','22'),
        T_TARIFA('BBVA275','VISITA INFRUCTUOSA','03','INT'),
        T_TARIFA('BBVA276','EXTRA CERRADURA GAMA BAJA','03','26'),
        T_TARIFA('BBVA280','INFORME OCUPACIONAL','03','62'),
        T_TARIFA('BBVA281','SOLICITUD DE PRESUPUESTO','03','INT'),
        T_TARIFA('BBVA282','INFORME DE LOCALIZACIÓN','03','14'),
        T_TARIFA('BBVA283','SUMINISTRO CARTEL VENTANA: AUTOADHESIVOS FLEXIBLES INTERIOR ( MEDIDAS 0,60 X 0,40 MTS )/ CARTEL VENT','03','72'),
        T_TARIFA('BBVA311','OBTENCION DE BOLETINES Y/O CERTIFICADO: PCI ( GARAJE )','03','25'),
        T_TARIFA('BBVA323','RETIRADA DE NIDOS (UD)','03','RAN'),
        T_TARIFA('BBVA367','COPIA JUEGO COMPLETO DE LLAVES','03','61'),
        T_TARIFA('BBVA379','CHAPA DE ACERO GALVANIZADO (M2)','03','125'),
        T_TARIFA('BBVA380','DESMONTAJE Y RETIRADA DE VENTANA ANTI-OKUPA (UD)','03','40'),
        T_TARIFA('BBVA063','SUMINISTRO E INSTALACIÓN DE HOJA DE PUERTA ABATIBLE INTERIOR DE HASTA 100 CMS GAMA MEDIA EN ACABADO','03','123'),
        T_TARIFA('BBVA215','INSTALACIÓN DE CEPO','03','120'),
        T_TARIFA('BBVA324','RETIRADA DE BUZÓN (UD)','03','28')

    );
    V_TMP_TARIFA T_TARIFA;


     TYPE T_TARIFA2 IS TABLE OF VARCHAR2(1000);

    TYPE T_ARRAY_TARIFAS2 IS TABLE OF T_TARIFA2;
    V_TARIFAS2 T_ARRAY_TARIFAS2 := T_ARRAY_TARIFAS2(

		T_TARIFA2('BBVA9100','03','125'),
        T_TARIFA2('BBVA9284','03','125'),
        T_TARIFA2('BBVA9292','02','14')

    );
    V_TMP_TARIFA2 T_TARIFA2;

BEGIN
DBMS_OUTPUT.PUT_LINE('[INICIO] Actualizacion en '||V_TABLE||' y '||V_TABLE_2||'');
    FOR I IN V_TARIFAS.FIRST .. V_TARIFAS.LAST
    LOOP
        V_TMP_TARIFA := V_TARIFAS(I);

        V_SQL :='SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLE||' WHERE DD_TTF_CODIGO='''||TRIM(V_TMP_TARIFA(1))||'''';
         EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;

        IF V_NUM_TABLAS = 1 THEN

            V_SQL := '
            UPDATE '||V_ESQUEMA||'.'||V_TABLE||'
            SET DD_TTF_DESCRIPCION = SUBSTR('''||TRIM(V_TMP_TARIFA(2))||''',0,100),
                DD_TTF_DESCRIPCION_LARGA='''||TRIM(V_TMP_TARIFA(2))||''',
                USUARIOMODIFICAR = '''||V_USUARIO||''',
                FECHAMODIFICAR = SYSDATE
            WHERE DD_TTF_CODIGO LIKE '''||TRIM(V_TMP_TARIFA(1))||'''       
        ';

        EXECUTE IMMEDIATE V_SQL;

         V_SQL := '
            UPDATE '||V_ESQUEMA||'.'||V_TABLE_2||'
            SET DD_TTR_ID = (SELECT DD_TTR_ID FROM '||V_ESQUEMA||'.DD_TTR_TIPO_TRABAJO WHERE DD_TTR_CODIGO = '''||TRIM(V_TMP_TARIFA(3))||''') , 
                DD_STR_ID = (SELECT DD_STR_ID FROM '||V_ESQUEMA||'.DD_STR_SUBTIPO_TRABAJO WHERE DD_STR_CODIGO = '''||TRIM(V_TMP_TARIFA(4))||''') ,
                USUARIOMODIFICAR = '''||V_USUARIO||''',
                FECHAMODIFICAR = SYSDATE
            WHERE DD_TTF_ID = (SELECT DD_TTF_ID FROM '||V_ESQUEMA||'.'||V_TABLE||' WHERE DD_TTF_CODIGO = '''||TRIM(V_TMP_TARIFA(1))||''')       
        ';

        EXECUTE IMMEDIATE V_SQL;
        DBMS_OUTPUT.PUT_LINE('[INFO] Tarifa '''||TRIM(V_TMP_TARIFA(1))||''' Actualizada correctamente ');
        ELSE
         DBMS_OUTPUT.PUT_LINE('[INFO] No existe la Tarifa con codigo '''||TRIM(V_TMP_TARIFA(1))||''' ');
        END IF;     

    END LOOP;


    DBMS_OUTPUT.PUT_LINE('[INFO] ###########################');
    DBMS_OUTPUT.PUT_LINE('[INFO] Actualizamos Tarifas aparte');
    DBMS_OUTPUT.PUT_LINE('[INFO] ###########################');

     FOR I IN V_TARIFAS2.FIRST .. V_TARIFAS2.LAST
    LOOP
        V_TMP_TARIFA2 := V_TARIFAS2(I);

             V_SQL :='SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLE||' WHERE DD_TTF_CODIGO='''||TRIM(V_TMP_TARIFA2(1))||'''';
         EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;

        IF V_NUM_TABLAS = 1 THEN

            V_SQL := '
            UPDATE '||V_ESQUEMA||'.'||V_TABLE_2||'
            SET DD_TTR_ID = (SELECT DD_TTR_ID FROM '||V_ESQUEMA||'.DD_TTR_TIPO_TRABAJO WHERE DD_TTR_CODIGO = '''||TRIM(V_TMP_TARIFA2(2))||''') , 
                DD_STR_ID = (SELECT DD_STR_ID FROM '||V_ESQUEMA||'.DD_STR_SUBTIPO_TRABAJO WHERE DD_STR_CODIGO = '''||TRIM(V_TMP_TARIFA2(3))||''') ,
                USUARIOMODIFICAR = '''||V_USUARIO_2||''',
                FECHAMODIFICAR = SYSDATE
            WHERE DD_TTF_ID = (SELECT DD_TTF_ID FROM '||V_ESQUEMA||'.'||V_TABLE||' WHERE DD_TTF_CODIGO = '''||TRIM(V_TMP_TARIFA2(1))||''')       
        ';

        EXECUTE IMMEDIATE V_SQL;
        DBMS_OUTPUT.PUT_LINE('[INFO] Tarifa '''||TRIM(V_TMP_TARIFA2(1))||''' Actualizada correctamente ');

        ELSE
        DBMS_OUTPUT.PUT_LINE('[INFO] No existe la Tarifa con codigo '''||TRIM(V_TMP_TARIFA2(1))||''' ');
        END IF;
    END LOOP;

	DBMS_OUTPUT.PUT_LINE('[FIN] Finalizado la modificacion de tarifas.');
	COMMIT;

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      DBMS_OUTPUT.PUT_LINE(V_SQL);
      ROLLBACK;
      RAISE;
END;
/
EXIT;