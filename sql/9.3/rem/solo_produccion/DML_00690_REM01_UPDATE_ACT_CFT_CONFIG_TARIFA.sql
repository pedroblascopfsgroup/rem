--/*
--#########################################
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20210224
--## ARTEFACTO=Batch
--## VERSION_ARTEFACTO=3.0
--## INCIDENCIA_LINK=REMVIP-9049
--## PRODUCTO=NO
--## 
--## Finalidad: Actualizar tarifas.
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-9049';

	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_SQL VARCHAR2(4000 CHAR);

    V_TABLE VARCHAR2(30 CHAR) := 'DD_TTF_TIPO_TARIFA';
    V_TABLE_2 VARCHAR2(30 CHAR) := 'ACT_CFT_CONFIG_TARIFA';
	

    TYPE T_TARIFA IS TABLE OF VARCHAR2(1000);

    TYPE T_ARRAY_TARIFAS IS TABLE OF T_TARIFA;
    V_TARIFAS T_ARRAY_TARIFAS := T_ARRAY_TARIFAS(

		T_TARIFA('BBVA276', 'VISITA INFRUCTUOSA', '03', 'INT'),
        T_TARIFA('BBVA281', 'INFORME OCUPACIONAL', '03', '62'),
        T_TARIFA('BBVA323', 'ACOMPAÑAMIENTO GENERAL', '03', 'ACO'),
        T_TARIFA('BBVA167', 'SUMINISTRO E INSTALACIÓN DE CANDADO, INCLUIDA CADENA HASTA 0,5M EN CASO NECESARIO Y DESCERRAJE DE CANDADO EXISTENTE SI FUERE NECESARIO', '03', '26'),
        T_TARIFA('BBVA123', 'EXTRA CONTENEDOR (6 M3) EN LIMPIEZA GENERAL DEL INMUEBLE: RETIRADA DE BASURAS, RESTOS DE COMIDA, ENSERES, MOBILIARIO, ESCOMBROS, ETC. GESTIÓN DE RESIDUOS INCLUIDA', '03', '30'),
        T_TARIFA('BBVA311', 'SERVICIO INFORME - CUESTIONARIO Y REPORTAJE FOTOGRÁFICO', '02', '14'),
        T_TARIFA('BBVA268', 'EXTRA CONTENEDOR (2M3) EN LIMPIEZA GENERAL DEL INMUEBLE: RETIRADA DE BASURAS, RESTOS DE COMIDA, ENSERES, MOBILIARIO, ESCOMBROS, ETC. GESTIÓN DE RESIDUOS INCLUIDA', '03', '30'),
        T_TARIFA('BBVA282', 'SOLICITUD DE PRESUPUESTO', '03', '38'),
        T_TARIFA('BBVA224', 'OBTENCIÓN LLAVES ZONAS COMUNES (COPIAS INCLUIDAS)', '03', '61'),
        T_TARIFA('BBVA109', 'SUSTITUCIÓN DE CERROJO (FAC, LINCE, EZCURRA O SIMILAR) INCLUYE APERTURA DE PUERTA, DESCERRAJE Y CERRADURA EN EL CASO DE SER NECESARIO.', '03', '26'),
        T_TARIFA('BBVA145', 'SUMINISTRO DE MANDO DE GARAJE CODIFICADO', '03', '61'),
        T_TARIFA('BBVA271', 'EMISIÓN Y ADECUACIÓN BOLETÍN GAS (SIN INCLUIR ADECUACIÓN)', '02', '24'),
        T_TARIFA('BBVA270', 'EMISIÓN Y ADECUACIÓN BOLETÍN LUZ (SIN INCLUIR ADECUACIÓN)', '02', '23'),
        T_TARIFA('BBVA269', 'EMISIÓN Y ADECUACIÓN BOLETÍN AGUA (SIN INCLUIR ADECUACIÓN)', '02', '22'),
        T_TARIFA('BBVA283', 'INFORME DE LOCALIZACIÓN', '02', '14'),
        T_TARIFA('BBVA147', 'SUMINISTRO E INSTALACIÓN DE PUERTA ANTIOCUPA HOMOLOGADA CUMPLIENDO NORMATIVA EUROPEA Y SUMINISTRADA IGUALMENTE POR FABRICANTE COMPETENTE PARA EMITIR SU CERTIFICADO DE IDONEIDAD', '03', '40'),
        T_TARIFA('BBVA275', 'OBTENCIÓN CEE', '02', '18'),
        T_TARIFA('BBVA222', 'DESTAPIADO DE CUALQUIER TIPO', '03', '125'),
        T_TARIFA('BBVA172', 'AJUSTE O REPARACIÓN DE HERRAJES/CIERRES DE CARPINTERÍA METÁLICA. VENTANA O PUERTA', '03', '123'),
        T_TARIFA('BBVA217', 'BLOQUEO DE ACCESOS', '03', '128'),
        T_TARIFA('BBVA367', 'CAMBIO DE BOMBÍN, CERRADURA CONVENCIONAL O CANDADO (UD)', '03', '26'),
        T_TARIFA('BBVA208', 'REPARACIÓN DE PERSIANA CONSISTENTE EN DESMONTAJE Y MONTAJE DE TAPA, COLOCACIÓN Y ALINEADO DE LAMAS, ENGRASADO DE POLEA, ETC. PARA EL CORRECTO FUNCIONAMIENTO DE LA MISMA.', '03', '123'),
        T_TARIFA('BBVA280', 'EXTRA CERRADURA GAMA SEGURIDAD', '03', '26'),
        T_TARIFA('BBVA380', 'CHAPA DE ACERO GALVANIZADO (M2)', '03', '110'),
        T_TARIFA('BBVA175', 'LIMPIEZA GENERAL DE PISCINA (INCLUIDO VACIADO)', '03', '29'),
        T_TARIFA('BBVA118', 'PODA, PUNTUAL Y SELECTIVA, MANUAL, CON TODOS LOS ÚTILES NECESARIOS. GESTIÓN DE RESIDUOS INCLUIDA', '03', '60'),
        T_TARIFA('BBVA216', 'INSTALACIÓN DE CEPO', '03', '120'),
        T_TARIFA('BBVA379', 'DEMOLICIÓN Y/O RETIRADA DE TAPADOS (M2)', '03', '64'),
        T_TARIFA('BBVA130', 'OBTENCIÓN/TRAMITACIÓN DE NUEVA CÉDULA DE HABITABILIDAD', '02', '20')

    );
    V_TMP_TARIFA T_TARIFA;

BEGIN

    FOR I IN V_TARIFAS.FIRST .. V_TARIFAS.LAST
    LOOP
        V_TMP_TARIFA := V_TARIFAS(I);

        V_SQL := '
            UPDATE '||V_ESQUEMA||'.'||V_TABLE||'
            SET DD_TTF_DESCRIPCION = SUBSTR('''||TRIM(V_TMP_TARIFA(2))||''',0,100),
                DD_TTF_DESCRIPCION_LARGA='''||TRIM(V_TMP_TARIFA(2))||''',
                USUARIOMODIFICAR = '''||V_USUARIO||''',
                FECHAMODIFICAR = SYSDATE
            WHERE DD_TTF_CODIGO LIKE '''||TRIM(V_TMP_TARIFA(1))||'''       
        ';

        EXECUTE IMMEDIATE V_SQL;


            V_SQL := '
            UPDATE '||V_ESQUEMA||'.'||V_TABLE_2||'
            SET DD_TTR_ID = (SELECT DD_TTR_ID FROM '||V_ESQUEMA||'.DD_TTR_TIPO_TRABAJO WHERE DD_TTR_CODIGO = '''||TRIM(V_TMP_TARIFA(3))||''') , 
                DD_STR_ID = (SELECT DD_STR_ID FROM '||V_ESQUEMA||'.DD_STR_SUBTIPO_TRABAJO WHERE DD_STR_CODIGO = '''||TRIM(V_TMP_TARIFA(4))||''') ,
                USUARIOMODIFICAR = '''||V_USUARIO||''',
                FECHAMODIFICAR = SYSDATE
            WHERE DD_TTF_ID = (SELECT DD_TTF_ID FROM '||V_ESQUEMA||'.'||V_TABLE||' WHERE DD_TTF_CODIGO = '''||TRIM(V_TMP_TARIFA(1))||''')       
        ';

        EXECUTE IMMEDIATE V_SQL;

    END LOOP;

	DBMS_OUTPUT.PUT_LINE('[FIN] Finalizado el proceso de inserción de gastos.');
	COMMIT;

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      DBMS_OUTPUT.PUT_LINE(V_SQL);
      ROLLBACK;
      RAISE;
END;
/
EXIT;