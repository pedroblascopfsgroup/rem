--/*
--##########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20210224
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9043
--## PRODUCTO=NO
--## 
--## Finalidad: Actualizaci贸n tabla 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versi贸n inicial
--#########################################
--*/

--Para permitir la visualizaci贸n de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_TEXT_TABLA VARCHAR2(2400 CHAR) := 'ACT_CAN_CALIFICACION_NEG'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_ID NUMBER(16);

    
BEGIN		
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');
	 	
               DBMS_OUTPUT.PUT_LINE('[INFO]: DESBORRAR REGISTROS');

       	  V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_CAN_CALIFICACION_NEG CAN USING(
				SELECT CAN.ACT_CAN_ID 
				FROM '||V_ESQUEMA||'.ACT_CAN_CALIFICACION_NEG CAN 
				JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = CAN.ACT_ID
				JOIN '||V_ESQUEMA||'.DD_CAN_CALIFICACION_NEG NEG ON NEG.DD_CAN_ID = CAN.DD_CAN_ID
				WHERE CAN.USUARIOCREAR = ''MIG_BBVA'' AND NEG.DD_CAN_CODIGO = ''02'' AND CAN.BORRADO = 1 AND CAN.USUARIOBORRAR = ''REMVIP-9024''
				) AUX ON (AUX.ACT_CAN_ID = CAN.ACT_CAN_ID)
			     WHEN MATCHED THEN UPDATE SET
		             CAN.BORRADO = 0,
			     CAN.USUARIOBORRAR = NULL,
			     CAN.FECHABORRAR = NULL,
			     CAN.USUARIOMODIFICAR = ''REMVIP-9043'',
			     CAN.FECHAMODIFICAR = SYSDATE';
					
          EXECUTE IMMEDIATE V_MSQL;           	
          DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZADOS  '|| SQL%ROWCOUNT ||' REGISTROS ');
          
               DBMS_OUTPUT.PUT_LINE('[INFO]: BORRAR REGISTROS');

       	  V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_CAN_CALIFICACION_NEG NEG USING(
				SELECT ACT_CAN_ID FROM (SELECT NEG.ACT_CAN_ID, ROW_NUMBER() OVER(
       						PARTITION BY TIT.TIT_ID
        						ORDER BY AHT.AHT_FECHA_CALIFICACION DESC 
    							) ROW_NUM FROM '||V_ESQUEMA||'.ACT_CAN_CALIFICACION_NEG NEG 
				JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = NEG.ACT_ID
				JOIN '||V_ESQUEMA||'.act_aht_hist_tram_titulo AHT ON AHT.AHT_ID = NEG.AHT_ID
				JOIN '||V_ESQUEMA||'.ACT_TIT_TITULO TIT ON TIT.TIT_ID = AHT.TIT_ID
				WHERE ACT.ACT_NUM_ACTIVO IN (7305014,7305213,7305427,7305814,7306351,7306378,7306555,7304374,7304384,7304394,7304403,7304490,7304954,7315907,7316173,7316402,7317427,7306576,7306579,7307499,7307515,7307520,7307522,7308017,7308037,7308066,7308075,7309157,7309877,7310627,7311449,7311618,7312220,7312305,7312786,7313028,7313320,7313460,7326527,7313777,7315139,7315173,7320428,7321706,7321708,7321713,7321714,7321730,7321749,7321873,7424093,7321908,7321922,7322016,7322018,7322021,7318300,7318825,7318945,7318971,7318972,7319268,7319562,7322345,7322901,7323424,7323434,7323437,7323462,7323480,7323581,7324282,7386686,7386695,7386700,7386710,7386713,7386718,7386726,7386730,7386734,7386737,7386741,7386755,7305314,7305803,7305848,7303669,7303821,7303857,7303938,7304054,7304313,7315392,7315900,7316168,7326824,7306581,7306644,7307503,7307509,7307524,7307536,7308081,7308740,7310361,7312294,7312302,7312307,7312493,7312907,7313303,7313322,7313724,7313968,7313972,7314749,7385752,7321002,7321009,7321700,7321702,7321710,7321737,7321738,7321748,7321753,7321774,7321841,7321845,7321860,7321924,7322020,7318106,7318122,7318860,7319877,7385625,7322196,7322477,7322492,7322645,7322869,7322976,7323418,7323430,7323438,7323440,7323441,7323449,7323460,7323471,7323481,7386684,7386691,7386701,7386717,7386723,7386733,7386739,7386757,7386760,7305139,7305163,7305166,7305714,7305727,7305737,7305984,7306030,7306240,7306267,7306489,7303923,7304571,7304957,7316353,7316454,7316767,7306827,7307496,7307497,7308038,7308061,7308068,7308079,7308083,7311734,7311863,7311943,7312221,7312330,7326228,7312651,7312878,7313098,7313235,7313408,7313668,7313799,7313969,7314144,7314240,7314710,7314748,7314750,7314827,7314853,7315172,7320253,7320430,7320431,7320984,7321716,7321724,7321729,7321736,7321741,7321745,7321839,7321844,7322017,7318075,7318706,7318949,7318958,7319267,7319275,7319302,7319309,7322193,7323419,7323439,7323443,7323448,7323457,7323472,7323477,7386690,7386696,7386716,7386719,7386724,7386735,7386743,7386744,7386750,7386762,7305161,7305170,7305234,7305271,7305335,7305520,7305523,7305822,7325787,7305907,7305939,7306282,7303614,7303637,7303933,7304211,7304767,7304933,7315176,7315178,7315415,7315552,7316166,7316400,7316453,7316977,7306575,7306577,7306578,7306828,7307504,7307511,7307518,7307523,7307533,7308062,7308063,7308065,7308070,7310703,7311845,7312301,7312567,7312822,7313085,7313168,7313269,7313773,7313774,7314143,7314798,7315174,7320267,7386367,7320421,7320528,7320810,7320815,7320834,7321698,7321704,7321711,7321728,7321739,7321740,7321746,7321747,7321752,7321911,7321936,7322019,7317606,7318092,7318241,7318946,7318950,7318952,7318953,7319477,7319923,7322347,7322369,7322384,7323127,7323429,7323451,7323453,7323468,7323479,7323580,7323582,7324973,7386680,7386693,7386694,7386699,7386708,7386711,7386712,7386715,7386720,7386722,7386727,7386728,7386745,7386748,7386751,7386753,7386754,7305040,7305202,7305863,7306229,7306249,7306385,7306497,7304375,7304575,7304591,7304621,7304797,7304956,7315175,7315177,7316177,7316284,7316457,7306571,7306713,7307246,7307505,7307507,7307512,7307513,7307516,7307519,7307535,7307983,7308040,7308073,7308076,7308082,7308134,7309502,7310994,7311600,7312185,7312303,7312315,7312589,7312661,7312983,7313048,7313060,7313078,7313157,7313489,7313520,7313749,7313783,7313814,7314316,7314940,7314991,7320088,7385639,7320419,7320426,7320429,7320500,7320792,7320852,7321695,7321696,7321701,7321703,7321712,7321720,7321727,7321731,7321734,7321735,7321840,7321843,7321920,7317574,7318091,7318935,7318955,7318962,7319297,7319373,7323425,7323431,7323433,7323446,7323455,7323456,7323467,7323469,7323474,7324281,7386681,7386685,7386698,7386749,7305162,7305280,7305413,7305545,7305802,7306074,7306131,7303748,7303761,7304254,7304421,7304489,7304859,7304958,7315975,7316401,7316458,7316488,7316489,7316505,7306574,7325866,7306676,7307521,7307525,7307528,7307531,7307532,7307537,7308072,7309029,7309829,7311679,7311898,7312299,7312304,7313045,7313144,7313413,7313517,7313642,7326611,7314145,7314253,7314325,7314483,7314495,7314885,7434369,7320770,7321709,7321715,7321718,7321721,7321723,7321742,7321743,7321819,7321842,7321938,7321951,7322015,7318826,7318951,7318956,7318957,7318959,7319133,7319581,7319594,7319941,7322371,7322479,7322868,7323216,7323272,7323423,7323427,7323428,7323444,7323450,7323454,7323461,7323463,7323475,7323476,7323478,7324949,7386682,7386687,7386692,7386704,7386742,7386752,7305039,7305169,7305612,7305742,7306048,7306056,7306268,7306512,7303638,7303681,7303790,7303806,7304048,7304676,7304775,7304955,7316482,7316490,7316503,7316504,7316515,7317196,7306580,7306809,7307245,7307500,7307501,7307506,7307510,7307514,7307526,7307529,7307530,7308036,7308041,7308060,7308067,7308071,7308074,7308080,7308621,7309824,7309825,7311567,7311846,7312300,7312329,7312376,7312392,7312768,7313071,7313179,7313276,7313351,7386368,7320351,7320989,7321699,7321744,7321750,7321751,7321754,7321846,7321861,7321917,7317468,7317469,7318970,7319273,7322382,7322909,7323421,7323432,7323435,7323447,7323459,7323465,7323466,7323473,7324950,7325257,7386688,7386689,7386702,7386703,7386706,7386709,7386721,7386725,7386729,7386732,7386736,7386740,7386747,7386756,7386761,7305012,7305066,7305118,7305130,7305165,7305261,7305272,7305367,7305445,7305598,7305771,7305813,7305844,7305859,7306040,7306075,7306570,7303847,7304126,7304164,7304193,7304437,7304574,7325635,7304943,7326792,7326795,7316167,7316399,7316480,7316481,7317077,7317130,7306572,7306573,7306582,7307498,7307502,7307508,7307517,7307527,7307534,7308053,7308064,7311346,7312207,7312257,7312295,7312306,7312932,7313058,7313158,7313160,7313400,7313409,7313824,7314090,7314890,7320154,7320501,7320988,7321697,7321705,7321707,7321717,7321719,7321722,7321725,7321726,7321732,7321733,7321755,7321838,7321919,7318657,7318947,7318948,7318954,7318960,7318961,7319221,7319232,7319670,7322381,7322473,7322731,7322870,7322966,7323212,7323223,7323420,7323422,7323436,7323442,7323445,7323452,7323458,7323464,7323470,7323583,7324957,7325122,7325235,7386683,7386697,7386705,7386707,7386714,7386731,7386738,7386746,7386758,7386759)
				) WHERE ROW_NUM = 1
				) AUX ON (AUX.ACT_CAN_ID = NEG.ACT_CAN_ID)
				WHEN MATCHED THEN UPDATE SET
				NEG.USUARIOBORRAR = ''REMVIP-9043'',
				NEG.BORRADO =1,
				NEG.FECHABORRAR = SYSDATE';
					
          EXECUTE IMMEDIATE V_MSQL;           	
          DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZADOS  '|| SQL%ROWCOUNT ||' REGISTROS ');
    
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN] ');

EXCEPTION
     WHEN OTHERS THEN
          ERR_MSG := SQLCODE;
          ERR_MSG := SQLERRM;

          DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecuci贸n:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------'); 
          DBMS_OUTPUT.PUT_LINE(ERR_MSG);

          ROLLBACK;
          RAISE;          

END;
/

EXIT
