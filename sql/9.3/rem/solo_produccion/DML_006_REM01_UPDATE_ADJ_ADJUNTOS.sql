--/*
--#########################################
--## AUTOR=Alvaro Garcia
--## FECHA_CREACION=20190425
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=2.2
--## INCIDENCIA_LINK=HREOS-6193
--## PRODUCTO=NO
--## 
--## Finalidad: BORRADO DE ADJUNTOS MIGRADOS A HAYA
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

	V_MSQL VARCHAR2(32000 CHAR); 
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; 
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';
	V_SQL VARCHAR2(4000 CHAR);
	V_NUM NUMBER(16);
	ERR_NUM NUMBER(25);  
	ERR_MSG VARCHAR2(1024 CHAR); 

	V_TABLA VARCHAR2(30 CHAR):= 'ADJ_ADJUNTOS';
        V_TABLA_ABR VARCHAR2(30 CHAR):= 'ADJ';


BEGIN	

	DBMS_OUTPUT.PUT_LINE('[INFO] INICIO DEL PROCESO.');
	
	V_MSQL := '
	SELECT COUNT(1) 
	FROM ALL_TABLES	
	WHERE TABLE_NAME = '''||V_TABLA||''' AND OWNER = '''||V_ESQUEMA||'''
	'
	;

	EXECUTE IMMEDIATE V_MSQL INTO V_NUM;
	
	IF V_NUM != 0 THEN
	
	DBMS_OUTPUT.PUT_LINE('[INFO] LA TABLA '||V_TABLA||' EXISTE, COMENZAMOS EL BORRADO DE ADJUNTOS');
		
        V_MSQL := '
	MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' '||V_TABLA_ABR||' USING (
	SELECT ADJ_ID FROM (
		SELECT 
		ADJ.ADJ_ID,
		ADAC.ADA_ID_DOCUMENTO_REST AS ID_DOCUMENTO_REST
		from '||V_ESQUEMA||'.ADJ_ADJUNTOS ADJ
		INNER JOIN '||V_ESQUEMA||'.ACT_ADA_ADJUNTO_ACTIVO ADAC ON ADAC.ADJ_ID=ADJ.ADJ_ID AND ADAC.BORRADO=0

		UNION

		SELECT 
		ADJ.ADJ_ID,
		ADTR.ADT_ID_DOCUMENTO_REST AS ID_DOCUMENTO_REST
		from '||V_ESQUEMA||'.ADJ_ADJUNTOS ADJ
		INNER JOIN '||V_ESQUEMA||'.ACT_ADT_ADJUNTO_TRABAJO ADTR ON ADTR.ADJ_ID=ADJ.ADJ_ID AND ADTR.BORRADO=0

		UNION

		SELECT 
		ADJ.ADJ_ID,
		ADCOM.ADC_ID_DOCUMENTO_REST AS ID_DOCUMENTO_REST
		from '||V_ESQUEMA||'.ADJ_ADJUNTOS ADJ
		INNER JOIN '||V_ESQUEMA||'.ADC_ADJUNTO_COMPRADOR ADCOM ON ADCOM.ADJ_ID=ADJ.ADJ_ID AND ADCOM.BORRADO=0

		UNION

		SELECT 
		ADJ.ADJ_ID,
		ADEX.ADE_ID_DOCUMENTO_REST AS ID_DOCUMENTO_REST
		from '||V_ESQUEMA||'.ADJ_ADJUNTOS ADJ
		INNER JOIN '||V_ESQUEMA||'.ADE_ADJUNTO_EXPEDIENTE ADEX ON ADEX.ADJ_ID=ADJ.ADJ_ID AND ADEX.BORRADO=0)
		WHERE ID_DOCUMENTO_REST IS NOT NULL 
		AND ID_DOCUMENTO_REST NOT IN (
		4150579 , 
		18026090 , 
		18025382 , 
		18162032 , 
		24746301 , 
		41246760)
	) AUX ON (AUX.ADJ_ID = '||V_TABLA_ABR||'.ADJ_ID)
	WHEN MATCHED THEN UPDATE SET ADJ_FICHERO = EMPTY_BLOB()
	'
	;

        EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('[INFO] LOS DOCUMENTOS DE LA TABLA '||V_TABLA||' HAN SIDO BORRADOS CON EXITO.');
	DBMS_OUTPUT.PUT_LINE('[INFO] Se han borrado '||sql%rowcount);

		
	ELSE
	
		DBMS_OUTPUT.PUT_LINE('[INFO] LA TABLA '||V_TABLA||' NO EXISTE. SE CREARÁ.');		
	
  
  END IF;
  COMMIT;
  DBMS_OUTPUT.PUT_LINE('[INFO] PROCESO FINALIZADO.');

         
EXCEPTION

   WHEN OTHERS THEN
   
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;
/
EXIT
