--/*
--##########################################
--## AUTOR=Carlos Santos Vílchez
--## FECHA_CREACION=20210226
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9062
--## PRODUCTO=SI
--##
--## Finalidad: Script que da de baja proveedores
--## INSTRUCCIONES:
--## VERSIONES:
--## 		0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE
	V_MSQL VARCHAR2(4000 CHAR);
	V_SQL VARCHAR2(4000 CHAR);
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	V_NUM NUMBER(16); -- Vble. para validar la existencia de un registro.
	err_num NUMBER; -- Numero de errores
	err_msg VARCHAR2(2048); -- Mensaje de error
	V_USR VARCHAR2(30 CHAR) := 'REMVIP-9062'; -- USUARIOCREAR/USUARIOMODIFICAR.
	V_COUNT NUMBER(16) := 0;
	V_TIPO_PROVEEDOR VARCHAR2(50 CHAR);
	
	TYPE T_VAR IS TABLE OF VARCHAR2(100);
	TYPE T_ARRAY_VAR IS TABLE OF T_VAR; 
	V_VAR T_ARRAY_VAR := T_ARRAY_VAR(
		-- 	PVE_NOMBRE 									
		T_VAR('B54665716'),
		T_VAR('B84212463'),
		T_VAR('F84944891'),
		T_VAR('B82136326'),
		T_VAR('34849979B'),
		T_VAR('A84583632'),
		T_VAR('B11412343'),
		T_VAR('B12885471'),
		T_VAR('B46405429'),
		T_VAR('B90169624'),
		T_VAR('B97853584'),
		T_VAR('B19671601'),
		T_VAR('B19693902'),
		T_VAR('B13490149'),
		T_VAR('B97296602'),
		T_VAR('B19261775'),
		T_VAR('B76143171'),
		T_VAR('B86074259'),
		T_VAR('B43794809'),
		T_VAR('74339454G'),
		T_VAR('B81755720'),
		T_VAR('30598576C'),
		T_VAR('18904822H'),
		T_VAR('B92354679'),
		T_VAR('52522826A'),
		T_VAR('53752492C'),
		T_VAR('B73610362'),
		T_VAR('30192137Z'),
		T_VAR('39838985H'),
		T_VAR('52633447V'),
		T_VAR('A78492303'),
		T_VAR('B12566576'),
		T_VAR('B14610620'),
		T_VAR('B19307842'),
		T_VAR('B19596196'),
		T_VAR('B43844620'),
		T_VAR('B54610126'),
		T_VAR('B65652281'),
		T_VAR('B82692732'),
		T_VAR('B85074896'),
		T_VAR('B96856083'),
		T_VAR('45480664G'),
		T_VAR('24335432Y'),
		T_VAR('74866541T'),
		T_VAR('B84461854'),
		T_VAR('B97494835'),
		T_VAR('24356134P'),
		T_VAR('B54901095'),
		T_VAR('77721400F'),
		T_VAR('B96591110'),
		T_VAR('B98993298'),
		T_VAR('B14612170'),
		T_VAR('52586362J'),
		T_VAR('B73238974'),
		T_VAR('B04739322'),
		T_VAR('B19639962'),
		T_VAR('48448872Q'),
		T_VAR('X6663899V'),
		T_VAR('48638517A'),
		T_VAR('20191694V'),
		T_VAR('B73260077'),
		T_VAR('B53136297'),
		T_VAR('B30587828'),
		T_VAR('29001146D'),
		T_VAR('B30822159'),
		T_VAR('E98967789'),
		T_VAR('02626445Y'),
		T_VAR('X6645632N'),
		T_VAR('22469767D'),
		T_VAR('B72374390'),
		T_VAR('B47763032'),
		T_VAR('B44523199'),
		T_VAR('20159926N'),
		T_VAR('X4888796P'),
		T_VAR('B44523983'),
		T_VAR('44871895E'),
		T_VAR('48661125W'),
		T_VAR('B43368976'),
		T_VAR('48495468Z'),
		T_VAR('B42651455'),
		T_VAR('B62053046'),
		T_VAR('B04911137'),
		T_VAR('48379784C'),
		T_VAR('72533519Y'),
		T_VAR('B04869996'),
		T_VAR('B67231993'),
		T_VAR('52817867T'),
		T_VAR('48438649M'),
		T_VAR('J43365840'),
		T_VAR('B63484877'),
		T_VAR('78545796Z'),
		T_VAR('B35456961'),
		T_VAR('29104055Q'),
		T_VAR('34843951D'),
		T_VAR('B27393644'),
		T_VAR('B93479210'),
		T_VAR('B43626886'),
		T_VAR('43665130K'),
		T_VAR('47688379H'),
		T_VAR('J93605178'),
		T_VAR('B42604868'),
		T_VAR('45599308Z')

	); 
	V_TMP_VAR T_VAR;

BEGIN
	DBMS_OUTPUT.PUT_LINE('[INICIO] Comienza el proceso:');
	DBMS_OUTPUT.PUT_LINE('---------------------------------------');

	V_MSQL := 'SELECT DD_TPR_ID FROM '||V_ESQUEMA||'.DD_TPR_TIPO_PROVEEDOR WHERE DD_TPR_CODIGO = ''04''';
	EXECUTE IMMEDIATE V_MSQL INTO V_TIPO_PROVEEDOR;

	FOR I IN V_VAR.FIRST .. V_VAR.LAST LOOP
		V_TMP_VAR := V_VAR(I);
		
		DBMS_OUTPUT.PUT_LINE('[INFO] Dando de baja el proveedor con documento "'||V_TMP_VAR(1)||'"...');
		
		V_MSQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR WHERE PVE_DOCIDENTIF = '''||V_TMP_VAR(1)||''' AND DD_TPR_ID = '||V_TIPO_PROVEEDOR||'';
		EXECUTE IMMEDIATE V_MSQL INTO V_NUM;
		
		IF V_NUM = 1 THEN
			
			EXECUTE IMMEDIATE 'UPDATE '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR SET
					DD_EPR_ID = 7,
					PVE_FECHA_BAJA = SYSDATE,
					USUARIOMODIFICAR = '''||V_USR||''',
					FECHAMODIFICAR = SYSDATE
					WHERE DD_TPR_ID = '||V_TIPO_PROVEEDOR||' AND PVE_DOCIDENTIF = '''||V_TMP_VAR(1)||'''';
			
			DBMS_OUTPUT.PUT_LINE('	[INFO] Proveedor con documento '||V_TMP_VAR(1)||' dado de baja');
		ELSE

			DBMS_OUTPUT.PUT_LINE('	[INFO] No existe el proveedor API con documento '||V_TMP_VAR(1)||'');

		END IF;

	END LOOP;		

	DBMS_OUTPUT.PUT_LINE('[FIN].');

	COMMIT;

EXCEPTION
	WHEN OTHERS THEN
		ERR_NUM := SQLCODE;
		ERR_MSG := SQLERRM;
		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
		DBMS_OUTPUT.put_line(ERR_MSG);
		ROLLBACK;
		RAISE;   
END;

/

EXIT;
