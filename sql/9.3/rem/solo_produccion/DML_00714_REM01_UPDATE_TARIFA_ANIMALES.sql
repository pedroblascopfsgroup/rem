--/*
--#########################################
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=202100302
--## ARTEFACTO=Batch
--## VERSION_ARTEFACTO=3.0
--## INCIDENCIA_LINK=REMVIP-9049
--## PRODUCTO=NO
--## 
--## Finalidad: Actualizar tarifas.
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/
--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

	V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-9049_3';

	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	ERR_NUM NUMBER;-- Numero de errores
	ERR_MSG VARCHAR2(2048);-- Mensaje de error
	V_SQL VARCHAR2(4000 CHAR);
    V_MSQL VARCHAR2(4000 CHAR);

    V_TABLA_TTF VARCHAR2(30 CHAR) := 'DD_TTF_TIPO_TARIFA';
    V_TABLA_CFT VARCHAR2(30 CHAR) := 'ACT_CFT_CONFIG_TARIFA';
    V_TABLA_TRABAJO VARCHAR2(30 CHAR) := 'ACT_TBJ_TRABAJO';
    V_TABLA_TCT VARCHAR2(30 CHAR) :='ACT_TCT_TRABAJO_CFGTARIFA';
    --V_TABLA_AUX VARCHAR2(30 CHAR):='AUX_REMVIP_9049';
    V_NUM_TABLAS NUMBER(16);
    V_ID NUMBER(16);
    V_CFT_ID NUMBER(16);

BEGIN
DBMS_OUTPUT.PUT_LINE('[INICIO] Actualizacion en '||V_TABLA_TRABAJO||' y '||V_TABLA_TCT||'');


        V_SQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA_TCT||' T1
        USING (SELECT DISTINCT
                    TBJ.TBJ_ID,
                    TCT.TCT_ID,
                    TBJ.TBJ_NUM_TRABAJO
                    FROM '||V_ESQUEMA||'.DD_TTF_TIPO_TARIFA TTF 
                    INNER JOIN '||V_ESQUEMA||'.ACT_CFT_CONFIG_TARIFA CFT ON CFT.DD_TTF_ID = TTF.DD_TTF_ID 
                    INNER JOIN '||V_ESQUEMA||'.DD_TTR_TIPO_TRABAJO TTR ON CFT.DD_TTR_ID = TTR.DD_TTR_ID
                    INNER JOIN '||V_ESQUEMA||'.DD_STR_SUBTIPO_TRABAJO STR1 ON CFT.DD_STR_ID = STR1.DD_STR_ID 
                    INNER JOIN '||V_ESQUEMA||'.ACT_TCT_TRABAJO_CFGTARIFA TCT ON TCT.CFT_ID = CFT.CFT_ID 
                    INNER JOIN '||V_ESQUEMA||'.ACT_TBJ_TRABAJO TBJ ON TCT.TBJ_ID = TBJ.TBJ_ID
                    INNER JOIN '||V_ESQUEMA||'.DD_STR_SUBTIPO_TRABAJO STR2 ON TBJ.DD_STR_ID = STR2.DD_STR_ID 
                    INNER JOIN '||V_ESQUEMA||'.DD_EST_ESTADO_TRABAJO EST ON EST.DD_EST_ID=TBJ.DD_EST_ID
                    WHERE CFT.DD_CRA_ID = 162
                    AND EST.DD_EST_ID=23
                    AND DD_TTF_CODIGO LIKE ''%BBVA%''
                    AND (TBJ.DD_STR_ID <> CFT.DD_STR_ID)
                    AND TCT.BORRADO=0 AND TBJ.BORRADO=0
                    AND STR1.DD_STR_ID=207
                    AND STR2.DD_STR_ID=206
ORDER BY TBJ.TBJ_NUM_TRABAJO  ) T2 
        ON (T1.TCT_ID = T2.TCT_ID)
        WHEN MATCHED THEN UPDATE SET
        T1.CFT_ID=(SELECT CFT_ID FROM '||V_ESQUEMA||'.ACT_CFT_CONFIG_TARIFA CFT
                    JOIN '||V_ESQUEMA||'.DD_TTF_TIPO_TARIFA TTF ON TTF.DD_TTF_ID=CFT.DD_TTF_ID
                    WHERE CFT.BORRADO=0 AND TTF.BORRADO=0 AND TTF.DD_TTF_CODIGO=''BBVA322'' AND CFT.DD_SCR_ID=503),
        T1.TCT_PRECIO_UNITARIO=TO_NUMBER(''38,46''),
        T1.TCT_PRECIO_UNITARIO_CLIENTE=TO_NUMBER(''50''), 
        T1.USUARIOMODIFICAR = '''||V_USUARIO||''', 
        T1.FECHAMODIFICAR = SYSDATE';

        EXECUTE IMMEDIATE V_SQL;

        DBMS_OUTPUT.PUT_LINE('[INFO] MODIFICADOS  '|| SQL%ROWCOUNT ||' REGISTROS EN '||V_TABLA_TCT||' CAMBIADOS DE TARIFAS');

       
        V_SQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA_TRABAJO||' T1
        USING (SELECT DISTINCT TBJ.TBJ_ID,SUM(TCT.TCT_PRECIO_UNITARIO*TCT.TCT_MEDICION) AS PRECIO_UNITARIO, SUM(TCT.TCT_PRECIO_UNITARIO_CLIENTE * TCT.TCT_MEDICION) AS PRECIO_CLIENTE FROM '||V_ESQUEMA||'.ACT_TBJ_TRABAJO TBJ
                JOIN '||V_ESQUEMA||'.act_tct_trabajo_cfgtarifa TCT ON TCT.TBJ_ID=TBJ.TBJ_ID AND TCT.BORRADO=0                
                WHERE TBJ.BORRADO=0 AND TCT.USUARIOMODIFICAR='''||V_USUARIO||'''
                GROUP BY TBJ.TBJ_ID) T2 
        ON (T1.TBJ_ID = T2.TBJ_ID)
        WHEN MATCHED THEN UPDATE SET 
        T1.TBJ_IMPORTE_TOTAL=T2.PRECIO_CLIENTE,
        T1.TBJ_IMPORTE_PRESUPUESTO=T2.PRECIO_UNITARIO,        
        T1.USUARIOMODIFICAR = '''||V_USUARIO||''', 
        T1.FECHAMODIFICAR = SYSDATE';

        EXECUTE IMMEDIATE V_SQL;

        DBMS_OUTPUT.PUT_LINE('[INFO] MODIFICADOS  '|| SQL%ROWCOUNT ||' REGISTROS EN '||V_TABLA_TRABAJO||' CAMBIADOS IMPORTES');
                

	DBMS_OUTPUT.PUT_LINE('[FIN] Finalizado la modificacion de tarifas y trabajos.');
	COMMIT;

EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(SQLCODE));
      DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------');
      DBMS_OUTPUT.PUT_LINE(SQLERRM);
      DBMS_OUTPUT.PUT_LINE(V_SQL);
      ROLLBACK;
      RAISE;
END;
/
EXIT;
