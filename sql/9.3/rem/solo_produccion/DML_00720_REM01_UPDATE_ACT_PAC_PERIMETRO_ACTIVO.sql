--/*
--##########################################
--## AUTOR=Carlos Santos Vílchez
--## FECHA_CREACION=20210303
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9115
--## PRODUCTO=NO
--##
--## Finalidad: Script para marcar checks
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_NUM_SEQUENCE NUMBER(16); -- Vble. auxiliar para almacenar el número de secuencia actual.
    V_NUM NUMBER(16); -- Vble. auxiliar para almacenar el número de registros
    V_COUNT_INSERT NUMBER(16):= 0; -- Vble. para contar inserts
    V_TEXT_TABLA VARCHAR2(27 CHAR) := 'ACT_PAC_PERIMETRO_ACTIVO'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_USU VARCHAR2(30 CHAR) := 'REMVIP-9115'; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.
	V_ACT_ID NUMBER(16);
	V_COUNT NUMBER(16);

    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(1024);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;

    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    --	ACTIVO
	T_TIPO_DATA('7322090'),
	T_TIPO_DATA('7322092'),
	T_TIPO_DATA('7322093'),
	T_TIPO_DATA('7322094'),
	T_TIPO_DATA('7322096'),
	T_TIPO_DATA('7433419'),
	T_TIPO_DATA('7433420'),
	T_TIPO_DATA('7433421'),
	T_TIPO_DATA('7433422'),
	T_TIPO_DATA('7433423'),
	T_TIPO_DATA('7433424'),
	T_TIPO_DATA('7433425'),
	T_TIPO_DATA('7433426'),
	T_TIPO_DATA('7433427'),
	T_TIPO_DATA('7433428'),
	T_TIPO_DATA('7433429'),
	T_TIPO_DATA('7433430'),
	T_TIPO_DATA('7433431'),
	T_TIPO_DATA('7433432'),
	T_TIPO_DATA('7433433'),
	T_TIPO_DATA('7433434'),
	T_TIPO_DATA('7433435'),
	T_TIPO_DATA('7433436'),
	T_TIPO_DATA('7433437'),
	T_TIPO_DATA('7433438'),
	T_TIPO_DATA('7433439'),
	T_TIPO_DATA('7433440'),
	T_TIPO_DATA('7433441'),
	T_TIPO_DATA('7433442'),
	T_TIPO_DATA('7433443'),
	T_TIPO_DATA('7433444'),
	T_TIPO_DATA('7433445'),
	T_TIPO_DATA('7433446'),
	T_TIPO_DATA('7433447'),
	T_TIPO_DATA('7433448'),
	T_TIPO_DATA('7433449'),
	T_TIPO_DATA('7433450'),
	T_TIPO_DATA('7433451'),
	T_TIPO_DATA('7433452'),
	T_TIPO_DATA('7433453'),
	T_TIPO_DATA('7433454'),
	T_TIPO_DATA('7433455'),
	T_TIPO_DATA('7433456'),
	T_TIPO_DATA('7433457'),
	T_TIPO_DATA('7433458'),
	T_TIPO_DATA('7433459'),
	T_TIPO_DATA('7433460'),
	T_TIPO_DATA('7433461'),
	T_TIPO_DATA('7433462'),
	T_TIPO_DATA('7433463'),
	T_TIPO_DATA('7433464'),
	T_TIPO_DATA('7433465'),
	T_TIPO_DATA('7433466'),
	T_TIPO_DATA('7433467'),
	T_TIPO_DATA('7433468'),
	T_TIPO_DATA('7433469'),
	T_TIPO_DATA('7433470'),
	T_TIPO_DATA('7433471'),
	T_TIPO_DATA('7433472'),
	T_TIPO_DATA('7433473'),
	T_TIPO_DATA('7433474'),
	T_TIPO_DATA('7433475'),
	T_TIPO_DATA('7433476'),
	T_TIPO_DATA('7433477'),
	T_TIPO_DATA('7433478'),
	T_TIPO_DATA('7433479'),
	T_TIPO_DATA('7433480'),
	T_TIPO_DATA('7433481'),
	T_TIPO_DATA('7433482'),
	T_TIPO_DATA('7433483'),
	T_TIPO_DATA('7433484'),
	T_TIPO_DATA('7433485'),
	T_TIPO_DATA('7433486'),
	T_TIPO_DATA('7433487'),
	T_TIPO_DATA('7433488'),
	T_TIPO_DATA('7433489'),
	T_TIPO_DATA('7433490'),
	T_TIPO_DATA('7433491'),
	T_TIPO_DATA('7433492'),
	T_TIPO_DATA('7433493'),
	T_TIPO_DATA('7433494'),
	T_TIPO_DATA('7433495'),
	T_TIPO_DATA('7433496'),
	T_TIPO_DATA('7433497'),
	T_TIPO_DATA('7433498'),
	T_TIPO_DATA('7433499'),
	T_TIPO_DATA('7433500'),
	T_TIPO_DATA('7433501'),
	T_TIPO_DATA('7433502'),
	T_TIPO_DATA('7433503'),
	T_TIPO_DATA('7433504'),
	T_TIPO_DATA('7433505'),
	T_TIPO_DATA('7433506'),
	T_TIPO_DATA('7433507'),
	T_TIPO_DATA('7433508'),
	T_TIPO_DATA('7433509'),
	T_TIPO_DATA('7433510'),
	T_TIPO_DATA('7433511'),
	T_TIPO_DATA('7433512'),
	T_TIPO_DATA('7433513'),
	T_TIPO_DATA('7433514'),
	T_TIPO_DATA('7433515'),
	T_TIPO_DATA('7433516'),
	T_TIPO_DATA('7433517'),
	T_TIPO_DATA('7433518'),
	T_TIPO_DATA('7433519'),
	T_TIPO_DATA('7433520'),
	T_TIPO_DATA('7433521'),
	T_TIPO_DATA('7433522'),
	T_TIPO_DATA('7433523'),
	T_TIPO_DATA('7433524'),
	T_TIPO_DATA('7433525'),
	T_TIPO_DATA('7433526'),
	T_TIPO_DATA('7433527'),
	T_TIPO_DATA('7433528'),
	T_TIPO_DATA('7433529'),
	T_TIPO_DATA('7433530'),
	T_TIPO_DATA('7433531'),
	T_TIPO_DATA('7433532'),
	T_TIPO_DATA('7433533'),
	T_TIPO_DATA('7433534'),
	T_TIPO_DATA('7433535'),
	T_TIPO_DATA('7433536'),
	T_TIPO_DATA('7433537'),
	T_TIPO_DATA('7433538'),
	T_TIPO_DATA('7433539'),
	T_TIPO_DATA('7433540'),
	T_TIPO_DATA('7433541'),
	T_TIPO_DATA('7433542'),
	T_TIPO_DATA('7433543'),
	T_TIPO_DATA('7433544'),
	T_TIPO_DATA('7433545'),
	T_TIPO_DATA('7433546'),
	T_TIPO_DATA('7433547'),
	T_TIPO_DATA('7433548'),
	T_TIPO_DATA('7433549'),
	T_TIPO_DATA('7433550'),
	T_TIPO_DATA('7433551'),
	T_TIPO_DATA('7433552'),
	T_TIPO_DATA('7433553'),
	T_TIPO_DATA('7433554'),
	T_TIPO_DATA('7433555'),
	T_TIPO_DATA('7433556'),
	T_TIPO_DATA('7433557'),
	T_TIPO_DATA('7433558'),
	T_TIPO_DATA('7433559'),
	T_TIPO_DATA('7433560'),
	T_TIPO_DATA('7433561'),
	T_TIPO_DATA('7433562'),
	T_TIPO_DATA('7433563'),
	T_TIPO_DATA('7433564'),
	T_TIPO_DATA('7433565'),
	T_TIPO_DATA('7433566'),
	T_TIPO_DATA('7433567'),
	T_TIPO_DATA('7433568'),
	T_TIPO_DATA('7433569'),
	T_TIPO_DATA('7433570'),
	T_TIPO_DATA('7433571'),
	T_TIPO_DATA('7433572'),
	T_TIPO_DATA('7433573'),
	T_TIPO_DATA('7433574'),
	T_TIPO_DATA('7434393'),
	T_TIPO_DATA('7434394'),
	T_TIPO_DATA('7434395'),
	T_TIPO_DATA('7434396'),
	T_TIPO_DATA('7434397'),
	T_TIPO_DATA('7434398'),
	T_TIPO_DATA('7434399'),
	T_TIPO_DATA('7434400'),
	T_TIPO_DATA('7434401'),
	T_TIPO_DATA('7434402'),
	T_TIPO_DATA('7434403'),
	T_TIPO_DATA('7434404'),
	T_TIPO_DATA('7434405'),
	T_TIPO_DATA('7434406'),
	T_TIPO_DATA('7434407'),
	T_TIPO_DATA('7434408'),
	T_TIPO_DATA('7434409'),
	T_TIPO_DATA('7434410'),
	T_TIPO_DATA('7434411'),
	T_TIPO_DATA('7434412'),
	T_TIPO_DATA('7434413'),
	T_TIPO_DATA('7434414'),
	T_TIPO_DATA('7434415'),
	T_TIPO_DATA('7434416'),
	T_TIPO_DATA('7434417'),
	T_TIPO_DATA('7434418'),
	T_TIPO_DATA('7434419'),
	T_TIPO_DATA('7434420'),
	T_TIPO_DATA('7434421'),
	T_TIPO_DATA('7435010')

    ); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

BEGIN	

	DBMS_OUTPUT.PUT_LINE('[INICIO]');

	DBMS_OUTPUT.PUT_LINE('[INFO]: MARCAR CHECKS EN '||V_TEXT_TABLA);
	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
	LOOP
		V_TMP_TIPO_DATA := V_TIPO_DATA(I);

		V_MSQL:='SELECT COUNT(*) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'';
		EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

		IF V_COUNT > 0 THEN

			V_MSQL:='SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'';
			EXECUTE IMMEDIATE V_MSQL INTO V_ACT_ID;

			V_MSQL := 'UPDATE '||V_ESQUEMA||'.'||V_TEXT_TABLA||' SET
			PAC_CHECK_COMERCIALIZAR = 1,
			PAC_FECHA_COMERCIALIZAR = SYSDATE,
			PAC_CHECK_FORMALIZAR = 1,
			PAC_FECHA_FORMALIZAR = SYSDATE,
			USUARIOMODIFICAR = '''||V_USU||''',
			FECHAMODIFICAR = SYSDATE
			WHERE ACT_ID = '||V_ACT_ID||'';
			EXECUTE IMMEDIATE V_MSQL;

			DBMS_OUTPUT.PUT_LINE('[INFO]: CHECKS MARCADOS PARA EL ACTIVO: '||V_TMP_TIPO_DATA(1)||'');
		
		ELSE

			DBMS_OUTPUT.PUT_LINE('[INFO]: EL ACTIVO: '||V_TMP_TIPO_DATA(1)||' NO EXISTE');

		END IF;

	END LOOP;

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN]');


EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;

/

EXIT