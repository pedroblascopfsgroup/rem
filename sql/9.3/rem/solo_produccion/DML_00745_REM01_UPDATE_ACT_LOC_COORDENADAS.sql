--/*
--##########################################
--## AUTOR=Carlos Santos Vílchez
--## FECHA_CREACION=20210309
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9175
--## PRODUCTO=NO
--##
--## Finalidad: Script para actualizar las coordenadas
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;
DECLARE
    V_MSQL VARCHAR2(4000 CHAR);
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    err_num NUMBER; -- Numero de errores
    err_msg VARCHAR2(2048); -- Mensaje de error
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-9175'; -- USUARIOCREAR/USUARIOMODIFICAR.
    REC_ID NUMBER(16);
    LOC_CODIGO VARCHAR2(20 CHAR);
    PRV_CODIGO VARCHAR2(20 CHAR);
    LOC_ID NUMBER(16);
    PRV_ID NUMBER(16);
    ACT_ID NUMBER(16);
    BIE_ID NUMBER(16);

    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	--act_recovery_id, dd_loc_codigo, dd_prv_codigo

	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(

		T_JBV(7248301,'41.456721987485','2.2140487501849'),
		T_JBV(7249119,'41.371661518243','2.1110554284117'),
		T_JBV(7241076,'40.410864740371','-3.695416211574'),
		T_JBV(7249728,'41.373563269968','2.1105652082859'),
		T_JBV(7283695,'41.972467963782','2.7923078064199'),
		T_JBV(7283829,'41.446381311663','2.1757133702838'),
		T_JBV(7283904,'38.237569549241','-5.5516726995964'),
		T_JBV(7283913,'40.395578905758','-3.7374619553637'),
		T_JBV(7284156,'41.438766598981','2.2185077035843'),
		T_JBV(7284182,'37.388764423047','-5.9680255251498'),
		T_JBV(7284214,'38.339109931391','-0.76508115115673'),
		T_JBV(7284374,'28.052886553002','-16.721199667798'),
		T_JBV(7284582,'40.930736114465','-4.058341960063'),
		T_JBV(7284616,'41.553787458868','2.2685182863301'),
		T_JBV(7285150,'41.447520450892','2.1816640286212'),
		T_JBV(7285319,'41.143834477897','1.1125622217783'),
		T_JBV(7285384,'41.433187865239','2.1549813456129'),
		T_JBV(7285443,'41.452113416712','2.1918687076771'),
		T_JBV(7285467,'41.919187235334','3.1557032839892'),
		T_JBV(7285528,'41.445458136263','2.1747579018721'),
		T_JBV(7285619,'41.552884995945','2.2680192018555'),
		T_JBV(7285651,'41.48831448349','2.0307230496866'),
		T_JBV(7285701,'41.519028510021','2.1284493541041'),
		T_JBV(7285769,'41.552884995945','2.2680192018555'),
		T_JBV(7285968,'41.370267987892','2.0547846471053'),
		T_JBV(7285995,'41.525841682509','2.1072164509722'),
		T_JBV(7286061,'28.405897775656','-16.325393396076'),
		T_JBV(7286278,'37.260480255946','-6.9307007751705'),
		T_JBV(7286279,'37.260480255946','-6.9307007751705'),
		T_JBV(7286280,'37.260480255946','-6.9307007751705'),
		T_JBV(7286361,'37.386121536837','-6.8410528406444'),
		T_JBV(7286412,'41.618490319549','2.6682105453333'),
		T_JBV(7286962,'41.54297198508','2.2088521437098'),
		T_JBV(7286981,'41.447610973576','2.184288979904'),
		T_JBV(7286989,'37.658217692718','-5.5359250929034'),
		T_JBV(7287065,'41.160251050959','1.1127259349346'),
		T_JBV(7287472,'36.16930989376','-5.3694449976431'),
		T_JBV(7287917,'40.315214004614','-3.7196496336327'),
		T_JBV(7287943,'41.00503422518','0.9289457269368'),
		T_JBV(7288048,'41.541322632813','2.4538248049209'),
		T_JBV(7288050,'41.541322632813','2.4538248049209'),
		T_JBV(7288077,'40.780136370456','-3.6860701005614'),
		T_JBV(7288293,'41.615276771663','2.0838485015634'),
		T_JBV(7243183,'40.379802296831','0.40692015017256'),
		T_JBV(7252228,'41.610764690297','2.0215416129677'),
		T_JBV(7263910,'36.691474735364','-4.4469893577966'),
		T_JBV(7283612,'41.164696146971','1.2462488289308'),
		T_JBV(7283614,'41.447135582671','2.1863523577829'),
		T_JBV(7283714,'41.635426543303','2.0744648587524'),
		T_JBV(7283907,'41.14023769732','1.1169053784618'),
		T_JBV(7283989,'41.553964875529','2.2697469460592'),
		T_JBV(7284015,'41.673761885545','2.2849415266431'),
		T_JBV(7284206,'36.4878521479','-4.9527340314795'),
		T_JBV(7284263,'37.261839738629','-6.8613157529745'),
		T_JBV(7284289,'41.56517822702','2.0968020531858'),
		T_JBV(7284458,'41.550656208826','2.1265995765202'),
		T_JBV(7284581,'41.600538506666','1.9165635667207'),
		T_JBV(7284590,'39.956602601519','-3.9365040587914'),
		T_JBV(7284874,'41.530394153476','2.1125126856368'),
		T_JBV(7285309,'40.428412908112','-3.6751724883372'),
		T_JBV(7285350,'41.434339670123','2.2060184373645'),
		T_JBV(7285352,'41.434274065485','2.2046709120248'),
		T_JBV(7285416,'41.460397481217','2.1777533579603'),
		T_JBV(7285418,'41.373938882669','2.1566724998576'),
		T_JBV(7285461,'41.452865488531','2.1903248497581'),
		T_JBV(7285466,'41.919187235334','3.1557032839892'),
		T_JBV(7285468,'41.919187235334','3.1557032839892'),
		T_JBV(7285469,'41.919187235334','3.1557032839892'),
		T_JBV(7285484,'40.416432151998','-3.6959553786891'),
		T_JBV(7285485,'40.416432151998','-3.6959553786891'),
		T_JBV(7285486,'40.416432151998','-3.6959553786891'),
		T_JBV(7285518,'41.448873872575','2.1757675379885'),
		T_JBV(7285533,'41.421756454227','2.2074718127356'),
		T_JBV(7285750,'41.459781141535','2.1766251861963'),
		T_JBV(7286127,'41.460997567168','2.1725673588589'),
		T_JBV(7286363,'37.449040128316','-7.1093324936332'),
		T_JBV(7286379,'41.82715782932','1.8967228588508'),
		T_JBV(7286386,'41.697230707951','2.2736772657786'),
		T_JBV(7287473,'36.16930989376','-5.3694449976431'),
		T_JBV(7287475,'36.16930989376','-5.3694449976431'),
		T_JBV(7287942,'41.00503422518','0.9289457269368'),
		T_JBV(7287981,'36.614097538245','-6.2086115075684'),
		T_JBV(7287984,'40.1702679467','-3.2706328117633'),
		T_JBV(7288385,'28.955490042616','-13.589767998106'),
		T_JBV(7288391,'41.531861814815','2.0866214975324'),
		T_JBV(7288392,'41.461214279593','2.1724664164516'),
		T_JBV(7278186,'37.67361136004','-5.1613056115642'),
		T_JBV(7278187,'37.67361136004','-5.1613056115642'),
		T_JBV(7283659,'40.030534410729','-3.594092135568'),
		T_JBV(7283701,'41.552559912681','2.267536635506'),
		T_JBV(7283749,'41.14628200233','1.1071270046267'),
		T_JBV(7283792,'41.532416403477','2.121360123075'),
		T_JBV(7283918,'36.468544975229','-6.1879349522469'),
		T_JBV(7283919,'40.361165410593','-3.9093399948254'),
		T_JBV(7283935,'41.544537485729','2.0864442017445'),
		T_JBV(7283967,'41.140132177594','1.1169908479777'),
		T_JBV(7284010,'37.280259304543','-5.9305984895426'),
		T_JBV(7284352,'37.346418196583','-5.8304089125186'),
		T_JBV(7284401,'41.634548277117','1.9154504092184'),
		T_JBV(7284728,'42.013008452251','2.8256560798777'),
		T_JBV(7284738,'37.377584171696','-5.9494509137534'),
		T_JBV(7284769,'41.384900339861','2.0759147230166'),
		T_JBV(7284845,'37.967860111545','-1.2096830835592'),
		T_JBV(7285246,'41.160903289236','1.1170349620905'),
		T_JBV(7285378,'41.437290869162','2.1579456844434'),
		T_JBV(7285429,'41.451708554866','2.1902962556939'),
		T_JBV(7285474,'41.453311963379','2.1932317632629'),
		T_JBV(7285495,'41.461826596463','2.1764944177214'),
		T_JBV(7285513,'41.41440550594','2.2188323213491'),
		T_JBV(7285531,'41.443239718608','2.1741959705431'),
		T_JBV(7285549,'41.084023894991','1.1000604268062'),
		T_JBV(7285637,'41.552483614869','2.2659819100789'),
		T_JBV(7285664,'41.432497817646','2.169928684271'),
		T_JBV(7285713,'41.655370913646','1.1402249309192'),
		T_JBV(7285714,'41.674813855498','1.8396001754471'),
		T_JBV(7285888,'37.674297486781','-1.699732131336'),
		T_JBV(7285965,'40.423413577196','-3.6994254893574'),
		T_JBV(7286030,'41.185110244408','1.4585848709387'),
		T_JBV(7286064,'40.405618036478','-3.6158001567205'),
		T_JBV(7286147,'28.070443516434','-15.420365241516'),
		T_JBV(7286150,'41.378521553765','2.130793323799'),
		T_JBV(7286207,'41.550765214576','2.1255827461959'),
		T_JBV(7286217,'41.460147583975','2.1778875090833'),
		T_JBV(7286275,'37.260480255946','-6.9307007751705'),
		T_JBV(7286276,'37.260480255946','-6.9307007751705'),
		T_JBV(7286325,'38.155736946052','-0.89548193554812'),
		T_JBV(7286382,'41.82715782932','1.8967228588508'),
		T_JBV(7286617,'42.051007187982','2.2644193537814'),
		T_JBV(7286935,'41.460574190365','2.1786210351332'),
		T_JBV(7286944,'37.377830389632','-5.9655484940887'),
		T_JBV(7287476,'36.16930989376','-5.3694449976431'),
		T_JBV(7287938,'41.553094866143','2.2666622029942'),
		T_JBV(7288046,'41.541322632813','2.4538248049209'),
		T_JBV(7288362,'37.969088025085','-1.2164532142889'),
		T_JBV(7282999,'37.293249123362','-5.9233833807127'),
		T_JBV(7283499,'42.464650891195','-2.4318713278557'),
		T_JBV(7283625,'41.438916902324','2.1664566336289'),
		T_JBV(7283917,'37.37267778113','-4.9555334713656'),
		T_JBV(7283928,'41.46191129728','2.179650230029'),
		T_JBV(7283986,'41.971205352467','2.8450885709211'),
		T_JBV(7284070,'37.934669018191','-1.1653526842614'),
		T_JBV(7284351,'41.447202837209','2.1759213324005'),
		T_JBV(7284578,'39.474386543777','-0.33426534006591'),
		T_JBV(7284771,'41.375447474383','2.0799223081866'),
		T_JBV(7285223,'41.423597457379','2.1477154919711'),
		T_JBV(7285262,'41.379327064798','2.1658254760813'),
		T_JBV(7285373,'41.433001012899','2.1696970188784'),
		T_JBV(7285463,'41.919187235334','3.1557032839892'),
		T_JBV(7285464,'41.919187235334','3.1557032839892'),
		T_JBV(7285465,'41.919187235334','3.1557032839892'),
		T_JBV(7285504,'41.418554111084','2.2155404695406'),
		T_JBV(7285522,'41.418843475689','2.2147019775833'),
		T_JBV(7285612,'41.640276136159','2.2321378749861'),
		T_JBV(7285613,'41.640629888738','2.2323329961255'),
		T_JBV(7285621,'41.553964875529','2.2697469460592'),
		T_JBV(7285631,'41.568175220451','2.02895274314'),
		T_JBV(7285698,'38.397193263848','-0.52694041091951'),
		T_JBV(7285704,'41.463152164739','2.1786164026617'),
		T_JBV(7285705,'41.577635402371','1.6274333615521'),
		T_JBV(7285722,'41.461314950917','2.1761512469044'),
		T_JBV(7285764,'36.762972945006','-2.6247663503159'),
		T_JBV(7285874,'41.461483965971','2.1736072367218'),
		T_JBV(7285991,'41.442074392535','2.2121149874062'),
		T_JBV(7286050,'38.358559537849','-0.48636726362378'),
		T_JBV(7286058,'28.405897775656','-16.325393396076'),
		T_JBV(7286139,'41.417609000835','2.2167897347963'),
		T_JBV(7286140,'41.452662243293','2.192639032493'),
		T_JBV(7286250,'41.615497738867','1.9970432588595'),
		T_JBV(7286381,'41.82715782932','1.8967228588508'),
		T_JBV(7286384,'41.82715782932','1.8967228588508'),
		T_JBV(7286540,'41.781885133572','1.834395696273'),
		T_JBV(7286541,'41.664696750972','2.7839175216814'),
		T_JBV(7286607,'41.537515103954','2.0997761302058'),
		T_JBV(7286983,'41.621011645952','2.2946628514064'),
		T_JBV(7287075,'37.973436423528','-4.1032802801701'),
		T_JBV(7287444,'36.16930989376','-5.3694449976431'),
		T_JBV(7287897,'37.54514634095','-5.8687563608684'),
		T_JBV(7287944,'41.00503422518','0.9289457269368'),
		T_JBV(7288052,'41.541322632813','2.4538248049209'),
		T_JBV(7288154,'41.561324504042','2.0412714799963'),
		T_JBV(7241077,'40.410864740371','-3.695416211574'),
		T_JBV(7283670,'41.435983178122','2.2078882667984'),
		T_JBV(7283814,'36.714779476682','-2.6898171709869'),
		T_JBV(7283895,'37.38606397614','-5.7214638656132'),
		T_JBV(7283971,'38.382772418724','-0.503052240259'),
		T_JBV(7284056,'41.352337778691','2.0772778098924'),
		T_JBV(7284097,'41.371649703791','2.1606633946954'),
		T_JBV(7284223,'41.675016654111','2.7759296456656'),
		T_JBV(7284232,'41.431370565792','2.1694210938705'),
		T_JBV(7284240,'37.194862368394','-7.3296335217178'),
		T_JBV(7284382,'41.552483614869','2.2659819100789'),
		T_JBV(7284438,'41.550564487058','2.1262165139949'),
		T_JBV(7285135,'38.201381605464','-1.401436265014'),
		T_JBV(7285483,'40.416432151998','-3.6959553786891'),
		T_JBV(7285584,'41.69693757502','0.59422443785664'),
		T_JBV(7285602,'41.550359873819','2.1267897780696'),
		T_JBV(7285670,'41.360376922548','2.1419850365391'),
		T_JBV(7285693,'41.418843475689','2.2147019775833'),
		T_JBV(7285703,'41.669692968859','1.8604763280266'),
		T_JBV(7285777,'36.684728281249','-6.135394524621'),
		T_JBV(7285869,'37.296352060272','-6.9899499762482'),
		T_JBV(7286038,'41.631209582747','0.62128197757429'),
		T_JBV(7286086,'41.237529929627','1.816546466824'),
		T_JBV(7286185,'36.5998907278','-4.53705792199'),
		T_JBV(7286277,'37.260480255946','-6.9307007751705'),
		T_JBV(7286380,'41.82715782932','1.8967228588508'),
		T_JBV(7286385,'41.82715782932','1.8967228588508'),
		T_JBV(7286389,'41.927280235547','2.2655494892401'),
		T_JBV(7286539,'41.783734458123','1.839069934463'),
		T_JBV(7286932,'36.775888246188','-2.8176356250725'),
		T_JBV(7286940,'41.61155270327','0.63024703580797'),
		T_JBV(7287474,'36.16930989376','-5.3694449976431'),
		T_JBV(7287592,'39.593467543301','2.6324888858628'),
		T_JBV(7287932,'37.593246046569','-5.737165980427'),
		T_JBV(7287934,'41.450393931329','2.1914244528231'),
		T_JBV(7288049,'41.541322632813','2.4538248049209'),
		T_JBV(7288051,'41.541322632813','2.4538248049209'),
		T_JBV(7288341,'37.256266801025','-6.9565974471957'),
		T_JBV(7288342,'37.256266801025','-6.9565974471957'),
		T_JBV(7288368,'41.979703501898','2.8222497794705'),
		T_JBV(7276930,'42.573091','-2.193561'),
		T_JBV(7283651,'36.177326643898','-5.3698167910755'),
		T_JBV(7283710,'37.54590883579','-5.8682851784309'),
		T_JBV(7283785,'38.063018166203','-1.0530616221199'),
		T_JBV(7283825,'41.423264900496','2.204295824573'),
		T_JBV(7283833,'41.141889111413','1.1122569893148'),
		T_JBV(7283844,'41.553216413887','2.2685067378621'),
		T_JBV(7283900,'41.182977297371','0.56496346301876'),
		T_JBV(7283959,'37.21884529501','-5.3136286863669'),
		T_JBV(7284044,'41.46346313929','2.1781931308751'),
		T_JBV(7284086,'36.744116177662','-3.6642397762785'),
		T_JBV(7284144,'38.074955574534','-0.83590680350962'),
		T_JBV(7284228,'41.147095728742','1.1071765213795'),
		T_JBV(7284386,'41.466642566604','2.0768402711622'),
		T_JBV(7284635,'37.401498955572','-5.9258683639317'),
		T_JBV(7284820,'38.093669657756','-3.6230633087042'),
		T_JBV(7284863,'41.428222907009','2.1791335342162'),
		T_JBV(7285114,'41.524663922903','2.1077312493765'),
		T_JBV(7285314,'40.435109572845','-3.7018139190961'),
		T_JBV(7285346,'41.165006209366','1.247155732163'),
		T_JBV(7285379,'40.376520243789','-3.6221784816481'),
		T_JBV(7285382,'41.424226703806','2.1509417809554'),
		T_JBV(7285413,'41.373307612818','2.1576163628927'),
		T_JBV(7285587,'41.372940948743','2.1311036674942'),
		T_JBV(7285673,'41.146463605279','1.1073635544284'),
		T_JBV(7285708,'41.423686524093','2.152871944693'),
		T_JBV(7285973,'41.553546644436','2.2689920138914'),
		T_JBV(7286015,'41.550487779657','2.1267308618808'),
		T_JBV(7286066,'41.553789673732','2.0013525734499'),
		T_JBV(7286149,'40.90232330693','-0.11361295333684'),
		T_JBV(7286156,'39.693079423458','-0.34934335903181'),
		T_JBV(7286164,'38.882770842034','-7.018394176479'),
		T_JBV(7286190,'37.861872034259','-1.8504626219063'),
		T_JBV(7286222,'41.79653008637','2.8048908787269'),
		T_JBV(7286233,'42.000618788064','2.2889462584807'),
		T_JBV(7286241,'41.367671733389','2.1114410659564'),
		T_JBV(7286281,'40.302687741661','-3.4451885371962'),
		T_JBV(7286309,'35.88132097789','-5.3274514397721'),
		T_JBV(7286315,'38.992188685735','-1.8744461171281'),
		T_JBV(7286399,'42.099860627156','1.8423781311425'),
		T_JBV(7286615,'42.051007187982','2.2644193537814'),
		T_JBV(7286616,'42.051007187982','2.2644193537814'),
		T_JBV(7287855,'38.243393263171','-6.0124966685581'),
		T_JBV(7287952,'37.376434546434','-5.9548985538733'),
		T_JBV(7287955,'38.264879627863','-0.71259084975148'),
		T_JBV(7287997,'28.449653433028','-16.28529374172'),
		T_JBV(7288045,'41.541322632813','2.4538248049209'),
		T_JBV(7288047,'41.541322632813','2.4538248049209'),
		T_JBV(7288053,'41.541322632813','2.4538248049209'),
		T_JBV(7288144,'41.790770072723','3.0257150325068'),
		T_JBV(7288339,'41.371649703791','2.1606633946954'),
		T_JBV(7288364,'41.346466383006','2.0312839639855')

		); 
	V_TMP_JBV T_JBV;

BEGIN	
    -- LOOP Insertando 
    DBMS_OUTPUT.PUT_LINE('[INICIO] Empezando a insertar datos en la tabla');

    FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
		V_TMP_JBV := V_JBV(I);
	
		V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_LOC_LOCALIZACION LOC USING (
					SELECT ACT.ACT_ID
					FROM '||V_ESQUEMA||'.ACT_LOC_LOCALIZACION AUX
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AUX.ACT_ID
					WHERE ACT.ACT_NUM_ACTIVO = '||V_TMP_JBV(1)||' AND ACT.BORRADO = 0
					) AUX ON (AUX.ACT_ID = LOC.ACT_ID)
					WHEN MATCHED THEN UPDATE SET
					LOC.LOC_LONGITUD = '||V_TMP_JBV(3)||',
					LOC.LOC_LATITUD = '||V_TMP_JBV(2)||',
					LOC.USUARIOMODIFICAR = '''||V_USR||''',
					LOC.FECHAMODIFICAR = SYSDATE';

		EXECUTE IMMEDIATE V_MSQL;
				
		DBMS_OUTPUT.PUT_LINE('[INFO] Activo '||V_TMP_JBV(1)||' actualizado correctamente. ');
		
    END LOOP; 

	DBMS_OUTPUT.PUT_LINE('[FIN] Registros actualizado correctamente.');	
	
	COMMIT;

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
