--/*
--##########################################
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20210311
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9188
--## PRODUCTO=NO
--##
--## Finalidad: Script informa mediador relacionado para oficinas
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_TEXT_TABLA VARCHAR2(27 CHAR) := 'ACT_PVE_PROVEEDOR'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_USU VARCHAR2(30 CHAR) := 'REMVIP-9188'; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.
	V_COUNT NUMBER(16);
	V_PVE_ID NUMBER(16);

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
		-- 		COD_OFI  COD_MED
		T_TIPO_DATA(9603,1799),
		T_TIPO_DATA(8454,1799),
		T_TIPO_DATA(8252,1799),
		T_TIPO_DATA(8760,1799),
		T_TIPO_DATA(8589,1799),
		T_TIPO_DATA(8562,1799),
		T_TIPO_DATA(8569,1799),
		T_TIPO_DATA(8509,1799),
		T_TIPO_DATA(8529,1799),
		T_TIPO_DATA(8537,1799),
		T_TIPO_DATA(8466,1799),
		T_TIPO_DATA(8389,1799),
		T_TIPO_DATA(7398,1799),
		T_TIPO_DATA(8701,1799),
		T_TIPO_DATA(8414,1799),
		T_TIPO_DATA(8287,1799),
		T_TIPO_DATA(8293,1799),
		T_TIPO_DATA(8535,1799),
		T_TIPO_DATA(8517,1798),
		T_TIPO_DATA(8659,1798),
		T_TIPO_DATA(8666,1798),
		T_TIPO_DATA(8677,1798),
		T_TIPO_DATA(8579,1798),
		T_TIPO_DATA(8588,1798),
		T_TIPO_DATA(8596,1798),
		T_TIPO_DATA(8519,1798),
		T_TIPO_DATA(7590,1798),
		T_TIPO_DATA(7592,1798),
		T_TIPO_DATA(8296,1798),
		T_TIPO_DATA(8572,9990148),
		T_TIPO_DATA(8574,9990148),
		T_TIPO_DATA(8527,9990148),
		T_TIPO_DATA(8700,9990148),
		T_TIPO_DATA(8717,9990148),
		T_TIPO_DATA(8583,9990148),
		T_TIPO_DATA(8522,9990148),
		T_TIPO_DATA(8534,9990148),
		T_TIPO_DATA(8561,9990148),
		T_TIPO_DATA(8568,9990148),
		T_TIPO_DATA(8452,9990148),
		T_TIPO_DATA(8473,9990148),
		T_TIPO_DATA(8480,9990148),
		T_TIPO_DATA(8497,9990148),
		T_TIPO_DATA(7405,9990148),
		T_TIPO_DATA(8822,9990148),
		T_TIPO_DATA(8657,9990148),
		T_TIPO_DATA(8676,9990148),
		T_TIPO_DATA(8681,9990148),
		T_TIPO_DATA(8683,9990148),
		T_TIPO_DATA(8685,9990148),
		T_TIPO_DATA(8686,9990148),
		T_TIPO_DATA(8550,9990148),
		T_TIPO_DATA(8552,9990148),
		T_TIPO_DATA(8560,9990148),
		T_TIPO_DATA(7215,9990148),
		T_TIPO_DATA(8654,9990148),
		T_TIPO_DATA(7366,9990148),
		T_TIPO_DATA(8336,2260),
		T_TIPO_DATA(8352,2260),
		T_TIPO_DATA(8362,2260),
		T_TIPO_DATA(8570,2260),
		T_TIPO_DATA(8495,2260),
		T_TIPO_DATA(8442,2260),
		T_TIPO_DATA(8339,2260),
		T_TIPO_DATA(8670,3655),
		T_TIPO_DATA(8645,3655),
		T_TIPO_DATA(8694,3655),
		T_TIPO_DATA(8585,4443),
		T_TIPO_DATA(8599,4443),
		T_TIPO_DATA(8611,4443),
		T_TIPO_DATA(8612,4443),
		T_TIPO_DATA(8613,4443),
		T_TIPO_DATA(8619,4443),
		T_TIPO_DATA(8540,4443),
		T_TIPO_DATA(8578,4443),
		T_TIPO_DATA(8703,4443),
		T_TIPO_DATA(8651,4443),
		T_TIPO_DATA(8663,4443),
		T_TIPO_DATA(8673,4443),
		T_TIPO_DATA(8691,4443),
		T_TIPO_DATA(8695,4443),
		T_TIPO_DATA(8696,4443),
		T_TIPO_DATA(8581,4443),
		T_TIPO_DATA(8604,4443),
		T_TIPO_DATA(8605,4443),
		T_TIPO_DATA(8453,4443),
		T_TIPO_DATA(9702,662),
		T_TIPO_DATA(9703,662),
		T_TIPO_DATA(9707,662),
		T_TIPO_DATA(9709,662),
		T_TIPO_DATA(9710,662),
		T_TIPO_DATA(9711,662),
		T_TIPO_DATA(9596,662),
		T_TIPO_DATA(8823,662),
		T_TIPO_DATA(8824,662),
		T_TIPO_DATA(8708,662),
		T_TIPO_DATA(8620,662),
		T_TIPO_DATA(8621,662),
		T_TIPO_DATA(8479,662),
		T_TIPO_DATA(8485,662),
		T_TIPO_DATA(8419,662),
		T_TIPO_DATA(8439,662),
		T_TIPO_DATA(8318,662),
		T_TIPO_DATA(8376,662),
		T_TIPO_DATA(8103,662),
		T_TIPO_DATA(7277,662),
		T_TIPO_DATA(8464,662),
		T_TIPO_DATA(8373,662),
		T_TIPO_DATA(8377,662),
		T_TIPO_DATA(8639,662),
		T_TIPO_DATA(8563,662),
		T_TIPO_DATA(8682,662),
		T_TIPO_DATA(8697,662),
		T_TIPO_DATA(8623,662),
		T_TIPO_DATA(8633,662),
		T_TIPO_DATA(8508,662),
		T_TIPO_DATA(8459,662),
		T_TIPO_DATA(8475,662),
		T_TIPO_DATA(8409,662),
		T_TIPO_DATA(8270,662),
		T_TIPO_DATA(8289,662),
		T_TIPO_DATA(8290,662),
		T_TIPO_DATA(8600,662),
		T_TIPO_DATA(8624,662),
		T_TIPO_DATA(8625,662),
		T_TIPO_DATA(8630,662),
		T_TIPO_DATA(8511,662),
		T_TIPO_DATA(8410,662),
		T_TIPO_DATA(8422,662),
		T_TIPO_DATA(8264,662),
		T_TIPO_DATA(8274,662),
		T_TIPO_DATA(8292,662),
		T_TIPO_DATA(7280,662),
		T_TIPO_DATA(7281,662),
		T_TIPO_DATA(8709,662),
		T_TIPO_DATA(8761,662),
		T_TIPO_DATA(8634,662),
		T_TIPO_DATA(8635,662),
		T_TIPO_DATA(8510,662),
		T_TIPO_DATA(8382,662),
		T_TIPO_DATA(7274,662),
		T_TIPO_DATA(7275,662),
		T_TIPO_DATA(8516,662),
		T_TIPO_DATA(8320,662),
		T_TIPO_DATA(8323,662),
		T_TIPO_DATA(8324,662),
		T_TIPO_DATA(8329,662),
		T_TIPO_DATA(7282,662),
		T_TIPO_DATA(8655,662),
		T_TIPO_DATA(8675,662),
		T_TIPO_DATA(8254,662),
		T_TIPO_DATA(7375,662),
		T_TIPO_DATA(7394,662),
		T_TIPO_DATA(8428,662),
		T_TIPO_DATA(8364,662),
		T_TIPO_DATA(8595,662),
		T_TIPO_DATA(8711,662),
		T_TIPO_DATA(8524,662),
		T_TIPO_DATA(8458,662),
		T_TIPO_DATA(8404,662),
		T_TIPO_DATA(8425,662),
		T_TIPO_DATA(8427,662),
		T_TIPO_DATA(8430,662),
		T_TIPO_DATA(8375,662),
		T_TIPO_DATA(7483,662),
		T_TIPO_DATA(8575,662),
		T_TIPO_DATA(8617,662),
		T_TIPO_DATA(8719,662),
		T_TIPO_DATA(8762,662),
		T_TIPO_DATA(8689,662),
		T_TIPO_DATA(8690,662),
		T_TIPO_DATA(8576,662),
		T_TIPO_DATA(8482,662),
		T_TIPO_DATA(8331,662),
		T_TIPO_DATA(8358,662),
		T_TIPO_DATA(8259,662),
		T_TIPO_DATA(8275,662),
		T_TIPO_DATA(8465,662),
		T_TIPO_DATA(8494,662),
		T_TIPO_DATA(8379,662),
		T_TIPO_DATA(8256,662),
		T_TIPO_DATA(8261,662),
		T_TIPO_DATA(7399,662),
		T_TIPO_DATA(8664,662),
		T_TIPO_DATA(8577,662),
		T_TIPO_DATA(8478,662),
		T_TIPO_DATA(8489,662),
		T_TIPO_DATA(8506,3279),
		T_TIPO_DATA(8322,662),
		T_TIPO_DATA(8326,662),
		T_TIPO_DATA(8446,662),
		T_TIPO_DATA(8476,662),
		T_TIPO_DATA(8368,662),
		T_TIPO_DATA(8257,662),
		T_TIPO_DATA(8294,662),
		T_TIPO_DATA(8821,662),
		T_TIPO_DATA(8656,662),
		T_TIPO_DATA(8580,662),
		T_TIPO_DATA(8590,662),
		T_TIPO_DATA(8593,662),
		T_TIPO_DATA(8597,662),
		T_TIPO_DATA(8523,662),
		T_TIPO_DATA(8396,662),
		T_TIPO_DATA(7410,662),
		T_TIPO_DATA(8714,2996),
		T_TIPO_DATA(8503,2996),
		T_TIPO_DATA(8763,110161296),
		T_TIPO_DATA(8667,110161296),
		T_TIPO_DATA(8587,110161296),
		T_TIPO_DATA(8531,110161296),
		T_TIPO_DATA(7391,110161296),
		T_TIPO_DATA(8668,110161296),
		T_TIPO_DATA(8693,110161296),
		T_TIPO_DATA(8698,110161296),
		T_TIPO_DATA(8627,6964),
		T_TIPO_DATA(8470,6964),
		T_TIPO_DATA(8351,6964),
		T_TIPO_DATA(8455,13048),
		T_TIPO_DATA(8423,13048),
		T_TIPO_DATA(8424,13048),
		T_TIPO_DATA(8363,13048),
		T_TIPO_DATA(8594,13071),
		T_TIPO_DATA(8658,13071),
		T_TIPO_DATA(8584,13071),
		T_TIPO_DATA(8104,96),
		T_TIPO_DATA(8499,96),
		T_TIPO_DATA(9708,13090),
		T_TIPO_DATA(7407,13090),
		T_TIPO_DATA(8603,13090),
		T_TIPO_DATA(8553,13090),
		T_TIPO_DATA(8295,13090),
		T_TIPO_DATA(7371,13090),
		T_TIPO_DATA(8539,13090),
		T_TIPO_DATA(7368,13090),
		T_TIPO_DATA(8544,13090),
		T_TIPO_DATA(8684,13090),
		T_TIPO_DATA(8536,13090),
		T_TIPO_DATA(8542,13090),
		T_TIPO_DATA(8546,13090),
		T_TIPO_DATA(8278,13090),
		T_TIPO_DATA(8555,13090),
		T_TIPO_DATA(8601,13090),
		T_TIPO_DATA(8548,13090),
		T_TIPO_DATA(7380,13090),
		T_TIPO_DATA(8582,2658),
		T_TIPO_DATA(8662,2658),
		T_TIPO_DATA(8591,2658),
		T_TIPO_DATA(8598,2658),
		T_TIPO_DATA(7367,2658),
		T_TIPO_DATA(8438,373),
		T_TIPO_DATA(8347,396),
		T_TIPO_DATA(110155758,2164),
		T_TIPO_DATA(8532,2164),
		T_TIPO_DATA(8554,2164),
		T_TIPO_DATA(7374,2164),
		T_TIPO_DATA(8699,2164),
		T_TIPO_DATA(8518,2164),
		T_TIPO_DATA(8520,2164),
		T_TIPO_DATA(8678,2164),
		T_TIPO_DATA(8573,2164),
		T_TIPO_DATA(8592,2164),
		T_TIPO_DATA(8602,2164),
		T_TIPO_DATA(8609,2164),
		T_TIPO_DATA(8549,2164),
		T_TIPO_DATA(8556,2164),
		T_TIPO_DATA(8447,2164),
		T_TIPO_DATA(7587,2164),
		T_TIPO_DATA(7393,2164)); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

    
BEGIN		

	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	
	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
    LOOP
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
		V_PVE_ID := 0;

		DBMS_OUTPUT.PUT_LINE('[INFO]: INFORMAR MEDIADOR EN '||V_TEXT_TABLA);

		V_MSQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE PVE_COD_REM = '||V_TMP_TIPO_DATA(1)||' AND BORRADO = 0';
		EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

		IF V_COUNT = 1 THEN

			V_MSQL:= 'SELECT PVE_ID FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE PVE_COD_REM = '||V_TMP_TIPO_DATA(2)||' AND BORRADO = 0';
			EXECUTE IMMEDIATE V_MSQL INTO V_PVE_ID;

			IF V_PVE_ID != 0 THEN

				V_MSQL:= 'UPDATE '||V_ESQUEMA||'.'||V_TEXT_TABLA||' SET
							PVE_ID_MEDIADOR_REL = '||V_PVE_ID||',
							USUARIOMODIFICAR = '''||V_USU||''',
							FECHAMODIFICAR = SYSDATE
							WHERE PVE_COD_REM = '||V_TMP_TIPO_DATA(1)||' AND BORRADO = 0';
				EXECUTE IMMEDIATE V_MSQL;
				
				DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICAMOS PVE_ID_MEDIADOR_REL = '||V_TMP_TIPO_DATA(2)||' EN OFICINA CON PVE_COD_REM '||V_TMP_TIPO_DATA(1)||'');

			ELSE

				DBMS_OUTPUT.PUT_LINE('[INFO]: PROVEEDOR MEDIADOR '||V_TMP_TIPO_DATA(2)||' NO EXISTE O ESTA BORRADO');

			END IF;

		ELSE

			DBMS_OUTPUT.PUT_LINE('[INFO]: OFICINA CON CODIGO REM '||V_TMP_TIPO_DATA(1)||' NO EXISTE O ESTA BORRADO');

		END IF;

	END LOOP;

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN]');


EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;

/

EXIT