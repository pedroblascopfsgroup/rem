--/*
--##########################################
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20210317
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9253
--## PRODUCTO=NO
--##
--## Finalidad: Script informa area peticionaria trabajos
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_TEXT_TABLA VARCHAR2(27 CHAR) := 'ACT_TBJ_TRABAJO'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_USU VARCHAR2(30 CHAR) := 'REMVIP-9253'; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.
	V_COUNT NUMBER(16);

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
		-- 			NUM_TRABAJO  IRE_ID
		T_TIPO_DATA(924567811064,4),
		T_TIPO_DATA(916964388711,4),
		T_TIPO_DATA(924567807930,4),
		T_TIPO_DATA(924567807913,4),
		T_TIPO_DATA(924567807911,4),
		T_TIPO_DATA(924567807910,4),
		T_TIPO_DATA(924567807909,4),
		T_TIPO_DATA(916950103536,4),
		T_TIPO_DATA(924567807908,4),
		T_TIPO_DATA(924567807907,4),
		T_TIPO_DATA(916950103587,4),
		T_TIPO_DATA(924567807906,4),
		T_TIPO_DATA(916964301149,4),
		T_TIPO_DATA(916964300417,4),
		T_TIPO_DATA(916964300458,4),
		T_TIPO_DATA(916964300856,4),
		T_TIPO_DATA(924567807905,4),
		T_TIPO_DATA(916964302327,4),
		T_TIPO_DATA(916964301189,4),
		T_TIPO_DATA(916964302656,4),
		T_TIPO_DATA(924567807903,4),
		T_TIPO_DATA(924567807880,4),
		T_TIPO_DATA(924567807862,4),
		T_TIPO_DATA(924567808970,4),
		T_TIPO_DATA(916964303169,4),
		T_TIPO_DATA(916964302509,4),
		T_TIPO_DATA(924567807923,4),
		T_TIPO_DATA(924567807831,4),
		T_TIPO_DATA(916964304132,4),
		T_TIPO_DATA(916964305854,4),
		T_TIPO_DATA(924567807669,4),
		T_TIPO_DATA(916964306613,4),
		T_TIPO_DATA(916964307578,4),
		T_TIPO_DATA(924567803878,4),
		T_TIPO_DATA(916964378131,4),
		T_TIPO_DATA(916964308992,4),
		T_TIPO_DATA(916964309685,4),
		T_TIPO_DATA(916964309322,4),
		T_TIPO_DATA(916964310124,4),
		T_TIPO_DATA(916964310387,4),
		T_TIPO_DATA(916964309297,4),
		T_TIPO_DATA(916964309681,4),
		T_TIPO_DATA(916964309956,4),
		T_TIPO_DATA(916964310975,4),
		T_TIPO_DATA(916964309561,4),
		T_TIPO_DATA(916964379276,4),
		T_TIPO_DATA(916964311689,4),
		T_TIPO_DATA(916964379354,4),
		T_TIPO_DATA(916964311699,4),
		T_TIPO_DATA(916964378612,4),
		T_TIPO_DATA(916964378006,4),
		T_TIPO_DATA(916964313007,4),
		T_TIPO_DATA(916964378465,4),
		T_TIPO_DATA(916964312997,4),
		T_TIPO_DATA(916964312998,4),
		T_TIPO_DATA(916964378457,4),
		T_TIPO_DATA(916964378146,4),
		T_TIPO_DATA(916964378145,4),
		T_TIPO_DATA(916964378144,4),
		T_TIPO_DATA(916964378143,4),
		T_TIPO_DATA(916964377872,4),
		T_TIPO_DATA(916964337453,4),
		T_TIPO_DATA(916964308623,4),
		T_TIPO_DATA(916964309340,4),
		T_TIPO_DATA(916964333975,4),
		T_TIPO_DATA(916964341002,4),
		T_TIPO_DATA(916964345909,4),
		T_TIPO_DATA(916964345783,4),
		T_TIPO_DATA(916964345749,4),
		T_TIPO_DATA(916964336346,4),
		T_TIPO_DATA(916964344484,4),
		T_TIPO_DATA(916964318997,4),
		T_TIPO_DATA(916964319396,4),
		T_TIPO_DATA(916964340940,4),
		T_TIPO_DATA(916964343031,4),
		T_TIPO_DATA(916964340062,4),
		T_TIPO_DATA(916964341169,4),
		T_TIPO_DATA(916964340769,4),
		T_TIPO_DATA(916964320088,4),
		T_TIPO_DATA(916964320503,4),
		T_TIPO_DATA(916964320696,4),
		T_TIPO_DATA(916964319302,4),
		T_TIPO_DATA(916964338968,4),
		T_TIPO_DATA(916964338471,4),
		T_TIPO_DATA(916964338456,4),
		T_TIPO_DATA(916964324194,4),
		T_TIPO_DATA(916964324201,4),
		T_TIPO_DATA(916964324204,4),
		T_TIPO_DATA(916964324216,4),
		T_TIPO_DATA(916964324231,4),
		T_TIPO_DATA(916964324240,4),
		T_TIPO_DATA(916964324244,4),
		T_TIPO_DATA(916964324253,4),
		T_TIPO_DATA(916964324254,4),
		T_TIPO_DATA(916964324263,4),
		T_TIPO_DATA(916964324273,4),
		T_TIPO_DATA(916964324282,4),
		T_TIPO_DATA(916964324284,4),
		T_TIPO_DATA(916964324292,4),
		T_TIPO_DATA(916964324305,4),
		T_TIPO_DATA(916964324308,4),
		T_TIPO_DATA(916964324313,4),
		T_TIPO_DATA(916964324323,4),
		T_TIPO_DATA(916964324325,4),
		T_TIPO_DATA(916964324330,4),
		T_TIPO_DATA(916964324333,4),
		T_TIPO_DATA(916964324345,4),
		T_TIPO_DATA(916964324346,4),
		T_TIPO_DATA(916964324352,4),
		T_TIPO_DATA(916964324355,4),
		T_TIPO_DATA(916964324357,4),
		T_TIPO_DATA(916964324403,4),
		T_TIPO_DATA(916964324415,4),
		T_TIPO_DATA(916964324420,4),
		T_TIPO_DATA(916964324431,4),
		T_TIPO_DATA(916964324433,4),
		T_TIPO_DATA(916964324435,4),
		T_TIPO_DATA(916964324436,4),
		T_TIPO_DATA(916964324437,4),
		T_TIPO_DATA(916964324445,4),
		T_TIPO_DATA(916964324450,4),
		T_TIPO_DATA(916964324451,4),
		T_TIPO_DATA(916964324458,4),
		T_TIPO_DATA(916964324460,4),
		T_TIPO_DATA(916964324463,4),
		T_TIPO_DATA(916964324467,4),
		T_TIPO_DATA(916964324476,4),
		T_TIPO_DATA(916964324373,4),
		T_TIPO_DATA(916964324378,4),
		T_TIPO_DATA(916964324380,4),
		T_TIPO_DATA(916964324383,4),
		T_TIPO_DATA(916964324390,4),
		T_TIPO_DATA(916964324394,4),
		T_TIPO_DATA(916964324397,4),
		T_TIPO_DATA(916964324406,4),
		T_TIPO_DATA(916964324424,4),
		T_TIPO_DATA(916964324428,4),
		T_TIPO_DATA(916964324447,4),
		T_TIPO_DATA(916964324448,4),
		T_TIPO_DATA(916964324482,4),
		T_TIPO_DATA(916964324550,4),
		T_TIPO_DATA(916964324551,4),
		T_TIPO_DATA(916964324553,4),
		T_TIPO_DATA(916964324554,4),
		T_TIPO_DATA(916964324555,4),
		T_TIPO_DATA(916964324558,4),
		T_TIPO_DATA(916964324561,4),
		T_TIPO_DATA(916964324564,4),
		T_TIPO_DATA(916964324567,4),
		T_TIPO_DATA(916964324568,4),
		T_TIPO_DATA(916964324570,4),
		T_TIPO_DATA(916964324593,4),
		T_TIPO_DATA(916964324595,4),
		T_TIPO_DATA(916964324598,4),
		T_TIPO_DATA(916964324599,4),
		T_TIPO_DATA(916964324602,4),
		T_TIPO_DATA(916964324604,4),
		T_TIPO_DATA(916964324606,4),
		T_TIPO_DATA(916964324614,4),
		T_TIPO_DATA(916964324616,4),
		T_TIPO_DATA(916964324617,4),
		T_TIPO_DATA(916964324619,4),
		T_TIPO_DATA(916964324626,4),
		T_TIPO_DATA(916964324630,4),
		T_TIPO_DATA(916964324632,4),
		T_TIPO_DATA(916964324634,4),
		T_TIPO_DATA(916964324636,4),
		T_TIPO_DATA(916964324638,4),
		T_TIPO_DATA(916964324650,4),
		T_TIPO_DATA(916964324655,4),
		T_TIPO_DATA(916964324660,4),
		T_TIPO_DATA(916964324662,4),
		T_TIPO_DATA(916964324664,4),
		T_TIPO_DATA(916964324667,4),
		T_TIPO_DATA(916964324668,4),
		T_TIPO_DATA(916964324676,4),
		T_TIPO_DATA(916964324679,4),
		T_TIPO_DATA(916964324687,4),
		T_TIPO_DATA(916964324688,4),
		T_TIPO_DATA(916964324700,4),
		T_TIPO_DATA(916964324726,4),
		T_TIPO_DATA(916964324730,4),
		T_TIPO_DATA(916964324732,4),
		T_TIPO_DATA(916964324741,4),
		T_TIPO_DATA(916964324751,4),
		T_TIPO_DATA(916964324752,4),
		T_TIPO_DATA(916964324767,4),
		T_TIPO_DATA(916964324781,4),
		T_TIPO_DATA(916964324783,4),
		T_TIPO_DATA(916964324785,4),
		T_TIPO_DATA(916964324788,4),
		T_TIPO_DATA(916964324789,4),
		T_TIPO_DATA(916964324791,4),
		T_TIPO_DATA(916964324793,4),
		T_TIPO_DATA(916964324794,4),
		T_TIPO_DATA(916964324814,4),
		T_TIPO_DATA(916964338440,4),
		T_TIPO_DATA(916964338107,4),
		T_TIPO_DATA(916964337470,4),
		T_TIPO_DATA(916964336622,4),
		T_TIPO_DATA(916964325929,4),
		T_TIPO_DATA(916964326090,4),
		T_TIPO_DATA(916964326213,4),
		T_TIPO_DATA(916964326248,4),
		T_TIPO_DATA(916964336620,4),
		T_TIPO_DATA(916964336617,4),
		T_TIPO_DATA(916964326732,4),
		T_TIPO_DATA(916964310032,4),
		T_TIPO_DATA(916964336265,4),
		T_TIPO_DATA(916964328396,4),
		T_TIPO_DATA(916964334554,4),
		T_TIPO_DATA(916964334420,4),
		T_TIPO_DATA(916964333571,4),
		T_TIPO_DATA(916964333570,4),
		T_TIPO_DATA(916964333567,4),
		T_TIPO_DATA(916964333544,4),
		T_TIPO_DATA(916964327967,4),
		T_TIPO_DATA(916964333538,4),
		T_TIPO_DATA(916964333495,4),
		T_TIPO_DATA(916964333485,4),
		T_TIPO_DATA(916964333480,4),
		T_TIPO_DATA(916964328124,4),
		T_TIPO_DATA(916964333454,4),
		T_TIPO_DATA(916964333448,4),
		T_TIPO_DATA(916964333440,4),
		T_TIPO_DATA(916964333390,4),
		T_TIPO_DATA(916964327009,4),
		T_TIPO_DATA(916964333382,4),
		T_TIPO_DATA(916964333367,4),
		T_TIPO_DATA(916964331567,4),
		T_TIPO_DATA(916964333352,4),
		T_TIPO_DATA(916964331714,4),
		T_TIPO_DATA(916964332982,4),
		T_TIPO_DATA(916964332986,4),
		T_TIPO_DATA(916964333033,4),
		T_TIPO_DATA(916964333034,4),
		T_TIPO_DATA(916964333040,4),
		T_TIPO_DATA(916964333346,4),
		T_TIPO_DATA(916964333131,4),
		T_TIPO_DATA(916964333340,4),
		T_TIPO_DATA(916964333165,4),
		T_TIPO_DATA(916964333173,4),
		T_TIPO_DATA(916964333175,4),
		T_TIPO_DATA(916964333183,4),
		T_TIPO_DATA(916964333187,4),
		T_TIPO_DATA(916964333201,4),
		T_TIPO_DATA(916964333229,4),
		T_TIPO_DATA(916964333251,4),
		T_TIPO_DATA(916964333339,4),
		T_TIPO_DATA(916964340284,4),
		T_TIPO_DATA(916964333196,4)); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

    
BEGIN		

	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	
	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
    LOOP
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);

		DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICAR DD_IRE_ID EN '||V_TEXT_TABLA);

		V_MSQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE TBJ_NUM_TRABAJO = '||V_TMP_TIPO_DATA(1)||' AND BORRADO = 0';
		EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

		IF V_COUNT = 1 THEN

			V_MSQL:= 'UPDATE '||V_ESQUEMA||'.'||V_TEXT_TABLA||' SET
						DD_IRE_ID = '||V_TMP_TIPO_DATA(2)||',
						USUARIOMODIFICAR = '''||V_USU||''',
						FECHAMODIFICAR = SYSDATE
						WHERE TBJ_NUM_TRABAJO = '||V_TMP_TIPO_DATA(1)||' AND BORRADO = 0';
			EXECUTE IMMEDIATE V_MSQL;
			
			DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICAMOS DD_IRE_ID = '||V_TMP_TIPO_DATA(2)||' EN TRABAJO '||V_TMP_TIPO_DATA(1)||'');

		ELSE

			DBMS_OUTPUT.PUT_LINE('[INFO]: TRABAJO '||V_TMP_TIPO_DATA(1)||' NO EXISTE O ESTA BORRADO');

		END IF;

	END LOOP;

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN]');


EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;

/

EXIT