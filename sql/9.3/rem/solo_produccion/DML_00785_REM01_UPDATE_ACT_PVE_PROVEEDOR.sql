--/*
--##########################################
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20210406
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9383
--## PRODUCTO=NO
--##
--## Finalidad: Script informa mediador relacionado para oficinas
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_TEXT_TABLA VARCHAR2(27 CHAR) := 'ACT_PVE_PROVEEDOR'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_USU VARCHAR2(30 CHAR) := 'REMVIP-9383'; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.
	V_COUNT NUMBER(16);
	V_PVE_ID NUMBER(16);

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
		-- 		COD_OFI  COD_MED
		T_TIPO_DATA(7650,2296),
		T_TIPO_DATA(7662,9990167),
		T_TIPO_DATA(7400,662),
		T_TIPO_DATA(8772,973),
		T_TIPO_DATA(7417,3219),
		T_TIPO_DATA(7418,2339),
		T_TIPO_DATA(110116921,973),
		T_TIPO_DATA(110075199,2140),
		T_TIPO_DATA(110075176,2339),
		T_TIPO_DATA(9713,662),
		T_TIPO_DATA(110075157,973),
		T_TIPO_DATA(110075206,973),
		T_TIPO_DATA(110075216,973),
		T_TIPO_DATA(110075217,973),
		T_TIPO_DATA(8768,973),
		T_TIPO_DATA(8783,973),
		T_TIPO_DATA(8826,973),
		T_TIPO_DATA(110075311,2140),
		T_TIPO_DATA(110075173,2140),
		T_TIPO_DATA(110075175,2140),
		T_TIPO_DATA(110075289,2339),
		T_TIPO_DATA(110075250,2339),
		T_TIPO_DATA(110075165,2339),
		T_TIPO_DATA(8629,662),
		T_TIPO_DATA(8468,662),
		T_TIPO_DATA(7379,662),
		T_TIPO_DATA(110075310,973),
		T_TIPO_DATA(110075249,973),
		T_TIPO_DATA(110075259,973),
		T_TIPO_DATA(110075171,973),
		T_TIPO_DATA(110075200,973),
		T_TIPO_DATA(110075195,973),
		T_TIPO_DATA(110075189,973),
		T_TIPO_DATA(110075187,973),
		T_TIPO_DATA(110075156,973),
		T_TIPO_DATA(110075272,9990167),
		T_TIPO_DATA(110075269,9990167),
		T_TIPO_DATA(110075118,9990167),
		T_TIPO_DATA(110075126,9990167),
		T_TIPO_DATA(110075127,9990167),
		T_TIPO_DATA(110075133,9990167),
		T_TIPO_DATA(110075136,2296),
		T_TIPO_DATA(8704,9990167),
		T_TIPO_DATA(8705,9990167),
		T_TIPO_DATA(8647,2296),
		T_TIPO_DATA(8650,2296),
		T_TIPO_DATA(8661,9990167),
		T_TIPO_DATA(8566,9990167),
		T_TIPO_DATA(8471,154),
		T_TIPO_DATA(8488,9990167),
		T_TIPO_DATA(8491,9990167),
		T_TIPO_DATA(8492,9990167),
		T_TIPO_DATA(7362,154),
		T_TIPO_DATA(7370,2296),
		T_TIPO_DATA(7382,2296),
		T_TIPO_DATA(7392,9990167),
		T_TIPO_DATA(110075273,9990165),
		T_TIPO_DATA(8782,662),
		T_TIPO_DATA(8710,110080848),
		T_TIPO_DATA(8637,662),
		T_TIPO_DATA(8679,4298),
		T_TIPO_DATA(8456,110080848),
		T_TIPO_DATA(8457,110080848),
		T_TIPO_DATA(8460,662),
		T_TIPO_DATA(8469,110080848),
		T_TIPO_DATA(8487,3369),
		T_TIPO_DATA(8381,110080848),
		T_TIPO_DATA(8397,3369),
		T_TIPO_DATA(8426,9990165),
		T_TIPO_DATA(8431,110080848),
		T_TIPO_DATA(7363,3369),
		T_TIPO_DATA(7381,662),
		T_TIPO_DATA(7386,110080848),
		T_TIPO_DATA(7387,662),
		T_TIPO_DATA(7389,110080848),
		T_TIPO_DATA(7408,110080848),
		T_TIPO_DATA(7409,110080848),
		T_TIPO_DATA(7299,3369),
		T_TIPO_DATA(110075290,110098265),
		T_TIPO_DATA(110075283,110080847),
		T_TIPO_DATA(110075284,10011321),
		T_TIPO_DATA(110075282,2140),
		T_TIPO_DATA(110075314,110080847),
		T_TIPO_DATA(110075307,110098265),
		T_TIPO_DATA(110075308,110080847),
		T_TIPO_DATA(110075300,110098265),
		T_TIPO_DATA(110075238,10011321),
		T_TIPO_DATA(110075240,110080847),
		T_TIPO_DATA(110075241,2140),
		T_TIPO_DATA(110075243,2140),
		T_TIPO_DATA(110075245,10011321),
		T_TIPO_DATA(110075162,2140),
		T_TIPO_DATA(110075201,110098265),
		T_TIPO_DATA(110075236,10011321),
		T_TIPO_DATA(110075229,110080847),
		T_TIPO_DATA(110075225,10011321),
		T_TIPO_DATA(110075220,3219),
		T_TIPO_DATA(110075319,10011321),
		T_TIPO_DATA(110075285,110157073),
		T_TIPO_DATA(110075263,110157073),
		T_TIPO_DATA(110075316,973),
		T_TIPO_DATA(110075306,110160971),
		T_TIPO_DATA(110075301,2140),
		T_TIPO_DATA(110075299,1326),
		T_TIPO_DATA(110075253,973),
		T_TIPO_DATA(110075255,973),
		T_TIPO_DATA(110075258,973),
		T_TIPO_DATA(110075170,5743),
		T_TIPO_DATA(110075167,2140),
		T_TIPO_DATA(110075194,1326),
		T_TIPO_DATA(110075230,973),
		T_TIPO_DATA(110075235,1326),
		T_TIPO_DATA(110075221,973),
		T_TIPO_DATA(110075152,973),
		T_TIPO_DATA(110075312,2339),
		T_TIPO_DATA(110075262,2339),
		T_TIPO_DATA(110075174,5745),
		T_TIPO_DATA(110075182,2339),
		T_TIPO_DATA(110075178,2339),
		T_TIPO_DATA(110075202,2339),
		T_TIPO_DATA(110075204,2339),
		T_TIPO_DATA(110075209,2339),
		T_TIPO_DATA(110075213,2339),
		T_TIPO_DATA(110075214,2339),
		T_TIPO_DATA(110075215,110190325),
		T_TIPO_DATA(110075196,2339),
		T_TIPO_DATA(110075197,2339),
		T_TIPO_DATA(110075228,2339),
		T_TIPO_DATA(110075147,2339),
		T_TIPO_DATA(110075148,2339),
		T_TIPO_DATA(110075287,5743),
		T_TIPO_DATA(110075286,973),
		T_TIPO_DATA(110075280,973),
		T_TIPO_DATA(110075309,973),
		T_TIPO_DATA(110075248,973),
		T_TIPO_DATA(110075251,973),
		T_TIPO_DATA(110075252,973),
		T_TIPO_DATA(110075254,973),
		T_TIPO_DATA(110075256,973),
		T_TIPO_DATA(110075257,973),
		T_TIPO_DATA(110075260,973),
		T_TIPO_DATA(110075261,973),
		T_TIPO_DATA(110075181,5743),
		T_TIPO_DATA(110075169,973),
		T_TIPO_DATA(110075177,973),
		T_TIPO_DATA(110075164,973),
		T_TIPO_DATA(110075161,973),
		T_TIPO_DATA(110075207,973),
		T_TIPO_DATA(110075210,973),
		T_TIPO_DATA(110075219,973),
		T_TIPO_DATA(110075231,973),
		T_TIPO_DATA(110075320,973),
		T_TIPO_DATA(110075158,973),
		T_TIPO_DATA(8769,973),
		T_TIPO_DATA(110075288,3219),
		T_TIPO_DATA(110075315,126),
		T_TIPO_DATA(110075303,3219),
		T_TIPO_DATA(110075244,3219),
		T_TIPO_DATA(110075247,3219),
		T_TIPO_DATA(110075172,3219),
		T_TIPO_DATA(110075180,3219),
		T_TIPO_DATA(110075160,3219),
		T_TIPO_DATA(110075166,3219),
		T_TIPO_DATA(110075163,126),
		T_TIPO_DATA(110075203,3219),
		T_TIPO_DATA(110075218,3219),
		T_TIPO_DATA(110075192,3219),
		T_TIPO_DATA(110075193,3219),
		T_TIPO_DATA(110075222,3219),
		T_TIPO_DATA(110075234,3219),
		T_TIPO_DATA(110075227,3219),
		T_TIPO_DATA(110075232,3219),
		T_TIPO_DATA(110075155,3219),
		T_TIPO_DATA(110075295,3219),
		T_TIPO_DATA(110075281,5743),
		T_TIPO_DATA(110075313,973),
		T_TIPO_DATA(110075305,5743),
		T_TIPO_DATA(110075304,110190325),
		T_TIPO_DATA(110075302,973),
		T_TIPO_DATA(110075242,973),
		T_TIPO_DATA(110075246,5743),
		T_TIPO_DATA(110075179,110190325),
		T_TIPO_DATA(110075168,5743),
		T_TIPO_DATA(110075211,5743),
		T_TIPO_DATA(110075184,110190325),
		T_TIPO_DATA(110075233,973),
		T_TIPO_DATA(110075223,5743),
		T_TIPO_DATA(110075224,973),
		T_TIPO_DATA(110075151,5743),
		T_TIPO_DATA(110075149,973),
		T_TIPO_DATA(110075150,110190325),
		T_TIPO_DATA(110075153,110190325),
		T_TIPO_DATA(110075297,973),
		T_TIPO_DATA(110075318,5743),
		T_TIPO_DATA(110075141,6602),
		T_TIPO_DATA(110075142,110112906),
		T_TIPO_DATA(110075145,110112906),
		T_TIPO_DATA(110075146,6602),
		T_TIPO_DATA(110075279,6602),
		T_TIPO_DATA(110075278,3260),
		T_TIPO_DATA(110075274,3260),
		T_TIPO_DATA(110075115,3260),
		T_TIPO_DATA(110075120,6602),
		T_TIPO_DATA(110075121,3260),
		T_TIPO_DATA(110075122,110112906),
		T_TIPO_DATA(110075123,110112906),
		T_TIPO_DATA(110075129,6602),
		T_TIPO_DATA(110075131,6602),
		T_TIPO_DATA(110075113,6602),
		T_TIPO_DATA(110075239,6602),
		T_TIPO_DATA(8770,9990167),
		T_TIPO_DATA(8638,3260),
		T_TIPO_DATA(8642,6602),
		T_TIPO_DATA(8649,110112906),
		T_TIPO_DATA(8493,110112906),
		T_TIPO_DATA(8502,6602),
		T_TIPO_DATA(7377,3260),
		T_TIPO_DATA(7388,110112906),
		T_TIPO_DATA(7293,6602),
		T_TIPO_DATA(8643,662),
		T_TIPO_DATA(8644,662),
		T_TIPO_DATA(8628,662),
		T_TIPO_DATA(8462,662),
		T_TIPO_DATA(8472,662),
		T_TIPO_DATA(8490,662),
		T_TIPO_DATA(8380,662),
		T_TIPO_DATA(8400,662),
		T_TIPO_DATA(8268,662),
		T_TIPO_DATA(7361,662),
		T_TIPO_DATA(7378,662),
		T_TIPO_DATA(7402,662),
		T_TIPO_DATA(7406,662),
		T_TIPO_DATA(7278,662)); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

    
BEGIN		

	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	
	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
    LOOP
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
		V_PVE_ID := 0;

		DBMS_OUTPUT.PUT_LINE('[INFO]: INFORMAR MEDIADOR EN '||V_TEXT_TABLA);

		V_MSQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE PVE_COD_REM = '||V_TMP_TIPO_DATA(1)||' AND BORRADO = 0';
		EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

		IF V_COUNT = 1 THEN

			V_MSQL:= 'SELECT PVE_ID FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE PVE_COD_REM = '||V_TMP_TIPO_DATA(2)||' AND BORRADO = 0';
			EXECUTE IMMEDIATE V_MSQL INTO V_PVE_ID;

			IF V_PVE_ID != 0 THEN

				V_MSQL:= 'UPDATE '||V_ESQUEMA||'.'||V_TEXT_TABLA||' SET
							PVE_ID_MEDIADOR_REL = '||V_PVE_ID||',
							USUARIOMODIFICAR = '''||V_USU||''',
							FECHAMODIFICAR = SYSDATE
							WHERE PVE_COD_REM = '||V_TMP_TIPO_DATA(1)||' AND BORRADO = 0';
				EXECUTE IMMEDIATE V_MSQL;
				
				DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICAMOS PVE_ID_MEDIADOR_REL = '||V_TMP_TIPO_DATA(2)||' EN OFICINA CON PVE_COD_REM '||V_TMP_TIPO_DATA(1)||'');

			ELSE

				DBMS_OUTPUT.PUT_LINE('[INFO]: PROVEEDOR MEDIADOR '||V_TMP_TIPO_DATA(2)||' NO EXISTE O ESTA BORRADO');

			END IF;

		ELSE

			DBMS_OUTPUT.PUT_LINE('[INFO]: OFICINA CON CODIGO REM '||V_TMP_TIPO_DATA(1)||' NO EXISTE O ESTA BORRADO');

		END IF;

	END LOOP;

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN]');


EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;

/

EXIT