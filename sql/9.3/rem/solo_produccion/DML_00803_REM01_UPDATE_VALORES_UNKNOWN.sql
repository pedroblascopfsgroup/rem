--/*
--##########################################
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20210409
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9269
--## PRODUCTO=NO
--##
--## Finalidad: Script 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

ALTER SESSION SET NLS_NUMERIC_CHARACTERS = '.,';
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USU VARCHAR2(30 CHAR) := 'REMVIP-9269'; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.
	V_TEXT_TABLA_AUX_VAL VARCHAR2(50 CHAR):= 'AUX_REMVIP_9269_VALORACIONES';
	V_TEXT_TABLA_AUX_BAN VARCHAR2(50 CHAR):= 'AUX_REMVIP_9269_BANCARIO';
	V_TEXT_TABLA_AUX_ADJ1 VARCHAR2(50 CHAR):= 'AUX_REMVIP_9269_ADJUDICACION_1';
	V_TEXT_TABLA_AUX_ADJ2 VARCHAR2(50 CHAR):= 'AUX_REMVIP_9269_ADJUDICACION_2';
	V_TEXT_TABLA_AUX_ADJ3 VARCHAR2(50 CHAR):= 'AUX_REMVIP_9269_ADJUDICACION_3';
	V_TEXT_TABLA_AUX_NJD1 VARCHAR2(50 CHAR):= 'AUX_REMVIP_9269_NOJUDICIAL_1';
	V_TEXT_TABLA_AUX_NJD2 VARCHAR2(50 CHAR):= 'AUX_REMVIP_9269_NOJUDICIAL_2';
	V_TEXT_TABLA_AUX_NJD3 VARCHAR2(50 CHAR):= 'AUX_REMVIP_9269_NOJUDICIAL_3';
	V_COUNT NUMBER(16);
    
BEGIN		

	DBMS_OUTPUT.PUT_LINE('[INICIO]'); 

	
	--LIMPIAMOS LA TABLA DE NULOS PARA ACTUALIZAR

	V_MSQL:= 'DELETE FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_VAL||' WHERE IMPORTE = ''NULL''';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN LIMPIADO '||SQL%ROWCOUNT||' REGISTROS EN '||V_TEXT_TABLA_AUX_VAL||' CON IMPORTE NULO');   

	V_MSQL:= 'DELETE FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_BAN||' WHERE ABA_NEXPRIESGO = ''NULL''';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN LIMPIADO '||SQL%ROWCOUNT||' REGISTROS EN '||V_TEXT_TABLA_AUX_BAN||' CON ABA_NEXPRIESGO NULO'); 

	V_MSQL:= 'DELETE FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_NJD1||' WHERE ADN_FECHA_TITULO = ''NULL''';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN LIMPIADO '||SQL%ROWCOUNT||' REGISTROS EN '||V_TEXT_TABLA_AUX_ADJ1||' CON ADN_FECHA_TITULO NULO'); 

	V_MSQL:= 'DELETE FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_NJD2||' WHERE ADN_FECHA_FIRMA_TITULO = ''NULL''';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN LIMPIADO '||SQL%ROWCOUNT||' REGISTROS EN '||V_TEXT_TABLA_AUX_ADJ2||' CON ADN_FECHA_FIRMA_TITULO NULO'); 

	V_MSQL:= 'DELETE FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_NJD3||' WHERE ADN_NUM_REFERENCIA = ''NULL''';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN LIMPIADO '||SQL%ROWCOUNT||' REGISTROS EN '||V_TEXT_TABLA_AUX_ADJ3||' CON ADN_NUM_REFERENCIA NULO'); 

	V_MSQL:= 'DELETE FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_ADJ1||' WHERE BIE_ADJ_F_REA_POSESION = ''NULL''';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN LIMPIADO '||SQL%ROWCOUNT||' REGISTROS EN '||V_TEXT_TABLA_AUX_NJD1||' CON BIE_ADJ_F_REA_POSESION NULO'); 

	V_MSQL:= 'DELETE FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_ADJ2||' WHERE BIE_ADJ_F_DECRETO_FIRME = ''NULL''';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN LIMPIADO '||SQL%ROWCOUNT||' REGISTROS EN '||V_TEXT_TABLA_AUX_NJD2||' CON BIE_ADJ_F_DECRETO_FIRME NULO'); 

	V_MSQL:= 'DELETE FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_ADJ3||' WHERE BIE_ADJ_F_SOL_POSESION = ''NULL''';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN LIMPIADO '||SQL%ROWCOUNT||' REGISTROS EN '||V_TEXT_TABLA_AUX_NJD3||' CON BIE_ADJ_F_SOL_POSESION NULO'); 

	V_MSQL:= 'UPDATE '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_ADJ3||' SET BIE_ADJ_F_SOL_POSESION = REPLACE(BIE_ADJ_F_SOL_POSESION,'' 1:00'', '''') 
			WHERE BIE_ID IN (SELECT BIE_ID FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_ADJ3||' WHERE BIE_ADJ_F_SOL_POSESION LIKE ''% 1:00'')';
	EXECUTE IMMEDIATE V_MSQL;

	COMMIT;

	/*ACT_VAL_VALORACIONES*/

	V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.ACT_VAL_VALORACIONES T1 USING (
					SELECT DISTINCT VAL.VAL_ID, AUX.IMPORTE FROM '||V_ESQUEMA||'.ACT_VAL_VALORACIONES VAL
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = VAL.ACT_ID AND ACT.BORRADO = 0
					JOIN '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_VAL||' AUX ON AUX.ACT_NUM_ACTIVO = ACT.ACT_NUM_ACTIVO AND TIPO_PRECIO = 2
					WHERE VAL.BORRADO = 0 AND VAL.DD_TPC_ID = 2 AND VAL.VAL_IMPORTE != AUX.IMPORTE) T2
				ON (T1.VAL_ID = T2.VAL_ID)
				WHEN MATCHED THEN UPDATE SET 
				T1.VAL_IMPORTE = T2.IMPORTE,
				T1.USUARIOMODIFICAR = '''||V_USU||''',
				T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN MODIFICADO '||SQL%ROWCOUNT||' REGISTROS EN ACT_VAL_VALORACIONES PARA TIPO_PRECIO = 2');

	V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.ACT_VAL_VALORACIONES T1 USING (
					SELECT DISTINCT VAL.VAL_ID, AUX.IMPORTE FROM '||V_ESQUEMA||'.ACT_VAL_VALORACIONES VAL
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = VAL.ACT_ID AND ACT.BORRADO = 0
					JOIN '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_VAL||' AUX ON AUX.ACT_NUM_ACTIVO = ACT.ACT_NUM_ACTIVO AND TIPO_PRECIO = 4
					WHERE VAL.BORRADO = 0 AND VAL.DD_TPC_ID = 4 AND VAL.VAL_IMPORTE != AUX.IMPORTE) T2
				ON (T1.VAL_ID = T2.VAL_ID)
				WHEN MATCHED THEN UPDATE SET 
				T1.VAL_IMPORTE = T2.IMPORTE,
				T1.USUARIOMODIFICAR = '''||V_USU||''',
				T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN MODIFICADO '||SQL%ROWCOUNT||' REGISTROS EN ACT_VAL_VALORACIONES PARA TIPO_PRECIO = 4');
	
	/*ACT_ABA_ACTIVO_BANCARIO*/

	V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.ACT_ABA_ACTIVO_BANCARIO T1 USING (
					SELECT DISTINCT ABA.ABA_ID, AUX.ABA_NEXPRIESGO FROM '||V_ESQUEMA||'.ACT_ABA_ACTIVO_BANCARIO ABA
					JOIN '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_BAN||' AUX ON AUX.ABA_ID = ABA.ABA_ID
					WHERE ABA.BORRADO = 0 AND ABA.ABA_NEXPRIESGO != AUX.ABA_NEXPRIESGO) T2
				ON (T1.ABA_ID = T2.ABA_ID)
				WHEN MATCHED THEN UPDATE SET 
				T1.ABA_NEXPRIESGO = T2.ABA_NEXPRIESGO,
				T1.USUARIOMODIFICAR = '''||V_USU||''',
				T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN MODIFICADO '||SQL%ROWCOUNT||' REGISTROS EN ACT_ABA_ACTIVO_BANCARIO');

	/*ACT_ADN_ADJNOJUDICIAL*/

	V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.ACT_ADN_ADJNOJUDICIAL T1 USING (
					SELECT DISTINCT ADN.ADN_ID, AUX.ADN_FECHA_TITULO FROM '||V_ESQUEMA||'.ACT_ADN_ADJNOJUDICIAL ADN
					JOIN '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_NJD1||' AUX ON AUX.ADN_ID = ADN.ADN_ID
					WHERE ADN.BORRADO = 0 AND ADN.ADN_FECHA_TITULO != TO_DATE(AUX.ADN_FECHA_TITULO,''DD/MM/YYYY'')) T2
				ON (T1.ADN_ID = T2.ADN_ID)
				WHEN MATCHED THEN UPDATE SET 
				T1.ADN_FECHA_TITULO = TO_DATE(T2.ADN_FECHA_TITULO,''DD/MM/YYYY''),
				T1.USUARIOMODIFICAR = '''||V_USU||''',
				T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN MODIFICADO '||SQL%ROWCOUNT||' REGISTROS EN ACT_ADN_ADJNOJUDICIAL');

	V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.ACT_ADN_ADJNOJUDICIAL T1 USING (
					SELECT DISTINCT ADN.ADN_ID, AUX.ADN_FECHA_FIRMA_TITULO FROM '||V_ESQUEMA||'.ACT_ADN_ADJNOJUDICIAL ADN
					JOIN '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_NJD2||' AUX ON AUX.ADN_ID = ADN.ADN_ID
					WHERE ADN.BORRADO = 0 AND ADN.ADN_FECHA_FIRMA_TITULO != TO_DATE(AUX.ADN_FECHA_FIRMA_TITULO,''DD/MM/YYYY'')) T2
				ON (T1.ADN_ID = T2.ADN_ID)
				WHEN MATCHED THEN UPDATE SET 
				T1.ADN_FECHA_FIRMA_TITULO = TO_DATE(T2.ADN_FECHA_FIRMA_TITULO,''DD/MM/YYYY''),
				T1.USUARIOMODIFICAR = '''||V_USU||''',
				T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN MODIFICADO '||SQL%ROWCOUNT||' REGISTROS EN ACT_ADN_ADJNOJUDICIAL');

	V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.ACT_ADN_ADJNOJUDICIAL T1 USING (
					SELECT DISTINCT ADN.ADN_ID, AUX.ADN_NUM_REFERENCIA FROM '||V_ESQUEMA||'.ACT_ADN_ADJNOJUDICIAL ADN
					JOIN '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_NJD3||' AUX ON AUX.ADN_ID = ADN.ADN_ID
					WHERE ADN.BORRADO = 0 AND ADN.ADN_NUM_REFERENCIA != AUX.ADN_NUM_REFERENCIA) T2
				ON (T1.ADN_ID = T2.ADN_ID)
				WHEN MATCHED THEN UPDATE SET 
				T1.ADN_NUM_REFERENCIA = T2.ADN_NUM_REFERENCIA,
				T1.USUARIOMODIFICAR = '''||V_USU||''',
				T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN MODIFICADO '||SQL%ROWCOUNT||' REGISTROS EN ACT_ADN_ADJNOJUDICIAL');

	/*BIE_ADJ_ADJUDICACION*/

	V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.BIE_ADJ_ADJUDICACION T1 USING (
					SELECT DISTINCT BIE.BIE_ID, AUX.BIE_ADJ_F_REA_POSESION FROM '||V_ESQUEMA||'.BIE_ADJ_ADJUDICACION BIE
					JOIN '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_ADJ1||' AUX ON AUX.BIE_ID = BIE.BIE_ID
					WHERE BIE.BORRADO = 0 AND BIE.BIE_ADJ_F_REA_POSESION != TO_DATE(AUX.BIE_ADJ_F_REA_POSESION,''DD/MM/YYYY'')) T2
				ON (T1.BIE_ID = T2.BIE_ID)
				WHEN MATCHED THEN UPDATE SET 
				T1.BIE_ADJ_F_REA_POSESION = TO_DATE(T2.BIE_ADJ_F_REA_POSESION,''DD/MM/YYYY''),
				T1.USUARIOMODIFICAR = '''||V_USU||''',
				T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN MODIFICADO '||SQL%ROWCOUNT||' REGISTROS EN BIE_ADJ_ADJUDICACION');

	V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.BIE_ADJ_ADJUDICACION T1 USING (
					SELECT DISTINCT BIE.BIE_ID, AUX.BIE_ADJ_F_DECRETO_FIRME FROM '||V_ESQUEMA||'.BIE_ADJ_ADJUDICACION BIE
					JOIN '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_ADJ2||' AUX ON AUX.BIE_ID = BIE.BIE_ID
					WHERE BIE.BORRADO = 0 AND BIE.BIE_ADJ_F_DECRETO_FIRME != TO_DATE(AUX.BIE_ADJ_F_DECRETO_FIRME,''DD/MM/YYYY'')) T2
				ON (T1.BIE_ID = T2.BIE_ID)
				WHEN MATCHED THEN UPDATE SET 
				T1.BIE_ADJ_F_DECRETO_FIRME = TO_DATE(T2.BIE_ADJ_F_DECRETO_FIRME,''DD/MM/YYYY''),
				T1.USUARIOMODIFICAR = '''||V_USU||''',
				T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN MODIFICADO '||SQL%ROWCOUNT||' REGISTROS EN BIE_ADJ_ADJUDICACION');

	V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.BIE_ADJ_ADJUDICACION T1 USING (
					SELECT DISTINCT BIE.BIE_ID, AUX.BIE_ADJ_F_SOL_POSESION FROM '||V_ESQUEMA||'.BIE_ADJ_ADJUDICACION BIE
					JOIN '||V_ESQUEMA||'.'||V_TEXT_TABLA_AUX_ADJ3||' AUX ON AUX.BIE_ID = BIE.BIE_ID
					WHERE BIE.BORRADO = 0 AND BIE.BIE_ADJ_F_SOL_POSESION != TO_DATE(AUX.BIE_ADJ_F_SOL_POSESION,''DD/MM/YYYY'')) T2
				ON (T1.BIE_ID = T2.BIE_ID)
				WHEN MATCHED THEN UPDATE SET 
				T1.BIE_ADJ_F_SOL_POSESION = TO_DATE(T2.BIE_ADJ_F_SOL_POSESION,''DD/MM/YYYY''),
				T1.USUARIOMODIFICAR = '''||V_USU||''',
				T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;
	
	DBMS_OUTPUT.PUT_LINE('[INFO] SE HAN MODIFICADO '||SQL%ROWCOUNT||' REGISTROS EN BIE_ADJ_ADJUDICACION');

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;

/

EXIT