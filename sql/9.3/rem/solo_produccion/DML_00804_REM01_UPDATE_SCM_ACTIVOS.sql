--/*
--###########################################
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20210412
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-9451
--## PRODUCTO=NO
--## 
--## Finalidad: UPDATEAR SITUACION COMERCIAL ACTIVO 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--###########################################
----*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE
  V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
  V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
  V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
  V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
  V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
  ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
  ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
  V_USUARIO VARCHAR2(100 CHAR) := 'REMVIP-9451';

  V_COUNT_TOTAL NUMBER(16):=0;
  V_COUNT NUMBER(16):=0;
  
  TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
  TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    -- 	 			ACTIVO, SITUACION COMERCIAL 
   T_TIPO_DATA('7061560','05'),
    T_TIPO_DATA('7049973','05'),
    T_TIPO_DATA('7058037','05'),
    T_TIPO_DATA('7058069','05'),
    T_TIPO_DATA('7058054','05'),
    T_TIPO_DATA('7058046','05'),
    T_TIPO_DATA('7058045','05'),
    T_TIPO_DATA('7058053','05'),
    T_TIPO_DATA('7058063','05'),
    T_TIPO_DATA('7058030','05'),
    T_TIPO_DATA('7058036','05'),
    T_TIPO_DATA('7058043','05'),
    T_TIPO_DATA('7058029','05'),
    T_TIPO_DATA('7058047','05'),
    T_TIPO_DATA('7058021','05'),
    T_TIPO_DATA('7058068','05'),
    T_TIPO_DATA('7058062','05'),
    T_TIPO_DATA('7058064','05'),
    T_TIPO_DATA('7058044','05'),
    T_TIPO_DATA('7058027','05'),
    T_TIPO_DATA('7058031','05'),
    T_TIPO_DATA('7058028','05'),
    T_TIPO_DATA('7058040','05'),
    T_TIPO_DATA('7058038','05'),
    T_TIPO_DATA('7058060','05'),
    T_TIPO_DATA('7058048','05'),
    T_TIPO_DATA('7058061','05'),
    T_TIPO_DATA('7058039','05'),
    T_TIPO_DATA('7058022','05'),
    T_TIPO_DATA('7058024','05'),
    T_TIPO_DATA('7058050','05'),
    T_TIPO_DATA('7058052','05'),
    T_TIPO_DATA('7058051','05'),
    T_TIPO_DATA('7058056','05'),
    T_TIPO_DATA('7058055','05'),
    T_TIPO_DATA('7058049','05'),
    T_TIPO_DATA('7058023','05'),
    T_TIPO_DATA('7058035','05'),
    T_TIPO_DATA('7058033','05'),
    T_TIPO_DATA('7058034','05'),
    T_TIPO_DATA('7058032','05'),
    T_TIPO_DATA('7058042','05'),
    T_TIPO_DATA('7058067','05'),
    T_TIPO_DATA('7058066','05'),
    T_TIPO_DATA('7058065','05'),
    T_TIPO_DATA('7058026','05'),
    T_TIPO_DATA('7058057','05'),
    T_TIPO_DATA('7058041','05'),
    T_TIPO_DATA('7058059','05'),
    T_TIPO_DATA('7058025','05'),
    T_TIPO_DATA('7058058','05'),
    T_TIPO_DATA('7058105','05'),
    T_TIPO_DATA('7058079','05'),
    T_TIPO_DATA('7058080','05'),
    T_TIPO_DATA('7058111','05'),
    T_TIPO_DATA('7058095','05'),
    T_TIPO_DATA('7058071','05'),
    T_TIPO_DATA('7058081','05'),
    T_TIPO_DATA('7058082','05'),
    T_TIPO_DATA('7058073','05'),
    T_TIPO_DATA('7058093','05'),
    T_TIPO_DATA('7058086','05'),
    T_TIPO_DATA('7058097','05'),
    T_TIPO_DATA('7058099','05'),
    T_TIPO_DATA('7058098','05'),
    T_TIPO_DATA('7058100','05'),
    T_TIPO_DATA('7058112','05'),
    T_TIPO_DATA('7058072','05'),
    T_TIPO_DATA('7058096','05'),
    T_TIPO_DATA('7058083','05'),
    T_TIPO_DATA('7058094','05'),
    T_TIPO_DATA('7058104','05'),
    T_TIPO_DATA('7058109','05'),
    T_TIPO_DATA('7058089','05'),
    T_TIPO_DATA('7058110','05'),
    T_TIPO_DATA('7058101','05'),
    T_TIPO_DATA('7058106','05'),
    T_TIPO_DATA('7058102','05'),
    T_TIPO_DATA('7058090','05'),
    T_TIPO_DATA('7058078','05'),
    T_TIPO_DATA('7058108','05'),
    T_TIPO_DATA('7058075','05'),
    T_TIPO_DATA('7058103','05'),
    T_TIPO_DATA('7058076','05'),
    T_TIPO_DATA('7058114','05'),
    T_TIPO_DATA('7058085','05'),
    T_TIPO_DATA('7058107','05'),
    T_TIPO_DATA('7058077','05'),
    T_TIPO_DATA('7058113','05'),
    T_TIPO_DATA('7058074','05'),
    T_TIPO_DATA('7058118','05'),
    T_TIPO_DATA('7058091','05'),
    T_TIPO_DATA('7058084','05'),
    T_TIPO_DATA('7058115','05'),
    T_TIPO_DATA('7058092','05'),
    T_TIPO_DATA('7058117','05'),
    T_TIPO_DATA('7058116','05'),
    T_TIPO_DATA('7050814','05'),
    T_TIPO_DATA('7038015','05'),
    T_TIPO_DATA('7041282','05'),
    T_TIPO_DATA('7041286','05'),
    T_TIPO_DATA('7041281','05'),
    T_TIPO_DATA('7041283','05'),
    T_TIPO_DATA('7041284','05'),
    T_TIPO_DATA('7041285','05'),
    T_TIPO_DATA('7054983','05'),
    T_TIPO_DATA('7054968','05'),
    T_TIPO_DATA('7054969','05'),
    T_TIPO_DATA('7054986','05'),
    T_TIPO_DATA('7054987','05'),
    T_TIPO_DATA('7054990','05'),
    T_TIPO_DATA('7054993','05'),
    T_TIPO_DATA('7054958','05'),
    T_TIPO_DATA('7054959','05'),
    T_TIPO_DATA('7054961','05'),
    T_TIPO_DATA('7054992','05'),
    T_TIPO_DATA('7054966','05'),
    T_TIPO_DATA('7054967','05'),
    T_TIPO_DATA('7054963','05'),
    T_TIPO_DATA('7054957','05'),
    T_TIPO_DATA('7054960','05'),
    T_TIPO_DATA('7054962','05'),
    T_TIPO_DATA('7054965','05'),
    T_TIPO_DATA('7054970','05'),
    T_TIPO_DATA('7054978','05'),
    T_TIPO_DATA('7054991','05'),
    T_TIPO_DATA('7054974','05'),
    T_TIPO_DATA('7054980','05'),
    T_TIPO_DATA('7054982','05'),
    T_TIPO_DATA('7054984','05'),
    T_TIPO_DATA('7054985','05'),
    T_TIPO_DATA('7054988','05'),
    T_TIPO_DATA('7054973','05'),
    T_TIPO_DATA('7054976','05'),
    T_TIPO_DATA('7054977','05'),
    T_TIPO_DATA('7054979','05'),
    T_TIPO_DATA('7054971','05'),
    T_TIPO_DATA('7054964','05'),
    T_TIPO_DATA('7054981','05'),
    T_TIPO_DATA('7054989','05'),
    T_TIPO_DATA('7054956','05'),
    T_TIPO_DATA('7054972','05'),
    T_TIPO_DATA('7054975','05'),
    T_TIPO_DATA('7054995','05'),
    T_TIPO_DATA('7054994','05'),
    T_TIPO_DATA('7053183','05'),
    T_TIPO_DATA('7034304','05'),
    T_TIPO_DATA('7061024','05'),
    T_TIPO_DATA('7061026','05'),
    T_TIPO_DATA('7061033','05'),
    T_TIPO_DATA('7061032','05'),
    T_TIPO_DATA('7061042','05'),
    T_TIPO_DATA('7061043','05'),
    T_TIPO_DATA('7061025','05'),
    T_TIPO_DATA('7061031','05'),
    T_TIPO_DATA('7061034','05'),
    T_TIPO_DATA('7061041','05'),
    T_TIPO_DATA('7061030','05'),
    T_TIPO_DATA('7061037','05'),
    T_TIPO_DATA('7061027','05'),
    T_TIPO_DATA('7061035','05'),
    T_TIPO_DATA('7061039','05'),
    T_TIPO_DATA('7061044','05'),
    T_TIPO_DATA('7061028','05'),
    T_TIPO_DATA('7061040','05'),
    T_TIPO_DATA('7061036','05'),
    T_TIPO_DATA('7061029','05'),
    T_TIPO_DATA('7061038','05'),
    T_TIPO_DATA('7052358','05'),
    T_TIPO_DATA('7032762','05'),
    T_TIPO_DATA('7032763','05'),
    T_TIPO_DATA('7032764','05'),
    T_TIPO_DATA('7032753','05'),
    T_TIPO_DATA('7032756','05'),
    T_TIPO_DATA('7032751','05'),
    T_TIPO_DATA('7032752','05'),
    T_TIPO_DATA('7032755','05'),
    T_TIPO_DATA('7032754','05'),
    T_TIPO_DATA('7032750','05'),
    T_TIPO_DATA('7032757','05'),
    T_TIPO_DATA('7032759','05'),
    T_TIPO_DATA('7032765','05'),
    T_TIPO_DATA('7032767','05'),
    T_TIPO_DATA('7032760','05'),
    T_TIPO_DATA('7032766','05'),
    T_TIPO_DATA('7032758','05'),
    T_TIPO_DATA('7032761','05'),
    T_TIPO_DATA('7032768','05'),
    T_TIPO_DATA('7042783','05'),
    T_TIPO_DATA('7045553','05'),
    T_TIPO_DATA('7034384','05'),
    T_TIPO_DATA('7037393','05'),
    T_TIPO_DATA('7037396','05'),
    T_TIPO_DATA('7037390','05'),
    T_TIPO_DATA('7037384','05'),
    T_TIPO_DATA('7037389','05'),
    T_TIPO_DATA('7037383','05'),
    T_TIPO_DATA('7037378','05'),
    T_TIPO_DATA('7037379','05'),
    T_TIPO_DATA('7037370','05'),
    T_TIPO_DATA('7037371','05'),
    T_TIPO_DATA('7037374','05'),
    T_TIPO_DATA('7037375','05'),
    T_TIPO_DATA('7037366','05'),
    T_TIPO_DATA('7037367','05'),
    T_TIPO_DATA('7037369','05'),
    T_TIPO_DATA('7037372','05'),
    T_TIPO_DATA('7037368','05'),
    T_TIPO_DATA('7037365','05'),
    T_TIPO_DATA('7037387','05'),
    T_TIPO_DATA('7037392','05'),
    T_TIPO_DATA('7037377','05'),
    T_TIPO_DATA('7037380','05'),
    T_TIPO_DATA('7037381','05'),
    T_TIPO_DATA('7037386','05'),
    T_TIPO_DATA('7037373','05'),
    T_TIPO_DATA('7037376','05'),
    T_TIPO_DATA('7037391','05'),
    T_TIPO_DATA('7037382','05'),
    T_TIPO_DATA('7037385','05'),
    T_TIPO_DATA('7037388','05'),
    T_TIPO_DATA('7037399','05'),
    T_TIPO_DATA('7037397','05'),
    T_TIPO_DATA('7037401','05'),
    T_TIPO_DATA('7037402','05'),
    T_TIPO_DATA('7037404','05'),
    T_TIPO_DATA('7037400','05'),
    T_TIPO_DATA('7037403','05'),
    T_TIPO_DATA('7037398','05'),
    T_TIPO_DATA('7037405','05'),
    T_TIPO_DATA('7038004','05'),
    T_TIPO_DATA('7042242','05'),
    T_TIPO_DATA('7038041','05'),
    T_TIPO_DATA('7034241','05'),
    T_TIPO_DATA('7034235','05'),
    T_TIPO_DATA('7034239','05'),
    T_TIPO_DATA('7034255','05'),
    T_TIPO_DATA('7034246','05'),
    T_TIPO_DATA('7034248','05'),
    T_TIPO_DATA('7034238','05'),
    T_TIPO_DATA('7034252','05'),
    T_TIPO_DATA('7034245','05'),
    T_TIPO_DATA('7034240','05'),
    T_TIPO_DATA('7034254','05'),
    T_TIPO_DATA('7034236','05'),
    T_TIPO_DATA('7034250','05'),
    T_TIPO_DATA('7034251','05'),
    T_TIPO_DATA('7034243','05'),
    T_TIPO_DATA('7034244','05'),
    T_TIPO_DATA('7053955','05'),
    T_TIPO_DATA('7053954','05'),
    T_TIPO_DATA('7053953','05'),
    T_TIPO_DATA('7053952','05'),
    T_TIPO_DATA('7053951','05'),
    T_TIPO_DATA('7053950','05'),
    T_TIPO_DATA('7053949','05'),
    T_TIPO_DATA('7053948','05'),
    T_TIPO_DATA('7053947','05'),
    T_TIPO_DATA('7053946','05'),
    T_TIPO_DATA('7053944','05'),
    T_TIPO_DATA('7053945','05'),
    T_TIPO_DATA('7053939','05'),
    T_TIPO_DATA('7053941','05'),
    T_TIPO_DATA('7053937','05'),
    T_TIPO_DATA('7053938','05'),
    T_TIPO_DATA('7053940','05'),
    T_TIPO_DATA('7053942','05'),
    T_TIPO_DATA('7053943','05'),
    T_TIPO_DATA('7053936','05'),
    T_TIPO_DATA('7053935','05'),
    T_TIPO_DATA('7053934','05'),
    T_TIPO_DATA('7048439','05'),
    T_TIPO_DATA('7033503','05'),
    T_TIPO_DATA('7033488','05'),
    T_TIPO_DATA('7033485','05'),
    T_TIPO_DATA('7033469','05'),
    T_TIPO_DATA('7033492','05'),
    T_TIPO_DATA('7033497','05'),
    T_TIPO_DATA('7033484','05'),
    T_TIPO_DATA('7033479','05'),
    T_TIPO_DATA('7033473','05'),
    T_TIPO_DATA('7033489','05'),
    T_TIPO_DATA('7033491','05'),
    T_TIPO_DATA('7033486','05'),
    T_TIPO_DATA('7033472','05'),
    T_TIPO_DATA('7033476','05'),
    T_TIPO_DATA('7033501','05'),
    T_TIPO_DATA('7033480','05'),
    T_TIPO_DATA('7033475','05'),
    T_TIPO_DATA('7033477','05'),
    T_TIPO_DATA('7033502','05'),
    T_TIPO_DATA('7033471','05'),
    T_TIPO_DATA('7033474','05'),
    T_TIPO_DATA('7033490','05'),
    T_TIPO_DATA('7033493','05'),
    T_TIPO_DATA('7033494','05'),
    T_TIPO_DATA('7033482','05'),
    T_TIPO_DATA('7033487','05'),
    T_TIPO_DATA('7033498','05'),
    T_TIPO_DATA('7033478','05'),
    T_TIPO_DATA('7033481','05'),
    T_TIPO_DATA('7033483','05'),
    T_TIPO_DATA('7033496','05'),
    T_TIPO_DATA('7033495','05'),
    T_TIPO_DATA('7033499','05'),
    T_TIPO_DATA('7033500','05'),
    T_TIPO_DATA('7062993','05'),
    T_TIPO_DATA('7062994','05'),
    T_TIPO_DATA('7062995','05'),
    T_TIPO_DATA('7062996','05'),
    T_TIPO_DATA('7062997','05'),
    T_TIPO_DATA('7062998','05'),
    T_TIPO_DATA('7063028','05'),
    T_TIPO_DATA('7040958','05'),
    T_TIPO_DATA('7052231','05'),
    T_TIPO_DATA('7052226','05'),
    T_TIPO_DATA('7052224','05'),
    T_TIPO_DATA('7052215','05'),
    T_TIPO_DATA('7052214','05'),
    T_TIPO_DATA('7052212','05'),
    T_TIPO_DATA('7052213','05'),
    T_TIPO_DATA('7052211','05'),
    T_TIPO_DATA('7052210','05'),
    T_TIPO_DATA('7052208','05'),
    T_TIPO_DATA('7052206','05'),
    T_TIPO_DATA('7052207','05'),
    T_TIPO_DATA('7052205','05'),
    T_TIPO_DATA('7052204','05'),
    T_TIPO_DATA('7052192','05'),
    T_TIPO_DATA('7052200','05'),
    T_TIPO_DATA('7052195','05'),
    T_TIPO_DATA('7052187','05'),
    T_TIPO_DATA('7052190','05'),
    T_TIPO_DATA('7052198','05'),
    T_TIPO_DATA('7052199','05'),
    T_TIPO_DATA('7052202','05'),
    T_TIPO_DATA('7052196','05'),
    T_TIPO_DATA('7052197','05'),
    T_TIPO_DATA('7052201','05'),
    T_TIPO_DATA('7052194','05'),
    T_TIPO_DATA('7052191','05'),
    T_TIPO_DATA('7052189','05'),
    T_TIPO_DATA('7052203','05'),
    T_TIPO_DATA('7052188','05'),
    T_TIPO_DATA('7052193','05'),
    T_TIPO_DATA('7052222','05'),
    T_TIPO_DATA('7052209','05'),
    T_TIPO_DATA('7052219','05'),
    T_TIPO_DATA('7052216','05'),
    T_TIPO_DATA('7052217','05'),
    T_TIPO_DATA('7052218','05'),
    T_TIPO_DATA('7052220','05'),
    T_TIPO_DATA('7052221','05'),
    T_TIPO_DATA('7052223','05'),
    T_TIPO_DATA('7052225','05'),
    T_TIPO_DATA('7052227','05'),
    T_TIPO_DATA('7052228','05'),
    T_TIPO_DATA('7052229','05'),
    T_TIPO_DATA('7052230','05'),
    T_TIPO_DATA('7046891','05'),
    T_TIPO_DATA('7046896','05'),
    T_TIPO_DATA('7046893','05'),
    T_TIPO_DATA('7054263','05'),
    T_TIPO_DATA('7054262','05'),
    T_TIPO_DATA('7054260','05'),
    T_TIPO_DATA('7054261','05'),
    T_TIPO_DATA('7054259','05'),
    T_TIPO_DATA('7050339','05')

	); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');

	 
    -- LOOP para actualizar los valores en ACT_TBJ_TRABAJO -----------------------------------------------------------------
    DBMS_OUTPUT.PUT_LINE('[INFO]: UPDATE SITUACION COMERCIAL ACTIVO');
    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
      LOOP
      
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);

        V_COUNT_TOTAL:=V_COUNT_TOTAL+1;
    
        --Comprobamos el dato a insertar
        V_SQL := 'SELECT
						COUNT(1)
					FROM
						'||V_ESQUEMA||'.ACT_ACTIVO 
					WHERE
						ACT_NUM_ACTIVO =  '||TRIM(V_TMP_TIPO_DATA(1))||'';
				
        EXECUTE IMMEDIATE V_SQL INTO V_NUM_TABLAS;
        
        --Si existe realizamos otra comprobacion
        IF V_NUM_TABLAS > 0 THEN		

			DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICAMOS LA SITUACION COMERCIAL DEL ACTIVO '||TRIM(V_TMP_TIPO_DATA(1))||'');
			
				V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_ACTIVO
								SET
									DD_SCM_ID = (SELECT DD_SCM_ID FROM '||V_ESQUEMA||'.DD_SCM_SITUACION_COMERCIAL WHERE DD_SCM_CODIGO = '''||TRIM(V_TMP_TIPO_DATA(2))||'''),
									USUARIOMODIFICAR = '''||V_USUARIO||''',
									FECHAMODIFICAR = SYSDATE
							WHERE
								ACT_NUM_ACTIVO = '||TRIM(V_TMP_TIPO_DATA(1))||'';

				EXECUTE IMMEDIATE V_MSQL;

                V_COUNT:=V_COUNT+1;

			DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZADO CORRECTAMENTE LA SITUACIoN COMERCIAL DEL ACTIVO '||TRIM(V_TMP_TIPO_DATA(1))||'');
			
		--El activo no existe
		ELSE
			  DBMS_OUTPUT.PUT_LINE('[ERROR]:  LA SITUACION COMERCIAL DEL ACTIVO '''||TRIM(V_TMP_TIPO_DATA(1))||' NO HA SIDO ACTUALIZADA');
		END IF;
		
    END LOOP;
    
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN]:  LA SITUACION COMERCIAL DE LOS ACTIVOS HA SIDO ACTUALIZADA, ACTUALIZADOS '||V_COUNT||' DE '||V_COUNT_TOTAL||' ');

EXCEPTION

   WHEN OTHERS THEN
        err_num := SQLCODE;
        err_msg := SQLERRM;

        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
        DBMS_OUTPUT.put_line(err_msg);

        ROLLBACK;
        RAISE;          

END;

/

EXIT