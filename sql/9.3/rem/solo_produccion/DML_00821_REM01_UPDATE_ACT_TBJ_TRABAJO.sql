--/*
--##########################################
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20210421
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9535
--## PRODUCTO=NO
--##
--## Finalidad: Script iguala importe cliente y proveedor
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_TEXT_TABLA VARCHAR2(27 CHAR) := 'ACT_TBJ_TRABAJO'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_USU VARCHAR2(30 CHAR) := 'REMVIP-9535'; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.
	V_COUNT NUMBER(16);
	V_TBJ_ID NUMBER(16);

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
		-- 			NUM_TRABAJO  
		T_TIPO_DATA(913145600001),
		T_TIPO_DATA(915779900001),
		T_TIPO_DATA(916295700001),
		T_TIPO_DATA(916950106731),
		T_TIPO_DATA(916964304607),
		T_TIPO_DATA(916964306376),
		T_TIPO_DATA(916964337952),
		T_TIPO_DATA(916964342363),
		T_TIPO_DATA(916964350532),
		T_TIPO_DATA(916964353070),
		T_TIPO_DATA(916964363446),
		T_TIPO_DATA(916964365068),
		T_TIPO_DATA(916964366162),
		T_TIPO_DATA(916964367437),
		T_TIPO_DATA(916964370053),
		T_TIPO_DATA(916964370157),
		T_TIPO_DATA(916964370212),
		T_TIPO_DATA(916964370781),
		T_TIPO_DATA(916964377350),
		T_TIPO_DATA(916964377582),
		T_TIPO_DATA(916964377918),
		T_TIPO_DATA(916964380423),
		T_TIPO_DATA(916964380477),
		T_TIPO_DATA(916964382042),
		T_TIPO_DATA(916964382046),
		T_TIPO_DATA(916964382050),
		T_TIPO_DATA(916964382208),
		T_TIPO_DATA(916964382209),
		T_TIPO_DATA(916964382558),
		T_TIPO_DATA(916964382790),
		T_TIPO_DATA(916964383567),
		T_TIPO_DATA(916964383914),
		T_TIPO_DATA(916964384564),
		T_TIPO_DATA(916964385791),
		T_TIPO_DATA(916964385828),
		T_TIPO_DATA(916964385896),
		T_TIPO_DATA(916964386161),
		T_TIPO_DATA(916964386261),
		T_TIPO_DATA(916964387146),
		T_TIPO_DATA(916964387534),
		T_TIPO_DATA(916964388393),
		T_TIPO_DATA(916964388933),
		T_TIPO_DATA(916964389719),
		T_TIPO_DATA(916964390320),
		T_TIPO_DATA(916964390878),
		T_TIPO_DATA(916964391136),
		T_TIPO_DATA(916964391368),
		T_TIPO_DATA(924567803531),
		T_TIPO_DATA(924567803833),
		T_TIPO_DATA(924567804360),
		T_TIPO_DATA(924567804362),
		T_TIPO_DATA(924567805938),
		T_TIPO_DATA(924567806483),
		T_TIPO_DATA(924567806486),
		T_TIPO_DATA(924567806489),
		T_TIPO_DATA(924567806713),
		T_TIPO_DATA(924567806788),
		T_TIPO_DATA(924567807671),
		T_TIPO_DATA(924567808127),
		T_TIPO_DATA(924567808131),
		T_TIPO_DATA(924567808608),
		T_TIPO_DATA(924567809341),
		T_TIPO_DATA(924567809688),
		T_TIPO_DATA(924567810027),
		T_TIPO_DATA(924567810211),
		T_TIPO_DATA(924567810794),
		T_TIPO_DATA(924567810808),
		T_TIPO_DATA(924567810815),
		T_TIPO_DATA(924567810966),
		T_TIPO_DATA(924567811027),
		T_TIPO_DATA(924567811812),
		T_TIPO_DATA(924567812519),
		T_TIPO_DATA(924567812879),
		T_TIPO_DATA(924567813041),
		T_TIPO_DATA(924567813264),
		T_TIPO_DATA(924567813674),
		T_TIPO_DATA(924567813701),
		T_TIPO_DATA(924567813706),
		T_TIPO_DATA(924567813710),
		T_TIPO_DATA(924567813736),
		T_TIPO_DATA(924567814773),
		T_TIPO_DATA(924567815155),
		T_TIPO_DATA(924567815876),
		T_TIPO_DATA(924567816024),
		T_TIPO_DATA(924567816149),
		T_TIPO_DATA(924567816196),
		T_TIPO_DATA(924567816446),
		T_TIPO_DATA(924567816869),
		T_TIPO_DATA(924567816890),
		T_TIPO_DATA(924567816977),
		T_TIPO_DATA(924567817703),
		T_TIPO_DATA(924567818504),
		T_TIPO_DATA(924567818640),
		T_TIPO_DATA(924567818665),
		T_TIPO_DATA(924567818955),
		T_TIPO_DATA(924567818968),
		T_TIPO_DATA(924567819234),
		T_TIPO_DATA(924567819886),
		T_TIPO_DATA(924567819894),
		T_TIPO_DATA(924567819901),
		T_TIPO_DATA(924567819906),
		T_TIPO_DATA(924567820162),
		T_TIPO_DATA(924567820627),
		T_TIPO_DATA(924567820629),
		T_TIPO_DATA(924567820721),
		T_TIPO_DATA(924567820906),
		T_TIPO_DATA(924567820909),
		T_TIPO_DATA(924567821147),
		T_TIPO_DATA(924567821344),
		T_TIPO_DATA(924567821555),
		T_TIPO_DATA(924567821781),
		T_TIPO_DATA(924567822410),
		T_TIPO_DATA(924567822604),
		T_TIPO_DATA(924567822787),
		T_TIPO_DATA(924567822828),
		T_TIPO_DATA(924567823468),
		T_TIPO_DATA(924567824455),
		T_TIPO_DATA(924567824951),
		T_TIPO_DATA(924567825199),
		T_TIPO_DATA(924567825706),
		T_TIPO_DATA(924567826291),
		T_TIPO_DATA(924567826442),
		T_TIPO_DATA(924567826546),
		T_TIPO_DATA(924567827699),
		T_TIPO_DATA(924567828471),
		T_TIPO_DATA(924567828779),
		T_TIPO_DATA(924567829001),
		T_TIPO_DATA(924567829953),
		T_TIPO_DATA(924567830366),
		T_TIPO_DATA(924567830727),
		T_TIPO_DATA(924567831907),
		T_TIPO_DATA(924567832024),
		T_TIPO_DATA(924567832435),
		T_TIPO_DATA(924567832533),
		T_TIPO_DATA(924567834165),
		T_TIPO_DATA(924567835357),
		T_TIPO_DATA(924567836417)); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

    
BEGIN		

	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	
	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
    LOOP
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);

		V_TBJ_ID:= 0;

		DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICAR IMPORTE TRABAJOS, PRESUPUESTOS Y TARIFAS EN '||V_TEXT_TABLA);

		V_MSQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE TBJ_NUM_TRABAJO = '||V_TMP_TIPO_DATA(1)||' AND BORRADO = 0';
		EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

		IF V_COUNT = 1 THEN

			V_MSQL:= 'SELECT TBJ_ID FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE TBJ_NUM_TRABAJO = '||V_TMP_TIPO_DATA(1)||' AND BORRADO = 0';
			EXECUTE IMMEDIATE V_MSQL INTO V_TBJ_ID;

			V_MSQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_PRT_PRESUPUESTO_TRABAJO WHERE TBJ_ID = '||V_TBJ_ID||' AND BORRADO = 0 AND PRT_IMPORTE_CLIENTE IS NULL';
			EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

			IF V_COUNT > 0 THEN

				V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.ACT_PRT_PRESUPUESTO_TRABAJO T1 USING (
							SELECT PRT_ID, PRT_IMPORTE FROM '||V_ESQUEMA||'.ACT_PRT_PRESUPUESTO_TRABAJO 
							WHERE TBJ_ID = '||V_TBJ_ID||' AND BORRADO = 0 AND PRT_IMPORTE_CLIENTE IS NULL) T2
							ON (T1.PRT_ID = T2.PRT_ID)
							WHEN MATCHED THEN UPDATE SET
							T1.PRT_IMPORTE_CLIENTE = T2.PRT_IMPORTE,
							T1.USUARIOMODIFICAR = '''||V_USU||''',
							T1.FECHAMODIFICAR = SYSDATE';
				EXECUTE IMMEDIATE V_MSQL;
				
				DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICAMOS PRT_IMPORTE_CLIENTE = PRT_IMPORTE EN PRESUPUESTO DE TRABAJO '||V_TMP_TIPO_DATA(1)||'');

			ELSE

				DBMS_OUTPUT.PUT_LINE('[INFO]: TRABAJO '||V_TMP_TIPO_DATA(1)||' NO TIENE PRESUPUESTO O ESTA CORRECTO');

			END IF;

			V_MSQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_TCT_TRABAJO_CFGTARIFA WHERE TBJ_ID = '||V_TBJ_ID||' AND BORRADO = 0 AND TCT_PRECIO_UNITARIO != TCT_PRECIO_UNITARIO_CLIENTE';
			EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

			IF V_COUNT > 0 THEN

				V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.ACT_TCT_TRABAJO_CFGTARIFA T1 USING (
							SELECT TCT_ID, TCT_PRECIO_UNITARIO FROM '||V_ESQUEMA||'.ACT_TCT_TRABAJO_CFGTARIFA 
							WHERE TBJ_ID = '||V_TBJ_ID||' AND BORRADO = 0 AND TCT_PRECIO_UNITARIO != TCT_PRECIO_UNITARIO_CLIENTE) T2
							ON (T1.TCT_ID = T2.TCT_ID)
							WHEN MATCHED THEN UPDATE SET
							T1.TCT_PRECIO_UNITARIO_CLIENTE = T2.TCT_PRECIO_UNITARIO,
							T1.USUARIOMODIFICAR = '''||V_USU||''',
							T1.FECHAMODIFICAR = SYSDATE';
				EXECUTE IMMEDIATE V_MSQL;
				
				DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICAMOS TCT_PRECIO_UNITARIO_CLIENTE = TCT_PRECIO_UNITARIO EN TARIFA DE TRABAJO '||V_TMP_TIPO_DATA(1)||'');

			ELSE

				DBMS_OUTPUT.PUT_LINE('[INFO]: TRABAJO '||V_TMP_TIPO_DATA(1)||' NO TIENE TARIFA O ESTA CORRECTA');

			END IF;

			V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.'||V_TEXT_TABLA||' T1 USING (
						SELECT DISTINCT TBJ_ID, TBJ_IMPORTE_PRESUPUESTO FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||'
						WHERE TBJ_ID = '||V_TBJ_ID||' AND BORRADO = 0
					) T2
					ON (T1.TBJ_ID = T2.TBJ_ID)
					WHEN MATCHED THEN UPDATE SET
					T1.TBJ_IMPORTE_TOTAL = T2.TBJ_IMPORTE_PRESUPUESTO,
					USUARIOMODIFICAR = '''||V_USU||''',
					FECHAMODIFICAR = SYSDATE';
			EXECUTE IMMEDIATE V_MSQL;

			DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICAMOS TBJ_IMPORTE_TOTAL = TBJ_IMPORTE_PRESUPUESTO EN TRABAJO '||V_TMP_TIPO_DATA(1)||'');

		ELSE

			DBMS_OUTPUT.PUT_LINE('[INFO]: TRABAJO '||V_TMP_TIPO_DATA(1)||' NO EXISTE O ESTA BORRADO');

		END IF;

	END LOOP;

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN]');


EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;

/

EXIT