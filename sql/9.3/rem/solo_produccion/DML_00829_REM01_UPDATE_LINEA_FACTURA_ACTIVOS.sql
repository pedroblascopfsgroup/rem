--/*
--######################################### 
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20210430
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9613
--## PRODUCTO=NO
--##            
--## INSTRUCCIONES:  ACTUALIZAR LINEA FACTURA ACTIVOS BBVA
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.     
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USUARIO VARCHAR2(100 CHAR):='REMVIP-9613'; --Vble. auxiliar para almacenar el usuario
    V_TABLA VARCHAR2(100 CHAR) :='ACT_BBVA_ACTIVOS'; --Vble. auxiliar para almacenar la tabla a insertar
    
	
    V_ID NUMBER(16); --Vble. Para almacenar el id del tramite a actualizar    
    
    V_COUNT NUMBER(16):=0; --Vble. Para contar cuantos registros se han actualizado correctamente
    V_COUNT_TOTAL NUMBER(16):=0; --Vble. Para contar el total de registros de la iteracion


 TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(32000 CHAR);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
        --BBVA_LINEA_FACTURA    BBVA_NUM_ACTIVO
        T_TIPO_DATA('9999132623','525205'),
        T_TIPO_DATA('9999132624','526626'),
        T_TIPO_DATA('9999132625','525944'),
        T_TIPO_DATA('9999132626','517480'),
        T_TIPO_DATA('9999132627','523864'),
        T_TIPO_DATA('9999132628','528274'),
        T_TIPO_DATA('9999132629','529121'),
        T_TIPO_DATA('9999132630','528654'),
        T_TIPO_DATA('9999132631','531349'),
        T_TIPO_DATA('9999132632','531477'),
        T_TIPO_DATA('9999132633','531391'),
        T_TIPO_DATA('9999132634','522136'),
        T_TIPO_DATA('9999132635','530172'),
        T_TIPO_DATA('9999132636','273241'),
        T_TIPO_DATA('1500004365','820707'),
        T_TIPO_DATA('1500004366','820711'),
        T_TIPO_DATA('1500004369','820722'),
        T_TIPO_DATA('1500004370','820725'),
        T_TIPO_DATA('1500004381','820762'),
        T_TIPO_DATA('1500004383','820768'),
        T_TIPO_DATA('1500004384','820771'),
        T_TIPO_DATA('1500004385','820774'),
        T_TIPO_DATA('1500004388','820783'),
        T_TIPO_DATA('1500004389','820786'),
        T_TIPO_DATA('1500004394','820801'),
        T_TIPO_DATA('1500004397','820813'),
        T_TIPO_DATA('1500004398','820816'),
        T_TIPO_DATA('1500004400','820822'),
        T_TIPO_DATA('1500004401','820825'),
        T_TIPO_DATA('1500004408','820847'),
        T_TIPO_DATA('1500004409','820851'),
        T_TIPO_DATA('1500004410','820854'),
        T_TIPO_DATA('1500004413','820863'),
        T_TIPO_DATA('1500004415','820869'),
        T_TIPO_DATA('1500004416','820872'),
        T_TIPO_DATA('1500004418','820878'),
        T_TIPO_DATA('1500004419','820881'),
        T_TIPO_DATA('1500004420','820884'),
        T_TIPO_DATA('1500004421','820887'),
        T_TIPO_DATA('1500004422','820890'),
        T_TIPO_DATA('1500004423','820893'),
        T_TIPO_DATA('1500004424','820896'),
        T_TIPO_DATA('1500004425','820900'),
        T_TIPO_DATA('1500004426','820904'),
        T_TIPO_DATA('1500004427','820909'),
        T_TIPO_DATA('1500004428','820910'),
        T_TIPO_DATA('1500004429','820912'),
        T_TIPO_DATA('1500004430','820913'),
        T_TIPO_DATA('1500004436','825974'),
        T_TIPO_DATA('1500004438','825982'),
        T_TIPO_DATA('1500004439','825986'),
        T_TIPO_DATA('1500004440','825989'),
        T_TIPO_DATA('1500004441','825992'),
        T_TIPO_DATA('1500004442','825995'),
        T_TIPO_DATA('1500004443','825998'),
        T_TIPO_DATA('1500004445','826004'),
        T_TIPO_DATA('1500004448','826013'),
        T_TIPO_DATA('1500004449','826016'),
        T_TIPO_DATA('1500004450','826019'),
        T_TIPO_DATA('1500004454','826031'),
        T_TIPO_DATA('1500004455','826034'),
        T_TIPO_DATA('1500004456','826037'),
        T_TIPO_DATA('1500004462','826053'),
        T_TIPO_DATA('1500004463','826055'),
        T_TIPO_DATA('1500004465','826060'),
        T_TIPO_DATA('1500004469','826070'),
        T_TIPO_DATA('1500004471','826074'),
        T_TIPO_DATA('1500004473','826079'),
        T_TIPO_DATA('1500004474','826081'),
        T_TIPO_DATA('1500004478','826092'),
        T_TIPO_DATA('1500004482','826101'),
        T_TIPO_DATA('1500004483','826103'),
        T_TIPO_DATA('1500004489','826117'),
        T_TIPO_DATA('1500004491','826121'),
        T_TIPO_DATA('1500004492','826123'),
        T_TIPO_DATA('1500004495','826130'),
        T_TIPO_DATA('1500004499','826140'),
        T_TIPO_DATA('1500004501','826144'),
        T_TIPO_DATA('1500004502','826146'),
        T_TIPO_DATA('1500004503','826149'),
        T_TIPO_DATA('1500004509','826163'),
        T_TIPO_DATA('1500004515','826176'),
        T_TIPO_DATA('1500004517','826182'),
        T_TIPO_DATA('1500004519','826186'),
        T_TIPO_DATA('1500004522','826195'),
        T_TIPO_DATA('1500004523','826197'),
        T_TIPO_DATA('1500004526','826205'),
        T_TIPO_DATA('1500004529','826211'),
        T_TIPO_DATA('1500004536','826229'),
        T_TIPO_DATA('1500004539','826235'),
        T_TIPO_DATA('1500004541','826243'),
        T_TIPO_DATA('1500004542','826244'),
        T_TIPO_DATA('1500004543','826245'),
        T_TIPO_DATA('1500004546','826248'),
        T_TIPO_DATA('1500004547','826249'),
        T_TIPO_DATA('1500004548','826250'),
        T_TIPO_DATA('1500004549','831737'),
        T_TIPO_DATA('1500004550','831738'),
        T_TIPO_DATA('1500004551','831739'),
        T_TIPO_DATA('1500004552','831740'),
        T_TIPO_DATA('1500004553','831741'),
        T_TIPO_DATA('1500004554','831742'),
        T_TIPO_DATA('1500004555','831743'),
        T_TIPO_DATA('1500004556','831744'),
        T_TIPO_DATA('1500004557','831745'),
        T_TIPO_DATA('1500004558','831746'),
        T_TIPO_DATA('1500004559','831747'),
        T_TIPO_DATA('1500004560','831748'),
        T_TIPO_DATA('1500004561','831749'),
        T_TIPO_DATA('1500004562','831750'),
        T_TIPO_DATA('1500004563','831751'),
        T_TIPO_DATA('1500004564','831752'),
        T_TIPO_DATA('1500004565','831753'),
        T_TIPO_DATA('1500004566','831754'),
        T_TIPO_DATA('1500004567','831755'),
        T_TIPO_DATA('1500004568','831756'),
        T_TIPO_DATA('1500004569','831757'),
        T_TIPO_DATA('1500004570','831758'),
        T_TIPO_DATA('1500004571','831759'),
        T_TIPO_DATA('1500004572','831760'),
        T_TIPO_DATA('1500004573','831761'),
        T_TIPO_DATA('1500004574','831762'),
        T_TIPO_DATA('1500004575','831646'),
        T_TIPO_DATA('1500004576','831647'),
        T_TIPO_DATA('1500004577','831648'),
        T_TIPO_DATA('1500004578','831649'),
        T_TIPO_DATA('1500004579','831650'),
        T_TIPO_DATA('1500004580','831651'),
        T_TIPO_DATA('1500004581','831652'),
        T_TIPO_DATA('1500004582','831653'),
        T_TIPO_DATA('1500004583','831654'),
        T_TIPO_DATA('1500004584','831655'),
        T_TIPO_DATA('1500004585','831656'),
        T_TIPO_DATA('1500004586','831657'),
        T_TIPO_DATA('1500004587','831658'),
        T_TIPO_DATA('1500004588','831659'),
        T_TIPO_DATA('1500004589','831660'),
        T_TIPO_DATA('1500004590','831661'),
        T_TIPO_DATA('1500004591','831662'),
        T_TIPO_DATA('1500004592','831663'),
        T_TIPO_DATA('1500004593','831664'),
        T_TIPO_DATA('1500004594','831665'),
        T_TIPO_DATA('1500004595','831666'),
        T_TIPO_DATA('1500004596','831667'),
        T_TIPO_DATA('1500004597','831668'),
        T_TIPO_DATA('1500004598','831669'),
        T_TIPO_DATA('1500004599','831670'),
        T_TIPO_DATA('1500004600','831671'),
        T_TIPO_DATA('1500004601','831672'),
        T_TIPO_DATA('1500004602','831673'),
        T_TIPO_DATA('1500004603','831674'),
        T_TIPO_DATA('1500004604','831675'),
        T_TIPO_DATA('1500004605','831676'),
        T_TIPO_DATA('1500004606','831677'),
        T_TIPO_DATA('1500004607','831678'),
        T_TIPO_DATA('1500004608','831679'),
        T_TIPO_DATA('1500004609','831680'),
        T_TIPO_DATA('1500004610','831681'),
        T_TIPO_DATA('1500004611','831682'),
        T_TIPO_DATA('1500004612','831683'),
        T_TIPO_DATA('1500004613','831684'),
        T_TIPO_DATA('1500004614','831685'),
        T_TIPO_DATA('1500004615','831686'),
        T_TIPO_DATA('1500004616','831687'),
        T_TIPO_DATA('1500004617','831688'),
        T_TIPO_DATA('1500004618','831689'),
        T_TIPO_DATA('1500004619','831690'),
        T_TIPO_DATA('1500004620','831691'),
        T_TIPO_DATA('1500004621','831692'),
        T_TIPO_DATA('1500004622','831693'),
        T_TIPO_DATA('1500004623','831694'),
        T_TIPO_DATA('1500004624','831695'),
        T_TIPO_DATA('1500004625','831696'),
        T_TIPO_DATA('1500004626','831697'),
        T_TIPO_DATA('1500004627','831698'),
        T_TIPO_DATA('1500004628','831699'),
        T_TIPO_DATA('1500004629','831700'),
        T_TIPO_DATA('1500004630','831701'),
        T_TIPO_DATA('1500004631','831702'),
        T_TIPO_DATA('1500004632','831703'),
        T_TIPO_DATA('1500004633','831704'),
        T_TIPO_DATA('1500004634','831705'),
        T_TIPO_DATA('1500004635','831706'),
        T_TIPO_DATA('1500004636','831707'),
        T_TIPO_DATA('1500004637','831708'),
        T_TIPO_DATA('1500004638','831709'),
        T_TIPO_DATA('1500004639','831710'),
        T_TIPO_DATA('1500004640','831711'),
        T_TIPO_DATA('1500004641','831712'),
        T_TIPO_DATA('1500004642','831713'),
        T_TIPO_DATA('1500004643','831714'),
        T_TIPO_DATA('1500004644','831715'),
        T_TIPO_DATA('1500004645','831716'),
        T_TIPO_DATA('1500004646','831717'),
        T_TIPO_DATA('1500004647','831718'),
        T_TIPO_DATA('1500004648','831719'),
        T_TIPO_DATA('1500004649','831720'),
        T_TIPO_DATA('1500004650','831721'),
        T_TIPO_DATA('1500004651','831722'),
        T_TIPO_DATA('1500004652','831723'),
        T_TIPO_DATA('1500004653','831724'),
        T_TIPO_DATA('1500004654','831725'),
        T_TIPO_DATA('1500004655','831726'),
        T_TIPO_DATA('1500004656','831727'),
        T_TIPO_DATA('1500004657','831728'),
        T_TIPO_DATA('1500004658','831729'),
        T_TIPO_DATA('1500004659','831730'),
        T_TIPO_DATA('1500004660','831731'),
        T_TIPO_DATA('1500004661','831732'),
        T_TIPO_DATA('1500004662','831733'),
        T_TIPO_DATA('1500004663','831734'),
        T_TIPO_DATA('1500004664','831735'),
        T_TIPO_DATA('1500004665','831736'),
        T_TIPO_DATA('1500000012','831623'),
        T_TIPO_DATA('1500001407','829469'),
        T_TIPO_DATA('1500001408','831221'),
        T_TIPO_DATA('1500001409','831222'),
        T_TIPO_DATA('1500001410','831223'),
        T_TIPO_DATA('9999132622','831258')


    ); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN	
	
	DBMS_OUTPUT.PUT_LINE('[INICIO] ');
 
    -- LOOP para insertar los valores en OFR_OFERTAS
    DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZACION EN '||V_TABLA||' ');            


    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
    LOOP
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
        
        V_COUNT_TOTAL:=V_COUNT_TOTAL+1;
        --Comprobar si el activo ya existe
        V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TABLA||' WHERE BBVA_NUM_ACTIVO='''||V_TMP_TIPO_DATA(2)||''' ';
        EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;            
        
        IF V_NUM_TABLAS > 0 THEN

            DBMS_OUTPUT.PUT_LINE('[INFO]: ACTUALIZAMOS LINEA_FACTURA DEL ACTIVO BBVA_NUM_ACTIVO: '''||V_TMP_TIPO_DATA(2)||''' ');
                
            
            V_MSQL :='UPDATE '||V_ESQUEMA||'.'||V_TABLA||' SET 
                    BBVA_LINEA_FACTURA = '||V_TMP_TIPO_DATA(1)||' ,
                    USUARIOMODIFICAR = '''||V_USUARIO||''', 
                    FECHAMODIFICAR = SYSDATE 
                    WHERE BBVA_NUM_ACTIVO='''||V_TMP_TIPO_DATA(2)||''' ';

            EXECUTE IMMEDIATE V_MSQL;


            IF sql%rowcount > 0 THEN 
                DBMS_OUTPUT.PUT_LINE('[INFO]: Modificado el BBVA_NUM_ACTIVO: '''||V_TMP_TIPO_DATA(2)||'''  CON LINEA FACTURA: '''||V_TMP_TIPO_DATA(1)||''' ');
                DBMS_OUTPUT.PUT_LINE('[INFO]:                                                                                           ');
                V_COUNT:=V_COUNT+1;
            END IF;

        ELSE                
            DBMS_OUTPUT.PUT_LINE('[INFO]: NO EXISTE EL ACTIVO CON BBVA_NUM_ACTIVO: '''||V_TMP_TIPO_DATA(2)||''' ');

        END IF;

    END LOOP;

    DBMS_OUTPUT.PUT_LINE('[FIN]: ACTUALIZADOS CORRECTAMENTE '''||V_COUNT||''' DE '''||V_COUNT_TOTAL||''' ');

    COMMIT;
    
    DBMS_OUTPUT.PUT_LINE('[FIN]');
    
    
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);

          ROLLBACK;
          RAISE;          

END;
/
EXIT