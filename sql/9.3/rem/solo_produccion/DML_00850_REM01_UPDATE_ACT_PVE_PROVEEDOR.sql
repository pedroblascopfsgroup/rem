--/*
--##########################################
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20210512
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9716
--## PRODUCTO=NO
--##
--## Finalidad: Script informa mediador relacionado para oficinas
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versi√≥n inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_TEXT_TABLA VARCHAR2(27 CHAR) := 'ACT_PVE_PROVEEDOR'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_USU VARCHAR2(30 CHAR) := 'REMVIP-9716'; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.
	V_COUNT NUMBER(16);
	V_PVE_ID NUMBER(16);

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
		-- 		COD_OFI  COD_MED
		T_TIPO_DATA(7240,4395),
		T_TIPO_DATA(7241,4395),
		T_TIPO_DATA(7242,4395),
		T_TIPO_DATA(7243,4395),
		T_TIPO_DATA(110075708,4395),
		T_TIPO_DATA(8879,1116),
		T_TIPO_DATA(8880,1116),
		T_TIPO_DATA(8886,1116),
		T_TIPO_DATA(8891,1116),
		T_TIPO_DATA(110075553,2320),
		T_TIPO_DATA(110075541,2320),
		T_TIPO_DATA(110075543,2320),
		T_TIPO_DATA(110075544,2320),
		T_TIPO_DATA(110075709,2320),
		T_TIPO_DATA(110075705,2320),
		T_TIPO_DATA(110075707,2320),
		T_TIPO_DATA(110075701,2320),
		T_TIPO_DATA(110075695,2320),
		T_TIPO_DATA(110075698,2320),
		T_TIPO_DATA(110075714,2320),
		T_TIPO_DATA(7309,2320),
		T_TIPO_DATA(7318,2320),
		T_TIPO_DATA(110075622,12608),
		T_TIPO_DATA(110075536,12608),
		T_TIPO_DATA(8775,12608),
		T_TIPO_DATA(8733,12608),
		T_TIPO_DATA(7585,12608),
		T_TIPO_DATA(7321,12608),
		T_TIPO_DATA(7334,12608),
		T_TIPO_DATA(7345,12608),
		T_TIPO_DATA(7346,12608),
		T_TIPO_DATA(7351,12608),
		T_TIPO_DATA(7238,3240),
		T_TIPO_DATA(7724,3240),
		T_TIPO_DATA(7341,3240),
		T_TIPO_DATA(110075632,3240),
		T_TIPO_DATA(110075633,3240),
		T_TIPO_DATA(110075637,3240),
		T_TIPO_DATA(110075556,3240),
		T_TIPO_DATA(110075552,3240),
		T_TIPO_DATA(110075540,3240),
		T_TIPO_DATA(7302,3240),
		T_TIPO_DATA(7308,3240),
		T_TIPO_DATA(7330,3240),
		T_TIPO_DATA(7350,3240),
		T_TIPO_DATA(8877,10028830),
		T_TIPO_DATA(8878,10028830),
		T_TIPO_DATA(8765,10028830),
		T_TIPO_DATA(8767,10028830),
		T_TIPO_DATA(110075625,2941),
		T_TIPO_DATA(110075626,2941),
		T_TIPO_DATA(110075627,2941),
		T_TIPO_DATA(110075542,2941),
		T_TIPO_DATA(110075546,2941),
		T_TIPO_DATA(110116922,3232),
		T_TIPO_DATA(110075646,3232),
		T_TIPO_DATA(110075643,3232),
		T_TIPO_DATA(110075644,3232),
		T_TIPO_DATA(110075647,3232),
		T_TIPO_DATA(110075601,3232),
		T_TIPO_DATA(7303,3232),
		T_TIPO_DATA(7323,3232),
		T_TIPO_DATA(110075520,3232),
		T_TIPO_DATA(110075699,3232),
		T_TIPO_DATA(110075654,3232),
		T_TIPO_DATA(110075477,3232),
		T_TIPO_DATA(110075485,3232),
		T_TIPO_DATA(110075490,3232),
		T_TIPO_DATA(110075667,3232),
		T_TIPO_DATA(110075668,3232),
		T_TIPO_DATA(110075674,3232),
		T_TIPO_DATA(110075678,3232),
		T_TIPO_DATA(110075681,3232),
		T_TIPO_DATA(110075615,3232),
		T_TIPO_DATA(110075611,3232),
		T_TIPO_DATA(110075574,3232),
		T_TIPO_DATA(110075579,3232),
		T_TIPO_DATA(110075580,3232),
		T_TIPO_DATA(110075581,3232),
		T_TIPO_DATA(110075595,3232),
		T_TIPO_DATA(110075623,3232),
		T_TIPO_DATA(110075629,3232),
		T_TIPO_DATA(110075630,3232),
		T_TIPO_DATA(110075640,3232),
		T_TIPO_DATA(110075527,3232),
		T_TIPO_DATA(110075658,3232),
		T_TIPO_DATA(110075480,3232),
		T_TIPO_DATA(110075482,3232),
		T_TIPO_DATA(110075483,3232),
		T_TIPO_DATA(110075489,3232),
		T_TIPO_DATA(110075491,3232),
		T_TIPO_DATA(110075492,3232),
		T_TIPO_DATA(110075495,3232),
		T_TIPO_DATA(110075496,3232),
		T_TIPO_DATA(110075497,3232),
		T_TIPO_DATA(110075503,3232),
		T_TIPO_DATA(110075573,3232),
		T_TIPO_DATA(110075572,3232),
		T_TIPO_DATA(110075565,3232),
		T_TIPO_DATA(110075657,3232),
		T_TIPO_DATA(110075665,3232),
		T_TIPO_DATA(110075680,3232),
		T_TIPO_DATA(110075689,3232),
		T_TIPO_DATA(110075602,3232),
		T_TIPO_DATA(110075578,3232),
		T_TIPO_DATA(110075628,3232),
		T_TIPO_DATA(110075641,3232),
		T_TIPO_DATA(110075559,3232),
		T_TIPO_DATA(110075649,3232),
		T_TIPO_DATA(110075645,3232),
		T_TIPO_DATA(110075648,3232),
		T_TIPO_DATA(110075650,3232),
		T_TIPO_DATA(110075661,3232),
		T_TIPO_DATA(110075672,3232),
		T_TIPO_DATA(110075583,3232),
		T_TIPO_DATA(110075585,3232),
		T_TIPO_DATA(110075596,3232),
		T_TIPO_DATA(110075609,3232),
		T_TIPO_DATA(110075619,3232),
		T_TIPO_DATA(110075549,3232),
		T_TIPO_DATA(110075550,3232),
		T_TIPO_DATA(110075528,3232),
		T_TIPO_DATA(110075532,3232),
		T_TIPO_DATA(110075537,3232),
		T_TIPO_DATA(7324,3232),
		T_TIPO_DATA(110075653,3232),
		T_TIPO_DATA(110075478,3232),
		T_TIPO_DATA(110075501,3232),
		T_TIPO_DATA(110075564,3232),
		T_TIPO_DATA(110075669,3232),
		T_TIPO_DATA(110075690,3232),
		T_TIPO_DATA(110075592,3232),
		T_TIPO_DATA(110075616,3232),
		T_TIPO_DATA(110075617,3232),
		T_TIPO_DATA(110075636,3232),
		T_TIPO_DATA(110075521,3232),
		T_TIPO_DATA(110075529,3232),
		T_TIPO_DATA(7725,3232),
		T_TIPO_DATA(7236,3232),
		T_TIPO_DATA(110075474,3232),
		T_TIPO_DATA(110075475,3232),
		T_TIPO_DATA(110075499,3232),
		T_TIPO_DATA(110075500,3232),
		T_TIPO_DATA(110075561,3232),
		T_TIPO_DATA(110075566,3232),
		T_TIPO_DATA(110075562,3232),
		T_TIPO_DATA(110075569,3232),
		T_TIPO_DATA(110075666,3232),
		T_TIPO_DATA(110075670,3232),
		T_TIPO_DATA(110075675,3232),
		T_TIPO_DATA(110075677,3232),
		T_TIPO_DATA(110075686,3232),
		T_TIPO_DATA(110075612,3232),
		T_TIPO_DATA(110075613,3232),
		T_TIPO_DATA(110075568,3232),
		T_TIPO_DATA(110075575,3232),
		T_TIPO_DATA(110075576,3232),
		T_TIPO_DATA(110075577,3232),
		T_TIPO_DATA(110075624,3232),
		T_TIPO_DATA(110075638,3232),
		T_TIPO_DATA(110075639,3232),
		T_TIPO_DATA(110075523,3232),
		T_TIPO_DATA(110075524,3232),
		T_TIPO_DATA(110075538,3232),
		T_TIPO_DATA(110075539,3232),
		T_TIPO_DATA(110075655,3232),
		T_TIPO_DATA(110075659,3232),
		T_TIPO_DATA(110075476,3232),
		T_TIPO_DATA(110075479,3232),
		T_TIPO_DATA(110075487,3232),
		T_TIPO_DATA(110075494,3232),
		T_TIPO_DATA(110075498,3232),
		T_TIPO_DATA(110075502,3232),
		T_TIPO_DATA(110075504,3232),
		T_TIPO_DATA(110075567,3232),
		T_TIPO_DATA(110075570,3232),
		T_TIPO_DATA(110075563,3232),
		T_TIPO_DATA(110075673,3232),
		T_TIPO_DATA(110075676,3232),
		T_TIPO_DATA(110075682,3232),
		T_TIPO_DATA(110075683,3232),
		T_TIPO_DATA(110075685,3232),
		T_TIPO_DATA(110075687,3232),
		T_TIPO_DATA(110075606,3232),
		T_TIPO_DATA(110075607,3232),
		T_TIPO_DATA(110075600,3232),
		T_TIPO_DATA(110075517,3232),
		T_TIPO_DATA(110075519,3232),
		T_TIPO_DATA(110075558,3232),
		T_TIPO_DATA(110075704,3232),
		T_TIPO_DATA(110075697,3232),
		T_TIPO_DATA(7322,10765),
		T_TIPO_DATA(7347,10765),
		T_TIPO_DATA(7234,10765),
		T_TIPO_DATA(110075642,3393),
		T_TIPO_DATA(110075555,3393),
		T_TIPO_DATA(110075548,3393),
		T_TIPO_DATA(110075702,3393),
		T_TIPO_DATA(7312,3393),
		T_TIPO_DATA(110075530,3351),
		T_TIPO_DATA(110075533,3351),
		T_TIPO_DATA(110075534,3351),
		T_TIPO_DATA(110075696,3351),
		T_TIPO_DATA(8731,3351),
		T_TIPO_DATA(7326,3351),
		T_TIPO_DATA(7228,3351),
		T_TIPO_DATA(7239,3351),
		T_TIPO_DATA(7247,3351),
		T_TIPO_DATA(7249,3351),
		T_TIPO_DATA(110075651,3351),
		T_TIPO_DATA(110075652,3351),
		T_TIPO_DATA(110075481,3351),
		T_TIPO_DATA(110075484,3351),
		T_TIPO_DATA(110075486,3351),
		T_TIPO_DATA(110075493,3351),
		T_TIPO_DATA(110075571,3351),
		T_TIPO_DATA(110075662,3351),
		T_TIPO_DATA(110075663,3351),
		T_TIPO_DATA(110075664,3351),
		T_TIPO_DATA(110075671,3351),
		T_TIPO_DATA(110075679,3351),
		T_TIPO_DATA(110075684,3351),
		T_TIPO_DATA(110075605,3351),
		T_TIPO_DATA(110075604,3351),
		T_TIPO_DATA(110075591,3351),
		T_TIPO_DATA(110075515,3351),
		T_TIPO_DATA(110075516,3351),
		T_TIPO_DATA(110075511,3351),
		T_TIPO_DATA(110075518,3351),
		T_TIPO_DATA(110075507,3351),
		T_TIPO_DATA(110075508,3351),
		T_TIPO_DATA(110075514,3351),
		T_TIPO_DATA(110075522,3351),
		T_TIPO_DATA(7317,3351),
		T_TIPO_DATA(7235,3351),
		T_TIPO_DATA(110075688,3351),
		T_TIPO_DATA(110075488,3351),
		T_TIPO_DATA(110075608,3351),
		T_TIPO_DATA(110075614,3351),
		T_TIPO_DATA(110075603,3351),
		T_TIPO_DATA(110075610,3351),
		T_TIPO_DATA(110075587,3351),
		T_TIPO_DATA(110075588,3351),
		T_TIPO_DATA(110075589,3351),
		T_TIPO_DATA(110075590,3351),
		T_TIPO_DATA(110075593,3351),
		T_TIPO_DATA(110075594,3351),
		T_TIPO_DATA(110075599,3351),
		T_TIPO_DATA(110075509,3351),
		T_TIPO_DATA(110075512,3351),
		T_TIPO_DATA(110075545,3351),
		T_TIPO_DATA(9699,963),
		T_TIPO_DATA(8729,963),
		T_TIPO_DATA(8105,963),
		T_TIPO_DATA(8728,963),
		T_TIPO_DATA(7728,963),
		T_TIPO_DATA(7732,963),
		T_TIPO_DATA(7319,963),
		T_TIPO_DATA(7344,963),
		T_TIPO_DATA(7349,963),
		T_TIPO_DATA(7230,963),
		T_TIPO_DATA(7246,963),
		T_TIPO_DATA(110075535,963),
		T_TIPO_DATA(7730,963),
		T_TIPO_DATA(7735,963),
		T_TIPO_DATA(7616,963),
		T_TIPO_DATA(7301,963),
		T_TIPO_DATA(7304,963),
		T_TIPO_DATA(7320,963),
		T_TIPO_DATA(7343,963),
		T_TIPO_DATA(7352,963),
		T_TIPO_DATA(7354,963),
		T_TIPO_DATA(7237,963),
		T_TIPO_DATA(7250,963),
		T_TIPO_DATA(7286,963)); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

    
BEGIN		

	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	
	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
    LOOP
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
		V_PVE_ID := 0;

		DBMS_OUTPUT.PUT_LINE('[INFO]: INFORMAR MEDIADOR EN '||V_TEXT_TABLA);

		V_MSQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE PVE_COD_REM = '||V_TMP_TIPO_DATA(1)||' AND BORRADO = 0';
		EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

		IF V_COUNT = 1 THEN

			V_MSQL:= 'SELECT PVE_ID FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE PVE_COD_REM = '||V_TMP_TIPO_DATA(2)||' AND BORRADO = 0';
			EXECUTE IMMEDIATE V_MSQL INTO V_PVE_ID;

			IF V_PVE_ID != 0 THEN

				V_MSQL:= 'UPDATE '||V_ESQUEMA||'.'||V_TEXT_TABLA||' SET
							PVE_ID_MEDIADOR_REL = '||V_PVE_ID||',
							USUARIOMODIFICAR = '''||V_USU||''',
							FECHAMODIFICAR = SYSDATE
							WHERE PVE_COD_REM = '||V_TMP_TIPO_DATA(1)||' AND BORRADO = 0';
				EXECUTE IMMEDIATE V_MSQL;
				
				DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICAMOS PVE_ID_MEDIADOR_REL = '||V_TMP_TIPO_DATA(2)||' EN OFICINA CON PVE_COD_REM '||V_TMP_TIPO_DATA(1)||'');

			ELSE

				DBMS_OUTPUT.PUT_LINE('[INFO]: PROVEEDOR MEDIADOR '||V_TMP_TIPO_DATA(2)||' NO EXISTE O ESTA BORRADO');

			END IF;

		ELSE

			DBMS_OUTPUT.PUT_LINE('[INFO]: OFICINA CON CODIGO REM '||V_TMP_TIPO_DATA(1)||' NO EXISTE O ESTA BORRADO');

		END IF;

	END LOOP;

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN]');


EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecuci√≥n:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;

/

EXIT