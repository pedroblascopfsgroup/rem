--/*
--##########################################
--## AUTOR=Carlos Santos Vílchez
--## FECHA_CREACION=20210607
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-9867
--## PRODUCTO=NO
--##
--## Finalidad: Script añade gestores a expedientes
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USU VARCHAR2(30 CHAR) := 'REMVIP-9867'; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.
	V_COUNT NUMBER(16);
	V_ECO_ID NUMBER(16);
	V_GEE_ID NUMBER(16);
	V_GEH_ID NUMBER(16);
	V_USU_ID NUMBER(16);
	V_TGE_ID NUMBER(16);

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
			T_TIPO_DATA('10097'),
			T_TIPO_DATA('85277'),
			T_TIPO_DATA('134205'),
			T_TIPO_DATA('144711'),
			T_TIPO_DATA('144736'),
			T_TIPO_DATA('145896'),
			T_TIPO_DATA('154569'),
			T_TIPO_DATA('159450'),
			T_TIPO_DATA('159694'),
			T_TIPO_DATA('159796'),
			T_TIPO_DATA('160219'),
			T_TIPO_DATA('160235'),
			T_TIPO_DATA('161772'),
			T_TIPO_DATA('162036'),
			T_TIPO_DATA('164852'),
			T_TIPO_DATA('177277'),
			T_TIPO_DATA('177287'),
			T_TIPO_DATA('177392'),
			T_TIPO_DATA('180687'),
			T_TIPO_DATA('180770'),
			T_TIPO_DATA('181186'),
			T_TIPO_DATA('189277'),
			T_TIPO_DATA('189991'),
			T_TIPO_DATA('191641'),
			T_TIPO_DATA('193055'),
			T_TIPO_DATA('193197'),
			T_TIPO_DATA('194169'),
			T_TIPO_DATA('194187'),
			T_TIPO_DATA('194155'),
			T_TIPO_DATA('194221'),
			T_TIPO_DATA('194683'),
			T_TIPO_DATA('194971'),
			T_TIPO_DATA('195529'),
			T_TIPO_DATA('195157'),
			T_TIPO_DATA('196000'),
			T_TIPO_DATA('195866'),
			T_TIPO_DATA('196791'),
			T_TIPO_DATA('196405'),
			T_TIPO_DATA('197159'),
			T_TIPO_DATA('196950'),
			T_TIPO_DATA('197017'),
			T_TIPO_DATA('197152'),
			T_TIPO_DATA('197336'),
			T_TIPO_DATA('230295'),
			T_TIPO_DATA('232614'),
			T_TIPO_DATA('232889'),
			T_TIPO_DATA('235175'),
			T_TIPO_DATA('235804'),
			T_TIPO_DATA('236876'),
			T_TIPO_DATA('237344'),
			T_TIPO_DATA('246606'),
			T_TIPO_DATA('247397'),
			T_TIPO_DATA('247403'),
			T_TIPO_DATA('248943'),
			T_TIPO_DATA('249254'),
			T_TIPO_DATA('249148'),
			T_TIPO_DATA('249146'),
			T_TIPO_DATA('251061'),
			T_TIPO_DATA('250057'),
			T_TIPO_DATA('250691'),
			T_TIPO_DATA('250668'),
			T_TIPO_DATA('251009'),
			T_TIPO_DATA('250989'),
			T_TIPO_DATA('251818'),
			T_TIPO_DATA('252277'),
			T_TIPO_DATA('252525'),
			T_TIPO_DATA('253375'),
			T_TIPO_DATA('253714'),
			T_TIPO_DATA('254554'),
			T_TIPO_DATA('254652'),
			T_TIPO_DATA('254655'),
			T_TIPO_DATA('254658'),
			T_TIPO_DATA('254668'),
			T_TIPO_DATA('254987'),
			T_TIPO_DATA('255242'),
			T_TIPO_DATA('255709'),
			T_TIPO_DATA('255944'),
			T_TIPO_DATA('257249'),
			T_TIPO_DATA('257611'),
			T_TIPO_DATA('257827'),
			T_TIPO_DATA('259212'),
			T_TIPO_DATA('258858'),
			T_TIPO_DATA('259073'),
			T_TIPO_DATA('259871'),
			T_TIPO_DATA('260318'),
			T_TIPO_DATA('260759'),
			T_TIPO_DATA('261304'),
			T_TIPO_DATA('261720'),
			T_TIPO_DATA('261602'),
			T_TIPO_DATA('262197'),
			T_TIPO_DATA('261854'),
			T_TIPO_DATA('262076')

		); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

    
BEGIN		

	DBMS_OUTPUT.PUT_LINE('[INICIO]');

	V_MSQL:= 'SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''grucontroller''';
	EXECUTE IMMEDIATE V_MSQL INTO V_USU_ID;

	V_MSQL:= 'SELECT DD_TGE_ID FROM '||V_ESQUEMA_M||'.DD_TGE_TIPO_GESTOR WHERE DD_TGE_CODIGO = ''GCONT''';
	EXECUTE IMMEDIATE V_MSQL INTO V_TGE_ID;
	
	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
	LOOP
	V_TMP_TIPO_DATA := V_TIPO_DATA(I);

		V_MSQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL WHERE ECO_NUM_EXPEDIENTE = '||V_TMP_TIPO_DATA(1)||' AND BORRADO = 0';
		EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

		IF V_COUNT = 1 THEN

			V_MSQL:= 'SELECT ECO_ID FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL WHERE ECO_NUM_EXPEDIENTE = '||V_TMP_TIPO_DATA(1)||'';
			EXECUTE IMMEDIATE V_MSQL INTO V_ECO_ID;

			V_MSQL:= 'INSERT INTO '||V_ESQUEMA||'.GEE_GESTOR_ENTIDAD (GEE_ID, USU_ID, DD_TGE_ID, USUARIOCREAR, FECHACREAR) VALUES (
				'||V_ESQUEMA||'.S_GEE_GESTOR_ENTIDAD.NEXTVAL,
				'||V_USU_ID||',
				'||V_TGE_ID||',
				'''||V_USU||''',
				SYSDATE
			)';
			EXECUTE IMMEDIATE V_MSQL;

			V_MSQL:= 'SELECT '||V_ESQUEMA||'.S_GEE_GESTOR_ENTIDAD.CURRVAL FROM DUAL';
			EXECUTE IMMEDIATE V_MSQL INTO V_GEE_ID;

			V_MSQL:= 'INSERT INTO '||V_ESQUEMA||'.GCO_GESTOR_ADD_ECO (GEE_ID, ECO_ID) VALUES (
				'||V_GEE_ID||',
				'||V_ECO_ID||'
			)';
			EXECUTE IMMEDIATE V_MSQL;

			V_MSQL:= 'INSERT INTO '||V_ESQUEMA||'.GEH_GESTOR_ENTIDAD_HIST (GEH_ID, USU_ID, DD_TGE_ID, GEH_FECHA_DESDE, USUARIOCREAR, FECHACREAR) VALUES (
				'||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.NEXTVAL,
				'||V_USU_ID||',
				'||V_TGE_ID||',
				TO_DATE(''07/06/2021'', ''DD/MM/YYYY''),
				'''||V_USU||''',
				SYSDATE
			)';
			EXECUTE IMMEDIATE V_MSQL;

			V_MSQL:= 'SELECT '||V_ESQUEMA||'.S_GEH_GESTOR_ENTIDAD_HIST.CURRVAL FROM DUAL';
			EXECUTE IMMEDIATE V_MSQL INTO V_GEH_ID;

			V_MSQL:= 'INSERT INTO '||V_ESQUEMA||'.GCH_GESTOR_ECO_HISTORICO (GEH_ID, ECO_ID) VALUES (
				'||V_GEH_ID||',
				'||V_ECO_ID||'
			)';
			EXECUTE IMMEDIATE V_MSQL;

			DBMS_OUTPUT.PUT_LINE('[INFO]: GESTOR INSERTADO EN EXPEDIENTE: '||V_TMP_TIPO_DATA(1)||'');

		ELSE

			DBMS_OUTPUT.PUT_LINE('[INFO]: NO EXISTE EL EXPEDIENTE: '||V_TMP_TIPO_DATA(1)||'');

		END IF;

	END LOOP;

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN]');


EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;

/

EXIT