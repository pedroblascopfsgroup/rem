--/*
--##########################################
--## AUTOR=Carlos Santos Vílchez
--## FECHA_CREACION=20210623
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-10040
--## PRODUCTO=NO
--##
--## Finalidad: Script modifica solicitante trabajos
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_TEXT_TABLA VARCHAR2(27 CHAR) := 'ACT_TBJ_TRABAJO'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_USU VARCHAR2(30 CHAR) := 'REMVIP-10040'; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.
	V_COUNT NUMBER(16);
	V_TBJ_ID NUMBER(16);
	V_USU_ID NUMBER(16);

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
		T_TIPO_DATA('924567823622'),
		T_TIPO_DATA('924567827668'),
		T_TIPO_DATA('924567848889'),
		T_TIPO_DATA('924567850403'),
		T_TIPO_DATA('924567843775'),
		T_TIPO_DATA('924567850400'),
		T_TIPO_DATA('924567828717'),
		T_TIPO_DATA('924567846142'),
		T_TIPO_DATA('924567842223'),
		T_TIPO_DATA('924567831151'),
		T_TIPO_DATA('924567820744'),
		T_TIPO_DATA('924567838735'),
		T_TIPO_DATA('924567823621'),
		T_TIPO_DATA('924567837131'),
		T_TIPO_DATA('924567831143'),
		T_TIPO_DATA('924567818500'),
		T_TIPO_DATA('916964387982'),
		T_TIPO_DATA('916964387979'),
		T_TIPO_DATA('916964387977'),
		T_TIPO_DATA('916964387976'),
		T_TIPO_DATA('924567850404'),
		T_TIPO_DATA('924567831155'),
		T_TIPO_DATA('924567810186'),
		T_TIPO_DATA('924567823297'),
		T_TIPO_DATA('924567846144'),
		T_TIPO_DATA('916964371520'),
		T_TIPO_DATA('916964379364'),
		T_TIPO_DATA('916964345126'),
		T_TIPO_DATA('924567827666'),
		T_TIPO_DATA('916964371019'),
		T_TIPO_DATA('924567823295'),
		T_TIPO_DATA('916964376848'),
		T_TIPO_DATA('924567821634'),
		T_TIPO_DATA('924567821635'),
		T_TIPO_DATA('916964376850'),
		T_TIPO_DATA('916964376854'),
		T_TIPO_DATA('916964376852'),
		T_TIPO_DATA('924567850406'),
		T_TIPO_DATA('924567850407'),
		T_TIPO_DATA('924567823320'),
		T_TIPO_DATA('924567829511'),
		T_TIPO_DATA('924567819347'),
		T_TIPO_DATA('916964383811'),
		T_TIPO_DATA('916964383799'),
		T_TIPO_DATA('924567823291'),
		T_TIPO_DATA('916964330804'),
		T_TIPO_DATA('916964383779'),
		T_TIPO_DATA('916964383778'),
		T_TIPO_DATA('916964383821'),
		T_TIPO_DATA('916964383783'),
		T_TIPO_DATA('924567823319'),
		T_TIPO_DATA('924567820680'),
		T_TIPO_DATA('924567823328'),
		T_TIPO_DATA('916964383814'),
		T_TIPO_DATA('924567823318'),
		T_TIPO_DATA('924567823330'),
		T_TIPO_DATA('9000258775'),
		T_TIPO_DATA('9000258489'),
		T_TIPO_DATA('9000258532'),
		T_TIPO_DATA('9000258495'),
		T_TIPO_DATA('9000258509'),
		T_TIPO_DATA('9000257157'),
		T_TIPO_DATA('9000257678'),
		T_TIPO_DATA('9000257191'),
		T_TIPO_DATA('9000258428'),
		T_TIPO_DATA('9000258694'),
		T_TIPO_DATA('9000258697'),
		T_TIPO_DATA('9000258418'),
		T_TIPO_DATA('9000258406'),
		T_TIPO_DATA('9000257563'),
		T_TIPO_DATA('9000257631'),
		T_TIPO_DATA('9000256647'),
		T_TIPO_DATA('9000256441'),
		T_TIPO_DATA('9000256667'),
		T_TIPO_DATA('9000253923'),
		T_TIPO_DATA('9000255816'),
		T_TIPO_DATA('9000255808'),
		T_TIPO_DATA('9000255741'),
		T_TIPO_DATA('9000255815'),
		T_TIPO_DATA('9000255316'),
		T_TIPO_DATA('9000252847'),
		T_TIPO_DATA('9000252903'),
		T_TIPO_DATA('9000252857'),
		T_TIPO_DATA('9000252868'),
		T_TIPO_DATA('9000250393'),
		T_TIPO_DATA('9000251632'),
		T_TIPO_DATA('9000251636'),
		T_TIPO_DATA('9000251243'),
		T_TIPO_DATA('9000251225'),
		T_TIPO_DATA('9000250158'),
		T_TIPO_DATA('9000250132'),
		T_TIPO_DATA('9000250149'),
		T_TIPO_DATA('9000248416'),
		T_TIPO_DATA('9000249676'),
		T_TIPO_DATA('9000249514'),
		T_TIPO_DATA('9000249688'),
		T_TIPO_DATA('9000249166'),
		T_TIPO_DATA('9000249193'),
		T_TIPO_DATA('9000249680'),
		T_TIPO_DATA('9000249172'),
		T_TIPO_DATA('9000249513'),
		T_TIPO_DATA('9000249125'),
		T_TIPO_DATA('9000249720'),
		T_TIPO_DATA('9000248746'),
		T_TIPO_DATA('9000249734'),
		T_TIPO_DATA('9000248717'),
		T_TIPO_DATA('9000248585'),
		T_TIPO_DATA('9000249656'),
		T_TIPO_DATA('9000246543'),
		T_TIPO_DATA('9000246541'),
		T_TIPO_DATA('9000254617'),
		T_TIPO_DATA('9000246549'),
		T_TIPO_DATA('9000246535'),
		T_TIPO_DATA('9000246537'),
		T_TIPO_DATA('9000246538'),
		T_TIPO_DATA('9000240170'),
		T_TIPO_DATA('9000240141'),
		T_TIPO_DATA('9000240159'),
		T_TIPO_DATA('9000240164'),
		T_TIPO_DATA('9000240158'),
		T_TIPO_DATA('9000240167'),
		T_TIPO_DATA('9000240134'),
		T_TIPO_DATA('9000240144'),
		T_TIPO_DATA('9000229427'),
		T_TIPO_DATA('9000226351'),
		T_TIPO_DATA('9000226352'),
		T_TIPO_DATA('9000240987'),
		T_TIPO_DATA('9000250442'),
		T_TIPO_DATA('9000249724'),
		T_TIPO_DATA('9000249727'),
		T_TIPO_DATA('9000205898'),
		T_TIPO_DATA('9000249729'),
		T_TIPO_DATA('9000205922'),
		T_TIPO_DATA('9000252844'),
		T_TIPO_DATA('9000205737'),
		T_TIPO_DATA('9000215407'),
		T_TIPO_DATA('9000248723'),
		T_TIPO_DATA('9000254715'),
		T_TIPO_DATA('9000255311'),
		T_TIPO_DATA('9000256434'),
		T_TIPO_DATA('9000215360'),
		T_TIPO_DATA('9000218616'),
		T_TIPO_DATA('9000248587'),
		T_TIPO_DATA('9000215352'),
		T_TIPO_DATA('9000251236'),
		T_TIPO_DATA('9000246516'),
		T_TIPO_DATA('9000254673'),
		T_TIPO_DATA('9000256300'),
		T_TIPO_DATA('9000245603'),
		T_TIPO_DATA('9000254630'),
		T_TIPO_DATA('9000256307'),
		T_TIPO_DATA('9000246528'),
		T_TIPO_DATA('9000205917'),
		T_TIPO_DATA('9000242328'),
		T_TIPO_DATA('9000254688'),
		T_TIPO_DATA('9000250469'),
		T_TIPO_DATA('9000242312'),
		T_TIPO_DATA('9000246523'),
		T_TIPO_DATA('9000246514'),
		T_TIPO_DATA('9000254693'),
		T_TIPO_DATA('9000240142'),
		T_TIPO_DATA('9000215573'),
		T_TIPO_DATA('9000240165'),
		T_TIPO_DATA('9000246512'),
		T_TIPO_DATA('9000246510'),
		T_TIPO_DATA('9000250458'),
		T_TIPO_DATA('9000254677'),
		T_TIPO_DATA('9000254629'),
		T_TIPO_DATA('9000242306'),
		T_TIPO_DATA('9000256296'),
		T_TIPO_DATA('9000250462'),
		T_TIPO_DATA('9000246531'),
		T_TIPO_DATA('9000242309'),
		T_TIPO_DATA('9000240151'),
		T_TIPO_DATA('9000256294'),
		T_TIPO_DATA('9000246525'),
		T_TIPO_DATA('9000250452'),
		T_TIPO_DATA('9000242313'),
		T_TIPO_DATA('9000250437'),
		T_TIPO_DATA('9000268651'),
		T_TIPO_DATA('9000254633'),
		T_TIPO_DATA('9000218685'),
		T_TIPO_DATA('9000242314'),
		T_TIPO_DATA('9000249717'),
		T_TIPO_DATA('9000254675'),
		T_TIPO_DATA('9000259331'),
		T_TIPO_DATA('9000254685'),
		T_TIPO_DATA('9000254692'),
		T_TIPO_DATA('9000240150'),
		T_TIPO_DATA('9000301318'),
		T_TIPO_DATA('9000254687'),
		T_TIPO_DATA('9000268660'),
		T_TIPO_DATA('9000254674'),
		T_TIPO_DATA('9000268663'),
		T_TIPO_DATA('916964387640'),
		T_TIPO_DATA('924567813844'),
		T_TIPO_DATA('924567848037'),
		T_TIPO_DATA('924567848036'),
		T_TIPO_DATA('924567848033'),
		T_TIPO_DATA('924567829508'),
		T_TIPO_DATA('924567846145'),
		T_TIPO_DATA('924567843776'),
		T_TIPO_DATA('924567842229'),
		T_TIPO_DATA('924567842226'),
		T_TIPO_DATA('924567842225'),
		T_TIPO_DATA('924567838734'),
		T_TIPO_DATA('924567842222'),
		T_TIPO_DATA('924567840058'),
		T_TIPO_DATA('916964387640'),
		T_TIPO_DATA('924567813844'),
		T_TIPO_DATA('924567848037'),
		T_TIPO_DATA('924567848036'),
		T_TIPO_DATA('924567848033'),
		T_TIPO_DATA('924567829508'),
		T_TIPO_DATA('924567846145'),
		T_TIPO_DATA('924567843776'),
		T_TIPO_DATA('924567842229'),
		T_TIPO_DATA('924567842226'),
		T_TIPO_DATA('924567842225'),
		T_TIPO_DATA('924567838734'),
		T_TIPO_DATA('924567842222'),
		T_TIPO_DATA('924567840058'),
		T_TIPO_DATA('924567850405'),
		T_TIPO_DATA('924567850402'),
		T_TIPO_DATA('924567850401'),
		T_TIPO_DATA('924567848893')

		); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

    
BEGIN		

	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	
	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
	LOOP
	V_TMP_TIPO_DATA := V_TIPO_DATA(I);

		V_MSQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE TBJ_NUM_TRABAJO = '||V_TMP_TIPO_DATA(1)||'';
		EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

		IF V_COUNT = 1 THEN

			V_MSQL:= 'SELECT TBJ_ID FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE TBJ_NUM_TRABAJO = '||V_TMP_TIPO_DATA(1)||'';
			EXECUTE IMMEDIATE V_MSQL INTO V_TBJ_ID;

			V_MSQL:= 'SELECT USU_ID FROM '||V_ESQUEMA_M||'.USU_USUARIOS WHERE USU_USERNAME = ''mgarciade''';
			EXECUTE IMMEDIATE V_MSQL INTO V_USU_ID;

			V_MSQL:= 'UPDATE '||V_ESQUEMA||'.'||V_TEXT_TABLA||' SET
					USU_ID = '||V_USU_ID||',
					USUARIOMODIFICAR = '''||V_USU||''',
					FECHAMODIFICAR = SYSDATE
					WHERE TBJ_ID = '||V_TBJ_ID||'';
			EXECUTE IMMEDIATE V_MSQL;

			DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICAMOS RESPONSABLE EN TRABAJO '||V_TMP_TIPO_DATA(1)||'');

		ELSE

			DBMS_OUTPUT.PUT_LINE('[INFO]: TRABAJO '||V_TMP_TIPO_DATA(1)||' NO EXISTE O ESTA BORRADO');

		END IF;

	END LOOP;

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN]');


EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;

/

EXIT