--/*
--##########################################
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20210726
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-10226
--## PRODUCTO=NO
--## 
--## Finalidad: Script que a침ade en ACT_TAS_TASACION los datos a침adidos en T_ARRAY_DATA
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versi칩n inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;
ALTER SESSION SET NLS_NUMERIC_CHARACTERS = ',.';


DECLARE
        V_SQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar         
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_TABLA VARCHAR2(25 CHAR):= 'ACT_TAS_TASACION';
    V_COUNT NUMBER(16); -- Vble. para contar.
    V_KOUNT NUMBER(16); -- Vble. para kontar.
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

	ACT_NUM_ACTIVO NUMBER(16);
	ACT_ID NUMBER(16);
	NUM_SECUENCIA_VAL NUMBER(16);
	NUM_SECUENCIA_TAS NUMBER(16);
	BIE_ID NUMBER(16);

    V_USUARIO VARCHAR2(50 CHAR) := 'REMVIP-10226';    
    
    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    			-- NUM_ACT	TAS_IMPORTE_VALOR_TASACION      TAS_IMPORTE_TAS_FIN
            T_TIPO_DATA('7282275'),
T_TIPO_DATA('7251612'),
T_TIPO_DATA('7267191'),
T_TIPO_DATA('7264847'),
T_TIPO_DATA('7264179'),
T_TIPO_DATA('7265310'),
T_TIPO_DATA('7255474'),
T_TIPO_DATA('7250536'),
T_TIPO_DATA('7242826'),
T_TIPO_DATA('7250662'),
T_TIPO_DATA('7249889'),
T_TIPO_DATA('7283002'),
T_TIPO_DATA('7265880'),
T_TIPO_DATA('7263171'),
T_TIPO_DATA('7249984'),
T_TIPO_DATA('7267186'),
T_TIPO_DATA('7255924'),
T_TIPO_DATA('7282446'),
T_TIPO_DATA('7264527'),
T_TIPO_DATA('7250017'),
T_TIPO_DATA('7238566'),
T_TIPO_DATA('7264528'),
T_TIPO_DATA('7251393'),
T_TIPO_DATA('7264174'),
T_TIPO_DATA('7249913'),
T_TIPO_DATA('7263529'),
T_TIPO_DATA('7267222'),
T_TIPO_DATA('7235710'),
T_TIPO_DATA('7282447'),
T_TIPO_DATA('7284832'),
T_TIPO_DATA('7238345'),
T_TIPO_DATA('7281982'),
T_TIPO_DATA('7249781'),
T_TIPO_DATA('7264531'),
T_TIPO_DATA('7262103'),
T_TIPO_DATA('7282524'),
T_TIPO_DATA('7264532'),
T_TIPO_DATA('7282274'),
T_TIPO_DATA('7242993'),
T_TIPO_DATA('7268480'),
T_TIPO_DATA('7251392'),
T_TIPO_DATA('7265342'),
T_TIPO_DATA('7264529'),
T_TIPO_DATA('7267188'),
T_TIPO_DATA('7282525'),
T_TIPO_DATA('7272078'),
T_TIPO_DATA('7232186'),
T_TIPO_DATA('7252101'),
T_TIPO_DATA('7231386'),
T_TIPO_DATA('7278720'),
T_TIPO_DATA('7280899'),
T_TIPO_DATA('7275056'),
T_TIPO_DATA('7269907'),
T_TIPO_DATA('7290315'),
T_TIPO_DATA('7275551'),
T_TIPO_DATA('7275041'),
T_TIPO_DATA('7232249'),
T_TIPO_DATA('7273274'),
T_TIPO_DATA('7234868'),
T_TIPO_DATA('7264533'),
T_TIPO_DATA('7251678'),
T_TIPO_DATA('7236276'),
T_TIPO_DATA('7240471'),
T_TIPO_DATA('7257883'),
T_TIPO_DATA('7279566'),
T_TIPO_DATA('7272634'),
T_TIPO_DATA('7236269'),
T_TIPO_DATA('7232610'),
T_TIPO_DATA('7247125'),
T_TIPO_DATA('7275052'),
T_TIPO_DATA('7254611'),
T_TIPO_DATA('7268433'),
T_TIPO_DATA('7275048'),
T_TIPO_DATA('7263336'),
T_TIPO_DATA('7263545'),
T_TIPO_DATA('7251379'),
T_TIPO_DATA('7236275'),
T_TIPO_DATA('7236286'),
T_TIPO_DATA('7236277'),
T_TIPO_DATA('7274783'),
T_TIPO_DATA('7290049'),
T_TIPO_DATA('7275046'),
T_TIPO_DATA('7233246'),
T_TIPO_DATA('7274768'),
T_TIPO_DATA('7267110'),
T_TIPO_DATA('7232836'),
T_TIPO_DATA('7236266'),
T_TIPO_DATA('7263660'),
T_TIPO_DATA('7275053'),
T_TIPO_DATA('7261370'),
T_TIPO_DATA('7236268'),
T_TIPO_DATA('7237007'),
T_TIPO_DATA('7267131'),
T_TIPO_DATA('7275055'),
T_TIPO_DATA('7278474'),
T_TIPO_DATA('7275045'),
T_TIPO_DATA('7253414'),
T_TIPO_DATA('7283037'),
T_TIPO_DATA('7263662'),
T_TIPO_DATA('7275044'),
T_TIPO_DATA('7275042'),
T_TIPO_DATA('7266384'),
T_TIPO_DATA('7254632'),
T_TIPO_DATA('7241733'),
T_TIPO_DATA('7261369'),
T_TIPO_DATA('7271952'),
T_TIPO_DATA('7236267'),
T_TIPO_DATA('7258408'),
T_TIPO_DATA('7263693'),
T_TIPO_DATA('7264087'),
T_TIPO_DATA('7288718'),
T_TIPO_DATA('7281580'),
T_TIPO_DATA('7263004'),
T_TIPO_DATA('7273505'),
T_TIPO_DATA('7267495'),
T_TIPO_DATA('7249788'),
T_TIPO_DATA('7275043'),
T_TIPO_DATA('7230252'),
T_TIPO_DATA('7275146'),
T_TIPO_DATA('7236274'),
T_TIPO_DATA('7243955'),
T_TIPO_DATA('7281278'),
T_TIPO_DATA('7233829'),
T_TIPO_DATA('7275054'),
T_TIPO_DATA('7275286'),
T_TIPO_DATA('7253947'),
T_TIPO_DATA('7233245'),
T_TIPO_DATA('7275047'),
T_TIPO_DATA('7236270'),
T_TIPO_DATA('7275057'),
T_TIPO_DATA('7264561'),
T_TIPO_DATA('7249821'),
T_TIPO_DATA('7240470'),
T_TIPO_DATA('7275058'),
T_TIPO_DATA('7268542'),
T_TIPO_DATA('7269037'),
T_TIPO_DATA('7280898'),
T_TIPO_DATA('7264530'),
T_TIPO_DATA('7288704'),
T_TIPO_DATA('7277993'),
T_TIPO_DATA('7247016'),
T_TIPO_DATA('7236273'),
T_TIPO_DATA('7236284'),
T_TIPO_DATA('7290316'),
T_TIPO_DATA('7269141'),
T_TIPO_DATA('7260226'),
T_TIPO_DATA('7280721'),
T_TIPO_DATA('7271695'),
T_TIPO_DATA('7291972'),
T_TIPO_DATA('7275051'),
T_TIPO_DATA('7251574'),
T_TIPO_DATA('7291669'),
T_TIPO_DATA('7253575'),
T_TIPO_DATA('7275040'),
T_TIPO_DATA('7236271'),
T_TIPO_DATA('7236937'),
T_TIPO_DATA('7236283'),
T_TIPO_DATA('7275061'),
T_TIPO_DATA('7280897'),
T_TIPO_DATA('7267493'),
T_TIPO_DATA('7248301'),
T_TIPO_DATA('7275049'),
T_TIPO_DATA('7275050'),
T_TIPO_DATA('7277552'),
T_TIPO_DATA('7231630'),
T_TIPO_DATA('7275039'),
T_TIPO_DATA('7250188'),
T_TIPO_DATA('7275060'),
T_TIPO_DATA('7275059'),
T_TIPO_DATA('7255909'),
T_TIPO_DATA('7266106')



		); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN	
	
    DBMS_OUTPUT.PUT_LINE('[INICIO] ');


    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
      LOOP
      
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
    	ACT_NUM_ACTIVO := TRIM(V_TMP_TIPO_DATA(1));
       	EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO INTO V_KOUNT;
  			  
		IF V_KOUNT > 0 THEN 
	  			  
                EXECUTE IMMEDIATE 'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO INTO ACT_ID;
        
                
                DBMS_OUTPUT.PUT_LINE('UPDATEANDO EL ACTIVO '||ACT_NUM_ACTIVO||' EN '||V_TABLA);
                
                V_SQL := 'UPDATE '||V_ESQUEMA||'.'||V_TABLA||' 
                    SET TAS_IMPORTE_TAS_FIN = 0,
                        TAS_FECHA_INI_TASACION = NULL
                        ,USUARIOMODIFICAR = '''||V_USUARIO||'''
                        ,FECHAMODIFICAR = SYSDATE
                    WHERE TAS_ID IN (SELECT TAS.TAS_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                                    JOIN '||V_ESQUEMA||'.ACT_TAS_TASACION TAS ON TAS.ACT_ID=ACT.ACT_ID 
                                    WHERE ACT.ACT_NUM_ACTIVO = '''||TRIM(V_TMP_TIPO_DATA(1))||''' AND TAS.TAS_IMPORTE_TAS_FIN <=''0,01'' )
                    AND TAS_IMPORTE_TAS_FIN <=''0,01''';
                EXECUTE IMMEDIATE V_SQL;

                V_SQL := 'UPDATE '||V_ESQUEMA||'.BIE_VALORACIONES
                    SET BIE_IMPORTE_VALOR_TASACION = 0,
                        BIE_FECHA_VALOR_TASACION = NULL
                        ,USUARIOMODIFICAR = '''||V_USUARIO||'''
                        ,FECHAMODIFICAR = SYSDATE
                    WHERE BIE_VAL_ID IN (SELECT TAS.BIE_VAL_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
                                        JOIN '||V_ESQUEMA||'.ACT_TAS_TASACION TAS ON TAS.ACT_ID=ACT.ACT_ID
                                        WHERE ACT.ACT_NUM_ACTIVO = '''||TRIM(V_TMP_TIPO_DATA(1))||''' AND TAS.TAS_IMPORTE_TAS_FIN <=''0,01'')
                    AND BIE_IMPORTE_VALOR_TASACION <=''0,01''';
                EXECUTE IMMEDIATE V_SQL;
                
                DBMS_OUTPUT.PUT_LINE('MODIFICANDO IMPORTE Y FECHA EL ACTIVO '||ACT_NUM_ACTIVO||' EN '||V_TABLA);
                
                V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
				
		ELSE
			
			DBMS_OUTPUT.PUT_LINE('[INFO] El activo '||ACT_NUM_ACTIVO||' no existe!');
			
		END IF;
		
      END LOOP;
    COMMIT;

    DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado en total '||V_COUNT_UPDATE||' registros en la tabla '||V_TABLA);
   

EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecuci칩n:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;
/
EXIT