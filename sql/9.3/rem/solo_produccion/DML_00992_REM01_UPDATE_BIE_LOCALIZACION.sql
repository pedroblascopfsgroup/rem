--/*
--######################################### 
--## AUTOR=Carlos Santos Vílchez
--## FECHA_CREACION=20210804
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-10276
--## PRODUCTO=NO
--##            
--## INSTRUCCIONES:  Añadir municipios
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejECVtar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	V_USU VARCHAR2(30 CHAR) := 'REMVIP-10276';
	V_NUM_TABLAS NUMBER(16);
	V_BIE_ID NUMBER(16);
	V_COUNT NUMBER(16);

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
		T_TIPO_DATA('7481178','12040'),
		T_TIPO_DATA('7481209','12040'),
		T_TIPO_DATA('7481323','12040'),
		T_TIPO_DATA('7481527','12040'),
		T_TIPO_DATA('7481774','12040'),
		T_TIPO_DATA('7482052','12040'),
		T_TIPO_DATA('7480925','12089'),
		T_TIPO_DATA('7481059','12089'),
		T_TIPO_DATA('7481072','12089'),
		T_TIPO_DATA('7481194','12089'),
		T_TIPO_DATA('7481278','12089'),
		T_TIPO_DATA('7481284','12089'),
		T_TIPO_DATA('7481306','12089'),
		T_TIPO_DATA('7481499','12089'),
		T_TIPO_DATA('7482140','12089'),
		T_TIPO_DATA('7482329','12089'),
		T_TIPO_DATA('7480918','43163'),
		T_TIPO_DATA('7480934','43163'),
		T_TIPO_DATA('7480954','43163'),
		T_TIPO_DATA('7480964','43163'),
		T_TIPO_DATA('7480972','43163'),
		T_TIPO_DATA('7480982','43163'),
		T_TIPO_DATA('7481015','43163'),
		T_TIPO_DATA('7481018','43163'),
		T_TIPO_DATA('7481022','43163'),
		T_TIPO_DATA('7481023','43163'),
		T_TIPO_DATA('7481032','43163'),
		T_TIPO_DATA('7481036','43163'),
		T_TIPO_DATA('7481046','43163'),
		T_TIPO_DATA('7481048','43163'),
		T_TIPO_DATA('7481054','43163'),
		T_TIPO_DATA('7481057','43163'),
		T_TIPO_DATA('7481060','43163'),
		T_TIPO_DATA('7481066','43163'),
		T_TIPO_DATA('7481067','43163'),
		T_TIPO_DATA('7481073','43163'),
		T_TIPO_DATA('7481083','43163'),
		T_TIPO_DATA('7481095','43163'),
		T_TIPO_DATA('7481117','43163'),
		T_TIPO_DATA('7481135','43163'),
		T_TIPO_DATA('7481153','43163'),
		T_TIPO_DATA('7481168','43163'),
		T_TIPO_DATA('7481189','43163'),
		T_TIPO_DATA('7481193','43163'),
		T_TIPO_DATA('7481202','43163'),
		T_TIPO_DATA('7481207','43163'),
		T_TIPO_DATA('7481220','43163'),
		T_TIPO_DATA('7481297','43163'),
		T_TIPO_DATA('7481299','43163'),
		T_TIPO_DATA('7481316','43163'),
		T_TIPO_DATA('7481318','43163'),
		T_TIPO_DATA('7481346','43163'),
		T_TIPO_DATA('7481349','43163'),
		T_TIPO_DATA('7481354','43163'),
		T_TIPO_DATA('7481355','43163'),
		T_TIPO_DATA('7481356','43163'),
		T_TIPO_DATA('7481360','43163'),
		T_TIPO_DATA('7481367','43163'),
		T_TIPO_DATA('7481375','43163'),
		T_TIPO_DATA('7481377','43163'),
		T_TIPO_DATA('7481397','43163'),
		T_TIPO_DATA('7481400','43163'),
		T_TIPO_DATA('7481405','43163'),
		T_TIPO_DATA('7481415','43163'),
		T_TIPO_DATA('7481443','43163'),
		T_TIPO_DATA('7481468','43163'),
		T_TIPO_DATA('7481478','43163'),
		T_TIPO_DATA('7481500','43163'),
		T_TIPO_DATA('7481502','43163'),
		T_TIPO_DATA('7481506','43163'),
		T_TIPO_DATA('7481538','43163'),
		T_TIPO_DATA('7481549','43163'),
		T_TIPO_DATA('7481550','43163'),
		T_TIPO_DATA('7481577','43163'),
		T_TIPO_DATA('7481593','43163'),
		T_TIPO_DATA('7481595','43163'),
		T_TIPO_DATA('7481602','43163'),
		T_TIPO_DATA('7481614','43163'),
		T_TIPO_DATA('7481616','43163'),
		T_TIPO_DATA('7481627','43163'),
		T_TIPO_DATA('7481628','43163'),
		T_TIPO_DATA('7481632','43163'),
		T_TIPO_DATA('7481634','43163'),
		T_TIPO_DATA('7481641','43163'),
		T_TIPO_DATA('7481655','43163'),
		T_TIPO_DATA('7481663','43163'),
		T_TIPO_DATA('7481681','43163'),
		T_TIPO_DATA('7481687','43163'),
		T_TIPO_DATA('7481699','43163'),
		T_TIPO_DATA('7481708','43163'),
		T_TIPO_DATA('7481711','43163'),
		T_TIPO_DATA('7481724','43163'),
		T_TIPO_DATA('7481742','43163'),
		T_TIPO_DATA('7481748','43163'),
		T_TIPO_DATA('7481766','43163'),
		T_TIPO_DATA('7481768','43163'),
		T_TIPO_DATA('7481779','43163'),
		T_TIPO_DATA('7481785','43163'),
		T_TIPO_DATA('7481806','43163'),
		T_TIPO_DATA('7481808','43163'),
		T_TIPO_DATA('7481811','43163'),
		T_TIPO_DATA('7481824','43163'),
		T_TIPO_DATA('7481825','43163'),
		T_TIPO_DATA('7481843','43163'),
		T_TIPO_DATA('7481860','43163'),
		T_TIPO_DATA('7481868','43163'),
		T_TIPO_DATA('7481869','43163'),
		T_TIPO_DATA('7481881','43163'),
		T_TIPO_DATA('7481883','43163'),
		T_TIPO_DATA('7481887','43163'),
		T_TIPO_DATA('7481896','43163'),
		T_TIPO_DATA('7481904','43163'),
		T_TIPO_DATA('7481905','43163'),
		T_TIPO_DATA('7481914','43163'),
		T_TIPO_DATA('7481917','43163'),
		T_TIPO_DATA('7481933','43163'),
		T_TIPO_DATA('7481945','43163'),
		T_TIPO_DATA('7481955','43163'),
		T_TIPO_DATA('7481956','43163'),
		T_TIPO_DATA('7481958','43163'),
		T_TIPO_DATA('7481998','43163'),
		T_TIPO_DATA('7482001','43163'),
		T_TIPO_DATA('7482003','43163'),
		T_TIPO_DATA('7482018','43163'),
		T_TIPO_DATA('7482020','43163'),
		T_TIPO_DATA('7482028','43163'),
		T_TIPO_DATA('7482040','43163'),
		T_TIPO_DATA('7482059','43163'),
		T_TIPO_DATA('7482062','43163'),
		T_TIPO_DATA('7482063','43163'),
		T_TIPO_DATA('7482067','43163'),
		T_TIPO_DATA('7482077','43163'),
		T_TIPO_DATA('7482094','43163'),
		T_TIPO_DATA('7482095','43163'),
		T_TIPO_DATA('7482138','43163'),
		T_TIPO_DATA('7482153','43163'),
		T_TIPO_DATA('7482162','43163'),
		T_TIPO_DATA('7482169','43163'),
		T_TIPO_DATA('7482178','43163'),
		T_TIPO_DATA('7482192','43163'),
		T_TIPO_DATA('7482198','43163'),
		T_TIPO_DATA('7482207','43163'),
		T_TIPO_DATA('7482208','43163'),
		T_TIPO_DATA('7482210','43163'),
		T_TIPO_DATA('7482236','43163'),
		T_TIPO_DATA('7482249','43163'),
		T_TIPO_DATA('7482254','43163'),
		T_TIPO_DATA('7482264','43163'),
		T_TIPO_DATA('7482275','43163'),
		T_TIPO_DATA('7482277','43163'),
		T_TIPO_DATA('7482287','43163'),
		T_TIPO_DATA('7482289','43163'),
		T_TIPO_DATA('7482291','43163'),
		T_TIPO_DATA('7482316','43163'),
		T_TIPO_DATA('7482319','43163'),
		T_TIPO_DATA('7482324','43163'),
		T_TIPO_DATA('7482328','43163')

    ); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN

	 -- LOOP para insertar los valores --
    DBMS_OUTPUT.PUT_LINE('[INFO]: UPDATE EN BIE_LOCALIZACION');
    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST

    LOOP
	V_TMP_TIPO_DATA := V_TIPO_DATA(I);

		V_MSQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'';
		EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

		IF V_COUNT > 0 THEN	

			V_MSQL := 'SELECT BIE_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'';
			EXECUTE IMMEDIATE V_MSQL INTO V_BIE_ID;	

			V_MSQL:= 'UPDATE '||V_ESQUEMA||'.BIE_LOCALIZACION SET 
						DD_LOC_ID = (SELECT DD_LOC_ID FROM '||V_ESQUEMA_M||'.DD_LOC_LOCALIDAD WHERE DD_LOC_CODIGO = '''||V_TMP_TIPO_DATA(2)||'''),
						USUARIOMODIFICAR = '''||V_USU||''',
						FECHAMODIFICAR = SYSDATE
						WHERE BIE_ID = '||V_BIE_ID||'';
			EXECUTE IMMEDIATE V_MSQL;
			
			DBMS_OUTPUT.PUT_LINE('[INFO] LOCALIZACIÓN DE ACTIVO '||V_TMP_TIPO_DATA(1)||' MODIFICADA');

		ELSE 

			DBMS_OUTPUT.PUT_LINE('[INFO] NO EXISTE EL ACTIVO '||V_TMP_TIPO_DATA(1)||'');

		END IF;
        
	END LOOP;

    COMMIT;

EXCEPTION
     WHEN OTHERS THEN 
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejECVción:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;

/

EXIT;