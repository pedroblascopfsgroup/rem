--/*
--######################################### 
--## AUTOR=Carlos Santos Vílchez
--## FECHA_CREACION=20210806
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-10293
--## PRODUCTO=NO
--##            
--## INSTRUCCIONES:  Cambiar tipo y subtipo de activo en la ICO
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejECVtar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	V_USU VARCHAR2(30 CHAR) := 'REMVIP-10293';
	V_NUM_TABLAS NUMBER(16);
	V_ID NUMBER(16);
	V_COUNT NUMBER(16);

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(	
		T_TIPO_DATA('7477473'),
		T_TIPO_DATA('7476955'),
		T_TIPO_DATA('7476666'),
		T_TIPO_DATA('7477482'),
		T_TIPO_DATA('7476310'),
		T_TIPO_DATA('7477535'),
		T_TIPO_DATA('7476909'),
		T_TIPO_DATA('7477135'),
		T_TIPO_DATA('7477385'),
		T_TIPO_DATA('7477076'),
		T_TIPO_DATA('7477322'),
		T_TIPO_DATA('7477719'),
		T_TIPO_DATA('7477363'),
		T_TIPO_DATA('7476258'),
		T_TIPO_DATA('7476500'),
		T_TIPO_DATA('7476325'),
		T_TIPO_DATA('7476634'),
		T_TIPO_DATA('7477708'),
		T_TIPO_DATA('7476356'),
		T_TIPO_DATA('7476658'),
		T_TIPO_DATA('7476255'),
		T_TIPO_DATA('7477320'),
		T_TIPO_DATA('7477121'),
		T_TIPO_DATA('7476404'),
		T_TIPO_DATA('7477720'),
		T_TIPO_DATA('7476318'),
		T_TIPO_DATA('7476553'),
		T_TIPO_DATA('7477484'),
		T_TIPO_DATA('7477376'),
		T_TIPO_DATA('7476359'),
		T_TIPO_DATA('7477234'),
		T_TIPO_DATA('7477742'),
		T_TIPO_DATA('7476450'),
		T_TIPO_DATA('7476629'),
		T_TIPO_DATA('7476332'),
		T_TIPO_DATA('7476499'),
		T_TIPO_DATA('7477079'),
		T_TIPO_DATA('7477126'),
		T_TIPO_DATA('7476673'),
		T_TIPO_DATA('7477743'),
		T_TIPO_DATA('7477392'),
		T_TIPO_DATA('7477718'),
		T_TIPO_DATA('7477738'),
		T_TIPO_DATA('7476295'),
		T_TIPO_DATA('7477007'),
		T_TIPO_DATA('7476237'),
		T_TIPO_DATA('7475362'),
		T_TIPO_DATA('7475364'),
		T_TIPO_DATA('7475538'),
		T_TIPO_DATA('7475030'),
		T_TIPO_DATA('7475360'),
		T_TIPO_DATA('7475706'),
		T_TIPO_DATA('7475902'),
		T_TIPO_DATA('7475031'),
		T_TIPO_DATA('7476045'),
		T_TIPO_DATA('7475959'),
		T_TIPO_DATA('7475633'),
		T_TIPO_DATA('7476050'),
		T_TIPO_DATA('7475034'),
		T_TIPO_DATA('7475303'),
		T_TIPO_DATA('7475028'),
		T_TIPO_DATA('7475351'),
		T_TIPO_DATA('7475080'),
		T_TIPO_DATA('7476003'),
		T_TIPO_DATA('7475618'),
		T_TIPO_DATA('7475118'),
		T_TIPO_DATA('7475114'),
		T_TIPO_DATA('7474991'),
		T_TIPO_DATA('7476119'),
		T_TIPO_DATA('7475966'),
		T_TIPO_DATA('7475160'),
		T_TIPO_DATA('7476001'),
		T_TIPO_DATA('7476049'),
		T_TIPO_DATA('7476207'),
		T_TIPO_DATA('7475614'),
		T_TIPO_DATA('7475346'),
		T_TIPO_DATA('7475452'),
		T_TIPO_DATA('7475856'),
		T_TIPO_DATA('7475343'),
		T_TIPO_DATA('7475019'),
		T_TIPO_DATA('7475413'),
		T_TIPO_DATA('7475938'),
		T_TIPO_DATA('7475855'),
		T_TIPO_DATA('7475263'),
		T_TIPO_DATA('7475819'),
		T_TIPO_DATA('7475226'),
		T_TIPO_DATA('7475081'),
		T_TIPO_DATA('7475443'),
		T_TIPO_DATA('7475046'),
		T_TIPO_DATA('7476202'),
		T_TIPO_DATA('7475619'),
		T_TIPO_DATA('7475638'),
		T_TIPO_DATA('7474987'),
		T_TIPO_DATA('7475859'),
		T_TIPO_DATA('7475939'),
		T_TIPO_DATA('7475158'),
		T_TIPO_DATA('7475451'),
		T_TIPO_DATA('7475929'),
		T_TIPO_DATA('7475569'),
		T_TIPO_DATA('7475900'),
		T_TIPO_DATA('7475159'),
		T_TIPO_DATA('7475363'),
		T_TIPO_DATA('7476046'),
		T_TIPO_DATA('7475613'),
		T_TIPO_DATA('7475043'),
		T_TIPO_DATA('7475683'),
		T_TIPO_DATA('7476041'),
		T_TIPO_DATA('7475946'),
		T_TIPO_DATA('7475345'),
		T_TIPO_DATA('7475033'),
		T_TIPO_DATA('7475111'),
		T_TIPO_DATA('7475366'),
		T_TIPO_DATA('7476122'),
		T_TIPO_DATA('7477772'),
		T_TIPO_DATA('7476008'),
		T_TIPO_DATA('7475261'),
		T_TIPO_DATA('7475934'),
		T_TIPO_DATA('7475566'),
		T_TIPO_DATA('7475347'),
		T_TIPO_DATA('7475928'),
		T_TIPO_DATA('7476232'),
		T_TIPO_DATA('7475676'),
		T_TIPO_DATA('7475866'),
		T_TIPO_DATA('7475333'),
		T_TIPO_DATA('7475344'),
		T_TIPO_DATA('7476043'),
		T_TIPO_DATA('7476231'),
		T_TIPO_DATA('7475749'),
		T_TIPO_DATA('7475640'),
		T_TIPO_DATA('7475292'),
		T_TIPO_DATA('7475038'),
		T_TIPO_DATA('7475048'),
		T_TIPO_DATA('7475020'),
		T_TIPO_DATA('7475444'),
		T_TIPO_DATA('7475117'),
		T_TIPO_DATA('7475565'),
		T_TIPO_DATA('7475580'),
		T_TIPO_DATA('7475675'),
		T_TIPO_DATA('7475341'),
		T_TIPO_DATA('7475681'),
		T_TIPO_DATA('7475965'),
		T_TIPO_DATA('7475820'),
		T_TIPO_DATA('7476159'),
		T_TIPO_DATA('7475639'),
		T_TIPO_DATA('7475860'),
		T_TIPO_DATA('7476162'),
		T_TIPO_DATA('7475367'),
		T_TIPO_DATA('7475944'),
		T_TIPO_DATA('7475574'),
		T_TIPO_DATA('7475447'),
		T_TIPO_DATA('7475255'),
		T_TIPO_DATA('7475967'),
		T_TIPO_DATA('7475893'),
		T_TIPO_DATA('7475635'),
		T_TIPO_DATA('7475456'),
		T_TIPO_DATA('7476189'),
		T_TIPO_DATA('7475616'),
		T_TIPO_DATA('7475361'),
		T_TIPO_DATA('7475948')

    ); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN

    DBMS_OUTPUT.PUT_LINE('[INFO]: UPDATE EN ACT_ICO_INFO_COMERCIAL');
    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST

    LOOP
	V_TMP_TIPO_DATA := V_TIPO_DATA(I);

		V_MSQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'';
		EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

		IF V_COUNT > 0 THEN	

			V_MSQL := 'SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'';
			EXECUTE IMMEDIATE V_MSQL INTO V_ID;	

			V_MSQL:= 'UPDATE '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL SET 
						DD_TPA_ID = (SELECT DD_TPA_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_ID = '||V_ID||'),
						DD_SAC_ID = (SELECT DD_SAC_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_ID = '||V_ID||'),
						USUARIOMODIFICAR = '''||V_USU||''',
						FECHAMODIFICAR = SYSDATE
						WHERE ACT_ID = '||V_ID||'';
			EXECUTE IMMEDIATE V_MSQL;
			
			DBMS_OUTPUT.PUT_LINE('[INFO] ICO DEL ACTIVO '||V_TMP_TIPO_DATA(1)||' MODIFICADO');

		ELSE 

			DBMS_OUTPUT.PUT_LINE('[INFO] NO EXISTE EL ACTIVO '||V_TMP_TIPO_DATA(1)||'');

		END IF;
        
	END LOOP;

    COMMIT;

EXCEPTION
     WHEN OTHERS THEN 
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejECVción:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;

/

EXIT;