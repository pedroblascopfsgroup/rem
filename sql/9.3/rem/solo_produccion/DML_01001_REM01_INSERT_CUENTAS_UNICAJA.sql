--/*
--##########################################
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20210809
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=RREMVIP-10305
--## PRODUCTO=NO
--##
--## Finalidad: Script informa area peticionaria RAM trabajos
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_TEXT_TABLA VARCHAR2(27 CHAR) := 'ACT_PRO_PROPIETARIO'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_USU VARCHAR2(30 CHAR) := 'REMVIP-10307'; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.
	V_COUNT NUMBER(16);
    DNI_VIEJO VARCHAR2(100 CHAR):='A86201993';
    DNI_NUEVO VARCHAR2(100 CHAR):='A93139053';
    V_ID_VIEJO NUMBER(16);
    V_ID_NUEVO NUMBER(16);
    
BEGIN		

	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	DBMS_OUTPUT.PUT_LINE('[INFO]:  INSERTAR CUENTAS Y PARTIDAS PROPIETARIO NUEVO ');


		V_MSQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE PRO_DOCIDENTIF = '''||DNI_VIEJO||''' AND BORRADO = 0';
		EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

		IF V_COUNT = 1 THEN

            V_MSQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE PRO_DOCIDENTIF = '''||DNI_NUEVO||''' AND BORRADO = 0';
            EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

            IF V_COUNT = 1 THEN

                V_MSQL:= 'SELECT PRO_ID FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE PRO_DOCIDENTIF = '''||DNI_VIEJO||''' AND BORRADO = 0';
                EXECUTE IMMEDIATE V_MSQL INTO V_ID_VIEJO;

                 V_MSQL:= 'SELECT PRO_ID FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE PRO_DOCIDENTIF = '''||DNI_NUEVO||''' AND BORRADO = 0';
                EXECUTE IMMEDIATE V_MSQL INTO V_ID_NUEVO;

                V_MSQL:= 'INSERT INTO '||V_ESQUEMA||'.ACT_CONFIG_CTAS_CONTABLES

                        (CCC_CTAS_ID,CCC_CUENTA_CONTABLE,DD_TGA_ID,DD_STG_ID,DD_TIM_ID,DD_CRA_ID,DD_SCR_ID,PRO_ID,EJE_ID,
                        CCC_ARRENDAMIENTO,CCC_REFACTURABLE,VERSION,USUARIOCREAR,FECHACREAR,DD_TBE_ID,
                        CCC_SUBCUENTA_CONTABLE,CCC_ACTIVABLE,CCC_PLAN_VISITAS,DD_TCH_ID,CCC_PRINCIPAL,DD_TRT_ID,CCC_VENDIDO)

                        SELECT '||V_ESQUEMA||'.S_ACT_CONFIG_CTAS_CONTABLES.NEXTVAL,
                        CONF.CCC_CUENTA_CONTABLE,CONF.DD_TGA_ID,CONF.DD_STG_ID,CONF.DD_TIM_ID,CONF.DD_CRA_ID,CONF.DD_SCR_ID,'||V_ID_NUEVO||',
                        CONF.EJE_ID,CONF.CCC_ARRENDAMIENTO,CONF.CCC_REFACTURABLE,0,'''||V_USU||''' AS USUARIOCREAR, SYSDATE AS FECHACREAR  ,
                        CONF.DD_TBE_ID,CONF.CCC_SUBCUENTA_CONTABLE, CONF.CCC_ACTIVABLE,CONF.CCC_PLAN_VISITAS,CONF.DD_TCH_ID,CONF.CCC_PRINCIPAL,CONF.DD_TRT_ID, CONF.CCC_VENDIDO
                        FROM '||V_ESQUEMA||'.ACT_CONFIG_CTAS_CONTABLES CONF WHERE CONF.PRO_ID='||V_ID_VIEJO||' AND CONF.BORRADO = 0
                            ';
                EXECUTE IMMEDIATE V_MSQL;
                
                DBMS_OUTPUT.PUT_LINE('[INFO]: INSERTAMOS EN ACT_CONFIG_CTAS_CONTABLES CUENTAS PROPIETARIO '''||DNI_NUEVO||''' DEL PROPIETARIO '''||DNI_VIEJO||''' ');
                DBMS_OUTPUT.PUT_LINE('[INFO]: REGISTROS INSERTADOS: '|| SQL%ROWCOUNT ||' ');

                V_MSQL:= 'INSERT INTO '||V_ESQUEMA||'.ACT_CONFIG_PTDAS_PREP

                        (CPP_PTDAS_ID,CPP_PARTIDA_PRESUPUESTARIA,DD_TGA_ID,DD_STG_ID,DD_TIM_ID,DD_CRA_ID,DD_SCR_ID,PRO_ID,EJE_ID,
                        CPP_ARRENDAMIENTO,CPP_REFACTURABLE,VERSION,USUARIOCREAR,FECHACREAR,CPP_PRINCIPAL,DD_TBE_ID,
                        CPP_APARTADO,CPP_CAPITULO,CPP_ACTIVABLE,CPP_PLAN_VISITAS,DD_TCH_ID,DD_TRT_ID,CPP_VENDIDO)

                        SELECT '||V_ESQUEMA||'.S_ACT_CONFIG_PTDAS_PREP.NEXTVAL,
                        CONF.CPP_PARTIDA_PRESUPUESTARIA,CONF.DD_TGA_ID,CONF.DD_STG_ID,CONF.DD_TIM_ID,CONF.DD_CRA_ID,CONF.DD_SCR_ID,'||V_ID_NUEVO||',
                        CONF.EJE_ID,CPP_ARRENDAMIENTO,CPP_REFACTURABLE,0,'''||V_USU||''' AS USUARIOCREAR, SYSDATE AS FECHACREAR ,
                        CONF.CPP_PRINCIPAL,CONF.DD_TBE_ID,CONF.CPP_APARTADO,CONF.CPP_CAPITULO,CONF.CPP_ACTIVABLE,CONF.CPP_PLAN_VISITAS,
                        CONF.DD_TCH_ID,CONF.DD_TRT_ID,CONF.CPP_VENDIDO        
                        FROM '||V_ESQUEMA||'.ACT_CONFIG_PTDAS_PREP CONF WHERE CONF.PRO_ID='''||V_ID_VIEJO||''' AND CONF.BORRADO = 0
                            ';
                EXECUTE IMMEDIATE V_MSQL;
                
                DBMS_OUTPUT.PUT_LINE('[INFO]: INSERTAMOS EN ACT_CONFIG_PTDAS_PREP CUENTAS PROPIETARIO '''||DNI_NUEVO||''' DEL PROPIETARIO '''||DNI_VIEJO||''' ');
                DBMS_OUTPUT.PUT_LINE('[INFO]: REGISTROS INSERTADOS: '|| SQL%ROWCOUNT ||' ');

            ELSE

			DBMS_OUTPUT.PUT_LINE('[INFO]: PROPIETARIO '||DNI_NUEVO||' NO EXISTE O ESTA BORRADO');

		    END IF;

		ELSE

			DBMS_OUTPUT.PUT_LINE('[INFO]: PROPIETARIO '||DNI_VIEJO||' NO EXISTE O ESTA BORRADO');

		END IF;


	COMMIT;
    DBMS_OUTPUT.PUT_LINE('[INFO]: REGISTROS INSERTADOS CORRECTAMENTE');
	DBMS_OUTPUT.PUT_LINE('[FIN]');


EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;

/

EXIT