--/*
--#########################################
--## AUTOR=PIER GOTTA
--## FECHA_CREACION=20211115
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.11
--## INCIDENCIA_LINK=REMVIP-10757
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##                    
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
V_SENTENCIA VARCHAR2(2000 CHAR);
V_NUM_TABLAS NUMBER(16);
V_MSQL VARCHAR2(32000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.

BEGIN 
 

	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZACIÓN NUMERO DE EXPEDIENTES.');
 
         V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO USING(
			SELECT ECO.ECO_ID, ECO2.ECO_NUM_EXPEDIENTE FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO 
			JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = ECO.OFR_ID
			JOIN '||V_ESQUEMA||'.MIG2_OFR_MAPEO_NUM_OFERTAS MIG ON MIG.COD_OFERTA_CAIXA = OFR.OFR_NUM_OFERTA
			JOIN '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA CAI ON CAI.NUM_OFERTA = MIG.COD_OFERTA_CAIXA
			JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO2 ON ECO2.ECO_ID = CAI.ECO_ID
			WHERE OFR.USUARIOCREAR = ''MIG_CAIXA'') AUX ON  (AUX.ECO_ID = ECO.ECO_ID)
			WHEN MATCHED THEN UPDATE SET
			ECO.ECO_NUM_EXPEDIENTE = AUX.ECO_NUM_EXPEDIENTE,
			ECO.USUARIOMODIFICAR = ''REMVIP-10757'',
			ECO.FECHAMODIFICAR = SYSDATE';
   	  	EXECUTE IMMEDIATE V_MSQL;
  
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' Actualizadas '||SQL%ROWCOUNT||' Filas.');
  
           V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO USING(
		SELECT ECO.ECO_ID, LPAD(ECO_NUM_EXPEDIENTE,7,9) AS NUEVO_EXPEDIENTE FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO
		JOIN '||V_ESQUEMA||'.MIG2_CAIXA_POSICIONAMIENTO_OFERTA CAI ON ECO.ECO_ID = CAI.ECO_ID
		) AUX ON  (AUX.ECO_ID = ECO.ECO_ID)
		WHEN MATCHED THEN UPDATE SET
		ECO.ECO_NUM_EXPEDIENTE = AUX.NUEVO_EXPEDIENTE,
		ECO.USUARIOMODIFICAR = ''REMVIP-10757'',
		ECO.FECHAMODIFICAR = SYSDATE';
		
   	  	EXECUTE IMMEDIATE V_MSQL;
  
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' Actualizadas '||SQL%ROWCOUNT||' Filas.');
  
  COMMIT;
  

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT;
