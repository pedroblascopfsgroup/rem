--/*
--#########################################
--## AUTOR=Daniel Algaba
--## FECHA_CREACION=20211116
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.11
--## INCIDENCIA_LINK=HREOS-16321
--## PRODUCTO=NO
--## 
--## Finalidad: 
--##                    
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01';
V_SENTENCIA VARCHAR2(2000 CHAR);
V_NUM_TABLAS NUMBER(16);
V_MSQL VARCHAR2(32000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.

BEGIN 
 

	DBMS_OUTPUT.PUT_LINE('[INFO] ACTUALIZACIÓN AHP Y PORTALES');
 
         V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION APU
					USING (
						SELECT
								DD_POR_ID
								,ACT_ID
							FROM(
							SELECT
									CASE
										WHEN TCO.DD_TCO_CODIGO=''01'' AND CAI.CBX_PUBL_PORT_PUBL_VENTA=1 THEN ''01''
										WHEN TCO.DD_TCO_CODIGO=''03'' AND CAI.CBX_PUBL_PORT_PUBL_ALQUILER=1 THEN ''01''
										WHEN TCO.DD_TCO_CODIGO=''02'' AND (CAI.CBX_PUBL_PORT_PUBL_VENTA=1 OR CAI.CBX_PUBL_PORT_PUBL_ALQUILER=1) THEN ''01''
										WHEN TCO.DD_TCO_CODIGO=''01'' AND CAI.CBX_PUBL_PORT_PUBL_VENTA=0 AND CAI.CBX_PUBL_PORT_INV_VENTA=1 THEN ''02''
										WHEN TCO.DD_TCO_CODIGO=''03'' AND CAI.CBX_PUBL_PORT_PUBL_ALQUILER=0  AND CAI.CBX_PUBL_PORT_INV_ALQUILER=1 THEN ''02''
										WHEN TCO.DD_TCO_CODIGO=''02'' AND CAI.CBX_PUBL_PORT_PUBL_VENTA=0  AND CAI.CBX_PUBL_PORT_PUBL_ALQUILER=0 AND
											CAI.CBX_PUBL_PORT_INV_VENTA=1 AND CAI.CBX_PUBL_PORT_INV_ALQUILER =1 THEN ''02''
										WHEN CAI.CBX_PUBL_PORT_PUBL_VENTA=0  AND CAI.CBX_PUBL_PORT_PUBL_ALQUILER=0  AND
											CAI.CBX_PUBL_PORT_INV_VENTA=0  AND CAI.CBX_PUBL_PORT_INV_ALQUILER=0  THEN NULL
									END AS DD_POR_CODIGO
									,ACT.ACT_ID AS ACT_ID
							FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
							JOIN '||V_ESQUEMA||'.AUX_APR_BCR_STOCK AUX ON ACT.ACT_NUM_ACTIVO_CAIXA=AUX.NUM_IDENTIFICATIVO
							JOIN '||V_ESQUEMA||'.ACT_ACTIVO_CAIXA CAI ON CAI.ACT_ID=ACT.ACT_ID AND CAI.BORRADO=0
							JOIN '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION APU ON ACT.ACT_ID=APU.ACT_ID
							JOIN '||V_ESQUEMA||'.DD_TCO_TIPO_COMERCIALIZACION TCO ON APU.DD_TCO_ID=TCO.DD_TCO_ID
							) AUX
							LEFT JOIN '||V_ESQUEMA||'.DD_POR_PORTAL POR ON AUX.DD_POR_CODIGO=POR.DD_POR_CODIGO

							) US ON (US.ACT_ID = APU.ACT_ID)
							WHEN MATCHED THEN UPDATE SET
								APU.DD_POR_ID=US.DD_POR_ID
								,APU.USUARIOMODIFICAR = ''STOCK_BC''
								,APU.FECHAMODIFICAR = SYSDATE
								WHERE APU.BORRADO=0 AND NVL(APU.DD_POR_ID,0)!=NVL(US.DD_POR_ID,0)';
   	  	EXECUTE IMMEDIATE V_MSQL;
  
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' Actualizadas '||SQL%ROWCOUNT||' Filas de portales.');

           V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_AHP_HIST_PUBLICACION AHP
					USING (
						SELECT AHP.AHP_ID
						FROM '||V_ESQUEMA||'.ACT_AHP_HIST_PUBLICACION AHP
						JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AHP.ACT_ID
						WHERE ACT.BORRADO = 0
							AND ACT.DD_CRA_ID = 21
							AND AHP.BORRADO = 0
							AND AHP.USUARIOCREAR = ''PROC_CALCULO_PORTAL''
							AND TRUNC(AHP.FECHACREAR) > TO_DATE(''05/11/2021'', ''dd/mm/yy'')
							AND ACT.ACT_NUM_ACTIVO_CAIXA IS NOT NULL
					) AUX
						ON (AHP.AHP_ID = AUX.AHP_ID)
					WHEN MATCHED THEN
						UPDATE SET AHP.BORRADO = 1
						, AHP.USUARIOBORRAR = ''STOCK_BC''
						, AHP.FECHABORRAR = SYSDATE';
   	  	EXECUTE IMMEDIATE V_MSQL;
  
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' Actualizadas '||SQL%ROWCOUNT||' Filas que se dan de baja en la AHP.');

           V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_AHP_HIST_PUBLICACION AHP
						USING (
							SELECT TMP.AHP_ID FROM (SELECT ROW_NUMBER() OVER(PARTITION BY AHP.ACT_ID ORDER BY AHP.FECHACREAR DESC) RN, AHP.AHP_ID
							FROM '||V_ESQUEMA||'.ACT_AHP_HIST_PUBLICACION AHP
							JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AHP.ACT_ID
							WHERE ACT.BORRADO = 0
								AND ACT.DD_CRA_ID = 21
								AND AHP.BORRADO = 0
								AND AHP.AHP_FECHA_INI_VENTA IS NOT NULL
								AND AHP.AHP_FECHA_FIN_VENTA IS NOT NULL
								AND AHP.USUARIOMODIFICAR = ''PROC_CALCULO_PORTAL''
								AND TRUNC(AHP.FECHAMODIFICAR) > TO_DATE(''05/11/2021'', ''dd/mm/yy'')
								AND ACT.ACT_NUM_ACTIVO_CAIXA IS NOT NULL) TMP WHERE RN = 1
						) AUX
							ON (AHP.AHP_ID = AUX.AHP_ID)
						WHEN MATCHED THEN
							UPDATE SET AHP.AHP_FECHA_FIN_VENTA = NULL
							, AHP.USUARIOMODIFICAR = NULL
							, AHP.FECHAMODIFICAR = NULL';
   	  	EXECUTE IMMEDIATE V_MSQL;
  
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' Actualizadas '||SQL%ROWCOUNT||' Filas a reactivar en la AHP.');

           V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_AHP_HIST_PUBLICACION AHP
						USING (
							SELECT TMP.AHP_ID FROM (SELECT ROW_NUMBER() OVER(PARTITION BY AHP.ACT_ID ORDER BY AHP.FECHACREAR DESC) RN, AHP.AHP_ID
							FROM '||V_ESQUEMA||'.ACT_AHP_HIST_PUBLICACION AHP
							JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AHP.ACT_ID
							JOIN '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION APU ON ACT.ACT_ID = APU.ACT_ID
							WHERE ACT.BORRADO = 0
								AND ACT.DD_CRA_ID = 21
								AND AHP.BORRADO = 0
								AND AHP.AHP_FECHA_INI_VENTA IS NOT NULL
								AND AHP.AHP_FECHA_FIN_VENTA IS NULL
								AND ACT.ACT_NUM_ACTIVO_CAIXA IS NOT NULL
								AND NVL(APU.DD_POR_ID,0) <> NVL(AHP.DD_POR_ID,0)
							) TMP WHERE RN = 1
						) AUX
							ON (AHP.AHP_ID = AUX.AHP_ID)
						WHEN MATCHED THEN
							UPDATE SET AHP.AHP_FECHA_FIN_VENTA = TO_DATE(''15/11/21'', ''dd/mm/yy'')
							, AHP.USUARIOMODIFICAR = ''STOCK_BC''
							, AHP.FECHAMODIFICAR = TO_DATE(''15/11/21'', ''dd/mm/yy'')';
   	  	EXECUTE IMMEDIATE V_MSQL;
  
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' Actualizadas '||SQL%ROWCOUNT||' Filas a finalizar por portal diferente.');

           V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_AHP_HIST_PUBLICACION (AHP_ID,ACT_ID
						,DD_TPU_A_ID,DD_TPU_V_ID,DD_EPV_ID,DD_EPA_ID,DD_TCO_ID,DD_MTO_V_ID
						,AHP_MOT_OCULTACION_MANUAL_V,AHP_CHECK_PUBLICAR_V,AHP_CHECK_OCULTAR_V
						,AHP_CHECK_OCULTAR_PRECIO_V,AHP_CHECK_PUB_SIN_PRECIO_V
						,DD_MTO_A_ID
						,AHP_MOT_OCULTACION_MANUAL_A,AHP_CHECK_PUBLICAR_A
						,AHP_CHECK_OCULTAR_A,AHP_CHECK_OCULTAR_PRECIO_A
						,AHP_CHECK_PUB_SIN_PRECIO_A
						,AHP_FECHA_INI_VENTA
						,DD_POR_ID
						,VERSION
						,USUARIOCREAR,FECHACREAR
						,BORRADO
						,ES_CONDICONADO_ANTERIOR)
						SELECT '||V_ESQUEMA||'.S_ACT_AHP_HIST_PUBLICACION.NEXTVAL, APU.ACT_ID
						,APU.DD_TPU_A_ID,APU.DD_TPU_V_ID,APU.DD_EPV_ID,APU.DD_EPA_ID,APU.DD_TCO_ID,APU.DD_MTO_V_ID
						,APU.APU_MOT_OCULTACION_MANUAL_V,APU.APU_CHECK_PUBLICAR_V,APU.APU_CHECK_OCULTAR_V
						,APU.APU_CHECK_OCULTAR_PRECIO_V,APU.APU_CHECK_PUB_SIN_PRECIO_V
						,APU.DD_MTO_A_ID
						,APU.APU_MOT_OCULTACION_MANUAL_A,APU.APU_CHECK_PUBLICAR_A
						,APU.APU_CHECK_OCULTAR_A,APU.APU_CHECK_OCULTAR_PRECIO_A
						,APU.APU_CHECK_PUB_SIN_PRECIO_A
						,TO_DATE(''15/11/21'', ''dd/mm/yy'') AHP_FECHA_INI_VENTA
						,APU.DD_POR_ID
						,APU.VERSION
						,''STOCK_BC'' USUARIOCREAR
						, TO_DATE(''15/11/21'', ''dd/mm/yy'') FECHACREAR
						,0 BORRADO
						,APU.ES_CONDICONADO_ANTERIOR
						FROM (SELECT ROW_NUMBER() OVER(PARTITION BY AHP.ACT_ID ORDER BY AHP.FECHACREAR DESC) RN, AHP.ACT_ID
						FROM '||V_ESQUEMA||'.ACT_AHP_HIST_PUBLICACION AHP
						JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AHP.ACT_ID
						JOIN '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION APU ON ACT.ACT_ID = APU.ACT_ID
						WHERE ACT.BORRADO = 0
							AND ACT.DD_CRA_ID = 21
							AND AHP.BORRADO = 0
							AND AHP.AHP_FECHA_INI_VENTA IS NOT NULL
							AND AHP.AHP_FECHA_FIN_VENTA IS NOT NULL
							AND AHP.USUARIOMODIFICAR = ''STOCK_BC''
							AND ACT.ACT_NUM_ACTIVO_CAIXA IS NOT NULL
							AND NVL(APU.DD_POR_ID,0) <> NVL(AHP.DD_POR_ID,0)
						) AUX
						JOIN '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION APU ON APU.ACT_ID = AUX.ACT_ID AND APU.BORRADO = 0
						WHERE AUX.RN = 1';
   	  	EXECUTE IMMEDIATE V_MSQL;
  
  DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||' Actualizadas '||SQL%ROWCOUNT||' Filas a insertar por cambiar el portal.');
  
  
  COMMIT;
  

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT;
