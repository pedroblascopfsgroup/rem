--/*
--#########################################
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20211203
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-10251
--## PRODUCTO=NO
--## 
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 VersiÃ³n inicial
--#########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

	V_MSQL VARCHAR(4000 CHAR);
	TABLE_COUNT NUMBER(1,0) := 0;
	V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
	V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
	V_USUARIO VARCHAR2(200 CHAR):='REMVIP-10864';
   	PL_OUTPUT VARCHAR2(32000 CHAR);
    	P_ACT_ID NUMBER;
    	P_ALL_ACTIVOS NUMBER;
   	V_MAX_PTO_ID NUMBER(16,0);
    	V_EJE_ID NUMBER(16,0);
    	V_COUNT NUMBER(16):= 0;
    	V_COUNT2 NUMBER(16):= 0;
    	HORA_INI TIMESTAMP;
    	HORA_FIN TIMESTAMP;
    	v_n  INTERVAL DAY TO SECOND ;
      

BEGIN			

V_MSQL := 'DELETE FROM PFSREM.TMP_ACTIVOS_OCULTO_APROBADO';
	EXECUTE IMMEDIATE V_MSQL;

V_MSQL := 'DELETE FROM PFSREM.TMP_AGRUPACIONES_OCULTO_APROBADO';
	EXECUTE IMMEDIATE V_MSQL;
	
	V_MSQL := 'INSERT INTO PFSREM.TMP_ACTIVOS_OCULTO_APROBADO (ACT_ID, EJECUTADO)
		SELECT DISTINCT ACT.ACT_ID, 0 EJECUTADO
		FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
		JOIN '||V_ESQUEMA||'.ACT_OFR AO ON AO.ACT_ID = ACT.ACT_ID
		JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = AO.OFR_ID
			AND OFR.BORRADO = 0
		JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID 
			AND ECO.BORRADO = 0
		LEFT JOIN '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION MTO ON MTO.DD_MTO_CODIGO = ''18'' 
			AND MTO.BORRADO = 0
		JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID 
			AND CRA.BORRADO = 0
		JOIN '||V_ESQUEMA||'.ACT_TBJ_TRABAJO TBJ ON TBJ.TBJ_ID=ECO.TBJ_ID 
			AND TBJ.BORRADO = 0
		JOIN '||V_ESQUEMA||'.DD_TTR_TIPO_TRABAJO TTR ON TTR.DD_TTR_ID=TBJ.DD_TTR_ID 
			AND TTR.BORRADO=0
		JOIN '||V_ESQUEMA||'.ACT_TRA_TRAMITE TRA ON TRA.TBJ_ID=ECO.TBJ_ID 
			AND TRA.BORRADO = 0
		JOIN '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC ON TAC.TRA_ID=TRA.TRA_ID
		JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID=TAC.TAR_ID
		JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID=TAR.TAR_ID
		JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID=TEX.TAP_ID 
			AND TAP.BORRADO = 0
		JOIN '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR TEV ON TEV.TEX_ID=TEX.TEX_ID 
			AND TEV.BORRADO = 0
		WHERE ACT.BORRADO = 0 
			AND CRA.DD_CRA_CODIGO=''03'' 
			AND TTR.DD_TTR_CODIGO=''06'' 
			AND TAP.TAP_CODIGO IN (''T017_ResolucionCES'',''T015_ElevarASancion'')
			AND (TAR.TAR_TAREA_FINALIZADA=1 OR (TAR.BORRADO = 1 AND TAC.BORRADO = 1))
			AND (TEV.TEV_NOMBRE = ''comboResolucion'' AND TEV.TEV_VALOR=''01'' OR (TEV.TEV_NOMBRE=''resolucionOferta'' AND TEV.TEV_VALOR=''01''))
            AND ACT.ACT_ID NOT IN (SELECT AGA.ACT_ID
				   FROM  '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO AGA
                   JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON AGA.ACT_ID=ACT.ACT_ID AND ACT.BORRADO = 0
                   JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID=ACT.DD_CRA_ID AND CRA.BORRADO = 0 AND CRA.DD_CRA_CODIGO=''03''
				   JOIN '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_ID = AGA.AGR_ID AND AGR.BORRADO = 0
				   JOIN '||V_ESQUEMA||'.DD_TAG_TIPO_AGRUPACION TAG ON TAG.DD_TAG_ID = AGR.DD_TAG_ID AND TAG.BORRADO = 0 AND TAG.DD_TAG_CODIGO IN (''02''/*Restringida*/ ,''17''/*Restringida alquiler*/,''18''/*Restringida OBREM*/)	
					   AND (AGR.AGR_FIN_VIGENCIA IS NULL OR TRUNC(AGR.AGR_FIN_VIGENCIA) >= TRUNC(SYSDATE))
				  WHERE AGA.ACT_ID = ACT.ACT_ID 
					AND AGA.BORRADO = 0)';
	EXECUTE IMMEDIATE V_MSQL;
DBMS_OUTPUT.PUT_LINE('[FIN] INSERTADOS ACTIVOS '||SQL%ROWCOUNT||' ');


    	V_MSQL := 'INSERT INTO PFSREM.TMP_AGRUPACIONES_OCULTO_APROBADO (AGR_ID, EJECUTADO)
				WITH AGRUPACIONES AS (
        SELECT AGA.ACT_ID,AGR.AGR_ID,AGR.AGR_NUM_AGRUP_REM
				   FROM  '||V_ESQUEMA||'.ACT_AGA_AGRUPACION_ACTIVO AGA
                   JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON AGA.ACT_ID=ACT.ACT_ID AND ACT.BORRADO = 0
                   JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID=ACT.DD_CRA_ID AND CRA.BORRADO = 0 AND CRA.DD_CRA_CODIGO=''03''
				   JOIN '||V_ESQUEMA||'.ACT_AGR_AGRUPACION AGR ON AGR.AGR_ID = AGA.AGR_ID AND AGR.BORRADO = 0
				   JOIN '||V_ESQUEMA||'.DD_TAG_TIPO_AGRUPACION TAG ON TAG.DD_TAG_ID = AGR.DD_TAG_ID AND TAG.BORRADO = 0 AND TAG.DD_TAG_CODIGO IN (''02''/*Restringida*/ ,''17''/*Restringida alquiler*/,''18''/*Restringida OBREM*/)	
					   AND (AGR.AGR_FIN_VIGENCIA IS NULL OR TRUNC(AGR.AGR_FIN_VIGENCIA) >= TRUNC(SYSDATE))
				  WHERE AGA.ACT_ID = ACT.ACT_ID 
					AND AGA.BORRADO = 0
        )
        SELECT DISTINCT AGR2.AGR_ID, 0 EJECUTADO
		FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
		JOIN '||V_ESQUEMA||'.ACT_OFR AO ON AO.ACT_ID = ACT.ACT_ID
		JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = AO.OFR_ID
			AND OFR.BORRADO = 0
		JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = OFR.OFR_ID 
			AND ECO.BORRADO = 0
		LEFT JOIN '||V_ESQUEMA||'.DD_MTO_MOTIVOS_OCULTACION MTO ON MTO.DD_MTO_CODIGO = ''18'' 
			AND MTO.BORRADO = 0
		JOIN '||V_ESQUEMA||'.DD_CRA_CARTERA CRA ON CRA.DD_CRA_ID = ACT.DD_CRA_ID 
			AND CRA.BORRADO = 0
		JOIN '||V_ESQUEMA||'.ACT_TBJ_TRABAJO TBJ ON TBJ.TBJ_ID=ECO.TBJ_ID 
			AND TBJ.BORRADO = 0
		JOIN '||V_ESQUEMA||'.DD_TTR_TIPO_TRABAJO TTR ON TTR.DD_TTR_ID=TBJ.DD_TTR_ID 
			AND TTR.BORRADO=0
		JOIN '||V_ESQUEMA||'.ACT_TRA_TRAMITE TRA ON TRA.TBJ_ID=ECO.TBJ_ID 
			AND TRA.BORRADO = 0
		JOIN '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC ON TAC.TRA_ID=TRA.TRA_ID
		JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID=TAC.TAR_ID
		JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID=TAR.TAR_ID
		JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID=TEX.TAP_ID 
			AND TAP.BORRADO = 0
		JOIN '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR TEV ON TEV.TEX_ID=TEX.TEX_ID 
			AND TEV.BORRADO = 0
        JOIN AGRUPACIONES AGR2 ON AGR2.ACT_ID=ACT.ACT_ID
		WHERE ACT.BORRADO = 0 
			AND CRA.DD_CRA_CODIGO=''03'' 
			AND TTR.DD_TTR_CODIGO=''06'' 
			AND TAP.TAP_CODIGO IN (''T017_ResolucionCES'',''T015_ElevarASancion'')
			AND (TAR.TAR_TAREA_FINALIZADA=1 OR (TAR.BORRADO = 1 AND TAC.BORRADO = 1))
			AND (TEV.TEV_NOMBRE = ''comboResolucion'' AND TEV.TEV_VALOR=''01'' OR (TEV.TEV_NOMBRE=''resolucionOferta'' AND TEV.TEV_VALOR=''01''))';
	EXECUTE IMMEDIATE V_MSQL;
	    DBMS_OUTPUT.PUT_LINE('[FIN] INSERTADOS AGRUPACIONES '||SQL%ROWCOUNT||' ');
	    DBMS_OUTPUT.PUT_LINE('[FIN] Ha finalizado la INSERCCION ');

        DBMS_OUTPUT.PUT_LINE('[FIN] LLAMAMOS SP... ');
    PFSREM.SP_RECURSIVO_PUBLICACIONES_ACTIVOS(1);
	    
      DBMS_OUTPUT.PUT_LINE('[FIN] Finalizada llamada SP correctamente ');
  	COMMIT;
	
EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT