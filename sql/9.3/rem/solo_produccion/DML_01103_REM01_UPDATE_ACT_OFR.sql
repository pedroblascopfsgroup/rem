--/*
--##########################################
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20211228
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-10990
--## PRODUCTO=NO
--##
--## INSTRUCCIONES: 
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/
WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF; 
DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquemas
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.
    V_NUM_FILAS NUMBER(16); -- Vble. para validar la existencia de un registro.
    V_NUM_FILAS2 NUMBER(16); -- Vble. para validar la existencia de un registro.
    V_NUM_FILAS3 NUMBER(16); -- Vble. para validar la existencia de un registro.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-10990'; -- USUARIOCREAR/USUARIOMODIFICAR.
    V_ECO_ID NUMBER(16); 
    
    ACT_NUM_ACTIVO NUMBER(16);
    V_COUNT_UPDATE NUMBER(16):= 0; -- Vble. para contar updates
    
    TYPE T_JBV IS TABLE OF VARCHAR2(32000);
    TYPE T_ARRAY_JBV IS TABLE OF T_JBV; 
	
	V_JBV T_ARRAY_JBV := T_ARRAY_JBV(
T_JBV(90371549,7460085,'139847'),
T_JBV(90371549,7224040,'47758'),
T_JBV(90371549,7031775,'37547'),
T_JBV(90371549,7466470,'85359'),
T_JBV(90371549,7031733,'69644'),
T_JBV(90371549,7018765,'119661'),
T_JBV(90371549,7226674,'56028'),
T_JBV(90371549,7225988,'101107'),
T_JBV(90371549,6976740,'6356'),
T_JBV(90371549,7288609,'77822'),
T_JBV(90371549,7294300,'80719'),
T_JBV(90371549,7294207,'67097'),
T_JBV(90371549,6964835,'52167'),
T_JBV(90371549,6891905,'83015'),
T_JBV(90371549,7385557,'45037'),
T_JBV(90371549,6976442,'44499'),
T_JBV(90371549,6976467,'59967'),
T_JBV(90371549,7302236,'40870'),
T_JBV(90371549,7330233,'67239'),
T_JBV(90371549,7330062,'29515'),
T_JBV(90371549,7330046,'85429'),
T_JBV(90371549,7386209,'82314'),
T_JBV(90371549,7300580,'69671'),
T_JBV(90371549,7387356,'96726'),
T_JBV(90371549,6835288,'88701'),
T_JBV(90371549,7396781,'117800'),
T_JBV(90371549,7432464,'67826'),
T_JBV(90371549,7431879,'163955'),
T_JBV(90371549,7433818,'83694'),
T_JBV(90371549,7434938,'53864'),
T_JBV(90362346,7461030,'46113'),
T_JBV(90362346,6961813,'61270'),
T_JBV(90362346,7466627,'52057'),
T_JBV(90362346,7461441,'48255'),
T_JBV(90362346,6891061,'49241'),
T_JBV(90362346,7068208,'224839'),
T_JBV(90362346,7302981,'50232'),
T_JBV(90362346,6940676,'84106'),
T_JBV(90362346,7424178,'75571'),
T_JBV(90362346,7300179,'43298'),
T_JBV(90362346,7225874,'57810'),
T_JBV(90362346,7303433,'39245'),
T_JBV(90362346,6971698,'43274'),
T_JBV(90362346,6891593,'62645'),
T_JBV(90362346,7228870,'38537'),
T_JBV(90362346,6818990,'58863'),
T_JBV(90362346,6823541,'54269'),
T_JBV(90362346,7297917,'41902'),
T_JBV(90362346,7403191,'116176'),
T_JBV(90362346,6934613,'33842'),
T_JBV(90362346,7298204,'48314'),
T_JBV(90362346,6934669,'30027'),
T_JBV(90362346,7299561,'72741'),
T_JBV(90362346,7075514,'28163'),
T_JBV(90362346,7075710,'42370'),
T_JBV(90362346,7076217,'73524'),
T_JBV(90362346,7302935,'53441'),
T_JBV(90362346,7386212,'37364'),
T_JBV(90362346,7386291,'35401'),
T_JBV(90362346,7386217,'54600'),
T_JBV(90362346,7396799,'29997'),
T_JBV(90362346,7403414,'66458'),
T_JBV(90362346,6833292,'47728'),
T_JBV(90362346,7423262,'47000'),
T_JBV(90362346,7432947,'37004'),
T_JBV(90362346,7431880,'108474'),
T_JBV(90362351,7297949,'50285'),
T_JBV(90362351,7297961,'45594'),
T_JBV(90362351,7297945,'59718'),
T_JBV(90362351,7297994,'60537'),
T_JBV(90362351,7297971,'58763'),
T_JBV(90362351,7297915,'69239'),
T_JBV(90362351,7297972,'43061'),
T_JBV(90362351,7297977,'43911'),
T_JBV(90362351,7297946,'45811'),
T_JBV(90362351,7297995,'61917'),
T_JBV(90362351,7297928,'43475'),
T_JBV(90362351,7297920,'46822'),
T_JBV(90362351,7297986,'66603'),
T_JBV(90362351,7297959,'44351'),
T_JBV(90362351,7297999,'54752'),
T_JBV(90362351,7297931,'60099'),
T_JBV(90362351,7297968,'56261'),
T_JBV(90362351,7297950,'62899'),
T_JBV(90362351,7298010,'52760'),
T_JBV(90362351,7297948,'64754'),
T_JBV(90362112,6036344,'70860'),
T_JBV(90362112,6042676,'55198'),
T_JBV(90362112,6028931,'70016'),
T_JBV(90362112,6028929,'65824'),
T_JBV(90362112,6028928,'55820'),
T_JBV(90362112,6042677,'51546'),
T_JBV(90362112,6042674,'4904'),
T_JBV(90362112,6028930,'57019'),
T_JBV(90362112,6034685,'59439'),
T_JBV(90362112,6034684,'55618'),
T_JBV(90362112,6042675,'4577'),
T_JBV(90362112,6036342,'4904'),
T_JBV(90362112,6034683,'4108'),
T_JBV(90362112,6036343,'8241'),
T_JBV(90362112,6034682,'5659'),
T_JBV(90362112,6042673,'5890'),
T_JBV(90362112,6028927,'4904'),
T_JBV(90362112,6028926,'4226')
	); 
	V_TMP_JBV T_JBV;
    
BEGIN	
	
	FOR I IN V_JBV.FIRST .. V_JBV.LAST
	
	LOOP
 
	V_TMP_JBV := V_JBV(I);
	
  	ACT_NUM_ACTIVO := TRIM(V_TMP_JBV(2));
	
	V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE BORRADO = 0 AND ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO;
	
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS;

    	V_SQL := 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.OFR_OFERTAS WHERE BORRADO = 0 AND OFR_NUM_OFERTA = '||V_TMP_JBV(1)||'';
	
	EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS2;

    V_SQL :='SELECT COUNT(*) FROM '||V_ESQUEMA||'.ACT_OFR AOF
    JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID=AOF.ACT_ID AND ACT.BORRADO = 0
    JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID=AOF.OFR_ID AND OFR.BORRADO =0
    WHERE ACT.ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||' AND OFR.OFR_NUM_OFERTA='||V_TMP_JBV(1)||'';
    EXECUTE IMMEDIATE V_SQL INTO V_NUM_FILAS3;
	
	IF V_NUM_FILAS = 1 AND V_NUM_FILAS2 = 1 AND V_NUM_FILAS3 = 1 THEN
		V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_OFR 
							SET 
                            ACT_OFR_IMPORTE = '''||V_TMP_JBV(3)||''',
							OFR_ACT_PORCEN_PARTICIPACION = 100 * ('''||V_TMP_JBV(3)||'''/ (SELECT OFR_IMPORTE 
                            FROM '||V_ESQUEMA||'.OFR_OFERTAS WHERE OFR_NUM_OFERTA = '||V_TMP_JBV(1)||'))
                            WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||ACT_NUM_ACTIVO||')
                            AND OFR_ID = (SELECT OFR_ID FROM '||V_ESQUEMA||'.OFR_OFERTAS WHERE OFR_NUM_OFERTA = '||V_TMP_JBV(1)||')';
	
		EXECUTE IMMEDIATE V_MSQL;
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO CON ACT_NUM_ACTIVO: '||ACT_NUM_ACTIVO||' ACTUALIZADO');
		
		V_COUNT_UPDATE := V_COUNT_UPDATE + 1;
		
	ELSE
		
		DBMS_OUTPUT.PUT_LINE('[INFO] REGISTRO NO EXISTE');
		
	END IF;
	
	END LOOP;
		
	COMMIT;
	
	DBMS_OUTPUT.PUT_LINE('[FIN] Se han updateado en total '||V_COUNT_UPDATE||' registros');
 
EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;