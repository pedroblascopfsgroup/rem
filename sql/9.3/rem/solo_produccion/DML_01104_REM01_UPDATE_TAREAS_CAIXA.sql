--/*
--######################################### 
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20211216
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-10881
--## PRODUCTO=NO
--##            
--## INSTRUCCIONES:  Arregla Fork de tareas de PVCVenta Caixa
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE

V_ESQUEMA VARCHAR2(10 CHAR) := '#ESQUEMA#';
V_ESQUEMA_M VARCHAR2(10 CHAR) := '#ESQUEMA_MASTER#';
V_USUARIO VARCHAR2(20 CHAR) := 'REMVIP-10881_1603';
V_USUARIO2 VARCHAR2(50 CHAR);
V_SENTENCIA VARCHAR2(2000 CHAR);
PL_OUTPUT VARCHAR2(32000 CHAR);
V_NUM_TABLAS NUMBER(16);
TOKEN_ID NUMBER(16);
MODULE_ID NUMBER(16);
VMAP_ID NUMBER(16);
VINST_ID NUMBER(16);
V_MSQL VARCHAR2(32000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
				--OFR_NUM_OFERTA
T_TIPO_DATA('90264692'),
T_TIPO_DATA('90273625'),
T_TIPO_DATA('90274620'),
T_TIPO_DATA('90274627'),
T_TIPO_DATA('90279136'),
T_TIPO_DATA('90283478'),
T_TIPO_DATA('90284842'),
T_TIPO_DATA('90284849'),
T_TIPO_DATA('90284851'),
T_TIPO_DATA('90293302'),
T_TIPO_DATA('90295353'),
T_TIPO_DATA('90295779'),
T_TIPO_DATA('90296696'),
T_TIPO_DATA('90297090'),
T_TIPO_DATA('90302270'),
T_TIPO_DATA('90305816'),
T_TIPO_DATA('90313143'),
T_TIPO_DATA('90314604'),
T_TIPO_DATA('90314870'),
T_TIPO_DATA('90316698'),
T_TIPO_DATA('90321198'),
T_TIPO_DATA('90321265'),
T_TIPO_DATA('90322724'),
T_TIPO_DATA('90322727'),
T_TIPO_DATA('90322822'),
T_TIPO_DATA('90323513'),
T_TIPO_DATA('90323900'),
T_TIPO_DATA('90324919'),
T_TIPO_DATA('90325058'),
T_TIPO_DATA('90327633'),
T_TIPO_DATA('90327642'),
T_TIPO_DATA('90327696'),
T_TIPO_DATA('90328071'),
T_TIPO_DATA('90328529'),
T_TIPO_DATA('90329116'),
T_TIPO_DATA('90329174'),
T_TIPO_DATA('90329290'),
T_TIPO_DATA('90329496'),
T_TIPO_DATA('90329594'),
T_TIPO_DATA('90329917'),
T_TIPO_DATA('90330012'),
T_TIPO_DATA('90330083'),
T_TIPO_DATA('90330439'),
T_TIPO_DATA('90330675'),
T_TIPO_DATA('90330727'),
T_TIPO_DATA('90330831'),
T_TIPO_DATA('90331035'),
T_TIPO_DATA('90332205'),
T_TIPO_DATA('90332284'),
T_TIPO_DATA('90332321'),
T_TIPO_DATA('90332621'),
T_TIPO_DATA('90333124'),
T_TIPO_DATA('90333527'),
T_TIPO_DATA('90334181'),
T_TIPO_DATA('90335030'),
T_TIPO_DATA('90335655'),
T_TIPO_DATA('90336194'),
T_TIPO_DATA('90336217'),
T_TIPO_DATA('90336341'),
T_TIPO_DATA('90336442'),
T_TIPO_DATA('90336899'),
T_TIPO_DATA('90337481'),
T_TIPO_DATA('90337541'),
T_TIPO_DATA('90337604'),
T_TIPO_DATA('90337622'),
T_TIPO_DATA('90338181'),
T_TIPO_DATA('90338521'),
T_TIPO_DATA('90338673'),
T_TIPO_DATA('90338728'),
T_TIPO_DATA('90338829'),
T_TIPO_DATA('90338966'),
T_TIPO_DATA('90339192'),
T_TIPO_DATA('90339279'),
T_TIPO_DATA('90339335'),
T_TIPO_DATA('90339473'),
T_TIPO_DATA('90339651'),
T_TIPO_DATA('90339665'),
T_TIPO_DATA('90339779'),
T_TIPO_DATA('90339848'),
T_TIPO_DATA('90339859'),
T_TIPO_DATA('90339960'),
T_TIPO_DATA('90339974'),
T_TIPO_DATA('90340117'),
T_TIPO_DATA('90340226'),
T_TIPO_DATA('90340393'),
T_TIPO_DATA('90340536'),
T_TIPO_DATA('90340742'),
T_TIPO_DATA('90340884'),
T_TIPO_DATA('90341438'),
T_TIPO_DATA('90341664'),
T_TIPO_DATA('90342011'),
T_TIPO_DATA('90342144'),
T_TIPO_DATA('90342229'),
T_TIPO_DATA('90342267'),
T_TIPO_DATA('90342511'),
T_TIPO_DATA('90342629'),
T_TIPO_DATA('90342877'),
T_TIPO_DATA('90342930'),
T_TIPO_DATA('90342947'),
T_TIPO_DATA('90342987'),
T_TIPO_DATA('90343157'),
T_TIPO_DATA('90343170'),
T_TIPO_DATA('90343359'),
T_TIPO_DATA('90343610'),
T_TIPO_DATA('90343828'),
T_TIPO_DATA('90343858'),
T_TIPO_DATA('90343921'),
T_TIPO_DATA('90344118'),
T_TIPO_DATA('90344126'),
T_TIPO_DATA('90344180'),
T_TIPO_DATA('90344285'),
T_TIPO_DATA('90344289'),
T_TIPO_DATA('90344296'),
T_TIPO_DATA('90344330'),
T_TIPO_DATA('90344580'),
T_TIPO_DATA('90344685'),
T_TIPO_DATA('90344735'),
T_TIPO_DATA('90344815'),
T_TIPO_DATA('90344824'),
T_TIPO_DATA('90344830'),
T_TIPO_DATA('90344876'),
T_TIPO_DATA('90345066'),
T_TIPO_DATA('90345099'),
T_TIPO_DATA('90345125'),
T_TIPO_DATA('90345127'),
T_TIPO_DATA('90345320'),
T_TIPO_DATA('90345322'),
T_TIPO_DATA('90345490'),
T_TIPO_DATA('90345498'),
T_TIPO_DATA('90345505'),
T_TIPO_DATA('90345526'),
T_TIPO_DATA('90345546'),
T_TIPO_DATA('90345608'),
T_TIPO_DATA('90345722'),
T_TIPO_DATA('90345845'),
T_TIPO_DATA('90345964'),
T_TIPO_DATA('90345984'),
T_TIPO_DATA('90346016'),
T_TIPO_DATA('90346041'),
T_TIPO_DATA('90346076'),
T_TIPO_DATA('90346078'),
T_TIPO_DATA('90346103'),
T_TIPO_DATA('90346125'),
T_TIPO_DATA('90346185'),
T_TIPO_DATA('90346267'),
T_TIPO_DATA('90346331'),
T_TIPO_DATA('90346361'),
T_TIPO_DATA('90346384'),
T_TIPO_DATA('90346502'),
T_TIPO_DATA('90346637'),
T_TIPO_DATA('90346661'),
T_TIPO_DATA('90346702'),
T_TIPO_DATA('90346707'),
T_TIPO_DATA('90346715'),
T_TIPO_DATA('90346766'),
T_TIPO_DATA('90346802'),
T_TIPO_DATA('90346803'),
T_TIPO_DATA('90346822'),
T_TIPO_DATA('90346833'),
T_TIPO_DATA('90346952'),
T_TIPO_DATA('90346979'),
T_TIPO_DATA('90347018'),
T_TIPO_DATA('90347086'),
T_TIPO_DATA('90347090'),
T_TIPO_DATA('90347112'),
T_TIPO_DATA('90347162'),
T_TIPO_DATA('90347197'),
T_TIPO_DATA('90347305'),
T_TIPO_DATA('90347362'),
T_TIPO_DATA('90347371'),
T_TIPO_DATA('90347377'),
T_TIPO_DATA('90347393'),
T_TIPO_DATA('90347406'),
T_TIPO_DATA('90347469'),
T_TIPO_DATA('90347479'),
T_TIPO_DATA('90347632'),
T_TIPO_DATA('90347801'),
T_TIPO_DATA('90347858'),
T_TIPO_DATA('90347932'),
T_TIPO_DATA('90348055'),
T_TIPO_DATA('90348060'),
T_TIPO_DATA('90348079'),
T_TIPO_DATA('90348091'),
T_TIPO_DATA('90348193'),
T_TIPO_DATA('90348223'),
T_TIPO_DATA('90348352'),
T_TIPO_DATA('90348457'),
T_TIPO_DATA('90348499'),
T_TIPO_DATA('90348515'),
T_TIPO_DATA('90348770'),
T_TIPO_DATA('90348826'),
T_TIPO_DATA('90348882'),
T_TIPO_DATA('90348907'),
T_TIPO_DATA('90348923'),
T_TIPO_DATA('90348926'),
T_TIPO_DATA('90349038'),
T_TIPO_DATA('90349105'),
T_TIPO_DATA('90349174'),
T_TIPO_DATA('90349214'),
T_TIPO_DATA('90349230'),
T_TIPO_DATA('90349231'),
T_TIPO_DATA('90349333'),
T_TIPO_DATA('90349373'),
T_TIPO_DATA('90349419'),
T_TIPO_DATA('90349449'),
T_TIPO_DATA('90349455'),
T_TIPO_DATA('90349500'),
T_TIPO_DATA('90349598'),
T_TIPO_DATA('90349653'),
T_TIPO_DATA('90349712'),
T_TIPO_DATA('90349752'),
T_TIPO_DATA('90349767'),
T_TIPO_DATA('90349788'),
T_TIPO_DATA('90349807'),
T_TIPO_DATA('90349888'),
T_TIPO_DATA('90349911'),
T_TIPO_DATA('90349974'),
T_TIPO_DATA('90350052'),
T_TIPO_DATA('90350055'),
T_TIPO_DATA('90350119'),
T_TIPO_DATA('90350122'),
T_TIPO_DATA('90350167'),
T_TIPO_DATA('90350336'),
T_TIPO_DATA('90350368'),
T_TIPO_DATA('90350380'),
T_TIPO_DATA('90350430'),
T_TIPO_DATA('90350431'),
T_TIPO_DATA('90350704'),
T_TIPO_DATA('90350858'),
T_TIPO_DATA('90350891'),
T_TIPO_DATA('90350964'),
T_TIPO_DATA('90351012'),
T_TIPO_DATA('90351027'),
T_TIPO_DATA('90351124'),
T_TIPO_DATA('90351196'),
T_TIPO_DATA('90351386'),
T_TIPO_DATA('90351462'),
T_TIPO_DATA('90351468'),
T_TIPO_DATA('90351549'),
T_TIPO_DATA('90351559'),
T_TIPO_DATA('90351625'),
T_TIPO_DATA('90351675'),
T_TIPO_DATA('90351690'),
T_TIPO_DATA('90351716'),
T_TIPO_DATA('90351776'),
T_TIPO_DATA('90351777'),
T_TIPO_DATA('90351779'),
T_TIPO_DATA('90351786'),
T_TIPO_DATA('90351849'),
T_TIPO_DATA('90351959'),
T_TIPO_DATA('90351969'),
T_TIPO_DATA('90351978'),
T_TIPO_DATA('90351981'),
T_TIPO_DATA('90352145'),
T_TIPO_DATA('90352200'),
T_TIPO_DATA('90352256'),
T_TIPO_DATA('90352267'),
T_TIPO_DATA('90352309'),
T_TIPO_DATA('90352412'),
T_TIPO_DATA('90352429'),
T_TIPO_DATA('90352449'),
T_TIPO_DATA('90352553'),
T_TIPO_DATA('90352582'),
T_TIPO_DATA('90352587'),
T_TIPO_DATA('90352605'),
T_TIPO_DATA('90352658'),
T_TIPO_DATA('90352666'),
T_TIPO_DATA('90352668'),
T_TIPO_DATA('90352738'),
T_TIPO_DATA('90352758'),
T_TIPO_DATA('90352880'),
T_TIPO_DATA('90352900'),
T_TIPO_DATA('90352945'),
T_TIPO_DATA('90352971'),
T_TIPO_DATA('90353006'),
T_TIPO_DATA('90353007'),
T_TIPO_DATA('90353028'),
T_TIPO_DATA('90353157'),
T_TIPO_DATA('90353161'),
T_TIPO_DATA('90353190'),
T_TIPO_DATA('90353191'),
T_TIPO_DATA('90353200'),
T_TIPO_DATA('90353274'),
T_TIPO_DATA('90353349'),
T_TIPO_DATA('90353436'),
T_TIPO_DATA('90353582'),
T_TIPO_DATA('90353600'),
T_TIPO_DATA('90353634'),
T_TIPO_DATA('90353658'),
T_TIPO_DATA('90353665'),
T_TIPO_DATA('90353701'),
T_TIPO_DATA('90353752'),
T_TIPO_DATA('90353772'),
T_TIPO_DATA('90353785'),
T_TIPO_DATA('90353860'),
T_TIPO_DATA('90353884'),
T_TIPO_DATA('90353911'),
T_TIPO_DATA('90353937'),
T_TIPO_DATA('90354036'),
T_TIPO_DATA('90354043'),
T_TIPO_DATA('90354061'),
T_TIPO_DATA('90354075'),
T_TIPO_DATA('90354097'),
T_TIPO_DATA('90354117'),
T_TIPO_DATA('90354132'),
T_TIPO_DATA('90354153'),
T_TIPO_DATA('90354254'),
T_TIPO_DATA('90354321'),
T_TIPO_DATA('90354375'),
T_TIPO_DATA('90354414'),
T_TIPO_DATA('90354430'),
T_TIPO_DATA('90354442'),
T_TIPO_DATA('90354629'),
T_TIPO_DATA('90354632'),
T_TIPO_DATA('90354661'),
T_TIPO_DATA('90354705'),
T_TIPO_DATA('90354796'),
T_TIPO_DATA('90355145'),
T_TIPO_DATA('90355209'),
T_TIPO_DATA('90355421'),
T_TIPO_DATA('90355471'),
T_TIPO_DATA('90355474'),
T_TIPO_DATA('90355569'),
T_TIPO_DATA('90355605'),
T_TIPO_DATA('90355646'),
T_TIPO_DATA('90355790'),
T_TIPO_DATA('90355795'),
T_TIPO_DATA('90355816'),
T_TIPO_DATA('90356116'),
T_TIPO_DATA('90356422'),
T_TIPO_DATA('90356653'),
T_TIPO_DATA('90356759'),
T_TIPO_DATA('90356762'),
T_TIPO_DATA('90357245'),
T_TIPO_DATA('90357348'),
T_TIPO_DATA('90357613')

    ); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

BEGIN 
     FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
    LOOP
	V_TMP_TIPO_DATA := V_TIPO_DATA(I);
    
    V_MSQL :='SELECT TO_CHAR('''||V_USUARIO||''' || ''_'' || '''||V_TMP_TIPO_DATA(1)||''')  FROM REM01.OFR_OFERTAS OFR
WHERE OFR.OFR_NUM_OFERTA='||V_TMP_TIPO_DATA(1)||'';
EXECUTE IMMEDIATE V_MSQL INTO V_USUARIO2;
	DBMS_OUTPUT.PUT_LINE('[INFO] BORRAMOS TRA_PROCESS_BPM');
 
	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_TRA_TRAMITE TRA USING(
					SELECT DISTINCT TRA.TRA_ID
						FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO
                        INNER JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = ECO.OFR_ID AND OFR.BORRADO = 0
						INNER JOIN '||V_ESQUEMA||'.ACT_TRA_TRAMITE TRA ON TRA.TBJ_ID = ECO.TBJ_ID AND TRA.BORRADO = 0
						INNER JOIN '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC ON TAC.TRA_ID = TRA.TRA_ID AND TAC.BORRADO = 0
						INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID AND TAR.TAR_TAREA_FINALIZADA = 0 AND TAR.BORRADO = 0
						INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID AND TEX.BORRADO = 0
						INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TEX.TAP_ID = TAP.TAP_ID AND TAP.TAP_CODIGO IN (
                        ''T017_PBCVenta'', ''T017_BloqueoScreening'') AND TAP.BORRADO = 0
						INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON TAC.ACT_ID = ACT.ACT_ID AND ACT.BORRADO = 0
						AND TAC.BORRADO = 0 AND ACT.DD_CRA_ID = 21 AND OFR.OFR_NUM_OFERTA in ('||V_TMP_TIPO_DATA(1)||')) AUX 
				ON (AUX.TRA_ID = TRA.TRA_ID)
				WHEN MATCHED THEN UPDATE SET
				TRA.TRA_PROCESS_BPM = NULL';
	EXECUTE IMMEDIATE V_MSQL;
  
  	DBMS_OUTPUT.PUT_LINE('[INFO] - BORRADO TRA_PROCESS_BPM EN '||SQL%ROWCOUNT||' TAREAS.');

	DBMS_OUTPUT.PUT_LINE('[INFO] BORRAMOS TEX_TOKEN_ID_BPM');
 
	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX USING(
					SELECT DISTINCT TEX.TEX_ID
						FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO
                        INNER JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = ECO.OFR_ID AND OFR.BORRADO = 0
						INNER JOIN '||V_ESQUEMA||'.ACT_TRA_TRAMITE TRA ON TRA.TBJ_ID = ECO.TBJ_ID AND TRA.BORRADO = 0
						INNER JOIN '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC ON TAC.TRA_ID = TRA.TRA_ID AND TAC.BORRADO = 0
						INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID AND TAR.TAR_TAREA_FINALIZADA = 0 AND TAR.BORRADO = 0
						INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TEX.TAR_ID = TAC.TAR_ID AND TEX.BORRADO = 0
						INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TEX.TAP_ID = TAP.TAP_ID AND TAP.TAP_CODIGO IN (
                        ''T017_PBCVenta'', ''T017_BloqueoScreening'') AND TAP.BORRADO = 0
						INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON TAC.ACT_ID = ACT.ACT_ID AND ACT.BORRADO = 0
						AND TAC.BORRADO = 0 AND ACT.DD_CRA_ID = 21 AND OFR.OFR_NUM_OFERTA in ('||V_TMP_TIPO_DATA(1)||') ) AUX 
				ON (AUX.TEX_ID = TEX.TEX_ID)
				WHEN MATCHED THEN UPDATE SET
				TEX.TEX_TOKEN_ID_BPM = NULL';
	EXECUTE IMMEDIATE V_MSQL;
  
  	DBMS_OUTPUT.PUT_LINE('[INFO] - BORRADO TEX_TOKEN_ID_BPM EN '||SQL%ROWCOUNT||' TAREAS.');

	DBMS_OUTPUT.PUT_LINE('[INFO] LANZAMOS ALTA_BPM_INSTANCES');
  
	REM01.ALTA_BPM_INSTANCES(V_USUARIO2,PL_OUTPUT);

	DBMS_OUTPUT.PUT_LINE('[INFO] ASIGNAMOS TRA_PROCESS_BPM Y TEX_TOKEN_ID_BPM');

	FOR CURSOR IN (SELECT CASE WHEN TIENE_RESERVA = 1 THEN
	(SELECT ID_ FROM REMMASTER.JBPM_NODE WHERE NAME_ = 'forkReservaSiBbva' AND processdefinition_ = AUX.processdefinition_)
   		ELSE (SELECT ID_ FROM REMMASTER.JBPM_NODE WHERE NAME_ = 'forkReservaNoBbva' AND processdefinition_ = AUX.processdefinition_) END AS NODE_PARENT,
		AUX.* FROM(SELECT DISTINCT
		TRA.TRA_ID,
		TRA.TRA_PROCESS_BPM,
		INST.PROCESSDEFINITION_,
		TAR.TAR_ID,
		TAP.TAP_CODIGO,
		TEX.TEX_ID,
		TEX.TEX_TOKEN_ID_BPM,
		NODE.ID_ NODE_ID,
		TOKEN.PARENT_,
		ECO.ECO_NUM_EXPEDIENTE,
		CASE WHEN RES.RES_ID IS NULL THEN 0 ELSE 1 END AS TIENE_RESERVA,
		TAR.TAR_TAREA_FINALIZADA
		FROM REM01.ECO_EXPEDIENTE_COMERCIAL ECO
		INNER JOIN REM01.ACT_TRA_TRAMITE TRA
		ON TRA.TBJ_ID = ECO.TBJ_ID
		INNER JOIN REMMASTER.JBPM_PROCESSINSTANCE INST
		ON INST.ID_ = TRA.TRA_PROCESS_BPM
		INNER JOIN REM01.TAC_TAREAS_ACTIVOS TAC
		ON TAC.TRA_ID = TRA.TRA_ID
		INNER JOIN REM01.TAR_TAREAS_NOTIFICACIONES TAR
		ON TAR.TAR_ID = TAC.TAR_ID
		INNER JOIN REM01.TEX_TAREA_EXTERNA TEX
		ON TEX.TAR_ID = TAR.TAR_ID
		INNER JOIN REM01.TAP_TAREA_PROCEDIMIENTO TAP
		ON TEX.TAP_ID = TAP.TAP_ID
		INNER JOIN REMMASTER.JBPM_TOKEN TOKEN
		ON TOKEN.ID_ = TEX.TEX_TOKEN_ID_BPM
		INNER JOIN REMMASTER.JBPM_NODE NODE
		ON NODE.ID_ = TOKEN.NODE_
		LEFT JOIN REM01.RES_RESERVAS RES
		ON RES.ECO_ID = ECO.ECO_ID
		WHERE TRA.USUARIOMODIFICAR = V_USUARIO2
		AND TAP_CODIGO IN (
		'T017_AgendarFechaFirmaArras','T017_ConfirmarFechaFirmaArras',
		'T017_InstruccionesReserva','T017_ObtencionContratoReserva',
		'T017_PBCReserva','T017_PBCVenta', 'T017_BloqueoScreening')
		ORDER BY TRA_ID ASC, TAP_CODIGO ASC) AUX) LOOP

	IF CURSOR.TAR_TAREA_FINALIZADA = 0 THEN
		IF CURSOR.PARENT_ IS NULL THEN
			TOKEN_ID := REMMASTER.HIBERNATE_SEQUENCE.NEXTVAL;
			MODULE_ID := REMMASTER.HIBERNATE_SEQUENCE.NEXTVAL;
			VMAP_ID := REMMASTER.HIBERNATE_SEQUENCE.NEXTVAL;
			VINST_ID := REMMASTER.HIBERNATE_SEQUENCE.NEXTVAL;
			V_MSQL := 'INSERT INTO '||V_ESQUEMA_M||'.JBPM_TOKEN(ID_, VERSION_, NAME_, START_, END_, NODEENTER_, NEXTLOGINDEX_, ISABLETOREACTIVATEPARENT_, ISTERMINATIONIMPLICIT_, ISSUSPENDED_, LOCK_, NODE_, PROCESSINSTANCE_, PARENT_, SUBPROCESSINSTANCE_,  RPR_REFERENCIA, T_REFERENCIA) VALUES (
			'||TOKEN_ID||', 0, (SELECT NAME_ FROM '||V_ESQUEMA_M||'.JBPM_NODE WHERE ID_ = '||CURSOR.NODE_PARENT||'), SYSDATE, NULL, SYSDATE, 2, 1, 0, 0, NULL, '||CURSOR.NODE_PARENT||', '||CURSOR.TRA_PROCESS_BPM||', NULL, NULL, NULL, NULL)';
			EXECUTE IMMEDIATE V_MSQL;
			--DBMS_OUTPUT.PUT_LINE(V_MSQL);
			V_MSQL := 'UPDATE '||V_ESQUEMA_M||'.JBPM_TOKEN SET ISABLETOREACTIVATEPARENT_ = 1, NEXTLOGINDEX_ = 2, PARENT_ = '||TOKEN_ID||' WHERE ID_ = '||CURSOR.TEX_TOKEN_ID_BPM;
			EXECUTE IMMEDIATE V_MSQL;
			--DBMS_OUTPUT.PUT_LINE(V_MSQL);
			V_MSQL := 'UPDATE '||V_ESQUEMA_M||'.JBPM_PROCESSINSTANCE SET ROOTTOKEN_ = '||TOKEN_ID||'  WHERE ID_ = '||CURSOR.TRA_PROCESS_BPM;
			EXECUTE IMMEDIATE V_MSQL;
			--DBMS_OUTPUT.PUT_LINE(V_MSQL);
			--DBMS_OUTPUT.PUT_LINE('Actualizando las module y vmap...') ;
			V_MSQL := 'INSERT INTO REMMASTER.JBPM_MODULEINSTANCE
					(ID_, CLASS_, VERSION_, PROCESSINSTANCE_, NAME_) VALUES (
					'||MODULE_ID||'
					, ''C''
					, 0
					, '||CURSOR.TRA_PROCESS_BPM||'
					, ''org.jbpm.context.exe.ContextInstance'' )';
			EXECUTE IMMEDIATE V_MSQL;
			--DBMS_OUTPUT.PUT_LINE(V_MSQL);
			V_MSQL := 'INSERT INTO REMMASTER.JBPM_TOKENVARIABLEMAP
					(ID_, VERSION_, TOKEN_, CONTEXTINSTANCE_) VALUES (
				'||VMAP_ID||'
				, 0
				, '||TOKEN_ID||'
				, '||MODULE_ID||'  
			)';
			EXECUTE IMMEDIATE V_MSQL;
			--DBMS_OUTPUT.PUT_LINE(V_MSQL);
			--DBMS_OUTPUT.PUT_LINE('module y vmap actualizadas!!') ;


			--DBMS_OUTPUT.PUT_LINE('Actualizando VARIABLE INSTABLE...') ;

			--DBMS_OUTPUT.PUT_LINE('Insertamos la variable DB_ID para cada instancia..') ;
			V_MSQL := 'INSERT INTO REMMASTER.JBPM_VARIABLEINSTANCE
				(ID_, CLASS_, VERSION_, NAME_, TOKEN_, TOKENVARIABLEMAP_, PROCESSINSTANCE_, LONGVALUE_) VALUES (
				'||VINST_ID||'
				,''L''
				, 0
				, ''DB_ID''
				, '||TOKEN_ID||'
				, '||VMAP_ID||'
				, '||CURSOR.TRA_PROCESS_BPM||'
				, 1
			)';
			EXECUTE IMMEDIATE V_MSQL;
			--DBMS_OUTPUT.PUT_LINE(V_MSQL);
			--DBMS_OUTPUT.PUT_LINE('Insertamos la variable procedimientoTareaExterna para cada instancia..') ;
			VINST_ID := REMMASTER.HIBERNATE_SEQUENCE.NEXTVAL;
			V_MSQL := 'INSERT INTO REMMASTER.JBPM_VARIABLEINSTANCE
				(ID_, CLASS_, VERSION_, NAME_, TOKEN_, TOKENVARIABLEMAP_, PROCESSINSTANCE_, LONGVALUE_) VALUES (
				'||VINST_ID||'
				,''L''
				, 0
				, ''procedimientoTareaExterna''
				, '||TOKEN_ID||'
				, '||VMAP_ID||'
				, '||CURSOR.TRA_PROCESS_BPM||'
				, '||CURSOR.TRA_ID||'
			)';
			EXECUTE IMMEDIATE V_MSQL;
			--DBMS_OUTPUT.PUT_LINE(V_MSQL);
			--DBMS_OUTPUT.PUT_LINE('Insertamos la variable bpmParalizado para cada instancia..') ;
			VINST_ID := REMMASTER.HIBERNATE_SEQUENCE.NEXTVAL;
			V_MSQL := 'INSERT INTO REMMASTER.JBPM_VARIABLEINSTANCE
				(ID_, CLASS_, VERSION_, NAME_, TOKEN_, TOKENVARIABLEMAP_, PROCESSINSTANCE_, LONGVALUE_) VALUES (
				'||VINST_ID||'
				,''L''
				, 0
				, ''bpmParalizado''
				, '||TOKEN_ID||'
				, '||VMAP_ID||'
				, '||CURSOR.TRA_PROCESS_BPM||'
				, 0
			)';
			EXECUTE IMMEDIATE V_MSQL;
			--DBMS_OUTPUT.PUT_LINE(V_MSQL);
			--DBMS_OUTPUT.PUT_LINE('Insertamos la variable idCODIGOTAREA para cada instancia..') ;
			VINST_ID := REMMASTER.HIBERNATE_SEQUENCE.NEXTVAL;
			V_MSQL := 'INSERT INTO REMMASTER.JBPM_VARIABLEINSTANCE
				(ID_, CLASS_, VERSION_, NAME_, TOKEN_, TOKENVARIABLEMAP_, PROCESSINSTANCE_, LONGVALUE_) VALUES (
				'||VINST_ID||'
				,''L''
				, 0
				, ''id'||CURSOR.TAP_CODIGO||'.'||CURSOR.TEX_TOKEN_ID_BPM||'''
				, '||TOKEN_ID||'
				, '||VMAP_ID||'
				, '||CURSOR.TRA_PROCESS_BPM||'
				, '||CURSOR.TEX_ID||'
			)';
			EXECUTE IMMEDIATE V_MSQL;
			--DBMS_OUTPUT.PUT_LINE(V_MSQL);
			--DBMS_OUTPUT.PUT_LINE('FIN VARIABLE INSTANCE!!') ;


			--Insertamos variable sin concatenar TOKEN_PADRE_ID
			VINST_ID := REMMASTER.HIBERNATE_SEQUENCE.NEXTVAL;
			V_MSQL := 'INSERT INTO REMMASTER.JBPM_VARIABLEINSTANCE
				(ID_, CLASS_, VERSION_, NAME_, TOKEN_, TOKENVARIABLEMAP_, PROCESSINSTANCE_, LONGVALUE_) VALUES (
				'||VINST_ID||'
				,''L''
				, 0
				, ''id'||CURSOR.TAP_CODIGO||'''
				, '||TOKEN_ID||'
				, '||VMAP_ID||'
				, '||CURSOR.TRA_PROCESS_BPM||'
				, '||CURSOR.TEX_ID||'
			)';
			EXECUTE IMMEDIATE V_MSQL;
			--DBMS_OUTPUT.PUT_LINE(V_MSQL);
			--DBMS_OUTPUT.PUT_LINE('FIN VARIABLE INSTANCE!!') ;


			VINST_ID := REMMASTER.HIBERNATE_SEQUENCE.NEXTVAL;
			V_MSQL := 'INSERT INTO REMMASTER.JBPM_VARIABLEINSTANCE
				(ID_, CLASS_, VERSION_, NAME_, TOKEN_, TOKENVARIABLEMAP_, PROCESSINSTANCE_, LONGVALUE_) VALUES (
				'||VINST_ID||'
				,''L''
				, 0
				, ''activoTramiteTareaExterna''
				, '||TOKEN_ID||'
				, '||VMAP_ID||'
				, '||CURSOR.TRA_PROCESS_BPM||'
				, '||CURSOR.TRA_ID||'
			)';
			EXECUTE IMMEDIATE V_MSQL;
			--DBMS_OUTPUT.PUT_LINE(V_MSQL);
			--DBMS_OUTPUT.PUT_LINE('FIN VARIABLE INSTANCE!!') ;

			ELSE
			V_MSQL := 'UPDATE '||V_ESQUEMA_M||'.JBPM_TOKEN SET NODE_ = '||CURSOR.NODE_PARENT||' WHERE ID_ = '||CURSOR.PARENT_;
			EXECUTE IMMEDIATE V_MSQL;
			V_MSQL := 'UPDATE '||V_ESQUEMA_M||'.JBPM_TOKEN SET NEXTLOGINDEX_= 2, ISABLETOREACTIVATEPARENT_ = 1 WHERE ID_ = '||CURSOR.TEX_TOKEN_ID_BPM;
			EXECUTE IMMEDIATE V_MSQL;
		END IF;
	END IF;
	END LOOP;
    
    END LOOP;
  
  	COMMIT;
  

EXCEPTION
    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT;