--/*
--##########################################
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20211222
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-10953
--## PRODUCTO=NO
--##
--## Finalidad: Script modifica situacion posesoria activos
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versi√≥n inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USU VARCHAR2(30 CHAR) := 'REMVIP-10953'; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.
	V_COUNT NUMBER(16);

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
        --ID_PERSONA_HAYA   PAISNACIMIENTO  PAISNACIONALIDAD
T_TIPO_DATA('1027021','CO','ES'),
T_TIPO_DATA('1985309','DZ','FR'),
T_TIPO_DATA('1985310','DZ','GA'),
T_TIPO_DATA('1407672','CU','ES'),
T_TIPO_DATA('2029303','CU','ES'),
T_TIPO_DATA('816214','US','ES'),
T_TIPO_DATA('1407616','EC','ES'),
T_TIPO_DATA('332196','UA','IL'),
T_TIPO_DATA('1410654','BG','ES'),
T_TIPO_DATA('1409504','MA','ES'),
T_TIPO_DATA('1412923','EC','ES'),
T_TIPO_DATA('1412606','BG','ES'),
T_TIPO_DATA('1422022','NL','ES'),
T_TIPO_DATA('1417159','MA','BE'),
T_TIPO_DATA('1421315','MA','ES'),
T_TIPO_DATA('1423314','DO','ES'),
T_TIPO_DATA('1426436','MA','ES'),
T_TIPO_DATA('934073','BO','ES'),
T_TIPO_DATA('1425960','AR','ES'),
T_TIPO_DATA('1428777','UY','ES'),
T_TIPO_DATA('29734','MA','ES'),
T_TIPO_DATA('1410668','CU','ES'),
T_TIPO_DATA('1549439','SN','ES'),
T_TIPO_DATA('1549440','SN','ES'),
T_TIPO_DATA('1561058','BO','ES'),
T_TIPO_DATA('1560766','AR','ES'),
T_TIPO_DATA('1705647','MA','FR'),
T_TIPO_DATA('1706145','MA','ES'),
T_TIPO_DATA('1708525','EC','ES'),
T_TIPO_DATA('1751078','PE','ES'),
T_TIPO_DATA('1758930','VE','ES'),
T_TIPO_DATA('1771232','HU','DE'),
T_TIPO_DATA('1726123','EC','ES'),
T_TIPO_DATA('1858710','MA','ES'),
T_TIPO_DATA('1754557','UY','IT'),
T_TIPO_DATA('1886510','ES','MA'),
T_TIPO_DATA('1892458','MD','RO'),
T_TIPO_DATA('313033','UA','ES'),
T_TIPO_DATA('866180','VE','ES'),
T_TIPO_DATA('1911797','ES','IT'),
T_TIPO_DATA('1952753','VE','IT'),
T_TIPO_DATA('1918046','MA','ES'),
T_TIPO_DATA('1921408','MA','ES'),
T_TIPO_DATA('1921409','MA','ES'),
T_TIPO_DATA('1925357','MA','ES'),
T_TIPO_DATA('1953429','MA','ES'),
T_TIPO_DATA('863777','MA','ES'),
T_TIPO_DATA('1953896','CO','FR'),
T_TIPO_DATA('1952368','MA','ES'),
T_TIPO_DATA('306972','VE','ES'),
T_TIPO_DATA('1956747','BD','ES'),
T_TIPO_DATA('1958710','MA','ES'),
T_TIPO_DATA('1960671','MA','ES'),
T_TIPO_DATA('1873038','UA','DE'),
T_TIPO_DATA('1960285','US','FR'),
T_TIPO_DATA('1992471','AR','ES'),
T_TIPO_DATA('1975823','MA','ES'),
T_TIPO_DATA('1971842','PE','ES'),
T_TIPO_DATA('1972631','VE','IT'),
T_TIPO_DATA('1974060','MA','ES'),
T_TIPO_DATA('1983242','MA','ES'),
T_TIPO_DATA('513911','IN','ES'),
T_TIPO_DATA('1976068','CH','ES'),
T_TIPO_DATA('1985698','AR','IT'),
T_TIPO_DATA('1985699','AR','IT'),
T_TIPO_DATA('1967245','MA','ES'),
T_TIPO_DATA('1305210','PE','ES'),
T_TIPO_DATA('1981601','CO','ES'),
T_TIPO_DATA('1986092','ES','DE'),
T_TIPO_DATA('1987286','AR','ES'),
T_TIPO_DATA('1992119','MA','ES'),
T_TIPO_DATA('1992140','IN','ES'),
T_TIPO_DATA('2043312','UY','IT'),
T_TIPO_DATA('1415777','AR','ES'),
T_TIPO_DATA('1997362','RO','ES'),
T_TIPO_DATA('2082428','RO','ES'),
T_TIPO_DATA('22819','BO','ES'),
T_TIPO_DATA('38742','BO','ES'),
T_TIPO_DATA('1994785','CO','FR'),
T_TIPO_DATA('1999708','CO','ES'),
T_TIPO_DATA('2029226','US','ES'),
T_TIPO_DATA('1997878','MA','ES'),
T_TIPO_DATA('1999119','HN','ES'),
T_TIPO_DATA('2005739','HN','ES'),
T_TIPO_DATA('2001946','PE','ES'),
T_TIPO_DATA('1973314','ES','MA'),
T_TIPO_DATA('2027487','BO','ES'),
T_TIPO_DATA('2051481','MA','ES'),
T_TIPO_DATA('2007144','RU','ES'),
T_TIPO_DATA('2005850','MX','ES'),
T_TIPO_DATA('2027175','VE','ES'),
T_TIPO_DATA('866174','MA','ES'),
T_TIPO_DATA('2006316','UY','ES'),
T_TIPO_DATA('2007273','AR','ES'),
T_TIPO_DATA('2041771','MA','ES'),
T_TIPO_DATA('2042430','MD','SK'),
T_TIPO_DATA('2042438','DO','US'),
T_TIPO_DATA('2042481','MA','ES'),
T_TIPO_DATA('2042517','BG','ES'),
T_TIPO_DATA('2042570','PE','ES'),
T_TIPO_DATA('2042571','PE','ES'),
T_TIPO_DATA('2027922','RO','ES'),
T_TIPO_DATA('2027861','UA','ES'),
T_TIPO_DATA('2027867','UA','ES'),
T_TIPO_DATA('2047012','NI','ES'),
T_TIPO_DATA('2047013','NI','ES'),
T_TIPO_DATA('2049029','RO','ES'),
T_TIPO_DATA('2049485','CO','ES'),
T_TIPO_DATA('2049486','CO','ES'),
T_TIPO_DATA('2049874','EC','ES'),
T_TIPO_DATA('2049875','EC','ES'),
T_TIPO_DATA('2050857','EC','ES'),
T_TIPO_DATA('2051939','MA','ES'),
T_TIPO_DATA('2027221','MA','ES'),
T_TIPO_DATA('2071032','MA','ES'),
T_TIPO_DATA('2070724','MD','RO'),
T_TIPO_DATA('2050408','EC','ES'),
T_TIPO_DATA('2075246','MA','ES')

); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

    
BEGIN		

	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	
	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
	LOOP
	V_TMP_TIPO_DATA := V_TIPO_DATA(I);



                    V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.CEX_COMPRADOR_EXPEDIENTE T1
                USING (
SELECT DISTINCT COM.COM_ID,PAINAC.DD_PAI_ID,PAINACAUX.DD_PAI_ID AS PAISPONER FROM '||V_ESQUEMA||'.CEX_COMPRADOR_EXPEDIENTE CEX
                    JOIN '||V_ESQUEMA||'.COM_COMPRADOR COM ON COM.COM_ID=CEX.COM_ID AND COM.BORRADO = 0
                    LEFT JOIN '||V_ESQUEMA||'.DD_PAI_PAISES PAINAC ON PAINAC.DD_PAI_ID=CEX.DD_PAI_ID_ISO AND PAINAC.BORRADO =0 
                    AND PAINAC.DD_PAI_COD_ISO!='''||V_TMP_TIPO_DATA(3)||'''
                    JOIN '||V_ESQUEMA||'.DD_PAI_PAISES PAINACAUX ON PAINACAUX.DD_PAI_COD_ISO='''||V_TMP_TIPO_DATA(3)||'''
                    WHERE COM.COM_ID_PERSONA_HAYA_CAIXA = '||V_TMP_TIPO_DATA(1)||'

                ) T2
                ON (T1.COM_ID = T2.COM_ID)
                WHEN MATCHED THEN
                UPDATE SET 
                    T1.DD_PAI_ID_ISO = T2.PAISPONER,
                    T1.FECHAMODIFICAR = SYSDATE,
                    T1.USUARIOMODIFICAR = '''||V_USU||'''	 		
                ';
		
	EXECUTE IMMEDIATE V_MSQL;  

    DBMS_OUTPUT.PUT_LINE('[INFO]: CEX_COMPRADOR_EXPEDIENTE '|| SQL%ROWCOUNT ||' PAIS actualizados  '''||V_TMP_TIPO_DATA(1)||''' - '''||V_TMP_TIPO_DATA(3)||'''  ');
    
    
                        V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.CEX_COMPRADOR_EXPEDIENTE T1
                USING (
SELECT DISTINCT COM.COM_ID,PAINAC.DD_PAI_ID,PAINACAUX.DD_PAI_ID AS PAISPONER FROM '||V_ESQUEMA||'.CEX_COMPRADOR_EXPEDIENTE CEX
                    JOIN '||V_ESQUEMA||'.COM_COMPRADOR COM ON COM.COM_ID=CEX.COM_ID AND COM.BORRADO = 0
                    LEFT JOIN '||V_ESQUEMA||'.DD_PAI_PAISES PAINAC ON PAINAC.DD_PAI_ID=CEX.DD_PAI_ID_ISO_RPR AND PAINAC.BORRADO =0 
                    AND PAINAC.DD_PAI_COD_ISO!='''||V_TMP_TIPO_DATA(3)||'''
                    JOIN '||V_ESQUEMA||'.DD_PAI_PAISES PAINACAUX ON PAINACAUX.DD_PAI_COD_ISO='''||V_TMP_TIPO_DATA(3)||'''
                    WHERE CEX.CEX_ID_PERSONA_HAYA_CAIXA_REPR = '||V_TMP_TIPO_DATA(1)||'

                ) T2
                ON (T1.COM_ID = T2.COM_ID)
                WHEN MATCHED THEN
                UPDATE SET 
                    T1.DD_PAI_ID_ISO_RPR = T2.PAISPONER,
                    T1.FECHAMODIFICAR = SYSDATE,
                    T1.USUARIOMODIFICAR = '''||V_USU||'''	 		
                ';
		
	EXECUTE IMMEDIATE V_MSQL;  

    DBMS_OUTPUT.PUT_LINE('[INFO]: CEX_COMPRADOR_EXPEDIENTE '|| SQL%ROWCOUNT ||' PAIS REPRESENTANTE actualizados  '''||V_TMP_TIPO_DATA(1)||''' - '''||V_TMP_TIPO_DATA(3)||'''  ');



                V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.iap_info_adc_persona T1
                USING (
SELECT DISTINCT IAP.IAP_ID,PAINAC.DD_PAI_ID,PAINACAUX.DD_PAI_ID AS PAISPONER FROM '||V_ESQUEMA||'.IAP_INFO_ADC_PERSONA IAP
                    LEFT JOIN '||V_ESQUEMA||'.DD_PAI_PAISES PAINAC ON PAINAC.DD_PAI_ID=IAP.DD_PAI_ID AND PAINAC.BORRADO =0 
                    AND PAINAC.DD_PAI_COD_ISO!='''||V_TMP_TIPO_DATA(3)||'''
                    JOIN '||V_ESQUEMA||'.DD_PAI_PAISES PAINACAUX ON PAINACAUX.DD_PAI_COD_ISO='''||V_TMP_TIPO_DATA(3)||'''
WHERE IAP.IAP_ID_PERSONA_HAYA_CAIXA= '||V_TMP_TIPO_DATA(1)||'

                ) T2
                ON (T1.IAP_ID = T2.IAP_ID)
                WHEN MATCHED THEN
                UPDATE SET 
                    T1.DD_PAI_ID = T2.PAISPONER,
                    T1.FECHAMODIFICAR = SYSDATE,
                    T1.USUARIOMODIFICAR = '''||V_USU||'''	 		
                ';
		
	EXECUTE IMMEDIATE V_MSQL;  

    DBMS_OUTPUT.PUT_LINE('[INFO]: IAP_INFO_ADC_PERSONA '|| SQL%ROWCOUNT ||' PAIS actualizados  '''||V_TMP_TIPO_DATA(1)||''' - '''||V_TMP_TIPO_DATA(3)||'''  ');
    
    
                    V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.iap_info_adc_persona T1
                USING (
SELECT DISTINCT IAP.IAP_ID,PAINAC.DD_PAI_ID,PAINACAUX.DD_PAI_ID AS PAISPONER FROM '||V_ESQUEMA||'.IAP_INFO_ADC_PERSONA IAP
                    LEFT JOIN '||V_ESQUEMA||'.DD_PAI_PAISES PAINAC ON PAINAC.DD_PAI_ID=IAP.DD_PAI_ID_RPR AND PAINAC.BORRADO =0 
                    AND PAINAC.DD_PAI_COD_ISO!='''||V_TMP_TIPO_DATA(3)||'''
                    JOIN '||V_ESQUEMA||'.DD_PAI_PAISES PAINACAUX ON PAINACAUX.DD_PAI_COD_ISO='''||V_TMP_TIPO_DATA(3)||'''
                    JOIN '||V_ESQUEMA||'.CLC_CLIENTE_COMERCIAL CLC ON CLC.IAP_ID_REP=IAP.IAP_ID
WHERE IAP.IAP_ID_PERSONA_HAYA_CAIXA= '||V_TMP_TIPO_DATA(1)||'

                ) T2
                ON (T1.IAP_ID = T2.IAP_ID)
                WHEN MATCHED THEN
                UPDATE SET 
                    T1.DD_PAI_ID_RPR = T2.PAISPONER,
                    T1.FECHAMODIFICAR = SYSDATE,
                    T1.USUARIOMODIFICAR = '''||V_USU||'''	 		
                ';
		
	EXECUTE IMMEDIATE V_MSQL;  

    DBMS_OUTPUT.PUT_LINE('[INFO]: IAP_INFO_ADC_PERSONA '|| SQL%ROWCOUNT ||' PAIS REPRESENTANTE actualizados  '''||V_TMP_TIPO_DATA(1)||''' - '''||V_TMP_TIPO_DATA(3)||'''  ');

	END LOOP;

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN]');


EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecuci√≥n:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;

/

EXIT
