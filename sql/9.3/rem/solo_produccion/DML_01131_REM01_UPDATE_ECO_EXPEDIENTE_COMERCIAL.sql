--/*
--#########################################
--## AUTOR=Cristian Montoya 
--## FECHA_CREACION=20210310
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-11325
--## PRODUCTO=NO
--## 
--## Finalidad: Actualizar estados expedientes bc
--##			
--## INSTRUCCIONES:  
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	
    err_num NUMBER; -- Numero de error.
    err_msg VARCHAR2(2048); -- Mensaje de error.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_USUARIOMODIFICAR VARCHAR(100 CHAR):= 'REMVIP-11325';
    V_SQL VARCHAR2(30000 CHAR);
    V_NUM_TABLAS NUMBER;
    V_COUNT NUMBER(16):= 0; -- Vble. para contar updates
    
    
BEGIN	

    DBMS_OUTPUT.PUT_LINE('[INICIO]');
    
	V_SQL :='MERGE INTO '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL T1 USING (
			        SELECT ECO_ID
			        FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO 
			        JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = ECO.OFR_ID 
			        WHERE OFR.OFR_NUM_OFERTA IN (90387324,90387321,90387315,90386621,90386617,90386334,90386178,90386106,90386062,90385919,
							90385851,90385827,90385467,90385323,90385257,90385228,90385154,90385115,90384671,90384457,90384433,90384421,
							90384332,90384314,90384306,90384261,90384255,90384122,90384054,90383944,90383923,90383902,90383744,90383732,
							90383713,90383647,90383549,90383513,90383508,90383444,90383370,90383216,90383215,90383173,90383153,90383143,
							90383087,90382960,90382891,90382781,90382730,90382705,90382608,90382409,90382346,90382251,90382116,90382110,
							90382020,90382006,90381976,90381941,90381917,90381916,90381907,90381874,90381871,90381833,90381819,90381763,
							90381738,90381625,90381585,90381571,90381542,90381515,90381419,90381383,90381164,90381103,90381048,90380926,
							90380902,90380811,90380621,90380587,90380538,90380502,90380501,90380402,90380367,90380358,90380341,90380330,
							90380326,90380250,90380176,90380012,90379950,90379945,90379942,90379934,90379888,90379847,90379827,90379751,
							90379724,90379722,90379698,90379488,90379457,90379291,90379121,90379111,90379061,90378893,90378842,90378653,
							90378652,90378301,90378176,90378143,90378137,90378003,90377957,90377833,90377735,90377696,90377677,90377556,
							90377483,90377401,90377366,90377360,90377358,90377298,90377293,90377275,90377212,90377158,90377153,90377142,
							90377121,90376828,90376778,90376730,90376729,90376672,90376619,90376601,90376575,90376544,90376527,90376448,
							90376322,90376159,90376032,90375936,90375930,90375852,90375780,90375721,90375703,90375605,90375601,90375567,
							90375514,90375460,90375448,90375420,90375242,90375195,90375191,90375144,90375112,90375106,90375101,90351989,
							90354033,90354820,90355718,90355729,90356469,90357374,90359426,90359528,90359534,90359576,90359673,90359928,
							90360128,90362035,90362082,90362642,90363787,90365458,90365639,90371113,90372291,90373434,90374428,90376579,
							90377721,90378756,90380010,90380769,90383707,90350103,90351415,90351708,90351930,90352056,90352773,90353403,
							90353593,90353738,90353854,90353929,90355035,90355193,90355284,90355331,90355798,90355855,90355862,90355904,
							90356107,90356136,90356140,90356147,90356190,90356235,90356336,90356347,90356797,90356960,90357108,90357131,
							90357264,90357321,90357642,90359434,90359435,90359440,90359472,90359498,90359511,90359512,90359536,90359541,
							90359589,90359755,90359902,90359936,90360076,90360085,90360089,90360104,90360129,90360178,90360319,90360479,
							90360504,90360658,90360790,90360810,90360905,90360997,90361048,90361257,90361270,90361313,90361367,90361389,
							90361633,90361677,90361679,90361796,90361798,90361991,90362107,90362115,90362430,90362553,90362567,90362664,
							90362814,90362819,90362861,90362887,90362921,90363027,90363096,90363189,90363199,90363202,90363429,90363476,
							90363585,90363644,90364892,90365174,90365175,90365256,90365296,90365434,90365472,90365491,90365562,90365715,
							90365759,90365884,90365951,90370665,90370709,90370737,90370780,90370808,90370818,90370852,90370861,90370893,
							90370896,90370907,90370931,90370940,90370971,90371062,90371076,90371139,90371165,90371200,90371350,90371352,
							90371380,90371381,90371419,90371445,90371471,90371530,90371583,90371793,90371833,90371851,90371880,90371945,
							90372046,90372057,90372062,90372070,90372088,90372093,90372169,90372260,90372672,90372690,90372767,90372804,
							90372814,90372827,90372840,90372924,90373126,90373186,90373286,90373298,90373343,90373354,90373390,90373442,
							90373550,90373653,90373689,90373727,90373757,90373804,90373828,90373948,90374049,90374136,90374269,90374316,
							90374387,90374402,90374548,90374568,90374602,90374604,90374716,90374736,90374821,90374854,90374856,90374863,
							90374879,90374917,90374921,90374944,90374982,90375075,90375080,90375082) 
			    )T2
			ON (T1.ECO_ID=T2.ECO_ID)
			WHEN MATCHED THEN UPDATE SET 
			    T1.DD_EEB_ID = (SELECT DD_EEB_ID FROM '||V_ESQUEMA||'.DD_EEB_ESTADO_EXPEDIENTE_BC WHERE DD_EEB_CODIGO_C4C = ''20'')
			    ,   T1.USUARIOMODIFICAR = '''||V_USUARIOMODIFICAR||'''
			    ,   T1.FECHAMODIFICAR = SYSDATE';
    
    EXECUTE IMMEDIATE V_SQL;

    DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado  '||SQL%ROWCOUNT||' registros con estado oferta cancelada.');
    
	V_SQL :='MERGE INTO '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL T1 USING (
			        SELECT ECO_ID
			        FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO 
			        JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = ECO.OFR_ID 
			        WHERE OFR.OFR_NUM_OFERTA IN (90353871,90376181,90365541,90107198,90254458,90281342,90301787,90307048,90325040,90337481,
							90348352,90348619,90349861,90349949,90351303,90352885,90354861,90365293,90170450,90215286,90227063,90231053,
							90279017,90290843,90302633,90303913,90306610,90315135,90318504,90320271,90321501,90325158,90325364,90326928,
							90326940,90327786,90328071,90328575,90329472,90329594,90330012,90330439,90331093,90332118,90332321,90332423,
							90332509,90332600,90332688,90333657,90333704,90333838,90335326,90335526,90335593,90336097,90336194,90336545,
							90336932,90337741,90339171,90339294,90339848,90340469,90340536,90340888,90340958,90341250,90341897,90342071,
							90342141,90342188,90342629,90343323,90343359,90343382,90343570,90344048,90345016,90345282,90345322,90345404,
							90345514,90345604,90345964,90346041,90346078,90346177,90346636,90347629,90347666,90347711,90347807,90348196,
							90348499,90348504,90348680,90348706,90348907,90348948,90349038,90349119,90349214,90349327,90349419,90349644,
							90349741,90349767,90349920,90350162,90350478,90350502,90350596,90350694,90351192,90351203,90351304,90351432,
							90351716,90351785,90351849,90352220,90352309,90352355,90352409,90352418,90352580,90352593,90352658,90352666,
							90352700,90352704,90352848,90352857,90353001,90353012,90353072,90353157,90353200,90353252,90353258,90353425,
							90353436,90353582,90353639,90353658,90353704,90353802,90353840,90354061,90354339,90354414,90354418,90354430,
							90354442,90354449,90354464,90354526,90354629,90354661,90354748,90356614,90357209,90357627,90359461,90359467,
							90359588,90359729,90360893,90361907,90362387,90362541,90363435,90363503,90363794)
			    )T2
			ON (T1.ECO_ID=T2.ECO_ID)
			WHEN MATCHED THEN UPDATE SET 
			    T1.DD_EEB_ID = (SELECT DD_EEB_ID FROM '||V_ESQUEMA||'.DD_EEB_ESTADO_EXPEDIENTE_BC WHERE DD_EEB_CODIGO_C4C = ''150'')
			    ,   T1.USUARIOMODIFICAR = '''||V_USUARIOMODIFICAR||'''
			    ,   T1.FECHAMODIFICAR = SYSDATE';

   	EXECUTE IMMEDIATE V_SQL;
   	
    DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado  '||SQL%ROWCOUNT||' registros con estado compromiso cancelado.');
   	
	V_SQL :='MERGE INTO '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL T1 USING (
			        SELECT ECO_ID
			        FROM '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO 
			        JOIN '||V_ESQUEMA||'.OFR_OFERTAS OFR ON OFR.OFR_ID = ECO.OFR_ID 
			        WHERE OFR.OFR_NUM_OFERTA IN (90351728,90349974,90349316,90348012,90344753,90339565,90338832,90337604,90336404,90334832,
							90332073,90331441,90330510,90330433,90330384,90324968,90324886,90323268,90317483,90315549,90313404,90305757,
							90290951,90287968,90286982,90269330,90263105,90252082,90245125,90228880,90196935,90305725)
			    )T2
			ON (T1.ECO_ID=T2.ECO_ID)
			WHEN MATCHED THEN UPDATE SET 
			    T1.DD_EEB_ID = (SELECT DD_EEB_ID FROM '||V_ESQUEMA||'.DD_EEB_ESTADO_EXPEDIENTE_BC WHERE DD_EEB_CODIGO_C4C = ''150'')
			    ,   T1.DD_EEC_ID = (SELECT DD_EEC_ID FROM '||V_ESQUEMA||'.DD_EEC_EST_EXP_COMERCIAL WHERE DD_EEC_CODIGO = ''02'')
			    ,   T1.USUARIOMODIFICAR = '''||V_USUARIOMODIFICAR||'''
			    ,   T1.FECHAMODIFICAR = SYSDATE';
    
    EXECUTE IMMEDIATE V_SQL;
    
    DBMS_OUTPUT.PUT_LINE('[INFO] Se han actualizado  '||SQL%ROWCOUNT||' registros con estado compromiso cancelado y expediente anulado.');

    COMMIT;

    DBMS_OUTPUT.PUT_LINE('[FIN]');

EXCEPTION

    WHEN OTHERS THEN
        DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
        DBMS_OUTPUT.put_line('-----------------------------------------------------------');
        DBMS_OUTPUT.put_line(SQLERRM);
        ROLLBACK;
        RAISE;
END;
/
EXIT
