--/*
--######################################### 
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20220325
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-11401
--## PRODUCTO=NO
--##            
--## INSTRUCCIONES:  ANULAR OFERTAS
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;

DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejECVtar    
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	V_USU VARCHAR2(30 CHAR) := 'REMVIP-11401';
	V_NUM_TABLAS NUMBER(16);
	V_EOF_ID NUMBER(16);
	V_COUNT NUMBER(16);

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
		T_TIPO_DATA(90388496),
		T_TIPO_DATA(90388071),
		T_TIPO_DATA(90385912),
		T_TIPO_DATA(90385710),
		T_TIPO_DATA(90385239),
		T_TIPO_DATA(90384884),
		T_TIPO_DATA(90384510),
		T_TIPO_DATA(90384528),
		T_TIPO_DATA(90384235),
		T_TIPO_DATA(90383619),
		T_TIPO_DATA(90383232),
		T_TIPO_DATA(90382360),
		T_TIPO_DATA(90381932),
		T_TIPO_DATA(90381513),
		T_TIPO_DATA(90381496),
		T_TIPO_DATA(90379002),
		T_TIPO_DATA(90379019),
		T_TIPO_DATA(90378570),
		T_TIPO_DATA(90378188),
		T_TIPO_DATA(90377740),
		T_TIPO_DATA(90377666),
		T_TIPO_DATA(90377634),
		T_TIPO_DATA(90377259),
		T_TIPO_DATA(90377195),
		T_TIPO_DATA(90377022),
		T_TIPO_DATA(90376443),
		T_TIPO_DATA(90376273),
		T_TIPO_DATA(90375897),
		T_TIPO_DATA(90374750),
		T_TIPO_DATA(90374288),
		T_TIPO_DATA(90373959),
		T_TIPO_DATA(90373749),
		T_TIPO_DATA(90373281),
		T_TIPO_DATA(90373292),
		T_TIPO_DATA(90372781),
		T_TIPO_DATA(90371810),
		T_TIPO_DATA(90371122),
		T_TIPO_DATA(90370767),
		T_TIPO_DATA(90365807),
		T_TIPO_DATA(90365681),
		T_TIPO_DATA(90365151),
		T_TIPO_DATA(90365154),
		T_TIPO_DATA(90364954),
		T_TIPO_DATA(90363514),
		T_TIPO_DATA(90364998),
		T_TIPO_DATA(90363363),
		T_TIPO_DATA(90363437),
		T_TIPO_DATA(90363225),
		T_TIPO_DATA(90362855),
		T_TIPO_DATA(90362548),
		T_TIPO_DATA(90362184),
		T_TIPO_DATA(90362165),
		T_TIPO_DATA(90364961),
		T_TIPO_DATA(90361492),
		T_TIPO_DATA(90360912),
		T_TIPO_DATA(90360897),
		T_TIPO_DATA(90360802),
		T_TIPO_DATA(90360596)
    ); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN

	 -- LOOP para insertar los valores --
    DBMS_OUTPUT.PUT_LINE('[INFO]: UPDATE EN OFR_OFERTAS');
    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST

    LOOP
	V_TMP_TIPO_DATA := V_TIPO_DATA(I);

		EXECUTE IMMEDIATE 'SELECT COUNT(*) FROM '||V_ESQUEMA||'.OFR_OFERTAS 
					WHERE OFR_NUM_OFERTA = :1 AND BORRADO = 0' INTO V_COUNT USING V_TMP_TIPO_DATA(1);

		IF V_COUNT > 0 THEN	

			EXECUTE IMMEDIATE 'SELECT OFR.DD_EOF_ID FROM '||V_ESQUEMA||'.OFR_OFERTAS 
						WHERE OFR_NUM_OFERTA = :1 AND BORRADO = 0' INTO V_EOF_ID USING V_TMP_TIPO_DATA(1);

			DBMS_OUTPUT.PUT_LINE('[INFO] OFERTA '||V_TMP_TIPO_DATA(1)||' TENIA DD_EOF_ID '||V_EOF_ID);

			EXECUTE IMMEDIATE'UPDATE '||V_ESQUEMA||'.OFR_OFERTAS SET 
						DD_EOF_ID = (SELECT DD_EOF_ID FROM '||V_ESQUEMA||'.DD_EOF_ESTADOS_OFERTA WHERE DD_EOF_CODIGO = ''02'' AND BORRADO = 0),
						USUARIOMODIFICAR = :1,
						FECHAMODIFICAR = SYSDATE
						WHERE OFR_NUM_OFERTA = :2 AND BORRADO = 0' USING V_USU,V_TMP_TIPO_DATA(1);
			
			DBMS_OUTPUT.PUT_LINE('[INFO] OFERTA '||V_TMP_TIPO_DATA(1)||' MODIFICADA');

		ELSE 

			DBMS_OUTPUT.PUT_LINE('[INFO] NO EXISTE LA OFERTA '||V_TMP_TIPO_DATA(1)||'');

		END IF;
        
	END LOOP;

    COMMIT;

EXCEPTION
     WHEN OTHERS THEN 
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejECVción:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;

/

EXIT;