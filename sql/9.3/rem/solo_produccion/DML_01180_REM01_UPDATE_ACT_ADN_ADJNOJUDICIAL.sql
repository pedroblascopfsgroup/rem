--/*
--######################################### 
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20220715
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-12089
--## PRODUCTO=NO
--##            
--## INSTRUCCIONES:UPDATE fecha posesion ACT_ADN_ADJNOJUDICIAL
--## VERSIONES:
--##        0.1 Versión inicial
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
	V_TEXT_TABLA VARCHAR2(2400 CHAR) := 'ACT_ADN_ADJNOJUDICIAL'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
	V_USUARIO VARCHAR2(32 CHAR) := 'REMVIP-12089';

    
    TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
    	T_TIPO_DATA(7488989,'12/31/1899'),
        T_TIPO_DATA(7487843,'7/30/2009'),
        T_TIPO_DATA(7488451,'11/7/2011'),
        T_TIPO_DATA(7491790,'5/22/2009'),
        T_TIPO_DATA(7488288,'9/22/2017'),
        T_TIPO_DATA(7489013,'11/23/2017'),
        T_TIPO_DATA(7489663,'6/5/2018'),
        T_TIPO_DATA(7487107,'2/19/2019'),
        T_TIPO_DATA(7488245,'3/27/2019'),
        T_TIPO_DATA(7489411,'10/22/2020'),
        T_TIPO_DATA(7488602,'2/28/2013'),
        T_TIPO_DATA(7489724,'6/28/2021'),
        T_TIPO_DATA(7491134,'11/9/2021'),
        T_TIPO_DATA(7486720,'7/11/2022'),
        T_TIPO_DATA(7489279,'9/30/2011'),
        T_TIPO_DATA(7488143,'3/24/2012'),
        T_TIPO_DATA(7488037,'2/24/2014'),
        T_TIPO_DATA(7489275,'11/16/2015'),
        T_TIPO_DATA(7488162,'4/26/2016'),
        T_TIPO_DATA(7488118,'1/25/2017'),
        T_TIPO_DATA(7487848,'9/30/2011'),
        T_TIPO_DATA(7491815,'12/12/2018'),
        T_TIPO_DATA(7486965,'9/15/2017'),
        T_TIPO_DATA(7487222,'11/8/2013'),
        T_TIPO_DATA(7489114,'2/28/2013'),
        T_TIPO_DATA(7486509,'5/27/2015'),
        T_TIPO_DATA(7489710,'5/14/2018'),
        T_TIPO_DATA(7488126,'11/1/2019'),
        T_TIPO_DATA(7486679,'7/1/2022'),
        T_TIPO_DATA(7489617,'12/2/2020'),
        T_TIPO_DATA(7488815,'2/3/2015'),
        T_TIPO_DATA(7491557,'9/20/2010'),
        T_TIPO_DATA(7487227,'12/30/2010'),
        T_TIPO_DATA(7486880,'11/5/2020'),
        T_TIPO_DATA(7488954,'2/2/2012'),
        T_TIPO_DATA(7491544,'5/11/2009'),
        T_TIPO_DATA(7487135,'8/4/2017'),
        T_TIPO_DATA(7488418,'2/20/2019'),
        T_TIPO_DATA(7489440,'7/13/2020'),
        T_TIPO_DATA(7489613,'9/30/2011'),
        T_TIPO_DATA(7487353,'11/8/2013'),
        T_TIPO_DATA(7489633,'9/24/2015'),
        T_TIPO_DATA(7491594,'9/25/2013'),
        T_TIPO_DATA(7489482,'12/31/1899'),
        T_TIPO_DATA(7489484,'4/3/2019'),
        T_TIPO_DATA(7486796,'5/7/2021'),
        T_TIPO_DATA(7488861,'10/30/2013'),
        T_TIPO_DATA(7487676,'5/30/2012'),
        T_TIPO_DATA(7489010,'2/28/2013'),
        T_TIPO_DATA(7489329,'7/24/2017'),
        T_TIPO_DATA(7487202,'5/21/2019'),
        T_TIPO_DATA(7489443,'12/18/2020'),
        T_TIPO_DATA(7486696,'11/15/2018'),
        T_TIPO_DATA(7487056,'5/11/2017'),
        T_TIPO_DATA(7487092,'10/17/2017'),
        T_TIPO_DATA(7488040,'6/21/2011'),
        T_TIPO_DATA(7489222,'5/22/2009'),
        T_TIPO_DATA(7488468,'11/8/2013'),
        T_TIPO_DATA(7489487,'12/18/2017'),
        T_TIPO_DATA(7488755,'3/27/2018'),
        T_TIPO_DATA(7489715,'2/4/2020'),
        T_TIPO_DATA(7486762,'12/12/2017'),
        T_TIPO_DATA(7492008,'3/29/2021'),
        T_TIPO_DATA(7488095,'11/20/2018'),
        T_TIPO_DATA(7489478,'10/31/2016'),
        T_TIPO_DATA(7489485,'9/30/2011'),
        T_TIPO_DATA(7488713,'3/1/2018'),
        T_TIPO_DATA(7488718,'6/22/2018'),
        T_TIPO_DATA(7489585,'10/11/2018'),
        T_TIPO_DATA(7491859,'12/17/2019'),
        T_TIPO_DATA(7488427,'10/21/2020'),
        T_TIPO_DATA(7489122,'6/23/2015'),
        T_TIPO_DATA(7488435,'7/28/2015'),
        T_TIPO_DATA(7487824,'2/20/2020'),
        T_TIPO_DATA(7489268,'10/25/2013'),
        T_TIPO_DATA(7489273,'10/25/2013'),
        T_TIPO_DATA(7489106,'2/28/2013'),
        T_TIPO_DATA(7489379,'11/4/2014'),
        T_TIPO_DATA(7489714,'8/20/2019'),
        T_TIPO_DATA(7489451,'6/25/2020'),
        T_TIPO_DATA(7488309,'3/16/2021'),
        T_TIPO_DATA(7486736,'11/20/2020'),
        T_TIPO_DATA(7487241,'7/15/2015'),
        T_TIPO_DATA(7489312,'9/30/2011'),
        T_TIPO_DATA(7488318,'2/1/2018'),
        T_TIPO_DATA(7486474,'11/19/2021'),
        T_TIPO_DATA(7487748,'1/22/2018'),
        T_TIPO_DATA(7486798,'12/31/1899'),
        T_TIPO_DATA(7489321,'11/11/2014'),
        T_TIPO_DATA(7489759,'12/10/2019'),
        T_TIPO_DATA(7488572,'7/25/2017'),
        T_TIPO_DATA(7489160,'2/22/2019'),
        T_TIPO_DATA(7492020,'4/20/2021'),
        T_TIPO_DATA(7486815,'10/24/2012'),
        T_TIPO_DATA(7486945,'10/22/2012'),
        T_TIPO_DATA(7487767,'2/16/2015'),
        T_TIPO_DATA(7487901,'7/18/2011'),
        T_TIPO_DATA(7489148,'10/2/2019'),
        T_TIPO_DATA(7488330,'7/25/2016'),
        T_TIPO_DATA(7491520,'7/24/2012'),
        T_TIPO_DATA(7486687,'7/21/2017'),
        T_TIPO_DATA(7491713,'10/1/2018'),
        T_TIPO_DATA(7487725,'12/17/2020'),
        T_TIPO_DATA(7491932,'4/14/2021'),
        T_TIPO_DATA(7487255,'4/30/2013'),
        T_TIPO_DATA(7489206,'1/25/2018'),
        T_TIPO_DATA(7487259,'11/14/2019'),
        T_TIPO_DATA(7488175,'1/23/2018'),
        T_TIPO_DATA(7487416,'2/14/2018'),
        T_TIPO_DATA(7488017,'1/30/2020'),
        T_TIPO_DATA(7491999,'1/17/2022'),
        T_TIPO_DATA(7488609,'2/28/2013'),
        T_TIPO_DATA(7488053,'11/8/2013'),
        T_TIPO_DATA(7486749,'6/12/2019'),
        T_TIPO_DATA(7486955,'11/6/2014'),
        T_TIPO_DATA(7489359,'7/6/2017'),
        T_TIPO_DATA(7489244,'10/15/2021'),
        T_TIPO_DATA(7487695,'2/15/2018'),
        T_TIPO_DATA(7489162,'2/15/2019'),
        T_TIPO_DATA(7486497,'2/29/2016'),
        T_TIPO_DATA(7489232,'9/1/2012'),
        T_TIPO_DATA(7487841,'10/6/2017'),
        T_TIPO_DATA(7486730,'2/6/2018'),
        T_TIPO_DATA(7486811,'9/19/2017'),
        T_TIPO_DATA(7487183,'9/23/2015'),
        T_TIPO_DATA(7488244,'2/1/2016'),
        T_TIPO_DATA(7487591,'7/26/2018'),
        T_TIPO_DATA(7491766,'1/4/2010'),
        T_TIPO_DATA(7488114,'9/30/2011'),
        T_TIPO_DATA(7489423,'9/30/2011'),
        T_TIPO_DATA(7486333,'1/23/2018'),
        T_TIPO_DATA(7486914,'10/5/2021'),
        T_TIPO_DATA(7486513,'10/24/2019'),
        T_TIPO_DATA(7486932,'10/14/2016'),
        T_TIPO_DATA(7488194,'1/17/2018'),
        T_TIPO_DATA(7487579,'8/4/2017'),
        T_TIPO_DATA(7486268,'3/8/2018'),
        T_TIPO_DATA(7486944,'10/11/2018'),
        T_TIPO_DATA(7488939,'6/25/2020'),
        T_TIPO_DATA(7489058,'5/22/2018'),
        T_TIPO_DATA(7486642,'5/22/2009'),
        T_TIPO_DATA(7487934,'2/28/2013'),
        T_TIPO_DATA(7486872,'12/30/2010'),
        T_TIPO_DATA(7491732,'12/30/2008'),
        T_TIPO_DATA(7486911,'1/19/2018'),
        T_TIPO_DATA(7491825,'2/6/2018'),
        T_TIPO_DATA(7488766,'12/1/2021'),
        T_TIPO_DATA(7488315,'2/1/2018'),
        T_TIPO_DATA(7489604,'7/26/2010'),
        T_TIPO_DATA(7488823,'2/12/2016'),
        T_TIPO_DATA(7488484,'4/4/2019'),
        T_TIPO_DATA(7488429,'2/22/2018'),
        T_TIPO_DATA(7487140,'3/26/2019'),
        T_TIPO_DATA(7488564,'2/15/2017'),
        T_TIPO_DATA(7488507,'11/5/2014'),
        T_TIPO_DATA(7487734,'2/28/2013'),
        T_TIPO_DATA(7488079,'9/30/2011'),
        T_TIPO_DATA(7486408,'7/22/2011'),
        T_TIPO_DATA(7489029,'1/24/2019'),
        T_TIPO_DATA(7489856,'6/17/2019'),
        T_TIPO_DATA(7491966,'3/24/2021'),
        T_TIPO_DATA(7489512,'9/17/2014'),
        T_TIPO_DATA(7488138,'11/8/2013'),
        T_TIPO_DATA(7487221,'11/8/2013'),
        T_TIPO_DATA(7489024,'3/4/2016'),
        T_TIPO_DATA(7487203,'8/17/2017'),
        T_TIPO_DATA(7488005,'4/15/2019'),
        T_TIPO_DATA(7487588,'7/11/2019'),
        T_TIPO_DATA(7489178,'10/3/2017'),
        T_TIPO_DATA(7488885,'3/16/2021'),
        T_TIPO_DATA(7491958,'11/11/2021'),
        T_TIPO_DATA(7486566,'2/13/2017'),
        T_TIPO_DATA(7489809,'10/30/2017'),
        T_TIPO_DATA(7491643,'8/3/2011'),
        T_TIPO_DATA(7491845,'5/23/2019'),
        T_TIPO_DATA(7488595,'9/6/2019'),
        T_TIPO_DATA(7489778,'9/23/2016'),
        T_TIPO_DATA(7487163,'1/26/2015'),
        T_TIPO_DATA(7487043,'12/30/2010'),
        T_TIPO_DATA(7488514,'12/20/2011'),
        T_TIPO_DATA(7486559,'7/3/2012'),
        T_TIPO_DATA(7489626,'10/24/2012'),
        T_TIPO_DATA(7489538,'2/5/2021'),
        T_TIPO_DATA(7488873,'3/27/2018'),
        T_TIPO_DATA(7491848,'9/16/2019'),
        T_TIPO_DATA(7487366,'1/28/2016'),
        T_TIPO_DATA(7487468,'3/30/2012'),
        T_TIPO_DATA(7487392,'8/13/2014'),
        T_TIPO_DATA(7491133,'11/9/2021'),
        T_TIPO_DATA(7489069,'9/18/2015'),
        T_TIPO_DATA(7486528,'4/7/2015'),
        T_TIPO_DATA(7488098,'5/31/2012'),
        T_TIPO_DATA(7489666,'3/2/2018'),
        T_TIPO_DATA(7489137,'9/3/2019'),
        T_TIPO_DATA(7489417,'2/1/2022'),
        T_TIPO_DATA(7489539,'9/19/2018'),
        T_TIPO_DATA(7489410,'6/18/2019'),
        T_TIPO_DATA(7489257,'12/31/1899'),
        T_TIPO_DATA(7487500,'5/9/2006'),
        T_TIPO_DATA(7489456,'11/15/2015'),
        T_TIPO_DATA(7489109,'3/21/2016'),
        T_TIPO_DATA(7486623,'9/14/2017'),
        T_TIPO_DATA(7488399,'11/30/2020'),
        T_TIPO_DATA(7489496,'6/23/2020'),
        T_TIPO_DATA(7488549,'5/20/2016'),
        T_TIPO_DATA(7487299,'10/8/2015'),
        T_TIPO_DATA(7489098,'1/26/2017'),
        T_TIPO_DATA(7486426,'5/8/2013'),
        T_TIPO_DATA(7488104,'2/7/2019'),
        T_TIPO_DATA(7487875,'1/23/2019'),
        T_TIPO_DATA(7488770,'1/14/2021'),
        T_TIPO_DATA(7488730,'10/28/2020'),
        T_TIPO_DATA(7489699,'11/14/2011'),
        T_TIPO_DATA(7488562,'1/10/2017')
    ); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    
BEGIN
DBMS_OUTPUT.PUT_LINE('[INICIO]');


    DBMS_OUTPUT.PUT_LINE('[INFO]: UPDATE EN '||V_TEXT_TABLA);
    FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
    LOOP

        V_TMP_TIPO_DATA := V_TIPO_DATA(I);

        V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||TRIM(V_TMP_TIPO_DATA(1))||' AND BORRADO = 0';
        EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;
        -- Si existe se modifica.
        IF V_NUM_TABLAS > 0 THEN				
            
            DBMS_OUTPUT.PUT_LINE('[INFO]: MODIFICAR EL ACTIVO '||V_TMP_TIPO_DATA(1)||'');
            V_MSQL := 'UPDATE '|| V_ESQUEMA ||'.'||V_TEXT_TABLA||'
                        SET FECHA_POSESION = TO_DATE('''||TRIM(V_TMP_TIPO_DATA(2))||''',''MM/DD/YYYY'')
                            , USUARIOMODIFICAR = '''||V_USUARIO||''' 
                            , FECHAMODIFICAR = SYSDATE 
                        WHERE ACT_ID = (SELECT ACT_ID FROM '|| V_ESQUEMA ||'.ACT_ACTIVO 
                            WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||')';
            EXECUTE IMMEDIATE V_MSQL;
            DBMS_OUTPUT.PUT_LINE('[INFO]: REGISTRO MODIFICADO CORRECTAMENTE');

        ELSE

          DBMS_OUTPUT.PUT_LINE('[INFO]: NO EXISTE EL ACTIVO:  '||V_TMP_TIPO_DATA(1)||'');

        END IF;
    END LOOP;
      
    COMMIT;
    DBMS_OUTPUT.PUT_LINE('[FIN]: TABLA '||V_TEXT_TABLA||' ACTUALIZADO CORRECTAMENTE ');

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;
