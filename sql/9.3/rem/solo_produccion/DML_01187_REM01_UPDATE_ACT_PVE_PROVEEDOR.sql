--/*
--##########################################
--## AUTOR=Juan Bautista Alfonso
--## FECHA_CREACION=20220916
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-12426
--## PRODUCTO=NO
--##
--## Finalidad: Script actualiza codigo caixa provedores
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_TEXT_TABLA VARCHAR2(27 CHAR) := 'ACT_PVE_PROVEEDOR'; -- Vble. auxiliar para almacenar el nombre de la tabla de ref.
    V_USU VARCHAR2(30 CHAR) := 'REMVIP-12426'; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.
	V_COUNT NUMBER(16);

    V_COUNT_REG NUMBER(16):=0;
    V_COUNT_REG_TOTAL NUMBER(16):=0;

	TYPE T_TIPO_DATA IS TABLE OF VARCHAR2(150);
    TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
		-- 			DOCIDENTIF  PVE_COD_UVEM
T_TIPO_DATA('H59009571','1018500'),
T_TIPO_DATA('H78810918','1018582'),
T_TIPO_DATA('H79752762','1021826'),
T_TIPO_DATA('H25496092','1021813'),
T_TIPO_DATA('H07535438','1020505'),
T_TIPO_DATA('H59553651','1020305'),
T_TIPO_DATA('H82376864','1021825'),
T_TIPO_DATA('H79845756','1021827'),
T_TIPO_DATA('H64168586','1018560'),
T_TIPO_DATA('H07521461','1018338'),
T_TIPO_DATA('H79743688','1020375'),
T_TIPO_DATA('H64072879','1018559'),
T_TIPO_DATA('H25239617','1005851'),
T_TIPO_DATA('H45037959','1021845'),
T_TIPO_DATA('H61406344','1018532'),
T_TIPO_DATA('H31952021','1018418'),
T_TIPO_DATA('H79798914','1018663'),
T_TIPO_DATA('H13434956','1021809'),
T_TIPO_DATA('H33208356','1018419'),
T_TIPO_DATA('H59767798','1021592'),
T_TIPO_DATA('H35208461','1007105'),
T_TIPO_DATA('H43275650','1020303'),
T_TIPO_DATA('H85495323','1018745'),
T_TIPO_DATA('H64680929','1018569'),
T_TIPO_DATA('H25252669','1018401'),
T_TIPO_DATA('H79247128','1018599'),
T_TIPO_DATA('H57558769','1018487'),
T_TIPO_DATA('H80246374','1018690'),
T_TIPO_DATA('H59720060','1018513'),
T_TIPO_DATA('H35756931','1018427'),
T_TIPO_DATA('H79527008','1018617'),
T_TIPO_DATA('H25568528','1018404'),
T_TIPO_DATA('H79660379','1018639'),
T_TIPO_DATA('H59366013','1020300'),
T_TIPO_DATA('H59747105','1020295'),
T_TIPO_DATA('H01939420','1018320'),
T_TIPO_DATA('H45454998','1018463'),
T_TIPO_DATA('H59866681','1005149'),
T_TIPO_DATA('H79692240','1021824'),
T_TIPO_DATA('H17899774','1021811'),
T_TIPO_DATA('H25207622','1005683'),
T_TIPO_DATA('H63757298','1021802'),
T_TIPO_DATA('E78005790','1018302'),
T_TIPO_DATA('H63177315','1018549'),
T_TIPO_DATA('H17578246','1018387'),
T_TIPO_DATA('H63738942','1021823'),
T_TIPO_DATA('H17294810','1004451'),
T_TIPO_DATA('H81540023','1021843'),
T_TIPO_DATA('H82426107','1018728'),
T_TIPO_DATA('H45707874','1021846'),
T_TIPO_DATA('H60368701','1018524'),
T_TIPO_DATA('H07322811','1018334'),
T_TIPO_DATA('H63935613','1021814'),
T_TIPO_DATA('H0457400','1021564'),
T_TIPO_DATA('H79702809','1021810'),
T_TIPO_DATA('H45633823','1021702'),
T_TIPO_DATA('H35259936','1021704'),
T_TIPO_DATA('H81780520','1021812'),
T_TIPO_DATA('G81472920','1021821'),
T_TIPO_DATA('H04704920','1021857'),
T_TIPO_DATA('H43573286','1018446'),
T_TIPO_DATA('H43370063','1008327'),
T_TIPO_DATA('H64261092','1018562'),
T_TIPO_DATA('E16020497','1018298'),
T_TIPO_DATA('H61794707','1018536'),
T_TIPO_DATA('H58648163','1018492'),
T_TIPO_DATA('H60205077','1002595'),
T_TIPO_DATA('H43747690','1018449'),
T_TIPO_DATA('H61794491','1018535'),
T_TIPO_DATA('H43984053','1018454'),
T_TIPO_DATA('H33307976','1018422'),
T_TIPO_DATA('H62396106','1018540'),
T_TIPO_DATA('H62612114','1018543'),
T_TIPO_DATA('H63574776','1018552'),
T_TIPO_DATA('H58916594','1018497'),
T_TIPO_DATA('H17241530','1018371'),
T_TIPO_DATA('H50429398','1018477'),
T_TIPO_DATA('H43210426','1007660'),
T_TIPO_DATA('B19163690','1018297'),
T_TIPO_DATA('H17474529','1018385'),
T_TIPO_DATA('H17275843','1018378'),
T_TIPO_DATA('H59709915','1018511'),
T_TIPO_DATA('H65136558','1018572'),
T_TIPO_DATA('H55016562','1021453'),
T_TIPO_DATA('H43271451','1021822'),
T_TIPO_DATA('H80307655','1021820'),
T_TIPO_DATA('H17350547','1021816'),
T_TIPO_DATA('H43854660','1018452'),
T_TIPO_DATA('H43275494','1018441'),
T_TIPO_DATA('H79582904','1021844'),
T_TIPO_DATA('H80222318','1020299'),
T_TIPO_DATA('H17274739','1004258'),
T_TIPO_DATA('H64987993','1007171'),
T_TIPO_DATA('H62986617','1018545'),
T_TIPO_DATA('H26385567','1018411'),
T_TIPO_DATA('H62698584','1018544'),
T_TIPO_DATA('H07603335','1018340'),
T_TIPO_DATA('H60165131','1005341'),
T_TIPO_DATA('P1406600E','4002429'),
T_TIPO_DATA('P1808000B','4002551')

        ); 
    V_TMP_TIPO_DATA T_TIPO_DATA;

    
BEGIN		

	DBMS_OUTPUT.PUT_LINE('[INICIO]');
	DBMS_OUTPUT.PUT_LINE('[INFO]: INFORMAR CODIGO_CAIXA EN CAMPO PVE_COD_UVEM, TABLA '||V_TEXT_TABLA);
    
	FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
    LOOP
        V_TMP_TIPO_DATA := V_TIPO_DATA(I);
        V_COUNT_REG_TOTAL :=V_COUNT_REG_TOTAL+1;

        DBMS_OUTPUT.PUT_LINE('[INFO]: Se procede a actualizar proveedor '''||TRIM(V_TMP_TIPO_DATA(1))||'''  ');

		V_MSQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE PVE_DOCIDENTIF = '''||TRIM(V_TMP_TIPO_DATA(1))||''' AND BORRADO = 0 AND PVE_FECHA_BAJA IS NULL';
		EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

		IF V_COUNT > 0 THEN

            V_MSQL:= 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.'||V_TEXT_TABLA||' WHERE PVE_DOCIDENTIF = '''||TRIM(V_TMP_TIPO_DATA(1))||''' 
            AND (PVE_COD_UVEM!='||V_TMP_TIPO_DATA(2)||' OR PVE_COD_UVEM IS NULL) AND BORRADO = 0 AND PVE_FECHA_BAJA IS NULL';
            EXECUTE IMMEDIATE V_MSQL INTO V_COUNT;

			IF V_COUNT > 0 THEN

                V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_PVE_PROVEEDOR T1
                            USING (
                                select PVE.PVE_ID from '||V_ESQUEMA||'.act_pve_proveedor pve
                                where pve.pve_docidentif ='''||TRIM(V_TMP_TIPO_DATA(1))||''' AND (PVE.PVE_COD_UVEM!='||V_TMP_TIPO_DATA(2)||' OR PVE.PVE_COD_UVEM IS NULL) 
                                AND PVE.BORRADO = 0 AND PVE.PVE_FECHA_BAJA IS NULL
                            ) T2
                            ON (T1.PVE_ID = T2.PVE_ID)
                            WHEN MATCHED THEN
                            UPDATE SET 
                                PVE_COD_UVEM = '||V_TMP_TIPO_DATA(2)||',
                                FECHAMODIFICAR = SYSDATE,
                                USUARIOMODIFICAR = '''||V_USU||'''	 		
                            ';
                    
                EXECUTE IMMEDIATE V_MSQL;  

                DBMS_OUTPUT.PUT_LINE('[INFO]: '|| SQL%ROWCOUNT ||' Proveedores actualizados  ');
                V_COUNT_REG := V_COUNT_REG+1;

			ELSE

				DBMS_OUTPUT.PUT_LINE('[WARN]: EL PROVEEDOR '||V_TMP_TIPO_DATA(1)||' YA TIENE EL PVE_COD_REM = '||V_TMP_TIPO_DATA(2)||' ');

			END IF;

		ELSE

			DBMS_OUTPUT.PUT_LINE('[ERROR]: NO EXISTE PROVEEDOR CON DOCIDENTIF '||V_TMP_TIPO_DATA(1)||' ');

		END IF;

	END LOOP;

    DBMS_OUTPUT.PUT_LINE('[INFO]: SE HAN ACTUALIZADO '||V_COUNT_REG||' DE '||V_COUNT_REG_TOTAL||' ');

	COMMIT;

	DBMS_OUTPUT.PUT_LINE('[FIN]');


EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;

/

EXIT