--/*
--##########################################
--## AUTOR=IVAN REPISO
--## FECHA_CREACION=20230110
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-13080
--## PRODUCTO=NO
--##
--## Finalidad: Script modifica CUENTA Y PARTIDA
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_USU VARCHAR2(30 CHAR) := 'REMVIP-13080'; -- Vble. auxiliar para almacenar el nombre de usuario que modifica los registros.
    V_CONDICION VARCHAR2(32000 CHAR) := 'GPV_NUM_GASTO_HAYA IN (15624947,15637522,15637523,15637635,15638199,15638200,15638201,15638202,15638205,15638206,
                                         15638207, 15638208, 15638209, 15638210, 15638211, 15638212, 15638213, 15638214, 15638215, 15638216, 15638217, 15640101,
                                         15640104, 15640117, 15640139, 15640141, 15640142, 15640143, 15638160, 15637565, 15639726, 15637915, 15637916, 15637917,
                                         15637918, 15637919, 15637921, 15637922, 15637923, 15637924, 15637925, 15639629, 15639630, 15639631, 15639793, 15640068,
                                         15646929, 15637554, 15637555, 15637556, 15637557, 15637558, 15637559, 15639692, 15637897, 15637797, 15639696, 15639698,
                                         15639718, 15639731, 15637869, 15637877, 15637771, 15637886, 15637887, 15639753, 15637963, 15637964, 15639667, 15639668,
                                         15639699, 15640003, 15638187, 15638195, 15638196, 15639655, 15639656, 15639754, 15639757, 15639763, 15639764, 15639766,
                                         15639768, 15639771, 15639772, 15639777, 15639778, 15639783, 15639786, 15639835, 15639837, 15639838, 15639841, 15639843,
                                         15639845, 15639847, 15639848, 15639851, 15639853, 15639855, 15639857, 15639858, 15639861, 15639864, 15639866, 15639868,
                                         15639869, 15639872, 15639873, 15639876, 15639877, 15639880, 15639882, 15639883, 15639885, 15639887, 15639889, 15639892,
                                         15639894, 15639896, 15639897, 15639899, 15639902, 15639903, 15639906, 15639907, 15639909, 15639910, 15639912, 15639914,
                                         15639916, 15639918, 15639920, 15639922, 15639924, 15639927, 15639929, 15639931, 15639933, 15639934, 15639935, 15639936,
                                         15639937, 15639938, 15639939, 15639940, 15639941, 15639942, 15639943, 15639944, 15639945, 15639947, 15639948, 15639949,
                                         15639950, 15639951, 15639952, 15639953, 15639997, 15640000, 15640002, 15640010, 15640012, 15640040, 15640047, 15640049,
                                         15640090, 15640094, 15640095, 15640098, 15640125, 15638178, 15638179, 15638180, 15638181, 15639635, 15637711, 15639653,
                                         15639654, 15639823, 15637746, 15639614, 15639615, 15639616, 15639747, 15640074, 15638193, 15637848, 15639618, 15639833,
                                         15638227, 15639748, 15639651, 15639649, 15637935, 15638224, 15638228, 15639716, 15639717, 15639721, 15640020, 15639628,
                                         15639657, 15639741, 15639774, 15639752, 15639619, 15639804, 15637777, 15639746, 15640045, 15639831, 15639627, 15639734,
                                         15639736, 15639737, 15639738, 15639739, 15639740, 15639773, 15640013, 15637949, 15639824, 15639658, 15639659, 15639660,
                                         15640006, 15639684, 15639828, 15639662, 15639744, 15639759, 15640133, 15640121, 15640035, 15640036, 15639794, 15639724,
                                         15640123, 15639730, 15639956, 15637526, 15639669, 15637933, 15637894, 15638164, 15639787, 15637784, 15637787, 15637788,
                                         15639695, 15637984, 15637528, 15637752, 15637754, 15637755, 15639680, 15637659, 15637808, 15637738, 15639689, 15637991,
                                         15637792, 15637793, 15637759, 15637794, 15637706, 15637736, 15637737, 15637955, 15637533, 15638192, 15638167, 15637786,
                                         15637718, 15637691, 15637720, 15637930, 15638135, 15637838, 15637960, 15637914, 15637722, 15637547, 15637563, 15637766,
                                         15637767, 15637791, 15637594, 15637620, 15637970, 15639779, 15637779, 15637895, 15637840, 15637904, 15637851, 15637907,
                                         15637709, 15638236, 15637630, 15638129, 15638127, 15637800, 15637908, 15637619, 15637889, 15637945, 15637946, 15638134,
                                         15638230, 15637753, 15637741, 15637988, 15637989, 15637837, 15637801, 15637807, 15637765, 15637868, 15637953, 15638191,
                                         15639782, 15637992, 15639715, 15637954, 15639643, 15637920, 15639638, 15639670, 15639767, 15638116, 15637698, 15639672,
                                         15639676, 15637874, 15637875, 15638246, 15638247, 15638248, 15637885, 15637994, 15637701, 15639742, 15637950, 15637687,
                                         15639711, 15637647, 15637648, 15637649, 15637650, 15637909, 15637910, 15637911, 15637912, 15637913, 15637882, 15638237,
                                         15639652, 15637939, 15637940, 15637938, 15639830, 15637764, 15639712, 15639722, 15639795, 15637500, 15639735, 15639611,
                                         15639625, 15639671, 15639829, 15639832, 15639725, 15640129, 15639633, 15640131, 15639743, 15639958, 15639995, 15639700,
                                         15637637, 15637638, 15637888, 15637823, 15639626, 15639681, 15637607, 15639693, 15637506, 15639811, 15637876, 15640122,
                                         15638133, 15637776, 15639704, 15637892, 15639623, 15639624, 15637977, 15640147, 15638198, 15639826, 15637893, 15637640,
                                         15637713, 15637744, 15639612, 15639797, 15639798, 15639799, 15639800, 15639801, 15639802, 15640009, 15637730, 15637693,
                                         15637694, 15637695, 15637995, 15637996, 15637997, 15637998, 15637999, 15638001, 15638002, 15639664, 15646585, 15639707,
                                         15637673, 15638194, 15639954, 15639955, 15639946, 15639749, 15639780, 15639789, 15639790, 15639791, 15639792, 15639988,
                                         15639796, 15638173, 15638174, 15638175, 15638176, 15638177, 15639713, 15638235, 15638231, 15638232, 15638233, 15638234,
                                         15637956, 15637872, 15637873, 15637575, 15637576, 15637577, 15637993, 15638159, 15637890, 15637891, 15637903, 15637790,
                                         15637571, 15637809, 15637810, 15637811, 15637812, 15637813, 15637814, 15637815, 15637816, 15637817, 15637818, 15637819,
                                         15637820, 15637821, 15638238, 15638239, 15638240, 15638242, 15638243, 15638244, 15638245, 15638469, 15638226, 15637858,
                                         15637859, 15637860, 15637861, 15637862, 15637863, 15637770, 15637798, 15638050, 15637757, 15637716, 15637948, 15637734,
                                         15637852, 15637853, 15637854, 15637855, 15637856, 15637857, 15637847, 15637976, 15637524, 15637525, 15638189, 15637715,
                                         15637535, 15637661, 15637704, 15638128, 15639648, 15639714, 15637747, 15637696, 15637527, 15637618, 15637532, 15638154,
                                         15639705, 15639751, 15639785, 15637639, 15639642, 15637615, 15637723, 15640015, 15639645, 15639646, 15639694, 15639860,
                                         15639632, 15639727, 15639666, 15639690, 15638367, 15639641, 15637850, 15639788, 15639720, 15639703, 15637934, 15638000,
                                         15637733, 15639750, 15637870, 15639644, 15639706, 15640004, 15637562, 15637841, 15639996, 15638085, 15637608, 15637609,
                                         15637610, 15637514, 15637515, 15637516, 15637517, 15637518, 15637839, 15637666, 15639805, 15639806, 15639807, 15640092,
                                         15638182, 15638183, 15638184, 15638185, 15637632, 15637633, 15639650, 15638172, 15637605, 15637606, 15637902, 15639775,
                                         15639781, 15639808, 15639809, 15639810, 15639812, 15639813, 15639814, 15639815, 15639816, 15639817, 15639818, 15639819,
                                         15639820, 15639821, 15639822, 15640014, 15639661, 15639663, 15639745, 15639760, 15640134, 15637789, 15639617, 15639957,
                                         15637692, 15637626, 15637665, 15637952, 15638136, 15637750, 15637612, 15637613, 15637634, 15637534, 15637585, 15637530,
                                         15637900, 15637587, 15637588, 15637564, 15637672, 15637943, 15637944, 15637544, 15637928, 15637929, 15637926, 15638156,
                                         15637501, 15637540, 15637597, 15637749, 15638218, 15637541, 15637542, 15637543, 15637932, 15637599, 15637785, 15637865,
                                         15637866, 15637742, 15637602, 15637584, 15637719, 15637586, 15637884, 15637674, 15639685, 15639687, 15637622, 15640126,
                                         15638249, 15638250, 15638251, 15637898, 15637899, 15637529, 15637978, 15637502, 15637579, 15637591, 15637596, 15637688,
                                         15637942, 15637593, 15637550, 15637568, 15637806, 15640007, 15637560, 15637561, 15637937, 15637981, 15639825, 15637735,
                                         15637508, 15637710, 15637601, 15637658, 15637590, 15637573, 15637623, 15637689, 15637551, 15637690, 15637896, 15637545,
                                         15637538, 15638203, 15638204, 15637569, 15637669, 15637671, 15637572, 15637539, 15637604, 15637683, 15637664, 15637758,
                                         15637520, 15637583, 15637574, 15637552, 15637581, 15638170, 15638171, 15637531, 15637553, 15640120, 15640128, 15637570,
                                         15639719, 15637536, 15639761, 15637505, 15639636, 15639708, 15639733, 15639755, 15639756, 15639762, 15639765, 15639769,
                                         15639770, 15639776, 15639784, 15639834, 15639836, 15639839, 15639840, 15639842, 15639844, 15639846, 15639849, 15639850,
                                         15639852, 15639854, 15639856, 15639859, 15639862, 15639863, 15639865, 15639867, 15639870, 15639871, 15639874, 15639875,
                                         15639878, 15639879, 15639881, 15639884, 15639886, 15639888, 15639890, 15639891, 15639893, 15639895, 15639898, 15639900,
                                         15639901, 15639904, 15639905, 15639908, 15639911, 15639913, 15639915, 15639917, 15639919, 15639921, 15639923, 15639925,
                                         15639926, 15639928, 15639930, 15639932, 15639998, 15640001, 15640011, 15640039, 15640048, 15640050, 15640091, 15640093,
                                         15640096, 15640097, 15638197, 15639827, 15639683, 15637631, 15637592, 15637624, 15637625, 15637629, 15637621, 15637822,
                                         15637708, 15637627, 15637628, 15640130, 15639686, 15639688, 15639710, 15637979, 15637662, 15637927, 15639647, 15637582,
                                         15637727, 15637728, 15637883, 15637773, 15637774, 15637775, 15638190, 15638165, 15640008, 15637705, 15638555, 15638556,
                                         15638169, 15637880, 15637878, 15637879, 15639691, 15640124, 15640132, 15637699, 15639673, 15639674, 15639677, 15639678,
                                         15639729, 15637499, 15637503, 15637504, 15637510, 15637511, 15637548, 15637549, 15637566, 15637567, 15637578, 15637580,
                                         15637589, 15637595, 15637598, 15637600, 15637603, 15637611, 15637614, 15637616, 15637617, 15637657, 15637660, 15637667,
                                         15637668, 15637670, 15637680, 15637685, 15637724, 15637739, 15637745, 15637751, 15637768, 15637772, 15637778, 15637780,
                                         15637781, 15637782, 15637795, 15637796, 15637803, 15637836, 15637846, 15637864, 15637867, 15637871, 15637951, 15637957,
                                         15637958, 15637959, 15637961, 15637962, 15637965, 15637966, 15637967, 15637969, 15637971, 15637974, 15637975, 15637990,
                                         15638126, 15638130, 15638131, 15638132, 15638138, 15638139, 15638140, 15638141, 15638142, 15638143, 15638144, 15638145,
                                         15638146, 15638147, 15638148, 15638149, 15638150, 15638151, 15638152, 15638153, 15638155, 15638157, 15638158, 15638161,
                                         15638162, 15638163, 15638166, 15638168, 15638219, 15638220, 15638221, 15638222, 15638223, 15638225, 15638229, 15638252,
                                         15638253, 15638557, 15638830, 15638831, 15638832, 15638833, 15638834, 15638835, 15638836, 15638840, 15638844, 15638845,
                                         15638853, 15638873, 15638956, 15638957, 15638974, 15638997, 15638998, 15638999, 15639021, 15639031, 15639032, 15639033,
                                         15639038, 15639057, 15639089, 15639269, 15639298, 15639364, 15639402, 15639405, 15639407, 15639420, 15639456, 15639457,
                                         15639505, 15639517, 15639575, 15639968, 15640021, 15640022, 15640052, 15640056, 15640080, 15640084, 15646740)';

BEGIN		

	DBMS_OUTPUT.PUT_LINE('[INICIO]');
    DBMS_OUTPUT.PUT_LINE('[INFO] MODIFICAMOS CUENTAS PARTIDAS GASTOS ');

    V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.GLD_GASTOS_LINEA_DETALLE T1 USING (
            
            SELECT distinct GLD.GLD_ID,ctas.ccc_cuenta_contable AS CCC_BASE

            FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV
            JOIN '||V_ESQUEMA||'.gld_gastos_linea_detalle GLD ON GLD.GPV_ID=GPV.GPV_ID AND GLD.BORRADO = 0
            JOIN '||V_ESQUEMA||'.gic_gastos_info_contabilidad GIC ON gic.gpv_id=GPV.GPV_ID
            JOIN '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID=GPV.PRO_ID AND PRO.BORRADO = 0
            JOIN '||V_ESQUEMA||'.gld_ent GLENT ON GLENT.GLD_ID=GLD.GLD_ID AND glent.dd_ent_id=1 AND GLENT.BORRADO = 0 
            JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID=glent.ent_id AND ACT.BORRADO = 0

            JOIN '||V_ESQUEMA||'.act_config_ctas_contables CTAS ON CTAS.PRO_ID=GPV.PRO_ID 
            AND CTAS.BORRADO = 0 AND CTAS.DD_STG_ID=GLD.DD_STG_ID AND gic.eje_id=CTAS.EJE_ID 
            AND CTAS.DD_SCR_ID=ACT.DD_SCR_ID and ctas.dd_tim_id=1
            WHERE GPV.BORRADO = 0 AND '||V_CONDICION||') T2
        ON (T1.GLD_ID = T2.GLD_ID)
        WHEN MATCHED THEN UPDATE SET
        T1.GLD_CCC_BASE =T2.CCC_BASE,
        T1.USUARIOMODIFICAR = '''||V_USU||''',
        T1.FECHAMODIFICAR = SYSDATE';
    EXECUTE IMMEDIATE V_MSQL;

    DBMS_OUTPUT.PUT_LINE('[INFO] ASIGNADA CUENTA CONTABLE EN '|| SQL%ROWCOUNT ||' REGISTROS');

    V_MSQL:= 'MERGE INTO '||V_ESQUEMA||'.GLD_GASTOS_LINEA_DETALLE T1 USING (
            
            SELECT distinct GPV.GPV_NUM_GASTO_HAYA,GLD.GLD_ID,ctas.CPP_PARTIDA_PRESUPUESTARIA AS CPP_BASE

                FROM '||V_ESQUEMA||'.GPV_GASTOS_PROVEEDOR GPV
                JOIN '||V_ESQUEMA||'.gld_gastos_linea_detalle GLD ON GLD.GPV_ID=GPV.GPV_ID AND GLD.BORRADO = 0
                JOIN '||V_ESQUEMA||'.gic_gastos_info_contabilidad GIC ON gic.gpv_id=GPV.GPV_ID
                JOIN '||V_ESQUEMA||'.ACT_PRO_PROPIETARIO PRO ON PRO.PRO_ID=GPV.PRO_ID AND PRO.BORRADO = 0
                JOIN '||V_ESQUEMA||'.gld_ent GLENT ON GLENT.GLD_ID=GLD.GLD_ID AND glent.dd_ent_id=1 AND GLENT.BORRADO = 0 
                JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID=glent.ent_id AND ACT.BORRADO = 0
                JOIN '||V_ESQUEMA||'.act_config_ptdas_prep CTAS ON CTAS.PRO_ID=GPV.PRO_ID 
                AND CTAS.BORRADO = 0 AND CTAS.DD_STG_ID=GLD.DD_STG_ID AND gic.eje_id=CTAS.EJE_ID 
                AND CTAS.DD_SCR_ID=ACT.DD_SCR_ID and ctas.dd_tim_id=1
                WHERE GPV.BORRADO = 0 AND '||V_CONDICION||') T2
        ON (T1.GLD_ID = T2.GLD_ID)
        WHEN MATCHED THEN UPDATE SET
        T1.GLD_CPP_BASE =T2.CPP_BASE,
        T1.USUARIOMODIFICAR = '''||V_USU||''',
        T1.FECHAMODIFICAR = SYSDATE';
    EXECUTE IMMEDIATE V_MSQL;

    DBMS_OUTPUT.PUT_LINE('[INFO] ASIGNADA PARTIDA PRESUPUESTARIA EN '|| SQL%ROWCOUNT ||' REGISTROS');

    COMMIT;

    DBMS_OUTPUT.PUT_LINE('[FIN]');


EXCEPTION
		WHEN OTHERS THEN
			err_num := SQLCODE;
			err_msg := SQLERRM;

			DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
			DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
			DBMS_OUTPUT.put_line(err_msg);

			ROLLBACK;
			RAISE;          

END;

/

EXIT