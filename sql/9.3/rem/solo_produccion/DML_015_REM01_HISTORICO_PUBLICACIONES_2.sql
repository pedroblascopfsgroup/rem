--/*
--#########################################
--## AUTOR=Carles Molins
--## FECHA_CREACION=20190703
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.2
--## INCIDENCIA_LINK=REMVIP-4701
--## PRODUCTO=NO
--## 
--## Finalidad: [REMVIP-4701] Cambios en el histórico de publicaciones 2.0
--##
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial (solo Bankia) - REMVIP-4407
--##		0.2 Resto de carteras - REMVIP-4701
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema.
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master.
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.

    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar.
	V_TABLA VARCHAR2(30 CHAR):= 'ACT_AHP_HIST_PUBLICACION'; --Vble. para la tabla histórica.
	V_USUARIO VARCHAR2(40 CHAR) := 'REMVIP-4701'; --Vble. para el usuario REMVIP.
	V_NUM NUMBER(16); -- Vble. para validar la existencia de una tabla.

BEGIN

	DBMS_OUTPUT.put_line('[INICIO]');
	DBMS_OUTPUT.put_line('[INFO] Creación de las tablas auxiliares');

	V_MSQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''ACT_REG_BORRADOS'' AND OWNER = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO V_NUM;
	
	IF V_NUM > 0 THEN
		V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.ACT_REG_BORRADOS';
		EXECUTE IMMEDIATE V_MSQL;
	END IF;

	V_MSQL := 'CREATE TABLE '||V_ESQUEMA||'.ACT_REG_BORRADOS
				(
					ACT_ID NUMBER(16,0) NOT NULL
				)';
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO]	1.Tabla '||V_ESQUEMA||'.ACT_REG_BORRADOS creada');

	V_MSQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''MIGRACION_PUBLICACIONES'' AND OWNER = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO V_NUM;
	
	IF V_NUM > 0 THEN
		V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.MIGRACION_PUBLICACIONES';
		EXECUTE IMMEDIATE V_MSQL;
	END IF;

	V_MSQL := 'CREATE TABLE '||V_ESQUEMA||'.MIGRACION_PUBLICACIONES
				(
					ACT_ID NUMBER(16,0) NOT NULL,
					DD_TCO_ID NUMBER(16,0) NOT NULL,
					ESTADO NUMBER(16,0) NOT NULL,
					MOTIVO NUMBER(16,0),
					FECHA_DESDE DATE,
					FECHA_HASTA DATE
				)';
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO]	2.Tabla '||V_ESQUEMA||'.MIGRACION_PUBLICACIONES creada');

	V_MSQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''AHP_CONT_PUNTO2'' AND OWNER = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO V_NUM;
	
	IF V_NUM > 0 THEN
		V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.AHP_CONT_PUNTO2';
		EXECUTE IMMEDIATE V_MSQL;
	END IF;

	V_MSQL := 'CREATE TABLE '||V_ESQUEMA||'.AHP_CONT_PUNTO2
				(
					ACT_ID NUMBER(16,0) NOT NULL,
					ID_MENOR NUMBER(16,0) NOT NULL,
					FECHA_INI_MENOR DATE,
					ID_MAYOR NUMBER(16,0) NOT NULL,
					FECHA_INI_MAYOR DATE,
					FECHA_FIN DATE,
					BORRAR_MAYOR NUMBER(1,0) NOT NULL
				)';
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO]	3.Tabla '||V_ESQUEMA||'.AHP_CONT_PUNTO2 creada');

	V_MSQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''AHP_REPETIDOS'' AND OWNER = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO V_NUM;
	
	IF V_NUM > 0 THEN
		V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.AHP_REPETIDOS';
		EXECUTE IMMEDIATE V_MSQL;
	END IF;

	V_MSQL := 'CREATE TABLE '||V_ESQUEMA||'.AHP_REPETIDOS
				(
					ACT_ID NUMBER(16,0) NOT NULL,
					ID_MENOR NUMBER(16,0) NOT NULL,
					ID_MAYOR NUMBER(16,0) NOT NULL,
					FECHA_FIN_MAYOR DATE
				)';
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO]	4.Tabla '||V_ESQUEMA||'.AHP_REPETIDOS creada');

	V_MSQL := 'SELECT COUNT(1) FROM ALL_TABLES WHERE TABLE_NAME = ''AHP_INI_FIN'' AND OWNER = '''||V_ESQUEMA||'''';
	EXECUTE IMMEDIATE V_MSQL INTO V_NUM;
	
	IF V_NUM > 0 THEN
		V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.AHP_INI_FIN';
		EXECUTE IMMEDIATE V_MSQL;
	END IF;

	V_MSQL := 'CREATE TABLE '||V_ESQUEMA||'.AHP_INI_FIN
				(
					ACT_ID NUMBER(16,0) NOT NULL,
					ID_MENOR NUMBER(16,0) NOT NULL,
					ID_MAYOR NUMBER(16,0) NOT NULL,
					ID_VIVO NUMBER(16,0) NOT NULL,
					ESTADO_CORRECTO NUMBER(1,0) NOT NULL
				)';
	EXECUTE IMMEDIATE V_MSQL;
	DBMS_OUTPUT.PUT_LINE('[INFO]	5.Tabla '||V_ESQUEMA||'.AHP_INI_FIN creada');

/************************************************************************************************************************************************************************ PASO 1 *****/

	DBMS_OUTPUT.put_line('[INFO] Inicio del PASO 1');

/***** FECHA INI Y FECHA FIN IGUALES VENTA *****/

	V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.AHP_INI_FIN
				SELECT ACT_ID, MENOR, MAYOR, VIVO, ESTADO_CORRECTO FROM (
					SELECT DISTINCT H1.ACT_ID, H1.AHP_ID AS MENOR, H2.AHP_ID AS MAYOR, H3.AHP_ID AS VIVO,
						CASE 
							WHEN H3.DD_EPV_ID = APU.DD_EPV_ID THEN
								CASE
								    WHEN H3.DD_EPV_ID = 4 THEN
								        CASE
								            WHEN H3.DD_MTO_V_ID = APU.DD_MTO_V_ID THEN 1
								            ELSE 0
								        END
								    ELSE 1
								END
							ELSE 0
						END AS ESTADO_CORRECTO,
						ROW_NUMBER() OVER (PARTITION BY H1.AHP_ID ORDER BY H2.AHP_ID ASC) RN
					FROM '||V_ESQUEMA||'.'||V_TABLA||' H1
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H2 ON H1.ACT_ID = H2.ACT_ID AND H1.AHP_ID < H2.AHP_ID
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H3 ON H1.ACT_ID = H3.ACT_ID AND H1.AHP_ID <> H3.AHP_ID AND H2.AHP_ID <> H3.AHP_ID AND (H3.AHP_FECHA_INI_VENTA IS NOT NULL AND H3.AHP_FECHA_FIN_VENTA IS NULL)
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = H1.ACT_ID AND DD_CRA_ID <> 21 AND ACT.BORRADO = 0
					JOIN '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION APU ON APU.ACT_ID = ACT.ACT_ID
					WHERE TO_DATE(H1.AHP_FECHA_INI_VENTA,''DD/MM/YY'') = TO_DATE(H2.AHP_FECHA_INI_VENTA,''DD/MM/YY'')
					AND TO_DATE(H1.AHP_FECHA_FIN_VENTA,''DD/MM/YY'') = TO_DATE(H2.AHP_FECHA_FIN_VENTA,''DD/MM/YY'')
					AND TO_DATE(H1.AHP_FECHA_INI_VENTA,''DD/MM/YY'') <> TO_DATE(H1.AHP_FECHA_FIN_VENTA,''DD/MM/YY'')
					AND H1.BORRADO = 0 AND H2.BORRADO = 0 AND H3.BORRADO = 0
				) WHERE RN = 1';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT ID_MAYOR, HIS.AHP_FECHA_FIN_VENTA FROM '||V_ESQUEMA||'.AHP_INI_FIN AUX
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' HIS ON AUX.ID_MENOR = HIS.AHP_ID
					WHERE AUX.ESTADO_CORRECTO = 1
				) T2
				ON (T1.AHP_ID = T2.ID_MAYOR)
				WHEN MATCHED THEN UPDATE SET
					T1.AHP_FECHA_INI_VENTA = AHP_FECHA_FIN_VENTA
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT AUX.ACT_ID, HIS.AHP_ID FROM '||V_ESQUEMA||'.AHP_INI_FIN AUX
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' HIS ON HIS.AHP_ID = AUX.ID_VIVO
					JOIN '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION APU ON APU.ACT_ID = AUX.ACT_ID
					WHERE AUX.ESTADO_CORRECTO = 0 AND HIS.DD_EPV_ID = 3 AND APU.DD_EPV_ID = 1
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT H2.AHP_ID, H1.AHP_FECHA_FIN_VENTA
					FROM '||V_ESQUEMA||'.AHP_INI_FIN AUX
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H1 ON H1.AHP_ID = AUX.ID_MENOR AND H1.DD_EPV_ID = 4
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H2 ON H2.AHP_ID = AUX.ID_MAYOR AND H2.DD_EPV_ID = 1
					WHERE ESTADO_CORRECTO = 0
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.AHP_FECHA_INI_VENTA = AHP_FECHA_FIN_VENTA
					,T1.AHP_FECHA_FIN_VENTA = NULL
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION T1
				USING (
					SELECT AUX.ACT_ID, H2.AHP_FECHA_INI_VENTA
					FROM '||V_ESQUEMA||'.AHP_INI_FIN AUX
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H1 ON H1.AHP_ID = AUX.ID_MENOR AND H1.DD_EPV_ID = 4
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H2 ON H2.AHP_ID = AUX.ID_MAYOR AND H2.DD_EPV_ID = 1
					WHERE ESTADO_CORRECTO = 0
				) T2
				ON (T1.ACT_ID = T2.ACT_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.APU_FECHA_INI_VENTA = AHP_FECHA_INI_VENTA
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

/***** FECHA INI Y FECHA FIN IGUALES ALQUILER *****/

	V_MSQL := 'TRUNCATE TABLE '||V_ESQUEMA||'.AHP_INI_FIN';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.AHP_INI_FIN
				SELECT ACT_ID, MENOR, MAYOR, VIVO, ESTADO_CORRECTO FROM (
					SELECT DISTINCT H1.ACT_ID, H1.AHP_ID AS MENOR, H2.AHP_ID AS MAYOR, H3.AHP_ID AS VIVO,
						CASE 
						    WHEN H3.DD_EPA_ID = APU.DD_EPA_ID THEN
						        CASE
						            WHEN H3.DD_EPA_ID = 4 THEN
						                CASE
						                    WHEN H3.DD_MTO_A_ID = APU.DD_MTO_A_ID THEN 1
						                    ELSE 0
						                END
						            ELSE 1
						        END
						    ELSE 0
						END AS ESTADO_CORRECTO,
						ROW_NUMBER() OVER (PARTITION BY H1.AHP_ID ORDER BY H2.AHP_ID ASC) RN
					FROM '||V_ESQUEMA||'.'||V_TABLA||' H1
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H2 ON H1.ACT_ID = H2.ACT_ID AND H1.AHP_ID < H2.AHP_ID
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H3 ON H1.ACT_ID = H3.ACT_ID AND H1.AHP_ID <> H3.AHP_ID AND H2.AHP_ID <> H3.AHP_ID AND (H3.AHP_FECHA_INI_ALQUILER IS NOT NULL AND H3.AHP_FECHA_FIN_ALQUILER IS NULL)
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = H1.ACT_ID AND DD_CRA_ID <> 21 AND ACT.BORRADO = 0
					JOIN '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION APU ON APU.ACT_ID = ACT.ACT_ID
					WHERE TO_DATE(H1.AHP_FECHA_INI_ALQUILER,''DD/MM/YY'') = TO_DATE(H2.AHP_FECHA_INI_ALQUILER,''DD/MM/YY'')
					AND TO_DATE(H1.AHP_FECHA_FIN_ALQUILER,''DD/MM/YY'') = TO_DATE(H2.AHP_FECHA_FIN_ALQUILER,''DD/MM/YY'')
					AND TO_DATE(H1.AHP_FECHA_INI_ALQUILER,''DD/MM/YY'') <> TO_DATE(H1.AHP_FECHA_FIN_ALQUILER,''DD/MM/YY'')
					AND H1.BORRADO = 0 AND H2.BORRADO = 0 AND H3.BORRADO = 0
				) WHERE RN = 1';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT ID_MAYOR, HIS.AHP_FECHA_FIN_ALQUILER FROM '||V_ESQUEMA||'.AHP_INI_FIN AUX
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' HIS ON AUX.ID_MENOR = HIS.AHP_ID
					WHERE AUX.ESTADO_CORRECTO = 1
				) T2
				ON (T1.AHP_ID = T2.ID_MAYOR)
				WHEN MATCHED THEN UPDATE SET
					T1.AHP_FECHA_INI_ALQUILER = AHP_FECHA_FIN_ALQUILER
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT AUX.ACT_ID, HIS.AHP_ID FROM '||V_ESQUEMA||'.AHP_INI_FIN AUX
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' HIS ON HIS.AHP_ID = AUX.ID_VIVO
					JOIN '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION APU ON APU.ACT_ID = AUX.ACT_ID
					WHERE AUX.ESTADO_CORRECTO = 0 AND HIS.DD_EPV_ID = 3 AND APU.DD_EPV_ID = 1
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT H2.AHP_ID, H1.AHP_FECHA_FIN_ALQUILER
					FROM '||V_ESQUEMA||'.AHP_INI_FIN AUX
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H1 ON H1.AHP_ID = AUX.ID_MENOR AND H1.DD_EPV_ID = 4
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H2 ON H2.AHP_ID = AUX.ID_MAYOR AND H2.DD_EPV_ID = 1
					WHERE ESTADO_CORRECTO = 0
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.AHP_FECHA_INI_ALQUILER = AHP_FECHA_FIN_ALQUILER
					,T1.AHP_FECHA_FIN_ALQUILER = NULL
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.ACT_APU_ACTIVO_PUBLICACION T1
				USING (
					SELECT AUX.ACT_ID, H2.AHP_FECHA_INI_ALQUILER
					FROM '||V_ESQUEMA||'.AHP_INI_FIN AUX
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H1 ON H1.AHP_ID = AUX.ID_MENOR AND H1.DD_EPV_ID = 4
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H2 ON H2.AHP_ID = AUX.ID_MAYOR AND H2.DD_EPV_ID = 1
					WHERE ESTADO_CORRECTO = 0
				) T2
				ON (T1.ACT_ID = T2.ACT_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.APU_FECHA_INI_ALQUILER = AHP_FECHA_INI_ALQUILER
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

/************************************************************************************************************************************************************************ PASO 2 *****/

	DBMS_OUTPUT.put_line('[INFO] Inicio del PASO 2');

/***** REMIGRAR REGISTROS HEP PARA ACTIVOS CON CONTENIDOS VENTA *****/

	V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_REG_BORRADOS
				SELECT DISTINCT AHP.ACT_ID
				FROM (SELECT * FROM  '||V_ESQUEMA||'.'||V_TABLA||'  WHERE BORRADO = 0) AHP
				LEFT JOIN (SELECT * FROM  '||V_ESQUEMA||'.'||V_TABLA||' WHERE BORRADO = 0) AHP2 
				ON AHP.ACT_ID = AHP2.ACT_ID AND TO_DATE(AHP2.AHP_FECHA_INI_VENTA,''DD/MM/YY'') BETWEEN TO_DATE(AHP.AHP_FECHA_INI_VENTA+1,''DD/MM/YY'') and TO_DATE(AHP.AHP_FECHA_FIN_VENTA-1,''DD/MM/YY'') AND AHP.AHP_ID <> AHP2.AHP_ID
				INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT
				ON ACT.ACT_ID = AHP.ACT_ID AND DD_CRA_ID <> 21
				WHERE AHP2.ACT_ID IS NOT NULL';
	EXECUTE IMMEDIATE V_MSQL;
    
	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT DISTINCT AHP_ID FROM '||V_ESQUEMA||'.ACT_REG_BORRADOS ACT
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' AHP ON ACT.ACT_ID = AHP.ACT_ID AND AHP.BORRADO = 0
					WHERE AHP.AHP_FECHA_FIN_VENTA IS NOT NULL AND TO_DATE(AHP.AHP_FECHA_FIN_VENTA,''DD/MM/YY'') < TO_DATE(''23/11/18'' ,''DD/MM/YY'')
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.MIGRACION_PUBLICACIONES
				SELECT DISTINCT ACT.ACT_ID, 1 AS DD_TCO_ID,
				CASE WHEN HEP.DD_EPU_ID = 5 OR HEP.DD_EPU_ID = 3 THEN 4
					 WHEN HEP.DD_EPU_ID = 6 THEN 1
					 ELSE 3
				END ESTADO,
				NULL AS MOTIVO,
				HEP.HEP_FECHA_DESDE,
				HEP.HEP_FECHA_HASTA
				FROM '||V_ESQUEMA||'.ACT_REG_BORRADOS ACT
				JOIN '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION HEP ON HEP.ACT_ID = ACT.ACT_ID AND HEP.BORRADO = 0 AND HEP.HEP_FECHA_HASTA IS NOT NULL';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (
					AHP_ID
					,ACT_ID
					,DD_EPV_ID
					,DD_EPA_ID
					,DD_TCO_ID
					,DD_MTO_V_ID
					,AHP_CHECK_PUBLICAR_V
					,AHP_CHECK_OCULTAR_V
					,AHP_CHECK_OCULTAR_PRECIO_V
					,AHP_CHECK_PUB_SIN_PRECIO_V
					,AHP_CHECK_PUBLICAR_A
					,AHP_CHECK_OCULTAR_A
					,AHP_CHECK_OCULTAR_PRECIO_A
					,AHP_CHECK_PUB_SIN_PRECIO_A
					,AHP_FECHA_INI_VENTA
					,AHP_FECHA_FIN_VENTA
					,VERSION
					,USUARIOCREAR
					,FECHACREAR
					,BORRADO
					,ES_CONDICONADO_ANTERIOR
				)
				SELECT '||V_ESQUEMA||'.S_ACT_AHP_HIST_PUBLICACION.NEXTVAL
					,ACT_ID
					,ESTADO
					,CASE WHEN DD_TCO_ID = 2 THEN ESTADO
						  ELSE 1
					 END
					,DD_TCO_ID
					,MOTIVO
					,CASE WHEN ESTADO <> 1 THEN 1
						  ELSE 0
					 END
					,CASE WHEN ESTADO = 4 THEN 1
						  ELSE 0
					 END
					,0,0,0,0,0,0
					,FECHA_DESDE
					,FECHA_HASTA
					,0
					,'''||V_USUARIO||'''
					,SYSDATE
					,0
					,0
				FROM '||V_ESQUEMA||'.MIGRACION_PUBLICACIONES WHERE DD_TCO_ID IN (1,2)';
	EXECUTE IMMEDIATE V_MSQL;

/***** REMIGRAR REGISTROS HEP PARA ACTIVOS CON CONTENIDOS ALQUILER *****/

	V_MSQL := 'TRUNCATE TABLE '||V_ESQUEMA||'.ACT_REG_BORRADOS';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'TRUNCATE TABLE '||V_ESQUEMA||'.MIGRACION_PUBLICACIONES';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.ACT_REG_BORRADOS
				SELECT DISTINCT AHP.ACT_ID
				FROM (SELECT * FROM  '||V_ESQUEMA||'.'||V_TABLA||'  WHERE BORRADO = 0) AHP
				LEFT JOIN (SELECT * FROM  '||V_ESQUEMA||'.'||V_TABLA||' WHERE BORRADO = 0) AHP2 
				ON AHP.ACT_ID = AHP2.ACT_ID AND TO_DATE(AHP2.AHP_FECHA_INI_ALQUILER,''DD/MM/YY'') BETWEEN TO_DATE(AHP.AHP_FECHA_INI_ALQUILER+1,''DD/MM/YY'') and TO_DATE(AHP.AHP_FECHA_FIN_ALQUILER-1,''DD/MM/YY'') AND AHP.AHP_ID <> AHP2.AHP_ID
				INNER JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT
				ON ACT.ACT_ID = AHP.ACT_ID AND DD_CRA_ID <> 21
				WHERE AHP2.ACT_ID IS NOT NULL';
	EXECUTE IMMEDIATE V_MSQL;
    
	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT DISTINCT AHP_ID FROM '||V_ESQUEMA||'.ACT_REG_BORRADOS ACT
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' AHP ON ACT.ACT_ID = AHP.ACT_ID AND AHP.BORRADO = 0
					WHERE AHP.AHP_FECHA_FIN_ALQUILER IS NOT NULL AND TO_DATE(AHP.AHP_FECHA_FIN_ALQUILER,''DD/MM/YY'') < TO_DATE(''23/11/18'' ,''DD/MM/YY'')
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.MIGRACION_PUBLICACIONES
				SELECT DISTINCT ACT.ACT_ID, 3 AS DD_TCO_ID,
				CASE WHEN HEP.DD_EPU_ID = 5 OR HEP.DD_EPU_ID = 3 THEN 4
					 WHEN HEP.DD_EPU_ID = 6 THEN 1
					 ELSE 3
				END ESTADO,
				NULL AS MOTIVO,
				HEP.HEP_FECHA_DESDE,
				HEP.HEP_FECHA_HASTA
				FROM '||V_ESQUEMA||'.ACT_REG_BORRADOS ACT
				JOIN '||V_ESQUEMA||'.ACT_HEP_HIST_EST_PUBLICACION HEP ON HEP.ACT_ID = ACT.ACT_ID AND HEP.BORRADO = 0 AND HEP.HEP_FECHA_HASTA IS NOT NULL';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.'||V_TABLA||' (
					AHP_ID
					,ACT_ID
					,DD_EPV_ID
					,DD_EPA_ID
					,DD_TCO_ID
					,DD_MTO_V_ID
					,AHP_CHECK_PUBLICAR_V
					,AHP_CHECK_OCULTAR_V
					,AHP_CHECK_OCULTAR_PRECIO_V
					,AHP_CHECK_PUB_SIN_PRECIO_V
					,AHP_CHECK_PUBLICAR_A
					,AHP_CHECK_OCULTAR_A
					,AHP_CHECK_OCULTAR_PRECIO_A
					,AHP_CHECK_PUB_SIN_PRECIO_A
					,AHP_FECHA_INI_ALQUILER
					,AHP_FECHA_FIN_ALQUILER
					,VERSION
					,USUARIOCREAR
					,FECHACREAR
					,BORRADO
					,ES_CONDICONADO_ANTERIOR
				)
				SELECT '||V_ESQUEMA||'.S_ACT_AHP_HIST_PUBLICACION.NEXTVAL
					,ACT_ID
					,CASE WHEN DD_TCO_ID = 2 THEN ESTADO
						  ELSE 1
					 END
					,ESTADO
					,DD_TCO_ID
					,MOTIVO
					,CASE WHEN ESTADO <> 1 THEN 1
						  ELSE 0
					 END
					,CASE WHEN ESTADO = 4 THEN 1
						  ELSE 0
					 END
					,0,0,0,0,0,0
					,FECHA_DESDE
					,FECHA_HASTA
					,0
					,'''||V_USUARIO||'''
					,SYSDATE
					,0
					,0
				FROM '||V_ESQUEMA||'.MIGRACION_PUBLICACIONES WHERE DD_TCO_ID IN (2,3)';
	EXECUTE IMMEDIATE V_MSQL;

/************************************************************************************************************************************************************************ PASO 3 *****/

	DBMS_OUTPUT.put_line('[INFO] Inicio del PASO 3');

/***** CONTENIDOS MISMA FECHA FIN VENTA *****/

	V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.AHP_CONT_PUNTO2
				SELECT DISTINCT H1.ACT_ID, H1.AHP_ID AS ID_MENOR, H1.AHP_FECHA_INI_VENTA AS FECHA_INI_MENOR, H2.AHP_ID AS ID_MAYOR, H2.AHP_FECHA_INI_VENTA AS FECHA_INI_MAYOR, H1.AHP_FECHA_FIN_VENTA AS FECHA_FIN,
					CASE 
						WHEN H1.DD_EPV_ID = H2.DD_EPV_ID THEN
						    CASE
						        WHEN H1.DD_EPV_ID = 4 THEN 
						            CASE
						                WHEN H1.DD_MTO_V_ID = H2.DD_MTO_V_ID THEN 1
						                ELSE 0
						            END
						        ELSE 1
						    END
						ELSE 0
					END AS BORRAR_MAYOR
				FROM '||V_ESQUEMA||'.'||V_TABLA||' H1
				JOIN '||V_ESQUEMA||'.'||V_TABLA||' H2 ON H1.ACT_ID = H2.ACT_ID AND H1.AHP_ID <> H2.AHP_ID 
					AND TO_DATE(H1.AHP_FECHA_INI_VENTA,''DD/MM/YY'') < TO_DATE(H2.AHP_FECHA_INI_VENTA,''DD/MM/YY'')
					AND TO_DATE(H1.AHP_FECHA_INI_VENTA,''DD/MM/YY'') <> TO_DATE(H1.AHP_FECHA_FIN_VENTA,''DD/MM/YY'')
					AND TO_DATE(H2.AHP_FECHA_INI_VENTA,''DD/MM/YY'') <> TO_DATE(H2.AHP_FECHA_FIN_VENTA,''DD/MM/YY'')
					AND TO_DATE(H1.AHP_FECHA_FIN_VENTA,''DD/MM/YY'') = TO_DATE(H2.AHP_FECHA_FIN_VENTA,''DD/MM/YY'')
				JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = H1.ACT_ID AND DD_CRA_ID <> 21
				WHERE H1.AHP_FECHA_FIN_VENTA IS NOT NULL AND H1.BORRADO = 0
				AND H2.AHP_FECHA_FIN_VENTA IS NOT NULL AND H2.BORRADO = 0
				ORDER BY FECHA_FIN DESC';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT DISTINCT ID_MAYOR FROM '||V_ESQUEMA||'.AHP_CONT_PUNTO2 WHERE BORRAR_MAYOR = 1
				) T2
				ON (T1.AHP_ID = T2.ID_MAYOR)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT DISTINCT ID_MAYOR, TO_DATE(FECHA_FIN, ''DD/MM/YY'') AS FECHA_FIN FROM '||V_ESQUEMA||'.AHP_CONT_PUNTO2 WHERE BORRAR_MAYOR = 0
				) T2
				ON (T1.AHP_ID = T2.ID_MAYOR)
				WHEN MATCHED THEN UPDATE SET
					T1.AHP_FECHA_INI_VENTA = FECHA_FIN
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

/***** CONTENIDOS MISMA FECHA FIN ALQUILER *****/

	V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.AHP_CONT_PUNTO2
				SELECT DISTINCT H1.ACT_ID, H1.AHP_ID AS ID_MENOR, H1.AHP_FECHA_INI_ALQUILER AS FECHA_INI_MENOR, H2.AHP_ID AS ID_MAYOR, H2.AHP_FECHA_INI_ALQUILER AS FECHA_INI_MAYOR, H1.AHP_FECHA_FIN_ALQUILER AS FECHA_FIN,
					CASE 
						WHEN H1.DD_EPA_ID = H2.DD_EPA_ID THEN
						    CASE
						        WHEN H1.DD_EPA_ID = 4 THEN 
						            CASE
						                WHEN H1.DD_MTO_A_ID = H2.DD_MTO_A_ID THEN 1
						                ELSE 0
						            END
						        ELSE 1
						    END
						ELSE 0
					END AS BORRAR_MAYOR
				FROM '||V_ESQUEMA||'.'||V_TABLA||' H1
				JOIN '||V_ESQUEMA||'.'||V_TABLA||' H2 ON H1.ACT_ID = H2.ACT_ID AND H1.AHP_ID <> H2.AHP_ID 
					AND TO_DATE(H1.AHP_FECHA_INI_ALQUILER,''DD/MM/YY'') < TO_DATE(H2.AHP_FECHA_INI_ALQUILER,''DD/MM/YY'')
					AND TO_DATE(H1.AHP_FECHA_INI_ALQUILER,''DD/MM/YY'') <> TO_DATE(H1.AHP_FECHA_FIN_ALQUILER,''DD/MM/YY'')
					AND TO_DATE(H2.AHP_FECHA_INI_ALQUILER,''DD/MM/YY'') <> TO_DATE(H2.AHP_FECHA_FIN_ALQUILER,''DD/MM/YY'')
					AND TO_DATE(H1.AHP_FECHA_FIN_ALQUILER,''DD/MM/YY'') = TO_DATE(H2.AHP_FECHA_FIN_ALQUILER,''DD/MM/YY'')
				JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = H1.ACT_ID AND DD_CRA_ID <> 21
				WHERE H1.AHP_FECHA_FIN_ALQUILER IS NOT NULL AND H1.BORRADO = 0
				AND H2.AHP_FECHA_FIN_ALQUILER IS NOT NULL AND H2.BORRADO = 0
				ORDER BY FECHA_FIN DESC';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT DISTINCT ID_MAYOR FROM '||V_ESQUEMA||'.AHP_CONT_PUNTO2 WHERE BORRAR_MAYOR = 1
				) T2
				ON (T1.AHP_ID = T2.ID_MAYOR)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT DISTINCT ID_MAYOR, TO_DATE(FECHA_FIN, ''DD/MM/YY'') AS FECHA_FIN FROM '||V_ESQUEMA||'.AHP_CONT_PUNTO2 WHERE BORRAR_MAYOR = 0
				) T2
				ON (T1.AHP_ID = T2.ID_MAYOR)
				WHEN MATCHED THEN UPDATE SET
					T1.AHP_FECHA_INI_ALQUILER = FECHA_FIN
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

/************************************************************************************************************************************************************************ PASO 4 *****/

	DBMS_OUTPUT.put_line('[INFO] Inicio del PASO 4');

/***** MISMO INI DISTINTO FIN *****/

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT DISTINCT H1.ACT_ID, H1.AHP_ID, H2.AHP_ID AS AHP_ID_2, H1.AHP_FECHA_INI_VENTA, H1.AHP_FECHA_FIN_VENTA,  H2.AHP_FECHA_FIN_VENTA AS AHP_FECHA_FIN_VENTA_2
					FROM '||V_ESQUEMA||'.'||V_TABLA||' H1
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H2 ON H1.ACT_ID = H2.ACT_ID
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = H1.ACT_ID AND DD_CRA_ID <> 21 AND ACT.BORRADO = 0
					WHERE H1.AHP_ID <> H2.AHP_ID AND H1.BORRADO = 0 AND H2.BORRADO = 0
					AND TO_DATE(H1.AHP_FECHA_INI_VENTA,''DD/MM/YY'') = TO_DATE(H2.AHP_FECHA_INI_VENTA,''DD/MM/YY'')
					AND TO_DATE(H1.AHP_FECHA_INI_VENTA,''DD/MM/YY'') <> TO_DATE(H1.AHP_FECHA_FIN_VENTA,''DD/MM/YY'')
					AND TO_DATE(H2.AHP_FECHA_INI_VENTA,''DD/MM/YY'') <> TO_DATE(H2.AHP_FECHA_FIN_VENTA,''DD/MM/YY'')
					AND TO_DATE(H1.AHP_FECHA_FIN_VENTA,''DD/MM/YY'') < TO_DATE(H2.AHP_FECHA_FIN_VENTA,''DD/MM/YY'')
					AND H2.DD_EPV_ID = H1.DD_EPV_ID
					AND CASE WHEN H1.DD_EPV_ID = 4 THEN 
								 CASE WHEN H2.DD_MTO_V_ID = H1.DD_MTO_V_ID THEN 1
								      ELSE 0
								 END
							 ELSE 1
						END = 1
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT * FROM (
						SELECT DISTINCT H1.ACT_ID, H2.AHP_ID, TO_DATE(H1.AHP_FECHA_FIN_VENTA,''DD/MM/YY'') AS AHP_FECHA_FIN_VENTA,
						ROW_NUMBER() OVER (PARTITION BY H1.ACT_ID ORDER BY H1.AHP_FECHA_FIN_VENTA ASC) RN
						FROM '||V_ESQUEMA||'.'||V_TABLA||' H1
						JOIN '||V_ESQUEMA||'.'||V_TABLA||' H2 ON H1.ACT_ID = H2.ACT_ID
						JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = H1.ACT_ID AND DD_CRA_ID <> 21 AND ACT.BORRADO = 0
						WHERE H1.AHP_ID <> H2.AHP_ID AND H1.BORRADO = 0 AND H2.BORRADO = 0
						AND TO_DATE(H1.AHP_FECHA_INI_VENTA,''DD/MM/YY'') = TO_DATE(H2.AHP_FECHA_INI_VENTA,''DD/MM/YY'')
						AND TO_DATE(H1.AHP_FECHA_INI_VENTA,''DD/MM/YY'') <> TO_DATE(H1.AHP_FECHA_FIN_VENTA,''DD/MM/YY'')
						AND TO_DATE(H2.AHP_FECHA_INI_VENTA,''DD/MM/YY'') <> TO_DATE(H2.AHP_FECHA_FIN_VENTA,''DD/MM/YY'')
						AND TO_DATE(H1.AHP_FECHA_FIN_VENTA,''DD/MM/YY'') < TO_DATE(H2.AHP_FECHA_FIN_VENTA,''DD/MM/YY'')
						AND (H2.DD_EPV_ID <> H1.DD_EPV_ID
							OR CASE WHEN H1.DD_EPV_ID = 4 THEN 
										 CASE WHEN H2.DD_MTO_V_ID = H1.DD_MTO_V_ID THEN 1
										      ELSE 0
										 END
									 ELSE 1
								END = 0)
					) WHERE RN = 1
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.AHP_FECHA_INI_VENTA = AHP_FECHA_FIN_VENTA
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

/************************************************************************************************************************************************************************ PASO 5 *****/

	DBMS_OUTPUT.put_line('[INFO] Inicio del PASO 5');

/***** Fecha Migración – Fecha Hasta 1, Fecha Hasta 1 – Null, Fecha Desde 1 – Fecha Hasta 2 VENTA *****/

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT DISTINCT H1.AHP_ID
					FROM '||V_ESQUEMA||'.'||V_TABLA||' H1 --Fecha Migración – Fecha Hasta 1
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H2 ON H1.ACT_ID = H2.ACT_ID AND H1.AHP_ID <> H2.AHP_ID --Fecha Hasta 1 – Null
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H3 ON H1.ACT_ID = H3.ACT_ID AND H1.AHP_ID <> H3.AHP_ID AND H2.AHP_ID <> H3.AHP_ID --Fecha Desde 1 – Fecha Hasta 2
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = H1.ACT_ID AND DD_CRA_ID <> 21 AND ACT.BORRADO = 0
					WHERE H1.BORRADO = 0 AND H2.BORRADO = 0 AND H3.BORRADO = 0
					AND (TO_DATE(H1.AHP_FECHA_INI_VENTA,''DD/MM/YY'') BETWEEN TO_DATE(''21/11/18'',''DD/MM/YY'') AND TO_DATE(''23/11/18'',''DD/MM/YY''))
					AND TO_DATE(H1.AHP_FECHA_FIN_VENTA,''DD/MM/YY'') = TO_DATE(H2.AHP_FECHA_INI_VENTA,''DD/MM/YY'')
					AND H2.AHP_FECHA_FIN_VENTA IS NULL
					AND (TO_DATE(H3.AHP_FECHA_INI_VENTA,''DD/MM/YY'') BETWEEN TO_DATE(H1.AHP_FECHA_INI_VENTA,''DD/MM/YY'') AND TO_DATE(H1.AHP_FECHA_FIN_VENTA,''DD/MM/YY''))
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

/***** Fecha Migración – Fecha Hasta 1, Fecha Hasta 1 – Null, Fecha Desde 1 – Fecha Hasta 2 ALQUILER *****/

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT DISTINCT H1.AHP_ID
					FROM '||V_ESQUEMA||'.'||V_TABLA||' H1 --Fecha Migración – Fecha Hasta 1
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H2 ON H1.ACT_ID = H2.ACT_ID AND H1.AHP_ID <> H2.AHP_ID --Fecha Hasta 1 – Null
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' H3 ON H1.ACT_ID = H3.ACT_ID AND H1.AHP_ID <> H3.AHP_ID AND H2.AHP_ID <> H3.AHP_ID --Fecha Desde 1 – Fecha Hasta 2
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = H1.ACT_ID AND DD_CRA_ID <> 21 AND ACT.BORRADO = 0
					WHERE H1.BORRADO = 0 AND H2.BORRADO = 0 AND H3.BORRADO = 0
					AND (TO_DATE(H1.AHP_FECHA_INI_ALQUILER,''DD/MM/YY'') BETWEEN TO_DATE(''21/11/18'',''DD/MM/YY'') AND TO_DATE(''23/11/18'',''DD/MM/YY''))
					AND TO_DATE(H1.AHP_FECHA_FIN_ALQUILER,''DD/MM/YY'') = TO_DATE(H2.AHP_FECHA_INI_ALQUILER,''DD/MM/YY'')
					AND H2.AHP_FECHA_FIN_ALQUILER IS NULL
					AND (TO_DATE(H3.AHP_FECHA_INI_ALQUILER,''DD/MM/YY'') BETWEEN TO_DATE(H1.AHP_FECHA_INI_ALQUILER,''DD/MM/YY'') AND TO_DATE(H1.AHP_FECHA_FIN_ALQUILER,''DD/MM/YY''))
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

/************************************************************************************************************************************************************************ PASO 6 *****/

	DBMS_OUTPUT.put_line('[INFO] Inicio del PASO 6');

/***** ELIMINAR REPETIDOS VENTA *****/

	V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.AHP_REPETIDOS
				WITH HIST AS (
					SELECT DISTINCT AHP.AHP_ID, AHP.ACT_ID, AHP.AHP_FECHA_INI_VENTA, AHP.AHP_FECHA_FIN_VENTA, AHP.DD_EPV_ID, AHP.DD_MTO_V_ID,
					ROW_NUMBER() OVER (PARTITION BY AHP.ACT_ID ORDER BY AHP.AHP_FECHA_INI_VENTA, AHP.AHP_FECHA_FIN_VENTA ASC) RN
					FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
					WHERE ((AHP.AHP_FECHA_INI_VENTA IS NOT NULL OR AHP.AHP_FECHA_FIN_VENTA IS NOT NULL) AND DD_TCO_ID IN (1,2))
					AND AHP.BORRADO = 0
					ORDER BY 1,2,3,5
				)
				SELECT DISTINCT H.ACT_ID, H.AHP_ID, H2.AHP_ID AS AHP_ID_2, H2.AHP_FECHA_FIN_VENTA
				FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
				JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AHP.ACT_ID AND DD_CRA_ID <> 21 AND ACT.BORRADO = 0
				JOIN HIST H ON AHP.ACT_ID = H.ACT_ID
				JOIN HIST H2 ON AHP.ACT_ID = H2.ACT_ID AND H2.RN = H.RN+1
				WHERE AHP.DD_TCO_ID IN (1,2)
				AND H2.DD_EPV_ID = H.DD_EPV_ID
				AND CASE WHEN H.DD_EPV_ID = 4 THEN 
						     CASE WHEN H2.DD_MTO_V_ID = H.DD_MTO_V_ID THEN 1
						          ELSE 0
						     END
						 ELSE 1
					END = 1';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT ID_MENOR, FECHA_FIN_MAYOR FROM '||V_ESQUEMA||'.AHP_REPETIDOS
				) T2
				ON (T1.AHP_ID = T2.ID_MENOR)
				WHEN MATCHED THEN UPDATE SET
					T1.AHP_FECHA_FIN_VENTA = FECHA_FIN_MAYOR
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT ID_MAYOR FROM '||V_ESQUEMA||'.AHP_REPETIDOS
				) T2
				ON (T1.AHP_ID = T2.ID_MAYOR)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

/***** ELIMINAR REPETIDOS ALQUILER *****/

	V_MSQL := 'INSERT INTO '||V_ESQUEMA||'.AHP_REPETIDOS
				WITH HIST AS (
					SELECT DISTINCT AHP.AHP_ID, AHP.ACT_ID, AHP.AHP_FECHA_INI_ALQUILER, AHP.AHP_FECHA_FIN_ALQUILER, AHP.DD_EPA_ID, AHP.DD_MTO_A_ID,
					ROW_NUMBER() OVER (PARTITION BY AHP.ACT_ID ORDER BY AHP.AHP_FECHA_INI_ALQUILER, AHP.AHP_FECHA_FIN_ALQUILER ASC) RN
					FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
					WHERE ((AHP.AHP_FECHA_INI_ALQUILER IS NOT NULL OR AHP.AHP_FECHA_FIN_ALQUILER IS NOT NULL) AND DD_TCO_ID IN (2,3))
					AND AHP.BORRADO = 0
					ORDER BY 1,2,3,5
				)
				SELECT DISTINCT H.ACT_ID, H.AHP_ID, H2.AHP_ID AS AHP_ID_2, H2.AHP_FECHA_FIN_ALQUILER
				FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
				JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AHP.ACT_ID AND DD_CRA_ID <> 21 AND ACT.BORRADO = 0
				JOIN HIST H ON AHP.ACT_ID = H.ACT_ID
				JOIN HIST H2 ON AHP.ACT_ID = H2.ACT_ID AND H2.RN = H.RN+1
				WHERE AHP.DD_TCO_ID IN (2,3)
				AND H2.DD_EPA_ID = H.DD_EPA_ID
				AND CASE WHEN H.DD_EPA_ID = 4 THEN 
						     CASE WHEN H2.DD_MTO_A_ID = H.DD_MTO_A_ID THEN 1
						          ELSE 0
						     END
						 ELSE 1
					END = 1';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT ID_MENOR, FECHA_FIN_MAYOR FROM '||V_ESQUEMA||'.AHP_REPETIDOS
				) T2
				ON (T1.AHP_ID = T2.ID_MENOR)
				WHEN MATCHED THEN UPDATE SET
					T1.AHP_FECHA_FIN_ALQUILER = FECHA_FIN_MAYOR
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT ID_MAYOR FROM '||V_ESQUEMA||'.AHP_REPETIDOS
				) T2
				ON (T1.AHP_ID = T2.ID_MAYOR)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

/************************************************************************************************************************************************************************ PASO 7 *****/

	DBMS_OUTPUT.put_line('[INFO] Inicio del PASO 7');

/***** ELIMINAR DUPLICADOS VENTA *****/

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT DISTINCT AUX.AHP_ID
					FROM (
						SELECT AUX.AHP_ID, AUX.ACT_ID, AUX.DD_TCO_ID, DD_EPV_ID, DD_MTO_V_ID, TO_DATE(AHP_FECHA_INI_VENTA,''DD/MM/YY''), TO_DATE(AHP_FECHA_FIN_VENTA,''DD/MM/YY'')
							,ROW_NUMBER() OVER (PARTITION BY AUX.ACT_ID, AUX.DD_TCO_ID, DD_EPV_ID, DD_MTO_V_ID, TO_DATE(AHP_FECHA_INI_VENTA,''DD/MM/YY''), TO_DATE(AHP_FECHA_FIN_VENTA,''DD/MM/YY'') ORDER BY AUX.AHP_FECHA_INI_VENTA, AUX.AHP_FECHA_FIN_VENTA) AS ORDEN
						FROM '||V_ESQUEMA||'.'||V_TABLA||' AUX
						JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON AUX.ACT_ID = ACT.ACT_ID AND ACT.DD_CRA_ID <> 21 AND ACT.BORRADO = 0
						WHERE AUX.BORRADO = 0 AND AHP_FECHA_INI_VENTA IS NOT NULL AND AHP_FECHA_FIN_VENTA IS NOT NULL
					) AUX
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' AHP ON AHP.ACT_ID = AUX.ACT_ID
					WHERE ORDEN > 1
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;
    
/***** ELIMINAR DUPLICADOS ALQUILER *****/

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					SELECT DISTINCT AUX.AHP_ID
					FROM (
						SELECT AUX.AHP_ID, AUX.ACT_ID, AUX.DD_TCO_ID, DD_EPV_ID, DD_MTO_V_ID, TO_DATE(AHP_FECHA_INI_ALQUILER,''DD/MM/YY''), TO_DATE(AHP_FECHA_FIN_ALQUILER,''DD/MM/YY'')
							,ROW_NUMBER() OVER (PARTITION BY AUX.ACT_ID, AUX.DD_TCO_ID, DD_EPV_ID, DD_MTO_V_ID, TO_DATE(AHP_FECHA_INI_ALQUILER,''DD/MM/YY''), TO_DATE(AHP_FECHA_FIN_ALQUILER,''DD/MM/YY'') ORDER BY AUX.AHP_FECHA_INI_ALQUILER, AUX.AHP_FECHA_FIN_ALQUILER) AS ORDEN
						FROM '||V_ESQUEMA||'.'||V_TABLA||' AUX
						JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON AUX.ACT_ID = ACT.ACT_ID AND ACT.DD_CRA_ID <> 21 AND ACT.BORRADO = 0
						WHERE AUX.BORRADO = 0 AND AHP_FECHA_INI_ALQUILER IS NOT NULL AND AHP_FECHA_FIN_ALQUILER IS NOT NULL
					) AUX
					JOIN '||V_ESQUEMA||'.'||V_TABLA||' AHP ON AHP.ACT_ID = AUX.ACT_ID
					WHERE ORDEN > 1
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

/************************************************************************************************************************************************************************ PASO 8 *****/

	DBMS_OUTPUT.put_line('[INFO] Inicio del PASO 8');

/***** SOLUCIONAR CALVAS VENTA *****/

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					WITH HIST AS (
						SELECT DISTINCT AHP.ACT_ID, AHP.AHP_ID, AHP.AHP_FECHA_INI_VENTA, AHP.AHP_FECHA_FIN_VENTA,
						ROW_NUMBER() OVER (PARTITION BY AHP.ACT_ID ORDER BY AHP.AHP_FECHA_INI_VENTA, AHP.AHP_FECHA_FIN_VENTA ASC NULLS LAST) RN
						FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
						WHERE (AHP.AHP_FECHA_INI_VENTA IS NOT NULL AND DD_TCO_ID IN (1,2))
						AND AHP.BORRADO = 0
						ORDER BY 1,2,3,5
					)
					SELECT DISTINCT H.ACT_ID, H.AHP_ID, H.AHP_FECHA_INI_VENTA, H.AHP_FECHA_FIN_VENTA, H.RN, H2.AHP_FECHA_FIN_VENTA AS FECHA_INI_NUEVA
					FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
					JOIN HIST H ON AHP.ACT_ID = H.ACT_ID
					LEFT JOIN HIST H2 ON AHP.ACT_ID = H2.ACT_ID AND H2.RN = H.RN-1
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AHP.ACT_ID AND DD_CRA_ID <> 21 AND ACT.BORRADO = 0
					WHERE AHP.DD_TCO_ID in (1,2)
					AND TO_DATE(H.AHP_FECHA_INI_VENTA,''DD/MM/YY'') <> TO_DATE(H2.AHP_FECHA_FIN_VENTA,''DD/MM/YY'')
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.AHP_FECHA_INI_VENTA = T2.FECHA_INI_NUEVA
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

/***** SOLUCIONAR CALVAS ALQUILER *****/

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					WITH HIST AS (
						SELECT DISTINCT AHP.ACT_ID, AHP.AHP_ID, AHP.AHP_FECHA_INI_ALQUILER, AHP.AHP_FECHA_FIN_ALQUILER,
						ROW_NUMBER() OVER (PARTITION BY AHP.ACT_ID ORDER BY AHP.AHP_FECHA_INI_ALQUILER, AHP.AHP_FECHA_FIN_ALQUILER ASC NULLS LAST) RN
						FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
						WHERE (AHP.AHP_FECHA_INI_ALQUILER IS NOT NULL AND DD_TCO_ID IN (2,3))
						AND AHP.BORRADO = 0
						ORDER BY 1,2,3,5
					)
					SELECT DISTINCT H.ACT_ID, H.AHP_ID, H.AHP_FECHA_INI_ALQUILER, H.AHP_FECHA_FIN_ALQUILER, H.RN, H2.AHP_FECHA_FIN_ALQUILER AS FECHA_INI_NUEVA
					FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
					JOIN HIST H ON AHP.ACT_ID = H.ACT_ID
					LEFT JOIN HIST H2 ON AHP.ACT_ID = H2.ACT_ID AND H2.RN = H.RN-1
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AHP.ACT_ID AND DD_CRA_ID <> 21 AND ACT.BORRADO = 0
					WHERE AHP.DD_TCO_ID in (2,3)
					AND TO_DATE(H.AHP_FECHA_INI_ALQUILER,''DD/MM/YY'') <> TO_DATE(H2.AHP_FECHA_FIN_ALQUILER,''DD/MM/YY'')
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.AHP_FECHA_INI_ALQUILER = T2.FECHA_INI_NUEVA
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE';
	EXECUTE IMMEDIATE V_MSQL;

/************************************************************************************************************************************************************************ PASO 9 *****/

	DBMS_OUTPUT.put_line('[INFO] Inicio del PASO 9');

/***** UNIFICAR REGISTROS SEGUIDOS CON EL MISMO ESTADO DE PUBLICACIÓN VENTA *****/

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					WITH HIST AS (
						SELECT DISTINCT AHP.AHP_ID, AHP.ACT_ID, AHP.AHP_FECHA_INI_VENTA, AHP.AHP_FECHA_FIN_VENTA, AHP.DD_EPV_ID, AHP.DD_MTO_V_ID,
						ROW_NUMBER() OVER (PARTITION BY AHP.ACT_ID ORDER BY AHP.AHP_FECHA_INI_VENTA, AHP.AHP_FECHA_FIN_VENTA, AHP.AHP_ID ASC) RN
						FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
						WHERE ((AHP.AHP_FECHA_INI_VENTA IS NOT NULL OR AHP.AHP_FECHA_FIN_VENTA IS NOT NULL) AND DD_TCO_ID IN (1,2))
						AND AHP.BORRADO = 0
						ORDER BY 1,2,3,5
					)
					SELECT DISTINCT H.ACT_ID, H.AHP_ID, H.RN,
						CASE 
							WHEN H0.DD_EPV_ID = H.DD_EPV_ID AND H2.DD_EPV_ID = H.DD_EPV_ID THEN
								CASE
								    WHEN H.DD_EPV_ID = 4 THEN 
								        CASE
								            WHEN H0.DD_MTO_V_ID = H.DD_MTO_V_ID AND H2.DD_MTO_V_ID = H.DD_MTO_V_ID THEN 1
								            ELSE 0
								        END
								    ELSE 1
								END
							ELSE 0
						END AS BORRAR_FILA
					FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AHP.ACT_ID AND DD_CRA_ID <> 21 AND ACT.BORRADO = 0
					JOIN HIST H ON AHP.AHP_ID = H.AHP_ID
					LEFT JOIN HIST H0 ON AHP.ACT_ID = H0.ACT_ID AND H0.RN = H.RN-1
					LEFT JOIN HIST H2 ON AHP.ACT_ID = H2.ACT_ID AND H2.RN = H.RN+1
					WHERE AHP.DD_TCO_ID in (1,2)
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE
				WHERE T2.BORRAR_FILA = 1';
	EXECUTE IMMEDIATE V_MSQL;
    
	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					WITH HIST AS (
						SELECT DISTINCT AHP.AHP_ID, AHP.ACT_ID, AHP.AHP_FECHA_INI_VENTA, AHP.AHP_FECHA_FIN_VENTA, AHP.DD_EPV_ID, AHP.DD_MTO_V_ID,
						ROW_NUMBER() OVER (PARTITION BY AHP.ACT_ID ORDER BY AHP.AHP_FECHA_INI_VENTA, AHP.AHP_FECHA_FIN_VENTA ASC) RN
						FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
						WHERE ((AHP.AHP_FECHA_INI_VENTA IS NOT NULL OR AHP.AHP_FECHA_FIN_VENTA IS NOT NULL) AND DD_TCO_ID IN (1,2))
						AND AHP.BORRADO = 0
						ORDER BY 1,2,3,5
					)
					SELECT DISTINCT H.ACT_ID, H.AHP_ID, H.AHP_FECHA_INI_VENTA, H.AHP_FECHA_FIN_VENTA, H.RN, H2.AHP_FECHA_FIN_VENTA AS FECHA_FIN_NUEVA,
						CASE 
							WHEN H2.DD_EPV_ID = H.DD_EPV_ID THEN
								CASE
								    WHEN H.DD_EPV_ID = 4 THEN 
								        CASE
								            WHEN H2.DD_MTO_V_ID = H.DD_MTO_V_ID THEN 1
								            ELSE 0
								        END
								    ELSE 1
								END
							ELSE 0
						END AS ACTUALIZAR
					FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AHP.ACT_ID AND DD_CRA_ID <> 21 AND ACT.BORRADO = 0
					JOIN HIST H ON AHP.AHP_ID = H.AHP_ID
					LEFT JOIN HIST H2 ON AHP.ACT_ID = H2.ACT_ID AND H2.RN = H.RN+1
					WHERE AHP.DD_TCO_ID in (1,2)
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.AHP_FECHA_FIN_VENTA = T2.FECHA_FIN_NUEVA
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE
				WHERE T2.ACTUALIZAR = 1';
	EXECUTE IMMEDIATE V_MSQL;
    
	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					WITH HIST AS (
						SELECT DISTINCT AHP.AHP_ID, AHP.ACT_ID, AHP.AHP_FECHA_INI_VENTA, AHP.AHP_FECHA_FIN_VENTA, AHP.DD_EPV_ID, AHP.DD_MTO_V_ID,
						ROW_NUMBER() OVER (PARTITION BY AHP.ACT_ID ORDER BY AHP.AHP_FECHA_INI_VENTA, AHP.AHP_FECHA_FIN_VENTA ASC) RN
						FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
						WHERE ((AHP.AHP_FECHA_INI_VENTA IS NOT NULL OR AHP.AHP_FECHA_FIN_VENTA IS NOT NULL) AND DD_TCO_ID IN (1,2))
						AND AHP.BORRADO = 0
						ORDER BY 1,2,3,5
					)
					SELECT DISTINCT H.ACT_ID, H.AHP_ID, H.AHP_FECHA_INI_VENTA, H.AHP_FECHA_FIN_VENTA, H.RN,
						CASE 
							WHEN H2.DD_EPV_ID = H.DD_EPV_ID THEN
								CASE
								    WHEN H.DD_EPV_ID = 4 THEN 
								        CASE
								            WHEN H2.DD_MTO_V_ID = H.DD_MTO_V_ID THEN 1
								            ELSE 0
								        END
								    ELSE 1
								END
							ELSE 0
						END AS BORRAR_FILA
					FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
					JOIN '||V_ESQUEMA||'.ACT_ACTIVO ACT ON ACT.ACT_ID = AHP.ACT_ID AND DD_CRA_ID <> 21 AND ACT.BORRADO = 0
					JOIN HIST H ON AHP.AHP_ID = H.AHP_ID
					LEFT JOIN HIST H2 ON AHP.ACT_ID = H2.ACT_ID AND H2.RN = H.RN-1
					WHERE AHP.DD_TCO_ID in (1,2)
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE
				WHERE T2.BORRAR_FILA = 1';
	EXECUTE IMMEDIATE V_MSQL;
    
/***** UNIFICAR REGISTROS SEGUIDOS CON EL MISMO ESTADO DE PUBLICACIÓN ALQUILER *****/

	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					WITH HIST AS (
						SELECT DISTINCT AHP.AHP_ID, AHP.ACT_ID, AHP.AHP_FECHA_INI_ALQUILER, AHP.AHP_FECHA_FIN_ALQUILER, AHP.DD_EPA_ID, AHP.DD_MTO_A_ID,
						ROW_NUMBER() OVER (PARTITION BY AHP.ACT_ID ORDER BY AHP.AHP_FECHA_INI_ALQUILER, AHP.AHP_FECHA_FIN_ALQUILER ASC) RN
						FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
						WHERE ((AHP.AHP_FECHA_INI_ALQUILER IS NOT NULL OR AHP.AHP_FECHA_FIN_ALQUILER IS NOT NULL) AND DD_TCO_ID IN (2,3))
						AND AHP.BORRADO = 0
						ORDER BY 1,2,3,5
					)
					SELECT DISTINCT H.AHP_ID, H.RN,
						CASE 
							WHEN H0.DD_EPA_ID = H.DD_EPA_ID AND H2.DD_EPA_ID = H.DD_EPA_ID THEN
								CASE
								    WHEN H.DD_EPA_ID = 4 THEN 
								        CASE
								            WHEN H0.DD_MTO_A_ID = H.DD_MTO_A_ID AND H2.DD_MTO_A_ID = H.DD_MTO_A_ID THEN 1
								            ELSE 0
								        END
								    ELSE 1
								END
							ELSE 0
						END AS BORRAR_FILA
					FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
					JOIN HIST H ON AHP.AHP_ID = H.AHP_ID
					LEFT JOIN HIST H0 ON AHP.ACT_ID = H0.ACT_ID AND H0.RN = H.RN-1
					LEFT JOIN HIST H2 ON AHP.ACT_ID = H2.ACT_ID AND H2.RN = H.RN+1
					WHERE AHP.DD_TCO_ID IN (2,3)
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE
				WHERE T2.BORRAR_FILA = 1';
	EXECUTE IMMEDIATE V_MSQL;
    
	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					WITH HIST AS (
						SELECT DISTINCT AHP.AHP_ID, AHP.ACT_ID, AHP.AHP_FECHA_INI_ALQUILER, AHP.AHP_FECHA_FIN_ALQUILER, AHP.DD_EPA_ID, AHP.DD_MTO_A_ID,
						ROW_NUMBER() OVER (PARTITION BY AHP.ACT_ID ORDER BY AHP.AHP_FECHA_INI_ALQUILER, AHP.AHP_FECHA_FIN_ALQUILER ASC) RN
						FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
						WHERE ((AHP.AHP_FECHA_INI_ALQUILER IS NOT NULL OR AHP.AHP_FECHA_FIN_ALQUILER IS NOT NULL) AND DD_TCO_ID IN (2,3))
						AND AHP.BORRADO = 0
						ORDER BY 1,2,3,5
					)
					SELECT DISTINCT H.AHP_ID, H.AHP_FECHA_INI_ALQUILER, H.AHP_FECHA_FIN_ALQUILER, H.RN, H2.AHP_FECHA_FIN_ALQUILER AS FECHA_FIN_NUEVA,
						CASE 
							WHEN H2.DD_EPA_ID = H.DD_EPA_ID THEN
								CASE
								    WHEN H.DD_EPA_ID = 4 THEN 
								        CASE
								            WHEN H2.DD_MTO_A_ID = H.DD_MTO_A_ID THEN 1
								            ELSE 0
								        END
								    ELSE 1
								END
							ELSE 0
						END AS ACTUALIZAR
					FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
					JOIN HIST H ON AHP.AHP_ID = H.AHP_ID
					LEFT JOIN HIST H2 ON AHP.ACT_ID = H2.ACT_ID AND H2.RN = H.RN+1
					WHERE AHP.DD_TCO_ID IN (2,3)
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.AHP_FECHA_FIN_ALQUILER = T2.FECHA_FIN_NUEVA
					,T1.USUARIOMODIFICAR = '''||V_USUARIO||'''
					,T1.FECHAMODIFICAR = SYSDATE
				WHERE T2.ACTUALIZAR = 1';
	EXECUTE IMMEDIATE V_MSQL;
    
	V_MSQL := 'MERGE INTO '||V_ESQUEMA||'.'||V_TABLA||' T1
				USING (
					WITH HIST AS (
						SELECT DISTINCT AHP.AHP_ID, AHP.ACT_ID, AHP.AHP_FECHA_INI_ALQUILER, AHP.AHP_FECHA_FIN_ALQUILER, AHP.DD_EPA_ID, AHP.DD_MTO_A_ID,
						ROW_NUMBER() OVER (PARTITION BY AHP.ACT_ID ORDER BY AHP.AHP_FECHA_INI_ALQUILER, AHP.AHP_FECHA_FIN_ALQUILER ASC) RN
						FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
						WHERE ((AHP.AHP_FECHA_INI_ALQUILER IS NOT NULL OR AHP.AHP_FECHA_FIN_ALQUILER IS NOT NULL) AND DD_TCO_ID IN (2,3))
						AND AHP.BORRADO = 0
						ORDER BY 1,2,3,5
					)
					SELECT DISTINCT H.AHP_ID, H.AHP_FECHA_INI_ALQUILER, H.AHP_FECHA_FIN_ALQUILER, H.RN,
						CASE 
							WHEN H2.DD_EPA_ID = H.DD_EPA_ID THEN
								CASE
								    WHEN H.DD_EPA_ID = 4 THEN 
								        CASE
								            WHEN H2.DD_MTO_A_ID = H.DD_MTO_A_ID THEN 1
								            ELSE 0
								        END
								    ELSE 1
								END
							ELSE 0
						END AS BORRAR_FILA
					FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
					JOIN HIST H ON AHP.AHP_ID = H.AHP_ID
					LEFT JOIN HIST H2 ON AHP.ACT_ID = H2.ACT_ID AND H2.RN = H.RN-1
					WHERE AHP.DD_TCO_ID IN (2,3)
				) T2
				ON (T1.AHP_ID = T2.AHP_ID)
				WHEN MATCHED THEN UPDATE SET
					T1.BORRADO = 1
					,T1.USUARIOBORRAR = '''||V_USUARIO||'''
					,T1.FECHABORRAR = SYSDATE
				WHERE T2.BORRAR_FILA = 1';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.'||V_TABLA||' AHP
				WHERE EXISTS (
					SELECT AHP_ID FROM '||V_ESQUEMA||'.'||V_TABLA||' HIS
					JOIN REM01.ACT_ACTIVO ACT ON HIS.ACT_ID = ACT.ACT_ID AND ACT.BORRADO = 0
					WHERE (TO_DATE(HIS.AHP_FECHA_INI_VENTA, ''DD/MM/YY'') > TO_DATE(HIS.AHP_FECHA_FIN_VENTA, ''DD/MM/YY'')
						OR TO_DATE(HIS.AHP_FECHA_INI_ALQUILER, ''DD/MM/YY'') > TO_DATE(HIS.AHP_FECHA_FIN_ALQUILER, ''DD/MM/YY''))
					AND HIS.BORRADO = 0
					AND ACT.DD_CRA_ID <> 21
					AND AHP.AHP_ID = HIS.AHP_ID
				)';
	EXECUTE IMMEDIATE V_MSQL;

	DBMS_OUTPUT.put_line('[INFO] Inicio borrado tablas auxiliares');

	V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.ACT_REG_BORRADOS';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.MIGRACION_PUBLICACIONES';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.AHP_CONT_PUNTO2';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.AHP_REPETIDOS';
	EXECUTE IMMEDIATE V_MSQL;

	V_MSQL := 'DROP TABLE '||V_ESQUEMA||'.AHP_INI_FIN';
	EXECUTE IMMEDIATE V_MSQL;

 	COMMIT;
	DBMS_OUTPUT.put_line('[FIN]');

EXCEPTION
     WHEN OTHERS THEN
          ERR_NUM := SQLCODE;
          ERR_MSG := SQLERRM;
          DBMS_OUTPUT.PUT_LINE('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(ERR_NUM));
          DBMS_OUTPUT.PUT_LINE('-----------------------------------------------------------'); 
          DBMS_OUTPUT.PUT_LINE(ERR_MSG);
          ROLLBACK;
          RAISE;   
END;
/
EXIT;

