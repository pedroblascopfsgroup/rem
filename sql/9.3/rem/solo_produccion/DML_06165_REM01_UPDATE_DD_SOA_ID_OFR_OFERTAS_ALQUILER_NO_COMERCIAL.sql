--/*
--#########################################
--## AUTOR=Alejandra García
--## FECHA_CREACION=20221116
--## ARTEFACTO=batch
--## VERSION_ARTEFACTO=0.11
--## INCIDENCIA_LINK=HREOS-18941
--## PRODUCTO=NO
--## 
--## Finalidad:
--## 
--## INSTRUCCIONES:
--## VERSIONES:
--## 		0.1 Versión inicial - [HREOS-18941] - Alejandra García
--#########################################
--*/

--Para permitir la visualización de texto en un bloque PL/SQL utilizando DBMS_OUTPUT.PUT_LINE

WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON;
SET DEFINE OFF;

DECLARE
	TABLE_COUNT NUMBER(10,0) := 0;
	TABLE_COUNT_2 NUMBER(10,0) := 0;
	MAX_NUM_OFR NUMBER(10,0) := 0;
	V_NUM_TABLAS NUMBER(10,0) := 0;
	V_ESQUEMA VARCHAR2(10 CHAR) := 'REM01'; --REM01
	V_ESQUEMA_MASTER VARCHAR2(15 CHAR) := 'REMMASTER'; --REMMASTER
	V_SENTENCIA VARCHAR2(32000 CHAR);
	V_NUM_TABLAS_2 NUMBER(16);
	V_MSQL VARCHAR2(32000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.

BEGIN

	--Inicio del proceso de volcado sobre OFR_OFERTAS




	DBMS_OUTPUT.PUT_LINE('[INFO] COMIENZA EL PROCESO DE INSERCIÓN DE LOS DD_SOA_ID SOBRE LA TABLA '||V_ESQUEMA||'.OFR_OFERTAS');

	

        	
       		V_SENTENCIA := 'MERGE INTO '||V_ESQUEMA||'.OFR_OFERTAS MIG2 
			   				USING(
								SELECT DISTINCT 
									  OFR.OFR_NUM_OFERTA
									, TEV.TEV_NOMBRE
									, (SELECT DD_SOA_ID FROM '||V_ESQUEMA||'.DD_SOA_SUBTIPO_OFR_ALQUILER WHERE DD_SOA_CODIGO = TEV.TEV_VALOR) DD_SOA_ID
								FROM '||V_ESQUEMA||'.OFR_OFERTAS OFR
								JOIN '||V_ESQUEMA||'.OFR_OFERTAS_CAIXA CAIXA ON CAIXA.OFR_ID = OFR.OFR_ID  AND CAIXA.BORRADO = 0
								INNER JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO  ON ECO.OFR_ID = OFR.OFR_ID AND ECO.BORRADO = 0
								INNER JOIN '||V_ESQUEMA||'.ACT_TRA_TRAMITE ATR ON  ATR.TBJ_ID=ECO.TBJ_ID AND ATR.BORRADO = 0
								INNER JOIN '||V_ESQUEMA||'.DD_TOA_TIPO_OFR_ALQUILER TOA ON TOA.DD_TOA_ID = OFR.DD_TOA_ID AND TOA.BORRADO = 0
								INNER JOIN '||V_ESQUEMA||'.TAC_TAREAS_ACTIVOS TAC ON ATR.TRA_ID = TAC.TRA_ID AND ATR.TBJ_ID=ECO.TBJ_ID
								INNER JOIN '||V_ESQUEMA||'.TAR_TAREAS_NOTIFICACIONES TAR ON TAR.TAR_ID = TAC.TAR_ID AND TAR.TAR_TAREA_FINALIZADA = 1 
								INNER JOIN '||V_ESQUEMA||'.TEX_TAREA_EXTERNA TEX ON TAR.TAR_ID = TEX.TAR_ID 
								INNER JOIN '||V_ESQUEMA||'.TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_ID = TEX.TAP_ID AND TAP.TAP_CODIGO IN(''T018_DefinicionOferta'') 
								INNER JOIN '||V_ESQUEMA||'.TEV_TAREA_EXTERNA_VALOR TEV ON TEX.TEX_ID = TEV.TEX_ID AND TEV.TEV_NOMBRE IN (''tipoOfertaAlquiler'')
								WHERE OFR.BORRADO = 0
                    		)AUX ON (AUX.OFR_NUM_OFERTA = MIG2.OFR_NUM_OFERTA)
							WHEN MATCHED THEN UPDATE SET
							 MIG2.DD_SOA_ID = AUX.DD_SOA_ID
							,MIG2.USUARIOMODIFICAR = ''HREOS-18941''
							,MIG2.FECHAMODIFICAR = SYSDATE';
                   
        	EXECUTE IMMEDIATE V_SENTENCIA;

	DBMS_OUTPUT.PUT_LINE('[INFO] - '||to_char(sysdate,'HH24:MI:SS')||'  '||V_ESQUEMA||'..OFR_OFERTAS cargada. '||SQL%ROWCOUNT||' Filas.');
	
	COMMIT;

EXCEPTION
	WHEN OTHERS THEN
		DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecucion:'||TO_CHAR(SQLCODE));
		DBMS_OUTPUT.put_line('-----------------------------------------------------------');
		DBMS_OUTPUT.put_line(V_SENTENCIA);
		ROLLBACK;
		RAISE;
END;
/
EXIT;
