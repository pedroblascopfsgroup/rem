--/*
--##########################################
--## AUTOR=VIOREL REMUS OVIDIU
--## FECHA_CREACION=20191011
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-5441
--## PRODUCTO=NO
--##
--## Finalidad:
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
   
    V_ESQUEMA VARCHAR2(25 CHAR) := '#ESQUEMA#';-- '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR) := '#ESQUEMA_MASTER#';-- '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    ERR_NUM NUMBER;-- Numero de errores
    ERR_MSG VARCHAR2(2048);-- Mensaje de error;
    PL_OUTPUT VARCHAR2(20000 CHAR);
    V_NUM_TABLAS NUMBER;
    V_NUM_TABLAS_2 NUMBER;
    V_ECO_ID NUMBER(16,0);
    V_ACT_ID NUMBER(16,0);
    V_NUM_ECO NUMBER;
    V_COUNT NUMBER(16):= 0; -- Vble. para contar updates
    V_COS_ID NUMBER(16,0);
    V_USUARIO VARCHAR2(25 CHAR) := 'REMVIP-5441';
    TYPE T_FUNCION IS TABLE OF VARCHAR2(32000);
	TYPE T_ARRAY_FUNCION IS TABLE OF T_FUNCION;
	V_FUNCION T_ARRAY_FUNCION := T_ARRAY_FUNCION(
T_FUNCION(6520388,'10/09/2018'),
T_FUNCION(6520342,'10/09/2018'),
T_FUNCION(6964963,'15/06/2018'),
T_FUNCION(6886487,'29/12/2017'),
T_FUNCION(6710888,'21/12/2017'),
T_FUNCION(6083541,'29/12/2017'),
T_FUNCION(6083540,'29/12/2017'),
T_FUNCION(6033254,'14/12/2017'),
T_FUNCION(6031795,'11/01/2018'),
T_FUNCION(6134597,'14/12/2017'),
T_FUNCION(6040630,'18/01/2018'),
T_FUNCION(6043366,'17/01/2018'),
T_FUNCION(6036488,'15/12/2017'),
T_FUNCION(6035635,'12/01/2018'),
T_FUNCION(6031247,'27/12/2017'),
T_FUNCION(6035663,'15/12/2017'),
T_FUNCION(6035960,'19/12/2017'),
T_FUNCION(6030311,'28/12/2017'),
T_FUNCION(6035961,'27/12/2017'),
T_FUNCION(6035967,'14/12/2017'),
T_FUNCION(6034966,'19/12/2017'),
T_FUNCION(6030322,'21/12/2017'),
T_FUNCION(6037298,'14/12/2017'),
T_FUNCION(6037299,'18/12/2017'),
T_FUNCION(6041686,'22/12/2017'),
T_FUNCION(6029260,'27/12/2017'),
T_FUNCION(6041698,'27/12/2017'),
T_FUNCION(6038084,'18/12/2017'),
T_FUNCION(6041716,'25/01/2018'),
T_FUNCION(6029281,'25/01/2018'),
T_FUNCION(6037522,'29/12/2017'),
T_FUNCION(6037526,'29/12/2017'),
T_FUNCION(6043551,'14/12/2017'),
T_FUNCION(6040380,'29/12/2017'),
T_FUNCION(6037101,'28/12/2017'),
T_FUNCION(6037102,'28/12/2017'),
T_FUNCION(6032696,'28/12/2017'),
T_FUNCION(6028677,'29/12/2017'),
T_FUNCION(6028680,'29/12/2017'),
T_FUNCION(6042038,'28/12/2017'),
T_FUNCION(6029584,'28/12/2017'),
T_FUNCION(6029585,'28/12/2017'),
T_FUNCION(6032975,'28/12/2017'),
T_FUNCION(6037286,'28/12/2017'),
T_FUNCION(6081965,'28/12/2017'),
T_FUNCION(6136561,'22/12/2017'),
T_FUNCION(6781258,'14/12/2017'),
T_FUNCION(6781162,'14/12/2017'),
T_FUNCION(6780690,'28/12/2017'),
T_FUNCION(6780959,'15/12/2017'),
T_FUNCION(6036030,'22/12/2017'),
T_FUNCION(6033045,'28/12/2017'),
T_FUNCION(6042109,'22/12/2017'),
T_FUNCION(6031042,'14/12/2017'),
T_FUNCION(6037494,'27/12/2017'),
T_FUNCION(6033719,'15/12/2017'),
T_FUNCION(6036432,'21/12/2017'),
T_FUNCION(6034758,'28/12/2017'),
T_FUNCION(6034770,'28/12/2017'),
T_FUNCION(6034774,'21/12/2017'),
T_FUNCION(6077256,'22/12/2017'),
T_FUNCION(6029673,'22/12/2017'),
T_FUNCION(6029676,'22/12/2017'),
T_FUNCION(6037398,'18/12/2017'),
T_FUNCION(6034470,'19/12/2017'),
T_FUNCION(6039352,'29/12/2017'),
T_FUNCION(6029333,'14/12/2017'),
T_FUNCION(6033496,'19/01/2018'),
T_FUNCION(6030059,'19/01/2018'),
T_FUNCION(6042538,'19/01/2018'),
T_FUNCION(6037150,'19/01/2018'),
T_FUNCION(6036113,'29/12/2017'),
T_FUNCION(6035819,'19/12/2017'),
T_FUNCION(6031752,'22/12/2017'),
T_FUNCION(6077865,'22/12/2017'),
T_FUNCION(6028511,'20/12/2017'),
T_FUNCION(6030915,'27/12/2017'),
T_FUNCION(6033687,'19/12/2017'),
T_FUNCION(6029003,'21/12/2017'),
T_FUNCION(6038699,'18/12/2017'),
T_FUNCION(6038713,'29/12/2017'),
T_FUNCION(6036561,'14/12/2017'),
T_FUNCION(6029136,'27/12/2017'),
T_FUNCION(6041600,'29/12/2017'),
T_FUNCION(6035366,'21/12/2017'),
T_FUNCION(6041601,'21/12/2017'),
T_FUNCION(6031648,'27/12/2017'),
T_FUNCION(6041606,'27/12/2017'),
T_FUNCION(6031653,'26/12/2017'),
T_FUNCION(6031662,'19/12/2017'),
T_FUNCION(6029712,'27/12/2017'),
T_FUNCION(6038363,'27/12/2017'),
T_FUNCION(6042181,'27/12/2017'),
T_FUNCION(6042188,'26/12/2017'),
T_FUNCION(6042215,'26/12/2017'),
T_FUNCION(6038411,'27/12/2017'),
T_FUNCION(6029753,'19/12/2017'),
T_FUNCION(6029759,'27/12/2017'),
T_FUNCION(6029767,'21/12/2017'),
T_FUNCION(6042232,'21/12/2017'),
T_FUNCION(6042233,'21/12/2017'),
T_FUNCION(6029775,'29/12/2017'),
T_FUNCION(6033189,'29/12/2017'),
T_FUNCION(6034812,'29/12/2017'),
T_FUNCION(6029043,'21/12/2017'),
T_FUNCION(6934513,'28/12/2017'),
T_FUNCION(6934431,'05/01/2018'),
T_FUNCION(6934435,'12/01/2018'),
T_FUNCION(6891028,'26/01/2018'),
T_FUNCION(6886837,'25/01/2018'),
T_FUNCION(6886495,'17/01/2018'),
T_FUNCION(6886488,'17/01/2018'),
T_FUNCION(6886503,'29/12/2017'),
T_FUNCION(6886498,'29/12/2017'),
T_FUNCION(6886478,'29/12/2017'),
T_FUNCION(6886506,'19/01/2018'),
T_FUNCION(6886505,'19/01/2018'),
T_FUNCION(6886490,'24/01/2018'),
T_FUNCION(6886492,'19/01/2018'),
T_FUNCION(6886497,'19/01/2018'),
T_FUNCION(6042257,'14/12/2017'),
T_FUNCION(6886481,'24/01/2018'),
T_FUNCION(6886494,'17/01/2018'),
T_FUNCION(6886504,'19/01/2018'),
T_FUNCION(6886499,'19/01/2018'),
T_FUNCION(6844274,'26/01/2018'),
T_FUNCION(6840213,'28/12/2017'),
T_FUNCION(6840162,'15/12/2017'),
T_FUNCION(6839906,'22/12/2017'),
T_FUNCION(6836999,'28/12/2017'),
T_FUNCION(6837000,'28/12/2017'),
T_FUNCION(6836955,'29/12/2017'),
T_FUNCION(6837013,'29/12/2017'),
T_FUNCION(6836960,'29/12/2017'),
T_FUNCION(6837020,'28/12/2017'),
T_FUNCION(6837486,'27/12/2017'),
T_FUNCION(6837452,'27/12/2017'),
T_FUNCION(6837618,'27/12/2017'),
T_FUNCION(6834904,'26/12/2017'),
T_FUNCION(6032774,'26/12/2017'),
T_FUNCION(6833340,'22/12/2017'),
T_FUNCION(6833352,'22/12/2017'),
T_FUNCION(6833320,'29/12/2017'),
T_FUNCION(6828761,'28/12/2017'),
T_FUNCION(6828746,'28/12/2017'),
T_FUNCION(6827933,'22/12/2017'),
T_FUNCION(6827927,'29/12/2017'),
T_FUNCION(6827948,'29/12/2017'),
T_FUNCION(6823604,'27/12/2017'),
T_FUNCION(6819116,'22/12/2017'),
T_FUNCION(6819073,'25/01/2018'),
T_FUNCION(6819069,'25/01/2018'),
T_FUNCION(6815889,'22/12/2017'),
T_FUNCION(6815895,'22/12/2017'),
T_FUNCION(6815898,'22/12/2017'),
T_FUNCION(6815028,'22/12/2017'),
T_FUNCION(6814958,'22/12/2017'),
T_FUNCION(6814947,'22/12/2017'),
T_FUNCION(6814983,'28/12/2017'),
T_FUNCION(6815006,'29/12/2017'),
T_FUNCION(6814973,'28/12/2017'),
T_FUNCION(6814974,'28/12/2017'),
T_FUNCION(6815032,'28/12/2017'),
T_FUNCION(6814963,'28/12/2017'),
T_FUNCION(6814988,'24/01/2018'),
T_FUNCION(6814989,'29/12/2017'),
T_FUNCION(6815030,'29/12/2017'),
T_FUNCION(6814949,'29/12/2017'),
T_FUNCION(6814894,'28/12/2017'),
T_FUNCION(6814880,'28/12/2017'),
T_FUNCION(6811325,'29/12/2017'),
T_FUNCION(6811341,'29/12/2017'),
T_FUNCION(6810817,'20/12/2017'),
T_FUNCION(6810825,'20/12/2017'),
T_FUNCION(6810818,'20/12/2017'),
T_FUNCION(6806529,'29/12/2017'),
T_FUNCION(6806547,'29/12/2017'),
T_FUNCION(6806587,'29/12/2017'),
T_FUNCION(6806553,'27/12/2017'),
T_FUNCION(6806575,'27/12/2017'),
T_FUNCION(6806531,'29/12/2017'),
T_FUNCION(6806561,'29/12/2017'),
T_FUNCION(6806567,'22/12/2017'),
T_FUNCION(6806591,'29/12/2017'),
T_FUNCION(6806603,'29/12/2017'),
T_FUNCION(6811732,'28/12/2017'),
T_FUNCION(6811689,'14/12/2017'),
T_FUNCION(6801270,'26/12/2017'),
T_FUNCION(6801272,'26/12/2017'),
T_FUNCION(6801271,'26/12/2017'),
T_FUNCION(6791829,'26/01/2018'),
T_FUNCION(6787686,'22/12/2017'),
T_FUNCION(6787602,'29/12/2017'),
T_FUNCION(6787524,'29/12/2017'),
T_FUNCION(6785793,'16/01/2018'),
T_FUNCION(6785812,'16/01/2018'),
T_FUNCION(6785320,'29/12/2017'),
T_FUNCION(6780922,'22/12/2017'),
T_FUNCION(6780760,'15/01/2018'),
T_FUNCION(6781052,'28/12/2017'),
T_FUNCION(6780899,'19/12/2017'),
T_FUNCION(6762917,'29/12/2017'),
T_FUNCION(6760258,'27/12/2017'),
T_FUNCION(6757946,'13/12/2017'),
T_FUNCION(6747403,'27/12/2017'),
T_FUNCION(6747402,'27/12/2017'),
T_FUNCION(6744936,'25/01/2018'),
T_FUNCION(6745088,'25/01/2018'),
T_FUNCION(6739552,'22/12/2017'),
T_FUNCION(6738186,'22/12/2017'),
T_FUNCION(6741340,'22/12/2017'),
T_FUNCION(6712688,'22/12/2017'),
T_FUNCION(6733968,'22/12/2017'),
T_FUNCION(6728025,'22/12/2017'),
T_FUNCION(6725438,'22/12/2017'),
T_FUNCION(6735564,'22/12/2017'),
T_FUNCION(6714274,'22/12/2017'),
T_FUNCION(6719247,'22/12/2017'),
T_FUNCION(6715395,'22/12/2017'),
T_FUNCION(6738804,'22/12/2017'),
T_FUNCION(6731482,'22/12/2017'),
T_FUNCION(6729789,'22/12/2017'),
T_FUNCION(6741618,'22/12/2017'),
T_FUNCION(6741460,'22/12/2017'),
T_FUNCION(6715475,'22/12/2017'),
T_FUNCION(6716757,'22/12/2017'),
T_FUNCION(6723160,'22/12/2017'),
T_FUNCION(6711043,'21/12/2017'),
T_FUNCION(6711167,'21/12/2017'),
T_FUNCION(6710938,'22/12/2017'),
T_FUNCION(6711443,'21/12/2017'),
T_FUNCION(6711194,'29/12/2017'),
T_FUNCION(6711339,'12/01/2018'),
T_FUNCION(6710965,'26/12/2017'),
T_FUNCION(6710922,'14/12/2017'),
T_FUNCION(6711158,'29/12/2017'),
T_FUNCION(6694815,'14/12/2017'),
T_FUNCION(6694823,'26/12/2017'),
T_FUNCION(6694796,'29/12/2017'),
T_FUNCION(6528510,'20/12/2017'),
T_FUNCION(6520418,'26/12/2017'),
T_FUNCION(6520352,'22/12/2017'),
T_FUNCION(6520340,'20/12/2017'),
T_FUNCION(6520423,'20/12/2017'),
T_FUNCION(6520234,'18/12/2017'),
T_FUNCION(6028638,'28/12/2017'),
T_FUNCION(6354090,'26/01/2018'),
T_FUNCION(6354902,'26/12/2017'),
T_FUNCION(6346474,'22/12/2017'),
T_FUNCION(6346421,'21/12/2017'),
T_FUNCION(6346191,'21/12/2017'),
T_FUNCION(6133897,'27/12/2017'),
T_FUNCION(6134486,'15/12/2017'),
T_FUNCION(6133893,'04/01/2018'),
T_FUNCION(6135921,'14/12/2017'),
T_FUNCION(6134698,'14/12/2017'),
T_FUNCION(6133757,'29/12/2017'),
T_FUNCION(6133915,'29/12/2017'),
T_FUNCION(6133725,'29/12/2017'),
T_FUNCION(6135940,'29/12/2017'),
T_FUNCION(6134913,'18/12/2017'),
T_FUNCION(6136103,'27/12/2017'),
T_FUNCION(6135779,'29/12/2017'),
T_FUNCION(6079282,'28/12/2017'),
T_FUNCION(6080671,'20/12/2017'),
T_FUNCION(6078318,'27/12/2017'),
T_FUNCION(6078317,'27/12/2017'),
T_FUNCION(6082241,'20/12/2017'),
T_FUNCION(6082902,'29/12/2017'),
T_FUNCION(6079847,'28/12/2017'),
T_FUNCION(6079682,'29/12/2017'),
T_FUNCION(6079680,'29/12/2017'),
T_FUNCION(6080822,'27/12/2017'),
T_FUNCION(6082349,'22/12/2017'),
T_FUNCION(6081027,'29/12/2017'),
T_FUNCION(6082542,'21/12/2017'),
T_FUNCION(6135070,'21/12/2017'),
T_FUNCION(6079938,'15/12/2017'),
T_FUNCION(6134745,'13/12/2017'),
T_FUNCION(6080895,'21/12/2017'),
T_FUNCION(6080894,'21/12/2017'),
T_FUNCION(6080060,'15/12/2017'),
T_FUNCION(6075781,'21/12/2017'),
T_FUNCION(6082623,'14/12/2017'),
T_FUNCION(6075837,'30/01/2018'),
T_FUNCION(6075836,'29/12/2017'),
T_FUNCION(6081097,'29/12/2017'),
T_FUNCION(6081096,'29/12/2017'),
T_FUNCION(6037412,'29/12/2017'),
T_FUNCION(6037320,'28/12/2017'),
T_FUNCION(6041881,'22/12/2017'),
T_FUNCION(6029467,'22/12/2017'),
T_FUNCION(6041904,'22/12/2017'),
T_FUNCION(6037205,'21/12/2017'),
T_FUNCION(6029022,'20/12/2017'),
T_FUNCION(6039536,'19/12/2017'),
T_FUNCION(6030839,'26/12/2017'),
T_FUNCION(6039537,'19/12/2017'),
T_FUNCION(6041927,'28/12/2017'),
T_FUNCION(6040452,'19/12/2017'),
T_FUNCION(6136404,'19/12/2017'),
T_FUNCION(6079010,'27/12/2017'),
T_FUNCION(6079012,'27/12/2017'),
T_FUNCION(6075921,'26/01/2018'),
T_FUNCION(6076227,'14/12/2017'),
T_FUNCION(6078537,'20/12/2017'),
T_FUNCION(6078160,'18/12/2017'),
T_FUNCION(6083514,'21/12/2017'),
T_FUNCION(6081564,'19/12/2017'),
T_FUNCION(6076389,'28/12/2017'),
T_FUNCION(6134332,'27/12/2017'),
T_FUNCION(6076572,'21/12/2017'),
T_FUNCION(6076571,'21/12/2017'),
T_FUNCION(6076490,'21/12/2017'),
T_FUNCION(6037972,'28/12/2017'),
T_FUNCION(6135652,'22/12/2017'),
T_FUNCION(6136719,'15/12/2017'),
T_FUNCION(6032125,'28/12/2017'),
T_FUNCION(6033490,'14/12/2017'),
T_FUNCION(6076752,'27/12/2017'),
T_FUNCION(6076751,'27/12/2017'),
T_FUNCION(6036418,'21/12/2017'),
T_FUNCION(6038795,'29/12/2017'),
T_FUNCION(6038784,'29/12/2017'),
T_FUNCION(6136730,'15/12/2017'),
T_FUNCION(6076879,'27/12/2017'),
T_FUNCION(6040737,'29/12/2017'),
T_FUNCION(6076848,'29/12/2017'),
T_FUNCION(6076823,'29/12/2017'),
T_FUNCION(6030087,'20/12/2017'),
T_FUNCION(6038741,'20/12/2017'),
T_FUNCION(6083798,'10/01/2018'),
T_FUNCION(6033511,'29/12/2017'),
T_FUNCION(6033763,'18/12/2017'),
T_FUNCION(6076938,'10/01/2018'),
T_FUNCION(6076937,'10/01/2018'),
T_FUNCION(6035308,'28/12/2017'),
T_FUNCION(6032321,'21/12/2017'),
T_FUNCION(7100146,'21/12/2018'),
T_FUNCION(7100131,'17/01/2019'),
T_FUNCION(7100152,'21/12/2018'),
T_FUNCION(7100145,'21/12/2018'),
T_FUNCION(7100143,'21/12/2018'),
T_FUNCION(7100126,'21/12/2018'),
T_FUNCION(6823511,'01/12/2017'),
T_FUNCION(6039426,'05/10/2017'),
T_FUNCION(6043803,'07/11/2017'),
T_FUNCION(6082031,'08/11/2018'),
T_FUNCION(6033000,'11/12/2018'),
T_FUNCION(6041126,'14/12/2017')

	); 
	V_TMP_FUNCION T_FUNCION;

BEGIN

	DBMS_OUTPUT.PUT_LINE('[INI]: ACTUALIZAR ESTADO ACTIVO Y FECHA VENTA');

	FOR I IN V_FUNCION.FIRST .. V_FUNCION.LAST
		LOOP
			V_TMP_FUNCION := V_FUNCION(I);
			EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO
								WHERE ACT_NUM_ACTIVO = '||V_TMP_FUNCION(1)||' AND BORRADO = 0' INTO V_NUM_TABLAS;
			IF V_NUM_TABLAS > 0 THEN

				EXECUTE IMMEDIATE 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
					JOIN '||V_ESQUEMA||'.ACT_OFR AOF ON ACT.ACT_ID = AOF.ACT_ID 
					JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = AOF.OFR_ID 
					WHERE ECO.DD_EEC_ID = 8 AND ACT.ACT_NUM_ACTIVO = '||V_TMP_FUNCION(1)||'' INTO V_NUM_TABLAS_2 ;

				IF V_NUM_TABLAS_2 > 0 THEN

				EXECUTE IMMEDIATE 'SELECT ECO.ECO_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO ACT
					JOIN '||V_ESQUEMA||'.ACT_OFR AOF ON ACT.ACT_ID = AOF.ACT_ID 
					JOIN '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL ECO ON ECO.OFR_ID = AOF.OFR_ID 
					WHERE ECO.DD_EEC_ID = 8 AND ACT.ACT_NUM_ACTIVO = '||V_TMP_FUNCION(1)||'' INTO V_ECO_ID ;

					EXECUTE IMMEDIATE 'UPDATE '||V_ESQUEMA||'.ECO_EXPEDIENTE_COMERCIAL SET 
										ECO_FECHA_VENTA = TO_DATE('''||V_TMP_FUNCION(2)||''', ''DD/MM/YYYY''), 
										USUARIOMODIFICAR = '''||V_USUARIO||''',
										FECHAMODIFICAR = SYSDATE
										WHERE ECO_ID = '||V_ECO_ID||' ';

					EXECUTE IMMEDIATE 'UPDATE '||V_ESQUEMA||'.ACT_ACTIVO SET DD_SCM_ID = 5,
										USUARIOMODIFICAR = '''||V_USUARIO||''',
										FECHAMODIFICAR = SYSDATE
										WHERE ACT_NUM_ACTIVO = '||V_TMP_FUNCION(1)||' ';

					DBMS_OUTPUT.PUT_LINE('[INFO]: '||SQL%ROWCOUNT||' ACTIVO ACTUALIZADO : '''||V_TMP_FUNCION(1)||''' ');

					V_COUNT := V_COUNT + 1;

				ELSE

					DBMS_OUTPUT.PUT_LINE('[INFO] El expediente no existe!');
				
				END IF;

			ELSE
				DBMS_OUTPUT.PUT_LINE('[INFO] El activo '''||V_TMP_FUNCION(1)||''' no existe!');
				
			END IF;

		END LOOP;

		DBMS_OUTPUT.PUT_LINE('[INFO]: SE HAN ACTUALIZADO '||V_COUNT||' ACTIVOS Y EXPEDIENTES');

	COMMIT;
EXCEPTION
     WHEN OTHERS THEN
          err_num := SQLCODE;
          err_msg := SQLERRM;

          DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
          DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
          DBMS_OUTPUT.put_line(err_msg);

          ROLLBACK;
          RAISE;          

END;

/

EXIT
