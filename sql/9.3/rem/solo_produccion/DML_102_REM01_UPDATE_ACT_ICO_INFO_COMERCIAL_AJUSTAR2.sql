--/*
--##########################################
--## AUTOR=GUILLEM REY
--## FECHA_CREACION=20191112
--## ARTEFACTO=online
--## VERSION_ARTEFACTO=9.3
--## INCIDENCIA_LINK=REMVIP-5721
--## PRODUCTO=NO
--##
--## Finalidad: 
--## INSTRUCCIONES:
--## VERSIONES:
--##        0.1 Versión inicial
--##########################################
--*/


WHENEVER SQLERROR EXIT SQL.SQLCODE;
SET SERVEROUTPUT ON; 
SET DEFINE OFF;


DECLARE
    V_MSQL VARCHAR2(32000 CHAR); -- Sentencia a ejecutar     
    V_ESQUEMA VARCHAR2(25 CHAR):= '#ESQUEMA#'; -- Configuracion Esquema
    V_ESQUEMA_M VARCHAR2(25 CHAR):= '#ESQUEMA_MASTER#'; -- Configuracion Esquema Master
    V_SQL VARCHAR2(4000 CHAR); -- Vble. para consulta que valida la existencia de una tabla.
    V_NUM_TABLAS NUMBER(16); -- Vble. para validar la existencia de una tabla.   
    ERR_NUM NUMBER(25);  -- Vble. auxiliar para registrar errores en el script.
    ERR_MSG VARCHAR2(1024 CHAR); -- Vble. auxiliar para registrar errores en el script.
    V_TIPO_INFORME VARCHAR2(5 CHAR);
    V_USR VARCHAR2(30 CHAR) := 'REMVIP-5721'; -- USUARIOCREAR/USUARIOMODIFICAR
    
    TYPE T_TIPO_DATA IS TABLE OF NUMBER(25);
  	TYPE T_ARRAY_DATA IS TABLE OF T_TIPO_DATA;
    
    V_TIPO_DATA T_ARRAY_DATA := T_ARRAY_DATA(
		T_TIPO_DATA(6934369),
		T_TIPO_DATA(6831207),
		T_TIPO_DATA(7008440),
		T_TIPO_DATA(6983749),
		T_TIPO_DATA(7016379),
		T_TIPO_DATA(7020375),
		T_TIPO_DATA(7071131),
		T_TIPO_DATA(7037231),
		T_TIPO_DATA(7091254),
		T_TIPO_DATA(7098511),
		T_TIPO_DATA(7098552),
		T_TIPO_DATA(7099010),
		T_TIPO_DATA(7099466),
		T_TIPO_DATA(7226781),
		T_TIPO_DATA(7226980),
		T_TIPO_DATA(7089411),
		T_TIPO_DATA(7089412),
		T_TIPO_DATA(7089413),
		T_TIPO_DATA(7292853),
		T_TIPO_DATA(7292865),
		T_TIPO_DATA(7293118),
		T_TIPO_DATA(7293192),
		T_TIPO_DATA(7293445),
		T_TIPO_DATA(7293637),
		T_TIPO_DATA(7293638),
		T_TIPO_DATA(7294032),
		T_TIPO_DATA(7294041),
		T_TIPO_DATA(7294134),
		T_TIPO_DATA(7294168),
		T_TIPO_DATA(7294169),
		T_TIPO_DATA(7294192),
		T_TIPO_DATA(7294203),
		T_TIPO_DATA(7294272),
		T_TIPO_DATA(7294275),
		T_TIPO_DATA(7294281),
		T_TIPO_DATA(7294283),
		T_TIPO_DATA(7294284),
		T_TIPO_DATA(7294370),
		T_TIPO_DATA(7294360),
		T_TIPO_DATA(7294363),
		T_TIPO_DATA(7294376),
		T_TIPO_DATA(7294378),
		T_TIPO_DATA(7294389),
		T_TIPO_DATA(7294411),
		T_TIPO_DATA(7294454)
		); 
    V_TMP_TIPO_DATA T_TIPO_DATA;
    V_TIPO_ACTIVO NUMBER(16);
BEGIN	

		DBMS_OUTPUT.PUT_LINE('[INICIO]');
		FOR I IN V_TIPO_DATA.FIRST .. V_TIPO_DATA.LAST
      		LOOP
	      
	        	V_TMP_TIPO_DATA := V_TIPO_DATA(I);
	        	V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1);
		        EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;
	        	IF V_NUM_TABLAS > 0 THEN
			        V_MSQL := 'SELECT COUNT(1) FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||')';
			        EXECUTE IMMEDIATE V_MSQL INTO V_NUM_TABLAS;
			        
					IF V_NUM_TABLAS > 0 THEN
						V_MSQL := 'SELECT NVL(DD_TIC_ID, 0) FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL 					
									WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||')';
						EXECUTE IMMEDIATE V_MSQL INTO V_TIPO_INFORME;
						
						IF V_TIPO_INFORME = 1 THEN
							V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_LCO_LOCAL_COMERCIAL WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
							EXECUTE IMMEDIATE V_MSQL;
							V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_APR_PLAZA_APARCAMIENTO WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
							EXECUTE IMMEDIATE V_MSQL;
							
						ELSIF V_TIPO_INFORME = 2 THEN
							V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_VIV_VIVIENDA WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
							EXECUTE IMMEDIATE V_MSQL;
							V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_APR_PLAZA_APARCAMIENTO WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
							EXECUTE IMMEDIATE V_MSQL;
							
						ELSIF V_TIPO_INFORME = 3 THEN
							V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_VIV_VIVIENDA WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
							EXECUTE IMMEDIATE V_MSQL;
							V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_LCO_LOCAL_COMERCIAL WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
							EXECUTE IMMEDIATE V_MSQL;
							
						ELSE 
							V_MSQL := 'SELECT NVL(DD_TPA_ID, 0) FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||')';
							EXECUTE IMMEDIATE V_MSQL INTO V_TIPO_ACTIVO;
							IF V_TIPO_ACTIVO = 0 THEN
								V_MSQL := 'SELECT NVL(DD_TPA_ID, 0) FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1);
								EXECUTE IMMEDIATE V_MSQL INTO V_TIPO_ACTIVO;						
							END IF;
							IF V_TIPO_ACTIVO = 2 THEN
								V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL SET USUARIOMODIFICAR = '''||V_USR||''', FECHAMODIFICAR = SYSDATE, DD_TIC_ID = (SELECT DD_TIC_ID FROM '||V_ESQUEMA||'.DD_TIC_TIPO_INFO_COMERCIAL WHERE DD_TIC_CODIGO = ''01'') WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||')';
								EXECUTE IMMEDIATE V_MSQL;
								V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_LCO_LOCAL_COMERCIAL WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
								EXECUTE IMMEDIATE V_MSQL;
								V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_APR_PLAZA_APARCAMIENTO WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
								EXECUTE IMMEDIATE V_MSQL;
								
							ELSIF V_TIPO_ACTIVO = 3 THEN
								V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL SET USUARIOMODIFICAR = '''||V_USR||''', FECHAMODIFICAR = SYSDATE, DD_TIC_ID = (SELECT DD_TIC_ID FROM '||V_ESQUEMA||'.DD_TIC_TIPO_INFO_COMERCIAL WHERE DD_TIC_CODIGO = ''02'') WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||')';
								EXECUTE IMMEDIATE V_MSQL;
								V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_VIV_VIVIENDA WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
								EXECUTE IMMEDIATE V_MSQL;
								V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_APR_PLAZA_APARCAMIENTO WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
								EXECUTE IMMEDIATE V_MSQL;
								
							ELSIF V_TIPO_ACTIVO = 7 THEN
								V_MSQL := 'UPDATE '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL SET USUARIOMODIFICAR = '''||V_USR||''', FECHAMODIFICAR = SYSDATE, DD_TIC_ID = (SELECT DD_TIC_ID FROM '||V_ESQUEMA||'.DD_TIC_TIPO_INFO_COMERCIAL WHERE DD_TIC_CODIGO = ''03'') WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||')';
								EXECUTE IMMEDIATE V_MSQL;
								V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_VIV_VIVIENDA WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
								EXECUTE IMMEDIATE V_MSQL;
								V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_LCO_LOCAL_COMERCIAL WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
								EXECUTE IMMEDIATE V_MSQL;
								
							ELSE 
								V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_VIV_VIVIENDA WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
								EXECUTE IMMEDIATE V_MSQL;
								V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_LCO_LOCAL_COMERCIAL WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
								EXECUTE IMMEDIATE V_MSQL;
								V_MSQL := 'DELETE FROM '||V_ESQUEMA||'.ACT_APR_PLAZA_APARCAMIENTO WHERE ICO_ID = (SELECT ICO_ID FROM '||V_ESQUEMA||'.ACT_ICO_INFO_COMERCIAL WHERE ACT_ID = (SELECT ACT_ID FROM '||V_ESQUEMA||'.ACT_ACTIVO WHERE ACT_NUM_ACTIVO = '||V_TMP_TIPO_DATA(1)||'))';
								EXECUTE IMMEDIATE V_MSQL;
							END IF;					
						END IF;
					END IF;
				END IF;
	        END LOOP;
        DBMS_OUTPUT.PUT_LINE('[FIN]');
        
        COMMIT;
  
EXCEPTION
    WHEN OTHERS THEN
    err_num := SQLCODE;
    err_msg := SQLERRM;

    DBMS_OUTPUT.put_line('[ERROR] Se ha producido un error en la ejecución:'||TO_CHAR(err_num));
    DBMS_OUTPUT.put_line('-----------------------------------------------------------'); 
    DBMS_OUTPUT.put_line(err_msg);
    DBMS_OUTPUT.put_line(V_MSQL);
    ROLLBACK;
    RAISE;          

END;

/

EXIT