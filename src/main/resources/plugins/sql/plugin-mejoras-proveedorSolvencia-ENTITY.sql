-- función que se le asignará al proveedor de solvencia
insert into unmaster.fun_funciones (fun_id,fun_descripcion,fun_descripcion_larga,version,usuariocrear,fechacrear,borrado) values 
(unmaster.s_fun_funciones.nextval, 'ROLE_PROVEEDOR_SOLVENCIA', 'Perfil de proveedor de solvencia',0,'AAS',sysdate,0);


-- PARA LA AMPLIACIÓN DE LA CLASE PERSONA PARA DISTINGUIR LA VISIBILIDAD
-- 1-  DICCIONARIO DE TIPOS DE VISIBILIDAD
CREATE SEQUENCE S_DD_TVB_TIPO_VISIBILIDAD
  START WITH 1
  MAXVALUE 999999999999999999999999999;

CREATE TABLE DD_TVB_TIPO_VISIBILIDAD
(
  DD_TVB_ID                 NUMBER(16),
  DD_TVB_CODIGO             VARCHAR2(20 CHAR)   NOT NULL,
  DD_TVB_DESCRIPCION        VARCHAR2(50 CHAR),
  DD_TVB_DESCRIPCION_LARGA  VARCHAR2(250 CHAR),
  DD_TVB_NOMBRE_CLASE		VARCHAR2(250 CHAR)  NOT NULL,
  DD_TVB_NOMBRE_TABLA		VARCHAR2(250 CHAR)  NOT NULL,
  VERSION                   INTEGER             DEFAULT 0                     NOT NULL,
  USUARIOCREAR              VARCHAR2(10 CHAR)   NOT NULL,
  FECHACREAR                TIMESTAMP(6)        NOT NULL,
  USUARIOMODIFICAR          VARCHAR2(10 CHAR),
  FECHAMODIFICAR            TIMESTAMP(6),
  USUARIOBORRAR             VARCHAR2(10 CHAR),
  FECHABORRAR               TIMESTAMP(6),
  BORRADO                   NUMBER(1)           DEFAULT 0                     NOT NULL,
  CONSTRAINT PK_TVB_TIPO_VISIBILIDAD PRIMARY KEY (DD_TVB_ID),
  CONSTRAINT UK_TVB_TIPO_VISIBILIDAD UNIQUE (DD_TVB_CODIGO)
);


insert into DD_TVB_TIPO_VISIBILIDAD(DD_TVB_ID,DD_TVB_CODIGO,DD_TVB_DESCRIPCION,DD_TVB_DESCRIPCION_LARGA,DD_TVB_NOMBRE_CLASE,DD_TVB_NOMBRE_TABLA,VERSION,
USUARIOCREAR,FECHACREAR,BORRADO)
values(S_DD_TVB_TIPO_VISIBILIDAD.nextval, 'DES', 'Despacho', 'Visibilidad por despacho','DespachoExterno','DES_DESPACHO_EXTERNO', 0, 
'DIA',SYSDATE, 0);

-- 2- CREAMOS LA CLASE VILIBILIDAD QUE TENDRÁ UN VALOR DE UN ID Y UN TIPO DE VISIBILIDAD EN EL QUE SE LE INDICARÁ 
	-- A QUE ENTIDAD PERTENECE ESE ID
	
CREATE SEQUENCE S_VSB_VISIBILIDAD
  START WITH 1
  MAXVALUE 999999999999999999999999999;

CREATE TABLE VSB_VISIBILIDAD
(
  VSB_ID                 	NUMBER(16),
  VSB_IDENTIDAD				NUMBER(16)  		NOT NULL,
  DD_TVB_ID             	NUMBER(16)		    NOT NULL,
  VERSION                   INTEGER             DEFAULT 0                     NOT NULL,
  USUARIOCREAR              VARCHAR2(10 CHAR)   NOT NULL,
  FECHACREAR                TIMESTAMP(6)        NOT NULL,
  USUARIOMODIFICAR          VARCHAR2(10 CHAR),
  FECHAMODIFICAR            TIMESTAMP(6),
  USUARIOBORRAR             VARCHAR2(10 CHAR),
  FECHABORRAR               TIMESTAMP(6),
  BORRADO                   NUMBER(1)           DEFAULT 0                     NOT NULL,
  CONSTRAINT PK_VSB_VISIBILIDAD PRIMARY KEY (VSB_ID),
  CONSTRAINT FK_TVB_TIPO_VISIBILIDAD FOREIGN KEY (DD_TVB_ID) REFERENCES DD_TVB_TIPO_VISIBILIDAD (DD_TVB_ID)
);


--insert into VSB_VISIBILIDAD(VSB_ID,VSB_IDENTIDAD,DD_TVB_ID,VERSION,USUARIOCREAR,FECHACREAR,BORRADO)
--values(S_VSB_VISIBILIDAD.nextval, , , 0,'DIA',SYSDATE, 0);

-- EXTENDER LA CLASE PERSONA PARA PODER INSERTARLE UNA VISIBILIDAD
ALTER TABLE PER_PERSONAS ADD (DTYPE VARCHAR2 (20 CHAR) DEFAULT 'EXTPersona' NOT NULL);

ALTER TABLE PER_PERSONAS ADD (VSB_ID NUMBER(16));

ALTER TABLE PER_PERSONAS ADD (PER_FECHA_REV_SOLVENCIA TIMESTAMP(6));

ALTER TABLE PER_PERSONAS ADD (
  CONSTRAINT FK_PER_PERSONAS_VSB_ID 
 FOREIGN KEY (VSB_ID) 
 REFERENCES VSB_VISIBILIDAD (VSB_ID));
 
 -- nuevo despacho de tipo proveedor de solvencia
 Insert into DD_TDE_TIPO_DESPACHO
   (DD_TDE_ID, DD_TDE_CODIGO, DD_TDE_DESCRIPCION, DD_TDE_DESCRIPCION_LARGA, VERSION, 
    USUARIOCREAR, FECHACREAR, BORRADO)
 Values
   (S_DD_TDE_TIPO_DESPACHO.nextval, '4', 'Despacho Proveedor Solvencia', 'Despacho Proveedor Solvencia', 0, 
    'DD', sysdate, 0);
