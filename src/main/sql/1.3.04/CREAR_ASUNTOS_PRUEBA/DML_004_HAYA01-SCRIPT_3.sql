/*  INSERT PRC_PER             */

INSERT INTO PRC_PER(
PRC_ID,
PER_ID,
VERSION)

SELECT 

PRO.PRC_ID,
TMP.PER_ID,
'0'

FROM  CNV_AUX_ALTA_PRC PRC
LEFT JOIN  ASU_ASUNTOS ASU ON PRC.CODIGO_PROCEDIMIENTO_NUSE=ASU.ASU_ID_EXTERNO
LEFT JOIN PRC_PROCEDIMIENTOS PRO ON PRO.ASU_ID=ASU.ASU_ID
LEFT JOIN CNV_AUX_ALTA_PRC_PER PER ON PRC.CODIGO_PROCEDIMIENTO_NUSE=PER.CODIGO_PROCEDIMIENTO
LEFT JOIN CNV_TMP_PER_ID TMP ON TMP.CODIGO_PERSONA=PER.CODIGO_PERSONA
WHERE (PRO.PRC_ID||TMP.PER_ID) not in ( SELECT CEX.PRC_ID||CEX.PER_ID FROM PRC_PER CEX) AND TMP.PER_ID IS NOT NULL AND PRO.PRC_ID IS NOT NULL;



/*    INSERT PRC_PROCEDIMIENTOS     */

INSERT INTO PRC_PROCEDIMIENTOS(
PRC_ID,
ASU_ID,
DD_TAC_ID,
DD_TRE_ID,
DD_TPO_ID,
PRC_PORCENTAJE_RECUPERACION,
PRC_PLAZO_RECUPERACION,
PRC_SALDO_ORIGINAL_VENCIDO,
PRC_SALDO_ORIGINAL_NO_VENCIDO,
VERSION,
USUARIOCREAR,
FECHACREAR,
BORRADO,
PRC_DECIDIDO,
DD_EPR_ID,
DTYPE,
TIPO_PROC_ORIGINAL,
PRC_PARALIZADO)

SELECT 
S_PRC_PROCEDIMIENTOS.NEXTVAL,
ASU.ASU_ID,
null,
'1',
null,
'100',
'18',
'0',
'0',
'0',
'CONVIVE_F2',
SYSDATE,
'0',
'0',
EST.DD_EPR_ID,
'MEJProcedimiento',
null,
'0'

FROM  ASU_ASUNTOS ASU
LEFT JOIN HAYAMASTER.DD_EPR_ESTADO_PROCEDIMIENTO EST ON EST.DD_EPR_CODIGO='03'
where ASU.ASU_ID not in ( SELECT PRC.ASU_ID  FROM PRC_PROCEDIMIENTOS PRC) AND ASU.ASU_ID IS NOT NULL;



/*   INSERT PRC_CEX    */

INSERT INTO PRC_CEX(
PRC_ID,
CEX_ID,
VERSION)

SELECT 
PRO.PRC_ID,
CEX.CEX_ID,
'0'

FROM  CNV_AUX_ALTA_PRC PRC
LEFT JOIN  ASU_ASUNTOS ASU ON PRC.CODIGO_PROCEDIMIENTO_NUSE=ASU.ASU_ID_EXTERNO
LEFT JOIN PRC_PROCEDIMIENTOS PRO ON PRO.ASU_ID=ASU.ASU_ID,
EXP_EXPEDIENTES EXP
LEFT JOIN CEX_CONTRATOS_EXPEDIENTE CEX ON CEX.EXP_ID=EXP.EXP_ID
WHERE PRC.CODIGO_PROCEDIMIENTO_NUSE=EXP.CD_PROCEDIMIENTO
AND PRO.PRC_ID not in ( SELECT CEX.PRC_ID FROM PRC_CEX CEX) AND CEX.CEX_ID IS NOT NULL;


/*  INSERT_TAR_TAREAS_NOTIF(CONCURSOS)  */

INSERT INTO TAR_TAREAS_NOTIFICACIONES(
TAR_ID ,
EXP_ID,
ASU_ID ,
DD_EST_ID ,
DD_EIN_ID ,
DD_STA_ID ,
TAR_CODIGO ,
TAR_TAREA ,
TAR_DESCRIPCION ,
TAR_FECHA_INI ,
TAR_EN_ESPERA ,
TAR_ALERTA ,
TAR_EMISOR ,
VERSION ,
USUARIOCREAR,
FECHACREAR  ,
BORRADO ,
PRC_ID ,
DTYPE ,
NFA_TAR_REVISADA )

SELECT 
S_TAR_TAREAS_NOTIFICACIONES.NEXTVAL,
EXP_ID,
PRO.ASU_ID,
'6',
'5',
DD_STA_ID,
'1',
TAP_CODIGO,
TAP_DESCRIPCION,
SYSDATE,
'0',
'0',
'AUTOMATICA',
'0',
'CONVIVE_F2',
SYSDATE,
'0',
PRC_ID,
'EXTTareaNotificacion',
'0'

FROM CNV_AUX_ALTA_PRC PRC 
LEFT JOIN ASU_ASUNTOS ASU ON PRC.CODIGO_PROCEDIMIENTO_NUSE=ASU.ASU_ID_EXTERNO
LEFT JOIN PRC_PROCEDIMIENTOS PRO ON PRO.ASU_ID=ASU.ASU_ID
LEFT JOIN TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_CODIGO='P412_RegistrarPublicacionBOE' WHERE PRC.TIPO_PROCEDIMIENTO='CONCURSO'
AND ASU.EXP_ID not in ( SELECT TAR.EXP_ID FROM TAR_TAREAS_NOTIFICACIONES TAR where EXP_ID IS NOT NULL) AND EXP_ID IS NOT NULL;



/*    INSERT_TAR_TAREAS_NOTIF(LITIGIOS)   */

INSERT INTO TAR_TAREAS_NOTIFICACIONES(
TAR_ID ,
EXP_ID,
ASU_ID ,
DD_EST_ID ,
DD_EIN_ID ,
DD_STA_ID ,
TAR_CODIGO ,
TAR_TAREA ,
TAR_DESCRIPCION ,
TAR_FECHA_INI ,
TAR_EN_ESPERA ,
TAR_ALERTA ,
TAR_EMISOR ,
VERSION ,
USUARIOCREAR,
FECHACREAR  ,
BORRADO ,
PRC_ID ,
DTYPE ,
NFA_TAR_REVISADA )

SELECT 
S_TAR_TAREAS_NOTIFICACIONES.NEXTVAL,
EXP_ID,
PRO.ASU_ID,
'6',
'5',
DD_STA_ID,
'1',
TAP_CODIGO,
TAP_DESCRIPCION,
SYSDATE,
'0',
'0',
'AUTOMATICA',
'0',
'CONVIVE_F2',
SYSDATE,
'0',
PRC_ID,
'EXTTareaNotificacion',
'0'

FROM CNV_AUX_ALTA_PRC PRC 
LEFT JOIN ASU_ASUNTOS ASU ON PRC.CODIGO_PROCEDIMIENTO_NUSE=ASU.ASU_ID_EXTERNO
LEFT JOIN PRC_PROCEDIMIENTOS PRO ON PRO.ASU_ID=ASU.ASU_ID
LEFT JOIN TAP_TAREA_PROCEDIMIENTO TAP ON TAP.TAP_CODIGO='P420_registrarAceptacion' WHERE PRC.TIPO_PROCEDIMIENTO!='CONCURSO'
AND ASU.EXP_ID not in ( SELECT TAR.EXP_ID FROM TAR_TAREAS_NOTIFICACIONES TAR where EXP_ID IS NOT NULL) AND EXP_ID IS NOT NULL AND PRC_ID IS NOT NULL;



/*  INSERT TEX_TAREa_EXTERNA    */


INSERT INTO TEX_TAREA_EXTERNA(
TEX_ID,
TAR_ID ,
TAP_ID ,
TEX_DETENIDA ,
VERSION  ,
USUARIOCREAR ,
FECHACREAR  ,
BORRADO ,
TEX_CANCELADA ,
TEX_NUM_AUTOP ,
DTYPE   )

SELECT 
S_TEX_TAREA_EXTERNA.NEXTVAL,
TAR_ID,
TAP_ID,
'0',
'0',
'CONVIVE_F2',
SYSDATE,
'0',
'0',
'0',
'EXTTareaExterna'

FROM TAR_TAREAS_NOTIFICACIONES TAR 
LEFT JOIN TAP_TAREA_PROCEDIMIENTO TAP ON TAR.TAR_TAREA=TAP.TAP_CODIGO
WHERE TAR.USUARIOCREAR = 'CONVIVE_F2' AND TAR.TAR_ID not in ( SELECT TEX.TAR_ID FROM TEX_TAREA_EXTERNA TEX where TAR_ID IS NOT NULL) AND TAR.TAR_ID IS NOT NULL;


/*  UPDATE ASU_ASUNTOS  PAS _ ID */
 MERGE INTO ASU_ASUNTOS ASU
USING(
SELECT DISTINCT
DD.DD_PAS_ID,
ASU2.ASU_ID,
ASU2.EXP_ID
FROM CNV_AUX_ALTA_PRC CNV
INNER JOIN ASU_ASUNTOS ASU2 ON ASU2.ASU_NOMBRE=CNV.CODIGO_PROCEDIMIENTO_NUSE
INNER JOIN CEX_CONTRATOS_EXPEDIENTE CEX ON CEX.EXP_ID=ASU2.EXP_ID
INNER JOIN EXT_IAC_INFO_ADD_CONTRATO EXT ON EXT.CNT_ID=CEX.CNT_ID  AND EXT.DD_IFC_ID=31 AND EXT.IAC_VALUE=5074
INNER JOIN DD_PAS_PROPIEDAD_ASUNTO DD ON DD.DD_PAS_CODIGO='SAREB')ORIGEN
ON (ASU.ASU_ID=ORIGEN.ASU_ID AND ASU.EXP_ID=ORIGEN.EXP_ID)
WHEN MATCHED THEN UPDATE
SET ASU.DD_PAS_ID = ORIGEN.DD_PAS_ID;



/*   ASU_ASUNTOS TAS _ID  CONCURSO  */

MERGE INTO ASU_ASUNTOS ASU
USING(
SELECT  DD.DD_TAS_ID, ASU2.ASU_ID  
FROM CNV_AUX_ALTA_PRC CNV
INNER JOIN ASU_ASUNTOS ASU2 ON ASU2.ASU_ID_EXTERNO=CNV.CODIGO_PROCEDIMIENTO_NUSE AND CNV.TIPO_PROCEDIMIENTO='CONCURSO'
  INNER JOIN HAYAMASTER.DD_TAS_TIPOS_ASUNTO DD ON DD.DD_TAS_CODIGO=02) ORIGEN
ON (ASU.ASU_ID=ORIGEN.ASU_ID)
WHEN MATCHED THEN UPDATE
SET ASU.DD_TAS_ID = ORIGEN.DD_TAS_ID;



/*  ASUNTOS TAS _ ID LITIGIO   */

MERGE INTO ASU_ASUNTOS ASU
USING(
SELECT  DD.DD_TAS_ID, ASU2.ASU_ID  
FROM CNV_AUX_ALTA_PRC CNV
INNER JOIN ASU_ASUNTOS ASU2 ON ASU2.ASU_ID_EXTERNO=CNV.CODIGO_PROCEDIMIENTO_NUSE AND CNV.TIPO_PROCEDIMIENTO!='CONCURSO'
  INNER JOIN HAYAMASTER.DD_TAS_TIPOS_ASUNTO DD ON DD.DD_TAS_CODIGO=01) ORIGEN
ON (ASU.ASU_ID=ORIGEN.ASU_ID)
WHEN MATCHED THEN UPDATE
SET ASU.DD_TAS_ID = ORIGEN.DD_TAS_ID;


/*  UPDATE_ASU_ASUNTO_DD_GES_ID  */

 MERGE INTO ASU_ASUNTOS ASU
USING(
SELECT 
DD.DD_GES_ID,
ASU2.ASU_ID
FROM CNV_AUX_ALTA_PRC CNV
INNER JOIN ASU_ASUNTOS ASU2 ON ASU2.ASU_ID_EXTERNO=CNV.CODIGO_PROCEDIMIENTO_NUSE
INNER JOIN DD_GES_GESTION_ASUNTO DD ON DD.DD_GES_CODIGO='HAYA') ORIGEN
ON (ASU.ASU_ID=ORIGEN.ASU_ID)
WHEN MATCHED THEN UPDATE
SET ASU.DD_GES_ID = ORIGEN.DD_GES_ID;


/*  UPDATE_PRC_PROCEDIMIENTO_CONCURSO  */

MERGE INTO PRC_PROCEDIMIENTOS PRC
USING(
SELECT 
DD.DD_TPO_ID,
PRO.PRC_ID
FROM CNV_AUX_ALTA_PRC PRC2
LEFT JOIN ASU_ASUNTOS ASU ON PRC2.CODIGO_PROCEDIMIENTO_NUSE=ASU.ASU_ID_EXTERNO
LEFT JOIN PRC_PROCEDIMIENTOS PRO ON PRO.ASU_ID=ASU.ASU_ID
LEFT JOIN DD_TPO_TIPO_PROCEDIMIENTO DD ON DD.DD_TPO_CODIGO='P402' WHERE PRC2.TIPO_PROCEDIMIENTO='CONCURSO') ORIGEN
ON (PRC.PRC_ID=ORIGEN.PRC_ID)
WHEN MATCHED THEN UPDATE
SET PRC.DD_TPO_ID = ORIGEN.DD_TPO_ID,
PRC.TIPO_PROC_ORIGINAL=ORIGEN.DD_TPO_ID;



/*   UPDATE_PRC_PROCEDIMIENTO_LITIGIO  */


 MERGE INTO PRC_PROCEDIMIENTOS PRC
USING(
SELECT 
DD.DD_TPO_ID,
PRO.PRC_ID
FROM CNV_AUX_ALTA_PRC PRC2
LEFT JOIN ASU_ASUNTOS ASU ON PRC2.CODIGO_PROCEDIMIENTO_NUSE=ASU.ASU_ID_EXTERNO
LEFT JOIN PRC_PROCEDIMIENTOS PRO ON PRO.ASU_ID=ASU.ASU_ID
LEFT JOIN DD_TPO_TIPO_PROCEDIMIENTO DD ON DD.DD_TPO_CODIGO='P420' WHERE PRC2.TIPO_PROCEDIMIENTO!='CONCURSO') ORIGEN
ON (PRC.PRC_ID=ORIGEN.PRC_ID)
WHEN MATCHED THEN UPDATE
SET PRC.DD_TPO_ID = ORIGEN.DD_TPO_ID,
PRC.TIPO_PROC_ORIGINAL=ORIGEN.DD_TPO_ID;



  