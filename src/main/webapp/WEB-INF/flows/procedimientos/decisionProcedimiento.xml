<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">
	
	<var name="dtoDecisionProcedimiento" class="es.capgemini.pfs.decisionProcedimiento.dto.DtoDecisionProcedimiento" />
	<var name="dtoProcedimientoDerivado" class="es.capgemini.pfs.procedimientoDerivado.dto.DtoProcedimientoDerivado" />
	<var name="dtoProcedimiento" class="es.capgemini.pfs.asunto.dto.ProcedimientoDto"/>	
	<var name="decisionProcedimiento" class="es.capgemini.pfs.decisionProcedimiento.model.DecisionProcedimiento" />
	
	<input name="id" type="java.lang.Long"/>
	<input name="idProcedimiento" type="java.lang.Long"/>
   <input name="isConsulta" type="java.lang.Boolean"/>
	
	<decision-state id="newOrEdit">
		<if test="id!=null" then="buscar" else="crear"/>
	</decision-state>
	<action-state id="buscar">
	<evaluate expression="executor.execute('decisionProcedimientoManager.get', id)" result="flowScope.decisionProcedimiento"/>
	<transition to="formulario" />
	</action-state>
	<action-state id="crear">
		<evaluate expression="executor.execute('decisionProcedimientoManager.getInstance',idProcedimiento)"
			result="flowScope.decisionProcedimiento" />
		<transition to="formulario" />
	</action-state>
	<view-state id="formulario" view="${view}" model="dtoDecisionProcedimiento">
			<on-entry>
				<set name="dtoDecisionProcedimiento.decisionProcedimiento" value="decisionProcedimiento" />
				<set name="flowScope.view" value="'procedimientos/decision'" />
			</on-entry>
			<on-render>
			<set name="flowScope.view" value="'default'"/>
				<evaluate expression="executor.execute('dictionaryManager.getList','DDCausaDecision')" result="flashScope.causaDecision"/>
				<evaluate expression="executor.execute('dictionaryManager.getList','DDEstadoDecision')" result="flashScope.estadoDecision"/>
				<evaluate expression="executor.execute('procedimientoManager.getTiposActuacion')" result="flowScope.tiposActuacion" />
	    		<evaluate expression="executor.execute('procedimientoManager.getTiposProcedimiento')" result="flowScope.tiposProcedimientos" />
	    		<evaluate expression="executor.execute('procedimientoManager.getTiposReclamacion')" result="flowScope.tiposReclamacion" />
	    		<evaluate expression="executor.execute('procedimientoManager.getPersonasAfectadas', idProcedimiento)" result="flowScope.personas"/>
				<evaluate expression="executor.execute('decisionProcedimientoManager.getInstance',idProcedimiento)" result="flowScope.esConulta" />
				
				<evaluate expression="executor.execute('procedimientoManager.esGestor',idProcedimiento)" result="flowScope.esGestor" />
	    		<evaluate expression="executor.execute('procedimientoManager.esSupervisor',idProcedimiento)" result="flowScope.esSupervisor" />
			
			</on-render>
			<transition on="update" to="update"/>
			<transition on="rechazar" to="rechazar" bind="false"/>
			<transition on="aceptarPropuesta" to="aceptarPropuesta"/>
			<transition on="cancel" to="close" bind="false"/>
	</view-state>
	<action-state id="update">
		<evaluate expression="executor.execute('decisionProcedimientoManager.crearPropuesta',dtoDecisionProcedimiento)" />
	 <transition to="close"></transition>
	</action-state>
	<action-state id="rechazar">
		<evaluate expression="executor.execute('decisionProcedimientoManager.rechazarPropuesta',dtoDecisionProcedimiento)"/>
	 <transition to="close"></transition>
	</action-state>
	<action-state id="aceptarPropuesta">
		<evaluate expression="executor.execute('decisionProcedimientoManager.aceptarPropuesta',dtoDecisionProcedimiento)"/>
	 <transition to="close"></transition>
	</action-state>
	
	<end-state id="close" view="default" />
</flow>
