<!DOCTYPE properties SYSTEM "http://java.sun.com/dtd/properties.dtd">
<properties>
	<!-- COMPROBAMOS SI HAY ESQUEMAS PENDIENTES DE LIBERAR Y REALIZAMOS LOS CAMBOS CORRESPONDIENTES EN CASO AFIRMATIVO -->
	<entry key="recobro.gestion.esquemas.Oracle9iDialect">
		<![CDATA[
			declare
          		v_result NUMBER;
          		v_id_esquema_liberado_actual NUMBER;
		    	v_sql VARCHAR2(2000 CHAR);
		    	v_codigo_extincion VARCHAR2(5 CHAR);
          		v_codigo_liberado VARCHAR2(5 CHAR);
          		v_codigo_pendiente_liberar VARCHAR2(5 CHAR);
			begin
		        SELECT ESQ.RCF_ESQ_ID INTO v_id_esquema_liberado_actual 
		        FROM RCF_ESQ_ESQUEMA ESQ  
		        JOIN RCF_DD_EES_ESTADO_ESQUEMA EES ON ESQ.RCF_DD_EES_ID = EES.RCF_DD_EES_ID
		        WHERE EES.RCF_DD_EES_CODIGO = ${ddEstadoEsquemas.Liberado.codigo} AND ESQ.BORRADO = ${borrado.no.id} AND ROWNUM = 1;        
		        SELECT CASE WHEN (COUNT(DISTINCT ESQ.RCF_ESQ_ID) = 1) THEN 1 ELSE 0 END	INTO v_result 
		        FROM RCF_ESQ_ESQUEMA ESQ  
		        JOIN RCF_DD_EES_ESTADO_ESQUEMA EES ON ESQ.RCF_DD_EES_ID = EES.RCF_DD_EES_ID
		        WHERE EES.RCF_DD_EES_CODIGO = ${ddEstadoEsquemas.PendienteLiberar.codigo} AND ESQ.BORRADO = ${borrado.no.id} AND ROWNUM = 1;  
				IF(v_result = 1)
		    	THEN
			    	v_codigo_extincion:= ${ddEstadoEsquemas.Inactivo.codigo};
	       			v_codigo_liberado:= ${ddEstadoEsquemas.Liberado.codigo};
	        		v_codigo_pendiente_liberar:= ${ddEstadoEsquemas.PendienteLiberar.codigo};
					v_sql:='
			     		UPDATE RCF_ESQ_ESQUEMA ESQ SET ESQ.RCF_DD_EES_ID = (SELECT EES1.RCF_DD_EES_ID 
			            FROM RCF_DD_EES_ESTADO_ESQUEMA EES1 WHERE EES1.RCF_DD_EES_CODIGO = :v_codigo_extincion),
			            ESQ.RCF_ESQ_ID_SIGUIENTE = (SELECT ESQ1.RCF_ESQ_ID FROM RCF_ESQ_ESQUEMA ESQ1 WHERE ESQ.RCF_DD_EES_ID = 
			            (SELECT EES3.RCF_DD_EES_ID FROM RCF_DD_EES_ESTADO_ESQUEMA EES3 WHERE EES3.RCF_DD_EES_CODIGO = :v_codigo_pendiente_liberar))
			            WHERE ESQ.RCF_DD_EES_ID = (SELECT EES2.RCF_DD_EES_ID FROM RCF_DD_EES_ESTADO_ESQUEMA EES2 
			            WHERE EES2.RCF_DD_EES_CODIGO = :v_codigo_liberado) AND ESQ.BORRADO = 0
					';
					execute immediate v_sql using v_codigo_extincion, v_codigo_pendiente_liberar, v_codigo_liberado;
			    	COMMIT;
	        		v_sql:='
			     		UPDATE RCF_ESQ_ESQUEMA ESQ SET ESQ.RCF_DD_EES_ID = (SELECT EES1.RCF_DD_EES_ID 
			            FROM RCF_DD_EES_ESTADO_ESQUEMA EES1 WHERE EES1.RCF_DD_EES_CODIGO = :v_codigo_liberado),
			            ESQ.RCF_ESQ_ID_ANTERIOR = :v_id_esquema_liberado_actual,
			            ESQ.RCF_ESQ_FECHA_LIB = SYSDATE            
			            WHERE ESQ.RCF_DD_EES_ID = (SELECT EES2.RCF_DD_EES_ID FROM RCF_DD_EES_ESTADO_ESQUEMA EES2 
			            WHERE EES2.RCF_DD_EES_CODIGO = :v_codigo_pendiente_liberar) AND ESQ.BORRADO = 0
					';
					execute immediate v_sql using v_codigo_liberado, v_id_esquema_liberado_actual, v_codigo_pendiente_liberar;
			    	COMMIT;        
				END IF;
		    end;		
		]]>
	</entry> 
	<!-- VOLVEMOS A GENERAR LA VISTA DE BATCH_DATOS_EXP -->
	<entry key="recobro.creacion.batch_datos_exp.Oracle9iDialect">
		<![CDATA[
				CREATE OR REPLACE VIEW BATCH_DATOS_EXP AS
			      SELECT EXP.EXP_ID
			        , EXP.ARQ_ID AS ARQ_ID
			        , 0 AS EXP_BORRADO
			        , ${ddTipoExpediente.Recobro.codigo} AS DD_TPE_CODIGO
			        , EEX.DD_EEX_CODIGO
			        , CRE.RCF_ESQ_ID AS RCF_ESQ_ID
			        , CRE.RCF_AGE_ID AS RCF_AGE_ID
			        , CRE.RCF_SCA_ID AS RCF_SCA_ID
			        , -1 AS EXP_MARCADO_BPM
			        , EXP.EXP_MANUAL
			      FROM EXP_EXPEDIENTES EXP
			        JOIN EXR_EXPEDIENTE_RECOBRO REC ON EXP.EXP_ID = REC.EXP_ID
			        JOIN ${master.schema}.DD_EEX_ESTADO_EXPEDIENTE EEX ON EXP.DD_EEX_ID = EEX.DD_EEX_ID
			        JOIN CRE_CICLO_RECOBRO_EXP CRE ON EXP.EXP_ID = CRE.EXP_ID
			      WHERE EXP.BORRADO = 0 AND EEX.DD_EEX_CODIGO = ${ddEstadoExpedientes.Activo.codigo} AND EXP.EXP_MANUAL = 0
		]]>
	</entry> 
	<!-- VOLVEMOS A GENERAR LA VISTA DE BATCH_RCF_ENTRADA -->
	<entry key="recobro.creacion.batch_rcf_entrada.Oracle9iDialect">
		<![CDATA[
				CREATE OR REPLACE VIEW BATCH_RCF_ENTRADA AS
SELECT 
    ESQ.RCF_ESQ_ID AS RCF_ESQ_ID,
    ESQ.RCF_ESQ_PLAZO AS RCF_ESQ_PLAZO,
    ESQ.RCF_ESQ_FECHA_LIB AS RCF_ESQ_FECHA_LIB,
    ESQ.BORRADO AS RCF_ESQ_BORRADO,
    EES.RCF_DD_EES_ID AS RCF_DD_EES_ID,
    EES.RCF_DD_EES_CODIGO AS RCF_DD_EES_CODIGO,
    EES.BORRADO AS RCF_DD_EES_BORRADO,
    MTR.RCF_DD_MTR_ID AS RCF_DD_MTR_ID,
    MTR.RCF_DD_MTR_CODIGO AS RCF_DD_MTR_CODIGO,
    MTR.BORRADO AS RCF_DD_MTR_BORRADO,
    CAR.RCF_CAR_ID AS RCF_CAR_ID,
    CAR.RCF_CAR_NOMBRE AS RCF_CAR_NOMBRE,
    CAR.BORRADO AS RCF_CAR_BORRADO,
    CAST (null AS NUMBER(16)) AS RCF_DD_ECA_ID, --ECA.RCF_DD_ECA_ID ,
    CAST (null AS NUMBER(16)) AS RCF_DD_ECA_CODIGO, --ECA.RCF_DD_ECA_CODIGO ,
    CAST (null AS NUMBER(16)) AS RCF_DD_ECA_BORRADO, --ECA.BORRADO ,
    RUL.RD_ID AS RD_ID,
    RUL.RD_NAME AS RD_NAME,
    RUL.RD_DEFINITION AS RD_DEFINITION,
    RUL.BORRADO AS RD_BORRADO,
    AGE.RCF_AGE_ID AS RCF_AGE_ID,
    AGE.RCF_AGE_NOMBRE AS RCF_AGE_NOMBRE,
    AGE.RCF_AGE_CODIGO AS RCF_AGE_CODIGO,
    AGE.BORRADO AS RCF_AGE_BORRADO,
    ESC.RCF_ESC_ID AS RCF_ESC_ID,
    ESC.RCF_ESC_PRIORIDAD AS RCF_ESC_PRIORIDAD,
    ESC.BORRADO AS RCF_ESC_BORRADO,
    TCE.DD_TCE_ID AS RCF_DD_TCE_ID,        
    TCE.DD_TCE_CODIGO AS RCF_DD_TCE_CODIGO,
    TCE.BORRADO AS RCF_DD_TCE_BORRADO,
    TGC.DD_TGC_ID AS RCF_DD_TGC_ID,        
    TGC.DD_TGC_CODIGO AS RCF_DD_TGC_CODIGO,
    TGC.BORRADO AS RCF_DD_TGC_BORRADO,
    AER.DD_AER_ID AS RCF_DD_AER_ID,        
    AER.DD_AER_CODIGO AS RCF_DD_AER_CODIGO,
    AER.BORRADO AS RCF_DD_AER_BORRADO,
    SCA.RCF_SCA_ID AS RCF_SCA_ID,
    SCA.RCF_SCA_NOMBRE AS RCF_SCA_NOMBRE,
    SCA.RCF_SCA_PARTICION AS RCF_SCA_PARTICION,
    SCA.BORRADO AS RCF_SCA_BORRADO,
    TPR.RCF_DD_TPR_ID AS RCF_DD_TPR_ID,        
    TPR.RCF_DD_TPR_CODIGO AS RCF_DD_TPR_CODIGO,
    TPR.BORRADO AS RCF_DD_TPR_BORRADO,
    ITV.RCF_ITV_ID AS RCF_ITV_ID,        
    ITV.RCF_ITV_NOMBRE AS RCF_ITV_NOMBRE,
    ITV.RCF_ITV_FECHA_ALTA AS RCF_ITV_FECHA_ALTA,
    ITV.RCF_ITV_PLAZO_MAX AS RCF_ITV_PLAZO_MAX,
    ITV.RCF_ITV_NO_GEST AS RCF_ITV_NO_GEST,
    ITV.BORRADO AS RCF_ITV_BORRADO,
    MFA.RCF_MFA_ID AS RCF_MFA_ID,        
    MFA.RCF_MFA_NOMBRE AS RCF_MFA_NOMBRE,
    MFA.BORRADO AS RCF_MFA_BORRADO,
    POA.RCF_POA_ID AS RCF_POA_ID,        
    POA.RCF_POA_CODIGO AS RCF_POA_CODIGO,
    POA.BORRADO AS RCF_POA_BORRADO,
    MOR.RCF_MOR_ID AS RCF_MOR_ID,
    MOR.RCF_MOR_NOMBRE AS RCF_MOR_NOMBRE,
    MOR.BORRADO AS RCF_MOR_BORRADO,
    SUA.RCF_SUA_ID AS RCF_SUA_ID,
    SUA.RCF_SUA_COEFICIENTE AS RCF_SUA_COEFICIENTE,
    SUA.BORRADO AS RCF_SUA_BORRADO,
    SUR.RCF_SUR_ID AS RCF_SUR_ID,
    SUR.RCF_SUR_POSICION AS RCF_SUR_POSICION,
    SUR.RCF_SUR_PORCENTAJE AS RCF_SUR_PORCENTAJE,
    SUR.BORRADO AS RCF_SUR_BORRADO
  FROM RCF_ESQ_ESQUEMA ESQ  
    JOIN RCF_DD_MTR_MODELO_TRANSICION MTR ON ESQ.RCF_DD_MTR_ID = MTR.RCF_DD_MTR_ID
    JOIN RCF_DD_EES_ESTADO_ESQUEMA EES ON ESQ.RCF_DD_EES_ID = EES.RCF_DD_EES_ID    
    JOIN RCF_ESC_ESQUEMA_CARTERAS ESC ON ESQ.RCF_ESQ_ID = ESC.RCF_ESQ_ID
    JOIN RCF_DD_TGC_TIPO_GESTION_CART TGC ON ESC.DD_TGC_ID = TGC.DD_TGC_ID
    JOIN RCF_DD_TCE_TIPO_CARTERA_ESQ TCE ON ESC.DD_TCE_ID = TCE.DD_TCE_ID
    JOIN RCF_DD_AER_AMBITO_EXP_REC AER ON ESC.DD_AER_ID = AER.DD_AER_ID
    JOIN RCF_CAR_CARTERA CAR ON ESC.RCF_CAR_ID = CAR.RCF_CAR_ID
    --JOIN RCF_DD_ECA_ESTADO_CARTERA ECA ON CAR.RCF_DD_ECA_ID = ECA.RCF_DD_ECA_ID
    JOIN RULE_DEFINITION RUL ON CAR.RD_ID = RUL.RD_ID
    LEFT JOIN RCF_SCA_SUBCARTERA SCA ON ESC.RCF_ESC_ID = SCA.RCF_ESC_ID  AND SCA.BORRADO = 0
    LEFT JOIN RCF_DD_TPR_TIPO_REPARTO_SUBC TPR ON SCA.RCF_DD_TPR_ID = TPR.RCF_DD_TPR_ID AND TPR.BORRADO = 0
    LEFT JOIN RCF_ITV_ITI_METAS_VOLANTES ITV ON SCA.RCF_ITV_ID = ITV.RCF_ITV_ID AND ITV.BORRADO = 0
    LEFT JOIN RCF_MFA_MODELOS_FACTURACION MFA ON SCA.RCF_MFA_ID = MFA.RCF_MFA_ID AND MFA.BORRADO = 0
    LEFT JOIN RCF_SUA_SUBCARTERA_AGENCIAS SUA ON SCA.RCF_SCA_ID = SUA.RCF_SCA_ID AND SUA.BORRADO = 0
    LEFT JOIN RCF_AGE_AGENCIAS AGE ON SUA.RCF_AGE_ID  = AGE.RCF_AGE_ID AND AGE.BORRADO = 0
    LEFT JOIN RCF_SUR_SUBCARTERA_RANKING SUR ON SCA.RCF_SCA_ID = SUR.RCF_SUR_ID AND SUR.BORRADO = 0    
    LEFT JOIN RCF_POA_POLITICA_ACUERDOS POA ON SCA.RCF_POA_ID = POA.RCF_POA_ID AND POA.BORRADO = 0
    LEFT JOIN RCF_MOR_MODELO_RANKING MOR ON SCA.RCF_MOR_ID = MOR.RCF_MOR_ID
  WHERE EES.RCF_DD_EES_CODIGO IN (${ddEstadoEsquemas.Inactivo.codigo}, ${ddEstadoEsquemas.Liberado.codigo})
		]]>
	</entry>       
 </properties>